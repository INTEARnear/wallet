import{a as qa,b as ka,c as Ts,d as Ke,e as _e}from"./chunk-A5AP7RRR.js";import{a as Fr,b as us,c as ps,d as _a,e as Sa,f as Oa,g as ei,h as Ur,i as Pa,j as Ra,k as Ta,l as Gu,m as xa,n as Aa,o as Ca,q as Na,r as Wu,s as ja}from"./chunk-SQN7L5MN.js";import{a as Rs}from"./chunk-7GZ7JYLK.js";import{a as Dr,b as Ia,d as Pt,e as Rt,f as ze,g as Ut,h as Ni,k as ti,l as si,m as at,n as et,o as Br,p as ii,q as ji}from"./chunk-6HADIPAO.js";import"./chunk-2T4BE52W.js";import{a as hs,b as Qe,d as Qs}from"./chunk-XQOHLC2A.js";import"./chunk-BDUWLAUS.js";import"./chunk-6ZQQ3XQO.js";import"./chunk-MQMLE4BX.js";import"./chunk-EDRI7XUL.js";import{g as ls,i as qe,j as ke,k as Le,l as K,o as Fe}from"./chunk-JY5TIRRF.js";qe();Fe();Le();Qs();qe();Fe();Le();var jt=ls(Fr(),1),pt=ls(Ta(),1),Oc=ls(Gu(),1);var Pc=ls(Wu(),1);qe();Fe();Le();var bt={exports:{}};function Yu(t){try{return JSON.stringify(t)}catch{return'"[Circular]"'}}var Ju=Xu;function Xu(t,e,s){var i=s&&s.stringify||Yu,r=1;if(typeof t=="object"&&t!==null){var n=e.length+r;if(n===1)return t;var o=new Array(n);o[0]=i(t);for(var a=1;a<n;a++)o[a]=i(e[a]);return o.join(" ")}if(typeof t!="string")return t;var c=e.length;if(c===0)return t;for(var l="",h=1-r,u=-1,p=t&&t.length||0,d=0;d<p;){if(t.charCodeAt(d)===37&&d+1<p){switch(u=u>-1?u:0,t.charCodeAt(d+1)){case 100:case 102:if(h>=c||e[h]==null)break;u<d&&(l+=t.slice(u,d)),l+=Number(e[h]),u=d+2,d++;break;case 105:if(h>=c||e[h]==null)break;u<d&&(l+=t.slice(u,d)),l+=Math.floor(Number(e[h])),u=d+2,d++;break;case 79:case 111:case 106:if(h>=c||e[h]===void 0)break;u<d&&(l+=t.slice(u,d));var f=typeof e[h];if(f==="string"){l+="'"+e[h]+"'",u=d+2,d++;break}if(f==="function"){l+=e[h].name||"<anonymous>",u=d+2,d++;break}l+=i(e[h]),u=d+2,d++;break;case 115:if(h>=c)break;u<d&&(l+=t.slice(u,d)),l+=String(e[h]),u=d+2,d++;break;case 37:u<d&&(l+=t.slice(u,d)),l+="%",u=d+2,d++,h--;break}++h}++d}return u===-1?t:(u<p&&(l+=t.slice(u)),l)}var La=Ju;bt.exports=Tt;var ri=pp().console||{},Zu={mapHttpRequest:qi,mapHttpResponse:qi,wrapRequestSerializer:$r,wrapResponseSerializer:$r,wrapErrorSerializer:$r,req:qi,res:qi,err:Da,errWithCause:Da};function $t(t,e){return t==="silent"?1/0:e.levels.values[t]}var Gr=Symbol("pino.logFuncs"),Mr=Symbol("pino.hierarchy"),Qu={error:"log",fatal:"error",warn:"error",info:"log",debug:"log",trace:"log"};function Fa(t,e){let s={logger:e,parent:t[Mr]};e[Mr]=s}function ep(t,e,s){let i={};e.forEach(r=>{i[r]=s[r]?s[r]:ri[r]||ri[Qu[r]||"log"]||xs}),t[Gr]=i}function tp(t,e){return Array.isArray(t)?t.filter(function(s){return s!=="!stdSerializers.err"}):t===!0?Object.keys(e):!1}function Tt(t){t=t||{},t.browser=t.browser||{};let e=t.browser.transmit;if(e&&typeof e.send!="function")throw Error("pino: transmit option must have a send function");let s=t.browser.write||ri;t.browser.write&&(t.browser.asObject=!0);let i=t.serializers||{},r=tp(t.browser.serialize,i),n=t.browser.serialize;Array.isArray(t.browser.serialize)&&t.browser.serialize.indexOf("!stdSerializers.err")>-1&&(n=!1);let o=Object.keys(t.customLevels||{}),a=["error","fatal","warn","info","debug","trace"].concat(o);typeof s=="function"&&a.forEach(function(g){s[g]=s}),(t.enabled===!1||t.browser.disabled)&&(t.level="silent");let c=t.level||"info",l=Object.create(s);l.log||(l.log=xs),ep(l,a,s),Fa({},l),Object.defineProperty(l,"levelVal",{get:u}),Object.defineProperty(l,"level",{get:p,set:d});let h={transmit:e,serialize:r,asObject:t.browser.asObject,asObjectBindingsOnly:t.browser.asObjectBindingsOnly,formatters:t.browser.formatters,levels:a,timestamp:lp(t),messageKey:t.messageKey||"msg",onChild:t.onChild||xs};l.levels=sp(t),l.level=c,l.isLevelEnabled=function(g){return this.levels.values[g]?this.levels.values[g]>=this.levels.values[this.level]:!1},l.setMaxListeners=l.getMaxListeners=l.emit=l.addListener=l.on=l.prependListener=l.once=l.prependOnceListener=l.removeListener=l.removeAllListeners=l.listeners=l.listenerCount=l.eventNames=l.write=l.flush=xs,l.serializers=i,l._serialize=r,l._stdErrSerialize=n,l.child=function(...g){return f.call(this,h,...g)},e&&(l._logEvent=Vr());function u(){return $t(this.level,this)}function p(){return this._level}function d(g){if(g!=="silent"&&!this.levels.values[g])throw Error("unknown level "+g);this._level=g,ds(this,h,l,"error"),ds(this,h,l,"fatal"),ds(this,h,l,"warn"),ds(this,h,l,"info"),ds(this,h,l,"debug"),ds(this,h,l,"trace"),o.forEach(y=>{ds(this,h,l,y)})}function f(g,y,P){if(!y)throw new Error("missing bindings for child Pino");P=P||{},r&&y.serializers&&(P.serializers=y.serializers);let x=P.serializers;if(r&&x){var S=Object.assign({},i,x),q=t.browser.serialize===!0?Object.keys(S):r;delete y.serializers,Wr([y],q,S,this._stdErrSerialize)}function B(D){this._childLevel=(D._childLevel|0)+1,this.bindings=y,S&&(this.serializers=S,this._serialize=q),e&&(this._logEvent=Vr([].concat(D._logEvent.bindings,y)))}B.prototype=this;let N=new B(this);return Fa(this,N),N.child=function(...D){return f.call(this,g,...D)},N.level=P.level||this.level,g.onChild(N),N}return l}function sp(t){let e=t.customLevels||{},s=Object.assign({},Tt.levels.values,e),i=Object.assign({},Tt.levels.labels,ip(e));return{values:s,labels:i}}function ip(t){let e={};return Object.keys(t).forEach(function(s){e[t[s]]=s}),e}Tt.levels={values:{fatal:60,error:50,warn:40,info:30,debug:20,trace:10},labels:{10:"trace",20:"debug",30:"info",40:"warn",50:"error",60:"fatal"}},Tt.stdSerializers=Zu,Tt.stdTimeFunctions=Object.assign({},{nullTime:Ma,epochTime:Va,unixTime:hp,isoTime:up});function rp(t){let e=[];t.bindings&&e.push(t.bindings);let s=t[Mr];for(;s.parent;)s=s.parent,s.logger.bindings&&e.push(s.logger.bindings);return e.reverse()}function ds(t,e,s,i){if(Object.defineProperty(t,i,{value:$t(t.level,s)>$t(i,s)?xs:s[Gr][i],writable:!0,enumerable:!0,configurable:!0}),t[i]===xs){if(!e.transmit)return;let n=e.transmit.level||t.level,o=$t(n,s);if($t(i,s)<o)return}t[i]=op(t,e,s,i);let r=rp(t);r.length!==0&&(t[i]=np(r,t[i]))}function np(t,e){return function(){return e.apply(this,[...t,...arguments])}}function op(t,e,s,i){return function(r){return function(){let n=e.timestamp(),o=new Array(arguments.length),a=Object.getPrototypeOf&&Object.getPrototypeOf(this)===ri?ri:this;for(var c=0;c<o.length;c++)o[c]=arguments[c];var l=!1;if(e.serialize&&(Wr(o,this._serialize,this.serializers,this._stdErrSerialize),l=!0),e.asObject||e.formatters?r.call(a,...ap(this,i,o,n,e)):r.apply(a,o),e.transmit){let h=e.transmit.level||t._level,u=$t(h,s),p=$t(i,s);if(p<u)return;cp(this,{ts:n,methodLevel:i,methodValue:p,transmitLevel:h,transmitValue:s.levels.values[e.transmit.level||t._level],send:e.transmit.send,val:$t(t._level,s)},o,l)}}}(t[Gr][i])}function ap(t,e,s,i,r){let{level:n,log:o=u=>u}=r.formatters||{},a=s.slice(),c=a[0],l={},h=(t._childLevel|0)+1;if(h<1&&(h=1),i&&(l.time=i),n){let u=n(e,t.levels.values[e]);Object.assign(l,u)}else l.level=t.levels.values[e];if(r.asObjectBindingsOnly){if(c!==null&&typeof c=="object")for(;h--&&typeof a[0]=="object";)Object.assign(l,a.shift());return[o(l),...a]}else{if(c!==null&&typeof c=="object"){for(;h--&&typeof a[0]=="object";)Object.assign(l,a.shift());c=a.length?La(a.shift(),a):void 0}else typeof c=="string"&&(c=La(a.shift(),a));return c!==void 0&&(l[r.messageKey]=c),[o(l)]}}function Wr(t,e,s,i){for(let r in t)if(i&&t[r]instanceof Error)t[r]=Tt.stdSerializers.err(t[r]);else if(typeof t[r]=="object"&&!Array.isArray(t[r])&&e)for(let n in t[r])e.indexOf(n)>-1&&n in s&&(t[r][n]=s[n](t[r][n]))}function cp(t,e,s,i=!1){let r=e.send,n=e.ts,o=e.methodLevel,a=e.methodValue,c=e.val,l=t._logEvent.bindings;i||Wr(s,t._serialize||Object.keys(t.serializers),t.serializers,t._stdErrSerialize===void 0?!0:t._stdErrSerialize),t._logEvent.ts=n,t._logEvent.messages=s.filter(function(h){return l.indexOf(h)===-1}),t._logEvent.level.label=o,t._logEvent.level.value=a,r(o,t._logEvent,c),t._logEvent=Vr(l)}function Vr(t){return{ts:0,messages:[],bindings:t||[],level:{label:"",value:0}}}function Da(t){let e={type:t.constructor.name,msg:t.message,stack:t.stack};for(let s in t)e[s]===void 0&&(e[s]=t[s]);return e}function lp(t){return typeof t.timestamp=="function"?t.timestamp:t.timestamp===!1?Ma:Va}function qi(){return{}}function $r(t){return t}function xs(){}function Ma(){return!1}function Va(){return Date.now()}function hp(){return Math.round(Date.now()/1e3)}function up(){return new Date(Date.now()).toISOString()}function pp(){function t(e){return typeof e<"u"&&e}try{return typeof globalThis<"u"||Object.defineProperty(Object.prototype,"globalThis",{get:function(){return delete Object.prototype.globalThis,this.globalThis=this},configurable:!0}),globalThis}catch{return t(self)||t(window)||t(this)||{}}}bt.exports.default=Tt;var Dv=bt.exports.pino=Tt,dp={level:"info"},Di="custom_context",Yr=1e3*1024,fp=Object.defineProperty,gp=(t,e,s)=>e in t?fp(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Bt=(t,e,s)=>gp(t,typeof e!="symbol"?e+"":e,s),zr=class{constructor(e){Bt(this,"nodeValue"),Bt(this,"sizeInBytes"),Bt(this,"next"),this.nodeValue=e,this.sizeInBytes=new TextEncoder().encode(this.nodeValue).length,this.next=null}get value(){return this.nodeValue}get size(){return this.sizeInBytes}},Li=class{constructor(e){Bt(this,"lengthInNodes"),Bt(this,"sizeInBytes"),Bt(this,"head"),Bt(this,"tail"),Bt(this,"maxSizeInBytes"),this.head=null,this.tail=null,this.lengthInNodes=0,this.maxSizeInBytes=e,this.sizeInBytes=0}append(e){let s=new zr(e);if(s.size>this.maxSizeInBytes)throw new Error(`[LinkedList] Value too big to insert into list: ${e} with size ${s.size}`);for(;this.size+s.size>this.maxSizeInBytes;)this.shift();this.head?(this.tail&&(this.tail.next=s),this.tail=s):(this.head=s,this.tail=s),this.lengthInNodes++,this.sizeInBytes+=s.size}shift(){if(!this.head)return;let e=this.head;this.head=this.head.next,this.head||(this.tail=null),this.lengthInNodes--,this.sizeInBytes-=e.size}toArray(){let e=[],s=this.head;for(;s!==null;)e.push(s.value),s=s.next;return e}get length(){return this.lengthInNodes}get size(){return this.sizeInBytes}toOrderedArray(){return Array.from(this)}[Symbol.iterator](){let e=this.head;return{next:()=>{if(!e)return{done:!0,value:null};let s=e.value;return e=e.next,{done:!1,value:s}}}}},yp=t=>JSON.stringify(t,(e,s)=>typeof s=="bigint"?s.toString()+"n":s);function Ua(t){return typeof t=="string"?t:yp(t)||""}var mp=Object.defineProperty,wp=(t,e,s)=>e in t?mp(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,ki=(t,e,s)=>wp(t,typeof e!="symbol"?e+"":e,s),Fi=class{constructor(e,s=Yr){ki(this,"logs"),ki(this,"level"),ki(this,"levelValue"),ki(this,"MAX_LOG_SIZE_IN_BYTES"),this.level=e??"error",this.levelValue=bt.exports.levels.values[this.level],this.MAX_LOG_SIZE_IN_BYTES=s,this.logs=new Li(this.MAX_LOG_SIZE_IN_BYTES)}forwardToConsole(e,s){s===bt.exports.levels.values.error?console.error(e):s===bt.exports.levels.values.warn?console.warn(e):s===bt.exports.levels.values.debug?console.debug(e):s===bt.exports.levels.values.trace?console.trace(e):console.log(e)}appendToLogs(e){this.logs.append(Ua({timestamp:new Date().toISOString(),log:e}));let s=typeof e=="string"?JSON.parse(e).level:e.level;s>=this.levelValue&&this.forwardToConsole(e,s)}getLogs(){return this.logs}clearLogs(){this.logs=new Li(this.MAX_LOG_SIZE_IN_BYTES)}getLogArray(){return Array.from(this.logs)}logsToBlob(e){let s=this.getLogArray();return s.push(Ua({extraMetadata:e})),new Blob(s,{type:"application/json"})}},bp=Object.defineProperty,vp=(t,e,s)=>e in t?bp(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Ep=(t,e,s)=>vp(t,typeof e!="symbol"?e+"":e,s),Kr=class{constructor(e,s=Yr){Ep(this,"baseChunkLogger"),this.baseChunkLogger=new Fi(e,s)}write(e){this.baseChunkLogger.appendToLogs(e)}getLogs(){return this.baseChunkLogger.getLogs()}clearLogs(){this.baseChunkLogger.clearLogs()}getLogArray(){return this.baseChunkLogger.getLogArray()}logsToBlob(e){return this.baseChunkLogger.logsToBlob(e)}downloadLogsBlobInBrowser(e){let s=URL.createObjectURL(this.logsToBlob(e)),i=document.createElement("a");i.href=s,i.download=`walletconnect-logs-${new Date().toISOString()}.txt`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}},_p=Object.defineProperty,Ip=(t,e,s)=>e in t?_p(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Sp=(t,e,s)=>Ip(t,typeof e!="symbol"?e+"":e,s),Hr=class{constructor(e,s=Yr){Sp(this,"baseChunkLogger"),this.baseChunkLogger=new Fi(e,s)}write(e){this.baseChunkLogger.appendToLogs(e)}getLogs(){return this.baseChunkLogger.getLogs()}clearLogs(){this.baseChunkLogger.clearLogs()}getLogArray(){return this.baseChunkLogger.getLogArray()}logsToBlob(e){return this.baseChunkLogger.logsToBlob(e)}},Op=Object.defineProperty,Pp=Object.defineProperties,Rp=Object.getOwnPropertyDescriptors,Ba=Object.getOwnPropertySymbols,Tp=Object.prototype.hasOwnProperty,xp=Object.prototype.propertyIsEnumerable,$a=(t,e,s)=>e in t?Op(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Mt=(t,e)=>{for(var s in e||(e={}))Tp.call(e,s)&&$a(t,s,e[s]);if(Ba)for(var s of Ba(e))xp.call(e,s)&&$a(t,s,e[s]);return t},Vt=(t,e)=>Pp(t,Rp(e));function za(t){return Vt(Mt({},t),{level:t?.level||dp.level})}function Ap(t,e,s=Di){return t[s]=e,t}function Ie(t,e=Di){return t[e]||""}function Cp(t,e,s=Di){let i=Ie(t,s);return i.trim()?`${i}/${e}`:e}function De(t,e,s=Di){let i=Cp(t,e,s),r=t.child({context:i});return Ap(r,i,s)}function Np(t){var e,s;let i=new Kr((e=t.opts)==null?void 0:e.level,t.maxSizeInBytes);return{logger:bt.exports(Vt(Mt({},t.opts),{level:"trace",browser:Vt(Mt({},(s=t.opts)==null?void 0:s.browser),{write:r=>i.write(r)})})),chunkLoggerController:i}}function jp(t){var e,s;let i=new Hr((e=t.opts)==null?void 0:e.level,t.maxSizeInBytes);return{logger:bt.exports(Vt(Mt({},t.opts),{level:"trace",browser:Vt(Mt({},(s=t.opts)==null?void 0:s.browser),{write:r=>i.write(r)})}),i),chunkLoggerController:i}}function Ui(t){var e;if(typeof t.loggerOverride<"u"&&typeof t.loggerOverride!="string")return{logger:t.loggerOverride,chunkLoggerController:null};let s=Vt(Mt({},t.opts),{level:typeof t.loggerOverride=="string"?t.loggerOverride:(e=t.opts)==null?void 0:e.level});return typeof window<"u"?Np(Vt(Mt({},t),{opts:s})):jp(Vt(Mt({},t),{opts:s}))}var qp=":";function ft(t){let[e,s]=t.split(qp);return{namespace:e,reference:s}}function xn(t,e=[]){let s=[];return Object.keys(t).forEach(i=>{if(e.length&&!e.includes(i))return;let r=t[i];s.push(...r.accounts)}),s}function Rc(t,e){return t.includes(":")?[t]:e.chains||[]}var kp=Object.defineProperty,Lp=Object.defineProperties,Fp=Object.getOwnPropertyDescriptors,Ka=Object.getOwnPropertySymbols,Dp=Object.prototype.hasOwnProperty,Up=Object.prototype.propertyIsEnumerable,ln=(t,e,s)=>e in t?kp(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Ha=(t,e)=>{for(var s in e||(e={}))Dp.call(e,s)&&ln(t,s,e[s]);if(Ka)for(var s of Ka(e))Up.call(e,s)&&ln(t,s,e[s]);return t},Bp=(t,e)=>Lp(t,Fp(e)),Ga=(t,e,s)=>ln(t,typeof e!="symbol"?e+"":e,s),$p="ReactNative",Be={reactNative:"react-native",node:"node",browser:"browser",unknown:"unknown"};var Mp="js";function di(){return typeof ke<"u"&&typeof ke.versions<"u"&&typeof ke.versions.node<"u"}function kt(){return!(0,pt.getDocument)()&&!!(0,pt.getNavigator)()&&navigator.product===$p}function Tc(){return kt()&&typeof globalThis<"u"&&typeof globalThis?.Platform<"u"&&globalThis?.Platform.OS==="android"}function xc(){return kt()&&typeof globalThis<"u"&&typeof globalThis?.Platform<"u"&&globalThis?.Platform.OS==="ios"}function bs(){return!di()&&!!(0,pt.getNavigator)()&&!!(0,pt.getDocument)()}function fi(){return kt()?Be.reactNative:di()?Be.node:bs()?Be.browser:Be.unknown}function An(){var t;try{return kt()&&typeof globalThis<"u"&&typeof globalThis?.Application<"u"?(t=globalThis.Application)==null?void 0:t.applicationId:void 0}catch{return}}function Vp(t,e){let s=new URLSearchParams(t);return Object.entries(e).sort(([i],[r])=>i.localeCompare(r)).forEach(([i,r])=>{r!=null&&s.set(i,String(r))}),s.toString()}function Ac(t){var e,s;let i=Cn();try{return t!=null&&t.url&&i.url&&new URL(t.url).host!==new URL(i.url).host&&(console.warn(`The configured WalletConnect 'metadata.url':${t.url} differs from the actual page url:${i.url}. This is probably unintended and can lead to issues.`),t.url=i.url),(e=t?.icons)!=null&&e.length&&t.icons.length>0&&(t.icons=t.icons.filter(r=>r!=="")),Bp(Ha(Ha({},i),t),{url:t?.url||i.url,name:t?.name||i.name,description:t?.description||i.description,icons:(s=t?.icons)!=null&&s.length&&t.icons.length>0?t.icons:i.icons})}catch(r){return console.warn("Error populating app metadata",r),t||i}}function Cn(){return(0,Oc.getWindowMetadata)()||{name:"",description:"",url:"",icons:[""]}}function zp(){if(fi()===Be.reactNative&&typeof globalThis<"u"&&typeof globalThis?.Platform<"u"){let{OS:s,Version:i}=globalThis.Platform;return[s,i].join("-")}let t=Ra();if(t===null)return"unknown";let e=t.os?t.os.replace(" ","").toLowerCase():"unknown";return t.type==="browser"?[e,t.name,t.version].join("-"):[e,t.version].join("-")}function Kp(){var t;let e=fi();return e===Be.browser?[e,((t=(0,pt.getLocation)())==null?void 0:t.host)||"unknown"].join(":"):e}function Nn(t,e,s){let i=zp(),r=Kp();return[[t,e].join("-"),[Mp,s].join("-"),i,r].join("/")}function Cc({protocol:t,version:e,relayUrl:s,sdkVersion:i,auth:r,projectId:n,useOnCloseEvent:o,bundleId:a,packageName:c}){let l=s.split("?"),h=Nn(t,e,i),u={auth:r,ua:h,projectId:n,useOnCloseEvent:o||void 0,packageName:c||void 0,bundleId:a||void 0},p=Vp(l[1]||"",u);return l[0]+"?"+p}function fs(t,e){return t.filter(s=>e.includes(s)).length===t.length}function Qi(t){return Object.fromEntries(t.entries())}function er(t){return new Map(Object.entries(t))}function Lt(t=jt.FIVE_MINUTES,e){let s=(0,jt.toMiliseconds)(t||jt.FIVE_MINUTES),i,r,n,o;return{resolve:a=>{n&&i&&(clearTimeout(n),i(a),o=Promise.resolve(a))},reject:a=>{n&&r&&(clearTimeout(n),r(a))},done:()=>new Promise((a,c)=>{if(o)return a(o);n=setTimeout(()=>{let l=new Error(e);o=Promise.reject(l),c(l)},s),i=a,r=c})}}function gt(t,e,s){return new Promise(async(i,r)=>{let n=setTimeout(()=>r(new Error(s)),e);try{let o=await t;i(o)}catch(o){r(o)}clearTimeout(n)})}function Nc(t,e){if(typeof e=="string"&&e.startsWith(`${t}:`))return e;if(t.toLowerCase()==="topic"){if(typeof e!="string")throw new Error('Value must be "string" for expirer target type: topic');return`topic:${e}`}else if(t.toLowerCase()==="id"){if(typeof e!="number")throw new Error('Value must be "number" for expirer target type: id');return`id:${e}`}throw new Error(`Unknown expirer target type: ${t}`)}function jc(t){return Nc("topic",t)}function qc(t){return Nc("id",t)}function tr(t){let[e,s]=t.split(":"),i={id:void 0,topic:void 0};if(e==="topic"&&typeof s=="string")i.topic=s;else if(e==="id"&&Number.isInteger(Number(s)))i.id=Number(s);else throw new Error(`Invalid target, expected id:number or topic:string, got ${e}:${s}`);return i}function ce(t,e){return(0,jt.fromMiliseconds)((e||Date.now())+(0,jt.toMiliseconds)(t))}function Ge(t){return Date.now()>=(0,jt.toMiliseconds)(t)}function te(t,e){return`${t}${e?`:${e}`:""}`}function ht(t=[],e=[]){return[...new Set([...t,...e])]}async function kc({id:t,topic:e,wcDeepLink:s}){var i;try{if(!s)return;let r=typeof s=="string"?JSON.parse(s):s,n=r?.href;if(typeof n!="string")return;let o=Hp(n,t,e),a=fi();if(a===Be.browser){if(!((i=(0,pt.getDocument)())!=null&&i.hasFocus())){console.warn("Document does not have focus, skipping deeplink.");return}Gp(o)}else a===Be.reactNative&&typeof globalThis?.Linking<"u"&&await globalThis.Linking.openURL(o)}catch(r){console.error(r)}}function Hp(t,e,s){let i=`requestId=${e}&sessionTopic=${s}`;t.endsWith("/")&&(t=t.slice(0,-1));let r=`${t}`;if(t.startsWith("https://t.me")){let n=t.includes("?")?"&startapp=":"?startapp=";r=`${r}${n}${Jp(i,!0)}`}else r=`${r}/wc?${i}`;return r}function Gp(t){let e="_self";Yp()?e="_top":(Wp()||t.startsWith("https://")||t.startsWith("http://"))&&(e="_blank"),window.open(t,e,"noreferrer noopener")}async function Lc(t,e){let s="";try{if(bs()&&(s=localStorage.getItem(e),s))return s;s=await t.getItem(e)}catch(i){console.error(i)}return s}function jn(t,e){if(!t.includes(e))return null;let s=t.split(/([&,?,=])/),i=s.indexOf(e);return s[i+2]}function qn(){return typeof crypto<"u"&&crypto!=null&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/gu,t=>{let e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)})}function gi(){return typeof ke<"u"&&ke.env.IS_VITEST==="true"}function Wp(){return typeof window<"u"&&(!!window.TelegramWebviewProxy||!!window.Telegram||!!window.TelegramWebviewProxyProto)}function Yp(){try{return window.self!==window.top}catch{return!1}}function Jp(t,e=!1){let s=K.from(t).toString("base64");return e?s.replace(/[=]/g,""):s}function Fc(t){return K.from(t,"base64").toString("utf-8")}function Dc(t){return new Promise(e=>setTimeout(e,t))}var Ki=class{constructor({limit:e}){Ga(this,"limit"),Ga(this,"set"),this.limit=e,this.set=new Set}add(e){if(!this.set.has(e)){if(this.set.size>=this.limit){let s=this.set.values().next().value;s&&this.set.delete(s)}this.set.add(e)}}has(e){return this.set.has(e)}},Bi=BigInt(2**32-1),Wa=BigInt(32);function Uc(t,e=!1){return e?{h:Number(t&Bi),l:Number(t>>Wa&Bi)}:{h:Number(t>>Wa&Bi)|0,l:Number(t&Bi)|0}}function Bc(t,e=!1){let s=t.length,i=new Uint32Array(s),r=new Uint32Array(s);for(let n=0;n<s;n++){let{h:o,l:a}=Uc(t[n],e);[i[n],r[n]]=[o,a]}return[i,r]}var Ya=(t,e,s)=>t>>>s,Ja=(t,e,s)=>t<<32-s|e>>>s,Jt=(t,e,s)=>t>>>s|e<<32-s,Xt=(t,e,s)=>t<<32-s|e>>>s,ai=(t,e,s)=>t<<64-s|e>>>s-32,ci=(t,e,s)=>t>>>s-32|e<<64-s,Xp=(t,e)=>e,Zp=(t,e)=>t,Qp=(t,e,s)=>t<<s|e>>>32-s,ed=(t,e,s)=>e<<s|t>>>32-s,td=(t,e,s)=>e<<s-32|t>>>64-s,sd=(t,e,s)=>t<<s-32|e>>>64-s;function lt(t,e,s,i){let r=(e>>>0)+(i>>>0);return{h:t+s+(r/2**32|0)|0,l:r|0}}var kn=(t,e,s)=>(t>>>0)+(e>>>0)+(s>>>0),Ln=(t,e,s,i)=>e+s+i+(t/2**32|0)|0,id=(t,e,s,i)=>(t>>>0)+(e>>>0)+(s>>>0)+(i>>>0),rd=(t,e,s,i,r)=>e+s+i+r+(t/2**32|0)|0,nd=(t,e,s,i,r)=>(t>>>0)+(e>>>0)+(s>>>0)+(i>>>0)+(r>>>0),od=(t,e,s,i,r,n)=>e+s+i+r+n+(t/2**32|0)|0,Cs=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;function sr(t){return t instanceof Uint8Array||ArrayBuffer.isView(t)&&t.constructor.name==="Uint8Array"}function qt(t){if(!Number.isSafeInteger(t)||t<0)throw new Error("positive integer expected, got "+t)}function dt(t,...e){if(!sr(t))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw new Error("Uint8Array expected of length "+e+", got length="+t.length)}function ir(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");qt(t.outputLen),qt(t.blockLen)}function ts(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function Fn(t,e){dt(t);let s=e.outputLen;if(t.length<s)throw new Error("digestInto() expects output buffer of length at least "+s)}function hi(t){return new Uint32Array(t.buffer,t.byteOffset,Math.floor(t.byteLength/4))}function tt(...t){for(let e=0;e<t.length;e++)t[e].fill(0)}function Jr(t){return new DataView(t.buffer,t.byteOffset,t.byteLength)}function vt(t,e){return t<<32-e|t>>>e}var $c=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function Mc(t){return t<<24&4278190080|t<<8&16711680|t>>>8&65280|t>>>24&255}var At=$c?t=>t:t=>Mc(t);function ad(t){for(let e=0;e<t.length;e++)t[e]=Mc(t[e]);return t}var Zt=$c?t=>t:ad,Vc=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",cd=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function qs(t){if(dt(t),Vc)return t.toHex();let e="";for(let s=0;s<t.length;s++)e+=cd[t[s]];return e}var xt={_0:48,_9:57,A:65,F:70,a:97,f:102};function Xa(t){if(t>=xt._0&&t<=xt._9)return t-xt._0;if(t>=xt.A&&t<=xt.F)return t-(xt.A-10);if(t>=xt.a&&t<=xt.f)return t-(xt.a-10)}function Hi(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);if(Vc)return Uint8Array.fromHex(t);let e=t.length,s=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);let i=new Uint8Array(s);for(let r=0,n=0;r<s;r++,n+=2){let o=Xa(t.charCodeAt(n)),a=Xa(t.charCodeAt(n+1));if(o===void 0||a===void 0){let c=t[n]+t[n+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+n)}i[r]=o*16+a}return i}function zc(t){if(typeof t!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(t))}function ut(t){return typeof t=="string"&&(t=zc(t)),dt(t),t}function Qt(...t){let e=0;for(let i=0;i<t.length;i++){let r=t[i];dt(r),e+=r.length}let s=new Uint8Array(e);for(let i=0,r=0;i<t.length;i++){let n=t[i];s.set(n,r),r+=n.length}return s}var Ls=class{};function yi(t){let e=i=>t().update(ut(i)).digest(),s=t();return e.outputLen=s.outputLen,e.blockLen=s.blockLen,e.create=()=>t(),e}function ld(t){let e=(i,r)=>t(r).update(ut(i)).digest(),s=t({});return e.outputLen=s.outputLen,e.blockLen=s.blockLen,e.create=i=>t(i),e}function vs(t=32){if(Cs&&typeof Cs.getRandomValues=="function")return Cs.getRandomValues(new Uint8Array(t));if(Cs&&typeof Cs.randomBytes=="function")return Uint8Array.from(Cs.randomBytes(t));throw new Error("crypto.getRandomValues must be defined")}var hd=BigInt(0),ni=BigInt(1),ud=BigInt(2),pd=BigInt(7),dd=BigInt(256),fd=BigInt(113),Kc=[],Hc=[],Gc=[];for(let t=0,e=ni,s=1,i=0;t<24;t++){[s,i]=[i,(2*s+3*i)%5],Kc.push(2*(5*i+s)),Hc.push((t+1)*(t+2)/2%64);let r=hd;for(let n=0;n<7;n++)e=(e<<ni^(e>>pd)*fd)%dd,e&ud&&(r^=ni<<(ni<<BigInt(n))-ni);Gc.push(r)}var Wc=Bc(Gc,!0),gd=Wc[0],yd=Wc[1],Za=(t,e,s)=>s>32?td(t,e,s):Qp(t,e,s),Qa=(t,e,s)=>s>32?sd(t,e,s):ed(t,e,s);function md(t,e=24){let s=new Uint32Array(10);for(let i=24-e;i<24;i++){for(let o=0;o<10;o++)s[o]=t[o]^t[o+10]^t[o+20]^t[o+30]^t[o+40];for(let o=0;o<10;o+=2){let a=(o+8)%10,c=(o+2)%10,l=s[c],h=s[c+1],u=Za(l,h,1)^s[a],p=Qa(l,h,1)^s[a+1];for(let d=0;d<50;d+=10)t[o+d]^=u,t[o+d+1]^=p}let r=t[2],n=t[3];for(let o=0;o<24;o++){let a=Hc[o],c=Za(r,n,a),l=Qa(r,n,a),h=Kc[o];r=t[h],n=t[h+1],t[h]=c,t[h+1]=l}for(let o=0;o<50;o+=10){for(let a=0;a<10;a++)s[a]=t[o+a];for(let a=0;a<10;a++)t[o+a]^=~s[(a+2)%10]&s[(a+4)%10]}t[0]^=gd[i],t[1]^=yd[i]}tt(s)}var hn=class t extends Ls{constructor(e,s,i,r=!1,n=24){if(super(),this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,this.enableXOF=!1,this.blockLen=e,this.suffix=s,this.outputLen=i,this.enableXOF=r,this.rounds=n,qt(i),!(0<e&&e<200))throw new Error("only keccak-f1600 function is supported");this.state=new Uint8Array(200),this.state32=hi(this.state)}clone(){return this._cloneInto()}keccak(){Zt(this.state32),md(this.state32,this.rounds),Zt(this.state32),this.posOut=0,this.pos=0}update(e){ts(this),e=ut(e),dt(e);let{blockLen:s,state:i}=this,r=e.length;for(let n=0;n<r;){let o=Math.min(s-this.pos,r-n);for(let a=0;a<o;a++)i[this.pos++]^=e[n++];this.pos===s&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;let{state:e,suffix:s,pos:i,blockLen:r}=this;e[i]^=s,(s&128)!==0&&i===r-1&&this.keccak(),e[r-1]^=128,this.keccak()}writeInto(e){ts(this,!1),dt(e),this.finish();let s=this.state,{blockLen:i}=this;for(let r=0,n=e.length;r<n;){this.posOut>=i&&this.keccak();let o=Math.min(i-this.posOut,n-r);e.set(s.subarray(this.posOut,this.posOut+o),r),this.posOut+=o,r+=o}return e}xofInto(e){if(!this.enableXOF)throw new Error("XOF is not possible for this instance");return this.writeInto(e)}xof(e){return qt(e),this.xofInto(new Uint8Array(e))}digestInto(e){if(Fn(e,this),this.finished)throw new Error("digest() was already called");return this.writeInto(e),this.destroy(),e}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,tt(this.state)}_cloneInto(e){let{blockLen:s,suffix:i,outputLen:r,rounds:n,enableXOF:o}=this;return e||(e=new t(s,i,r,o,n)),e.state32.set(this.state32),e.pos=this.pos,e.posOut=this.posOut,e.finished=this.finished,e.rounds=n,e.suffix=i,e.outputLen=r,e.enableXOF=o,e.destroyed=this.destroyed,e}},wd=(t,e,s)=>yi(()=>new hn(e,t,s)),bd=wd(1,136,256/8);function vd(t,e,s,i){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,s,i);let r=BigInt(32),n=BigInt(4294967295),o=Number(s>>r&n),a=Number(s&n),c=i?4:0,l=i?0:4;t.setUint32(e+c,o,i),t.setUint32(e+l,a,i)}function Ed(t,e,s){return t&e^~t&s}function _d(t,e,s){return t&e^t&s^e&s}var Gi=class extends Ls{constructor(e,s,i,r){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=s,this.padOffset=i,this.isLE=r,this.buffer=new Uint8Array(e),this.view=Jr(this.buffer)}update(e){ts(this),e=ut(e),dt(e);let{view:s,buffer:i,blockLen:r}=this,n=e.length;for(let o=0;o<n;){let a=Math.min(r-this.pos,n-o);if(a===r){let c=Jr(e);for(;r<=n-o;o+=r)this.process(c,o);continue}i.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===r&&(this.process(s,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){ts(this),Fn(e,this),this.finished=!0;let{buffer:s,view:i,blockLen:r,isLE:n}=this,{pos:o}=this;s[o++]=128,tt(this.buffer.subarray(o)),this.padOffset>r-o&&(this.process(i,0),o=0);for(let u=o;u<r;u++)s[u]=0;vd(i,r-8,BigInt(this.length*8),n),this.process(i,0);let a=Jr(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let l=c/4,h=this.get();if(l>h.length)throw new Error("_sha2: outputLen bigger than state");for(let u=0;u<l;u++)a.setUint32(4*u,h[u],n)}digest(){let{buffer:e,outputLen:s}=this;this.digestInto(e);let i=e.slice(0,s);return this.destroy(),i}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:s,buffer:i,length:r,finished:n,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=n,e.length=r,e.pos=a,r%s&&e.buffer.set(i),e}clone(){return this._cloneInto()}},zt=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Se=Uint32Array.from([3418070365,3238371032,1654270250,914150663,2438529370,812702999,355462360,4144912697,1731405415,4290775857,2394180231,1750603025,3675008525,1694076839,1203062813,3204075428]),Oe=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),Id=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Kt=new Uint32Array(64),un=class extends Gi{constructor(e=32){super(64,e,8,!1),this.A=zt[0]|0,this.B=zt[1]|0,this.C=zt[2]|0,this.D=zt[3]|0,this.E=zt[4]|0,this.F=zt[5]|0,this.G=zt[6]|0,this.H=zt[7]|0}get(){let{A:e,B:s,C:i,D:r,E:n,F:o,G:a,H:c}=this;return[e,s,i,r,n,o,a,c]}set(e,s,i,r,n,o,a,c){this.A=e|0,this.B=s|0,this.C=i|0,this.D=r|0,this.E=n|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,s){for(let u=0;u<16;u++,s+=4)Kt[u]=e.getUint32(s,!1);for(let u=16;u<64;u++){let p=Kt[u-15],d=Kt[u-2],f=vt(p,7)^vt(p,18)^p>>>3,g=vt(d,17)^vt(d,19)^d>>>10;Kt[u]=g+Kt[u-7]+f+Kt[u-16]|0}let{A:i,B:r,C:n,D:o,E:a,F:c,G:l,H:h}=this;for(let u=0;u<64;u++){let p=vt(a,6)^vt(a,11)^vt(a,25),d=h+p+Ed(a,c,l)+Id[u]+Kt[u]|0,f=(vt(i,2)^vt(i,13)^vt(i,22))+_d(i,r,n)|0;h=l,l=c,c=a,a=o+d|0,o=n,n=r,r=i,i=d+f|0}i=i+this.A|0,r=r+this.B|0,n=n+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,h=h+this.H|0,this.set(i,r,n,o,a,c,l,h)}roundClean(){tt(Kt)}destroy(){this.set(0,0,0,0,0,0,0,0),tt(this.buffer)}},Yc=Bc(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(t=>BigInt(t))),Sd=Yc[0],Od=Yc[1],Ht=new Uint32Array(80),Gt=new Uint32Array(80),ui=class extends Gi{constructor(e=64){super(128,e,16,!1),this.Ah=Oe[0]|0,this.Al=Oe[1]|0,this.Bh=Oe[2]|0,this.Bl=Oe[3]|0,this.Ch=Oe[4]|0,this.Cl=Oe[5]|0,this.Dh=Oe[6]|0,this.Dl=Oe[7]|0,this.Eh=Oe[8]|0,this.El=Oe[9]|0,this.Fh=Oe[10]|0,this.Fl=Oe[11]|0,this.Gh=Oe[12]|0,this.Gl=Oe[13]|0,this.Hh=Oe[14]|0,this.Hl=Oe[15]|0}get(){let{Ah:e,Al:s,Bh:i,Bl:r,Ch:n,Cl:o,Dh:a,Dl:c,Eh:l,El:h,Fh:u,Fl:p,Gh:d,Gl:f,Hh:g,Hl:y}=this;return[e,s,i,r,n,o,a,c,l,h,u,p,d,f,g,y]}set(e,s,i,r,n,o,a,c,l,h,u,p,d,f,g,y){this.Ah=e|0,this.Al=s|0,this.Bh=i|0,this.Bl=r|0,this.Ch=n|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=h|0,this.Fh=u|0,this.Fl=p|0,this.Gh=d|0,this.Gl=f|0,this.Hh=g|0,this.Hl=y|0}process(e,s){for(let S=0;S<16;S++,s+=4)Ht[S]=e.getUint32(s),Gt[S]=e.getUint32(s+=4);for(let S=16;S<80;S++){let q=Ht[S-15]|0,B=Gt[S-15]|0,N=Jt(q,B,1)^Jt(q,B,8)^Ya(q,B,7),D=Xt(q,B,1)^Xt(q,B,8)^Ja(q,B,7),U=Ht[S-2]|0,_=Gt[S-2]|0,F=Jt(U,_,19)^ai(U,_,61)^Ya(U,_,6),M=Xt(U,_,19)^ci(U,_,61)^Ja(U,_,6),R=id(D,M,Gt[S-7],Gt[S-16]),m=rd(R,N,F,Ht[S-7],Ht[S-16]);Ht[S]=m|0,Gt[S]=R|0}let{Ah:i,Al:r,Bh:n,Bl:o,Ch:a,Cl:c,Dh:l,Dl:h,Eh:u,El:p,Fh:d,Fl:f,Gh:g,Gl:y,Hh:P,Hl:x}=this;for(let S=0;S<80;S++){let q=Jt(u,p,14)^Jt(u,p,18)^ai(u,p,41),B=Xt(u,p,14)^Xt(u,p,18)^ci(u,p,41),N=u&d^~u&g,D=p&f^~p&y,U=nd(x,B,D,Od[S],Gt[S]),_=od(U,P,q,N,Sd[S],Ht[S]),F=U|0,M=Jt(i,r,28)^ai(i,r,34)^ai(i,r,39),R=Xt(i,r,28)^ci(i,r,34)^ci(i,r,39),m=i&n^i&a^n&a,w=r&o^r&c^o&c;P=g|0,x=y|0,g=d|0,y=f|0,d=u|0,f=p|0,{h:u,l:p}=lt(l|0,h|0,_|0,F|0),l=a|0,h=c|0,a=n|0,c=o|0,n=i|0,o=r|0;let b=kn(F,R,w);i=Ln(b,_,M,m),r=b|0}({h:i,l:r}=lt(this.Ah|0,this.Al|0,i|0,r|0)),{h:n,l:o}=lt(this.Bh|0,this.Bl|0,n|0,o|0),{h:a,l:c}=lt(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:h}=lt(this.Dh|0,this.Dl|0,l|0,h|0),{h:u,l:p}=lt(this.Eh|0,this.El|0,u|0,p|0),{h:d,l:f}=lt(this.Fh|0,this.Fl|0,d|0,f|0),{h:g,l:y}=lt(this.Gh|0,this.Gl|0,g|0,y|0),{h:P,l:x}=lt(this.Hh|0,this.Hl|0,P|0,x|0),this.set(i,r,n,o,a,c,l,h,u,p,d,f,g,y,P,x)}roundClean(){tt(Ht,Gt)}destroy(){tt(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},pn=class extends ui{constructor(){super(48),this.Ah=Se[0]|0,this.Al=Se[1]|0,this.Bh=Se[2]|0,this.Bl=Se[3]|0,this.Ch=Se[4]|0,this.Cl=Se[5]|0,this.Dh=Se[6]|0,this.Dl=Se[7]|0,this.Eh=Se[8]|0,this.El=Se[9]|0,this.Fh=Se[10]|0,this.Fl=Se[11]|0,this.Gh=Se[12]|0,this.Gl=Se[13]|0,this.Hh=Se[14]|0,this.Hl=Se[15]|0}},Pe=Uint32Array.from([573645204,4230739756,2673172387,3360449730,596883563,1867755857,2520282905,1497426621,2519219938,2827943907,3193839141,1401305490,721525244,746961066,246885852,2177182882]),dn=class extends ui{constructor(){super(32),this.Ah=Pe[0]|0,this.Al=Pe[1]|0,this.Bh=Pe[2]|0,this.Bl=Pe[3]|0,this.Ch=Pe[4]|0,this.Cl=Pe[5]|0,this.Dh=Pe[6]|0,this.Dl=Pe[7]|0,this.Eh=Pe[8]|0,this.El=Pe[9]|0,this.Fh=Pe[10]|0,this.Fl=Pe[11]|0,this.Gh=Pe[12]|0,this.Gl=Pe[13]|0,this.Hh=Pe[14]|0,this.Hl=Pe[15]|0}},rr=yi(()=>new un),Pd=yi(()=>new ui),Rd=yi(()=>new pn),Td=yi(()=>new dn),xd=Uint8Array.from([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3,11,8,12,0,5,2,15,13,10,14,3,6,7,1,9,4,7,9,3,1,13,12,11,14,2,6,5,10,4,0,15,8,9,0,5,7,2,4,10,15,14,1,11,12,6,8,3,13,2,12,6,10,0,11,8,3,4,13,7,5,15,14,1,9,12,5,1,15,14,13,4,10,0,7,6,3,9,2,8,11,13,11,7,14,12,1,3,9,5,0,15,4,8,6,2,10,6,15,14,9,11,3,0,8,12,2,13,7,1,4,10,5,10,2,8,4,7,6,1,5,15,11,9,14,3,12,13,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3,11,8,12,0,5,2,15,13,10,14,3,6,7,1,9,4,7,9,3,1,13,12,11,14,2,6,5,10,4,0,15,8,9,0,5,7,2,4,10,15,14,1,11,12,6,8,3,13,2,12,6,10,0,11,8,3,4,13,7,5,15,14,1,9]),fe=Uint32Array.from([4089235720,1779033703,2227873595,3144134277,4271175723,1013904242,1595750129,2773480762,2917565137,1359893119,725511199,2600822924,4215389547,528734635,327033209,1541459225]),j=new Uint32Array(32);function Wt(t,e,s,i,r,n){let o=r[n],a=r[n+1],c=j[2*t],l=j[2*t+1],h=j[2*e],u=j[2*e+1],p=j[2*s],d=j[2*s+1],f=j[2*i],g=j[2*i+1],y=kn(c,h,o);l=Ln(y,l,u,a),c=y|0,{Dh:g,Dl:f}={Dh:g^l,Dl:f^c},{Dh:g,Dl:f}={Dh:Xp(g,f),Dl:Zp(g)},{h:d,l:p}=lt(d,p,g,f),{Bh:u,Bl:h}={Bh:u^d,Bl:h^p},{Bh:u,Bl:h}={Bh:Jt(u,h,24),Bl:Xt(u,h,24)},j[2*t]=c,j[2*t+1]=l,j[2*e]=h,j[2*e+1]=u,j[2*s]=p,j[2*s+1]=d,j[2*i]=f,j[2*i+1]=g}function Yt(t,e,s,i,r,n){let o=r[n],a=r[n+1],c=j[2*t],l=j[2*t+1],h=j[2*e],u=j[2*e+1],p=j[2*s],d=j[2*s+1],f=j[2*i],g=j[2*i+1],y=kn(c,h,o);l=Ln(y,l,u,a),c=y|0,{Dh:g,Dl:f}={Dh:g^l,Dl:f^c},{Dh:g,Dl:f}={Dh:Jt(g,f,16),Dl:Xt(g,f,16)},{h:d,l:p}=lt(d,p,g,f),{Bh:u,Bl:h}={Bh:u^d,Bl:h^p},{Bh:u,Bl:h}={Bh:ai(u,h,63),Bl:ci(u,h,63)},j[2*t]=c,j[2*t+1]=l,j[2*e]=h,j[2*e+1]=u,j[2*s]=p,j[2*s+1]=d,j[2*i]=f,j[2*i+1]=g}function Ad(t,e={},s,i,r){if(qt(s),t<0||t>s)throw new Error("outputLen bigger than keyLen");let{key:n,salt:o,personalization:a}=e;if(n!==void 0&&(n.length<1||n.length>s))throw new Error("key length must be undefined or 1.."+s);if(o!==void 0&&o.length!==i)throw new Error("salt must be undefined or "+i);if(a!==void 0&&a.length!==r)throw new Error("personalization must be undefined or "+r)}var fn=class extends Ls{constructor(e,s){super(),this.finished=!1,this.destroyed=!1,this.length=0,this.pos=0,qt(e),qt(s),this.blockLen=e,this.outputLen=s,this.buffer=new Uint8Array(e),this.buffer32=hi(this.buffer)}update(e){ts(this),e=ut(e),dt(e);let{blockLen:s,buffer:i,buffer32:r}=this,n=e.length,o=e.byteOffset,a=e.buffer;for(let c=0;c<n;){this.pos===s&&(Zt(r),this.compress(r,0,!1),Zt(r),this.pos=0);let l=Math.min(s-this.pos,n-c),h=o+c;if(l===s&&!(h%4)&&c+l<n){let u=new Uint32Array(a,h,Math.floor((n-c)/4));Zt(u);for(let p=0;c+s<n;p+=r.length,c+=s)this.length+=s,this.compress(u,p,!1);Zt(u);continue}i.set(e.subarray(c,c+l),this.pos),this.pos+=l,this.length+=l,c+=l}return this}digestInto(e){ts(this),Fn(e,this);let{pos:s,buffer32:i}=this;this.finished=!0,tt(this.buffer.subarray(s)),Zt(i),this.compress(i,0,!0),Zt(i);let r=hi(e);this.get().forEach((n,o)=>r[o]=At(n))}digest(){let{buffer:e,outputLen:s}=this;this.digestInto(e);let i=e.slice(0,s);return this.destroy(),i}_cloneInto(e){let{buffer:s,length:i,finished:r,destroyed:n,outputLen:o,pos:a}=this;return e||(e=new this.constructor({dkLen:o})),e.set(...this.get()),e.buffer.set(s),e.destroyed=n,e.finished=r,e.length=i,e.pos=a,e.outputLen=o,e}clone(){return this._cloneInto()}},gn=class extends fn{constructor(e={}){let s=e.dkLen===void 0?64:e.dkLen;super(128,s),this.v0l=fe[0]|0,this.v0h=fe[1]|0,this.v1l=fe[2]|0,this.v1h=fe[3]|0,this.v2l=fe[4]|0,this.v2h=fe[5]|0,this.v3l=fe[6]|0,this.v3h=fe[7]|0,this.v4l=fe[8]|0,this.v4h=fe[9]|0,this.v5l=fe[10]|0,this.v5h=fe[11]|0,this.v6l=fe[12]|0,this.v6h=fe[13]|0,this.v7l=fe[14]|0,this.v7h=fe[15]|0,Ad(s,e,64,16,16);let{key:i,personalization:r,salt:n}=e,o=0;if(i!==void 0&&(i=ut(i),o=i.length),this.v0l^=this.outputLen|o<<8|65536|1<<24,n!==void 0){n=ut(n);let a=hi(n);this.v4l^=At(a[0]),this.v4h^=At(a[1]),this.v5l^=At(a[2]),this.v5h^=At(a[3])}if(r!==void 0){r=ut(r);let a=hi(r);this.v6l^=At(a[0]),this.v6h^=At(a[1]),this.v7l^=At(a[2]),this.v7h^=At(a[3])}if(i!==void 0){let a=new Uint8Array(this.blockLen);a.set(i),this.update(a)}}get(){let{v0l:e,v0h:s,v1l:i,v1h:r,v2l:n,v2h:o,v3l:a,v3h:c,v4l:l,v4h:h,v5l:u,v5h:p,v6l:d,v6h:f,v7l:g,v7h:y}=this;return[e,s,i,r,n,o,a,c,l,h,u,p,d,f,g,y]}set(e,s,i,r,n,o,a,c,l,h,u,p,d,f,g,y){this.v0l=e|0,this.v0h=s|0,this.v1l=i|0,this.v1h=r|0,this.v2l=n|0,this.v2h=o|0,this.v3l=a|0,this.v3h=c|0,this.v4l=l|0,this.v4h=h|0,this.v5l=u|0,this.v5h=p|0,this.v6l=d|0,this.v6h=f|0,this.v7l=g|0,this.v7h=y|0}compress(e,s,i){this.get().forEach((c,l)=>j[l]=c),j.set(fe,16);let{h:r,l:n}=Uc(BigInt(this.length));j[24]=fe[8]^n,j[25]=fe[9]^r,i&&(j[28]=~j[28],j[29]=~j[29]);let o=0,a=xd;for(let c=0;c<12;c++)Wt(0,4,8,12,e,s+2*a[o++]),Yt(0,4,8,12,e,s+2*a[o++]),Wt(1,5,9,13,e,s+2*a[o++]),Yt(1,5,9,13,e,s+2*a[o++]),Wt(2,6,10,14,e,s+2*a[o++]),Yt(2,6,10,14,e,s+2*a[o++]),Wt(3,7,11,15,e,s+2*a[o++]),Yt(3,7,11,15,e,s+2*a[o++]),Wt(0,5,10,15,e,s+2*a[o++]),Yt(0,5,10,15,e,s+2*a[o++]),Wt(1,6,11,12,e,s+2*a[o++]),Yt(1,6,11,12,e,s+2*a[o++]),Wt(2,7,8,13,e,s+2*a[o++]),Yt(2,7,8,13,e,s+2*a[o++]),Wt(3,4,9,14,e,s+2*a[o++]),Yt(3,4,9,14,e,s+2*a[o++]);this.v0l^=j[0]^j[16],this.v0h^=j[1]^j[17],this.v1l^=j[2]^j[18],this.v1h^=j[3]^j[19],this.v2l^=j[4]^j[20],this.v2h^=j[5]^j[21],this.v3l^=j[6]^j[22],this.v3h^=j[7]^j[23],this.v4l^=j[8]^j[24],this.v4h^=j[9]^j[25],this.v5l^=j[10]^j[26],this.v5h^=j[11]^j[27],this.v6l^=j[12]^j[28],this.v6h^=j[13]^j[29],this.v7l^=j[14]^j[30],this.v7h^=j[15]^j[31],tt(j)}destroy(){this.destroyed=!0,tt(this.buffer32),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},Cd=ld(t=>new gn(t)),Nd="https://rpc.walletconnect.org/v1";function Jc(t){let e=`Ethereum Signed Message:
${t.length}`,s=new TextEncoder().encode(e+t);return"0x"+K.from(bd(s)).toString("hex")}async function jd(t,e,s,i,r,n){switch(s.t){case"eip191":return await qd(t,e,s.s);case"eip1271":return await kd(t,e,s.s,i,r,n);default:throw new Error(`verifySignature failed: Attempted to verify CacaoSignature with unknown type: ${s.t}`)}}function qd(t,e,s){let i=qa.fromHex(s);return ka.recoverAddress({payload:Jc(e),signature:i}).toLowerCase()===t.toLowerCase()}async function kd(t,e,s,i,r,n){let o=ft(i);if(!o.namespace||!o.reference)throw new Error(`isValidEip1271Signature failed: chainId must be in CAIP-2 format, received: ${i}`);try{let a="0x1626ba7e",c="0000000000000000000000000000000000000000000000000000000000000040",l=s.substring(2),h=(l.length/2).toString(16).padStart(64,"0"),u=(e.startsWith("0x")?e:Jc(e)).substring(2),p=a+u+c+h+l,d=await fetch(`${n||Nd}/?chainId=${i}&projectId=${r}`,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify({id:Ld(),jsonrpc:"2.0",method:"eth_call",params:[{to:t,data:p},"latest"]})}),{result:f}=await d.json();return f?f.slice(0,a.length).toLowerCase()===a.toLowerCase():!1}catch(a){return console.error("isValidEip1271Signature: ",a),!1}}function Ld(){return Date.now()+Math.floor(Math.random()*1e3)}function Xc(t){let e=atob(t),s=new Uint8Array(e.length);for(let o=0;o<e.length;o++)s[o]=e.charCodeAt(o);let i=s[0];if(i===0)throw new Error("No signatures found");let r=1+i*64;if(s.length<r)throw new Error("Transaction data too short for claimed signature count");if(s.length<100)throw new Error("Transaction too short");let n=K.from(t,"base64").slice(1,65);return Rs.encode(n)}function Zc(t){let e=new Uint8Array(K.from(t,"base64")),s=Array.from("TransactionData::").map(n=>n.charCodeAt(0)),i=new Uint8Array(s.length+e.length);i.set(s),i.set(e,s.length);let r=Cd(i,{dkLen:32});return Rs.encode(r)}function Dn(t){let e=new Uint8Array(rr(Fd(t)));return Rs.encode(e)}function Fd(t){if(t instanceof Uint8Array)return t;if(Array.isArray(t))return new Uint8Array(t);if(typeof t=="object"&&t!=null&&t.data)return new Uint8Array(Object.values(t.data));if(typeof t=="object"&&t)return new Uint8Array(Object.values(t));throw new Error("getNearUint8ArrayFromBytes: Unexpected result type from bytes array")}function Un(t){let e=K.from(t,"base64"),s=Ca(e).txn;if(!s)throw new Error("Invalid signed transaction: missing 'txn' field");let i=Aa(s),r=K.from("TX"),n=K.concat([r,K.from(i)]),o=Td(n);return xa.encode(o).replace(/=+$/,"")}function Xr(t){let e=[],s=BigInt(t);for(;s>=BigInt(128);)e.push(Number(s&BigInt(127)|BigInt(128))),s>>=BigInt(7);return e.push(Number(s)),K.from(e)}function Qc(t){let e=K.from(t.signed.bodyBytes,"base64"),s=K.from(t.signed.authInfoBytes,"base64"),i=K.from(t.signature.signature,"base64"),r=[];r.push(K.from([10])),r.push(Xr(e.length)),r.push(e),r.push(K.from([18])),r.push(Xr(s.length)),r.push(s),r.push(K.from([26])),r.push(Xr(i.length)),r.push(i);let n=K.concat(r),o=rr(n);return K.from(o).toString("hex").toUpperCase()}function el(t){var e,s;let i=[];try{if(typeof t=="string")return i.push(t),i;if(typeof t!="object")return i;t!=null&&t.id&&i.push(t.id);let r=(s=(e=t?.capabilities)==null?void 0:e.caip345)==null?void 0:s.transactionHashes;r&&i.push(...r)}catch(r){console.warn("getWalletSendCallsHashes failed: ",r)}return i}var Dd=Object.defineProperty,Ud=Object.defineProperties,Bd=Object.getOwnPropertyDescriptors,ec=Object.getOwnPropertySymbols,$d=Object.prototype.hasOwnProperty,Md=Object.prototype.propertyIsEnumerable,tc=(t,e,s)=>e in t?Dd(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Vd=(t,e)=>{for(var s in e||(e={}))$d.call(e,s)&&tc(t,s,e[s]);if(ec)for(var s of ec(e))Md.call(e,s)&&tc(t,s,e[s]);return t},zd=(t,e)=>Ud(t,Bd(e)),tl="did:pkh:",Kd={eip155:"Ethereum",solana:"Solana",bip122:"Bitcoin"},Hd=t=>t?Kd[t]||t:"",nr=t=>t?.split(":"),Gd=t=>{let e=t&&nr(t);if(e)return t.includes(tl)?e[3]:e[1]},Wd=t=>{let e=t&&nr(t);if(e)return t.includes(tl)?e[2]:e[0]},or=t=>{let e=t&&nr(t);if(e)return e[2]+":"+e[3]},mi=t=>{let e=t&&nr(t);if(e)return e.pop()};async function Bn(t){let{cacao:e,projectId:s}=t,{s:i,p:r}=e,n=$n(r,r.iss),o=mi(r.iss);return await jd(o,n,i,or(r.iss),s)}var $n=(t,e)=>{let s=Wd(e);if(!s)throw new Error("Invalid issuer: "+e);let i=`${t.domain} wants you to sign in with your ${Hd(s)} account:`,r=mi(e);if(!t.aud&&!t.uri)throw new Error("Either `aud` or `uri` is required to construct the message");let n=t.statement||void 0,o=`URI: ${t.aud||t.uri}`,a=`Version: ${t.version}`,c=`Chain ID: ${Gd(e)}`,l=`Nonce: ${t.nonce}`,h=`Issued At: ${t.iat}`,u=t.exp?`Expiration Time: ${t.exp}`:void 0,p=t.nbf?`Not Before: ${t.nbf}`:void 0,d=t.requestId?`Request ID: ${t.requestId}`:void 0,f=t.resources?`Resources:${t.resources.map(y=>`
- ${y}`).join("")}`:void 0,g=wi(t.resources);if(g){let y=pi(g);n=tf(n,y)}return[i,r,"",n,"",o,a,c,l,h,u,p,d,f].filter(y=>y!=null).join(`
`)};function Yd(t){return K.from(JSON.stringify(t)).toString("base64")}function Jd(t){return JSON.parse(K.from(t,"base64").toString("utf-8"))}function ws(t){if(!t)throw new Error("No recap provided, value is undefined");if(!t.att)throw new Error("No `att` property found");let e=Object.keys(t.att);if(!(e!=null&&e.length))throw new Error("No resources found in `att` property");e.forEach(s=>{let i=t.att[s];if(Array.isArray(i))throw new Error(`Resource must be an object: ${s}`);if(typeof i!="object")throw new Error(`Resource must be an object: ${s}`);if(!Object.keys(i).length)throw new Error(`Resource object is empty: ${s}`);Object.keys(i).forEach(r=>{let n=i[r];if(!Array.isArray(n))throw new Error(`Ability limits ${r} must be an array of objects, found: ${n}`);if(!n.length)throw new Error(`Value of ${r} is empty array, must be an array with objects`);n.forEach(o=>{if(typeof o!="object")throw new Error(`Ability limits (${r}) must be an array of objects, found: ${o}`)})})})}function Xd(t,e,s,i={}){return s?.sort((r,n)=>r.localeCompare(n)),{att:{[t]:Zd(e,s,i)}}}function Zd(t,e,s={}){e=e?.sort((r,n)=>r.localeCompare(n));let i=e.map(r=>({[`${t}/${r}`]:[s]}));return Object.assign({},...i)}function sl(t){return ws(t),`urn:recap:${Yd(t).replace(/=/g,"")}`}function pi(t){let e=Jd(t.replace("urn:recap:",""));return ws(e),e}function il(t,e,s){let i=Xd(t,e,s);return sl(i)}function Qd(t){return t&&t.includes("urn:recap:")}function rl(t,e){let s=pi(t),i=pi(e),r=ef(s,i);return sl(r)}function ef(t,e){ws(t),ws(e);let s=Object.keys(t.att).concat(Object.keys(e.att)).sort((r,n)=>r.localeCompare(n)),i={att:{}};return s.forEach(r=>{var n,o;Object.keys(((n=t.att)==null?void 0:n[r])||{}).concat(Object.keys(((o=e.att)==null?void 0:o[r])||{})).sort((a,c)=>a.localeCompare(c)).forEach(a=>{var c,l;i.att[r]=zd(Vd({},i.att[r]),{[a]:((c=t.att[r])==null?void 0:c[a])||((l=e.att[r])==null?void 0:l[a])})})}),i}function tf(t="",e){ws(e);let s="I further authorize the stated URI to perform the following actions on my behalf: ";if(t.includes(s))return t;let i=[],r=0;Object.keys(e.att).forEach(a=>{let c=Object.keys(e.att[a]).map(u=>({ability:u.split("/")[0],action:u.split("/")[1]}));c.sort((u,p)=>u.action.localeCompare(p.action));let l={};c.forEach(u=>{l[u.ability]||(l[u.ability]=[]),l[u.ability].push(u.action)});let h=Object.keys(l).map(u=>(r++,`(${r}) '${u}': '${l[u].join("', '")}' for '${a}'.`));i.push(h.join(", ").replace(".,","."))});let n=i.join(" "),o=`${s}${n}`;return`${t?t+" ":""}${o}`}function Mn(t){var e;let s=pi(t);ws(s);let i=(e=s.att)==null?void 0:e.eip155;return i?Object.keys(i).map(r=>r.split("/")[1]):[]}function Vn(t){let e=pi(t);ws(e);let s=[];return Object.values(e.att).forEach(i=>{Object.values(i).forEach(r=>{var n;(n=r?.[0])!=null&&n.chains&&s.push(r[0].chains)})}),[...new Set(s.flat())]}function wi(t){if(!t)return;let e=t?.[t.length-1];return Qd(e)?e:void 0}function nl(t){return t instanceof Uint8Array||ArrayBuffer.isView(t)&&t.constructor.name==="Uint8Array"}function yn(t){if(typeof t!="boolean")throw new Error(`boolean expected, not ${t}`)}function Zr(t){if(!Number.isSafeInteger(t)||t<0)throw new Error("positive integer expected, got "+t)}function Ue(t,...e){if(!nl(t))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw new Error("Uint8Array expected of length "+e+", got length="+t.length)}function sc(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function sf(t,e){Ue(t);let s=e.outputLen;if(t.length<s)throw new Error("digestInto() expects output buffer of length at least "+s)}function es(t){return new Uint32Array(t.buffer,t.byteOffset,Math.floor(t.byteLength/4))}function Fs(...t){for(let e=0;e<t.length;e++)t[e].fill(0)}function rf(t){return new DataView(t.buffer,t.byteOffset,t.byteLength)}var nf=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function of(t){if(typeof t!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(t))}function mn(t){if(typeof t=="string")t=of(t);else if(nl(t))t=wn(t);else throw new Error("Uint8Array expected, got "+typeof t);return t}function af(t,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(t,e)}function cf(t,e){if(t.length!==e.length)return!1;let s=0;for(let i=0;i<t.length;i++)s|=t[i]^e[i];return s===0}var lf=(t,e)=>{function s(i,...r){if(Ue(i),!nf)throw new Error("Non little-endian hardware is not yet supported");if(t.nonceLength!==void 0){let l=r[0];if(!l)throw new Error("nonce / iv required");t.varSizeNonce?Ue(l):Ue(l,t.nonceLength)}let n=t.tagLength;n&&r[1]!==void 0&&Ue(r[1]);let o=e(i,...r),a=(l,h)=>{if(h!==void 0){if(l!==2)throw new Error("cipher output not supported");Ue(h)}},c=!1;return{encrypt(l,h){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,Ue(l),a(o.encrypt.length,h),o.encrypt(l,h)},decrypt(l,h){if(Ue(l),n&&l.length<n)throw new Error("invalid ciphertext length: smaller than tagLength="+n);return a(o.decrypt.length,h),o.decrypt(l,h)}}}return Object.assign(s,t),s};function ic(t,e,s=!0){if(e===void 0)return new Uint8Array(t);if(e.length!==t)throw new Error("invalid output length, expected "+t+", got: "+e.length);if(s&&!uf(e))throw new Error("invalid output, must be aligned");return e}function rc(t,e,s,i){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,s,i);let r=BigInt(32),n=BigInt(4294967295),o=Number(s>>r&n),a=Number(s&n),c=i?4:0,l=i?0:4;t.setUint32(e+c,o,i),t.setUint32(e+l,a,i)}function hf(t,e,s){yn(s);let i=new Uint8Array(16),r=rf(i);return rc(r,0,BigInt(e),s),rc(r,8,BigInt(t),s),i}function uf(t){return t.byteOffset%4===0}function wn(t){return Uint8Array.from(t)}var ol=t=>Uint8Array.from(t.split("").map(e=>e.charCodeAt(0))),pf=ol("expand 16-byte k"),df=ol("expand 32-byte k"),ff=es(pf),gf=es(df);function Q(t,e){return t<<e|t>>>32-e}function bn(t){return t.byteOffset%4===0}var $i=64,yf=16,al=2**32-1,nc=new Uint32Array;function mf(t,e,s,i,r,n,o,a){let c=r.length,l=new Uint8Array($i),h=es(l),u=bn(r)&&bn(n),p=u?es(r):nc,d=u?es(n):nc;for(let f=0;f<c;o++){if(t(e,s,i,h,o,a),o>=al)throw new Error("arx: counter overflow");let g=Math.min($i,c-f);if(u&&g===$i){let y=f/4;if(f%4!==0)throw new Error("arx: invalid block position");for(let P=0,x;P<yf;P++)x=y+P,d[x]=p[x]^h[P];f+=$i;continue}for(let y=0,P;y<g;y++)P=f+y,n[P]=r[P]^l[y];f+=g}}function wf(t,e){let{allowShortKeys:s,extendNonceFn:i,counterLength:r,counterRight:n,rounds:o}=af({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof t!="function")throw new Error("core must be a function");return Zr(r),Zr(o),yn(n),yn(s),(a,c,l,h,u=0)=>{Ue(a),Ue(c),Ue(l);let p=l.length;if(h===void 0&&(h=new Uint8Array(p)),Ue(h),Zr(u),u<0||u>=al)throw new Error("arx: counter overflow");if(h.length<p)throw new Error(`arx: output (${h.length}) is shorter than data (${p})`);let d=[],f=a.length,g,y;if(f===32)d.push(g=wn(a)),y=gf;else if(f===16&&s)g=new Uint8Array(32),g.set(a),g.set(a,16),y=ff,d.push(g);else throw new Error(`arx: invalid 32-byte key, got length=${f}`);bn(c)||d.push(c=wn(c));let P=es(g);if(i){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");i(y,P,es(c.subarray(0,16)),P),c=c.subarray(16)}let x=16-r;if(x!==c.length)throw new Error(`arx: nonce must be ${x} or 16 bytes`);if(x!==12){let q=new Uint8Array(12);q.set(c,n?0:12-c.length),c=q,d.push(c)}let S=es(c);return mf(t,y,P,S,l,h,u,o),Fs(...d),h}}var me=(t,e)=>t[e++]&255|(t[e++]&255)<<8,vn=class{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=mn(e),Ue(e,32);let s=me(e,0),i=me(e,2),r=me(e,4),n=me(e,6),o=me(e,8),a=me(e,10),c=me(e,12),l=me(e,14);this.r[0]=s&8191,this.r[1]=(s>>>13|i<<3)&8191,this.r[2]=(i>>>10|r<<6)&7939,this.r[3]=(r>>>7|n<<9)&8191,this.r[4]=(n>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let h=0;h<8;h++)this.pad[h]=me(e,16+2*h)}process(e,s,i=!1){let r=i?0:2048,{h:n,r:o}=this,a=o[0],c=o[1],l=o[2],h=o[3],u=o[4],p=o[5],d=o[6],f=o[7],g=o[8],y=o[9],P=me(e,s+0),x=me(e,s+2),S=me(e,s+4),q=me(e,s+6),B=me(e,s+8),N=me(e,s+10),D=me(e,s+12),U=me(e,s+14),_=n[0]+(P&8191),F=n[1]+((P>>>13|x<<3)&8191),M=n[2]+((x>>>10|S<<6)&8191),R=n[3]+((S>>>7|q<<9)&8191),m=n[4]+((q>>>4|B<<12)&8191),w=n[5]+(B>>>1&8191),b=n[6]+((B>>>14|N<<2)&8191),E=n[7]+((N>>>11|D<<5)&8191),T=n[8]+((D>>>8|U<<8)&8191),C=n[9]+(U>>>5|r),v=0,O=v+_*a+F*(5*y)+M*(5*g)+R*(5*f)+m*(5*d);v=O>>>13,O&=8191,O+=w*(5*p)+b*(5*u)+E*(5*h)+T*(5*l)+C*(5*c),v+=O>>>13,O&=8191;let L=v+_*c+F*a+M*(5*y)+R*(5*g)+m*(5*f);v=L>>>13,L&=8191,L+=w*(5*d)+b*(5*p)+E*(5*u)+T*(5*h)+C*(5*l),v+=L>>>13,L&=8191;let k=v+_*l+F*c+M*a+R*(5*y)+m*(5*g);v=k>>>13,k&=8191,k+=w*(5*f)+b*(5*d)+E*(5*p)+T*(5*u)+C*(5*h),v+=k>>>13,k&=8191;let J=v+_*h+F*l+M*c+R*a+m*(5*y);v=J>>>13,J&=8191,J+=w*(5*g)+b*(5*f)+E*(5*d)+T*(5*p)+C*(5*u),v+=J>>>13,J&=8191;let z=v+_*u+F*h+M*l+R*c+m*a;v=z>>>13,z&=8191,z+=w*(5*y)+b*(5*g)+E*(5*f)+T*(5*d)+C*(5*p),v+=z>>>13,z&=8191;let V=v+_*p+F*u+M*h+R*l+m*c;v=V>>>13,V&=8191,V+=w*a+b*(5*y)+E*(5*g)+T*(5*f)+C*(5*d),v+=V>>>13,V&=8191;let Y=v+_*d+F*p+M*u+R*h+m*l;v=Y>>>13,Y&=8191,Y+=w*c+b*a+E*(5*y)+T*(5*g)+C*(5*f),v+=Y>>>13,Y&=8191;let G=v+_*f+F*d+M*p+R*u+m*h;v=G>>>13,G&=8191,G+=w*l+b*c+E*a+T*(5*y)+C*(5*g),v+=G>>>13,G&=8191;let ae=v+_*g+F*f+M*d+R*p+m*u;v=ae>>>13,ae&=8191,ae+=w*h+b*l+E*c+T*a+C*(5*y),v+=ae>>>13,ae&=8191;let W=v+_*y+F*g+M*f+R*d+m*p;v=W>>>13,W&=8191,W+=w*u+b*h+E*l+T*c+C*a,v+=W>>>13,W&=8191,v=(v<<2)+v|0,v=v+O|0,O=v&8191,v=v>>>13,L+=v,n[0]=O,n[1]=L,n[2]=k,n[3]=J,n[4]=z,n[5]=V,n[6]=Y,n[7]=G,n[8]=ae,n[9]=W}finalize(){let{h:e,pad:s}=this,i=new Uint16Array(10),r=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=r,r=e[a]>>>13,e[a]&=8191;e[0]+=r*5,r=e[0]>>>13,e[0]&=8191,e[1]+=r,r=e[1]>>>13,e[1]&=8191,e[2]+=r,i[0]=e[0]+5,r=i[0]>>>13,i[0]&=8191;for(let a=1;a<10;a++)i[a]=e[a]+r,r=i[a]>>>13,i[a]&=8191;i[9]-=8192;let n=(r^1)-1;for(let a=0;a<10;a++)i[a]&=n;n=~n;for(let a=0;a<10;a++)e[a]=e[a]&n|i[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+s[0];e[0]=o&65535;for(let a=1;a<8;a++)o=(e[a]+s[a]|0)+(o>>>16)|0,e[a]=o&65535;Fs(i)}update(e){sc(this),e=mn(e),Ue(e);let{buffer:s,blockLen:i}=this,r=e.length;for(let n=0;n<r;){let o=Math.min(i-this.pos,r-n);if(o===i){for(;i<=r-n;n+=i)this.process(e,n);continue}s.set(e.subarray(n,n+o),this.pos),this.pos+=o,n+=o,this.pos===i&&(this.process(s,0,!1),this.pos=0)}return this}destroy(){Fs(this.h,this.r,this.buffer,this.pad)}digestInto(e){sc(this),sf(e,this),this.finished=!0;let{buffer:s,h:i}=this,{pos:r}=this;if(r){for(s[r++]=1;r<16;r++)s[r]=0;this.process(s,0,!0)}this.finalize();let n=0;for(let o=0;o<8;o++)e[n++]=i[o]>>>0,e[n++]=i[o]>>>8;return e}digest(){let{buffer:e,outputLen:s}=this;this.digestInto(e);let i=e.slice(0,s);return this.destroy(),i}};function bf(t){let e=(i,r)=>t(r).update(mn(i)).digest(),s=t(new Uint8Array(32));return e.outputLen=s.outputLen,e.blockLen=s.blockLen,e.create=i=>t(i),e}var vf=bf(t=>new vn(t));function Ef(t,e,s,i,r,n=20){let o=t[0],a=t[1],c=t[2],l=t[3],h=e[0],u=e[1],p=e[2],d=e[3],f=e[4],g=e[5],y=e[6],P=e[7],x=r,S=s[0],q=s[1],B=s[2],N=o,D=a,U=c,_=l,F=h,M=u,R=p,m=d,w=f,b=g,E=y,T=P,C=x,v=S,O=q,L=B;for(let J=0;J<n;J+=2)N=N+F|0,C=Q(C^N,16),w=w+C|0,F=Q(F^w,12),N=N+F|0,C=Q(C^N,8),w=w+C|0,F=Q(F^w,7),D=D+M|0,v=Q(v^D,16),b=b+v|0,M=Q(M^b,12),D=D+M|0,v=Q(v^D,8),b=b+v|0,M=Q(M^b,7),U=U+R|0,O=Q(O^U,16),E=E+O|0,R=Q(R^E,12),U=U+R|0,O=Q(O^U,8),E=E+O|0,R=Q(R^E,7),_=_+m|0,L=Q(L^_,16),T=T+L|0,m=Q(m^T,12),_=_+m|0,L=Q(L^_,8),T=T+L|0,m=Q(m^T,7),N=N+M|0,L=Q(L^N,16),E=E+L|0,M=Q(M^E,12),N=N+M|0,L=Q(L^N,8),E=E+L|0,M=Q(M^E,7),D=D+R|0,C=Q(C^D,16),T=T+C|0,R=Q(R^T,12),D=D+R|0,C=Q(C^D,8),T=T+C|0,R=Q(R^T,7),U=U+m|0,v=Q(v^U,16),w=w+v|0,m=Q(m^w,12),U=U+m|0,v=Q(v^U,8),w=w+v|0,m=Q(m^w,7),_=_+F|0,O=Q(O^_,16),b=b+O|0,F=Q(F^b,12),_=_+F|0,O=Q(O^_,8),b=b+O|0,F=Q(F^b,7);let k=0;i[k++]=o+N|0,i[k++]=a+D|0,i[k++]=c+U|0,i[k++]=l+_|0,i[k++]=h+F|0,i[k++]=u+M|0,i[k++]=p+R|0,i[k++]=d+m|0,i[k++]=f+w|0,i[k++]=g+b|0,i[k++]=y+E|0,i[k++]=P+T|0,i[k++]=x+C|0,i[k++]=S+v|0,i[k++]=q+O|0,i[k++]=B+L|0}var _f=wf(Ef,{counterRight:!1,counterLength:4,allowShortKeys:!1}),If=new Uint8Array(16),oc=(t,e)=>{t.update(e);let s=e.length%16;s&&t.update(If.subarray(s))},Sf=new Uint8Array(32);function ac(t,e,s,i,r){let n=t(e,s,Sf),o=vf.create(n);r&&oc(o,r),oc(o,i);let a=hf(i.length,r?r.length:0,!0);o.update(a);let c=o.digest();return Fs(n,a),c}var Of=t=>(e,s,i)=>({encrypt(r,n){let o=r.length;n=ic(o+16,n,!1),n.set(r);let a=n.subarray(0,-16);t(e,s,a,a,1);let c=ac(t,e,s,a,i);return n.set(c,o),Fs(c),n},decrypt(r,n){n=ic(r.length-16,n,!1);let o=r.subarray(0,-16),a=r.subarray(-16),c=ac(t,e,s,o,i);if(!cf(a,c))throw new Error("invalid tag");return n.set(r.subarray(0,-16)),t(e,s,n,n,1),Fs(c),n}}),cl=lf({blockSize:64,nonceLength:12,tagLength:16},Of(_f)),Wi=class extends Ls{constructor(e,s){super(),this.finished=!1,this.destroyed=!1,ir(e);let i=ut(s);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let r=this.blockLen,n=new Uint8Array(r);n.set(i.length>r?e.create().update(i).digest():i);for(let o=0;o<n.length;o++)n[o]^=54;this.iHash.update(n),this.oHash=e.create();for(let o=0;o<n.length;o++)n[o]^=106;this.oHash.update(n),tt(n)}update(e){return ts(this),this.iHash.update(e),this}digestInto(e){ts(this),dt(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));let{oHash:s,iHash:i,finished:r,destroyed:n,blockLen:o,outputLen:a}=this;return e=e,e.finished=r,e.destroyed=n,e.blockLen=o,e.outputLen=a,e.oHash=s._cloneInto(e.oHash),e.iHash=i._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},ar=(t,e,s)=>new Wi(t,e).update(s).digest();ar.create=(t,e)=>new Wi(t,e);function Pf(t,e,s){return ir(t),s===void 0&&(s=new Uint8Array(t.outputLen)),ar(t,ut(s),ut(e))}var Qr=Uint8Array.from([0]),cc=Uint8Array.of();function Rf(t,e,s,i=32){ir(t),qt(i);let r=t.outputLen;if(i>255*r)throw new Error("Length should be <= 255*HashLen");let n=Math.ceil(i/r);s===void 0&&(s=cc);let o=new Uint8Array(n*r),a=ar.create(t,e),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let h=0;h<n;h++)Qr[0]=h+1,c.update(h===0?cc:l).update(s).update(Qr).digestInto(l),o.set(l,r*h),a._cloneInto(c);return a.destroy(),c.destroy(),tt(l,Qr),o.slice(0,i)}var Tf=(t,e,s,i,r)=>Rf(t,Pf(t,e,s),i,r),cr=rr,zn=BigInt(0),En=BigInt(1);function Yi(t,e=""){if(typeof t!="boolean"){let s=e&&`"${e}"`;throw new Error(s+"expected boolean, got type="+typeof t)}return t}function gs(t,e,s=""){let i=sr(t),r=t?.length,n=e!==void 0;if(!i||n&&r!==e){let o=s&&`"${s}" `,a=n?` of length ${e}`:"",c=i?`length=${r}`:`type=${typeof t}`;throw new Error(o+"expected Uint8Array"+a+", got "+c)}return t}function Mi(t){let e=t.toString(16);return e.length&1?"0"+e:e}function ll(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);return t===""?zn:BigInt("0x"+t)}function lr(t){return ll(qs(t))}function Ji(t){return dt(t),ll(qs(Uint8Array.from(t).reverse()))}function Kn(t,e){return Hi(t.toString(16).padStart(e*2,"0"))}function Hn(t,e){return Kn(t,e).reverse()}function Re(t,e,s){let i;if(typeof e=="string")try{i=Hi(e)}catch(n){throw new Error(t+" must be hex string or Uint8Array, cause: "+n)}else if(sr(e))i=Uint8Array.from(e);else throw new Error(t+" must be hex string or Uint8Array");let r=i.length;if(typeof s=="number"&&r!==s)throw new Error(t+" of length "+s+" expected, got "+r);return i}var en=t=>typeof t=="bigint"&&zn<=t;function xf(t,e,s){return en(t)&&en(e)&&en(s)&&e<=t&&t<s}function _n(t,e,s,i){if(!xf(e,s,i))throw new Error("expected valid "+t+": "+s+" <= n < "+i+", got "+e)}function hl(t){let e;for(e=0;t>zn;t>>=En,e+=1);return e}var bi=t=>(En<<BigInt(t))-En;function Af(t,e,s){if(typeof t!="number"||t<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof s!="function")throw new Error("hmacFn must be a function");let i=p=>new Uint8Array(p),r=p=>Uint8Array.of(p),n=i(t),o=i(t),a=0,c=()=>{n.fill(1),o.fill(0),a=0},l=(...p)=>s(o,n,...p),h=(p=i(0))=>{o=l(r(0),p),n=l(),p.length!==0&&(o=l(r(1),p),n=l())},u=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let p=0,d=[];for(;p<e;){n=l();let f=n.slice();d.push(f),p+=n.length}return Qt(...d)};return(p,d)=>{c(),h(p);let f;for(;!(f=d(u()));)h();return c(),f}}function hr(t,e,s={}){if(!t||typeof t!="object")throw new Error("expected valid options object");function i(r,n,o){let a=t[r];if(o&&a===void 0)return;let c=typeof a;if(c!==n||a===null)throw new Error(`param "${r}" is invalid: expected ${n}, got ${c}`)}Object.entries(e).forEach(([r,n])=>i(r,n,!1)),Object.entries(s).forEach(([r,n])=>i(r,n,!0))}function lc(t){let e=new WeakMap;return(s,...i)=>{let r=e.get(s);if(r!==void 0)return r;let n=t(s,...i);return e.set(s,n),n}}var $e=BigInt(0),Ne=BigInt(1),ys=BigInt(2),ul=BigInt(3),pl=BigInt(4),dl=BigInt(5),Cf=BigInt(7),fl=BigInt(8),Nf=BigInt(9),gl=BigInt(16);function He(t,e){let s=t%e;return s>=$e?s:e+s}function ct(t,e,s){let i=t;for(;e-- >$e;)i*=i,i%=s;return i}function hc(t,e){if(t===$e)throw new Error("invert: expected non-zero number");if(e<=$e)throw new Error("invert: expected positive modulus, got "+e);let s=He(t,e),i=e,r=$e,n=Ne;for(;s!==$e;){let o=i/s,a=i%s,c=r-n*o;i=s,s=a,r=n,n=c}if(i!==Ne)throw new Error("invert: does not exist");return He(r,e)}function Gn(t,e,s){if(!t.eql(t.sqr(e),s))throw new Error("Cannot find square root")}function yl(t,e){let s=(t.ORDER+Ne)/pl,i=t.pow(e,s);return Gn(t,i,e),i}function jf(t,e){let s=(t.ORDER-dl)/fl,i=t.mul(e,ys),r=t.pow(i,s),n=t.mul(e,r),o=t.mul(t.mul(n,ys),r),a=t.mul(n,t.sub(o,t.ONE));return Gn(t,a,e),a}function qf(t){let e=rs(t),s=ml(t),i=s(e,e.neg(e.ONE)),r=s(e,i),n=s(e,e.neg(i)),o=(t+Cf)/gl;return(a,c)=>{let l=a.pow(c,o),h=a.mul(l,i),u=a.mul(l,r),p=a.mul(l,n),d=a.eql(a.sqr(h),c),f=a.eql(a.sqr(u),c);l=a.cmov(l,h,d),h=a.cmov(p,u,f);let g=a.eql(a.sqr(h),c),y=a.cmov(l,h,g);return Gn(a,y,c),y}}function ml(t){if(t<ul)throw new Error("sqrt is not defined for small field");let e=t-Ne,s=0;for(;e%ys===$e;)e/=ys,s++;let i=ys,r=rs(t);for(;uc(r,i)===1;)if(i++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(s===1)return yl;let n=r.pow(i,e),o=(e+Ne)/ys;return function(a,c){if(a.is0(c))return c;if(uc(a,c)!==1)throw new Error("Cannot find square root");let l=s,h=a.mul(a.ONE,n),u=a.pow(c,e),p=a.pow(c,o);for(;!a.eql(u,a.ONE);){if(a.is0(u))return a.ZERO;let d=1,f=a.sqr(u);for(;!a.eql(f,a.ONE);)if(d++,f=a.sqr(f),d===l)throw new Error("Cannot find square root");let g=Ne<<BigInt(l-d-1),y=a.pow(h,g);l=d,h=a.sqr(y),u=a.mul(u,h),p=a.mul(p,y)}return p}}function kf(t){return t%pl===ul?yl:t%fl===dl?jf:t%gl===Nf?qf(t):ml(t)}var Lf=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Ff(t){let e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},s=Lf.reduce((i,r)=>(i[r]="function",i),e);return hr(t,s),t}function Df(t,e,s){if(s<$e)throw new Error("invalid exponent, negatives unsupported");if(s===$e)return t.ONE;if(s===Ne)return e;let i=t.ONE,r=e;for(;s>$e;)s&Ne&&(i=t.mul(i,r)),r=t.sqr(r),s>>=Ne;return i}function wl(t,e,s=!1){let i=new Array(e.length).fill(s?t.ZERO:void 0),r=e.reduce((o,a,c)=>t.is0(a)?o:(i[c]=o,t.mul(o,a)),t.ONE),n=t.inv(r);return e.reduceRight((o,a,c)=>t.is0(a)?o:(i[c]=t.mul(o,i[c]),t.mul(o,a)),n),i}function uc(t,e){let s=(t.ORDER-Ne)/ys,i=t.pow(e,s),r=t.eql(i,t.ONE),n=t.eql(i,t.ZERO),o=t.eql(i,t.neg(t.ONE));if(!r&&!n&&!o)throw new Error("invalid Legendre symbol result");return r?1:n?0:-1}function bl(t,e){e!==void 0&&qt(e);let s=e!==void 0?e:t.toString(2).length,i=Math.ceil(s/8);return{nBitLength:s,nByteLength:i}}function rs(t,e,s=!1,i={}){if(t<=$e)throw new Error("invalid field: expected ORDER > 0, got "+t);let r,n,o=!1,a;if(typeof e=="object"&&e!=null){if(i.sqrt||s)throw new Error("cannot specify opts in two arguments");let p=e;p.BITS&&(r=p.BITS),p.sqrt&&(n=p.sqrt),typeof p.isLE=="boolean"&&(s=p.isLE),typeof p.modFromBytes=="boolean"&&(o=p.modFromBytes),a=p.allowedLengths}else typeof e=="number"&&(r=e),i.sqrt&&(n=i.sqrt);let{nBitLength:c,nByteLength:l}=bl(t,r);if(l>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let h,u=Object.freeze({ORDER:t,isLE:s,BITS:c,BYTES:l,MASK:bi(c),ZERO:$e,ONE:Ne,allowedLengths:a,create:p=>He(p,t),isValid:p=>{if(typeof p!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof p);return $e<=p&&p<t},is0:p=>p===$e,isValidNot0:p=>!u.is0(p)&&u.isValid(p),isOdd:p=>(p&Ne)===Ne,neg:p=>He(-p,t),eql:(p,d)=>p===d,sqr:p=>He(p*p,t),add:(p,d)=>He(p+d,t),sub:(p,d)=>He(p-d,t),mul:(p,d)=>He(p*d,t),pow:(p,d)=>Df(u,p,d),div:(p,d)=>He(p*hc(d,t),t),sqrN:p=>p*p,addN:(p,d)=>p+d,subN:(p,d)=>p-d,mulN:(p,d)=>p*d,inv:p=>hc(p,t),sqrt:n||(p=>(h||(h=kf(t)),h(u,p))),toBytes:p=>s?Hn(p,l):Kn(p,l),fromBytes:(p,d=!0)=>{if(a){if(!a.includes(p.length)||p.length>l)throw new Error("Field.fromBytes: expected "+a+" bytes, got "+p.length);let g=new Uint8Array(l);g.set(p,s?0:g.length-p.length),p=g}if(p.length!==l)throw new Error("Field.fromBytes: expected "+l+" bytes, got "+p.length);let f=s?Ji(p):lr(p);if(o&&(f=He(f,t)),!d&&!u.isValid(f))throw new Error("invalid field element: outside of range 0..ORDER");return f},invertBatch:p=>wl(u,p),cmov:(p,d,f)=>f?d:p});return Object.freeze(u)}function vl(t){if(typeof t!="bigint")throw new Error("field order must be bigint");let e=t.toString(2).length;return Math.ceil(e/8)}function El(t){let e=vl(t);return e+Math.ceil(e/2)}function Uf(t,e,s=!1){let i=t.length,r=vl(e),n=El(e);if(i<16||i<n||i>1024)throw new Error("expected "+n+"-1024 bytes of input, got "+i);let o=s?Ji(t):lr(t),a=He(o,e-Ne)+Ne;return s?Hn(a,r):Kn(a,r)}var Ds=BigInt(0),ms=BigInt(1);function Xi(t,e){let s=e.negate();return t?s:e}function tn(t,e){let s=wl(t.Fp,e.map(i=>i.Z));return e.map((i,r)=>t.fromAffine(i.toAffine(s[r])))}function _l(t,e){if(!Number.isSafeInteger(t)||t<=0||t>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+t)}function sn(t,e){_l(t,e);let s=Math.ceil(e/t)+1,i=2**(t-1),r=2**t,n=bi(t),o=BigInt(t);return{windows:s,windowSize:i,mask:n,maxNumber:r,shiftBy:o}}function pc(t,e,s){let{windowSize:i,mask:r,maxNumber:n,shiftBy:o}=s,a=Number(t&r),c=t>>o;a>i&&(a-=n,c+=ms);let l=e*i,h=l+Math.abs(a)-1,u=a===0,p=a<0,d=e%2!==0;return{nextN:c,offset:h,isZero:u,isNeg:p,isNegF:d,offsetF:l}}function Bf(t,e){if(!Array.isArray(t))throw new Error("array expected");t.forEach((s,i)=>{if(!(s instanceof e))throw new Error("invalid point at index "+i)})}function $f(t,e){if(!Array.isArray(t))throw new Error("array of scalars expected");t.forEach((s,i)=>{if(!e.isValid(s))throw new Error("invalid scalar at index "+i)})}var rn=new WeakMap,Il=new WeakMap;function nn(t){return Il.get(t)||1}function dc(t){if(t!==Ds)throw new Error("invalid wNAF")}var In=class{constructor(e,s){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=s}_unsafeLadder(e,s,i=this.ZERO){let r=e;for(;s>Ds;)s&ms&&(i=i.add(r)),r=r.double(),s>>=ms;return i}precomputeWindow(e,s){let{windows:i,windowSize:r}=sn(s,this.bits),n=[],o=e,a=o;for(let c=0;c<i;c++){a=o,n.push(a);for(let l=1;l<r;l++)a=a.add(o),n.push(a);o=a.double()}return n}wNAF(e,s,i){if(!this.Fn.isValid(i))throw new Error("invalid scalar");let r=this.ZERO,n=this.BASE,o=sn(e,this.bits);for(let a=0;a<o.windows;a++){let{nextN:c,offset:l,isZero:h,isNeg:u,isNegF:p,offsetF:d}=pc(i,a,o);i=c,h?n=n.add(Xi(p,s[d])):r=r.add(Xi(u,s[l]))}return dc(i),{p:r,f:n}}wNAFUnsafe(e,s,i,r=this.ZERO){let n=sn(e,this.bits);for(let o=0;o<n.windows&&i!==Ds;o++){let{nextN:a,offset:c,isZero:l,isNeg:h}=pc(i,o,n);if(i=a,!l){let u=s[c];r=r.add(h?u.negate():u)}}return dc(i),r}getPrecomputes(e,s,i){let r=rn.get(s);return r||(r=this.precomputeWindow(s,e),e!==1&&(typeof i=="function"&&(r=i(r)),rn.set(s,r))),r}cached(e,s,i){let r=nn(e);return this.wNAF(r,this.getPrecomputes(r,e,i),s)}unsafe(e,s,i,r){let n=nn(e);return n===1?this._unsafeLadder(e,s,r):this.wNAFUnsafe(n,this.getPrecomputes(n,e,i),s,r)}createCache(e,s){_l(s,this.bits),Il.set(e,s),rn.delete(e)}hasCache(e){return nn(e)!==1}};function Mf(t,e,s,i){let r=e,n=t.ZERO,o=t.ZERO;for(;s>Ds||i>Ds;)s&ms&&(n=n.add(r)),i&ms&&(o=o.add(r)),r=r.double(),s>>=ms,i>>=ms;return{p1:n,p2:o}}function Vf(t,e,s,i){Bf(s,t),$f(i,e);let r=s.length,n=i.length;if(r!==n)throw new Error("arrays of points and scalars must have equal length");let o=t.ZERO,a=hl(BigInt(r)),c=1;a>12?c=a-3:a>4?c=a-2:a>0&&(c=2);let l=bi(c),h=new Array(Number(l)+1).fill(o),u=Math.floor((e.BITS-1)/c)*c,p=o;for(let d=u;d>=0;d-=c){h.fill(o);for(let g=0;g<n;g++){let y=i[g],P=Number(y>>BigInt(d)&l);h[P]=h[P].add(s[g])}let f=o;for(let g=h.length-1,y=o;g>0;g--)y=y.add(h[g]),f=f.add(y);if(p=p.add(f),d!==0)for(let g=0;g<c;g++)p=p.double()}return p}function fc(t,e,s){if(e){if(e.ORDER!==t)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return Ff(e),e}else return rs(t,{isLE:s})}function zf(t,e,s={},i){if(i===void 0&&(i=t==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${t} CURVE object`);for(let a of["p","n","h"]){let c=e[a];if(!(typeof c=="bigint"&&c>Ds))throw new Error(`CURVE.${a} must be positive bigint`)}let r=fc(e.p,s.Fp,i),n=fc(e.n,s.Fn,i),o=["Gx","Gy","a",t==="weierstrass"?"b":"d"];for(let a of o)if(!r.isValid(e[a]))throw new Error(`CURVE.${a} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:r,Fn:n}}BigInt(0),BigInt(1),BigInt(2),BigInt(8),zc("HashToScalar-");var oi=BigInt(0),Ns=BigInt(1),Vi=BigInt(2);function Kf(t){return hr(t,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...t})}function Hf(t){let e=Kf(t),{P:s,type:i,adjustScalarBytes:r,powPminus2:n,randomBytes:o}=e,a=i==="x25519";if(!a&&i!=="x448")throw new Error("invalid type");let c=o||vs,l=a?255:448,h=a?32:56,u=BigInt(a?9:5),p=BigInt(a?121665:39081),d=a?Vi**BigInt(254):Vi**BigInt(447),f=a?BigInt(8)*Vi**BigInt(251)-Ns:BigInt(4)*Vi**BigInt(445)-Ns,g=d+f+Ns,y=R=>He(R,s),P=x(u);function x(R){return Hn(y(R),h)}function S(R){let m=Re("u coordinate",R,h);return a&&(m[31]&=127),y(Ji(m))}function q(R){return Ji(r(Re("scalar",R,h)))}function B(R,m){let w=U(S(m),q(R));if(w===oi)throw new Error("invalid private or public key received");return x(w)}function N(R){return B(R,P)}function D(R,m,w){let b=y(R*(m-w));return m=y(m-b),w=y(w+b),{x_2:m,x_3:w}}function U(R,m){_n("u",R,oi,s),_n("scalar",m,d,g);let w=m,b=R,E=Ns,T=oi,C=R,v=Ns,O=oi;for(let k=BigInt(l-1);k>=oi;k--){let J=w>>k&Ns;O^=J,{x_2:E,x_3:C}=D(O,E,C),{x_2:T,x_3:v}=D(O,T,v),O=J;let z=E+T,V=y(z*z),Y=E-T,G=y(Y*Y),ae=V-G,W=C+v,he=C-v,ot=y(he*z),Dt=y(W*Y),cs=ot+Dt,Ps=ot-Dt;C=y(cs*cs),v=y(b*y(Ps*Ps)),E=y(V*G),T=y(ae*(V+y(p*ae)))}({x_2:E,x_3:C}=D(O,E,C)),{x_2:T,x_3:v}=D(O,T,v);let L=n(T);return y(E*L)}let _={secretKey:h,publicKey:h,seed:h},F=(R=c(h))=>(dt(R,_.seed),R);function M(R){let m=F(R);return{secretKey:m,publicKey:N(m)}}return{keygen:M,getSharedSecret:(R,m)=>B(R,m),getPublicKey:R=>N(R),scalarMult:B,scalarMultBase:N,utils:{randomSecretKey:F,randomPrivateKey:F},GuBytes:P.slice(),lengths:_}}var Gf=BigInt(1),gc=BigInt(2),Wf=BigInt(3),Yf=BigInt(5),Jf=BigInt(8),Sl=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),Xf={p:Sl,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:Jf,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function Zf(t){let e=BigInt(10),s=BigInt(20),i=BigInt(40),r=BigInt(80),n=Sl,o=t*t%n*t%n,a=ct(o,gc,n)*o%n,c=ct(a,Gf,n)*t%n,l=ct(c,Yf,n)*c%n,h=ct(l,e,n)*l%n,u=ct(h,s,n)*h%n,p=ct(u,i,n)*u%n,d=ct(p,r,n)*p%n,f=ct(d,r,n)*p%n,g=ct(f,e,n)*l%n;return{pow_p_5_8:ct(g,gc,n)*t%n,b2:o}}function Qf(t){return t[0]&=248,t[31]&=127,t[31]|=64,t}var eg=rs(Xf.p,{isLE:!0}),Sn=(()=>{let t=eg.ORDER;return Hf({P:t,type:"x25519",powPminus2:e=>{let{pow_p_5_8:s,b2:i}=Zf(e);return He(ct(s,Wf,t)*i,t)},adjustScalarBytes:Qf})})(),yc=(t,e)=>(t+(t>=0?e:-e)/Ol)/e;function tg(t,e,s){let[[i,r],[n,o]]=e,a=yc(o*t,s),c=yc(-r*t,s),l=t-a*i-c*n,h=-a*r-c*o,u=l<Nt,p=h<Nt;u&&(l=-l),p&&(h=-h);let d=bi(Math.ceil(hl(s)/2))+ks;if(l<Nt||l>=d||h<Nt||h>=d)throw new Error("splitScalar (endomorphism): failed, k="+t);return{k1neg:u,k1:l,k2neg:p,k2:h}}function On(t){if(!["compact","recovered","der"].includes(t))throw new Error('Signature format must be "compact", "recovered", or "der"');return t}function on(t,e){let s={};for(let i of Object.keys(e))s[i]=t[i]===void 0?e[i]:t[i];return Yi(s.lowS,"lowS"),Yi(s.prehash,"prehash"),s.format!==void 0&&On(s.format),s}var Pn=class extends Error{constructor(e=""){super(e)}},Ct={Err:Pn,_tlv:{encode:(t,e)=>{let{Err:s}=Ct;if(t<0||t>256)throw new s("tlv.encode: wrong tag");if(e.length&1)throw new s("tlv.encode: unpadded data");let i=e.length/2,r=Mi(i);if(r.length/2&128)throw new s("tlv.encode: long form length too big");let n=i>127?Mi(r.length/2|128):"";return Mi(t)+n+r+e},decode(t,e){let{Err:s}=Ct,i=0;if(t<0||t>256)throw new s("tlv.encode: wrong tag");if(e.length<2||e[i++]!==t)throw new s("tlv.decode: wrong tlv");let r=e[i++],n=!!(r&128),o=0;if(!n)o=r;else{let c=r&127;if(!c)throw new s("tlv.decode(long): indefinite length not supported");if(c>4)throw new s("tlv.decode(long): byte length is too big");let l=e.subarray(i,i+c);if(l.length!==c)throw new s("tlv.decode: length bytes not complete");if(l[0]===0)throw new s("tlv.decode(long): zero leftmost byte");for(let h of l)o=o<<8|h;if(i+=c,o<128)throw new s("tlv.decode(long): not minimal encoding")}let a=e.subarray(i,i+o);if(a.length!==o)throw new s("tlv.decode: wrong value length");return{v:a,l:e.subarray(i+o)}}},_int:{encode(t){let{Err:e}=Ct;if(t<Nt)throw new e("integer: negative integers are not allowed");let s=Mi(t);if(Number.parseInt(s[0],16)&8&&(s="00"+s),s.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return s},decode(t){let{Err:e}=Ct;if(t[0]&128)throw new e("invalid signature integer: negative");if(t[0]===0&&!(t[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return lr(t)}},toSig(t){let{Err:e,_int:s,_tlv:i}=Ct,r=Re("signature",t),{v:n,l:o}=i.decode(48,r);if(o.length)throw new e("invalid signature: left bytes after parsing");let{v:a,l:c}=i.decode(2,n),{v:l,l:h}=i.decode(2,c);if(h.length)throw new e("invalid signature: left bytes after parsing");return{r:s.decode(a),s:s.decode(l)}},hexFromSig(t){let{_tlv:e,_int:s}=Ct,i=e.encode(2,s.encode(t.r)),r=e.encode(2,s.encode(t.s)),n=i+r;return e.encode(48,n)}},Nt=BigInt(0),ks=BigInt(1),Ol=BigInt(2),zi=BigInt(3),sg=BigInt(4);function js(t,e){let{BYTES:s}=t,i;if(typeof e=="bigint")i=e;else{let r=Re("private key",e);try{i=t.fromBytes(r)}catch{throw new Error(`invalid private key: expected ui8a of size ${s}, got ${typeof e}`)}}if(!t.isValidNot0(i))throw new Error("invalid private key: out of range [1..N-1]");return i}function ig(t,e={}){let s=zf("weierstrass",t,e),{Fp:i,Fn:r}=s,n=s.CURVE,{h:o,n:a}=n;hr(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});let{endo:c}=e;if(c&&(!i.is0(n.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');let l=Rl(i,r);function h(){if(!i.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function u(R,m,w){let{x:b,y:E}=m.toAffine(),T=i.toBytes(b);if(Yi(w,"isCompressed"),w){h();let C=!i.isOdd(E);return Qt(Pl(C),T)}else return Qt(Uint8Array.of(4),T,i.toBytes(E))}function p(R){gs(R,void 0,"Point");let{publicKey:m,publicKeyUncompressed:w}=l,b=R.length,E=R[0],T=R.subarray(1);if(b===m&&(E===2||E===3)){let C=i.fromBytes(T);if(!i.isValid(C))throw new Error("bad point: is not on curve, wrong x");let v=g(C),O;try{O=i.sqrt(v)}catch(k){let J=k instanceof Error?": "+k.message:"";throw new Error("bad point: is not on curve, sqrt error"+J)}h();let L=i.isOdd(O);return(E&1)===1!==L&&(O=i.neg(O)),{x:C,y:O}}else if(b===w&&E===4){let C=i.BYTES,v=i.fromBytes(T.subarray(0,C)),O=i.fromBytes(T.subarray(C,C*2));if(!y(v,O))throw new Error("bad point: is not on curve");return{x:v,y:O}}else throw new Error(`bad point: got length ${b}, expected compressed=${m} or uncompressed=${w}`)}let d=e.toBytes||u,f=e.fromBytes||p;function g(R){let m=i.sqr(R),w=i.mul(m,R);return i.add(i.add(w,i.mul(R,n.a)),n.b)}function y(R,m){let w=i.sqr(m),b=g(R);return i.eql(w,b)}if(!y(n.Gx,n.Gy))throw new Error("bad curve params: generator point");let P=i.mul(i.pow(n.a,zi),sg),x=i.mul(i.sqr(n.b),BigInt(27));if(i.is0(i.add(P,x)))throw new Error("bad curve params: a or b");function S(R,m,w=!1){if(!i.isValid(m)||w&&i.is0(m))throw new Error(`bad point coordinate ${R}`);return m}function q(R){if(!(R instanceof _))throw new Error("ProjectivePoint expected")}function B(R){if(!c||!c.basises)throw new Error("no endo");return tg(R,c.basises,r.ORDER)}let N=lc((R,m)=>{let{X:w,Y:b,Z:E}=R;if(i.eql(E,i.ONE))return{x:w,y:b};let T=R.is0();m==null&&(m=T?i.ONE:i.inv(E));let C=i.mul(w,m),v=i.mul(b,m),O=i.mul(E,m);if(T)return{x:i.ZERO,y:i.ZERO};if(!i.eql(O,i.ONE))throw new Error("invZ was invalid");return{x:C,y:v}}),D=lc(R=>{if(R.is0()){if(e.allowInfinityPoint&&!i.is0(R.Y))return;throw new Error("bad point: ZERO")}let{x:m,y:w}=R.toAffine();if(!i.isValid(m)||!i.isValid(w))throw new Error("bad point: x or y not field elements");if(!y(m,w))throw new Error("bad point: equation left != right");if(!R.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function U(R,m,w,b,E){return w=new _(i.mul(w.X,R),w.Y,w.Z),m=Xi(b,m),w=Xi(E,w),m.add(w)}class _{constructor(m,w,b){this.X=S("x",m),this.Y=S("y",w,!0),this.Z=S("z",b),Object.freeze(this)}static CURVE(){return n}static fromAffine(m){let{x:w,y:b}=m||{};if(!m||!i.isValid(w)||!i.isValid(b))throw new Error("invalid affine point");if(m instanceof _)throw new Error("projective point not allowed");return i.is0(w)&&i.is0(b)?_.ZERO:new _(w,b,i.ONE)}static fromBytes(m){let w=_.fromAffine(f(gs(m,void 0,"point")));return w.assertValidity(),w}static fromHex(m){return _.fromBytes(Re("pointHex",m))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(m=8,w=!0){return M.createCache(this,m),w||this.multiply(zi),this}assertValidity(){D(this)}hasEvenY(){let{y:m}=this.toAffine();if(!i.isOdd)throw new Error("Field doesn't support isOdd");return!i.isOdd(m)}equals(m){q(m);let{X:w,Y:b,Z:E}=this,{X:T,Y:C,Z:v}=m,O=i.eql(i.mul(w,v),i.mul(T,E)),L=i.eql(i.mul(b,v),i.mul(C,E));return O&&L}negate(){return new _(this.X,i.neg(this.Y),this.Z)}double(){let{a:m,b:w}=n,b=i.mul(w,zi),{X:E,Y:T,Z:C}=this,v=i.ZERO,O=i.ZERO,L=i.ZERO,k=i.mul(E,E),J=i.mul(T,T),z=i.mul(C,C),V=i.mul(E,T);return V=i.add(V,V),L=i.mul(E,C),L=i.add(L,L),v=i.mul(m,L),O=i.mul(b,z),O=i.add(v,O),v=i.sub(J,O),O=i.add(J,O),O=i.mul(v,O),v=i.mul(V,v),L=i.mul(b,L),z=i.mul(m,z),V=i.sub(k,z),V=i.mul(m,V),V=i.add(V,L),L=i.add(k,k),k=i.add(L,k),k=i.add(k,z),k=i.mul(k,V),O=i.add(O,k),z=i.mul(T,C),z=i.add(z,z),k=i.mul(z,V),v=i.sub(v,k),L=i.mul(z,J),L=i.add(L,L),L=i.add(L,L),new _(v,O,L)}add(m){q(m);let{X:w,Y:b,Z:E}=this,{X:T,Y:C,Z:v}=m,O=i.ZERO,L=i.ZERO,k=i.ZERO,J=n.a,z=i.mul(n.b,zi),V=i.mul(w,T),Y=i.mul(b,C),G=i.mul(E,v),ae=i.add(w,b),W=i.add(T,C);ae=i.mul(ae,W),W=i.add(V,Y),ae=i.sub(ae,W),W=i.add(w,E);let he=i.add(T,v);return W=i.mul(W,he),he=i.add(V,G),W=i.sub(W,he),he=i.add(b,E),O=i.add(C,v),he=i.mul(he,O),O=i.add(Y,G),he=i.sub(he,O),k=i.mul(J,W),O=i.mul(z,G),k=i.add(O,k),O=i.sub(Y,k),k=i.add(Y,k),L=i.mul(O,k),Y=i.add(V,V),Y=i.add(Y,V),G=i.mul(J,G),W=i.mul(z,W),Y=i.add(Y,G),G=i.sub(V,G),G=i.mul(J,G),W=i.add(W,G),V=i.mul(Y,W),L=i.add(L,V),V=i.mul(he,W),O=i.mul(ae,O),O=i.sub(O,V),V=i.mul(ae,Y),k=i.mul(he,k),k=i.add(k,V),new _(O,L,k)}subtract(m){return this.add(m.negate())}is0(){return this.equals(_.ZERO)}multiply(m){let{endo:w}=e;if(!r.isValidNot0(m))throw new Error("invalid scalar: out of range");let b,E,T=C=>M.cached(this,C,v=>tn(_,v));if(w){let{k1neg:C,k1:v,k2neg:O,k2:L}=B(m),{p:k,f:J}=T(v),{p:z,f:V}=T(L);E=J.add(V),b=U(w.beta,k,z,C,O)}else{let{p:C,f:v}=T(m);b=C,E=v}return tn(_,[b,E])[0]}multiplyUnsafe(m){let{endo:w}=e,b=this;if(!r.isValid(m))throw new Error("invalid scalar: out of range");if(m===Nt||b.is0())return _.ZERO;if(m===ks)return b;if(M.hasCache(this))return this.multiply(m);if(w){let{k1neg:E,k1:T,k2neg:C,k2:v}=B(m),{p1:O,p2:L}=Mf(_,b,T,v);return U(w.beta,O,L,E,C)}else return M.unsafe(b,m)}multiplyAndAddUnsafe(m,w,b){let E=this.multiplyUnsafe(w).add(m.multiplyUnsafe(b));return E.is0()?void 0:E}toAffine(m){return N(this,m)}isTorsionFree(){let{isTorsionFree:m}=e;return o===ks?!0:m?m(_,this):M.unsafe(this,a).is0()}clearCofactor(){let{clearCofactor:m}=e;return o===ks?this:m?m(_,this):this.multiplyUnsafe(o)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}toBytes(m=!0){return Yi(m,"isCompressed"),this.assertValidity(),d(_,this,m)}toHex(m=!0){return qs(this.toBytes(m))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(m=!0){return this.toBytes(m)}_setWindowSize(m){this.precompute(m)}static normalizeZ(m){return tn(_,m)}static msm(m,w){return Vf(_,r,m,w)}static fromPrivateKey(m){return _.BASE.multiply(js(r,m))}}_.BASE=new _(n.Gx,n.Gy,i.ONE),_.ZERO=new _(i.ZERO,i.ONE,i.ZERO),_.Fp=i,_.Fn=r;let F=r.BITS,M=new In(_,e.endo?Math.ceil(F/2):F);return _.BASE.precompute(8),_}function Pl(t){return Uint8Array.of(t?2:3)}function Rl(t,e){return{secretKey:e.BYTES,publicKey:1+t.BYTES,publicKeyUncompressed:1+2*t.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function rg(t,e={}){let{Fn:s}=t,i=e.randomBytes||vs,r=Object.assign(Rl(t.Fp,s),{seed:El(s.ORDER)});function n(p){try{return!!js(s,p)}catch{return!1}}function o(p,d){let{publicKey:f,publicKeyUncompressed:g}=r;try{let y=p.length;return d===!0&&y!==f||d===!1&&y!==g?!1:!!t.fromBytes(p)}catch{return!1}}function a(p=i(r.seed)){return Uf(gs(p,r.seed,"seed"),s.ORDER)}function c(p,d=!0){return t.BASE.multiply(js(s,p)).toBytes(d)}function l(p){let d=a(p);return{secretKey:d,publicKey:c(d)}}function h(p){if(typeof p=="bigint")return!1;if(p instanceof t)return!0;let{secretKey:d,publicKey:f,publicKeyUncompressed:g}=r;if(s.allowedLengths||d===f)return;let y=Re("key",p).length;return y===f||y===g}function u(p,d,f=!0){if(h(p)===!0)throw new Error("first arg must be private key");if(h(d)===!1)throw new Error("second arg must be public key");let g=js(s,p);return t.fromHex(d).multiply(g).toBytes(f)}return Object.freeze({getPublicKey:c,getSharedSecret:u,keygen:l,Point:t,utils:{isValidSecretKey:n,isValidPublicKey:o,randomSecretKey:a,isValidPrivateKey:n,randomPrivateKey:a,normPrivateKeyToScalar:p=>js(s,p),precompute(p=8,d=t.BASE){return d.precompute(p,!1)}},lengths:r})}function ng(t,e,s={}){ir(e),hr(s,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});let i=s.randomBytes||vs,r=s.hmac||((w,...b)=>ar(e,w,Qt(...b))),{Fp:n,Fn:o}=t,{ORDER:a,BITS:c}=o,{keygen:l,getPublicKey:h,getSharedSecret:u,utils:p,lengths:d}=rg(t,s),f={prehash:!1,lowS:typeof s.lowS=="boolean"?s.lowS:!1,format:void 0,extraEntropy:!1},g="compact";function y(w){let b=a>>ks;return w>b}function P(w,b){if(!o.isValidNot0(b))throw new Error(`invalid signature ${w}: out of range 1..Point.Fn.ORDER`);return b}function x(w,b){On(b);let E=d.signature,T=b==="compact"?E:b==="recovered"?E+1:void 0;return gs(w,T,`${b} signature`)}class S{constructor(b,E,T){this.r=P("r",b),this.s=P("s",E),T!=null&&(this.recovery=T),Object.freeze(this)}static fromBytes(b,E=g){x(b,E);let T;if(E==="der"){let{r:L,s:k}=Ct.toSig(gs(b));return new S(L,k)}E==="recovered"&&(T=b[0],E="compact",b=b.subarray(1));let C=o.BYTES,v=b.subarray(0,C),O=b.subarray(C,C*2);return new S(o.fromBytes(v),o.fromBytes(O),T)}static fromHex(b,E){return this.fromBytes(Hi(b),E)}addRecoveryBit(b){return new S(this.r,this.s,b)}recoverPublicKey(b){let E=n.ORDER,{r:T,s:C,recovery:v}=this;if(v==null||![0,1,2,3].includes(v))throw new Error("recovery id invalid");if(a*Ol<E&&v>1)throw new Error("recovery id is ambiguous for h>1 curve");let O=v===2||v===3?T+a:T;if(!n.isValid(O))throw new Error("recovery id 2 or 3 invalid");let L=n.toBytes(O),k=t.fromBytes(Qt(Pl((v&1)===0),L)),J=o.inv(O),z=B(Re("msgHash",b)),V=o.create(-z*J),Y=o.create(C*J),G=t.BASE.multiplyUnsafe(V).add(k.multiplyUnsafe(Y));if(G.is0())throw new Error("point at infinify");return G.assertValidity(),G}hasHighS(){return y(this.s)}toBytes(b=g){if(On(b),b==="der")return Hi(Ct.hexFromSig(this));let E=o.toBytes(this.r),T=o.toBytes(this.s);if(b==="recovered"){if(this.recovery==null)throw new Error("recovery bit must be present");return Qt(Uint8Array.of(this.recovery),E,T)}return Qt(E,T)}toHex(b){return qs(this.toBytes(b))}assertValidity(){}static fromCompact(b){return S.fromBytes(Re("sig",b),"compact")}static fromDER(b){return S.fromBytes(Re("sig",b),"der")}normalizeS(){return this.hasHighS()?new S(this.r,o.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return qs(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return qs(this.toBytes("compact"))}}let q=s.bits2int||function(w){if(w.length>8192)throw new Error("input is too large");let b=lr(w),E=w.length*8-c;return E>0?b>>BigInt(E):b},B=s.bits2int_modN||function(w){return o.create(q(w))},N=bi(c);function D(w){return _n("num < 2^"+c,w,Nt,N),o.toBytes(w)}function U(w,b){return gs(w,void 0,"message"),b?gs(e(w),void 0,"prehashed message"):w}function _(w,b,E){if(["recovered","canonical"].some(Y=>Y in E))throw new Error("sign() legacy options not supported");let{lowS:T,prehash:C,extraEntropy:v}=on(E,f);w=U(w,C);let O=B(w),L=js(o,b),k=[D(L),D(O)];if(v!=null&&v!==!1){let Y=v===!0?i(d.secretKey):v;k.push(Re("extraEntropy",Y))}let J=Qt(...k),z=O;function V(Y){let G=q(Y);if(!o.isValidNot0(G))return;let ae=o.inv(G),W=t.BASE.multiply(G).toAffine(),he=o.create(W.x);if(he===Nt)return;let ot=o.create(ae*o.create(z+he*L));if(ot===Nt)return;let Dt=(W.x===he?0:2)|Number(W.y&ks),cs=ot;return T&&y(ot)&&(cs=o.neg(ot),Dt^=1),new S(he,cs,Dt)}return{seed:J,k2sig:V}}function F(w,b,E={}){w=Re("message",w);let{seed:T,k2sig:C}=_(w,b,E);return Af(e.outputLen,o.BYTES,r)(T,C)}function M(w){let b,E=typeof w=="string"||sr(w),T=!E&&w!==null&&typeof w=="object"&&typeof w.r=="bigint"&&typeof w.s=="bigint";if(!E&&!T)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(T)b=new S(w.r,w.s);else if(E){try{b=S.fromBytes(Re("sig",w),"der")}catch(C){if(!(C instanceof Ct.Err))throw C}if(!b)try{b=S.fromBytes(Re("sig",w),"compact")}catch{return!1}}return b||!1}function R(w,b,E,T={}){let{lowS:C,prehash:v,format:O}=on(T,f);if(E=Re("publicKey",E),b=U(Re("message",b),v),"strict"in T)throw new Error("options.strict was renamed to lowS");let L=O===void 0?M(w):S.fromBytes(Re("sig",w),O);if(L===!1)return!1;try{let k=t.fromBytes(E);if(C&&L.hasHighS())return!1;let{r:J,s:z}=L,V=B(b),Y=o.inv(z),G=o.create(V*Y),ae=o.create(J*Y),W=t.BASE.multiplyUnsafe(G).add(k.multiplyUnsafe(ae));return W.is0()?!1:o.create(W.x)===J}catch{return!1}}function m(w,b,E={}){let{prehash:T}=on(E,f);return b=U(b,T),S.fromBytes(w,"recovered").recoverPublicKey(b).toBytes()}return Object.freeze({keygen:l,getPublicKey:h,getSharedSecret:u,utils:p,lengths:d,Point:t,sign:F,verify:R,recoverPublicKey:m,Signature:S,hash:e})}function og(t){let e={a:t.a,b:t.b,p:t.Fp.ORDER,n:t.n,h:t.h,Gx:t.Gx,Gy:t.Gy},s=t.Fp,i=t.allowedPrivateKeyLengths?Array.from(new Set(t.allowedPrivateKeyLengths.map(o=>Math.ceil(o/2)))):void 0,r=rs(e.n,{BITS:t.nBitLength,allowedLengths:i,modFromBytes:t.wrapPrivateKey}),n={Fp:s,Fn:r,allowInfinityPoint:t.allowInfinityPoint,endo:t.endo,isTorsionFree:t.isTorsionFree,clearCofactor:t.clearCofactor,fromBytes:t.fromBytes,toBytes:t.toBytes};return{CURVE:e,curveOpts:n}}function ag(t){let{CURVE:e,curveOpts:s}=og(t),i={hmac:t.hmac,randomBytes:t.randomBytes,lowS:t.lowS,bits2int:t.bits2int,bits2int_modN:t.bits2int_modN};return{CURVE:e,curveOpts:s,hash:t.hash,ecdsaOpts:i}}function cg(t,e){let s=e.Point;return Object.assign({},e,{ProjectivePoint:s,CURVE:Object.assign({},t,bl(s.Fn.ORDER,s.Fn.BITS))})}function lg(t){let{CURVE:e,curveOpts:s,hash:i,ecdsaOpts:r}=ag(t),n=ig(e,s),o=ng(n,i,r);return cg(t,o)}function Rn(t,e){let s=i=>lg({...t,hash:i});return{...s(e),create:s}}var Tl={p:BigInt("0xffffffff00000001000000000000000000000000ffffffffffffffffffffffff"),n:BigInt("0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551"),h:BigInt(1),a:BigInt("0xffffffff00000001000000000000000000000000fffffffffffffffffffffffc"),b:BigInt("0x5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b"),Gx:BigInt("0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296"),Gy:BigInt("0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5")},xl={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffeffffffff0000000000000000ffffffff"),n:BigInt("0xffffffffffffffffffffffffffffffffffffffffffffffffc7634d81f4372ddf581a0db248b0a77aecec196accc52973"),h:BigInt(1),a:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffeffffffff0000000000000000fffffffc"),b:BigInt("0xb3312fa7e23ee7e4988e056be3f82d19181d9c6efe8141120314088f5013875ac656398d8a2ed19d2a85c8edd3ec2aef"),Gx:BigInt("0xaa87ca22be8b05378eb1c71ef320ad746e1d3b628ba79b9859f741e082542a385502f25dbf55296c3a545e3872760ab7"),Gy:BigInt("0x3617de4a96262c6f5d9e98bf9292dc29f8f41dbd289a147ce9da3113b5f0b8c00a60b1ce1d7e819d7a431d7c90ea0e5f")},Al={p:BigInt("0x1ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"),n:BigInt("0x01fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa51868783bf2f966b7fcc0148f709a5d03bb5c9b8899c47aebb6fb71e91386409"),h:BigInt(1),a:BigInt("0x1fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc"),b:BigInt("0x0051953eb9618e1c9a1f929a21a0b68540eea2da725b99b315f3b8b489918ef109e156193951ec7e937b1652c0bd3bb1bf073573df883d2c34f1ef451fd46b503f00"),Gx:BigInt("0x00c6858e06b70404e9cd9e3ecb662395b4429c648139053fb521f828af606b4d3dbaa14b5e77efe75928fe1dc127a2ffa8de3348b3c1856a429bf97e7e31c2e5bd66"),Gy:BigInt("0x011839296a789a3bc0045c8a5fb42c7d1bd998f54449579b446817afbd17273e662c97ee72995ef42640c550b9013fad0761353c7086a272c24088be94769fd16650")},hg=rs(Tl.p),ug=rs(xl.p),pg=rs(Al.p),dg=Rn({...Tl,Fp:hg,lowS:!1},rr);Rn({...xl,Fp:ug,lowS:!1},Rd),Rn({...Al,Fp:pg,lowS:!1,allowedPrivateKeyLengths:[130,131,132]},Pd);var fg=dg,Cl="base10",Te="base16",xe="base64pad",Ft="base64url",vi="utf8",Nl=0,yt=1,Us=2,gg=0,mc=1,li=12,Wn=32;function jl(){let t=Sn.utils.randomPrivateKey(),e=Sn.getPublicKey(t);return{privateKey:_e(t,Te),publicKey:_e(e,Te)}}function ur(){let t=vs(Wn);return _e(t,Te)}function ql(t,e){let s=Sn.getSharedSecret(Ke(t,Te),Ke(e,Te)),i=Tf(cr,s,void 0,void 0,Wn);return _e(i,Te)}function Bs(t){let e=cr(Ke(t,Te));return _e(e,Te)}function Me(t){let e=cr(Ke(t,vi));return _e(e,Te)}function kl(t){return Ke(`${t}`,Cl)}function ss(t){return Number(_e(t,Cl))}function Ll(t){return t.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function Fl(t){let e=t.replace(/-/g,"+").replace(/_/g,"/"),s=(4-e.length%4)%4;return e+"=".repeat(s)}function Dl(t){let e=kl(typeof t.type<"u"?t.type:Nl);if(ss(e)===yt&&typeof t.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");let s=typeof t.senderPublicKey<"u"?Ke(t.senderPublicKey,Te):void 0,i=typeof t.iv<"u"?Ke(t.iv,Te):vs(li),r=Ke(t.symKey,Te),n=cl(r,i).encrypt(Ke(t.message,vi)),o=Ml({type:e,sealed:n,iv:i,senderPublicKey:s});return t.encoding===Ft?Ll(o):o}function Ul(t){let e=Ke(t.symKey,Te),{sealed:s,iv:i}=$s({encoded:t.encoded,encoding:t.encoding}),r=cl(e,i).decrypt(s);if(r===null)throw new Error("Failed to decrypt");return _e(r,vi)}function Bl(t,e){let s=kl(Us),i=vs(li),r=Ke(t,vi),n=Ml({type:s,sealed:r,iv:i});return e===Ft?Ll(n):n}function $l(t,e){let{sealed:s}=$s({encoded:t,encoding:e});return _e(s,vi)}function Ml(t){if(ss(t.type)===Us)return _e(Ts([t.type,t.sealed]),xe);if(ss(t.type)===yt){if(typeof t.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");return _e(Ts([t.type,t.senderPublicKey,t.iv,t.sealed]),xe)}return _e(Ts([t.type,t.iv,t.sealed]),xe)}function $s(t){let e=(t.encoding||xe)===Ft?Fl(t.encoded):t.encoded,s=Ke(e,xe),i=s.slice(gg,mc),r=mc;if(ss(i)===yt){let c=r+Wn,l=c+li,h=s.slice(r,c),u=s.slice(c,l),p=s.slice(l);return{type:i,sealed:p,iv:u,senderPublicKey:h}}if(ss(i)===Us){let c=s.slice(r),l=vs(li);return{type:i,sealed:c,iv:l}}let n=r+li,o=s.slice(r,n),a=s.slice(n);return{type:i,sealed:a,iv:o}}function Vl(t,e){let s=$s({encoded:t,encoding:e?.encoding});return Yn({type:ss(s.type),senderPublicKey:typeof s.senderPublicKey<"u"?_e(s.senderPublicKey,Te):void 0,receiverPublicKey:e?.receiverPublicKey})}function Yn(t){let e=t?.type||Nl;if(e===yt){if(typeof t?.senderPublicKey>"u")throw new Error("missing sender public key");if(typeof t?.receiverPublicKey>"u")throw new Error("missing receiver public key")}return{type:e,senderPublicKey:t?.senderPublicKey,receiverPublicKey:t?.receiverPublicKey}}function Jn(t){return t.type===yt&&typeof t.senderPublicKey=="string"&&typeof t.receiverPublicKey=="string"}function Xn(t){return t.type===Us}function yg(t){let e=K.from(t.x,"base64"),s=K.from(t.y,"base64");return Ts([new Uint8Array([4]),e,s])}function zl(t,e){let[s,i,r]=t.split("."),n=K.from(Fl(r),"base64");if(n.length!==64)throw new Error("Invalid signature length");let o=n.slice(0,32),a=n.slice(32,64),c=`${s}.${i}`,l=cr(c),h=yg(e);if(!fg.verify(Ts([o,a]),l,h))throw new Error("Invalid signature");return ei(t).payload}var mg="irn";function Ei(t){return t?.relay||{protocol:mg}}function Es(t){let e=Na[t];if(typeof e>"u")throw new Error(`Relay Protocol not supported: ${t}`);return e}var wg=Object.defineProperty,bg=Object.defineProperties,vg=Object.getOwnPropertyDescriptors,wc=Object.getOwnPropertySymbols,Eg=Object.prototype.hasOwnProperty,_g=Object.prototype.propertyIsEnumerable,bc=(t,e,s)=>e in t?wg(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,an=(t,e)=>{for(var s in e||(e={}))Eg.call(e,s)&&bc(t,s,e[s]);if(wc)for(var s of wc(e))_g.call(e,s)&&bc(t,s,e[s]);return t},Ig=(t,e)=>bg(t,vg(e));function Sg(t,e="-"){let s={},i="relay"+e;return Object.keys(t).forEach(r=>{if(r.startsWith(i)){let n=r.replace(i,""),o=t[r];s[n]=o}}),s}function Zn(t){if(!t.includes("wc:")){let l=Fc(t);l!=null&&l.includes("wc:")&&(t=l)}t=t.includes("wc://")?t.replace("wc://",""):t,t=t.includes("wc:")?t.replace("wc:",""):t;let e=t.indexOf(":"),s=t.indexOf("?")!==-1?t.indexOf("?"):void 0,i=t.substring(0,e),r=t.substring(e+1,s).split("@"),n=typeof s<"u"?t.substring(s):"",o=new URLSearchParams(n),a=Object.fromEntries(o.entries()),c=typeof a.methods=="string"?a.methods.split(","):void 0;return{protocol:i,topic:Og(r[0]),version:parseInt(r[1],10),symKey:a.symKey,relay:Sg(a),methods:c,expiryTimestamp:a.expiryTimestamp?parseInt(a.expiryTimestamp,10):void 0}}function Og(t){return t.startsWith("//")?t.substring(2):t}function Pg(t,e="-"){let s="relay",i={};return Object.keys(t).forEach(r=>{let n=r,o=s+e+n;t[n]&&(i[o]=t[n])}),i}function Qn(t){let e=new URLSearchParams,s=an(an(Ig(an({},Pg(t.relay)),{symKey:t.symKey}),t.expiryTimestamp&&{expiryTimestamp:t.expiryTimestamp.toString()}),t.methods&&{methods:t.methods.join(",")});return Object.entries(s).sort(([i],[r])=>i.localeCompare(r)).forEach(([i,r])=>{r!==void 0&&e.append(i,String(r))}),`${t.protocol}:${t.topic}@${t.version}?${e}`}function _i(t,e,s){return`${t}?wc_ev=${s}&topic=${e}`}var Rg=Object.defineProperty,Tg=Object.defineProperties,xg=Object.getOwnPropertyDescriptors,vc=Object.getOwnPropertySymbols,Ag=Object.prototype.hasOwnProperty,Cg=Object.prototype.propertyIsEnumerable,Ec=(t,e,s)=>e in t?Rg(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Ng=(t,e)=>{for(var s in e||(e={}))Ag.call(e,s)&&Ec(t,s,e[s]);if(vc)for(var s of vc(e))Cg.call(e,s)&&Ec(t,s,e[s]);return t},jg=(t,e)=>Tg(t,xg(e));function Ms(t){let e=[];return t.forEach(s=>{let[i,r]=s.split(":");e.push(`${i}:${r}`)}),e}function eo(t){let e=[];return Object.values(t).forEach(s=>{e.push(...Ms(s.accounts))}),[...new Set(e)]}function Kl(t){let e=[];return Object.values(t).forEach(s=>{e.push(...s.methods)}),[...new Set(e)]}function Hl(t){let e=[];return Object.values(t).forEach(s=>{e.push(...s.events)}),[...new Set(e)]}function qg(t,e){let s=[];return Object.values(t).forEach(i=>{Ms(i.accounts).includes(e)&&s.push(...i.methods)}),s}function kg(t,e){let s=[];return Object.values(t).forEach(i=>{Ms(i.accounts).includes(e)&&s.push(...i.events)}),s}function Ii(t){return t.includes(":")}function _s(t){return Ii(t)?t.split(":")[0]:t}function _c(t){var e,s,i;let r={};if(!st(t))return r;for(let[n,o]of Object.entries(t)){let a=Ii(n)?[n]:o.chains,c=o.methods||[],l=o.events||[],h=_s(n);r[h]=jg(Ng({},r[h]),{chains:ht(a,(e=r[h])==null?void 0:e.chains),methods:ht(c,(s=r[h])==null?void 0:s.methods),events:ht(l,(i=r[h])==null?void 0:i.events)})}return r}function Lg(t){let e={};return t?.forEach(s=>{var i;let[r,n]=s.split(":");e[r]||(e[r]={accounts:[],chains:[],events:[],methods:[]}),e[r].accounts.push(s),(i=e[r].chains)==null||i.push(`${r}:${n}`)}),e}function to(t,e){e=e.map(i=>i.replace("did:pkh:",""));let s=Lg(e);for(let[i,r]of Object.entries(s))r.methods?r.methods=ht(r.methods,t):r.methods=t,r.events=["chainChanged","accountsChanged"];return s}function Gl(t,e){var s,i,r,n,o,a;let c=_c(t),l=_c(e),h={},u=Object.keys(c).concat(Object.keys(l));for(let p of u)h[p]={chains:ht((s=c[p])==null?void 0:s.chains,(i=l[p])==null?void 0:i.chains),methods:ht((r=c[p])==null?void 0:r.methods,(n=l[p])==null?void 0:n.methods),events:ht((o=c[p])==null?void 0:o.events,(a=l[p])==null?void 0:a.events)};return h}var Fg={INVALID_METHOD:{message:"Invalid method.",code:1001},INVALID_EVENT:{message:"Invalid event.",code:1002},INVALID_UPDATE_REQUEST:{message:"Invalid update request.",code:1003},INVALID_EXTEND_REQUEST:{message:"Invalid extend request.",code:1004},INVALID_SESSION_SETTLE_REQUEST:{message:"Invalid session settle request.",code:1005},UNAUTHORIZED_METHOD:{message:"Unauthorized method.",code:3001},UNAUTHORIZED_EVENT:{message:"Unauthorized event.",code:3002},UNAUTHORIZED_UPDATE_REQUEST:{message:"Unauthorized update request.",code:3003},UNAUTHORIZED_EXTEND_REQUEST:{message:"Unauthorized extend request.",code:3004},USER_REJECTED:{message:"User rejected.",code:5e3},USER_REJECTED_CHAINS:{message:"User rejected chains.",code:5001},USER_REJECTED_METHODS:{message:"User rejected methods.",code:5002},USER_REJECTED_EVENTS:{message:"User rejected events.",code:5003},UNSUPPORTED_CHAINS:{message:"Unsupported chains.",code:5100},UNSUPPORTED_METHODS:{message:"Unsupported methods.",code:5101},UNSUPPORTED_EVENTS:{message:"Unsupported events.",code:5102},UNSUPPORTED_ACCOUNTS:{message:"Unsupported accounts.",code:5103},UNSUPPORTED_NAMESPACE_KEY:{message:"Unsupported namespace key.",code:5104},USER_DISCONNECTED:{message:"User disconnected.",code:6e3},SESSION_SETTLEMENT_FAILED:{message:"Session settlement failed.",code:7e3},WC_METHOD_UNSUPPORTED:{message:"Unsupported wc_ method.",code:10001}},Dg={NOT_INITIALIZED:{message:"Not initialized.",code:1},NO_MATCHING_KEY:{message:"No matching key.",code:2},RESTORE_WILL_OVERRIDE:{message:"Restore will override.",code:3},RESUBSCRIBED:{message:"Resubscribed.",code:4},MISSING_OR_INVALID:{message:"Missing or invalid.",code:5},EXPIRED:{message:"Expired.",code:6},UNKNOWN_TYPE:{message:"Unknown type.",code:7},MISMATCHED_TOPIC:{message:"Mismatched topic.",code:8},NON_CONFORMING_NAMESPACES:{message:"Non conforming namespaces.",code:9}};function A(t,e){let{message:s,code:i}=Dg[t];return{message:e?`${s} ${e}`:s,code:i}}function ie(t,e){let{message:s,code:i}=Fg[t];return{message:e?`${s} ${e}`:s,code:i}}function je(t,e){return Array.isArray(t)?typeof e<"u"&&t.length?t.every(e):!0:!1}function st(t){return Object.getPrototypeOf(t)===Object.prototype&&Object.keys(t).length}function ue(t){return typeof t>"u"}function le(t,e){return e&&ue(t)?!0:typeof t=="string"&&!!t.trim().length}function so(t,e){return e&&ue(t)?!0:typeof t=="number"&&!isNaN(t)}function Wl(t,e){let{requiredNamespaces:s}=e,i=Object.keys(t.namespaces),r=Object.keys(s),n=!0;return fs(r,i)?(i.forEach(o=>{let{accounts:a,methods:c,events:l}=t.namespaces[o],h=Ms(a),u=s[o];(!fs(Rc(o,u),h)||!fs(u.methods,c)||!fs(u.events,l))&&(n=!1)}),n):!1}function Zi(t){return le(t,!1)&&t.includes(":")?t.split(":").length===2:!1}function Ug(t){if(le(t,!1)&&t.includes(":")){let e=t.split(":");if(e.length===3){let s=e[0]+":"+e[1];return!!e[2]&&Zi(s)}}return!1}function Yl(t){function e(s){try{return typeof new URL(s)<"u"}catch{return!1}}try{if(le(t,!1)){if(e(t))return!0;let s=Fc(t);return e(s)}}catch{}return!1}function Jl(t){var e;return(e=t?.proposer)==null?void 0:e.publicKey}function Xl(t){return t?.topic}function Zl(t,e){let s=null;return le(t?.publicKey,!1)||(s=A("MISSING_OR_INVALID",`${e} controller public key should be a string`)),s}function Ic(t){let e=!0;return je(t)?t.length&&(e=t.every(s=>le(s,!1))):e=!1,e}function Bg(t,e,s){let i=null;return je(e)&&e.length?e.forEach(r=>{i||Zi(r)||(i=ie("UNSUPPORTED_CHAINS",`${s}, chain ${r} should be a string and conform to "namespace:chainId" format`))}):Zi(t)||(i=ie("UNSUPPORTED_CHAINS",`${s}, chains must be defined as "namespace:chainId" e.g. "eip155:1": {...} in the namespace key OR as an array of CAIP-2 chainIds e.g. eip155: { chains: ["eip155:1", "eip155:5"] }`)),i}function $g(t,e,s){let i=null;return Object.entries(t).forEach(([r,n])=>{if(i)return;let o=Bg(r,Rc(r,n),`${e} ${s}`);o&&(i=o)}),i}function Mg(t,e){let s=null;return je(t)?t.forEach(i=>{s||Ug(i)||(s=ie("UNSUPPORTED_ACCOUNTS",`${e}, account ${i} should be a string and conform to "namespace:chainId:address" format`))}):s=ie("UNSUPPORTED_ACCOUNTS",`${e}, accounts should be an array of strings conforming to "namespace:chainId:address" format`),s}function Vg(t,e){let s=null;return Object.values(t).forEach(i=>{if(s)return;let r=Mg(i?.accounts,`${e} namespace`);r&&(s=r)}),s}function zg(t,e){let s=null;return Ic(t?.methods)?Ic(t?.events)||(s=ie("UNSUPPORTED_EVENTS",`${e}, events should be an array of strings or empty array for no events`)):s=ie("UNSUPPORTED_METHODS",`${e}, methods should be an array of strings or empty array for no methods`),s}function Ql(t,e){let s=null;return Object.values(t).forEach(i=>{if(s)return;let r=zg(i,`${e}, namespace`);r&&(s=r)}),s}function eh(t,e,s){let i=null;if(t&&st(t)){let r=Ql(t,e);r&&(i=r);let n=$g(t,e,s);n&&(i=n)}else i=A("MISSING_OR_INVALID",`${e}, ${s} should be an object with data`);return i}function pr(t,e){let s=null;if(t&&st(t)){let i=Ql(t,e);i&&(s=i);let r=Vg(t,e);r&&(s=r)}else s=A("MISSING_OR_INVALID",`${e}, namespaces should be an object with data`);return s}function io(t){return le(t.protocol,!0)}function th(t,e){let s=!1;return e&&!t?s=!0:t&&je(t)&&t.length&&t.forEach(i=>{s=io(i)}),s}function sh(t){return typeof t=="number"}function Ae(t){return typeof t<"u"&&typeof t!==null}function ih(t){return!(!t||typeof t!="object"||!t.code||!so(t.code,!1)||!t.message||!le(t.message,!1))}function rh(t){return!(ue(t)||!le(t.method,!1))}function nh(t){return!(ue(t)||ue(t.result)&&ue(t.error)||!so(t.id,!1)||!le(t.jsonrpc,!1))}function oh(t){return!(ue(t)||!le(t.name,!1))}function ro(t,e){return!(!Zi(e)||!eo(t).includes(e))}function ah(t,e,s){return le(s,!1)?qg(t,e).includes(s):!1}function ch(t,e,s){return le(s,!1)?kg(t,e).includes(s):!1}function no(t,e,s){let i=null,r=Kg(t),n=Hg(e),o=Object.keys(r),a=Object.keys(n),c=Sc(Object.keys(t)),l=Sc(Object.keys(e)),h=c.filter(u=>!l.includes(u));return h.length&&(i=A("NON_CONFORMING_NAMESPACES",`${s} namespaces keys don't satisfy requiredNamespaces.
      Required: ${h.toString()}
      Received: ${Object.keys(e).toString()}`)),fs(o,a)||(i=A("NON_CONFORMING_NAMESPACES",`${s} namespaces chains don't satisfy required namespaces.
      Required: ${o.toString()}
      Approved: ${a.toString()}`)),Object.keys(e).forEach(u=>{if(!u.includes(":")||i)return;let p=Ms(e[u].accounts);p.includes(u)||(i=A("NON_CONFORMING_NAMESPACES",`${s} namespaces accounts don't satisfy namespace accounts for ${u}
        Required: ${u}
        Approved: ${p.toString()}`))}),o.forEach(u=>{i||(fs(r[u].methods,n[u].methods)?fs(r[u].events,n[u].events)||(i=A("NON_CONFORMING_NAMESPACES",`${s} namespaces events don't satisfy namespace events for ${u}`)):i=A("NON_CONFORMING_NAMESPACES",`${s} namespaces methods don't satisfy namespace methods for ${u}`))}),i}function Kg(t){let e={};return Object.keys(t).forEach(s=>{var i;s.includes(":")?e[s]=t[s]:(i=t[s].chains)==null||i.forEach(r=>{e[r]={methods:t[s].methods,events:t[s].events}})}),e}function Sc(t){return[...new Set(t.map(e=>e.includes(":")?e.split(":")[0]:e))]}function Hg(t){let e={};return Object.keys(t).forEach(s=>{s.includes(":")?e[s]=t[s]:Ms(t[s].accounts)?.forEach(r=>{e[r]={accounts:t[s].accounts.filter(n=>n.includes(`${r}:`)),methods:t[s].methods,events:t[s].events}})}),e}function lh(t,e){return so(t,!1)&&t<=e.max&&t>=e.min}function oo(){let t=fi();return new Promise(e=>{switch(t){case Be.browser:e(Gg());break;case Be.reactNative:e(Wg());break;case Be.node:e(Yg());break;default:e(!0)}})}function Gg(){return bs()&&navigator?.onLine}async function Wg(){return kt()&&typeof globalThis<"u"&&globalThis!=null&&globalThis.NetInfo?(await globalThis?.NetInfo.fetch())?.isConnected:!0}function Yg(){return!0}function hh(t){switch(fi()){case Be.browser:Jg(t);break;case Be.reactNative:Xg(t);break;case Be.node:break}}function Jg(t){!kt()&&bs()&&(window.addEventListener("online",()=>t(!0)),window.addEventListener("offline",()=>t(!1)))}function Xg(t){kt()&&typeof globalThis<"u"&&globalThis!=null&&globalThis.NetInfo&&globalThis?.NetInfo.addEventListener(e=>t(e?.isConnected))}function uh(){var t;return bs()&&(0,pt.getDocument)()?((t=(0,pt.getDocument)())==null?void 0:t.visibilityState)==="visible":!0}var cn={},is=class{static get(e){return cn[e]}static set(e,s){cn[e]=s}static delete(e){delete cn[e]}};function Zg(t){let e=Rs.decode(t);if(e.length<33)throw new Error("Too short to contain a public key");return e.slice(1,33)}function Qg({publicKey:t,signature:e,payload:s}){var i;let r=Tn(s.method),n=128|parseInt(((i=s.version)==null?void 0:i.toString())||"4"),o=sy(s.address),a=s.era==="00"?new Uint8Array([0]):Tn(s.era);if(a.length!==1&&a.length!==2)throw new Error("Invalid era length");let c=parseInt(s.nonce,16),l=new Uint8Array([c&255,c>>8&255]),h=BigInt(`0x${ty(s.tip)}`),u=ry(h),p=new Uint8Array([0,...t,o,...e,...a,...l,...u,...r]),d=iy(p.length+1);return new Uint8Array([...d,n,...p])}function ey(t){let e=Tn(t),s=(0,Pc.blake2b)(e,void 0,32);return"0x"+K.from(s).toString("hex")}function Tn(t){return new Uint8Array(t.replace(/^0x/,"").match(/.{1,2}/g).map(e=>parseInt(e,16)))}function ty(t){return t.startsWith("0x")?t.slice(2):t}function sy(t){let e=Rs.decode(t)[0];return e===42?0:e===60?2:1}function iy(t){if(t<64)return new Uint8Array([t<<2]);if(t<16384){let e=t<<2|1;return new Uint8Array([e&255,e>>8&255])}else if(t<1<<30){let e=t<<2|2;return new Uint8Array([e&255,e>>8&255,e>>16&255,e>>24&255])}else throw new Error("Compact encoding > 2^30 not supported")}function ry(t){if(t<BigInt(1)<<BigInt(6))return new Uint8Array([Number(t<<BigInt(2))]);if(t<BigInt(1)<<BigInt(14)){let e=t<<BigInt(2)|BigInt(1);return new Uint8Array([Number(e&BigInt(255)),Number(e>>BigInt(8)&BigInt(255))])}else if(t<BigInt(1)<<BigInt(30)){let e=t<<BigInt(2)|BigInt(2);return new Uint8Array([Number(e&BigInt(255)),Number(e>>BigInt(8)&BigInt(255)),Number(e>>BigInt(16)&BigInt(255)),Number(e>>BigInt(24)&BigInt(255))])}else throw new Error("BigInt compact encoding not supported > 2^30")}function ph(t){let e=Uint8Array.from(K.from(t.signature,"hex")),s=Zg(t.transaction.address),i=Qg({publicKey:s,signature:e,payload:t.transaction}),r=K.from(i).toString("hex");return ey(r)}function Vs({logger:t,name:e}){let s=typeof t=="string"?Ui({opts:{level:t,name:e}}).logger:t;return s.level=typeof t=="string"?t:t.level,s}qe();Fe();Le();qe();Fe();Le();Qs();qe();Fe();Le();Qs();qe();Fe();Le();Qs();var ny=Object.defineProperty,oy=(t,e,s)=>e in t?ny(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,dh=(t,e,s)=>oy(t,typeof e!="symbol"?e+"":e,s),dr=class extends us{constructor(e){super(),this.opts=e,dh(this,"protocol","wc"),dh(this,"version",2)}};var ay=Object.defineProperty,cy=(t,e,s)=>e in t?ay(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,ly=(t,e,s)=>cy(t,typeof e!="symbol"?e+"":e,s),fr=class extends us{constructor(e,s){super(),this.core=e,this.logger=s,ly(this,"records",new Map)}},gr=class{constructor(e,s){this.logger=e,this.core=s}},yr=class extends us{constructor(e,s){super(),this.relayer=e,this.logger=s}},mr=class extends us{constructor(e){super()}},wr=class{constructor(e,s,i,r){this.core=e,this.logger=s,this.name=i}};var br=class extends us{constructor(e,s){super(),this.relayer=e,this.logger=s}};var vr=class extends us{constructor(e,s){super(),this.core=e,this.logger=s}};var Er=class{constructor(e,s,i){this.core=e,this.logger=s,this.store=i}},_r=class{constructor(e,s){this.projectId=e,this.logger=s}},Ir=class{constructor(e,s,i){this.core=e,this.logger=s,this.telemetryEnabled=i}},hy=Object.defineProperty,uy=(t,e,s)=>e in t?hy(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,fh=(t,e,s)=>uy(t,typeof e!="symbol"?e+"":e,s);var Sr=class{constructor(e){this.opts=e,fh(this,"protocol","wc"),fh(this,"version",2)}};var Or=class{constructor(e){this.client=e}};var $=ls(Fr(),1);var Uh=ls(Ta(),1),Bh="wc",$h=2,Rr="core",It=`${Bh}@2:${Rr}:`,py={name:Rr,logger:"error"},dy={database:":memory:"},fy="crypto",gh="client_ed25519_seed",gy=$.ONE_DAY,yy="keychain",my="0.3",wy="messages",by="0.3",vy=$.SIX_HOURS,Ey="publisher",$o="irn",_y="error",Mh="wss://relay.walletconnect.org",Iy="relayer",pe={message:"relayer_message",message_ack:"relayer_message_ack",connect:"relayer_connect",disconnect:"relayer_disconnect",error:"relayer_error",connection_stalled:"relayer_connection_stalled",transport_closed:"relayer_transport_closed",publish:"relayer_publish"},Sy="_subscription",it={payload:"payload",connect:"connect",disconnect:"disconnect",error:"error"},Oy=.1;var ho="2.23.2";var oe={link_mode:"link_mode",relay:"relay"},Pr={inbound:"inbound",outbound:"outbound"},Py="0.3",Ry="WALLETCONNECT_CLIENT_ID",yh="WALLETCONNECT_LINK_MODE_APPS",Ye={created:"subscription_created",deleted:"subscription_deleted",expired:"subscription_expired",disabled:"subscription_disabled",sync:"subscription_sync",resubscribed:"subscription_resubscribed"};var Ty="subscription",xy="0.3",E1=$.FIVE_SECONDS*1e3,Ay="pairing",Cy="0.3";var Si={wc_pairingDelete:{req:{ttl:$.ONE_DAY,prompt:!1,tag:1e3},res:{ttl:$.ONE_DAY,prompt:!1,tag:1001}},wc_pairingPing:{req:{ttl:$.THIRTY_SECONDS,prompt:!1,tag:1002},res:{ttl:$.THIRTY_SECONDS,prompt:!1,tag:1003}},unregistered_method:{req:{ttl:$.ONE_DAY,prompt:!1,tag:0},res:{ttl:$.ONE_DAY,prompt:!1,tag:0}}},ns={create:"pairing_create",expire:"pairing_expire",delete:"pairing_delete",ping:"pairing_ping"},mt={created:"history_created",updated:"history_updated",deleted:"history_deleted",sync:"history_sync"},Ny="history",jy="0.3",qy="expirer",Je={created:"expirer_created",deleted:"expirer_deleted",expired:"expirer_expired",sync:"expirer_sync"},ky="0.3";var Ly="verify-api",Fy="https://verify.walletconnect.com",Vh="https://verify.walletconnect.org",Hs=Vh,Dy=`${Hs}/v3`,Uy=[Fy,Vh],By="echo",$y="https://echo.walletconnect.com";var wt={pairing_started:"pairing_started",pairing_uri_validation_success:"pairing_uri_validation_success",pairing_uri_not_expired:"pairing_uri_not_expired",store_new_pairing:"store_new_pairing",subscribing_pairing_topic:"subscribing_pairing_topic",subscribe_pairing_topic_success:"subscribe_pairing_topic_success",existing_pairing:"existing_pairing",pairing_not_expired:"pairing_not_expired",emit_inactive_pairing:"emit_inactive_pairing",emit_session_proposal:"emit_session_proposal",subscribing_to_pairing_topic:"subscribing_to_pairing_topic"},_t={no_wss_connection:"no_wss_connection",no_internet_connection:"no_internet_connection",malformed_pairing_uri:"malformed_pairing_uri",active_pairing_already_exists:"active_pairing_already_exists",subscribe_pairing_topic_failure:"subscribe_pairing_topic_failure",pairing_expired:"pairing_expired",proposal_expired:"proposal_expired",proposal_listener_not_found:"proposal_listener_not_found"},nt={session_approve_started:"session_approve_started",proposal_not_expired:"proposal_not_expired",session_namespaces_validation_success:"session_namespaces_validation_success",create_session_topic:"create_session_topic",subscribing_session_topic:"subscribing_session_topic",subscribe_session_topic_success:"subscribe_session_topic_success",publishing_session_approve:"publishing_session_approve",session_approve_publish_success:"session_approve_publish_success",store_session:"store_session",publishing_session_settle:"publishing_session_settle",session_settle_publish_success:"session_settle_publish_success",session_request_response_started:"session_request_response_started",session_request_response_validation_success:"session_request_response_validation_success",session_request_response_publish_started:"session_request_response_publish_started"},os={no_internet_connection:"no_internet_connection",no_wss_connection:"no_wss_connection",proposal_expired:"proposal_expired",subscribe_session_topic_failure:"subscribe_session_topic_failure",session_approve_publish_failure:"session_approve_publish_failure",session_settle_publish_failure:"session_settle_publish_failure",session_approve_namespace_validation_failure:"session_approve_namespace_validation_failure",proposal_not_found:"proposal_not_found",session_request_response_validation_failure:"session_request_response_validation_failure",session_request_response_publish_failure:"session_request_response_publish_failure"},as={authenticated_session_approve_started:"authenticated_session_approve_started",authenticated_session_not_expired:"authenticated_session_not_expired",chains_caip2_compliant:"chains_caip2_compliant",chains_evm_compliant:"chains_evm_compliant",create_authenticated_session_topic:"create_authenticated_session_topic",cacaos_verified:"cacaos_verified",store_authenticated_session:"store_authenticated_session",subscribing_authenticated_session_topic:"subscribing_authenticated_session_topic",subscribe_authenticated_session_topic_success:"subscribe_authenticated_session_topic_success",publishing_authenticated_session_approve:"publishing_authenticated_session_approve",authenticated_session_approve_publish_success:"authenticated_session_approve_publish_success"},Gs={no_internet_connection:"no_internet_connection",no_wss_connection:"no_wss_connection",missing_session_authenticate_request:"missing_session_authenticate_request",session_authenticate_request_expired:"session_authenticate_request_expired",chains_caip2_compliant_failure:"chains_caip2_compliant_failure",chains_evm_compliant_failure:"chains_evm_compliant_failure",invalid_cacao:"invalid_cacao",subscribe_authenticated_session_topic_failure:"subscribe_authenticated_session_topic_failure",authenticated_session_approve_publish_failure:"authenticated_session_approve_publish_failure",authenticated_session_pending_request_not_found:"authenticated_session_pending_request_not_found"},My=.1,Vy="event-client",zy=86400,Ky="https://pulse.walletconnect.org/batch";function Hy(t,e){if(t.length>=255)throw new TypeError("Alphabet too long");for(var s=new Uint8Array(256),i=0;i<s.length;i++)s[i]=255;for(var r=0;r<t.length;r++){var n=t.charAt(r),o=n.charCodeAt(0);if(s[o]!==255)throw new TypeError(n+" is ambiguous");s[o]=r}var a=t.length,c=t.charAt(0),l=Math.log(a)/Math.log(256),h=Math.log(256)/Math.log(a);function u(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,y=0,P=0,x=f.length;P!==x&&f[P]===0;)P++,g++;for(var S=(x-P)*h+1>>>0,q=new Uint8Array(S);P!==x;){for(var B=f[P],N=0,D=S-1;(B!==0||N<y)&&D!==-1;D--,N++)B+=256*q[D]>>>0,q[D]=B%a>>>0,B=B/a>>>0;if(B!==0)throw new Error("Non-zero carry");y=N,P++}for(var U=S-y;U!==S&&q[U]===0;)U++;for(var _=c.repeat(g);U<S;++U)_+=t.charAt(q[U]);return _}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var y=0,P=0;f[g]===c;)y++,g++;for(var x=(f.length-g)*l+1>>>0,S=new Uint8Array(x);f[g];){var q=s[f.charCodeAt(g)];if(q===255)return;for(var B=0,N=x-1;(q!==0||B<P)&&N!==-1;N--,B++)q+=a*S[N]>>>0,S[N]=q%256>>>0,q=q/256>>>0;if(q!==0)throw new Error("Non-zero carry");P=B,g++}if(f[g]!==" "){for(var D=x-P;D!==x&&S[D]===0;)D++;for(var U=new Uint8Array(y+(x-D)),_=y;D!==x;)U[_++]=S[D++];return U}}}function d(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:p,decode:d}}var Gy=Hy,Wy=Gy,zh=t=>{if(t instanceof Uint8Array&&t.constructor.name==="Uint8Array")return t;if(t instanceof ArrayBuffer)return new Uint8Array(t);if(ArrayBuffer.isView(t))return new Uint8Array(t.buffer,t.byteOffset,t.byteLength);throw new Error("Unknown type, must be binary type")},Yy=t=>new TextEncoder().encode(t),Jy=t=>new TextDecoder().decode(t),uo=class{constructor(e,s,i){this.name=e,this.prefix=s,this.baseEncode=i}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},po=class{constructor(e,s,i){if(this.name=e,this.prefix=s,s.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=s.codePointAt(0),this.baseDecode=i}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Kh(this,e)}},fo=class{constructor(e){this.decoders=e}or(e){return Kh(this,e)}decode(e){let s=e[0],i=this.decoders[s];if(i)return i.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},Kh=(t,e)=>new fo({...t.decoders||{[t.prefix]:t},...e.decoders||{[e.prefix]:e}}),go=class{constructor(e,s,i,r){this.name=e,this.prefix=s,this.baseEncode=i,this.baseDecode=r,this.encoder=new uo(e,s,i),this.decoder=new po(e,s,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},Tr=({name:t,prefix:e,encode:s,decode:i})=>new go(t,e,s,i),xi=({prefix:t,name:e,alphabet:s})=>{let{encode:i,decode:r}=Wy(s,e);return Tr({prefix:t,name:e,encode:i,decode:n=>zh(r(n))})},Xy=(t,e,s,i)=>{let r={};for(let h=0;h<e.length;++h)r[e[h]]=h;let n=t.length;for(;t[n-1]==="=";)--n;let o=new Uint8Array(n*s/8|0),a=0,c=0,l=0;for(let h=0;h<n;++h){let u=r[t[h]];if(u===void 0)throw new SyntaxError(`Non-${i} character`);c=c<<s|u,a+=s,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=s||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Zy=(t,e,s)=>{let i=e[e.length-1]==="=",r=(1<<s)-1,n="",o=0,a=0;for(let c=0;c<t.length;++c)for(a=a<<8|t[c],o+=8;o>s;)o-=s,n+=e[r&a>>o];if(o&&(n+=e[r&a<<s-o]),i)for(;n.length*s&7;)n+="=";return n},be=({name:t,prefix:e,bitsPerChar:s,alphabet:i})=>Tr({prefix:e,name:t,encode(r){return Zy(r,i,s)},decode(r){return Xy(r,i,s,t)}}),Qy=Tr({prefix:"\0",name:"identity",encode:t=>Jy(t),decode:t=>Yy(t)}),em=Object.freeze({__proto__:null,identity:Qy}),tm=be({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),sm=Object.freeze({__proto__:null,base2:tm}),im=be({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),rm=Object.freeze({__proto__:null,base8:im}),nm=xi({prefix:"9",name:"base10",alphabet:"0123456789"}),om=Object.freeze({__proto__:null,base10:nm}),am=be({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),cm=be({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),lm=Object.freeze({__proto__:null,base16:am,base16upper:cm}),hm=be({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),um=be({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),pm=be({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),dm=be({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),fm=be({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),gm=be({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),ym=be({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),mm=be({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),wm=be({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),bm=Object.freeze({__proto__:null,base32:hm,base32upper:um,base32pad:pm,base32padupper:dm,base32hex:fm,base32hexupper:gm,base32hexpad:ym,base32hexpadupper:mm,base32z:wm}),vm=xi({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Em=xi({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),_m=Object.freeze({__proto__:null,base36:vm,base36upper:Em}),Im=xi({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Sm=xi({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),Om=Object.freeze({__proto__:null,base58btc:Im,base58flickr:Sm}),Pm=be({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Rm=be({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Tm=be({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),xm=be({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),Am=Object.freeze({__proto__:null,base64:Pm,base64pad:Rm,base64url:Tm,base64urlpad:xm}),Hh=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),Cm=Hh.reduce((t,e,s)=>(t[s]=e,t),[]),Nm=Hh.reduce((t,e,s)=>(t[e.codePointAt(0)]=s,t),[]);function jm(t){return t.reduce((e,s)=>(e+=Cm[s],e),"")}function qm(t){let e=[];for(let s of t){let i=Nm[s.codePointAt(0)];if(i===void 0)throw new Error(`Non-base256emoji character: ${s}`);e.push(i)}return new Uint8Array(e)}var km=Tr({prefix:"\u{1F680}",name:"base256emoji",encode:jm,decode:qm}),Lm=Object.freeze({__proto__:null,base256emoji:km}),Fm=Gh,mh=128,Dm=127,Um=~Dm,Bm=Math.pow(2,31);function Gh(t,e,s){e=e||[],s=s||0;for(var i=s;t>=Bm;)e[s++]=t&255|mh,t/=128;for(;t&Um;)e[s++]=t&255|mh,t>>>=7;return e[s]=t|0,Gh.bytes=s-i+1,e}var $m=yo,Mm=128,wh=127;function yo(t,i){var s=0,i=i||0,r=0,n=i,o,a=t.length;do{if(n>=a)throw yo.bytes=0,new RangeError("Could not decode varint");o=t[n++],s+=r<28?(o&wh)<<r:(o&wh)*Math.pow(2,r),r+=7}while(o>=Mm);return yo.bytes=n-i,s}var Vm=Math.pow(2,7),zm=Math.pow(2,14),Km=Math.pow(2,21),Hm=Math.pow(2,28),Gm=Math.pow(2,35),Wm=Math.pow(2,42),Ym=Math.pow(2,49),Jm=Math.pow(2,56),Xm=Math.pow(2,63),Zm=function(t){return t<Vm?1:t<zm?2:t<Km?3:t<Hm?4:t<Gm?5:t<Wm?6:t<Ym?7:t<Jm?8:t<Xm?9:10},Qm={encode:Fm,decode:$m,encodingLength:Zm},Wh=Qm,bh=(t,e,s=0)=>(Wh.encode(t,e,s),e),vh=t=>Wh.encodingLength(t),mo=(t,e)=>{let s=e.byteLength,i=vh(t),r=i+vh(s),n=new Uint8Array(r+s);return bh(t,n,0),bh(s,n,i),n.set(e,r),new wo(t,s,e,n)},wo=class{constructor(e,s,i,r){this.code=e,this.size=s,this.digest=i,this.bytes=r}},Yh=({name:t,code:e,encode:s})=>new bo(t,e,s),bo=class{constructor(e,s,i){this.name=e,this.code=s,this.encode=i}digest(e){if(e instanceof Uint8Array){let s=this.encode(e);return s instanceof Uint8Array?mo(this.code,s):s.then(i=>mo(this.code,i))}else throw Error("Unknown type, must be binary type")}},Jh=t=>async e=>new Uint8Array(await crypto.subtle.digest(t,e)),ew=Yh({name:"sha2-256",code:18,encode:Jh("SHA-256")}),tw=Yh({name:"sha2-512",code:19,encode:Jh("SHA-512")}),sw=Object.freeze({__proto__:null,sha256:ew,sha512:tw}),Xh=0,iw="identity",Zh=zh,rw=t=>mo(Xh,Zh(t)),nw={code:Xh,name:iw,encode:Zh,digest:rw},ow=Object.freeze({__proto__:null,identity:nw});new TextEncoder,new TextDecoder;var Eh={...em,...sm,...rm,...om,...lm,...bm,..._m,...Om,...Am,...Lm};({...sw,...ow});function Qh(t){return globalThis.Buffer!=null?new Uint8Array(t.buffer,t.byteOffset,t.byteLength):t}function aw(t=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?Qh(globalThis.Buffer.allocUnsafe(t)):new Uint8Array(t)}function eu(t,e,s,i){return{name:t,prefix:e,encoder:{name:t,prefix:e,encode:s},decoder:{decode:i}}}var _h=eu("utf8","u",t=>"u"+new TextDecoder("utf8").decode(t),t=>new TextEncoder().encode(t.substring(1))),ao=eu("ascii","a",t=>{let e="a";for(let s=0;s<t.length;s++)e+=String.fromCharCode(t[s]);return e},t=>{t=t.substring(1);let e=aw(t.length);for(let s=0;s<t.length;s++)e[s]=t.charCodeAt(s);return e}),cw={utf8:_h,"utf-8":_h,hex:Eh.base16,latin1:ao,ascii:ao,binary:ao,...Eh};function lw(t,e="utf8"){let s=cw[e];if(!s)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?Qh(globalThis.Buffer.from(t,"utf-8")):s.decoder.decode(`${s.prefix}${t}`)}var hw=Object.defineProperty,uw=(t,e,s)=>e in t?hw(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Et=(t,e,s)=>uw(t,typeof e!="symbol"?e+"":e,s),vo=class{constructor(e,s){this.core=e,this.logger=s,Et(this,"keychain",new Map),Et(this,"name",yy),Et(this,"version",my),Et(this,"initialized",!1),Et(this,"storagePrefix",It),Et(this,"init",async()=>{if(!this.initialized){let i=await this.getKeyChain();typeof i<"u"&&(this.keychain=i),this.initialized=!0}}),Et(this,"has",i=>(this.isInitialized(),this.keychain.has(i))),Et(this,"set",async(i,r)=>{this.isInitialized(),this.keychain.set(i,r),await this.persist()}),Et(this,"get",i=>{this.isInitialized();let r=this.keychain.get(i);if(typeof r>"u"){let{message:n}=A("NO_MATCHING_KEY",`${this.name}: ${i}`);throw new Error(n)}return r}),Et(this,"del",async i=>{this.isInitialized(),this.keychain.delete(i),await this.persist()}),this.core=e,this.logger=De(s,this.name)}get context(){return Ie(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}async setKeyChain(e){await this.core.storage.setItem(this.storageKey,Qi(e))}async getKeyChain(){let e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?er(e):void 0}async persist(){await this.setKeyChain(this.keychain)}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}},pw=Object.defineProperty,dw=(t,e,s)=>e in t?pw(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,ge=(t,e,s)=>dw(t,typeof e!="symbol"?e+"":e,s),Eo=class{constructor(e,s,i){this.core=e,this.logger=s,ge(this,"name",fy),ge(this,"keychain"),ge(this,"randomSessionIdentifier",ur()),ge(this,"initialized",!1),ge(this,"clientId"),ge(this,"init",async()=>{this.initialized||(await this.keychain.init(),this.initialized=!0)}),ge(this,"hasKeys",r=>(this.isInitialized(),this.keychain.has(r))),ge(this,"getClientId",async()=>{if(this.isInitialized(),this.clientId)return this.clientId;let r=await this.getClientSeed(),n=Ur(r),o=Oa(n.publicKey);return this.clientId=o,o}),ge(this,"generateKeyPair",()=>{this.isInitialized();let r=jl();return this.setPrivateKey(r.publicKey,r.privateKey)}),ge(this,"signJWT",async r=>{this.isInitialized();let n=await this.getClientSeed(),o=Ur(n),a=this.randomSessionIdentifier;return await Pa(a,r,gy,o)}),ge(this,"generateSharedKey",(r,n,o)=>{this.isInitialized();let a=this.getPrivateKey(r),c=ql(a,n);return this.setSymKey(c,o)}),ge(this,"setSymKey",async(r,n)=>{this.isInitialized();let o=n||Bs(r);return await this.keychain.set(o,r),o}),ge(this,"deleteKeyPair",async r=>{this.isInitialized(),await this.keychain.del(r)}),ge(this,"deleteSymKey",async r=>{this.isInitialized(),await this.keychain.del(r)}),ge(this,"encode",async(r,n,o)=>{this.isInitialized();let a=Yn(o),c=Ia(n);if(Xn(a))return Bl(c,o?.encoding);if(Jn(a)){let p=a.senderPublicKey,d=a.receiverPublicKey;r=await this.generateSharedKey(p,d)}let l=this.getSymKey(r),{type:h,senderPublicKey:u}=a;return Dl({type:h,symKey:l,message:c,senderPublicKey:u,encoding:o?.encoding})}),ge(this,"decode",async(r,n,o)=>{this.isInitialized();let a=Vl(n,o);if(Xn(a)){let c=$l(n,o?.encoding);return Dr(c)}if(Jn(a)){let c=a.receiverPublicKey,l=a.senderPublicKey;r=await this.generateSharedKey(c,l)}try{let c=this.getSymKey(r),l=Ul({symKey:c,encoded:n,encoding:o?.encoding});return Dr(l)}catch(c){this.logger.error(`Failed to decode message from topic: '${r}', clientId: '${await this.getClientId()}'`),this.logger.error(c)}}),ge(this,"getPayloadType",(r,n=xe)=>{let o=$s({encoded:r,encoding:n});return ss(o.type)}),ge(this,"getPayloadSenderPublicKey",(r,n=xe)=>{let o=$s({encoded:r,encoding:n});return o.senderPublicKey?_e(o.senderPublicKey,Te):void 0}),this.core=e,this.logger=De(s,this.name),this.keychain=i||new vo(this.core,this.logger)}get context(){return Ie(this.logger)}async setPrivateKey(e,s){return await this.keychain.set(e,s),e}getPrivateKey(e){return this.keychain.get(e)}async getClientSeed(){let e="";try{e=this.keychain.get(gh)}catch{e=ur(),await this.keychain.set(gh,e)}return lw(e,"base16")}getSymKey(e){return this.keychain.get(e)}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}},fw=Object.defineProperty,gw=Object.defineProperties,yw=Object.getOwnPropertyDescriptors,Ih=Object.getOwnPropertySymbols,mw=Object.prototype.hasOwnProperty,ww=Object.prototype.propertyIsEnumerable,_o=(t,e,s)=>e in t?fw(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,bw=(t,e)=>{for(var s in e||(e={}))mw.call(e,s)&&_o(t,s,e[s]);if(Ih)for(var s of Ih(e))ww.call(e,s)&&_o(t,s,e[s]);return t},vw=(t,e)=>gw(t,yw(e)),We=(t,e,s)=>_o(t,typeof e!="symbol"?e+"":e,s),Io=class extends gr{constructor(e,s){super(e,s),this.logger=e,this.core=s,We(this,"messages",new Map),We(this,"messagesWithoutClientAck",new Map),We(this,"name",wy),We(this,"version",by),We(this,"initialized",!1),We(this,"storagePrefix",It),We(this,"init",async()=>{if(!this.initialized){this.logger.trace("Initialized");try{let i=await this.getRelayerMessages();typeof i<"u"&&(this.messages=i);let r=await this.getRelayerMessagesWithoutClientAck();typeof r<"u"&&(this.messagesWithoutClientAck=r),this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",size:this.messages.size})}catch(i){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(i)}finally{this.initialized=!0}}}),We(this,"set",async(i,r,n)=>{this.isInitialized();let o=Me(r),a=this.messages.get(i);if(typeof a>"u"&&(a={}),typeof a[o]<"u")return o;if(a[o]=r,this.messages.set(i,a),n===Pr.inbound){let c=this.messagesWithoutClientAck.get(i)||{};this.messagesWithoutClientAck.set(i,vw(bw({},c),{[o]:r}))}return await this.persist(),o}),We(this,"get",i=>{this.isInitialized();let r=this.messages.get(i);return typeof r>"u"&&(r={}),r}),We(this,"getWithoutAck",i=>{this.isInitialized();let r={};for(let n of i){let o=this.messagesWithoutClientAck.get(n)||{};r[n]=Object.values(o)}return r}),We(this,"has",(i,r)=>{this.isInitialized();let n=this.get(i),o=Me(r);return typeof n[o]<"u"}),We(this,"ack",async(i,r)=>{this.isInitialized();let n=this.messagesWithoutClientAck.get(i);if(typeof n>"u")return;let o=Me(r);delete n[o],Object.keys(n).length===0?this.messagesWithoutClientAck.delete(i):this.messagesWithoutClientAck.set(i,n),await this.persist()}),We(this,"del",async i=>{this.isInitialized(),this.messages.delete(i),this.messagesWithoutClientAck.delete(i),await this.persist()}),this.logger=De(e,this.name),this.core=s}get context(){return Ie(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get storageKeyWithoutClientAck(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name+"_withoutClientAck"}async setRelayerMessages(e){await this.core.storage.setItem(this.storageKey,Qi(e))}async setRelayerMessagesWithoutClientAck(e){await this.core.storage.setItem(this.storageKeyWithoutClientAck,Qi(e))}async getRelayerMessages(){let e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?er(e):void 0}async getRelayerMessagesWithoutClientAck(){let e=await this.core.storage.getItem(this.storageKeyWithoutClientAck);return typeof e<"u"?er(e):void 0}async persist(){await this.setRelayerMessages(this.messages),await this.setRelayerMessagesWithoutClientAck(this.messagesWithoutClientAck)}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}},Ew=Object.defineProperty,_w=Object.defineProperties,Iw=Object.getOwnPropertyDescriptors,Sh=Object.getOwnPropertySymbols,Sw=Object.prototype.hasOwnProperty,Ow=Object.prototype.propertyIsEnumerable,So=(t,e,s)=>e in t?Ew(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,zs=(t,e)=>{for(var s in e||(e={}))Sw.call(e,s)&&So(t,s,e[s]);if(Sh)for(var s of Sh(e))Ow.call(e,s)&&So(t,s,e[s]);return t},Oh=(t,e)=>_w(t,Iw(e)),rt=(t,e,s)=>So(t,typeof e!="symbol"?e+"":e,s),Oo=class extends yr{constructor(e,s){super(e,s),this.relayer=e,this.logger=s,rt(this,"events",new Qe),rt(this,"name",Ey),rt(this,"queue",new Map),rt(this,"publishTimeout",(0,$.toMiliseconds)($.ONE_MINUTE)),rt(this,"initialPublishTimeout",(0,$.toMiliseconds)($.ONE_SECOND*15)),rt(this,"needsTransportRestart",!1),rt(this,"publish",async(i,r,n)=>{var o,a,c,l,h;this.logger.debug("Publishing Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:i,message:r,opts:n}});let u=n?.ttl||vy,p=n?.prompt||!1,d=n?.tag||0,f=n?.id||Rt().toString(),g=Es(Ei().protocol),y={id:f,method:n?.publishMethod||g.publish,params:zs({topic:i,message:r,ttl:u,prompt:p,tag:d,attestation:n?.attestation},n?.tvf)},P=`Failed to publish payload, please try again. id:${f} tag:${d}`;try{ue((o=y.params)==null?void 0:o.prompt)&&((a=y.params)==null||delete a.prompt),ue((c=y.params)==null?void 0:c.tag)&&((l=y.params)==null||delete l.tag);let x=new Promise(async S=>{let q=({id:N})=>{var D;((D=y.id)==null?void 0:D.toString())===N.toString()&&(this.removeRequestFromQueue(N),this.relayer.events.removeListener(pe.publish,q),S())};this.relayer.events.on(pe.publish,q);let B=gt(new Promise((N,D)=>{this.rpcPublish(y,n).then(N).catch(U=>{this.logger.warn(U,U?.message),D(U)})}),this.initialPublishTimeout,`Failed initial publish, retrying.... id:${f} tag:${d}`);try{await B,this.events.removeListener(pe.publish,q)}catch(N){this.queue.set(f,{request:y,opts:n,attempt:1}),this.logger.warn(N,N?.message)}});this.logger.trace({type:"method",method:"publish",params:{id:f,topic:i,message:r,opts:n}}),await gt(x,this.publishTimeout,P)}catch(x){if(this.logger.debug("Failed to Publish Payload"),this.logger.error(x),(h=n?.internal)!=null&&h.throwOnFailedPublish)throw x}finally{this.queue.delete(f)}}),rt(this,"publishCustom",async i=>{var r,n,o,a,c;this.logger.debug("Publishing custom payload"),this.logger.trace({type:"method",method:"publishCustom",params:i});let{payload:l,opts:h={}}=i,{attestation:u,tvf:p,publishMethod:d,prompt:f,tag:g,ttl:y=$.FIVE_MINUTES}=h,P=h.id||Rt().toString(),x=Es(Ei().protocol),S=d||x.publish,q={id:P,method:S,params:zs(Oh(zs({},l),{ttl:y,prompt:f,tag:g,attestation:u}),p)},B=`Failed to publish custom payload, please try again. id:${P} tag:${g}`;try{ue((r=q.params)==null?void 0:r.prompt)&&((n=q.params)==null||delete n.prompt),ue((o=q.params)==null?void 0:o.tag)&&((a=q.params)==null||delete a.tag);let N=new Promise(async D=>{let U=({id:F})=>{var M;((M=q.id)==null?void 0:M.toString())===F.toString()&&(this.removeRequestFromQueue(F),this.relayer.events.removeListener(pe.publish,U),D())};this.relayer.events.on(pe.publish,U);let _=gt(new Promise((F,M)=>{this.rpcPublish(q,h).then(F).catch(R=>{this.logger.warn(R,R?.message),M(R)})}),this.initialPublishTimeout,`Failed initial custom payload publish, retrying.... method:${S} id:${P} tag:${g}`);try{await _,this.events.removeListener(pe.publish,U)}catch(F){this.queue.set(P,{request:q,opts:h,attempt:1}),this.logger.warn(F,F?.message)}});this.logger.trace({type:"method",method:"publish",params:{id:P,payload:l,opts:h}}),await gt(N,this.publishTimeout,B)}catch(N){if(this.logger.debug("Failed to Publish Payload"),this.logger.error(N),(c=h?.internal)!=null&&c.throwOnFailedPublish)throw N}finally{this.queue.delete(P)}}),rt(this,"on",(i,r)=>{this.events.on(i,r)}),rt(this,"once",(i,r)=>{this.events.once(i,r)}),rt(this,"off",(i,r)=>{this.events.off(i,r)}),rt(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),this.relayer=e,this.logger=De(s,this.name),this.registerEventListeners()}get context(){return Ie(this.logger)}async rpcPublish(e,s){this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"message",direction:"outgoing",request:e});let i=await this.relayer.request(e);return this.relayer.events.emit(pe.publish,zs(zs({},e),s)),this.logger.debug("Successfully Published Payload"),i}removeRequestFromQueue(e){this.queue.delete(e)}checkQueue(){this.queue.forEach(async(e,s)=>{var i;let r=e.attempt+1;this.queue.set(s,Oh(zs({},e),{attempt:r})),this.logger.warn({},`Publisher: queue->publishing: ${e.request.id}, tag: ${(i=e.request.params)==null?void 0:i.tag}, attempt: ${r}`),await this.rpcPublish(e.request,e.opts),this.logger.warn({},`Publisher: queue->published: ${e.request.id}`)})}registerEventListeners(){this.relayer.core.heartbeat.on(ps.pulse,()=>{if(this.needsTransportRestart){this.needsTransportRestart=!1,this.relayer.events.emit(pe.connection_stalled);return}this.checkQueue()}),this.relayer.on(pe.message_ack,e=>{this.removeRequestFromQueue(e.id.toString())})}},Pw=Object.defineProperty,Rw=(t,e,s)=>e in t?Pw(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Ks=(t,e,s)=>Rw(t,typeof e!="symbol"?e+"":e,s),Po=class{constructor(){Ks(this,"map",new Map),Ks(this,"set",(e,s)=>{let i=this.get(e);this.exists(e,s)||this.map.set(e,[...i,s])}),Ks(this,"get",e=>this.map.get(e)||[]),Ks(this,"exists",(e,s)=>this.get(e).includes(s)),Ks(this,"delete",(e,s)=>{if(typeof s>"u"){this.map.delete(e);return}if(!this.map.has(e))return;let i=this.get(e);if(!this.exists(e,s))return;let r=i.filter(n=>n!==s);if(!r.length){this.map.delete(e);return}this.map.set(e,r)}),Ks(this,"clear",()=>{this.map.clear()})}get topics(){return Array.from(this.map.keys())}},Tw=Object.defineProperty,xw=Object.defineProperties,Aw=Object.getOwnPropertyDescriptors,Ph=Object.getOwnPropertySymbols,Cw=Object.prototype.hasOwnProperty,Nw=Object.prototype.propertyIsEnumerable,Ro=(t,e,s)=>e in t?Tw(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Oi=(t,e)=>{for(var s in e||(e={}))Cw.call(e,s)&&Ro(t,s,e[s]);if(Ph)for(var s of Ph(e))Nw.call(e,s)&&Ro(t,s,e[s]);return t},co=(t,e)=>xw(t,Aw(e)),re=(t,e,s)=>Ro(t,typeof e!="symbol"?e+"":e,s),To=class extends br{constructor(e,s){super(e,s),this.relayer=e,this.logger=s,re(this,"subscriptions",new Map),re(this,"topicMap",new Po),re(this,"events",new Qe),re(this,"name",Ty),re(this,"version",xy),re(this,"pending",new Map),re(this,"cached",[]),re(this,"initialized",!1),re(this,"storagePrefix",It),re(this,"subscribeTimeout",(0,$.toMiliseconds)($.ONE_MINUTE)),re(this,"initialSubscribeTimeout",(0,$.toMiliseconds)($.ONE_SECOND*15)),re(this,"clientId"),re(this,"batchSubscribeTopicsLimit",500),re(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),this.registerEventListeners(),await this.restore()),this.initialized=!0}),re(this,"subscribe",async(i,r)=>{var n;this.isInitialized(),this.logger.debug("Subscribing Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:i,opts:r}});try{let o=Ei(r),a={topic:i,relay:o,transportType:r?.transportType};(n=r?.internal)!=null&&n.skipSubscribe||this.pending.set(i,a);let c=await this.rpcSubscribe(i,o,r);return typeof c=="string"&&(this.onSubscribe(c,a),this.logger.debug("Successfully Subscribed Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:i,opts:r}})),c}catch(o){throw this.logger.debug("Failed to Subscribe Topic"),this.logger.error(o),o}}),re(this,"unsubscribe",async(i,r)=>{this.isInitialized(),typeof r?.id<"u"?await this.unsubscribeById(i,r.id,r):await this.unsubscribeByTopic(i,r)}),re(this,"isSubscribed",i=>new Promise(r=>{r(this.topicMap.topics.includes(i))})),re(this,"isKnownTopic",i=>new Promise(r=>{r(this.topicMap.topics.includes(i)||this.pending.has(i)||this.cached.some(n=>n.topic===i))})),re(this,"on",(i,r)=>{this.events.on(i,r)}),re(this,"once",(i,r)=>{this.events.once(i,r)}),re(this,"off",(i,r)=>{this.events.off(i,r)}),re(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),re(this,"start",async()=>{await this.onConnect()}),re(this,"stop",async()=>{await this.onDisconnect()}),re(this,"restart",async()=>{await this.restore(),await this.onRestart()}),re(this,"checkPending",async()=>{if(this.pending.size===0&&(!this.initialized||!this.relayer.connected))return;let i=[];this.pending.forEach(r=>{i.push(r)}),await this.batchSubscribe(i)}),re(this,"registerEventListeners",()=>{this.relayer.core.heartbeat.on(ps.pulse,async()=>{await this.checkPending()}),this.events.on(Ye.created,async i=>{let r=Ye.created;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:i}),await this.persist()}),this.events.on(Ye.deleted,async i=>{let r=Ye.deleted;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:i}),await this.persist()})}),this.relayer=e,this.logger=De(s,this.name),this.clientId=""}get context(){return Ie(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.relayer.core.customStoragePrefix+"//"+this.name}get length(){return this.subscriptions.size}get ids(){return Array.from(this.subscriptions.keys())}get values(){return Array.from(this.subscriptions.values())}get topics(){return this.topicMap.topics}get hasAnyTopics(){return this.topicMap.topics.length>0||this.pending.size>0||this.cached.length>0||this.subscriptions.size>0}hasSubscription(e,s){let i=!1;try{i=this.getSubscription(e).topic===s}catch{}return i}reset(){this.cached=[],this.initialized=!0}onDisable(){this.values.length>0&&(this.cached=this.values),this.subscriptions.clear(),this.topicMap.clear()}async unsubscribeByTopic(e,s){let i=this.topicMap.get(e);await Promise.all(i.map(async r=>await this.unsubscribeById(e,r,s)))}async unsubscribeById(e,s,i){this.logger.debug("Unsubscribing Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:s,opts:i}});try{let r=Ei(i);await this.restartToComplete({topic:e,id:s,relay:r}),await this.rpcUnsubscribe(e,s,r);let n=ie("USER_DISCONNECTED",`${this.name}, ${e}`);await this.onUnsubscribe(e,s,n),this.logger.debug("Successfully Unsubscribed Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:s,opts:i}})}catch(r){throw this.logger.debug("Failed to Unsubscribe Topic"),this.logger.error(r),r}}async rpcSubscribe(e,s,i){var r,n;let o=await this.getSubscriptionId(e);if((r=i?.internal)!=null&&r.skipSubscribe)return o;(!i||i?.transportType===oe.relay)&&await this.restartToComplete({topic:e,id:e,relay:s});let a={method:Es(s.protocol).subscribe,params:{topic:e}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:a});let c=(n=i?.internal)==null?void 0:n.throwOnFailedPublish;try{if(i?.transportType===oe.link_mode)return setTimeout(()=>{(this.relayer.connected||this.relayer.connecting)&&this.relayer.request(a).catch(u=>this.logger.warn(u))},(0,$.toMiliseconds)($.ONE_SECOND)),o;let l=new Promise(async u=>{let p=d=>{d.topic===e&&(this.events.removeListener(Ye.created,p),u(d.id))};this.events.on(Ye.created,p);try{let d=await gt(new Promise((f,g)=>{this.relayer.request(a).catch(y=>{this.logger.warn(y,y?.message),g(y)}).then(f)}),this.initialSubscribeTimeout,`Subscribing to ${e} failed, please try again`);this.events.removeListener(Ye.created,p),u(d)}catch{}}),h=await gt(l,this.subscribeTimeout,`Subscribing to ${e} failed, please try again`);if(!h&&c)throw new Error(`Subscribing to ${e} failed, please try again`);return h?o:null}catch(l){if(this.logger.debug("Outgoing Relay Subscribe Payload stalled"),this.relayer.events.emit(pe.connection_stalled),c)throw l}return null}async rpcBatchSubscribe(e){if(!e.length)return;let s=e[0].relay,i={method:Es(s.protocol).batchSubscribe,params:{topics:e.map(r=>r.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:i});try{await await gt(new Promise(r=>{this.relayer.request(i).catch(n=>this.logger.warn(n)).then(r)}),this.subscribeTimeout,"rpcBatchSubscribe failed, please try again")}catch{this.relayer.events.emit(pe.connection_stalled)}}async rpcBatchFetchMessages(e){if(!e.length)return;let s=e[0].relay,i={method:Es(s.protocol).batchFetchMessages,params:{topics:e.map(n=>n.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:i});let r;try{r=await await gt(new Promise((n,o)=>{this.relayer.request(i).catch(a=>{this.logger.warn(a),o(a)}).then(n)}),this.subscribeTimeout,"rpcBatchFetchMessages failed, please try again")}catch{this.relayer.events.emit(pe.connection_stalled)}return r}rpcUnsubscribe(e,s,i){let r={method:Es(i.protocol).unsubscribe,params:{topic:e,id:s}};return this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:r}),this.relayer.request(r)}onSubscribe(e,s){this.setSubscription(e,co(Oi({},s),{id:e})),this.pending.delete(s.topic)}onBatchSubscribe(e){e.length&&e.forEach(s=>{this.setSubscription(s.id,Oi({},s)),this.pending.delete(s.topic)})}async onUnsubscribe(e,s,i){this.events.removeAllListeners(s),this.hasSubscription(s,e)&&this.deleteSubscription(s,i),await this.relayer.messages.del(e)}async setRelayerSubscriptions(e){await this.relayer.core.storage.setItem(this.storageKey,e)}async getRelayerSubscriptions(){return await this.relayer.core.storage.getItem(this.storageKey)}setSubscription(e,s){this.logger.debug("Setting subscription"),this.logger.trace({type:"method",method:"setSubscription",id:e,subscription:s}),this.addSubscription(e,s)}addSubscription(e,s){this.subscriptions.set(e,Oi({},s)),this.topicMap.set(s.topic,e),this.events.emit(Ye.created,s)}getSubscription(e){this.logger.debug("Getting subscription"),this.logger.trace({type:"method",method:"getSubscription",id:e});let s=this.subscriptions.get(e);if(!s){let{message:i}=A("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(i)}return s}deleteSubscription(e,s){this.logger.debug("Deleting subscription"),this.logger.trace({type:"method",method:"deleteSubscription",id:e,reason:s});let i=this.getSubscription(e);this.subscriptions.delete(e),this.topicMap.delete(i.topic,e),this.events.emit(Ye.deleted,co(Oi({},i),{reason:s}))}async persist(){await this.setRelayerSubscriptions(this.values),this.events.emit(Ye.sync)}async onRestart(){if(this.cached.length){let e=[...this.cached],s=Math.ceil(this.cached.length/this.batchSubscribeTopicsLimit);for(let i=0;i<s;i++){let r=e.splice(0,this.batchSubscribeTopicsLimit);await this.batchSubscribe(r)}}this.events.emit(Ye.resubscribed)}async restore(){try{let e=await this.getRelayerSubscriptions();if(typeof e>"u"||!e.length)return;if(this.subscriptions.size&&!e.every(s=>{var i;return s.topic===((i=this.subscriptions.get(s.id))==null?void 0:i.topic)})){let{message:s}=A("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(s),this.logger.error(`${this.name}: ${JSON.stringify(this.values)}`),new Error(s)}this.cached=e,this.logger.debug(`Successfully Restored subscriptions for ${this.name}`),this.logger.trace({type:"method",method:"restore",subscriptions:this.values})}catch(e){this.logger.debug(`Failed to Restore subscriptions for ${this.name}`),this.logger.error(e)}}async batchSubscribe(e){e.length&&(await this.rpcBatchSubscribe(e),this.onBatchSubscribe(await Promise.all(e.map(async s=>co(Oi({},s),{id:await this.getSubscriptionId(s.topic)})))))}async batchFetchMessages(e){if(!e.length)return;this.logger.trace(`Fetching batch messages for ${e.length} subscriptions`);let s=await this.rpcBatchFetchMessages(e);s&&s.messages&&(await Dc((0,$.toMiliseconds)($.ONE_SECOND)),await this.relayer.handleBatchMessageEvents(s.messages))}async onConnect(){await this.restart(),this.reset()}onDisconnect(){this.onDisable()}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}async restartToComplete(e){!this.relayer.connected&&!this.relayer.connecting&&(this.cached.push(e),await this.relayer.transportOpen())}async getClientId(){return this.clientId||(this.clientId=await this.relayer.core.crypto.getClientId()),this.clientId}async getSubscriptionId(e){return Me(e+await this.getClientId())}},jw=Object.defineProperty,Rh=Object.getOwnPropertySymbols,qw=Object.prototype.hasOwnProperty,kw=Object.prototype.propertyIsEnumerable,xo=(t,e,s)=>e in t?jw(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Th=(t,e)=>{for(var s in e||(e={}))qw.call(e,s)&&xo(t,s,e[s]);if(Rh)for(var s of Rh(e))kw.call(e,s)&&xo(t,s,e[s]);return t},ee=(t,e,s)=>xo(t,typeof e!="symbol"?e+"":e,s),Ao=class extends mr{constructor(e){var s;super(e),ee(this,"protocol","wc"),ee(this,"version",2),ee(this,"core"),ee(this,"logger"),ee(this,"events",new Qe),ee(this,"provider"),ee(this,"messages"),ee(this,"subscriber"),ee(this,"publisher"),ee(this,"name",Iy),ee(this,"transportExplicitlyClosed",!1),ee(this,"initialized",!1),ee(this,"connectionAttemptInProgress",!1),ee(this,"relayUrl"),ee(this,"projectId"),ee(this,"packageName"),ee(this,"bundleId"),ee(this,"hasExperiencedNetworkDisruption",!1),ee(this,"pingTimeout"),ee(this,"heartBeatTimeout",(0,$.toMiliseconds)($.THIRTY_SECONDS+$.FIVE_SECONDS)),ee(this,"reconnectTimeout"),ee(this,"connectPromise"),ee(this,"reconnectInProgress",!1),ee(this,"requestsInFlight",[]),ee(this,"connectTimeout",(0,$.toMiliseconds)($.ONE_SECOND*15)),ee(this,"request",async i=>{var r,n;this.logger.debug("Publishing Request Payload");let o=i.id||Rt().toString();await this.toEstablishConnection();try{this.logger.trace({id:o,method:i.method,topic:(r=i.params)==null?void 0:r.topic},"relayer.request - publishing...");let a=`${o}:${((n=i.params)==null?void 0:n.tag)||""}`;this.requestsInFlight.push(a);let c=await this.provider.request(i);return this.requestsInFlight=this.requestsInFlight.filter(l=>l!==a),c}catch(a){throw this.logger.debug(`Failed to Publish Request: ${o}`),a}}),ee(this,"resetPingTimeout",()=>{di()&&(clearTimeout(this.pingTimeout),this.pingTimeout=setTimeout(()=>{var i,r,n,o;try{this.logger.debug({},"pingTimeout: Connection stalled, terminating..."),(o=(n=(r=(i=this.provider)==null?void 0:i.connection)==null?void 0:r.socket)==null?void 0:n.terminate)==null||o.call(n)}catch(a){this.logger.warn(a,a?.message)}},this.heartBeatTimeout))}),ee(this,"onPayloadHandler",i=>{this.onProviderPayload(i),this.resetPingTimeout()}),ee(this,"onConnectHandler",()=>{this.logger.warn({},"Relayer connected \u{1F6DC}"),this.startPingTimeout(),this.events.emit(pe.connect)}),ee(this,"onDisconnectHandler",()=>{this.logger.warn({},"Relayer disconnected \u{1F6D1}"),this.requestsInFlight=[],this.onProviderDisconnect()}),ee(this,"onProviderErrorHandler",i=>{this.logger.fatal(`Fatal socket error: ${i.message}`),this.events.emit(pe.error,i),this.logger.fatal("Fatal socket error received, closing transport"),this.transportClose()}),ee(this,"registerProviderListeners",()=>{this.provider.on(it.payload,this.onPayloadHandler),this.provider.on(it.connect,this.onConnectHandler),this.provider.on(it.disconnect,this.onDisconnectHandler),this.provider.on(it.error,this.onProviderErrorHandler)}),this.core=e.core,this.logger=Vs({logger:(s=e.logger)!=null?s:_y,name:this.name}),this.messages=new Io(this.logger,e.core),this.subscriber=new To(this,this.logger),this.publisher=new Oo(this,this.logger),this.projectId=e?.projectId,this.relayUrl=e?.relayUrl||Mh,Tc()?this.packageName=An():xc()&&(this.bundleId=An()),this.provider={}}async init(){this.logger.trace("Initialized"),this.registerEventListeners(),await Promise.all([this.messages.init(),this.subscriber.init()]),this.initialized=!0,this.transportOpen().catch(e=>this.logger.warn(e,e?.message))}get context(){return Ie(this.logger)}get connected(){var e,s,i;return((i=(s=(e=this.provider)==null?void 0:e.connection)==null?void 0:s.socket)==null?void 0:i.readyState)===1||!1}get connecting(){var e,s,i;return((i=(s=(e=this.provider)==null?void 0:e.connection)==null?void 0:s.socket)==null?void 0:i.readyState)===0||this.connectPromise!==void 0||!1}async publish(e,s,i){this.isInitialized(),await this.publisher.publish(e,s,i),await this.recordMessageEvent({topic:e,message:s,publishedAt:Date.now(),transportType:oe.relay},Pr.outbound)}async publishCustom(e){this.isInitialized(),await this.publisher.publishCustom(e)}async subscribe(e,s){var i,r,n;this.isInitialized(),(!(s!=null&&s.transportType)||s?.transportType==="relay")&&await this.toEstablishConnection();let o=typeof((i=s?.internal)==null?void 0:i.throwOnFailedPublish)>"u"?!0:(r=s?.internal)==null?void 0:r.throwOnFailedPublish,a=((n=this.subscriber.topicMap.get(e))==null?void 0:n[0])||"",c,l=h=>{h.topic===e&&(this.subscriber.off(Ye.created,l),c())};return await Promise.all([new Promise(h=>{c=h,this.subscriber.on(Ye.created,l)}),new Promise(async(h,u)=>{a=await this.subscriber.subscribe(e,Th({internal:{throwOnFailedPublish:o}},s)).catch(p=>{o&&u(p)})||a,h()})]),a}async unsubscribe(e,s){this.isInitialized(),await this.subscriber.unsubscribe(e,s)}on(e,s){this.events.on(e,s)}once(e,s){this.events.once(e,s)}off(e,s){this.events.off(e,s)}removeListener(e,s){this.events.removeListener(e,s)}async transportDisconnect(){this.provider.disconnect&&(this.hasExperiencedNetworkDisruption||this.connected)?await gt(this.provider.disconnect(),2e3,"provider.disconnect()").catch(()=>this.onProviderDisconnect()):this.onProviderDisconnect()}async transportClose(){this.transportExplicitlyClosed=!0,await this.transportDisconnect()}async transportOpen(e){if(!this.subscriber.hasAnyTopics){this.logger.info("Starting WS connection skipped because the client has no topics to work with.");return}if(this.connectPromise?(this.logger.debug({},"Waiting for existing connection attempt to resolve..."),await this.connectPromise,this.logger.debug({},"Existing connection attempt resolved")):(this.connectPromise=new Promise(async(s,i)=>{await this.connect(e).then(s).catch(i).finally(()=>{this.connectPromise=void 0})}),await this.connectPromise),!this.connected)throw new Error(`Couldn't establish socket connection to the relay server: ${this.relayUrl}`)}async restartTransport(e){this.logger.debug({},"Restarting transport..."),!this.connectionAttemptInProgress&&(this.relayUrl=e||this.relayUrl,await this.confirmOnlineStateOrThrow(),await this.transportClose(),await this.transportOpen())}async confirmOnlineStateOrThrow(){if(!await oo())throw new Error("No internet connection detected. Please restart your network and try again.")}async handleBatchMessageEvents(e){if(e?.length===0){this.logger.trace("Batch message events is empty. Ignoring...");return}let s=e.sort((i,r)=>i.publishedAt-r.publishedAt);this.logger.debug(`Batch of ${s.length} message events sorted`);for(let i of s)try{await this.onMessageEvent(i)}catch(r){this.logger.warn(r,"Error while processing batch message event: "+r?.message)}this.logger.trace(`Batch of ${s.length} message events processed`)}async onLinkMessageEvent(e,s){let{topic:i}=e;if(!s.sessionExists){let r=ce($.FIVE_MINUTES),n={topic:i,expiry:r,relay:{protocol:"irn"},active:!1};await this.core.pairing.pairings.set(i,n)}this.events.emit(pe.message,e),await this.recordMessageEvent(e,Pr.inbound)}async connect(e){await this.confirmOnlineStateOrThrow(),e&&e!==this.relayUrl&&(this.relayUrl=e,await this.transportDisconnect()),this.connectionAttemptInProgress=!0,this.transportExplicitlyClosed=!1;let s=1;for(;s<6;){try{if(this.transportExplicitlyClosed)break;this.logger.debug({},`Connecting to ${this.relayUrl}, attempt: ${s}...`),await this.createProvider(),await new Promise(async(i,r)=>{let n=()=>{r(new Error("Connection interrupted while trying to connect"))};this.provider.once(it.disconnect,n),await gt(new Promise((o,a)=>{this.provider.connect().then(o).catch(a)}),this.connectTimeout,`Socket stalled when trying to connect to ${this.relayUrl}`).catch(o=>{r(o)}).finally(()=>{this.provider.off(it.disconnect,n),clearTimeout(this.reconnectTimeout)}),await new Promise(async(o,a)=>{let c=()=>{r(new Error("Connection interrupted while trying to subscribe"))};this.provider.once(it.disconnect,c),await this.subscriber.start().then(o).catch(a).finally(()=>{this.provider.off(it.disconnect,c)})}),this.hasExperiencedNetworkDisruption=!1,i()})}catch(i){await this.subscriber.stop();let r=i;this.logger.warn({},r.message),this.hasExperiencedNetworkDisruption=!0}finally{this.connectionAttemptInProgress=!1}if(this.connected){this.logger.debug({},`Connected to ${this.relayUrl} successfully on attempt: ${s}`);break}await new Promise(i=>setTimeout(i,(0,$.toMiliseconds)(s*1))),s++}}startPingTimeout(){var e,s,i,r,n;if(di())try{(s=(e=this.provider)==null?void 0:e.connection)!=null&&s.socket&&((n=(r=(i=this.provider)==null?void 0:i.connection)==null?void 0:r.socket)==null||n.on("ping",()=>{this.resetPingTimeout()})),this.resetPingTimeout()}catch(o){this.logger.warn(o,o?.message)}}async createProvider(){this.provider.connection&&this.unregisterProviderListeners();let e=await this.core.crypto.signJWT(this.relayUrl);this.provider=new ii(new ja(Cc({sdkVersion:ho,protocol:this.protocol,version:this.version,relayUrl:this.relayUrl,projectId:this.projectId,auth:e,useOnCloseEvent:!0,bundleId:this.bundleId,packageName:this.packageName}))),this.registerProviderListeners()}async recordMessageEvent(e,s){let{topic:i,message:r}=e;await this.messages.set(i,r,s)}async shouldIgnoreMessageEvent(e){let{topic:s,message:i}=e;if(!i||i.length===0)return this.logger.warn(`Ignoring invalid/empty message: ${i}`),!0;if(!await this.subscriber.isKnownTopic(s))return this.logger.warn(`Ignoring message for unknown topic ${s}`),!0;let r=this.messages.has(s,i);return r&&this.logger.warn(`Ignoring duplicate message: ${i}`),r}async onProviderPayload(e){if(this.logger.debug("Incoming Relay Payload"),this.logger.trace({type:"payload",direction:"incoming",payload:e}),ti(e)){if(!e.method.endsWith(Sy))return;let s=e.params,{topic:i,message:r,publishedAt:n,attestation:o}=s.data,a={topic:i,message:r,publishedAt:n,transportType:oe.relay,attestation:o};this.logger.debug("Emitting Relayer Payload"),this.logger.trace(Th({type:"event",event:s.id},a)),this.events.emit(s.id,a),await this.acknowledgePayload(e),await this.onMessageEvent(a)}else si(e)&&this.events.emit(pe.message_ack,e)}async onMessageEvent(e){await this.shouldIgnoreMessageEvent(e)||(await this.recordMessageEvent(e,Pr.inbound),this.events.emit(pe.message,e))}async acknowledgePayload(e){let s=Ut(e.id,!0);await this.provider.connection.send(s)}unregisterProviderListeners(){this.provider.off(it.payload,this.onPayloadHandler),this.provider.off(it.connect,this.onConnectHandler),this.provider.off(it.disconnect,this.onDisconnectHandler),this.provider.off(it.error,this.onProviderErrorHandler),clearTimeout(this.pingTimeout)}async registerEventListeners(){let e=await oo();hh(async s=>{e!==s&&(e=s,s?await this.transportOpen().catch(i=>this.logger.error(i,i?.message)):(this.hasExperiencedNetworkDisruption=!0,await this.transportDisconnect(),this.transportExplicitlyClosed=!1))}),this.core.heartbeat.on(ps.pulse,async()=>{if(!this.transportExplicitlyClosed&&!this.connected&&uh())try{await this.confirmOnlineStateOrThrow(),await this.transportOpen()}catch(s){this.logger.warn(s,s?.message)}})}async onProviderDisconnect(){clearTimeout(this.pingTimeout),this.events.emit(pe.disconnect),this.connectionAttemptInProgress=!1,!this.reconnectInProgress&&(this.reconnectInProgress=!0,await this.subscriber.stop(),this.subscriber.hasAnyTopics&&(this.transportExplicitlyClosed||(this.reconnectTimeout=setTimeout(async()=>{await this.transportOpen().catch(e=>this.logger.error(e,e?.message)),this.reconnectTimeout=void 0,this.reconnectInProgress=!1},(0,$.toMiliseconds)(Oy)))))}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}async toEstablishConnection(){if(await this.confirmOnlineStateOrThrow(),!this.connected){if(this.connectPromise){await this.connectPromise;return}await this.connect()}}};function Lw(t,e){return t===e||Number.isNaN(t)&&Number.isNaN(e)}function xh(t){return Object.getOwnPropertySymbols(t).filter(e=>Object.prototype.propertyIsEnumerable.call(t,e))}function Ah(t){return t==null?t===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(t)}var Fw="[object RegExp]",Dw="[object String]",Uw="[object Number]",Bw="[object Boolean]",Ch="[object Arguments]",$w="[object Symbol]",Mw="[object Date]",Vw="[object Map]",zw="[object Set]",Kw="[object Array]",Hw="[object Function]",Gw="[object ArrayBuffer]",lo="[object Object]",Ww="[object Error]",Yw="[object DataView]",Jw="[object Uint8Array]",Xw="[object Uint8ClampedArray]",Zw="[object Uint16Array]",Qw="[object Uint32Array]",eb="[object BigUint64Array]",tb="[object Int8Array]",sb="[object Int16Array]",ib="[object Int32Array]",rb="[object BigInt64Array]",nb="[object Float32Array]",ob="[object Float64Array]";function ab(){}function Nh(t){if(!t||typeof t!="object")return!1;let e=Object.getPrototypeOf(t);return e===null||e===Object.prototype||Object.getPrototypeOf(e)===null?Object.prototype.toString.call(t)==="[object Object]":!1}function cb(t,e,s){return Ri(t,e,void 0,void 0,void 0,void 0,s)}function Ri(t,e,s,i,r,n,o){let a=o(t,e,s,i,r,n);if(a!==void 0)return a;if(typeof t==typeof e)switch(typeof t){case"bigint":case"string":case"boolean":case"symbol":case"undefined":return t===e;case"number":return t===e||Object.is(t,e);case"function":return t===e;case"object":return Ti(t,e,n,o)}return Ti(t,e,n,o)}function Ti(t,e,s,i){if(Object.is(t,e))return!0;let r=Ah(t),n=Ah(e);if(r===Ch&&(r=lo),n===Ch&&(n=lo),r!==n)return!1;switch(r){case Dw:return t.toString()===e.toString();case Uw:{let c=t.valueOf(),l=e.valueOf();return Lw(c,l)}case Bw:case Mw:case $w:return Object.is(t.valueOf(),e.valueOf());case Fw:return t.source===e.source&&t.flags===e.flags;case Hw:return t===e}s=s??new Map;let o=s.get(t),a=s.get(e);if(o!=null&&a!=null)return o===e;s.set(t,e),s.set(e,t);try{switch(r){case Vw:{if(t.size!==e.size)return!1;for(let[c,l]of t.entries())if(!e.has(c)||!Ri(l,e.get(c),c,t,e,s,i))return!1;return!0}case zw:{if(t.size!==e.size)return!1;let c=Array.from(t.values()),l=Array.from(e.values());for(let h=0;h<c.length;h++){let u=c[h],p=l.findIndex(d=>Ri(u,d,void 0,t,e,s,i));if(p===-1)return!1;l.splice(p,1)}return!0}case Kw:case Jw:case Xw:case Zw:case Qw:case eb:case tb:case sb:case ib:case rb:case nb:case ob:{if(typeof K<"u"&&K.isBuffer(t)!==K.isBuffer(e)||t.length!==e.length)return!1;for(let c=0;c<t.length;c++)if(!Ri(t[c],e[c],c,t,e,s,i))return!1;return!0}case Gw:return t.byteLength!==e.byteLength?!1:Ti(new Uint8Array(t),new Uint8Array(e),s,i);case Yw:return t.byteLength!==e.byteLength||t.byteOffset!==e.byteOffset?!1:Ti(new Uint8Array(t),new Uint8Array(e),s,i);case Ww:return t.name===e.name&&t.message===e.message;case lo:{if(!(Ti(t.constructor,e.constructor,s,i)||Nh(t)&&Nh(e)))return!1;let c=[...Object.keys(t),...xh(t)],l=[...Object.keys(e),...xh(e)];if(c.length!==l.length)return!1;for(let h=0;h<c.length;h++){let u=c[h],p=t[u];if(!Object.hasOwn(e,u))return!1;let d=e[u];if(!Ri(p,d,u,t,e,s,i))return!1}return!0}default:return!1}}finally{s.delete(t),s.delete(e)}}function lb(t,e){return cb(t,e,ab)}var hb=Object.defineProperty,jh=Object.getOwnPropertySymbols,ub=Object.prototype.hasOwnProperty,pb=Object.prototype.propertyIsEnumerable,Co=(t,e,s)=>e in t?hb(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,qh=(t,e)=>{for(var s in e||(e={}))ub.call(e,s)&&Co(t,s,e[s]);if(jh)for(var s of jh(e))pb.call(e,s)&&Co(t,s,e[s]);return t},Ve=(t,e,s)=>Co(t,typeof e!="symbol"?e+"":e,s),St=class extends wr{constructor(e,s,i,r=It,n=void 0){super(e,s,i,r),this.core=e,this.logger=s,this.name=i,Ve(this,"map",new Map),Ve(this,"version",Py),Ve(this,"cached",[]),Ve(this,"initialized",!1),Ve(this,"getKey"),Ve(this,"storagePrefix",It),Ve(this,"recentlyDeleted",[]),Ve(this,"recentlyDeletedLimit",200),Ve(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(o=>{this.getKey&&o!==null&&!ue(o)?this.map.set(this.getKey(o),o):Jl(o)?this.map.set(o.id,o):Xl(o)&&this.map.set(o.topic,o)}),this.cached=[],this.initialized=!0)}),Ve(this,"set",async(o,a)=>{this.isInitialized(),this.map.has(o)?await this.update(o,a):(this.logger.debug("Setting value"),this.logger.trace({type:"method",method:"set",key:o,value:a}),this.map.set(o,a),await this.persist())}),Ve(this,"get",o=>(this.isInitialized(),this.logger.debug("Getting value"),this.logger.trace({type:"method",method:"get",key:o}),this.getData(o))),Ve(this,"getAll",o=>(this.isInitialized(),o?this.values.filter(a=>Object.keys(o).every(c=>lb(a[c],o[c]))):this.values)),Ve(this,"update",async(o,a)=>{this.isInitialized(),this.logger.debug("Updating value"),this.logger.trace({type:"method",method:"update",key:o,update:a});let c=qh(qh({},this.getData(o)),a);this.map.set(o,c),await this.persist()}),Ve(this,"delete",async(o,a)=>{this.isInitialized(),this.map.has(o)&&(this.logger.debug("Deleting value"),this.logger.trace({type:"method",method:"delete",key:o,reason:a}),this.map.delete(o),this.addToRecentlyDeleted(o),await this.persist())}),this.logger=De(s,this.name),this.storagePrefix=r,this.getKey=n}get context(){return Ie(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.map.size}get keys(){return Array.from(this.map.keys())}get values(){return Array.from(this.map.values())}addToRecentlyDeleted(e){this.recentlyDeleted.push(e),this.recentlyDeleted.length>=this.recentlyDeletedLimit&&this.recentlyDeleted.splice(0,this.recentlyDeletedLimit/2)}async setDataStore(e){await this.core.storage.setItem(this.storageKey,e)}async getDataStore(){return await this.core.storage.getItem(this.storageKey)}getData(e){let s=this.map.get(e);if(!s){if(this.recentlyDeleted.includes(e)){let{message:r}=A("MISSING_OR_INVALID",`Record was recently deleted - ${this.name}: ${e}`);throw this.logger.error(r),new Error(r)}let{message:i}=A("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(i),new Error(i)}return s}async persist(){await this.setDataStore(this.values)}async restore(){try{let e=await this.getDataStore();if(typeof e>"u"||!e.length)return;if(this.map.size){let{message:s}=A("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(s),new Error(s)}this.cached=e,this.logger.debug(`Successfully Restored value for ${this.name}`),this.logger.trace({type:"method",method:"restore",value:this.values})}catch(e){this.logger.debug(`Failed to Restore value for ${this.name}`),this.logger.error(e)}}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}},db=Object.defineProperty,fb=(t,e,s)=>e in t?db(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,X=(t,e,s)=>fb(t,typeof e!="symbol"?e+"":e,s),No=class{constructor(e,s){this.core=e,this.logger=s,X(this,"name",Ay),X(this,"version",Cy),X(this,"events",new hs),X(this,"pairings"),X(this,"initialized",!1),X(this,"storagePrefix",It),X(this,"ignoredPayloadTypes",[yt]),X(this,"registeredMethods",[]),X(this,"init",async()=>{this.initialized||(await this.pairings.init(),await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.initialized=!0,this.logger.trace("Initialized"))}),X(this,"register",({methods:i})=>{this.isInitialized(),this.registeredMethods=[...new Set([...this.registeredMethods,...i])]}),X(this,"create",async i=>{this.isInitialized();let r=ur(),n=await this.core.crypto.setSymKey(r),o=ce($.FIVE_MINUTES),a={protocol:$o},c={topic:n,expiry:o,relay:a,active:!1,methods:i?.methods},l=Qn({protocol:this.core.protocol,version:this.core.version,topic:n,symKey:r,relay:a,expiryTimestamp:o,methods:i?.methods});return this.events.emit(ns.create,c),this.core.expirer.set(n,o),await this.pairings.set(n,c),await this.core.relayer.subscribe(n,{transportType:i?.transportType,internal:i?.internal}),{topic:n,uri:l}}),X(this,"pair",async i=>{this.isInitialized();let r=this.core.eventClient.createEvent({properties:{topic:i?.uri,trace:[wt.pairing_started]}});this.isValidPair(i,r);let{topic:n,symKey:o,relay:a,expiryTimestamp:c,methods:l}=Zn(i.uri);r.props.properties.topic=n,r.addTrace(wt.pairing_uri_validation_success),r.addTrace(wt.pairing_uri_not_expired);let h;if(this.pairings.keys.includes(n)){if(h=this.pairings.get(n),r.addTrace(wt.existing_pairing),h.active)throw r.setError(_t.active_pairing_already_exists),new Error(`Pairing already exists: ${n}. Please try again with a new connection URI.`);r.addTrace(wt.pairing_not_expired)}let u=c||ce($.FIVE_MINUTES),p={topic:n,relay:a,expiry:u,active:!1,methods:l};this.core.expirer.set(n,u),await this.pairings.set(n,p),r.addTrace(wt.store_new_pairing),i.activatePairing&&await this.activate({topic:n}),this.events.emit(ns.create,p),r.addTrace(wt.emit_inactive_pairing),this.core.crypto.keychain.has(n)||await this.core.crypto.setSymKey(o,n),r.addTrace(wt.subscribing_pairing_topic);try{await this.core.relayer.confirmOnlineStateOrThrow()}catch{r.setError(_t.no_internet_connection)}try{await this.core.relayer.subscribe(n,{relay:a})}catch(d){throw r.setError(_t.subscribe_pairing_topic_failure),d}return r.addTrace(wt.subscribe_pairing_topic_success),p}),X(this,"activate",async({topic:i})=>{this.isInitialized();let r=ce($.FIVE_MINUTES);this.core.expirer.set(i,r),await this.pairings.update(i,{active:!0,expiry:r})}),X(this,"ping",async i=>{this.isInitialized(),await this.isValidPing(i),this.logger.warn("ping() is deprecated and will be removed in the next major release.");let{topic:r}=i;if(this.pairings.keys.includes(r)){let n=await this.sendRequest(r,"wc_pairingPing",{}),{done:o,resolve:a,reject:c}=Lt();this.events.once(te("pairing_ping",n),({error:l})=>{l?c(l):a()}),await o()}}),X(this,"updateExpiry",async({topic:i,expiry:r})=>{this.isInitialized(),await this.pairings.update(i,{expiry:r})}),X(this,"updateMetadata",async({topic:i,metadata:r})=>{this.isInitialized(),await this.pairings.update(i,{peerMetadata:r})}),X(this,"getPairings",()=>(this.isInitialized(),this.pairings.values)),X(this,"disconnect",async i=>{this.isInitialized(),await this.isValidDisconnect(i);let{topic:r}=i;this.pairings.keys.includes(r)&&(await this.sendRequest(r,"wc_pairingDelete",ie("USER_DISCONNECTED")),await this.deletePairing(r))}),X(this,"formatUriFromPairing",i=>{this.isInitialized();let{topic:r,relay:n,expiry:o,methods:a}=i,c=this.core.crypto.keychain.get(r);return Qn({protocol:this.core.protocol,version:this.core.version,topic:r,symKey:c,relay:n,expiryTimestamp:o,methods:a})}),X(this,"sendRequest",async(i,r,n)=>{let o=ze(r,n),a=await this.core.crypto.encode(i,o),c=Si[r].req;return this.core.history.set(i,o),this.core.relayer.publish(i,a,c),o.id}),X(this,"sendResult",async(i,r,n)=>{let o=Ut(i,n),a=await this.core.crypto.encode(r,o),c=(await this.core.history.get(r,i)).request.method,l=Si[c].res;await this.core.relayer.publish(r,a,l),await this.core.history.resolve(o)}),X(this,"sendError",async(i,r,n)=>{let o=Ni(i,n),a=await this.core.crypto.encode(r,o),c=(await this.core.history.get(r,i)).request.method,l=Si[c]?Si[c].res:Si.unregistered_method.res;await this.core.relayer.publish(r,a,l),await this.core.history.resolve(o)}),X(this,"deletePairing",async(i,r)=>{await this.core.relayer.unsubscribe(i),await Promise.all([this.pairings.delete(i,ie("USER_DISCONNECTED")),this.core.crypto.deleteSymKey(i),r?Promise.resolve():this.core.expirer.del(i)])}),X(this,"cleanup",async()=>{let i=this.pairings.getAll().filter(r=>Ge(r.expiry));await Promise.all(i.map(r=>this.deletePairing(r.topic)))}),X(this,"onRelayEventRequest",async i=>{let{topic:r,payload:n}=i;switch(n.method){case"wc_pairingPing":return await this.onPairingPingRequest(r,n);case"wc_pairingDelete":return await this.onPairingDeleteRequest(r,n);default:return await this.onUnknownRpcMethodRequest(r,n)}}),X(this,"onRelayEventResponse",async i=>{let{topic:r,payload:n}=i,o=(await this.core.history.get(r,n.id)).request.method;switch(o){case"wc_pairingPing":return this.onPairingPingResponse(r,n);default:return this.onUnknownRpcMethodResponse(o)}}),X(this,"onPairingPingRequest",async(i,r)=>{let{id:n}=r;try{this.isValidPing({topic:i}),await this.sendResult(n,i,!0),this.events.emit(ns.ping,{id:n,topic:i})}catch(o){await this.sendError(n,i,o),this.logger.error(o)}}),X(this,"onPairingPingResponse",(i,r)=>{let{id:n}=r;setTimeout(()=>{at(r)?this.events.emit(te("pairing_ping",n),{}):et(r)&&this.events.emit(te("pairing_ping",n),{error:r.error})},500)}),X(this,"onPairingDeleteRequest",async(i,r)=>{let{id:n}=r;try{this.isValidDisconnect({topic:i}),await this.deletePairing(i),this.events.emit(ns.delete,{id:n,topic:i})}catch(o){await this.sendError(n,i,o),this.logger.error(o)}}),X(this,"onUnknownRpcMethodRequest",async(i,r)=>{let{id:n,method:o}=r;try{if(this.registeredMethods.includes(o))return;let a=ie("WC_METHOD_UNSUPPORTED",o);await this.sendError(n,i,a),this.logger.error(a)}catch(a){await this.sendError(n,i,a),this.logger.error(a)}}),X(this,"onUnknownRpcMethodResponse",i=>{this.registeredMethods.includes(i)||this.logger.error(ie("WC_METHOD_UNSUPPORTED",i))}),X(this,"isValidPair",(i,r)=>{var n;if(!Ae(i)){let{message:a}=A("MISSING_OR_INVALID",`pair() params: ${i}`);throw r.setError(_t.malformed_pairing_uri),new Error(a)}if(!Yl(i.uri)){let{message:a}=A("MISSING_OR_INVALID",`pair() uri: ${i.uri}`);throw r.setError(_t.malformed_pairing_uri),new Error(a)}let o=Zn(i?.uri);if(!((n=o?.relay)!=null&&n.protocol)){let{message:a}=A("MISSING_OR_INVALID","pair() uri#relay-protocol");throw r.setError(_t.malformed_pairing_uri),new Error(a)}if(!(o!=null&&o.symKey)){let{message:a}=A("MISSING_OR_INVALID","pair() uri#symKey");throw r.setError(_t.malformed_pairing_uri),new Error(a)}if(o!=null&&o.expiryTimestamp&&(0,$.toMiliseconds)(o?.expiryTimestamp)<Date.now()){r.setError(_t.pairing_expired);let{message:a}=A("EXPIRED","pair() URI has expired. Please try again with a new connection URI.");throw new Error(a)}}),X(this,"isValidPing",async i=>{if(!Ae(i)){let{message:n}=A("MISSING_OR_INVALID",`ping() params: ${i}`);throw new Error(n)}let{topic:r}=i;await this.isValidPairingTopic(r)}),X(this,"isValidDisconnect",async i=>{if(!Ae(i)){let{message:n}=A("MISSING_OR_INVALID",`disconnect() params: ${i}`);throw new Error(n)}let{topic:r}=i;await this.isValidPairingTopic(r)}),X(this,"isValidPairingTopic",async i=>{if(!le(i,!1)){let{message:r}=A("MISSING_OR_INVALID",`pairing topic should be a string: ${i}`);throw new Error(r)}if(!this.pairings.keys.includes(i)){let{message:r}=A("NO_MATCHING_KEY",`pairing topic doesn't exist: ${i}`);throw new Error(r)}if(Ge(this.pairings.get(i).expiry)){await this.deletePairing(i);let{message:r}=A("EXPIRED",`pairing topic: ${i}`);throw new Error(r)}}),this.core=e,this.logger=De(s,this.name),this.pairings=new St(this.core,this.logger,this.name,this.storagePrefix)}get context(){return Ie(this.logger)}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}registerRelayerEvents(){this.core.relayer.on(pe.message,async e=>{let{topic:s,message:i,transportType:r}=e;if(this.pairings.keys.includes(s)&&r!==oe.link_mode&&!this.ignoredPayloadTypes.includes(this.core.crypto.getPayloadType(i)))try{let n=await this.core.crypto.decode(s,i);ti(n)?(this.core.history.set(s,n),await this.onRelayEventRequest({topic:s,payload:n})):si(n)&&(await this.core.history.resolve(n),await this.onRelayEventResponse({topic:s,payload:n}),this.core.history.delete(s,n.id)),await this.core.relayer.messages.ack(s,i)}catch(n){this.logger.error(n)}})}registerExpirerEvents(){this.core.expirer.on(Je.expired,async e=>{let{topic:s}=tr(e.target);s&&this.pairings.keys.includes(s)&&(await this.deletePairing(s,!0),this.events.emit(ns.expire,{topic:s}))})}},gb=Object.defineProperty,yb=(t,e,s)=>e in t?gb(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,we=(t,e,s)=>yb(t,typeof e!="symbol"?e+"":e,s),jo=class extends fr{constructor(e,s){super(e,s),this.core=e,this.logger=s,we(this,"records",new Map),we(this,"events",new Qe),we(this,"name",Ny),we(this,"version",jy),we(this,"cached",[]),we(this,"initialized",!1),we(this,"storagePrefix",It),we(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(i=>this.records.set(i.id,i)),this.cached=[],this.registerEventListeners(),this.initialized=!0)}),we(this,"set",(i,r,n)=>{if(this.isInitialized(),this.logger.debug("Setting JSON-RPC request history record"),this.logger.trace({type:"method",method:"set",topic:i,request:r,chainId:n}),this.records.has(r.id))return;let o={id:r.id,topic:i,request:{method:r.method,params:r.params||null},chainId:n,expiry:ce($.THIRTY_DAYS)};this.records.set(o.id,o),this.persist(),this.events.emit(mt.created,o)}),we(this,"resolve",async i=>{if(this.isInitialized(),this.logger.debug("Updating JSON-RPC response history record"),this.logger.trace({type:"method",method:"update",response:i}),!this.records.has(i.id))return;let r=await this.getRecord(i.id);typeof r.response>"u"&&(r.response=et(i)?{error:i.error}:{result:i.result},this.records.set(r.id,r),this.persist(),this.events.emit(mt.updated,r))}),we(this,"get",async(i,r)=>(this.isInitialized(),this.logger.debug("Getting record"),this.logger.trace({type:"method",method:"get",topic:i,id:r}),await this.getRecord(r))),we(this,"delete",(i,r)=>{this.isInitialized(),this.logger.debug("Deleting record"),this.logger.trace({type:"method",method:"delete",id:r}),this.values.forEach(n=>{if(n.topic===i){if(typeof r<"u"&&n.id!==r)return;this.records.delete(n.id),this.events.emit(mt.deleted,n)}}),this.persist()}),we(this,"exists",async(i,r)=>(this.isInitialized(),this.records.has(r)?(await this.getRecord(r)).topic===i:!1)),we(this,"on",(i,r)=>{this.events.on(i,r)}),we(this,"once",(i,r)=>{this.events.once(i,r)}),we(this,"off",(i,r)=>{this.events.off(i,r)}),we(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),this.logger=De(s,this.name)}get context(){return Ie(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get size(){return this.records.size}get keys(){return Array.from(this.records.keys())}get values(){return Array.from(this.records.values())}get pending(){let e=[];return this.values.forEach(s=>{if(typeof s.response<"u")return;let i={topic:s.topic,request:ze(s.request.method,s.request.params,s.id),chainId:s.chainId};return e.push(i)}),e}async setJsonRpcRecords(e){await this.core.storage.setItem(this.storageKey,e)}async getJsonRpcRecords(){return await this.core.storage.getItem(this.storageKey)}getRecord(e){this.isInitialized();let s=this.records.get(e);if(!s){let{message:i}=A("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(i)}return s}async persist(){await this.setJsonRpcRecords(this.values),this.events.emit(mt.sync)}async restore(){try{let e=await this.getJsonRpcRecords();if(typeof e>"u"||!e.length)return;if(this.records.size){let{message:s}=A("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(s),new Error(s)}this.cached=e,this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",records:this.values})}catch(e){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(e)}}registerEventListeners(){this.events.on(mt.created,e=>{let s=mt.created;this.logger.info(`Emitting ${s}`),this.logger.debug({type:"event",event:s,record:e})}),this.events.on(mt.updated,e=>{let s=mt.updated;this.logger.info(`Emitting ${s}`),this.logger.debug({type:"event",event:s,record:e})}),this.events.on(mt.deleted,e=>{let s=mt.deleted;this.logger.info(`Emitting ${s}`),this.logger.debug({type:"event",event:s,record:e})}),this.core.heartbeat.on(ps.pulse,()=>{this.cleanup()})}cleanup(){try{this.isInitialized();let e=!1;this.records.forEach(s=>{(0,$.toMiliseconds)(s.expiry||0)-Date.now()<=0&&(this.logger.info(`Deleting expired history log: ${s.id}`),this.records.delete(s.id),this.events.emit(mt.deleted,s,!1),e=!0)}),e&&this.persist()}catch(e){this.logger.warn(e)}}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}},mb=Object.defineProperty,wb=(t,e,s)=>e in t?mb(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Ce=(t,e,s)=>wb(t,typeof e!="symbol"?e+"":e,s),qo=class extends vr{constructor(e,s){super(e,s),this.core=e,this.logger=s,Ce(this,"expirations",new Map),Ce(this,"events",new Qe),Ce(this,"name",qy),Ce(this,"version",ky),Ce(this,"cached",[]),Ce(this,"initialized",!1),Ce(this,"storagePrefix",It),Ce(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(i=>this.expirations.set(i.target,i)),this.cached=[],this.registerEventListeners(),this.initialized=!0)}),Ce(this,"has",i=>{try{let r=this.formatTarget(i);return typeof this.getExpiration(r)<"u"}catch{return!1}}),Ce(this,"set",(i,r)=>{this.isInitialized();let n=this.formatTarget(i),o={target:n,expiry:r};this.expirations.set(n,o),this.checkExpiry(n,o),this.events.emit(Je.created,{target:n,expiration:o})}),Ce(this,"get",i=>{this.isInitialized();let r=this.formatTarget(i);return this.getExpiration(r)}),Ce(this,"del",i=>{if(this.isInitialized(),this.has(i)){let r=this.formatTarget(i),n=this.getExpiration(r);this.expirations.delete(r),this.events.emit(Je.deleted,{target:r,expiration:n})}}),Ce(this,"on",(i,r)=>{this.events.on(i,r)}),Ce(this,"once",(i,r)=>{this.events.once(i,r)}),Ce(this,"off",(i,r)=>{this.events.off(i,r)}),Ce(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),this.logger=De(s,this.name)}get context(){return Ie(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.expirations.size}get keys(){return Array.from(this.expirations.keys())}get values(){return Array.from(this.expirations.values())}formatTarget(e){if(typeof e=="string")return jc(e);if(typeof e=="number")return qc(e);let{message:s}=A("UNKNOWN_TYPE",`Target type: ${typeof e}`);throw new Error(s)}async setExpirations(e){await this.core.storage.setItem(this.storageKey,e)}async getExpirations(){return await this.core.storage.getItem(this.storageKey)}async persist(){await this.setExpirations(this.values),this.events.emit(Je.sync)}async restore(){try{let e=await this.getExpirations();if(typeof e>"u"||!e.length)return;if(this.expirations.size){let{message:s}=A("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(s),new Error(s)}this.cached=e,this.logger.debug(`Successfully Restored expirations for ${this.name}`),this.logger.trace({type:"method",method:"restore",expirations:this.values})}catch(e){this.logger.debug(`Failed to Restore expirations for ${this.name}`),this.logger.error(e)}}getExpiration(e){let s=this.expirations.get(e);if(!s){let{message:i}=A("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.warn(i),new Error(i)}return s}checkExpiry(e,s){let{expiry:i}=s;(0,$.toMiliseconds)(i)-Date.now()<=0&&this.expire(e,s)}expire(e,s){this.expirations.delete(e),this.events.emit(Je.expired,{target:e,expiration:s})}checkExpirations(){this.core.relayer.connected&&this.expirations.forEach((e,s)=>this.checkExpiry(s,e))}registerEventListeners(){this.core.heartbeat.on(ps.pulse,()=>this.checkExpirations()),this.events.on(Je.created,e=>{let s=Je.created;this.logger.info(`Emitting ${s}`),this.logger.debug({type:"event",event:s,data:e}),this.persist()}),this.events.on(Je.expired,e=>{let s=Je.expired;this.logger.info(`Emitting ${s}`),this.logger.debug({type:"event",event:s,data:e}),this.persist()}),this.events.on(Je.deleted,e=>{let s=Je.deleted;this.logger.info(`Emitting ${s}`),this.logger.debug({type:"event",event:s,data:e}),this.persist()})}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}},bb=Object.defineProperty,vb=(t,e,s)=>e in t?bb(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,de=(t,e,s)=>vb(t,typeof e!="symbol"?e+"":e,s),ko=class extends Er{constructor(e,s,i){super(e,s,i),this.core=e,this.logger=s,this.store=i,de(this,"name",Ly),de(this,"abortController"),de(this,"isDevEnv"),de(this,"verifyUrlV3",Dy),de(this,"storagePrefix",It),de(this,"version",$h),de(this,"publicKey"),de(this,"fetchPromise"),de(this,"init",async()=>{var r;this.isDevEnv||(this.publicKey=await this.store.getItem(this.storeKey),this.publicKey&&(0,$.toMiliseconds)((r=this.publicKey)==null?void 0:r.expiresAt)<Date.now()&&(this.logger.debug("verify v2 public key expired"),await this.removePublicKey()))}),de(this,"register",async r=>{if(!bs()||this.isDevEnv)return;let n=window.location.origin,{id:o,decryptedId:a}=r,c=`${this.verifyUrlV3}/attestation?projectId=${this.core.projectId}&origin=${n}&id=${o}&decryptedId=${a}`;try{let l=(0,Uh.getDocument)(),h=this.startAbortTimer($.ONE_SECOND*5),u=await new Promise((p,d)=>{let f=()=>{window.removeEventListener("message",y),l.body.removeChild(g),d("attestation aborted")};this.abortController.signal.addEventListener("abort",f);let g=l.createElement("iframe");g.src=c,g.style.display="none",g.addEventListener("error",f,{signal:this.abortController.signal});let y=P=>{if(P.data&&typeof P.data=="string")try{let x=JSON.parse(P.data);if(x.type==="verify_attestation"){if(ei(x.attestation).payload.id!==o)return;clearInterval(h),l.body.removeChild(g),this.abortController.signal.removeEventListener("abort",f),window.removeEventListener("message",y),p(x.attestation===null?"":x.attestation)}}catch(x){this.logger.warn(x)}};l.body.appendChild(g),window.addEventListener("message",y,{signal:this.abortController.signal})});return this.logger.debug(u,"jwt attestation"),u}catch(l){this.logger.warn(l)}return""}),de(this,"resolve",async r=>{if(this.isDevEnv)return"";let{attestationId:n,hash:o,encryptedId:a}=r;if(n===""){this.logger.debug("resolve: attestationId is empty, skipping");return}if(n){if(ei(n).payload.id!==a)return;let l=await this.isValidJwtAttestation(n);if(l){if(!l.isVerified){this.logger.warn("resolve: jwt attestation: origin url not verified");return}return l}}if(!o)return;let c=this.getVerifyUrl(r?.verifyUrl);return this.fetchAttestation(o,c)}),de(this,"fetchAttestation",async(r,n)=>{this.logger.debug(`resolving attestation: ${r} from url: ${n}`);let o=this.startAbortTimer($.ONE_SECOND*5),a=await fetch(`${n}/attestation/${r}?v2Supported=true`,{signal:this.abortController.signal});return clearTimeout(o),a.status===200?await a.json():void 0}),de(this,"getVerifyUrl",r=>{let n=r||Hs;return Uy.includes(n)||(this.logger.info(`verify url: ${n}, not included in trusted list, assigning default: ${Hs}`),n=Hs),n}),de(this,"fetchPublicKey",async()=>{try{this.logger.debug(`fetching public key from: ${this.verifyUrlV3}`);let r=this.startAbortTimer($.FIVE_SECONDS),n=await fetch(`${this.verifyUrlV3}/public-key`,{signal:this.abortController.signal});return clearTimeout(r),await n.json()}catch(r){this.logger.warn(r)}}),de(this,"persistPublicKey",async r=>{this.logger.debug(r,"persisting public key to local storage"),await this.store.setItem(this.storeKey,r),this.publicKey=r}),de(this,"removePublicKey",async()=>{this.logger.debug("removing verify v2 public key from storage"),await this.store.removeItem(this.storeKey),this.publicKey=void 0}),de(this,"isValidJwtAttestation",async r=>{let n=await this.getPublicKey();try{if(n)return this.validateAttestation(r,n)}catch(a){this.logger.error(a),this.logger.warn("error validating attestation")}let o=await this.fetchAndPersistPublicKey();try{if(o)return this.validateAttestation(r,o)}catch(a){this.logger.error(a),this.logger.warn("error validating attestation")}}),de(this,"getPublicKey",async()=>this.publicKey?this.publicKey:await this.fetchAndPersistPublicKey()),de(this,"fetchAndPersistPublicKey",async()=>{if(this.fetchPromise)return await this.fetchPromise,this.publicKey;this.fetchPromise=new Promise(async n=>{let o=await this.fetchPublicKey();o&&(await this.persistPublicKey(o),n(o))});let r=await this.fetchPromise;return this.fetchPromise=void 0,r}),de(this,"validateAttestation",(r,n)=>{let o=zl(r,n.publicKey),a={hasExpired:(0,$.toMiliseconds)(o.exp)<Date.now(),payload:o};if(a.hasExpired)throw this.logger.warn("resolve: jwt attestation expired"),new Error("JWT attestation expired");return{origin:a.payload.origin,isScam:a.payload.isScam,isVerified:a.payload.isVerified}}),this.logger=De(s,this.name),this.abortController=new AbortController,this.isDevEnv=gi(),this.init()}get storeKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//verify:public:key"}get context(){return Ie(this.logger)}startAbortTimer(e){return this.abortController=new AbortController,setTimeout(()=>this.abortController.abort(),(0,$.toMiliseconds)(e))}},Eb=Object.defineProperty,_b=(t,e,s)=>e in t?Eb(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,kh=(t,e,s)=>_b(t,typeof e!="symbol"?e+"":e,s),Lo=class extends _r{constructor(e,s){super(e,s),this.projectId=e,this.logger=s,kh(this,"context",By),kh(this,"registerDeviceToken",async i=>{let{clientId:r,token:n,notificationType:o,enableEncrypted:a=!1}=i,c=`${$y}/${this.projectId}/clients`;await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:r,type:o,token:n,always_raw:a})})}),this.logger=De(s,this.context)}},Ib=Object.defineProperty,Lh=Object.getOwnPropertySymbols,Sb=Object.prototype.hasOwnProperty,Ob=Object.prototype.propertyIsEnumerable,Fo=(t,e,s)=>e in t?Ib(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Pi=(t,e)=>{for(var s in e||(e={}))Sb.call(e,s)&&Fo(t,s,e[s]);if(Lh)for(var s of Lh(e))Ob.call(e,s)&&Fo(t,s,e[s]);return t},ye=(t,e,s)=>Fo(t,typeof e!="symbol"?e+"":e,s),Do=class extends Ir{constructor(e,s,i=!0){super(e,s,i),this.core=e,this.logger=s,ye(this,"context",Vy),ye(this,"storagePrefix",It),ye(this,"storageVersion",My),ye(this,"events",new Map),ye(this,"shouldPersist",!1),ye(this,"init",async()=>{if(!gi())try{let r={eventId:qn(),timestamp:Date.now(),domain:this.getAppDomain(),props:{event:"INIT",type:"",properties:{client_id:await this.core.crypto.getClientId(),user_agent:Nn(this.core.relayer.protocol,this.core.relayer.version,ho)}}};await this.sendEvent([r])}catch(r){this.logger.warn(r)}}),ye(this,"createEvent",r=>{let{event:n="ERROR",type:o="",properties:{topic:a,trace:c}}=r,l=qn(),h=this.core.projectId||"",u=Date.now(),p=Pi({eventId:l,timestamp:u,props:{event:n,type:o,properties:{topic:a,trace:c}},bundleId:h,domain:this.getAppDomain()},this.setMethods(l));return this.telemetryEnabled&&(this.events.set(l,p),this.shouldPersist=!0),p}),ye(this,"getEvent",r=>{let{eventId:n,topic:o}=r;if(n)return this.events.get(n);let a=Array.from(this.events.values()).find(c=>c.props.properties.topic===o);if(a)return Pi(Pi({},a),this.setMethods(a.eventId))}),ye(this,"deleteEvent",r=>{let{eventId:n}=r;this.events.delete(n),this.shouldPersist=!0}),ye(this,"setEventListeners",()=>{this.core.heartbeat.on(ps.pulse,async()=>{this.shouldPersist&&await this.persist(),this.events.forEach(r=>{(0,$.fromMiliseconds)(Date.now())-(0,$.fromMiliseconds)(r.timestamp)>zy&&(this.events.delete(r.eventId),this.shouldPersist=!0)})})}),ye(this,"setMethods",r=>({addTrace:n=>this.addTrace(r,n),setError:n=>this.setError(r,n)})),ye(this,"addTrace",(r,n)=>{let o=this.events.get(r);o&&(o.props.properties.trace.push(n),this.events.set(r,o),this.shouldPersist=!0)}),ye(this,"setError",(r,n)=>{let o=this.events.get(r);o&&(o.props.type=n,o.timestamp=Date.now(),this.events.set(r,o),this.shouldPersist=!0)}),ye(this,"persist",async()=>{await this.core.storage.setItem(this.storageKey,Array.from(this.events.values())),this.shouldPersist=!1}),ye(this,"restore",async()=>{try{let r=await this.core.storage.getItem(this.storageKey)||[];if(!r.length)return;r.forEach(n=>{this.events.set(n.eventId,Pi(Pi({},n),this.setMethods(n.eventId)))})}catch(r){this.logger.warn(r)}}),ye(this,"submit",async()=>{if(!this.telemetryEnabled||this.events.size===0)return;let r=[];for(let[n,o]of this.events)o.props.type&&r.push(o);if(r.length!==0)try{if((await this.sendEvent(r)).ok)for(let n of r)this.events.delete(n.eventId),this.shouldPersist=!0}catch(n){this.logger.warn(n)}}),ye(this,"sendEvent",async r=>{let n=this.getAppDomain()?"":"&sp=desktop";return await fetch(`${Ky}?projectId=${this.core.projectId}&st=events_sdk&sv=js-${ho}${n}`,{method:"POST",body:JSON.stringify(r)})}),ye(this,"getAppDomain",()=>Cn().url),this.logger=De(s,this.context),this.telemetryEnabled=i,i?this.restore().then(async()=>{await this.submit(),this.setEventListeners()}):this.persist()}get storageKey(){return this.storagePrefix+this.storageVersion+this.core.customStoragePrefix+"//"+this.context}},Pb=Object.defineProperty,Fh=Object.getOwnPropertySymbols,Rb=Object.prototype.hasOwnProperty,Tb=Object.prototype.propertyIsEnumerable,Uo=(t,e,s)=>e in t?Pb(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Dh=(t,e)=>{for(var s in e||(e={}))Rb.call(e,s)&&Uo(t,s,e[s]);if(Fh)for(var s of Fh(e))Tb.call(e,s)&&Uo(t,s,e[s]);return t},ne=(t,e,s)=>Uo(t,typeof e!="symbol"?e+"":e,s),Bo=class t extends dr{constructor(e){var s;super(e),ne(this,"protocol",Bh),ne(this,"version",$h),ne(this,"name",Rr),ne(this,"relayUrl"),ne(this,"projectId"),ne(this,"customStoragePrefix"),ne(this,"events",new Qe),ne(this,"logger"),ne(this,"heartbeat"),ne(this,"relayer"),ne(this,"crypto"),ne(this,"storage"),ne(this,"history"),ne(this,"expirer"),ne(this,"pairing"),ne(this,"verify"),ne(this,"echoClient"),ne(this,"linkModeSupportedApps"),ne(this,"eventClient"),ne(this,"initialized",!1),ne(this,"logChunkController"),ne(this,"on",(a,c)=>this.events.on(a,c)),ne(this,"once",(a,c)=>this.events.once(a,c)),ne(this,"off",(a,c)=>this.events.off(a,c)),ne(this,"removeListener",(a,c)=>this.events.removeListener(a,c)),ne(this,"dispatchEnvelope",({topic:a,message:c,sessionExists:l})=>{if(!a||!c)return;let h={topic:a,message:c,publishedAt:Date.now(),transportType:oe.link_mode};this.relayer.onLinkMessageEvent(h,{sessionExists:l})});let i=this.getGlobalCore(e?.customStoragePrefix);if(i)try{return this.customStoragePrefix=i.customStoragePrefix,this.logger=i.logger,this.heartbeat=i.heartbeat,this.crypto=i.crypto,this.history=i.history,this.expirer=i.expirer,this.storage=i.storage,this.relayer=i.relayer,this.pairing=i.pairing,this.verify=i.verify,this.echoClient=i.echoClient,this.linkModeSupportedApps=i.linkModeSupportedApps,this.eventClient=i.eventClient,this.initialized=i.initialized,this.logChunkController=i.logChunkController,i}catch(a){console.warn("Failed to copy global core",a)}this.projectId=e?.projectId,this.relayUrl=e?.relayUrl||Mh,this.customStoragePrefix=e!=null&&e.customStoragePrefix?`:${e.customStoragePrefix}`:"";let r=za({level:typeof e?.logger=="string"&&e.logger?e.logger:py.logger,name:Rr}),{logger:n,chunkLoggerController:o}=Ui({opts:r,maxSizeInBytes:e?.maxLogBlobSizeInBytes,loggerOverride:e?.logger});this.logChunkController=o,(s=this.logChunkController)!=null&&s.downloadLogsBlobInBrowser&&(window.downloadLogsBlobInBrowser=async()=>{var a,c;(a=this.logChunkController)!=null&&a.downloadLogsBlobInBrowser&&((c=this.logChunkController)==null||c.downloadLogsBlobInBrowser({clientId:await this.crypto.getClientId()}))}),this.logger=De(n,this.name),this.heartbeat=new _a,this.crypto=new Eo(this,this.logger,e?.keychain),this.history=new jo(this,this.logger),this.expirer=new qo(this,this.logger),this.storage=e!=null&&e.storage?e.storage:new Sa(Dh(Dh({},dy),e?.storageOptions)),this.relayer=new Ao({core:this,logger:this.logger,relayUrl:this.relayUrl,projectId:this.projectId}),this.pairing=new No(this,this.logger),this.verify=new ko(this,this.logger,this.storage),this.echoClient=new Lo(this.projectId||"",this.logger),this.linkModeSupportedApps=[],this.eventClient=new Do(this,this.logger,e?.telemetryEnabled),this.setGlobalCore(this)}static async init(e){let s=new t(e);await s.initialize();let i=await s.crypto.getClientId();return await s.storage.setItem(Ry,i),s}get context(){return Ie(this.logger)}async start(){this.initialized||await this.initialize()}async getLogsBlob(){var e;return(e=this.logChunkController)==null?void 0:e.logsToBlob({clientId:await this.crypto.getClientId()})}async addLinkModeSupportedApp(e){this.linkModeSupportedApps.includes(e)||(this.linkModeSupportedApps.push(e),await this.storage.setItem(yh,this.linkModeSupportedApps))}async initialize(){this.logger.trace("Initialized");try{await this.crypto.init(),await this.history.init(),await this.expirer.init(),await this.relayer.init(),await this.heartbeat.init(),await this.pairing.init(),this.linkModeSupportedApps=await this.storage.getItem(yh)||[],this.initialized=!0,this.logger.info("Core Initialization Success")}catch(e){throw this.logger.warn(e,`Core Initialization Failure at epoch ${Date.now()}`),this.logger.error(e.message),e}}getGlobalCore(e=""){try{if(this.isGlobalCoreDisabled())return;let s=`_walletConnectCore_${e}`,i=`${s}_count`;return globalThis[i]=(globalThis[i]||0)+1,globalThis[i]>1&&console.warn(`WalletConnect Core is already initialized. This is probably a mistake and can lead to unexpected behavior. Init() was called ${globalThis[i]} times.`),globalThis[s]}catch(s){console.warn("Failed to get global WalletConnect core",s);return}}setGlobalCore(e){var s;try{if(this.isGlobalCoreDisabled())return;let i=`_walletConnectCore_${((s=e.opts)==null?void 0:s.customStoragePrefix)||""}`;globalThis[i]=e}catch(i){console.warn("Failed to set global WalletConnect core",i)}}isGlobalCoreDisabled(){try{return typeof ke<"u"&&ke.env.DISABLE_GLOBAL_CORE==="true"}catch{return!0}}},tu=Bo;var H=ls(Fr(),1);var nu="wc",ou=2,au="client",ta=`${nu}@${ou}:${au}:`,Mo={name:au,logger:"error",controller:!1,relayUrl:"wss://relay.walletconnect.org"};var su="WALLETCONNECT_DEEPLINK_CHOICE";var xb="proposal";var iu="Proposal expired",Ab="session",Ws=H.SEVEN_DAYS,Cb="engine",ve={wc_sessionPropose:{req:{ttl:H.FIVE_MINUTES,prompt:!0,tag:1100},res:{ttl:H.FIVE_MINUTES,prompt:!1,tag:1101},reject:{ttl:H.FIVE_MINUTES,prompt:!1,tag:1120},autoReject:{ttl:H.FIVE_MINUTES,prompt:!1,tag:1121}},wc_sessionSettle:{req:{ttl:H.FIVE_MINUTES,prompt:!1,tag:1102},res:{ttl:H.FIVE_MINUTES,prompt:!1,tag:1103}},wc_sessionUpdate:{req:{ttl:H.ONE_DAY,prompt:!1,tag:1104},res:{ttl:H.ONE_DAY,prompt:!1,tag:1105}},wc_sessionExtend:{req:{ttl:H.ONE_DAY,prompt:!1,tag:1106},res:{ttl:H.ONE_DAY,prompt:!1,tag:1107}},wc_sessionRequest:{req:{ttl:H.FIVE_MINUTES,prompt:!0,tag:1108},res:{ttl:H.FIVE_MINUTES,prompt:!1,tag:1109}},wc_sessionEvent:{req:{ttl:H.FIVE_MINUTES,prompt:!0,tag:1110},res:{ttl:H.FIVE_MINUTES,prompt:!1,tag:1111}},wc_sessionDelete:{req:{ttl:H.ONE_DAY,prompt:!1,tag:1112},res:{ttl:H.ONE_DAY,prompt:!1,tag:1113}},wc_sessionPing:{req:{ttl:H.ONE_DAY,prompt:!1,tag:1114},res:{ttl:H.ONE_DAY,prompt:!1,tag:1115}},wc_sessionAuthenticate:{req:{ttl:H.ONE_HOUR,prompt:!0,tag:1116},res:{ttl:H.ONE_HOUR,prompt:!1,tag:1117},reject:{ttl:H.FIVE_MINUTES,prompt:!1,tag:1118},autoReject:{ttl:H.FIVE_MINUTES,prompt:!1,tag:1119}}},Vo={min:H.FIVE_MINUTES,max:H.SEVEN_DAYS},Ot={idle:"IDLE",active:"ACTIVE"},Nb={eth_sendTransaction:{key:""},eth_sendRawTransaction:{key:""},wallet_sendCalls:{key:""},solana_signTransaction:{key:"signature"},solana_signAllTransactions:{key:"transactions"},solana_signAndSendTransaction:{key:"signature"},sui_signAndExecuteTransaction:{key:"digest"},sui_signTransaction:{key:""},hedera_signAndExecuteTransaction:{key:"transactionId"},hedera_executeTransaction:{key:"transactionId"},near_signTransaction:{key:""},near_signTransactions:{key:""},tron_signTransaction:{key:"txID"},xrpl_signTransaction:{key:""},xrpl_signTransactionFor:{key:""},algo_signTxn:{key:""},sendTransfer:{key:"txid"},stacks_stxTransfer:{key:"txId"},polkadot_signTransaction:{key:""},cosmos_signDirect:{key:""}},jb="request",qb=["wc_sessionPropose","wc_sessionRequest","wc_authRequest","wc_sessionAuthenticate"],kb="wc";var Lb="auth",Fb="authKeys",Db="pairingTopics",Ub="requests",Ar=`${kb}@${1.5}:${Lb}:`,xr=`${Ar}:PUB_KEY`,Bb=Object.defineProperty,$b=Object.defineProperties,Mb=Object.getOwnPropertyDescriptors,ru=Object.getOwnPropertySymbols,Vb=Object.prototype.hasOwnProperty,zb=Object.prototype.propertyIsEnumerable,Ko=(t,e,s)=>e in t?Bb(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,se=(t,e)=>{for(var s in e||(e={}))Vb.call(e,s)&&Ko(t,s,e[s]);if(ru)for(var s of ru(e))zb.call(e,s)&&Ko(t,s,e[s]);return t},Ee=(t,e)=>$b(t,Mb(e)),I=(t,e,s)=>Ko(t,typeof e!="symbol"?e+"":e,s),Ho=class extends Or{constructor(e){super(e),I(this,"name",Cb),I(this,"events",new hs),I(this,"initialized",!1),I(this,"requestQueue",{state:Ot.idle,queue:[]}),I(this,"sessionRequestQueue",{state:Ot.idle,queue:[]}),I(this,"emittedSessionRequests",new Ki({limit:500})),I(this,"requestQueueDelay",H.ONE_SECOND),I(this,"expectedPairingMethodMap",new Map),I(this,"recentlyDeletedMap",new Map),I(this,"recentlyDeletedLimit",200),I(this,"relayMessageCache",[]),I(this,"pendingSessions",new Map),I(this,"init",async()=>{this.initialized||(await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.registerPairingEvents(),await this.registerLinkModeListeners(),this.client.core.pairing.register({methods:Object.keys(ve)}),this.initialized=!0,setTimeout(async()=>{await this.processPendingMessageEvents(),this.sessionRequestQueue.queue=this.getPendingSessionRequests(),this.processSessionRequestQueue()},(0,H.toMiliseconds)(this.requestQueueDelay)))}),I(this,"connect",async s=>{var i;this.isInitialized(),await this.confirmOnlineStateOrThrow();let r=Ee(se({},s),{requiredNamespaces:s.requiredNamespaces||{},optionalNamespaces:s.optionalNamespaces||{}});await this.isValidConnect(r),r.optionalNamespaces=Gl(r.requiredNamespaces,r.optionalNamespaces),r.requiredNamespaces={};let{pairingTopic:n,requiredNamespaces:o,optionalNamespaces:a,sessionProperties:c,scopedProperties:l,relays:h,authentication:u,walletPay:p}=r,d=((i=u?.[0])==null?void 0:i.ttl)||ve.wc_sessionPropose.req.ttl||H.FIVE_MINUTES;this.validateRequestExpiry(d);let f=n,g,y=!1;try{if(f){let _=this.client.core.pairing.pairings.get(f);this.client.logger.warn("connect() with existing pairing topic is deprecated and will be removed in the next major release."),y=_.active}}catch(_){throw this.client.logger.error(`connect() -> pairing.get(${f}) failed`),_}if(!f||!y){let{topic:_,uri:F}=await this.client.core.pairing.create({internal:{skipSubscribe:!0}});f=_,g=F}if(!f){let{message:_}=A("NO_MATCHING_KEY",`connect() pairing topic: ${f}`);throw new Error(_)}let P=await this.client.core.crypto.generateKeyPair(),x=ce(d),S=se(Ee(se(se({requiredNamespaces:o,optionalNamespaces:a,relays:h??[{protocol:$o}],proposer:{publicKey:P,metadata:this.client.metadata},expiryTimestamp:x,pairingTopic:f},c&&{sessionProperties:c}),l&&{scopedProperties:l}),{id:Pt()}),(u||p)&&{requests:{authentication:u?.map(_=>{let{domain:F,chains:M,nonce:R,uri:m,exp:w,nbf:b,type:E,statement:T,requestId:C,resources:v,signatureTypes:O}=_;return{domain:F,chains:M,nonce:R,type:E??"caip122",aud:m,version:"1",iat:new Date().toISOString(),exp:w,nbf:b,statement:T,requestId:C,resources:v,signatureTypes:O}}),walletPay:p}}),q=te("session_connect",S.id),{reject:B,resolve:N,done:D}=Lt(d,iu),U=({id:_})=>{_===S.id&&(this.client.events.off("proposal_expire",U),this.pendingSessions.delete(S.id),this.events.emit(q,{error:{message:iu,code:0}}))};return this.client.events.on("proposal_expire",U),this.events.once(q,({error:_,session:F})=>{this.client.events.off("proposal_expire",U),_?B(_):F&&N(F)}),await this.setProposal(S.id,S),await this.sendProposeSession({proposal:S,publishOpts:{internal:{throwOnFailedPublish:!0},tvf:{correlationId:S.id}}}).catch(_=>{throw this.deleteProposal(S.id),_}),{uri:g,approval:D}}),I(this,"pair",async s=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{return await this.client.core.pairing.pair(s)}catch(i){throw this.client.logger.error("pair() failed"),i}}),I(this,"approve",async s=>{var i,r,n;let o=this.client.core.eventClient.createEvent({properties:{topic:(i=s?.id)==null?void 0:i.toString(),trace:[nt.session_approve_started]}});try{this.isInitialized(),await this.confirmOnlineStateOrThrow()}catch(F){throw o.setError(os.no_internet_connection),F}try{await this.isValidProposalId(s?.id)}catch(F){throw this.client.logger.error(`approve() -> proposal.get(${s?.id}) failed`),o.setError(os.proposal_not_found),F}try{await this.isValidApprove(s)}catch(F){throw this.client.logger.error("approve() -> isValidApprove() failed"),o.setError(os.session_approve_namespace_validation_failure),F}let{id:a,relayProtocol:c,namespaces:l,sessionProperties:h,scopedProperties:u,sessionConfig:p,proposalRequestsResponses:d}=s,f=this.client.proposal.get(a);this.client.core.eventClient.deleteEvent({eventId:o.eventId});let{pairingTopic:g,proposer:y,requiredNamespaces:P,optionalNamespaces:x}=f,S=(r=this.client.core.eventClient)==null?void 0:r.getEvent({topic:g});S||(S=(n=this.client.core.eventClient)==null?void 0:n.createEvent({type:nt.session_approve_started,properties:{topic:g,trace:[nt.session_approve_started,nt.session_namespaces_validation_success]}}));let q=await this.client.core.crypto.generateKeyPair(),B=y.publicKey,N=await this.client.core.crypto.generateSharedKey(q,B),D=Ee(se(se(se({relay:{protocol:c??"irn"},namespaces:l,controller:{publicKey:q,metadata:this.client.metadata},expiry:ce(Ws)},h&&{sessionProperties:h}),u&&{scopedProperties:u}),p&&{sessionConfig:p}),{proposalRequestsResponses:d}),U=oe.relay;S.addTrace(nt.subscribing_session_topic);try{await this.client.core.relayer.subscribe(N,{transportType:U,internal:{skipSubscribe:!0}})}catch(F){throw S.setError(os.subscribe_session_topic_failure),F}S.addTrace(nt.subscribe_session_topic_success);let _=Ee(se({},D),{topic:N,requiredNamespaces:P,optionalNamespaces:x,pairingTopic:g,acknowledged:!1,self:D.controller,peer:{publicKey:y.publicKey,metadata:y.metadata},controller:q,transportType:oe.relay,authentication:d?.authentication,walletPayResult:d?.walletPay});await this.client.session.set(N,_),S.addTrace(nt.store_session);try{await this.sendApproveSession({sessionTopic:N,proposal:f,pairingProposalResponse:{relay:{protocol:c??"irn"},responderPublicKey:q},sessionSettleRequest:D,publishOpts:{internal:{throwOnFailedPublish:!0},tvf:se({correlationId:a},this.getTVFApproveParams(_))}}),S.addTrace(nt.session_approve_publish_success)}catch(F){throw this.client.logger.error(F),this.client.session.delete(N,ie("USER_DISCONNECTED")),await this.client.core.relayer.unsubscribe(N),F}return this.client.core.eventClient.deleteEvent({eventId:S.eventId}),await this.client.core.pairing.updateMetadata({topic:g,metadata:y.metadata}),await this.deleteProposal(a),await this.client.core.pairing.activate({topic:g}),await this.setExpiry(N,ce(Ws)),{topic:N,acknowledged:()=>Promise.resolve(this.client.session.get(N))}}),I(this,"reject",async s=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidReject(s)}catch(o){throw this.client.logger.error("reject() -> isValidReject() failed"),o}let{id:i,reason:r}=s,n;try{n=this.client.proposal.get(i).pairingTopic}catch(o){throw this.client.logger.error(`reject() -> proposal.get(${i}) failed`),o}n&&await this.sendError({id:i,topic:n,error:r,rpcOpts:ve.wc_sessionPropose.reject}),await this.deleteProposal(i)}),I(this,"update",async s=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidUpdate(s)}catch(u){throw this.client.logger.error("update() -> isValidUpdate() failed"),u}let{topic:i,namespaces:r}=s,{done:n,resolve:o,reject:a}=Lt(H.FIVE_MINUTES,"Session update request expired without receiving any acknowledgement"),c=Pt(),l=Rt().toString(),h=this.client.session.get(i).namespaces;return this.events.once(te("session_update",c),({error:u})=>{u?a(u):o()}),await this.client.session.update(i,{namespaces:r}),await this.sendRequest({topic:i,method:"wc_sessionUpdate",params:{namespaces:r},throwOnFailedPublish:!0,clientRpcId:c,relayRpcId:l}).catch(u=>{this.client.logger.error(u),this.client.session.update(i,{namespaces:h}),a(u)}),{acknowledged:n}}),I(this,"extend",async s=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidExtend(s)}catch(c){throw this.client.logger.error("extend() -> isValidExtend() failed"),c}let{topic:i}=s,r=Pt(),{done:n,resolve:o,reject:a}=Lt(H.FIVE_MINUTES,"Session extend request expired without receiving any acknowledgement");return this.events.once(te("session_extend",r),({error:c})=>{c?a(c):o()}),await this.setExpiry(i,ce(Ws)),this.sendRequest({topic:i,method:"wc_sessionExtend",params:{},clientRpcId:r,throwOnFailedPublish:!0}).catch(c=>{a(c)}),{acknowledged:n}}),I(this,"request",async s=>{this.isInitialized();try{await this.isValidRequest(s)}catch(y){throw this.client.logger.error("request() -> isValidRequest() failed"),y}let{chainId:i,request:r,topic:n,expiry:o=ve.wc_sessionRequest.req.ttl}=s,a=this.client.session.get(n);a?.transportType===oe.relay&&await this.confirmOnlineStateOrThrow();let c=Pt(),l=Rt().toString(),{done:h,resolve:u,reject:p}=Lt(o,"Request expired. Please try again.");this.events.once(te("session_request",c),({error:y,result:P})=>{y?p(y):u(P)});let d="wc_sessionRequest",f=this.getAppLinkIfEnabled(a.peer.metadata,a.transportType);if(f)return await this.sendRequest({clientRpcId:c,relayRpcId:l,topic:n,method:d,params:{request:Ee(se({},r),{expiryTimestamp:ce(o)}),chainId:i},expiry:o,throwOnFailedPublish:!0,appLink:f}).catch(y=>p(y)),this.client.events.emit("session_request_sent",{topic:n,request:r,chainId:i,id:c}),await h();let g={request:Ee(se({},r),{expiryTimestamp:ce(o)}),chainId:i};return await Promise.all([new Promise(async y=>{await this.sendRequest({clientRpcId:c,relayRpcId:l,topic:n,method:d,params:g,expiry:o,throwOnFailedPublish:!0,tvf:this.getTVFParams(c,g)}).catch(P=>p(P)),this.client.events.emit("session_request_sent",{topic:n,request:r,chainId:i,id:c}),y()}),new Promise(async y=>{var P;if(!((P=a.sessionConfig)!=null&&P.disableDeepLink)){let x=await Lc(this.client.core.storage,su);await kc({id:c,topic:n,wcDeepLink:x})}y()}),h()]).then(y=>y[2])}),I(this,"respond",async s=>{var i,r;this.isInitialized();let n=this.client.core.eventClient.createEvent({properties:{topic:s?.topic||((r=(i=s?.response)==null?void 0:i.id)==null?void 0:r.toString()),trace:[nt.session_request_response_started]}});try{await this.isValidRespond(s)}catch(u){throw n.addTrace(u?.message),n.setError(os.session_request_response_validation_failure),u}n.addTrace(nt.session_request_response_validation_success);let{topic:o,response:a}=s,{id:c}=a,l=this.client.session.get(o);l.transportType===oe.relay&&await this.confirmOnlineStateOrThrow();let h=this.getAppLinkIfEnabled(l.peer.metadata,l.transportType);try{n.addTrace(nt.session_request_response_publish_started),at(a)?await this.sendResult({id:c,topic:o,result:a.result,throwOnFailedPublish:!0,appLink:h}):et(a)&&await this.sendError({id:c,topic:o,error:a.error,appLink:h}),this.cleanupAfterResponse(s)}catch(u){throw n.addTrace(u?.message),n.setError(os.session_request_response_publish_failure),u}}),I(this,"ping",async s=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidPing(s)}catch(r){throw this.client.logger.error("ping() -> isValidPing() failed"),r}let{topic:i}=s;if(this.client.session.keys.includes(i)){let r=Pt(),n=Rt().toString(),{done:o,resolve:a,reject:c}=Lt(H.FIVE_MINUTES,"Ping request expired without receiving any acknowledgement");this.events.once(te("session_ping",r),({error:l})=>{l?c(l):a()}),await Promise.all([this.sendRequest({topic:i,method:"wc_sessionPing",params:{},throwOnFailedPublish:!0,clientRpcId:r,relayRpcId:n}),o()])}else this.client.core.pairing.pairings.keys.includes(i)&&(this.client.logger.warn("ping() on pairing topic is deprecated and will be removed in the next major release."),await this.client.core.pairing.ping({topic:i}))}),I(this,"emit",async s=>{this.isInitialized(),await this.confirmOnlineStateOrThrow(),await this.isValidEmit(s);let{topic:i,event:r,chainId:n}=s,o=Rt().toString(),a=Pt();await this.sendRequest({topic:i,method:"wc_sessionEvent",params:{event:r,chainId:n},throwOnFailedPublish:!0,relayRpcId:o,clientRpcId:a})}),I(this,"disconnect",async s=>{this.isInitialized(),await this.confirmOnlineStateOrThrow(),await this.isValidDisconnect(s);let{topic:i}=s;if(this.client.session.keys.includes(i))await this.sendRequest({topic:i,method:"wc_sessionDelete",params:ie("USER_DISCONNECTED"),throwOnFailedPublish:!0}),await this.deleteSession({topic:i,emitEvent:!1});else if(this.client.core.pairing.pairings.keys.includes(i))await this.client.core.pairing.disconnect({topic:i});else{let{message:r}=A("MISMATCHED_TOPIC",`Session or pairing topic not found: ${i}`);throw new Error(r)}}),I(this,"find",s=>(this.isInitialized(),this.client.session.getAll().filter(i=>Wl(i,s)))),I(this,"getPendingSessionRequests",()=>this.client.pendingRequest.getAll()),I(this,"authenticate",async(s,i)=>{var r;this.isInitialized(),this.isValidAuthenticate(s);let n=i&&this.client.core.linkModeSupportedApps.includes(i)&&((r=this.client.metadata.redirect)==null?void 0:r.linkMode),o=n?oe.link_mode:oe.relay;o===oe.relay&&await this.confirmOnlineStateOrThrow();let{chains:a,statement:c="",uri:l,domain:h,nonce:u,type:p,exp:d,nbf:f,methods:g=[],expiry:y}=s,P=[...s.resources||[]],{topic:x,uri:S}=await this.client.core.pairing.create({methods:["wc_sessionAuthenticate"],transportType:o});this.client.logger.info({message:"Generated new pairing",pairing:{topic:x,uri:S}});let q=await this.client.core.crypto.generateKeyPair(),B=Bs(q);if(await Promise.all([this.client.auth.authKeys.set(xr,{responseTopic:B,publicKey:q}),this.client.auth.pairingTopics.set(B,{topic:B,pairingTopic:x})]),await this.client.core.relayer.subscribe(B,{transportType:o}),this.client.logger.info(`sending request to new pairing topic: ${x}`),g.length>0){let{namespace:v}=ft(a[0]),O=il(v,"request",g);wi(P)&&(O=rl(O,P.pop())),P.push(O)}let N=y&&y>ve.wc_sessionAuthenticate.req.ttl?y:ve.wc_sessionAuthenticate.req.ttl,D={authPayload:{type:p??"caip122",chains:a,statement:c,aud:l,domain:h,version:"1",nonce:u,iat:new Date().toISOString(),exp:d,nbf:f,resources:P},requester:{publicKey:q,metadata:this.client.metadata},expiryTimestamp:ce(N)},U={eip155:{chains:a,methods:[...new Set(["personal_sign",...g])],events:["chainChanged","accountsChanged"]}},_={requiredNamespaces:{},optionalNamespaces:U,relays:[{protocol:"irn"}],pairingTopic:x,proposer:{publicKey:q,metadata:this.client.metadata},expiryTimestamp:ce(ve.wc_sessionPropose.req.ttl),id:Pt()},{done:F,resolve:M,reject:R}=Lt(N,"Request expired"),m=Pt(),w=te("session_connect",_.id),b=te("session_request",m),E=async({error:v,session:O})=>{this.events.off(b,T),v?R(v):O&&M({session:O})},T=async v=>{var O,L,k;if(await this.deletePendingAuthRequest(m,{message:"fulfilled",code:0}),v.error){let W=ie("WC_METHOD_UNSUPPORTED","wc_sessionAuthenticate");return v.error.code===W.code?void 0:(this.events.off(w,E),R(v.error.message))}await this.deleteProposal(_.id),this.events.off(w,E);let{cacaos:J,responder:z}=v.result,V=[],Y=[];for(let W of J){await Bn({cacao:W,projectId:this.client.core.projectId})||(this.client.logger.error(W,"Signature verification failed"),R(ie("SESSION_SETTLEMENT_FAILED","Signature verification failed")));let{p:he}=W,ot=wi(he.resources),Dt=[or(he.iss)],cs=mi(he.iss);if(ot){let Ps=Mn(ot),Hu=Vn(ot);V.push(...Ps),Dt.push(...Hu)}for(let Ps of Dt)Y.push(`${Ps}:${cs}`)}let G=await this.client.core.crypto.generateSharedKey(q,z.publicKey),ae;V.length>0&&(ae={topic:G,acknowledged:!0,self:{publicKey:q,metadata:this.client.metadata},peer:z,controller:z.publicKey,expiry:ce(Ws),requiredNamespaces:{},optionalNamespaces:{},relay:{protocol:"irn"},pairingTopic:x,namespaces:to([...new Set(V)],[...new Set(Y)]),transportType:o},await this.client.core.relayer.subscribe(G,{transportType:o}),await this.client.session.set(G,ae),x&&await this.client.core.pairing.updateMetadata({topic:x,metadata:z.metadata}),ae=this.client.session.get(G)),(O=this.client.metadata.redirect)!=null&&O.linkMode&&(L=z.metadata.redirect)!=null&&L.linkMode&&(k=z.metadata.redirect)!=null&&k.universal&&i&&(this.client.core.addLinkModeSupportedApp(z.metadata.redirect.universal),this.client.session.update(G,{transportType:oe.link_mode})),M({auths:J,session:ae})};this.events.once(w,E),this.events.once(b,T);let C;try{if(n){let v=ze("wc_sessionAuthenticate",D,m);this.client.core.history.set(x,v);let O=await this.client.core.crypto.encode("",v,{type:Us,encoding:Ft});C=_i(i,x,O)}else await Promise.all([this.sendRequest({topic:x,method:"wc_sessionAuthenticate",params:D,expiry:s.expiry,throwOnFailedPublish:!0,clientRpcId:m}),this.sendRequest({topic:x,method:"wc_sessionPropose",params:_,expiry:ve.wc_sessionPropose.req.ttl,throwOnFailedPublish:!0,clientRpcId:_.id})])}catch(v){throw this.events.off(w,E),this.events.off(b,T),v}return await this.setProposal(_.id,_),await this.setAuthRequest(m,{request:Ee(se({},D),{verifyContext:{}}),pairingTopic:x,transportType:o}),{uri:C??S,response:F}}),I(this,"approveSessionAuthenticate",async s=>{let{id:i,auths:r}=s,n=this.client.core.eventClient.createEvent({properties:{topic:i.toString(),trace:[as.authenticated_session_approve_started]}});try{this.isInitialized()}catch(y){throw n.setError(Gs.no_internet_connection),y}let o=this.getPendingAuthRequest(i);if(!o)throw n.setError(Gs.authenticated_session_pending_request_not_found),new Error(`Could not find pending auth request with id ${i}`);let a=o.transportType||oe.relay;a===oe.relay&&await this.confirmOnlineStateOrThrow();let c=o.requester.publicKey,l=await this.client.core.crypto.generateKeyPair(),h=Bs(c),u={type:yt,receiverPublicKey:c,senderPublicKey:l},p=[],d=[];for(let y of r){if(!await Bn({cacao:y,projectId:this.client.core.projectId})){n.setError(Gs.invalid_cacao);let B=ie("SESSION_SETTLEMENT_FAILED","Signature verification failed");throw await this.sendError({id:i,topic:h,error:B,encodeOpts:u}),new Error(B.message)}n.addTrace(as.cacaos_verified);let{p:P}=y,x=wi(P.resources),S=[or(P.iss)],q=mi(P.iss);if(x){let B=Mn(x),N=Vn(x);p.push(...B),S.push(...N)}for(let B of S)d.push(`${B}:${q}`)}let f=await this.client.core.crypto.generateSharedKey(l,c);n.addTrace(as.create_authenticated_session_topic);let g;if(p?.length>0){g={topic:f,acknowledged:!0,self:{publicKey:l,metadata:this.client.metadata},peer:{publicKey:c,metadata:o.requester.metadata},controller:c,expiry:ce(Ws),authentication:r,requiredNamespaces:{},optionalNamespaces:{},relay:{protocol:"irn"},pairingTopic:o.pairingTopic,namespaces:to([...new Set(p)],[...new Set(d)]),transportType:a},n.addTrace(as.subscribing_authenticated_session_topic);try{await this.client.core.relayer.subscribe(f,{transportType:a})}catch(y){throw n.setError(Gs.subscribe_authenticated_session_topic_failure),y}n.addTrace(as.subscribe_authenticated_session_topic_success),await this.client.session.set(f,g),n.addTrace(as.store_authenticated_session),await this.client.core.pairing.updateMetadata({topic:o.pairingTopic,metadata:o.requester.metadata})}n.addTrace(as.publishing_authenticated_session_approve);try{await this.sendResult({topic:h,id:i,result:{cacaos:r,responder:{publicKey:l,metadata:this.client.metadata}},encodeOpts:u,throwOnFailedPublish:!0,appLink:this.getAppLinkIfEnabled(o.requester.metadata,a)})}catch(y){throw n.setError(Gs.authenticated_session_approve_publish_failure),y}return await this.client.auth.requests.delete(i,{message:"fulfilled",code:0}),await this.client.core.pairing.activate({topic:o.pairingTopic}),this.client.core.eventClient.deleteEvent({eventId:n.eventId}),{session:g}}),I(this,"rejectSessionAuthenticate",async s=>{this.isInitialized();let{id:i,reason:r}=s,n=this.getPendingAuthRequest(i);if(!n)throw new Error(`Could not find pending auth request with id ${i}`);n.transportType===oe.relay&&await this.confirmOnlineStateOrThrow();let o=n.requester.publicKey,a=await this.client.core.crypto.generateKeyPair(),c=Bs(o),l={type:yt,receiverPublicKey:o,senderPublicKey:a};await this.sendError({id:i,topic:c,error:r,encodeOpts:l,rpcOpts:ve.wc_sessionAuthenticate.reject,appLink:this.getAppLinkIfEnabled(n.requester.metadata,n.transportType)}),await this.client.auth.requests.delete(i,{message:"rejected",code:0}),await this.deleteProposal(i)}),I(this,"formatAuthMessage",s=>{this.isInitialized();let{request:i,iss:r}=s;return $n(i,r)}),I(this,"processRelayMessageCache",()=>{setTimeout(async()=>{if(this.relayMessageCache.length!==0)for(;this.relayMessageCache.length>0;)try{let s=this.relayMessageCache.shift();s&&await this.onRelayMessage(s)}catch(s){this.client.logger.error(s)}},50)}),I(this,"cleanupDuplicatePairings",async s=>{if(s.pairingTopic)try{let i=this.client.core.pairing.pairings.get(s.pairingTopic),r=this.client.core.pairing.pairings.getAll().filter(n=>{var o,a;return((o=n.peerMetadata)==null?void 0:o.url)&&((a=n.peerMetadata)==null?void 0:a.url)===s.peer.metadata.url&&n.topic&&n.topic!==i.topic});if(r.length===0)return;this.client.logger.info(`Cleaning up ${r.length} duplicate pairing(s)`),await Promise.all(r.map(n=>this.client.core.pairing.disconnect({topic:n.topic}))),this.client.logger.info("Duplicate pairings clean up finished")}catch(i){this.client.logger.error(i)}}),I(this,"deleteSession",async s=>{var i;let{topic:r,expirerHasDeleted:n=!1,emitEvent:o=!0,id:a=0}=s,{self:c}=this.client.session.get(r);await this.client.core.relayer.unsubscribe(r),await this.client.session.delete(r,ie("USER_DISCONNECTED")),this.addToRecentlyDeleted(r,"session"),this.client.core.crypto.keychain.has(c.publicKey)&&await this.client.core.crypto.deleteKeyPair(c.publicKey),this.client.core.crypto.keychain.has(r)&&await this.client.core.crypto.deleteSymKey(r),n||this.client.core.expirer.del(r),this.client.core.storage.removeItem(su).catch(l=>this.client.logger.warn(l)),r===((i=this.sessionRequestQueue.queue[0])==null?void 0:i.topic)&&(this.sessionRequestQueue.state=Ot.idle),await Promise.all(this.getPendingSessionRequests().filter(l=>l.topic===r).map(l=>this.deletePendingSessionRequest(l.id,ie("USER_DISCONNECTED")))),o&&this.client.events.emit("session_delete",{id:a,topic:r})}),I(this,"deleteProposal",async(s,i)=>{if(i)try{let r=this.client.proposal.get(s);this.client.core.eventClient.getEvent({topic:r.pairingTopic})?.setError(os.proposal_expired)}catch{}await Promise.all([this.client.proposal.delete(s,ie("USER_DISCONNECTED")),i?Promise.resolve():this.client.core.expirer.del(s)]),this.addToRecentlyDeleted(s,"proposal")}),I(this,"deletePendingSessionRequest",async(s,i,r=!1)=>{await Promise.all([this.client.pendingRequest.delete(s,i),r?Promise.resolve():this.client.core.expirer.del(s)]),this.addToRecentlyDeleted(s,"request"),this.sessionRequestQueue.queue=this.sessionRequestQueue.queue.filter(n=>n.id!==s),r&&(this.sessionRequestQueue.state=Ot.idle,this.client.events.emit("session_request_expire",{id:s}))}),I(this,"deletePendingAuthRequest",async(s,i,r=!1)=>{await Promise.all([this.client.auth.requests.delete(s,i),r?Promise.resolve():this.client.core.expirer.del(s)])}),I(this,"setExpiry",async(s,i)=>{this.client.session.keys.includes(s)&&(this.client.core.expirer.set(s,i),await this.client.session.update(s,{expiry:i}))}),I(this,"setProposal",async(s,i)=>{this.client.core.expirer.set(s,ce(ve.wc_sessionPropose.req.ttl)),await this.client.proposal.set(s,i)}),I(this,"setAuthRequest",async(s,i)=>{let{request:r,pairingTopic:n,transportType:o=oe.relay}=i;this.client.core.expirer.set(s,r.expiryTimestamp),await this.client.auth.requests.set(s,{authPayload:r.authPayload,requester:r.requester,expiryTimestamp:r.expiryTimestamp,id:s,pairingTopic:n,verifyContext:r.verifyContext,transportType:o})}),I(this,"setPendingSessionRequest",async s=>{let{id:i,topic:r,params:n,verifyContext:o}=s,a=n.request.expiryTimestamp||ce(ve.wc_sessionRequest.req.ttl);this.client.core.expirer.set(i,a),await this.client.pendingRequest.set(i,{id:i,topic:r,params:n,verifyContext:o})}),I(this,"sendRequest",async s=>{let{topic:i,method:r,params:n,expiry:o,relayRpcId:a,clientRpcId:c,throwOnFailedPublish:l,appLink:h,tvf:u,publishOpts:p={}}=s,d=ze(r,n,c),f,g=!!h;try{let x=g?Ft:xe;f=await this.client.core.crypto.encode(i,d,{encoding:x})}catch(x){throw await this.cleanup(),this.client.logger.error(`sendRequest() -> core.crypto.encode() for topic ${i} failed`),x}let y;if(qb.includes(r)){let x=Me(JSON.stringify(d)),S=Me(f);y=await this.client.core.verify.register({id:S,decryptedId:x})}let P=se(se({},ve[r].req),p);if(P.attestation=y,o&&(P.ttl=o),a&&(P.id=a),this.client.core.history.set(i,d),g){let x=_i(h,i,f);await globalThis.Linking.openURL(x,this.client.name)}else P.tvf=Ee(se({},u),{correlationId:d.id}),l?(P.internal=Ee(se({},P.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(i,f,P)):this.client.core.relayer.publish(i,f,P).catch(x=>this.client.logger.error(x));return d.id}),I(this,"sendProposeSession",async s=>{let{proposal:i,publishOpts:r}=s,n=ze("wc_sessionPropose",i,i.id);this.client.core.history.set(i.pairingTopic,n);let o=await this.client.core.crypto.encode(i.pairingTopic,n,{encoding:xe}),a=Me(JSON.stringify(n)),c=Me(o),l=await this.client.core.verify.register({id:c,decryptedId:a});await this.client.core.relayer.publishCustom({payload:{pairingTopic:i.pairingTopic,sessionProposal:o},opts:Ee(se({},r),{publishMethod:"wc_proposeSession",attestation:l})})}),I(this,"sendApproveSession",async s=>{let{sessionTopic:i,pairingProposalResponse:r,proposal:n,sessionSettleRequest:o,publishOpts:a}=s,c=Ut(n.id,r),l=await this.client.core.crypto.encode(n.pairingTopic,c,{encoding:xe}),h=ze("wc_sessionSettle",o,a?.id),u=await this.client.core.crypto.encode(i,h,{encoding:xe});this.client.core.history.set(i,h),await this.client.core.relayer.publishCustom({payload:{sessionTopic:i,pairingTopic:n.pairingTopic,sessionProposalResponse:l,sessionSettlementRequest:u},opts:Ee(se({},a),{publishMethod:"wc_approveSession"})})}),I(this,"sendResult",async s=>{let{id:i,topic:r,result:n,throwOnFailedPublish:o,encodeOpts:a,appLink:c}=s,l=Ut(i,n),h,u=c&&typeof globalThis?.Linking<"u";try{let f=u?Ft:xe;h=await this.client.core.crypto.encode(r,l,Ee(se({},a||{}),{encoding:f}))}catch(f){throw await this.cleanup(),this.client.logger.error(`sendResult() -> core.crypto.encode() for topic ${r} failed`),f}let p,d;try{p=await this.client.core.history.get(r,i);let f=p.request;try{d=this.getTVFParams(i,f.params,n)}catch(g){this.client.logger.warn(`sendResult() -> getTVFParams() failed: ${g?.message}`)}}catch(f){throw this.client.logger.error(`sendResult() -> history.get(${r}, ${i}) failed`),f}if(u){let f=_i(c,r,h);await globalThis.Linking.openURL(f,this.client.name)}else{let f=p.request.method,g=ve[f].res;g.tvf=Ee(se({},d),{correlationId:i}),o?(g.internal=Ee(se({},g.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(r,h,g)):this.client.core.relayer.publish(r,h,g).catch(y=>this.client.logger.error(y))}await this.client.core.history.resolve(l)}),I(this,"sendError",async s=>{let{id:i,topic:r,error:n,encodeOpts:o,rpcOpts:a,appLink:c}=s,l=Ni(i,n),h,u=c&&typeof globalThis?.Linking<"u";try{let d=u?Ft:xe;h=await this.client.core.crypto.encode(r,l,Ee(se({},o||{}),{encoding:d}))}catch(d){throw await this.cleanup(),this.client.logger.error(`sendError() -> core.crypto.encode() for topic ${r} failed`),d}let p;try{p=await this.client.core.history.get(r,i)}catch(d){throw this.client.logger.error(`sendError() -> history.get(${r}, ${i}) failed`),d}if(u){let d=_i(c,r,h);await globalThis.Linking.openURL(d,this.client.name)}else{let d=p.request.method,f=a||ve[d].res;this.client.core.relayer.publish(r,h,f)}await this.client.core.history.resolve(l)}),I(this,"cleanup",async()=>{let s=[],i=[];this.client.session.getAll().forEach(r=>{let n=!1;Ge(r.expiry)&&(n=!0),this.client.core.crypto.keychain.has(r.topic)||(n=!0),n&&s.push(r.topic)}),this.client.proposal.getAll().forEach(r=>{Ge(r.expiryTimestamp)&&i.push(r.id)}),await Promise.all([...s.map(r=>this.deleteSession({topic:r})),...i.map(r=>this.deleteProposal(r))])}),I(this,"onProviderMessageEvent",async s=>{!this.initialized||this.relayMessageCache.length>0?this.relayMessageCache.push(s):await this.onRelayMessage(s)}),I(this,"onRelayEventRequest",async s=>{this.requestQueue.queue.push(s),await this.processRequestsQueue()}),I(this,"processRequestsQueue",async()=>{if(this.requestQueue.state===Ot.active){this.client.logger.info("Request queue already active, skipping...");return}for(this.client.logger.info(`Request queue starting with ${this.requestQueue.queue.length} requests`);this.requestQueue.queue.length>0;){this.requestQueue.state=Ot.active;let s=this.requestQueue.queue.shift();if(s)try{await this.processRequest(s)}catch(i){this.client.logger.warn(i)}}this.requestQueue.state=Ot.idle}),I(this,"processRequest",async s=>{let{topic:i,payload:r,attestation:n,transportType:o,encryptedId:a}=s,c=r.method;if(!this.shouldIgnorePairingRequest({topic:i,requestMethod:c}))switch(c){case"wc_sessionPropose":return await this.onSessionProposeRequest({topic:i,payload:r,attestation:n,encryptedId:a});case"wc_sessionSettle":return await this.onSessionSettleRequest(i,r);case"wc_sessionUpdate":return await this.onSessionUpdateRequest(i,r);case"wc_sessionExtend":return await this.onSessionExtendRequest(i,r);case"wc_sessionPing":return await this.onSessionPingRequest(i,r);case"wc_sessionDelete":return await this.onSessionDeleteRequest(i,r);case"wc_sessionRequest":return await this.onSessionRequest({topic:i,payload:r,attestation:n,encryptedId:a,transportType:o});case"wc_sessionEvent":return await this.onSessionEventRequest(i,r);case"wc_sessionAuthenticate":return await this.onSessionAuthenticateRequest({topic:i,payload:r,attestation:n,encryptedId:a,transportType:o});default:return this.client.logger.info(`Unsupported request method ${c}`)}}),I(this,"onRelayEventResponse",async s=>{let{topic:i,payload:r,transportType:n}=s,o=(await this.client.core.history.get(i,r.id)).request.method;switch(o){case"wc_sessionPropose":return this.onSessionProposeResponse(i,r,n);case"wc_sessionSettle":return this.onSessionSettleResponse(i,r);case"wc_sessionUpdate":return this.onSessionUpdateResponse(i,r);case"wc_sessionExtend":return this.onSessionExtendResponse(i,r);case"wc_sessionPing":return this.onSessionPingResponse(i,r);case"wc_sessionRequest":return this.onSessionRequestResponse(i,r);case"wc_sessionAuthenticate":return this.onSessionAuthenticateResponse(i,r);default:return this.client.logger.info(`Unsupported response method ${o}`)}}),I(this,"onRelayEventUnknownPayload",s=>{let{topic:i}=s,{message:r}=A("MISSING_OR_INVALID",`Decoded payload on topic ${i} is not identifiable as a JSON-RPC request or a response.`);throw new Error(r)}),I(this,"shouldIgnorePairingRequest",s=>{let{topic:i,requestMethod:r}=s,n=this.expectedPairingMethodMap.get(i);return!n||n.includes(r)?!1:!!(n.includes("wc_sessionAuthenticate")&&this.client.events.listenerCount("session_authenticate")>0)}),I(this,"onSessionProposeRequest",async s=>{let{topic:i,payload:r,attestation:n,encryptedId:o}=s,{params:a,id:c}=r;try{let l=this.client.core.eventClient.getEvent({topic:i});this.client.events.listenerCount("session_proposal")===0&&(console.warn("No listener for session_proposal event"),l?.setError(_t.proposal_listener_not_found)),this.isValidConnect(se({},r.params));let h=a.expiryTimestamp||ce(ve.wc_sessionPropose.req.ttl),u=se({id:c,pairingTopic:i,expiryTimestamp:h,attestation:n,encryptedId:o},a);await this.setProposal(c,u);let p=await this.getVerifyContext({attestationId:n,hash:Me(JSON.stringify(r)),encryptedId:o,metadata:u.proposer.metadata});l?.addTrace(wt.emit_session_proposal),this.client.events.emit("session_proposal",{id:c,params:u,verifyContext:p})}catch(l){await this.sendError({id:c,topic:i,error:l,rpcOpts:ve.wc_sessionPropose.autoReject}),this.client.logger.error(l)}}),I(this,"onSessionProposeResponse",async(s,i,r)=>{let{id:n}=i;if(at(i)){let{result:o}=i;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",result:o});let a=this.client.proposal.get(n);this.client.logger.trace({type:"method",method:"onSessionProposeResponse",proposal:a});let c=a.proposer.publicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",selfPublicKey:c});let l=o.responderPublicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",peerPublicKey:l});let h=await this.client.core.crypto.generateSharedKey(c,l);this.pendingSessions.set(n,{sessionTopic:h,pairingTopic:s,proposalId:n,publicKey:c});let u=await this.client.core.relayer.subscribe(h,{transportType:r});this.client.logger.trace({type:"method",method:"onSessionProposeResponse",subscriptionId:u}),await this.client.core.pairing.activate({topic:s})}else if(et(i)){await this.deleteProposal(n);let o=te("session_connect",n);if(this.events.listenerCount(o)===0)throw new Error(`emitting ${o} without any listeners, 954`);this.events.emit(o,{error:i.error})}}),I(this,"onSessionSettleRequest",async(s,i)=>{let{id:r,params:n}=i;try{this.isValidSessionSettleRequest(n);let{relay:o,controller:a,expiry:c,namespaces:l,sessionProperties:h,scopedProperties:u,sessionConfig:p,proposalRequestsResponses:d}=i.params,f=[...this.pendingSessions.values()].find(P=>P.sessionTopic===s);if(!f)return this.client.logger.error(`Pending session not found for topic ${s}`);let g=this.client.proposal.get(f.proposalId),y=Ee(se(se(se({topic:s,relay:o,expiry:c,namespaces:l,acknowledged:!0,pairingTopic:f.pairingTopic,requiredNamespaces:g.requiredNamespaces,optionalNamespaces:g.optionalNamespaces,controller:a.publicKey,self:{publicKey:f.publicKey,metadata:this.client.metadata},peer:{publicKey:a.publicKey,metadata:a.metadata}},h&&{sessionProperties:h}),u&&{scopedProperties:u}),p&&{sessionConfig:p}),{transportType:oe.relay,authentication:d?.authentication,walletPayResult:d?.walletPay});await this.client.session.set(y.topic,y),await this.setExpiry(y.topic,y.expiry),await this.client.core.pairing.updateMetadata({topic:f.pairingTopic,metadata:y.peer.metadata}),this.pendingSessions.delete(f.proposalId),this.deleteProposal(f.proposalId,!1),this.cleanupDuplicatePairings(y),await this.sendResult({id:i.id,topic:s,throwOnFailedPublish:!0,result:!0}),this.client.events.emit("session_connect",{session:y}),this.events.emit(te("session_connect",f.proposalId),{session:y})}catch(o){await this.sendError({id:r,topic:s,error:o}),this.client.logger.error(o)}}),I(this,"onSessionSettleResponse",async(s,i)=>{let{id:r}=i;at(i)?(await this.client.session.update(s,{acknowledged:!0}),this.events.emit(te("session_approve",r),{})):et(i)&&(await this.client.session.delete(s,ie("USER_DISCONNECTED")),this.events.emit(te("session_approve",r),{error:i.error}))}),I(this,"onSessionUpdateRequest",async(s,i)=>{let{params:r,id:n}=i;try{let o=`${s}_session_update`,a=is.get(o);if(a&&this.isRequestOutOfSync(a,n)){this.client.logger.warn(`Discarding out of sync request - ${n}`),this.sendError({id:n,topic:s,error:ie("INVALID_UPDATE_REQUEST")});return}this.isValidUpdate(se({topic:s},r));try{is.set(o,n),await this.client.session.update(s,{namespaces:r.namespaces}),await this.sendResult({id:n,topic:s,result:!0})}catch(c){throw is.delete(o),c}this.client.events.emit("session_update",{id:n,topic:s,params:r})}catch(o){await this.sendError({id:n,topic:s,error:o}),this.client.logger.error(o)}}),I(this,"isRequestOutOfSync",(s,i)=>i.toString().slice(0,-3)<s.toString().slice(0,-3)),I(this,"onSessionUpdateResponse",(s,i)=>{let{id:r}=i,n=te("session_update",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);at(i)?this.events.emit(te("session_update",r),{}):et(i)&&this.events.emit(te("session_update",r),{error:i.error})}),I(this,"onSessionExtendRequest",async(s,i)=>{let{id:r}=i;try{this.isValidExtend({topic:s}),await this.setExpiry(s,ce(Ws)),await this.sendResult({id:r,topic:s,result:!0}),this.client.events.emit("session_extend",{id:r,topic:s})}catch(n){await this.sendError({id:r,topic:s,error:n}),this.client.logger.error(n)}}),I(this,"onSessionExtendResponse",(s,i)=>{let{id:r}=i,n=te("session_extend",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);at(i)?this.events.emit(te("session_extend",r),{}):et(i)&&this.events.emit(te("session_extend",r),{error:i.error})}),I(this,"onSessionPingRequest",async(s,i)=>{let{id:r}=i;try{this.isValidPing({topic:s}),await this.sendResult({id:r,topic:s,result:!0,throwOnFailedPublish:!0}),this.client.events.emit("session_ping",{id:r,topic:s})}catch(n){await this.sendError({id:r,topic:s,error:n}),this.client.logger.error(n)}}),I(this,"onSessionPingResponse",(s,i)=>{let{id:r}=i,n=te("session_ping",r);setTimeout(()=>{if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners 2176`);at(i)?this.events.emit(te("session_ping",r),{}):et(i)&&this.events.emit(te("session_ping",r),{error:i.error})},500)}),I(this,"onSessionDeleteRequest",async(s,i)=>{let{id:r}=i;try{await this.isValidDisconnect({topic:s,reason:i.params}),this.cleanupPendingSentRequestsForTopic({topic:s,error:ie("USER_DISCONNECTED")}),await this.deleteSession({topic:s,id:r})}catch(n){this.client.logger.error(n)}}),I(this,"onSessionRequest",async s=>{var i,r,n;let{topic:o,payload:a,attestation:c,encryptedId:l,transportType:h}=s,{id:u,params:p}=a;try{await this.isValidRequest(se({topic:o},p));let d=this.client.session.get(o),f=await this.getVerifyContext({attestationId:c,hash:Me(JSON.stringify(ze("wc_sessionRequest",p,u))),encryptedId:l,metadata:d.peer.metadata,transportType:h}),g={id:u,topic:o,params:p,verifyContext:f};await this.setPendingSessionRequest(g),h===oe.link_mode&&(i=d.peer.metadata.redirect)!=null&&i.universal&&this.client.core.addLinkModeSupportedApp((r=d.peer.metadata.redirect)==null?void 0:r.universal),(n=this.client.signConfig)!=null&&n.disableRequestQueue?this.emitSessionRequest(g):(this.addSessionRequestToSessionRequestQueue(g),this.processSessionRequestQueue())}catch(d){await this.sendError({id:u,topic:o,error:d}),this.client.logger.error(d)}}),I(this,"onSessionRequestResponse",(s,i)=>{let{id:r}=i,n=te("session_request",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);at(i)?this.events.emit(te("session_request",r),{result:i.result}):et(i)&&this.events.emit(te("session_request",r),{error:i.error})}),I(this,"onSessionEventRequest",async(s,i)=>{let{id:r,params:n}=i;try{let o=`${s}_session_event_${n.event.name}`,a=is.get(o);if(a&&this.isRequestOutOfSync(a,r)){this.client.logger.info(`Discarding out of sync request - ${r}`);return}this.isValidEmit(se({topic:s},n)),this.client.events.emit("session_event",{id:r,topic:s,params:n}),is.set(o,r)}catch(o){await this.sendError({id:r,topic:s,error:o}),this.client.logger.error(o)}}),I(this,"onSessionAuthenticateResponse",(s,i)=>{let{id:r}=i;this.client.logger.trace({type:"method",method:"onSessionAuthenticateResponse",topic:s,payload:i}),at(i)?this.events.emit(te("session_request",r),{result:i.result}):et(i)&&this.events.emit(te("session_request",r),{error:i.error})}),I(this,"onSessionAuthenticateRequest",async s=>{var i;let{topic:r,payload:n,attestation:o,encryptedId:a,transportType:c}=s;try{let{requester:l,authPayload:h,expiryTimestamp:u}=n.params,p=await this.getVerifyContext({attestationId:o,hash:Me(JSON.stringify(n)),encryptedId:a,metadata:l.metadata,transportType:c}),d={requester:l,pairingTopic:r,id:n.id,authPayload:h,verifyContext:p,expiryTimestamp:u};await this.setAuthRequest(n.id,{request:d,pairingTopic:r,transportType:c}),c===oe.link_mode&&(i=l.metadata.redirect)!=null&&i.universal&&this.client.core.addLinkModeSupportedApp(l.metadata.redirect.universal),this.client.events.emit("session_authenticate",{topic:r,params:n.params,id:n.id,verifyContext:p})}catch(l){this.client.logger.error(l);let h=n.params.requester.publicKey,u=await this.client.core.crypto.generateKeyPair(),p=this.getAppLinkIfEnabled(n.params.requester.metadata,c),d={type:yt,receiverPublicKey:h,senderPublicKey:u};await this.sendError({id:n.id,topic:r,error:l,encodeOpts:d,rpcOpts:ve.wc_sessionAuthenticate.autoReject,appLink:p})}}),I(this,"addSessionRequestToSessionRequestQueue",s=>{this.sessionRequestQueue.queue.push(s)}),I(this,"cleanupAfterResponse",s=>{this.deletePendingSessionRequest(s.response.id,{message:"fulfilled",code:0}),setTimeout(()=>{this.sessionRequestQueue.state=Ot.idle,this.processSessionRequestQueue()},(0,H.toMiliseconds)(this.requestQueueDelay))}),I(this,"cleanupPendingSentRequestsForTopic",({topic:s,error:i})=>{let r=this.client.core.history.pending;r.length>0&&r.filter(n=>n.topic===s&&n.request.method==="wc_sessionRequest").forEach(n=>{this.events.emit(te("session_request",n.request.id),{error:i})})}),I(this,"processSessionRequestQueue",()=>{if(this.sessionRequestQueue.state===Ot.active){this.client.logger.info("session request queue is already active.");return}let s=this.sessionRequestQueue.queue[0];if(!s){this.client.logger.info("session request queue is empty.");return}try{this.emitSessionRequest(s)}catch(i){this.client.logger.error(i)}}),I(this,"emitSessionRequest",s=>{if(this.emittedSessionRequests.has(s.id)){this.client.logger.warn({id:s.id},`Skipping emitting \`session_request\` event for duplicate request. id: ${s.id}`);return}this.sessionRequestQueue.state=Ot.active,this.emittedSessionRequests.add(s.id),this.client.events.emit("session_request",s)}),I(this,"onPairingCreated",s=>{if(s.methods&&this.expectedPairingMethodMap.set(s.topic,s.methods),s.active)return;let i=this.client.proposal.getAll().find(r=>r.pairingTopic===s.topic);i&&this.onSessionProposeRequest({topic:s.topic,payload:ze("wc_sessionPropose",Ee(se({},i),{requiredNamespaces:i.requiredNamespaces,optionalNamespaces:i.optionalNamespaces,relays:i.relays,proposer:i.proposer,sessionProperties:i.sessionProperties,scopedProperties:i.scopedProperties}),i.id),attestation:i.attestation,encryptedId:i.encryptedId})}),I(this,"isValidConnect",async s=>{if(!Ae(s)){let{message:l}=A("MISSING_OR_INVALID",`connect() params: ${JSON.stringify(s)}`);throw new Error(l)}let{pairingTopic:i,requiredNamespaces:r,optionalNamespaces:n,sessionProperties:o,scopedProperties:a,relays:c}=s;if(ue(i)||await this.isValidPairingTopic(i),!th(c,!0)){let{message:l}=A("MISSING_OR_INVALID",`connect() relays: ${c}`);throw new Error(l)}if(r&&!ue(r)&&st(r)!==0){let l="requiredNamespaces are deprecated and are automatically assigned to optionalNamespaces";["fatal","error","silent"].includes(this.client.logger.level)?console.warn(l):this.client.logger.warn(l),this.validateNamespaces(r,"requiredNamespaces")}if(n&&!ue(n)&&st(n)!==0&&this.validateNamespaces(n,"optionalNamespaces"),o&&!ue(o)&&this.validateSessionProps(o,"sessionProperties"),a&&!ue(a)){this.validateSessionProps(a,"scopedProperties");let l=Object.keys(r||{}).concat(Object.keys(n||{}));if(!Object.keys(a).every(h=>l.includes(h.split(":")[0])))throw new Error(`Scoped properties must be a subset of required/optional namespaces, received: ${JSON.stringify(a)}, required/optional namespaces: ${JSON.stringify(l)}`)}}),I(this,"validateNamespaces",(s,i)=>{let r=eh(s,"connect()",i);if(r)throw new Error(r.message)}),I(this,"isValidApprove",async s=>{if(!Ae(s))throw new Error(A("MISSING_OR_INVALID",`approve() params: ${s}`).message);let{id:i,namespaces:r,relayProtocol:n,sessionProperties:o,scopedProperties:a}=s;this.checkRecentlyDeleted(i),await this.isValidProposalId(i);let c=this.client.proposal.get(i),l=pr(r,"approve()");if(l)throw new Error(l.message);let h=no(c.requiredNamespaces,r,"approve()");if(h)throw new Error(h.message);if(!le(n,!0)){let{message:u}=A("MISSING_OR_INVALID",`approve() relayProtocol: ${n}`);throw new Error(u)}if(o&&!ue(o)&&this.validateSessionProps(o,"sessionProperties"),a&&!ue(a)){this.validateSessionProps(a,"scopedProperties");let u=new Set(Object.keys(r));if(!Object.keys(a).every(p=>u.has(p.split(":")[0])))throw new Error(`Scoped properties must be a subset of approved namespaces, received: ${JSON.stringify(a)}, approved namespaces: ${Array.from(u).join(", ")}`)}}),I(this,"isValidReject",async s=>{if(!Ae(s)){let{message:n}=A("MISSING_OR_INVALID",`reject() params: ${s}`);throw new Error(n)}let{id:i,reason:r}=s;if(this.checkRecentlyDeleted(i),await this.isValidProposalId(i),!ih(r)){let{message:n}=A("MISSING_OR_INVALID",`reject() reason: ${JSON.stringify(r)}`);throw new Error(n)}}),I(this,"isValidSessionSettleRequest",s=>{if(!Ae(s)){let{message:l}=A("MISSING_OR_INVALID",`onSessionSettleRequest() params: ${s}`);throw new Error(l)}let{relay:i,controller:r,namespaces:n,expiry:o}=s;if(!io(i)){let{message:l}=A("MISSING_OR_INVALID","onSessionSettleRequest() relay protocol should be a string");throw new Error(l)}let a=Zl(r,"onSessionSettleRequest()");if(a)throw new Error(a.message);let c=pr(n,"onSessionSettleRequest()");if(c)throw new Error(c.message);if(Ge(o)){let{message:l}=A("EXPIRED","onSessionSettleRequest()");throw new Error(l)}}),I(this,"isValidUpdate",async s=>{if(!Ae(s)){let{message:c}=A("MISSING_OR_INVALID",`update() params: ${s}`);throw new Error(c)}let{topic:i,namespaces:r}=s;this.checkRecentlyDeleted(i),await this.isValidSessionTopic(i);let n=this.client.session.get(i),o=pr(r,"update()");if(o)throw new Error(o.message);let a=no(n.requiredNamespaces,r,"update()");if(a)throw new Error(a.message)}),I(this,"isValidExtend",async s=>{if(!Ae(s)){let{message:r}=A("MISSING_OR_INVALID",`extend() params: ${s}`);throw new Error(r)}let{topic:i}=s;this.checkRecentlyDeleted(i),await this.isValidSessionTopic(i)}),I(this,"isValidRequest",async s=>{if(!Ae(s)){let{message:c}=A("MISSING_OR_INVALID",`request() params: ${s}`);throw new Error(c)}let{topic:i,request:r,chainId:n,expiry:o}=s;this.checkRecentlyDeleted(i),await this.isValidSessionTopic(i);let{namespaces:a}=this.client.session.get(i);if(!ro(a,n)){let{message:c}=A("MISSING_OR_INVALID",`request() chainId: ${n}`);throw new Error(c)}if(!rh(r)){let{message:c}=A("MISSING_OR_INVALID",`request() ${JSON.stringify(r)}`);throw new Error(c)}if(!ah(a,n,r.method)){let{message:c}=A("MISSING_OR_INVALID",`request() method: ${r.method}`);throw new Error(c)}this.validateRequestExpiry(o)}),I(this,"isValidRespond",async s=>{var i;if(!Ae(s)){let{message:a}=A("MISSING_OR_INVALID",`respond() params: ${s}`);throw new Error(a)}let{topic:r,response:n}=s;try{await this.isValidSessionTopic(r)}catch(a){throw(i=s?.response)!=null&&i.id&&this.cleanupAfterResponse(s),a}if(!nh(n)){let{message:a}=A("MISSING_OR_INVALID",`respond() response: ${JSON.stringify(n)}`);throw new Error(a)}let o=this.client.pendingRequest.get(n.id);if(o.topic!==r){let{message:a}=A("MISMATCHED_TOPIC",`Request response topic mismatch. reqId: ${n.id}, expected topic: ${o.topic}, received topic: ${r}`);throw new Error(a)}}),I(this,"isValidPing",async s=>{if(!Ae(s)){let{message:r}=A("MISSING_OR_INVALID",`ping() params: ${s}`);throw new Error(r)}let{topic:i}=s;await this.isValidSessionOrPairingTopic(i)}),I(this,"isValidEmit",async s=>{if(!Ae(s)){let{message:a}=A("MISSING_OR_INVALID",`emit() params: ${s}`);throw new Error(a)}let{topic:i,event:r,chainId:n}=s;await this.isValidSessionTopic(i);let{namespaces:o}=this.client.session.get(i);if(!ro(o,n)){let{message:a}=A("MISSING_OR_INVALID",`emit() chainId: ${n}`);throw new Error(a)}if(!oh(r)){let{message:a}=A("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(r)}`);throw new Error(a)}if(!ch(o,n,r.name)){let{message:a}=A("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(r)}`);throw new Error(a)}}),I(this,"isValidDisconnect",async s=>{if(!Ae(s)){let{message:r}=A("MISSING_OR_INVALID",`disconnect() params: ${s}`);throw new Error(r)}let{topic:i}=s;await this.isValidSessionOrPairingTopic(i)}),I(this,"isValidAuthenticate",s=>{let{chains:i,uri:r,domain:n,nonce:o}=s;if(!Array.isArray(i)||i.length===0)throw new Error("chains is required and must be a non-empty array");if(!le(r,!1))throw new Error("uri is required parameter");if(!le(n,!1))throw new Error("domain is required parameter");if(!le(o,!1))throw new Error("nonce is required parameter");if([...new Set(i.map(c=>ft(c).namespace))].length>1)throw new Error("Multi-namespace requests are not supported. Please request single namespace only.");let{namespace:a}=ft(i[0]);if(a!=="eip155")throw new Error("Only eip155 namespace is supported for authenticated sessions. Please use .connect() for non-eip155 chains.")}),I(this,"getVerifyContext",async s=>{let{attestationId:i,hash:r,encryptedId:n,metadata:o,transportType:a}=s,c={verified:{verifyUrl:o.verifyUrl||Hs,validation:"UNKNOWN",origin:o.url||""}};try{if(a===oe.link_mode){let h=this.getAppLinkIfEnabled(o,a);return c.verified.validation=h&&new URL(h).origin===new URL(o.url).origin?"VALID":"INVALID",c}let l=await this.client.core.verify.resolve({attestationId:i,hash:r,encryptedId:n,verifyUrl:o.verifyUrl});l&&(c.verified.origin=l.origin,c.verified.isScam=l.isScam,c.verified.validation=l.origin===new URL(o.url).origin?"VALID":"INVALID")}catch(l){this.client.logger.warn(l)}return this.client.logger.debug(`Verify context: ${JSON.stringify(c)}`),c}),I(this,"validateSessionProps",(s,i)=>{Object.values(s).forEach((r,n)=>{if(r==null){let{message:o}=A("MISSING_OR_INVALID",`${i} must contain an existing value for each key. Received: ${r} for key ${Object.keys(s)[n]}`);throw new Error(o)}})}),I(this,"getPendingAuthRequest",s=>{let i=this.client.auth.requests.get(s);return typeof i=="object"?i:void 0}),I(this,"addToRecentlyDeleted",(s,i)=>{if(this.recentlyDeletedMap.set(s,i),this.recentlyDeletedMap.size>=this.recentlyDeletedLimit){let r=0,n=this.recentlyDeletedLimit/2;for(let o of this.recentlyDeletedMap.keys()){if(r++>=n)break;this.recentlyDeletedMap.delete(o)}}}),I(this,"checkRecentlyDeleted",s=>{let i=this.recentlyDeletedMap.get(s);if(i){let{message:r}=A("MISSING_OR_INVALID",`Record was recently deleted - ${i}: ${s}`);throw new Error(r)}}),I(this,"isLinkModeEnabled",(s,i)=>{var r,n,o,a,c,l,h,u,p;return!s||i!==oe.link_mode?!1:((n=(r=this.client.metadata)==null?void 0:r.redirect)==null?void 0:n.linkMode)===!0&&((a=(o=this.client.metadata)==null?void 0:o.redirect)==null?void 0:a.universal)!==void 0&&((l=(c=this.client.metadata)==null?void 0:c.redirect)==null?void 0:l.universal)!==""&&((h=s?.redirect)==null?void 0:h.universal)!==void 0&&((u=s?.redirect)==null?void 0:u.universal)!==""&&((p=s?.redirect)==null?void 0:p.linkMode)===!0&&this.client.core.linkModeSupportedApps.includes(s.redirect.universal)&&typeof globalThis?.Linking<"u"}),I(this,"getAppLinkIfEnabled",(s,i)=>{var r;return this.isLinkModeEnabled(s,i)?(r=s?.redirect)==null?void 0:r.universal:void 0}),I(this,"handleLinkModeMessage",({url:s})=>{if(!s||!s.includes("wc_ev")||!s.includes("topic"))return;let i=jn(s,"topic")||"",r=decodeURIComponent(jn(s,"wc_ev")||""),n=this.client.session.keys.includes(i);n&&this.client.session.update(i,{transportType:oe.link_mode}),this.client.core.dispatchEnvelope({topic:i,message:r,sessionExists:n})}),I(this,"registerLinkModeListeners",async()=>{var s;if(gi()||kt()&&(s=this.client.metadata.redirect)!=null&&s.linkMode){let i=globalThis?.Linking;if(typeof i<"u"){i.addEventListener("url",this.handleLinkModeMessage,this.client.name);let r=await i.getInitialURL();r&&setTimeout(()=>{this.handleLinkModeMessage({url:r})},50)}}}),I(this,"getTVFApproveParams",s=>{try{let i=eo(s.namespaces),r=Kl(s.namespaces),n=Hl(s.namespaces),o=s.sessionProperties,a=s.scopedProperties;return{approvedChains:i,approvedMethods:r,approvedEvents:n,sessionProperties:o,scopedProperties:a}}catch(i){return this.client.logger.warn(i,"Error getting TVF approve params"),{}}}),I(this,"getTVFParams",(s,i,r)=>{var n,o,a;if(!((n=i.request)!=null&&n.method))return{};let c={correlationId:s,rpcMethods:[i.request.method],chainId:i.chainId};try{let l=this.extractTxHashesFromResult(i.request,r);c.txHashes=l,c.contractAddresses=this.isValidContractData(i.request.params)?[(a=(o=i.request.params)==null?void 0:o[0])==null?void 0:a.to]:[]}catch(l){this.client.logger.warn(l,"Error getting TVF params")}return c}),I(this,"isValidContractData",s=>{var i;if(!s)return!1;try{let r=s?.data||((i=s?.[0])==null?void 0:i.data);if(!r.startsWith("0x"))return!1;let n=r.slice(2);return/^[0-9a-fA-F]*$/.test(n)?n.length%2===0:!1}catch{}return!1}),I(this,"extractTxHashesFromResult",(s,i)=>{var r;try{if(!i)return[];let n=s.method,o=Nb[n];if(n==="sui_signTransaction")return[Zc(i.transactionBytes)];if(n==="near_signTransaction")return[Dn(i)];if(n==="near_signTransactions")return i.map(c=>Dn(c));if(n==="xrpl_signTransactionFor"||n==="xrpl_signTransaction")return[(r=i.tx_json)==null?void 0:r.hash];if(n==="polkadot_signTransaction")return[ph({transaction:s.params.transactionPayload,signature:i.signature})];if(n==="algo_signTxn")return je(i)?i.map(c=>Un(c)):[Un(i)];if(n==="cosmos_signDirect")return[Qc(i)];if(n==="wallet_sendCalls")return el(i);if(typeof i=="string")return[i];let a=i[o.key];if(je(a))return n==="solana_signAllTransactions"?a.map(c=>Xc(c)):a;if(typeof a=="string")return[a]}catch(n){this.client.logger.warn(n,"Error extracting tx hashes from result")}return[]})}async processPendingMessageEvents(){try{let e=this.client.session.keys,s=this.client.core.relayer.messages.getWithoutAck(e);for(let[i,r]of Object.entries(s))for(let n of r)try{await this.onProviderMessageEvent({topic:i,message:n,publishedAt:Date.now()})}catch{this.client.logger.warn(`Error processing pending message event for topic: ${i}, message: ${n}`)}}catch(e){this.client.logger.warn(e,"processPendingMessageEvents failed")}}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}async confirmOnlineStateOrThrow(){await this.client.core.relayer.confirmOnlineStateOrThrow()}registerRelayerEvents(){this.client.core.relayer.on(pe.message,e=>{this.onProviderMessageEvent(e)})}async onRelayMessage(e){let{topic:s,message:i,attestation:r,transportType:n}=e,{publicKey:o}=this.client.auth.authKeys.keys.includes(xr)?this.client.auth.authKeys.get(xr):{responseTopic:void 0,publicKey:void 0};try{let a=await this.client.core.crypto.decode(s,i,{receiverPublicKey:o,encoding:n===oe.link_mode?Ft:xe});ti(a)?(this.client.core.history.set(s,a),await this.onRelayEventRequest({topic:s,payload:a,attestation:r,transportType:n,encryptedId:Me(i)})):si(a)?(await this.client.core.history.resolve(a),await this.onRelayEventResponse({topic:s,payload:a,transportType:n}),this.client.core.history.delete(s,a.id)):(this.client.logger.error(`onRelayMessage() -> unknown payload: ${JSON.stringify(a)}`),await this.onRelayEventUnknownPayload({topic:s,payload:a,transportType:n})),await this.client.core.relayer.messages.ack(s,i)}catch(a){this.client.logger.error(`onRelayMessage() -> failed to process an inbound message: ${i}`),this.client.logger.error(a)}}registerExpirerEvents(){this.client.core.expirer.on(Je.expired,async e=>{let{topic:s,id:i}=tr(e.target);if(i&&this.client.pendingRequest.keys.includes(i))return await this.deletePendingSessionRequest(i,A("EXPIRED"),!0);if(i&&this.client.auth.requests.keys.includes(i))return await this.deletePendingAuthRequest(i,A("EXPIRED"),!0);s?this.client.session.keys.includes(s)&&(await this.deleteSession({topic:s,expirerHasDeleted:!0}),this.client.events.emit("session_expire",{topic:s})):i&&(await this.deleteProposal(i,!0),this.client.events.emit("proposal_expire",{id:i}))})}registerPairingEvents(){this.client.core.pairing.events.on(ns.create,e=>this.onPairingCreated(e)),this.client.core.pairing.events.on(ns.delete,e=>{this.addToRecentlyDeleted(e.topic,"pairing")})}isValidPairingTopic(e){if(!le(e,!1)){let{message:s}=A("MISSING_OR_INVALID",`pairing topic should be a string: ${e}`);throw new Error(s)}if(!this.client.core.pairing.pairings.keys.includes(e)){let{message:s}=A("NO_MATCHING_KEY",`pairing topic doesn't exist: ${e}`);throw new Error(s)}if(Ge(this.client.core.pairing.pairings.get(e).expiry)){let{message:s}=A("EXPIRED",`pairing topic: ${e}`);throw new Error(s)}}async isValidSessionTopic(e){if(!le(e,!1)){let{message:s}=A("MISSING_OR_INVALID",`session topic should be a string: ${e}`);throw new Error(s)}if(this.checkRecentlyDeleted(e),!this.client.session.keys.includes(e)){let{message:s}=A("NO_MATCHING_KEY",`session topic doesn't exist: ${e}`);throw new Error(s)}if(Ge(this.client.session.get(e).expiry)){await this.deleteSession({topic:e});let{message:s}=A("EXPIRED",`session topic: ${e}`);throw new Error(s)}if(!this.client.core.crypto.keychain.has(e)){let{message:s}=A("MISSING_OR_INVALID",`session topic does not exist in keychain: ${e}`);throw await this.deleteSession({topic:e}),new Error(s)}}async isValidSessionOrPairingTopic(e){if(this.checkRecentlyDeleted(e),this.client.session.keys.includes(e))await this.isValidSessionTopic(e);else if(this.client.core.pairing.pairings.keys.includes(e))this.isValidPairingTopic(e);else if(le(e,!1)){let{message:s}=A("NO_MATCHING_KEY",`session or pairing topic doesn't exist: ${e}`);throw new Error(s)}else{let{message:s}=A("MISSING_OR_INVALID",`session or pairing topic should be a string: ${e}`);throw new Error(s)}}async isValidProposalId(e){if(!sh(e)){let{message:s}=A("MISSING_OR_INVALID",`proposal id should be a number: ${e}`);throw new Error(s)}if(!this.client.proposal.keys.includes(e)){let{message:s}=A("NO_MATCHING_KEY",`proposal id doesn't exist: ${e}`);throw new Error(s)}if(Ge(this.client.proposal.get(e).expiryTimestamp)){await this.deleteProposal(e);let{message:s}=A("EXPIRED",`proposal id: ${e}`);throw new Error(s)}}validateRequestExpiry(e){if(e&&!lh(e,Vo)){let{message:s}=A("MISSING_OR_INVALID",`request() expiry: ${e}. Expiry must be a number (in seconds) between ${Vo.min} and ${Vo.max}`);throw new Error(s)}}},Go=class extends St{constructor(e,s){super(e,s,xb,ta),this.core=e,this.logger=s}},Wo=class extends St{constructor(e,s){super(e,s,Ab,ta),this.core=e,this.logger=s}},Yo=class extends St{constructor(e,s){super(e,s,jb,ta,i=>i.id),this.core=e,this.logger=s}},Jo=class extends St{constructor(e,s){super(e,s,Fb,Ar,()=>xr),this.core=e,this.logger=s}},Xo=class extends St{constructor(e,s){super(e,s,Db,Ar),this.core=e,this.logger=s}},Zo=class extends St{constructor(e,s){super(e,s,Ub,Ar,i=>i.id),this.core=e,this.logger=s}},Kb=Object.defineProperty,Hb=(t,e,s)=>e in t?Kb(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,zo=(t,e,s)=>Hb(t,typeof e!="symbol"?e+"":e,s),Qo=class{constructor(e,s){this.core=e,this.logger=s,zo(this,"authKeys"),zo(this,"pairingTopics"),zo(this,"requests"),this.authKeys=new Jo(this.core,this.logger),this.pairingTopics=new Xo(this.core,this.logger),this.requests=new Zo(this.core,this.logger)}async init(){await this.authKeys.init(),await this.pairingTopics.init(),await this.requests.init()}},Gb=Object.defineProperty,Wb=(t,e,s)=>e in t?Gb(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Z=(t,e,s)=>Wb(t,typeof e!="symbol"?e+"":e,s),ea=class t extends Sr{constructor(e){super(e),Z(this,"protocol",nu),Z(this,"version",ou),Z(this,"name",Mo.name),Z(this,"metadata"),Z(this,"core"),Z(this,"logger"),Z(this,"events",new Qe),Z(this,"engine"),Z(this,"session"),Z(this,"proposal"),Z(this,"pendingRequest"),Z(this,"auth"),Z(this,"signConfig"),Z(this,"on",(i,r)=>this.events.on(i,r)),Z(this,"once",(i,r)=>this.events.once(i,r)),Z(this,"off",(i,r)=>this.events.off(i,r)),Z(this,"removeListener",(i,r)=>this.events.removeListener(i,r)),Z(this,"removeAllListeners",i=>this.events.removeAllListeners(i)),Z(this,"connect",async i=>{try{return await this.engine.connect(i)}catch(r){throw this.logger.error(r.message),r}}),Z(this,"pair",async i=>{try{return await this.engine.pair(i)}catch(r){throw this.logger.error(r.message),r}}),Z(this,"approve",async i=>{try{return await this.engine.approve(i)}catch(r){throw this.logger.error(r.message),r}}),Z(this,"reject",async i=>{try{return await this.engine.reject(i)}catch(r){throw this.logger.error(r.message),r}}),Z(this,"update",async i=>{try{return await this.engine.update(i)}catch(r){throw this.logger.error(r.message),r}}),Z(this,"extend",async i=>{try{return await this.engine.extend(i)}catch(r){throw this.logger.error(r.message),r}}),Z(this,"request",async i=>{try{return await this.engine.request(i)}catch(r){throw this.logger.error(r.message),r}}),Z(this,"respond",async i=>{try{return await this.engine.respond(i)}catch(r){throw this.logger.error(r.message),r}}),Z(this,"ping",async i=>{try{return await this.engine.ping(i)}catch(r){throw this.logger.error(r.message),r}}),Z(this,"emit",async i=>{try{return await this.engine.emit(i)}catch(r){throw this.logger.error(r.message),r}}),Z(this,"disconnect",async i=>{try{return await this.engine.disconnect(i)}catch(r){throw this.logger.error(r.message),r}}),Z(this,"find",i=>{try{return this.engine.find(i)}catch(r){throw this.logger.error(r.message),r}}),Z(this,"getPendingSessionRequests",()=>{try{return this.engine.getPendingSessionRequests()}catch(i){throw this.logger.error(i.message),i}}),Z(this,"authenticate",async(i,r)=>{try{return await this.engine.authenticate(i,r)}catch(n){throw this.logger.error(n.message),n}}),Z(this,"formatAuthMessage",i=>{try{return this.engine.formatAuthMessage(i)}catch(r){throw this.logger.error(r.message),r}}),Z(this,"approveSessionAuthenticate",async i=>{try{return await this.engine.approveSessionAuthenticate(i)}catch(r){throw this.logger.error(r.message),r}}),Z(this,"rejectSessionAuthenticate",async i=>{try{return await this.engine.rejectSessionAuthenticate(i)}catch(r){throw this.logger.error(r.message),r}}),this.name=e?.name||Mo.name,this.metadata=Ac(e?.metadata),this.signConfig=e?.signConfig;let s=Vs({logger:e?.logger||Mo.logger,name:this.name});this.logger=s,this.core=e?.core||new tu(e),this.session=new Wo(this.core,this.logger),this.proposal=new Go(this.core,this.logger),this.pendingRequest=new Yo(this.core,this.logger),this.engine=new Ho(this),this.auth=new Qo(this.core,this.logger)}static async init(e){let s=new t(e);return await s.initialize(),s}get context(){return Ie(this.logger)}get pairing(){return this.core.pairing.pairings}async initialize(){this.logger.trace("Initialized");try{await this.core.start(),await this.session.init(),await this.proposal.init(),await this.pendingRequest.init(),await this.auth.init(),await this.engine.init(),this.logger.info("SignClient Initialization Success")}catch(e){throw this.logger.info("SignClient Initialization Failure"),this.logger.error(e.message),e}}};var cu=ea;Qs();function ga(t){return t==null||typeof t!="object"&&typeof t!="function"}function Tu(t){return Object.getOwnPropertySymbols(t).filter(e=>Object.prototype.propertyIsEnumerable.call(t,e))}function xu(t){return t==null?t===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(t)}var Yb="[object RegExp]",Au="[object String]",Cu="[object Number]",Nu="[object Boolean]",ju="[object Arguments]",Jb="[object Symbol]",Xb="[object Date]",Zb="[object Map]",Qb="[object Set]",e0="[object Array]",t0="[object ArrayBuffer]",s0="[object Object]",i0="[object DataView]",r0="[object Uint8Array]",n0="[object Uint8ClampedArray]",o0="[object Uint16Array]",a0="[object Uint32Array]",c0="[object Int8Array]",l0="[object Int16Array]",h0="[object Int32Array]",u0="[object Float32Array]",p0="[object Float64Array]";function ya(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)}function d0(t,e){return Js(t,void 0,t,new Map,e)}function Js(t,e,s,i=new Map,r=void 0){let n=r?.(t,e,s,i);if(n!=null)return n;if(ga(t))return t;if(i.has(t))return i.get(t);if(Array.isArray(t)){let o=new Array(t.length);i.set(t,o);for(let a=0;a<t.length;a++)o[a]=Js(t[a],a,s,i,r);return Object.hasOwn(t,"index")&&(o.index=t.index),Object.hasOwn(t,"input")&&(o.input=t.input),o}if(t instanceof Date)return new Date(t.getTime());if(t instanceof RegExp){let o=new RegExp(t.source,t.flags);return o.lastIndex=t.lastIndex,o}if(t instanceof Map){let o=new Map;i.set(t,o);for(let[a,c]of t)o.set(a,Js(c,a,s,i,r));return o}if(t instanceof Set){let o=new Set;i.set(t,o);for(let a of t)o.add(Js(a,void 0,s,i,r));return o}if(typeof K<"u"&&K.isBuffer(t))return t.subarray();if(ya(t)){let o=new(Object.getPrototypeOf(t)).constructor(t.length);i.set(t,o);for(let a=0;a<t.length;a++)o[a]=Js(t[a],a,s,i,r);return o}if(t instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&t instanceof SharedArrayBuffer)return t.slice(0);if(t instanceof DataView){let o=new DataView(t.buffer.slice(0),t.byteOffset,t.byteLength);return i.set(t,o),Ss(o,t,s,i,r),o}if(typeof File<"u"&&t instanceof File){let o=new File([t],t.name,{type:t.type});return i.set(t,o),Ss(o,t,s,i,r),o}if(t instanceof Blob){let o=new Blob([t],{type:t.type});return i.set(t,o),Ss(o,t,s,i,r),o}if(t instanceof Error){let o=new t.constructor;return i.set(t,o),o.message=t.message,o.name=t.name,o.stack=t.stack,o.cause=t.cause,Ss(o,t,s,i,r),o}if(typeof t=="object"&&f0(t)){let o=Object.create(Object.getPrototypeOf(t));return i.set(t,o),Ss(o,t,s,i,r),o}return t}function Ss(t,e,s=t,i,r){let n=[...Object.keys(e),...Tu(e)];for(let o=0;o<n.length;o++){let a=n[o],c=Object.getOwnPropertyDescriptor(t,a);(c==null||c.writable)&&(t[a]=Js(e[a],a,s,i,r))}}function f0(t){switch(xu(t)){case ju:case e0:case t0:case i0:case Nu:case Xb:case u0:case p0:case c0:case l0:case h0:case Zb:case Cu:case s0:case Yb:case Qb:case Au:case Jb:case r0:case n0:case o0:case a0:return!0;default:return!1}}function g0(t,e){return d0(t,(s,i,r,n)=>{let o=e?.(s,i,r,n);if(o!=null)return o;if(typeof t=="object")switch(Object.prototype.toString.call(t)){case Cu:case Au:case Nu:{let a=new t.constructor(t?.valueOf());return Ss(a,t),a}case ju:{let a={};return Ss(a,t),a.length=t.length,a[Symbol.iterator]=t[Symbol.iterator],a}default:return}})}function lu(t){return g0(t)}function hu(t){return t!==null&&typeof t=="object"&&xu(t)==="[object Arguments]"}function uu(t){return typeof t=="object"&&t!==null}function y0(){}function m0(t){return ya(t)}function w0(t){if(typeof t!="object"||t==null)return!1;if(Object.getPrototypeOf(t)===null)return!0;if(Object.prototype.toString.call(t)!=="[object Object]"){let s=t[Symbol.toStringTag];return s==null||!Object.getOwnPropertyDescriptor(t,Symbol.toStringTag)?.writable?!1:t.toString()===`[object ${s}]`}let e=t;for(;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(t)===e}function b0(t){if(ga(t))return t;if(Array.isArray(t)||ya(t)||t instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&t instanceof SharedArrayBuffer)return t.slice(0);let e=Object.getPrototypeOf(t),s=e.constructor;if(t instanceof Date||t instanceof Map||t instanceof Set)return new s(t);if(t instanceof RegExp){let i=new s(t);return i.lastIndex=t.lastIndex,i}if(t instanceof DataView)return new s(t.buffer.slice(0));if(t instanceof Error){let i=new s(t.message);return i.stack=t.stack,i.name=t.name,i.cause=t.cause,i}if(typeof File<"u"&&t instanceof File)return new s([t],t.name,{type:t.type,lastModified:t.lastModified});if(typeof t=="object"){let i=Object.create(e);return Object.assign(i,t)}return t}function v0(t,...e){let s=e.slice(0,-1),i=e[e.length-1],r=t;for(let n=0;n<s.length;n++){let o=s[n];r=ca(r,o,i,new Map)}return r}function ca(t,e,s,i){if(ga(t)&&(t=Object(t)),e==null||typeof e!="object")return t;if(i.has(e))return b0(i.get(e));if(i.set(e,t),Array.isArray(e)){e=e.slice();for(let n=0;n<e.length;n++)e[n]=e[n]??void 0}let r=[...Object.keys(e),...Tu(e)];for(let n=0;n<r.length;n++){let o=r[n],a=e[o],c=t[o];if(hu(a)&&(a={...a}),hu(c)&&(c={...c}),typeof K<"u"&&K.isBuffer(a)&&(a=lu(a)),Array.isArray(a))if(typeof c=="object"&&c!=null){let h=[],u=Reflect.ownKeys(c);for(let p=0;p<u.length;p++){let d=u[p];h[d]=c[d]}c=h}else c=[];let l=s(c,a,o,t,e,i);l!=null?t[o]=l:Array.isArray(a)||uu(c)&&uu(a)?t[o]=ca(c,a,s,i):c==null&&w0(a)?t[o]=ca({},a,s,i):c==null&&m0(a)?t[o]=lu(a):(c===void 0||a!==void 0)&&(t[o]=a)}return t}function E0(t,...e){return v0(t,...e,y0)}var pu="error",_0="wss://relay.walletconnect.org",I0="wc",qu="universal_provider",Cr=`${I0}@2:${qu}:`,ku="https://rpc.walletconnect.org/v1/",Lu="generic",S0=`${ku}bundler`,Xs="call_status",O0=86400,ma={DEFAULT_CHAIN_CHANGED:"default_chain_changed"},P0=Object.defineProperty,R0=Object.defineProperties,T0=Object.getOwnPropertyDescriptors,du=Object.getOwnPropertySymbols,x0=Object.prototype.hasOwnProperty,A0=Object.prototype.propertyIsEnumerable,fu=(t,e,s)=>e in t?P0(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Nr=(t,e)=>{for(var s in e||(e={}))x0.call(e,s)&&fu(t,s,e[s]);if(du)for(var s of du(e))A0.call(e,s)&&fu(t,s,e[s]);return t},C0=(t,e)=>R0(t,T0(e));function Fu(t,e,s){var i;let r=ft(t);return((i=e.rpcMap)==null?void 0:i[r.reference])||`${ku}?chainId=${r.namespace}:${r.reference}&projectId=${s}`}function N0(t){return t.includes(":")?t.split(":")[1]:t}function Du(t){return t.map(e=>`${e.split(":")[0]}:${e.split(":")[1]}`)}function j0(t,e){let s=Object.keys(e.namespaces).filter(r=>r.includes(t));if(!s.length)return[];let i=[];return s.forEach(r=>{let n=e.namespaces[r].accounts;i.push(...n)}),i}function gu(t){return Object.fromEntries(Object.entries(t).filter(([e,s])=>{var i,r;return((i=s?.chains)==null?void 0:i.length)&&((r=s?.chains)==null?void 0:r.length)>0}))}function jr(t={},e={}){let s=gu(yu(t)),i=gu(yu(e));return E0(s,i)}function yu(t){var e,s,i,r,n;let o={};if(!st(t))return o;for(let[a,c]of Object.entries(t)){let l=Ii(a)?[a]:c.chains,h=c.methods||[],u=c.events||[],p=c.rpcMap||{},d=_s(a);o[d]=C0(Nr(Nr({},o[d]),c),{chains:ht(l,(e=o[d])==null?void 0:e.chains),methods:ht(h,(s=o[d])==null?void 0:s.methods),events:ht(u,(i=o[d])==null?void 0:i.events)}),(st(p)||st(((r=o[d])==null?void 0:r.rpcMap)||{}))&&(o[d].rpcMap=Nr(Nr({},p),(n=o[d])==null?void 0:n.rpcMap))}return o}function mu(t){return t.includes(":")?t.split(":")[2]:t}function wu(t){let e={};for(let[s,i]of Object.entries(t)){let r=i.methods||[],n=i.events||[],o=i.accounts||[],a=Ii(s)?[s]:i.chains?i.chains:Du(i.accounts);e[s]={chains:a,methods:r,events:n,accounts:o}}return e}function sa(t){return typeof t=="number"?t:t.includes("0x")?parseInt(t,16):(t=t.includes(":")?t.split(":")[1]:t,isNaN(Number(t))?t:Number(t))}function q0(t){try{let e=JSON.parse(t);return typeof e=="object"&&e!==null&&!Array.isArray(e)}catch{return!1}}var Uu={},Zs=t=>Uu[t],ia=(t,e)=>{Uu[t]=e},k0=Object.defineProperty,bu=Object.getOwnPropertySymbols,L0=Object.prototype.hasOwnProperty,F0=Object.prototype.propertyIsEnumerable,vu=(t,e,s)=>e in t?k0(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Eu=(t,e)=>{for(var s in e||(e={}))L0.call(e,s)&&vu(t,s,e[s]);if(bu)for(var s of bu(e))F0.call(e,s)&&vu(t,s,e[s]);return t},_u="eip155",D0=["atomic","flow-control","paymasterService","sessionKeys","auxiliaryFunds"],U0=t=>t&&t.startsWith("0x")?BigInt(t).toString(10):t,ra=t=>t&&t.startsWith("0x")?t:`0x${BigInt(t).toString(16)}`,Iu=t=>Object.keys(t).filter(e=>D0.includes(e)).reduce((e,s)=>(e[s]=B0(t[s]),e),{}),B0=t=>typeof t=="string"&&q0(t)?JSON.parse(t):t,$0=(t,e,s)=>{let{sessionProperties:i={},scopedProperties:r={}}=t,n={};if(!st(r)&&!st(i))return;let o=Iu(i);for(let a of s){let c=U0(a);if(!c)continue;n[ra(c)]=o;let l=r?.[`${_u}:${c}`];if(l){let h=l?.[`${_u}:${c}:${e}`];n[ra(c)]=Eu(Eu({},n[ra(c)]),Iu(h||l))}}for(let[a,c]of Object.entries(n))Object.keys(c).length===0&&delete n[a];return Object.keys(n).length>0?n:void 0},M0=Object.defineProperty,V0=(t,e,s)=>e in t?M0(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,z0=(t,e,s)=>V0(t,typeof e!="symbol"?e+"":e,s),na,la=class t{constructor(e){z0(this,"storage"),this.storage=e}async getItem(e){return await this.storage.getItem(e)}async setItem(e,s){return await this.storage.setItem(e,s)}async removeItem(e){return await this.storage.removeItem(e)}static getStorage(e){return na||(na=new t(e)),na}},K0=Object.defineProperty,H0=Object.defineProperties,G0=Object.getOwnPropertyDescriptors,Su=Object.getOwnPropertySymbols,W0=Object.prototype.hasOwnProperty,Y0=Object.prototype.propertyIsEnumerable,Ou=(t,e,s)=>e in t?K0(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,J0=(t,e)=>{for(var s in e||(e={}))W0.call(e,s)&&Ou(t,s,e[s]);if(Su)for(var s of Su(e))Y0.call(e,s)&&Ou(t,s,e[s]);return t},X0=(t,e)=>H0(t,G0(e));async function Z0(t,e){let s=ft(t.result.capabilities.caip345.caip2),i=t.result.capabilities.caip345.transactionHashes,r=await Promise.allSettled(i.map(u=>Q0(s.reference,u,e))),n=r.filter(u=>u.status==="fulfilled").map(u=>u.value).filter(u=>u);r.filter(u=>u.status==="rejected").forEach(u=>console.warn("Failed to fetch transaction receipt:",u.reason));let o=!n.length||n.some(u=>!u),a=n.every(u=>u?.status==="0x1"),c=n.every(u=>u?.status==="0x0"),l=n.some(u=>u?.status==="0x0"),h;return o?h=100:a?h=200:c?h=500:l&&(h=600),{id:t.result.id,version:t.request.version,atomic:t.request.atomicRequired,chainId:t.request.chainId,capabilities:t.result.capabilities,receipts:n,status:h}}async function Q0(t,e,s){return await s(parseInt(t)).request(ze("eth_getTransactionReceipt",[e]))}async function ev({sendCalls:t,storage:e}){let s=await e.getItem(Xs);await e.setItem(Xs,X0(J0({},s),{[t.result.id]:{request:t.request,result:t.result,expiry:ce(O0)}}))}async function tv({resultId:t,storage:e}){let s=await e.getItem(Xs);if(s){delete s[t],await e.setItem(Xs,s);for(let i in s)Ge(s[i].expiry)&&delete s[i];await e.setItem(Xs,s)}}async function sv({resultId:t,storage:e}){let s=await e.getItem(Xs),i=s?.[t];if(i&&!Ge(i.expiry))return i;await tv({resultId:t,storage:e})}var iv=Object.defineProperty,rv=Object.defineProperties,nv=Object.getOwnPropertyDescriptors,Pu=Object.getOwnPropertySymbols,ov=Object.prototype.hasOwnProperty,av=Object.prototype.propertyIsEnumerable,ha=(t,e,s)=>e in t?iv(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,oa=(t,e)=>{for(var s in e||(e={}))ov.call(e,s)&&ha(t,s,e[s]);if(Pu)for(var s of Pu(e))av.call(e,s)&&ha(t,s,e[s]);return t},aa=(t,e)=>rv(t,nv(e)),Is=(t,e,s)=>ha(t,typeof e!="symbol"?e+"":e,s),ua=class{constructor(e){Is(this,"name","eip155"),Is(this,"client"),Is(this,"chainId"),Is(this,"namespace"),Is(this,"httpProviders"),Is(this,"events"),Is(this,"storage"),this.namespace=e.namespace,this.events=Zs("events"),this.client=Zs("client"),this.httpProviders=this.createHttpProviders(),this.chainId=parseInt(this.getDefaultChain()),this.storage=la.getStorage(this.client.core.storage)}async request(e){switch(e.request.method){case"eth_requestAccounts":return this.getAccounts();case"eth_accounts":return this.getAccounts();case"wallet_switchEthereumChain":return await this.handleSwitchChain(e);case"eth_chainId":return parseInt(this.getDefaultChain());case"wallet_getCapabilities":return await this.getCapabilities(e);case"wallet_getCallsStatus":return await this.getCallStatus(e);case"wallet_sendCalls":return await this.sendCalls(e)}return this.namespace.methods.includes(e.request.method)?await this.client.request(e):this.getHttpProvider().request(e.request)}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}setDefaultChain(e,s){this.httpProviders[e]||this.setHttpProvider(parseInt(e),s);let i=this.chainId;this.chainId=parseInt(e),this.events.emit(ma.DEFAULT_CHAIN_CHANGED,{currentCaipChainId:`${this.name}:${e}`,previousCaipChainId:`${this.name}:${i}`})}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId.toString();if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}createHttpProvider(e,s){let i=s||Fu(`${this.name}:${e}`,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new ii(new ji(i,Zs("disableProviderPing")))}setHttpProvider(e,s){let i=this.createHttpProvider(e,s);i&&(this.httpProviders[e]=i)}createHttpProviders(){let e={};return this.namespace.chains.forEach(s=>{var i;let r=parseInt(N0(s));e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[s])}),e}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(s=>s.split(":")[1]===this.chainId.toString()).map(s=>s.split(":")[2]))]:[]}getHttpProvider(e){let s=e||this.chainId;return this.httpProviders[s]||(this.httpProviders=aa(oa({},this.httpProviders),{[s]:this.createHttpProvider(s)}),this.httpProviders[s])}async handleSwitchChain(e){var s,i;let r=e.request.params?(s=e.request.params[0])==null?void 0:s.chainId:"0x0";r=r.startsWith("0x")?r:`0x${r}`;let n=parseInt(r,16);if(this.isChainApproved(n))this.setDefaultChain(`${n}`);else if(this.namespace.methods.includes("wallet_switchEthereumChain"))await this.client.request({topic:e.topic,request:{method:e.request.method,params:[{chainId:r}]},chainId:(i=this.namespace.chains)==null?void 0:i[0]}),this.setDefaultChain(`${n}`);else throw new Error(`Failed to switch to chain 'eip155:${n}'. The chain is not approved or the wallet does not support 'wallet_switchEthereumChain' method.`);return null}isChainApproved(e){return this.namespace.chains.includes(`${this.name}:${e}`)}async getCapabilities(e){var s,i,r,n,o;let a=(i=(s=e.request)==null?void 0:s.params)==null?void 0:i[0],c=((n=(r=e.request)==null?void 0:r.params)==null?void 0:n[1])||[];if(!a)throw new Error("Missing address parameter in `wallet_getCapabilities` request");let l=this.client.session.get(e.topic),h=((o=l?.sessionProperties)==null?void 0:o.capabilities)||{},u=c.length>0?c.join(","):`0x${this.chainId.toString(16)}`,p=`${a}${u}`,d=h?.[p];if(d)return d;let f;try{f=$0(l,a,c)}catch(y){console.warn("Failed to extract capabilities from session",y)}if(f)return f;let g=await this.client.request(e);try{await this.client.session.update(e.topic,{sessionProperties:aa(oa({},l.sessionProperties||{}),{capabilities:aa(oa({},h||{}),{[p]:g})})})}catch(y){console.warn("Failed to update session with capabilities",y)}return g}async getCallStatus(e){var s,i,r;let n=this.client.session.get(e.topic),o=(s=n.sessionProperties)==null?void 0:s.bundler_name;if(o){let l=this.getBundlerUrl(e.chainId,o);try{return await this.getUserOperationReceipt(l,e)}catch(h){console.warn("Failed to fetch call status from bundler",h,l)}}let a=(i=n.sessionProperties)==null?void 0:i.bundler_url;if(a)try{return await this.getUserOperationReceipt(a,e)}catch(l){console.warn("Failed to fetch call status from custom bundler",l,a)}let c=await sv({resultId:(r=e.request.params)==null?void 0:r[0],storage:this.storage});if(c)try{return await Z0(c,this.getHttpProvider.bind(this))}catch(l){console.warn("Failed to fetch call status from stored send calls",l,c)}if(this.namespace.methods.includes(e.request.method))return await this.client.request(e);throw new Error("Fetching call status not approved by the wallet.")}async getUserOperationReceipt(e,s){var i;let r=new URL(e),n=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ze("eth_getUserOperationReceipt",[(i=s.request.params)==null?void 0:i[0]]))});if(!n.ok)throw new Error(`Failed to fetch user operation receipt - ${n.status}`);return await n.json()}getBundlerUrl(e,s){return`${S0}?projectId=${this.client.core.projectId}&chainId=${e}&bundler=${s}`}async sendCalls(e){var s,i,r;let n=await this.client.request(e),o=(s=e.request.params)==null?void 0:s[0],a=n?.id,c=n?.capabilities||{},l=(i=c?.caip345)==null?void 0:i.caip2,h=(r=c?.caip345)==null?void 0:r.transactionHashes;return!a||!l||!(h!=null&&h.length)||await ev({sendCalls:{request:o,result:n},storage:this.storage}),n}},cv=Object.defineProperty,lv=(t,e,s)=>e in t?cv(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Ys=(t,e,s)=>lv(t,typeof e!="symbol"?e+"":e,s),pa=class{constructor(e){Ys(this,"name",Lu),Ys(this,"client"),Ys(this,"httpProviders"),Ys(this,"events"),Ys(this,"namespace"),Ys(this,"chainId"),this.namespace=e.namespace,this.events=Zs("events"),this.client=Zs("client"),this.chainId=this.getDefaultChain(),this.name=this.getNamespaceName(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace.chains=[...new Set((this.namespace.chains||[]).concat(e.chains||[]))],this.namespace.accounts=[...new Set((this.namespace.accounts||[]).concat(e.accounts||[]))],this.namespace.methods=[...new Set((this.namespace.methods||[]).concat(e.methods||[]))],this.namespace.events=[...new Set((this.namespace.events||[]).concat(e.events||[]))],this.httpProviders=this.createHttpProviders()}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider(e.chainId).request(e.request)}setDefaultChain(e,s){this.httpProviders[e]||this.setHttpProvider(e,s);let i=this.chainId;this.chainId=e,this.events.emit(ma.DEFAULT_CHAIN_CHANGED,{currentCaipChainId:`${this.name}:${e}`,previousCaipChainId:`${this.name}:${i}`})}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getNamespaceName(){let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return ft(e).namespace}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(s=>s.split(":")[1]===this.chainId.toString()).map(s=>s.split(":")[2]))]:[]}createHttpProviders(){var e,s;let i={};return(s=(e=this.namespace)==null?void 0:e.accounts)==null||s.forEach(r=>{var n,o;let a=ft(r),c=(o=(n=this.namespace)==null?void 0:n.rpcMap)==null?void 0:o[`${a.namespace}:${a.reference}`];i[a.reference]=this.createHttpProvider(r,c)}),i}getHttpProvider(e){let s=ft(e).reference,i=this.httpProviders[s];if(typeof i>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return i}setHttpProvider(e,s){let i=this.createHttpProvider(e,s);i&&(this.httpProviders[e]=i)}createHttpProvider(e,s){let i=s||Fu(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new ii(new ji(i,Zs("disableProviderPing")))}},hv=Object.defineProperty,uv=Object.defineProperties,pv=Object.getOwnPropertyDescriptors,Ru=Object.getOwnPropertySymbols,dv=Object.prototype.hasOwnProperty,fv=Object.prototype.propertyIsEnumerable,da=(t,e,s)=>e in t?hv(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Ai=(t,e)=>{for(var s in e||(e={}))dv.call(e,s)&&da(t,s,e[s]);if(Ru)for(var s of Ru(e))fv.call(e,s)&&da(t,s,e[s]);return t},qr=(t,e)=>uv(t,pv(e)),Xe=(t,e,s)=>da(t,typeof e!="symbol"?e+"":e,s),fa=class t{constructor(e){Xe(this,"client"),Xe(this,"namespaces"),Xe(this,"optionalNamespaces"),Xe(this,"sessionProperties"),Xe(this,"scopedProperties"),Xe(this,"events",new hs),Xe(this,"rpcProviders",{}),Xe(this,"session"),Xe(this,"providerOpts"),Xe(this,"logger"),Xe(this,"uri"),Xe(this,"disableProviderPing",!1),Xe(this,"connectParams");var s,i;this.providerOpts=e,this.logger=Vs({logger:(s=e.logger)!=null?s:pu,name:(i=this.providerOpts.name)!=null?i:qu}),this.disableProviderPing=e?.disableProviderPing||!1}static async init(e){let s=new t(e);return await s.initialize(),s}async request(e,s,i){let[r,n]=this.validateChain(s);if(!this.session)throw new Error("Please call connect() before request()");return await this.getProvider(r).request({request:Ai({},e),chainId:`${r}:${n}`,topic:this.session.topic,expiry:i})}sendAsync(e,s,i,r){let n=new Date().getTime();this.request(e,i,r).then(o=>s(null,Ut(n,o))).catch(o=>s(o,void 0))}async enable(){if(!this.client)throw new Error("Sign Client not initialized");return this.session||await this.connect({namespaces:this.namespaces,optionalNamespaces:this.optionalNamespaces,sessionProperties:this.sessionProperties,scopedProperties:this.scopedProperties}),await this.requestAccounts()}async disconnect(){var e;if(!this.session)throw new Error("Please call connect() before enable()");await this.client.disconnect({topic:(e=this.session)==null?void 0:e.topic,reason:ie("USER_DISCONNECTED")}),await this.cleanup()}async connect(e){if(!this.client)throw new Error("Sign Client not initialized");if(this.connectParams=e,this.setNamespaces(e),this.cleanupPendingPairings(),!e.skipPairing)return await this.pair(e.pairingTopic)}async authenticate(e,s){if(!this.client)throw new Error("Sign Client not initialized");this.setNamespaces(e),await this.cleanupPendingPairings();let{uri:i,response:r}=await this.client.authenticate(e,s);i&&(this.uri=i,this.events.emit("display_uri",i));let n=await r();if(this.session=n.session,this.session){let o=wu(this.session.namespaces);this.namespaces=jr(this.namespaces,o),await this.persist("namespaces",this.namespaces),this.onConnect()}return n}on(e,s){this.events.on(e,s)}once(e,s){this.events.once(e,s)}removeListener(e,s){this.events.removeListener(e,s)}off(e,s){this.events.off(e,s)}get isWalletConnect(){return!0}async pair(e){var s,i;let{uri:r,approval:n}=await this.client.connect({pairingTopic:e,requiredNamespaces:this.namespaces,optionalNamespaces:this.optionalNamespaces,sessionProperties:this.sessionProperties,scopedProperties:this.scopedProperties,authentication:(s=this.connectParams)==null?void 0:s.authentication,walletPay:(i=this.connectParams)==null?void 0:i.walletPay});r&&(this.uri=r,this.events.emit("display_uri",r));let o=await n();this.session=o;let a=wu(o.namespaces);return this.namespaces=jr(this.namespaces,a),await this.persist("namespaces",this.namespaces),await this.persist("optionalNamespaces",this.optionalNamespaces),this.onConnect(),this.session}setDefaultChain(e,s){try{if(!this.session)return;let[i,r]=this.validateChain(e);this.getProvider(i).setDefaultChain(r,s)}catch(i){if(!/Please call connect/.test(i.message))throw i}}async cleanupPendingPairings(e={}){try{this.logger.info("Cleaning up inactive pairings...");let s=this.client.pairing.getAll();if(!je(s))return;for(let i of s)e.deletePairings?this.client.core.expirer.set(i.topic,0):await this.client.core.relayer.subscriber.unsubscribe(i.topic);this.logger.info(`Inactive pairings cleared: ${s.length}`)}catch(s){this.logger.warn(s,"Failed to cleanup pending pairings")}}abortPairingAttempt(){this.logger.warn("abortPairingAttempt is deprecated. This is now a no-op.")}async checkStorage(){this.namespaces=await this.getFromStore("namespaces")||{},this.optionalNamespaces=await this.getFromStore("optionalNamespaces")||{},this.session&&this.createProviders()}async initialize(){this.logger.trace("Initialized"),await this.createClient(),await this.checkStorage(),this.registerEventListeners()}async createClient(){var e,s;if(this.client=this.providerOpts.client||await cu.init({core:this.providerOpts.core,logger:this.providerOpts.logger||pu,relayUrl:this.providerOpts.relayUrl||_0,projectId:this.providerOpts.projectId,metadata:this.providerOpts.metadata,storageOptions:this.providerOpts.storageOptions,storage:this.providerOpts.storage,name:this.providerOpts.name,customStoragePrefix:this.providerOpts.customStoragePrefix,telemetryEnabled:this.providerOpts.telemetryEnabled}),this.providerOpts.session)try{this.session=this.client.session.get(this.providerOpts.session.topic)}catch(i){throw this.logger.error(i,"Failed to get session"),new Error(`The provided session: ${(s=(e=this.providerOpts)==null?void 0:e.session)==null?void 0:s.topic} doesn't exist in the Sign client`)}else{let i=this.client.session.getAll();this.session=i[0]}this.logger.trace("SignClient Initialized")}createProviders(){if(!this.client)throw new Error("Sign Client not initialized");if(!this.session)throw new Error("Session not initialized. Please call connect() before enable()");let e=[...new Set(Object.keys(this.session.namespaces).map(s=>_s(s)))];ia("client",this.client),ia("events",this.events),ia("disableProviderPing",this.disableProviderPing),e.forEach(s=>{if(!this.session)return;let i=j0(s,this.session);if(i?.length===0)return;let r=Du(i),n=jr(this.namespaces,this.optionalNamespaces),o=qr(Ai({},n[s]),{accounts:i,chains:r});switch(s){case"eip155":this.rpcProviders[s]=new ua({namespace:o});break;default:this.rpcProviders[s]=new pa({namespace:o})}})}registerEventListeners(){if(typeof this.client>"u")throw new Error("Sign Client is not initialized");this.client.on("session_ping",e=>{var s;let{topic:i}=e;i===((s=this.session)==null?void 0:s.topic)&&this.events.emit("session_ping",e)}),this.client.on("session_event",e=>{var s;let{params:i,topic:r}=e;if(r!==((s=this.session)==null?void 0:s.topic))return;let{event:n}=i;if(n.name==="accountsChanged"){let o=n.data;o&&je(o)&&this.events.emit("accountsChanged",o.map(mu))}else if(n.name==="chainChanged"){let o=i.chainId,a=i.event.data,c=_s(o),l=sa(o)!==sa(a)?`${c}:${sa(a)}`:o;this.onChainChanged({currentCaipChainId:l})}else this.events.emit(n.name,n.data);this.events.emit("session_event",e)}),this.client.on("session_update",({topic:e,params:s})=>{var i,r;if(e!==((i=this.session)==null?void 0:i.topic))return;let{namespaces:n}=s,o=(r=this.client)==null?void 0:r.session.get(e);this.session=qr(Ai({},o),{namespaces:n}),this.onSessionUpdate(),this.events.emit("session_update",{topic:e,params:s})}),this.client.on("session_delete",async e=>{var s;e.topic===((s=this.session)==null?void 0:s.topic)&&(await this.cleanup(),this.events.emit("session_delete",e),this.events.emit("disconnect",qr(Ai({},ie("USER_DISCONNECTED")),{data:e.topic})))}),this.on(ma.DEFAULT_CHAIN_CHANGED,e=>{this.onChainChanged(qr(Ai({},e),{internal:!0}))})}getProvider(e){return this.rpcProviders[e]||this.rpcProviders[Lu]}onSessionUpdate(){Object.keys(this.rpcProviders).forEach(e=>{var s;this.getProvider(e).updateNamespace((s=this.session)==null?void 0:s.namespaces[e])})}setNamespaces(e){let{namespaces:s={},optionalNamespaces:i={},sessionProperties:r,scopedProperties:n}=e;this.optionalNamespaces=jr(s,i),this.sessionProperties=r,this.scopedProperties=n}validateChain(e){let[s,i]=e?.split(":")||["",""];if(!this.namespaces||!Object.keys(this.namespaces).length)return[s,i];if(s&&!Object.keys(this.namespaces||{}).map(o=>_s(o)).includes(s))throw new Error(`Namespace '${s}' is not configured. Please call connect() first with namespace config.`);if(s&&i)return[s,i];let r=_s(Object.keys(this.namespaces)[0]),n=this.rpcProviders[r].getDefaultChain();return[r,n]}async requestAccounts(){let[e]=this.validateChain();return await this.getProvider(e).requestAccounts()}async onChainChanged({currentCaipChainId:e,previousCaipChainId:s,internal:i=!1}){if(!this.namespaces)return;let[r,n]=this.validateChain(e);n&&(this.updateNamespaceChain(r,n),i?(this.events.emit("chainChanged",n),this.emitAccountsChangedOnChainChange({namespace:r,currentCaipChainId:e,previousCaipChainId:s})):this.getProvider(r).setDefaultChain(n),await this.persist("namespaces",this.namespaces))}emitAccountsChangedOnChainChange({namespace:e,currentCaipChainId:s,previousCaipChainId:i}){var r,n;try{if(i===s)return;let o=(n=(r=this.session)==null?void 0:r.namespaces[e])==null?void 0:n.accounts;if(!o)return;let a=o.filter(c=>c.includes(`${s}:`)).map(mu);if(!je(a))return;this.events.emit("accountsChanged",a)}catch(o){this.logger.warn(o,"Failed to emit accountsChanged on chain change")}}updateNamespaceChain(e,s){if(!this.namespaces)return;let i=this.namespaces[e]?e:`${e}:${s}`,r={chains:[],methods:[],events:[],defaultChain:s};this.namespaces[i]?this.namespaces[i]&&(this.namespaces[i].defaultChain=s):this.namespaces[i]=r}onConnect(){this.createProviders(),this.events.emit("connect",{session:this.session})}async cleanup(){this.connectParams=void 0,this.namespaces=void 0,this.optionalNamespaces=void 0,this.sessionProperties=void 0,await this.deleteFromStore("namespaces"),await this.deleteFromStore("optionalNamespaces"),await this.deleteFromStore("sessionProperties"),this.session=void 0,this.cleanupPendingPairings({deletePairings:!0}),await this.cleanupStorage()}async persist(e,s){var i;let r=((i=this.session)==null?void 0:i.topic)||"";await this.client.core.storage.setItem(`${Cr}/${e}${r}`,s)}async getFromStore(e){var s;let i=((s=this.session)==null?void 0:s.topic)||"";return await this.client.core.storage.getItem(`${Cr}/${e}${i}`)}async deleteFromStore(e){var s;let i=((s=this.session)==null?void 0:s.topic)||"";await this.client.core.storage.removeItem(`${Cr}/${e}${i}`)}async cleanupStorage(){var e;try{if(((e=this.client)==null?void 0:e.session.length)>0)return;let s=await this.client.core.storage.getKeys();for(let i of s)i.startsWith(Cr)&&await this.client.core.storage.removeItem(i)}catch(s){this.logger.warn(s,"Failed to cleanup storage")}}},Bu=fa;var gv="wc",yv="ethereum_provider",mv=`${gv}@2:${yv}:`,wv="https://rpc.walletconnect.org/v1/",wa=["eth_sendTransaction","personal_sign"],bv=["eth_accounts","eth_requestAccounts","eth_sendRawTransaction","eth_sign","eth_signTransaction","eth_signTypedData","eth_signTypedData_v3","eth_signTypedData_v4","eth_sendTransaction","personal_sign","wallet_switchEthereumChain","wallet_addEthereumChain","wallet_getPermissions","wallet_requestPermissions","wallet_registerOnboarding","wallet_watchAsset","wallet_scanQRCode","wallet_sendCalls","wallet_getCapabilities","wallet_getCallsStatus","wallet_showCallsStatus"],ba=["chainChanged","accountsChanged"],vv=["chainChanged","accountsChanged","message","disconnect","connect"],Ev=async()=>{let{createAppKit:t}=await import("./core-GBTMLYWT.js");return t},_v=Object.defineProperty,Iv=Object.defineProperties,Sv=Object.getOwnPropertyDescriptors,$u=Object.getOwnPropertySymbols,Ov=Object.prototype.hasOwnProperty,Pv=Object.prototype.propertyIsEnumerable,va=(t,e,s)=>e in t?_v(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Os=(t,e)=>{for(var s in e||(e={}))Ov.call(e,s)&&va(t,s,e[s]);if($u)for(var s of $u(e))Pv.call(e,s)&&va(t,s,e[s]);return t},Ci=(t,e)=>Iv(t,Sv(e)),Ze=(t,e,s)=>va(t,typeof e!="symbol"?e+"":e,s);function Lr(t){return Number(t[0].split(":")[1])}function kr(t){return`0x${t.toString(16)}`}function Rv(t){let{chains:e,optionalChains:s,methods:i,optionalMethods:r,events:n,optionalEvents:o,rpcMap:a}=t;if(!je(e))throw new Error("Invalid chains");let c={chains:e,methods:i||wa,events:n||ba,rpcMap:Os({},e.length?{[Lr(e)]:a[Lr(e)]}:{})},l=n?.filter(d=>!ba.includes(d)),h=i?.filter(d=>!wa.includes(d));if(!s&&!o&&!r&&!(l!=null&&l.length)&&!(h!=null&&h.length))return{required:e.length?c:void 0};let u=l?.length&&h?.length||!s,p={chains:[...new Set(u?c.chains.concat(s||[]):s)],methods:[...new Set(c.methods.concat(r!=null&&r.length?r:bv))],events:[...new Set(c.events.concat(o!=null&&o.length?o:vv))],rpcMap:a};return{required:e.length?c:void 0,optional:s.length?p:void 0}}var Ea=class t{constructor(){Ze(this,"events",new Qe),Ze(this,"namespace","eip155"),Ze(this,"accounts",[]),Ze(this,"signer"),Ze(this,"chainId",1),Ze(this,"modal"),Ze(this,"rpc"),Ze(this,"STORAGE_KEY",mv),Ze(this,"on",(e,s)=>(this.events.on(e,s),this)),Ze(this,"once",(e,s)=>(this.events.once(e,s),this)),Ze(this,"removeListener",(e,s)=>(this.events.removeListener(e,s),this)),Ze(this,"off",(e,s)=>(this.events.off(e,s),this)),Ze(this,"parseAccount",e=>this.isCompatibleChainId(e)?this.parseAccountId(e).address:e),this.signer={},this.rpc={}}static async init(e){let s=new t;return await s.initialize(e),s}async request(e,s){return await this.signer.request(e,this.formatChainId(this.chainId),s)}sendAsync(e,s,i){this.signer.sendAsync(e,s,this.formatChainId(this.chainId),i)}get connected(){return this.signer.client?this.signer.client.core.relayer.connected:!1}get connecting(){return this.signer.client?this.signer.client.core.relayer.connecting:!1}async enable(){return this.session||await this.connect(),await this.request({method:"eth_requestAccounts"})}async connect(e){var s;if(!this.signer.client)throw new Error("Provider not initialized. Call init() first");this.loadConnectOpts(e);let{required:i,optional:r}=Rv(this.rpc);try{let n=await new Promise(async(a,c)=>{var l,h;this.rpc.showQrModal&&((l=this.modal)==null||l.open(),(h=this.modal)==null||h.subscribeState(p=>{!p.open&&!this.signer.session&&(this.signer.abortPairingAttempt(),c(new Error("Connection request reset. Please try again.")))}));let u=e!=null&&e.scopedProperties?{[this.namespace]:e.scopedProperties}:void 0;await this.signer.connect(Ci(Os({namespaces:Os({},i&&{[this.namespace]:i})},r&&{optionalNamespaces:{[this.namespace]:r}}),{pairingTopic:e?.pairingTopic,scopedProperties:u})).then(p=>{a(p)}).catch(p=>{var d;(d=this.modal)==null||d.showErrorMessage("Unable to connect"),c(new Error(p.message))})});if(!n)return;let o=xn(n.namespaces,[this.namespace]);this.setChainIds(this.rpc.chains.length?this.rpc.chains:o),this.setAccounts(o),this.events.emit("connect",{chainId:kr(this.chainId)})}catch(n){throw this.signer.logger.error(n),n}finally{(s=this.modal)==null||s.close()}}async authenticate(e,s){var i;if(!this.signer.client)throw new Error("Provider not initialized. Call init() first");this.loadConnectOpts({chains:e?.chains});try{let r=await new Promise(async(o,a)=>{var c,l;this.rpc.showQrModal&&((c=this.modal)==null||c.open(),(l=this.modal)==null||l.subscribeState(h=>{!h.open&&!this.signer.session&&(this.signer.abortPairingAttempt(),a(new Error("Connection request reset. Please try again.")))})),await this.signer.authenticate(Ci(Os({},e),{chains:this.rpc.chains}),s).then(h=>{o(h)}).catch(h=>{var u;(u=this.modal)==null||u.showErrorMessage("Unable to connect"),a(new Error(h.message))})}),n=r.session;if(n){let o=xn(n.namespaces,[this.namespace]);this.setChainIds(this.rpc.chains.length?this.rpc.chains:o),this.setAccounts(o),this.events.emit("connect",{chainId:kr(this.chainId)})}return r}catch(r){throw this.signer.logger.error(r),r}finally{(i=this.modal)==null||i.close()}}async disconnect(){this.session&&await this.signer.disconnect(),this.reset()}get isWalletConnect(){return!0}get session(){return this.signer.session}registerEventListeners(){this.signer.on("session_event",e=>{let{params:s}=e,{event:i}=s;i.name==="accountsChanged"?(this.accounts=this.parseAccounts(i.data),this.events.emit("accountsChanged",this.accounts)):i.name==="chainChanged"?this.setChainId(this.formatChainId(i.data)):this.events.emit(i.name,i.data),this.events.emit("session_event",e)}),this.signer.on("accountsChanged",e=>{this.accounts=this.parseAccounts(e),this.events.emit("accountsChanged",this.accounts)}),this.signer.on("chainChanged",e=>{let s=parseInt(e);this.chainId=s,this.events.emit("chainChanged",kr(this.chainId)),this.persist()}),this.signer.on("session_update",e=>{this.events.emit("session_update",e)}),this.signer.on("session_delete",e=>{this.reset(),this.events.emit("session_delete",e),this.events.emit("disconnect",Ci(Os({},ie("USER_DISCONNECTED")),{data:e.topic,name:"USER_DISCONNECTED"}))}),this.signer.on("display_uri",e=>{this.events.emit("display_uri",e)})}switchEthereumChain(e){this.request({method:"wallet_switchEthereumChain",params:[{chainId:e.toString(16)}]})}isCompatibleChainId(e){return typeof e=="string"?e.startsWith(`${this.namespace}:`):!1}formatChainId(e){return`${this.namespace}:${e}`}parseChainId(e){return Number(e.split(":")[1])}setChainIds(e){let s=e.filter(i=>this.isCompatibleChainId(i)).map(i=>this.parseChainId(i));s.length&&(this.chainId=s[0],this.events.emit("chainChanged",kr(this.chainId)),this.persist())}setChainId(e){if(this.isCompatibleChainId(e)){let s=this.parseChainId(e);this.chainId=s,this.switchEthereumChain(s)}}parseAccountId(e){let[s,i,r]=e.split(":");return{chainId:`${s}:${i}`,address:r}}setAccounts(e){this.accounts=e.filter(s=>this.parseChainId(this.parseAccountId(s).chainId)===this.chainId).map(s=>this.parseAccountId(s).address),this.events.emit("accountsChanged",this.accounts)}getRpcConfig(e){var s,i;let r=(s=e?.chains)!=null?s:[],n=(i=e?.optionalChains)!=null?i:[],o=r.concat(n);if(!o.length)throw new Error("No chains specified in either `chains` or `optionalChains`");let a=r.length?e?.methods||wa:[],c=r.length?e?.events||ba:[],l=e?.optionalMethods||[],h=e?.optionalEvents||[],u=e?.rpcMap||this.buildRpcMap(o,e.projectId),p=e?.qrModalOptions||void 0;return{chains:r?.map(d=>this.formatChainId(d)),optionalChains:n.map(d=>this.formatChainId(d)),methods:a,events:c,optionalMethods:l,optionalEvents:h,rpcMap:u,showQrModal:!!(e!=null&&e.showQrModal),qrModalOptions:p,projectId:e.projectId,metadata:e.metadata}}buildRpcMap(e,s){let i={};return e.forEach(r=>{i[r]=this.getRpcUrl(r,s)}),i}async initialize(e){var s;if(this.rpc=this.getRpcConfig(e),this.chainId=this.rpc.chains.length?Lr(this.rpc.chains):Lr(this.rpc.optionalChains),this.signer=await Bu.init({projectId:this.rpc.projectId,metadata:this.rpc.metadata,disableProviderPing:e.disableProviderPing,relayUrl:e.relayUrl,storage:e.storage,storageOptions:e.storageOptions,customStoragePrefix:e.customStoragePrefix,telemetryEnabled:e.telemetryEnabled,logger:e.logger}),this.registerEventListeners(),await this.loadPersistedSession(),this.rpc.showQrModal){let i;try{let r=await Ev(),{convertWCMToAppKitOptions:n}=await Promise.resolve().then(function(){return Fv}),o=n(Ci(Os({},this.rpc.qrModalOptions),{chains:[...new Set([...this.rpc.chains,...this.rpc.optionalChains])],metadata:this.rpc.metadata,projectId:this.rpc.projectId}));if(!o.networks.length)throw new Error("No networks found for WalletConnect");i=r(Ci(Os({},o),{universalProvider:this.signer,manualWCControl:!0,enableMobileFullScreen:((s=this.rpc.qrModalOptions)==null?void 0:s.enableMobileFullScreen)===!0}))}catch(r){throw console.warn(r),new Error("To use QR modal, please install @reown/appkit package")}if(i)try{this.modal=i}catch(r){throw this.signer.logger.error(r),new Error("Could not generate WalletConnectModal Instance")}}}loadConnectOpts(e){if(!e)return;let{chains:s,optionalChains:i,rpcMap:r}=e;s&&je(s)&&(this.rpc.chains=s.map(n=>this.formatChainId(n)),s.forEach(n=>{this.rpc.rpcMap[n]=r?.[n]||this.getRpcUrl(n)})),i&&je(i)&&(this.rpc.optionalChains=[],this.rpc.optionalChains=i?.map(n=>this.formatChainId(n)),i.forEach(n=>{this.rpc.rpcMap[n]=r?.[n]||this.getRpcUrl(n)}))}getRpcUrl(e,s){var i;return((i=this.rpc.rpcMap)==null?void 0:i[e])||`${wv}?chainId=eip155:${e}&projectId=${s||this.rpc.projectId}`}async loadPersistedSession(){if(this.session)try{let e=await this.signer.client.core.storage.getItem(`${this.STORAGE_KEY}/chainId`),s=this.session.namespaces[`${this.namespace}:${e}`]?this.session.namespaces[`${this.namespace}:${e}`]:this.session.namespaces[this.namespace];this.setChainIds(e?[this.formatChainId(e)]:s?.accounts),this.setAccounts(s?.accounts)}catch(e){this.signer.logger.error("Failed to load persisted session, clearing state..."),this.signer.logger.error(e),await this.disconnect().catch(s=>this.signer.logger.warn(s))}}reset(){this.chainId=1,this.accounts=[]}persist(){this.session&&this.signer.client.core.storage.setItem(`${this.STORAGE_KEY}/chainId`,this.chainId)}parseAccounts(e){return typeof e=="string"||e instanceof String?[this.parseAccount(e)]:e.map(s=>this.parseAccount(s))}},Y1=Ea,Tv=Object.defineProperty,xv=Object.defineProperties,Av=Object.getOwnPropertyDescriptors,Mu=Object.getOwnPropertySymbols,Cv=Object.prototype.hasOwnProperty,Nv=Object.prototype.propertyIsEnumerable,Vu=(t,e,s)=>e in t?Tv(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,zu=(t,e)=>{for(var s in e||(e={}))Cv.call(e,s)&&Vu(t,s,e[s]);if(Mu)for(var s of Mu(e))Nv.call(e,s)&&Vu(t,s,e[s]);return t},jv=(t,e)=>xv(t,Av(e));function qv(t){if(t)return{"--w3m-font-family":t["--wcm-font-family"],"--w3m-accent":t["--wcm-accent-color"],"--w3m-color-mix":t["--wcm-background-color"],"--w3m-z-index":t["--wcm-z-index"]?Number(t["--wcm-z-index"]):void 0,"--w3m-qr-color":t["--wcm-accent-color"],"--w3m-font-size-master":t["--wcm-text-medium-regular-size"],"--w3m-border-radius-master":t["--wcm-container-border-radius"],"--w3m-color-mix-strength":0}}var kv=t=>{let[e,s]=t.split(":");return Ku({id:s,caipNetworkId:t,chainNamespace:e,name:"",nativeCurrency:{name:"",symbol:"",decimals:8},rpcUrls:{default:{http:["https://rpc.walletconnect.org/v1"]}}})};function Lv(t){var e,s,i,r,n,o,a;let c=(e=t.chains)==null?void 0:e.map(kv).filter(Boolean);if(c.length===0)throw new Error("At least one chain must be specified");let l=c.find(u=>{var p;return u.id===((p=t.defaultChain)==null?void 0:p.id)}),h={projectId:t.projectId,networks:c,themeMode:t.themeMode,themeVariables:qv(t.themeVariables),chainImages:t.chainImages,connectorImages:t.walletImages,defaultNetwork:l,metadata:jv(zu({},t.metadata),{name:((s=t.metadata)==null?void 0:s.name)||"WalletConnect",description:((i=t.metadata)==null?void 0:i.description)||"Connect to WalletConnect-compatible wallets",url:((r=t.metadata)==null?void 0:r.url)||"https://walletconnect.org",icons:((n=t.metadata)==null?void 0:n.icons)||["https://walletconnect.org/walletconnect-logo.png"]}),showWallets:!0,featuredWalletIds:t.explorerRecommendedWalletIds==="NONE"?[]:Array.isArray(t.explorerRecommendedWalletIds)?t.explorerRecommendedWalletIds:[],excludeWalletIds:t.explorerExcludedWalletIds==="ALL"?[]:Array.isArray(t.explorerExcludedWalletIds)?t.explorerExcludedWalletIds:[],enableEIP6963:!1,enableInjected:!1,enableCoinbase:!0,enableWalletConnect:!0,features:{email:!1,socials:!1}};if((o=t.mobileWallets)!=null&&o.length||(a=t.desktopWallets)!=null&&a.length){let u=[...(t.mobileWallets||[]).map(f=>({id:f.id,name:f.name,links:f.links})),...(t.desktopWallets||[]).map(f=>({id:f.id,name:f.name,links:{native:f.links.native,universal:f.links.universal}}))],p=[...h.featuredWalletIds||[],...h.excludeWalletIds||[]],d=u.filter(f=>!p.includes(f.id));d.length&&(h.customWallets=d)}return h}function Ku(t){return zu({formatters:void 0,fees:void 0,serializers:void 0},t)}var Fv=Object.freeze({__proto__:null,convertWCMToAppKitOptions:Lv,defineChain:Ku});export{Y1 as EthereumProvider,vv as OPTIONAL_EVENTS,bv as OPTIONAL_METHODS,ba as REQUIRED_EVENTS,wa as REQUIRED_METHODS,Ea as default};
/*! Bundled license information:

@walletconnect/utils/dist/index.js:
  (*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) *)
*/
