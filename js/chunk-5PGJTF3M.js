import{b,u as O,v as L,w as U,x as o,y as d}from"./chunk-ORERQN7J.js";import{a as e}from"./chunk-ZMTN5ZA6.js";import{d as f,f as x,g as F}from"./chunk-F3BT2OCD.js";var P={address:/^0x(?:[A-Fa-f0-9]{40})$/u,transactionHash:/^0x(?:[A-Fa-f0-9]{64})$/u,signedMessage:/^0x(?:[a-fA-F0-9]{62,})$/u};var E={set(i,t){m.isClient&&localStorage.setItem(`${o.STORAGE_KEY}${i}`,t)},get(i){return m.isClient?localStorage.getItem(`${o.STORAGE_KEY}${i}`):null},delete(i,t){m.isClient&&(t?localStorage.removeItem(i):localStorage.removeItem(`${o.STORAGE_KEY}${i}`))}};var S=30*1e3,m={checkIfAllowedToTriggerEmail(){let i=E.get(o.LAST_EMAIL_LOGIN_TIME);if(i){let t=Date.now()-Number(i);if(t<S){let r=Math.ceil((S-t)/1e3);throw new Error(`Please try again after ${r} seconds`)}}},getTimeToNextEmailLogin(){let i=E.get(o.LAST_EMAIL_LOGIN_TIME);if(i){let t=Date.now()-Number(i);if(t<S)return Math.ceil((S-t)/1e3)}return 0},checkIfRequestExists(i){return d.NOT_SAFE_RPC_METHODS.includes(i.method)||d.SAFE_RPC_METHODS.includes(i.method)},getResponseType(i){return typeof i=="string"&&(i?.match(P.transactionHash)||i?.match(P.signedMessage))?o.RPC_RESPONSE_TYPE_TX:o.RPC_RESPONSE_TYPE_OBJECT},checkIfRequestIsSafe(i){return d.SAFE_RPC_METHODS.includes(i.method)},isClient:typeof window<"u"};var p=e.object({message:e.string()});function a(i){return e.literal(o[i])}var _t=e.object({accessList:e.array(e.string()),blockHash:e.string().nullable(),blockNumber:e.string().nullable(),chainId:e.string().or(e.number()),from:e.string(),gas:e.string(),hash:e.string(),input:e.string().nullable(),maxFeePerGas:e.string(),maxPriorityFeePerGas:e.string(),nonce:e.string(),r:e.string(),s:e.string(),to:e.string(),transactionIndex:e.string().nullable(),type:e.string(),v:e.string(),value:e.string()}),v=e.object({chainId:e.string().or(e.number())}),B=e.object({email:e.string().email()}),k=e.object({otp:e.string()}),H=e.object({uri:e.string(),preferredAccountType:e.optional(e.string()),chainId:e.optional(e.string().or(e.number()))}),W=e.object({chainId:e.optional(e.string().or(e.number())),preferredAccountType:e.optional(e.string()),socialUri:e.optional(e.string())}),Y=e.object({provider:e.enum(["google","github","apple","facebook","x","discord"])}),q=e.object({email:e.string().email()}),K=e.object({otp:e.string()}),V=e.object({otp:e.string()}),$=e.object({themeMode:e.optional(e.enum(["light","dark"])),themeVariables:e.optional(e.record(e.string(),e.string().or(e.number()))),w3mThemeVariables:e.optional(e.record(e.string(),e.string()))}),z=e.object({metadata:e.object({name:e.string(),description:e.string(),url:e.string(),icons:e.array(e.string())}).optional(),sdkVersion:e.string().optional(),sdkType:e.string().optional(),projectId:e.string()}),Q=e.object({type:e.string()}),J=e.object({action:e.enum(["VERIFY_DEVICE","VERIFY_OTP","CONNECT"])}),X=e.object({url:e.string()}),Z=e.object({userName:e.string()}),ee=e.object({email:e.string().optional().nullable(),address:e.string(),chainId:e.string().or(e.number()),accounts:e.array(e.object({address:e.string(),type:e.enum([d.ACCOUNT_TYPES.EOA,d.ACCOUNT_TYPES.SMART_ACCOUNT])})).optional(),userName:e.string().optional().nullable(),preferredAccountType:e.optional(e.string())}),te=e.object({action:e.enum(["VERIFY_PRIMARY_OTP","VERIFY_SECONDARY_OTP"])}),re=e.object({email:e.string().email().optional().nullable(),address:e.string(),chainId:e.string().or(e.number()),smartAccountDeployed:e.optional(e.boolean()),accounts:e.array(e.object({address:e.string(),type:e.enum([d.ACCOUNT_TYPES.EOA,d.ACCOUNT_TYPES.SMART_ACCOUNT])})).optional(),preferredAccountType:e.optional(e.string())}),oe=e.object({uri:e.string()}),ae=e.object({isConnected:e.boolean()}),ne=e.object({chainId:e.string().or(e.number())}),se=e.object({chainId:e.string().or(e.number())}),ie=e.object({newEmail:e.string().email()}),ce=e.object({smartAccountEnabledNetworks:e.array(e.number())}),ht=e.object({address:e.string(),isDeployed:e.boolean()}),pe=e.object({version:e.string().optional()}),le=e.object({type:e.string(),address:e.string()}),Ee=e.any(),me=e.object({method:e.literal("eth_accounts")}),de=e.object({method:e.literal("eth_blockNumber")}),_e=e.object({method:e.literal("eth_call"),params:e.array(e.any())}),he=e.object({method:e.literal("eth_chainId")}),Re=e.object({method:e.literal("eth_estimateGas"),params:e.array(e.any())}),ge=e.object({method:e.literal("eth_feeHistory"),params:e.array(e.any())}),ye=e.object({method:e.literal("eth_gasPrice")}),Ae=e.object({method:e.literal("eth_getAccount"),params:e.array(e.any())}),Ce=e.object({method:e.literal("eth_getBalance"),params:e.array(e.any())}),Se=e.object({method:e.literal("eth_getBlockByHash"),params:e.array(e.any())}),ue=e.object({method:e.literal("eth_getBlockByNumber"),params:e.array(e.any())}),Te=e.object({method:e.literal("eth_getBlockReceipts"),params:e.array(e.any())}),Pe=e.object({method:e.literal("eth_getBlockTransactionCountByHash"),params:e.array(e.any())}),Ne=e.object({method:e.literal("eth_getBlockTransactionCountByNumber"),params:e.array(e.any())}),we=e.object({method:e.literal("eth_getCode"),params:e.array(e.any())}),Ie=e.object({method:e.literal("eth_getFilterChanges"),params:e.array(e.any())}),fe=e.object({method:e.literal("eth_getFilterLogs"),params:e.array(e.any())}),xe=e.object({method:e.literal("eth_getLogs"),params:e.array(e.any())}),Fe=e.object({method:e.literal("eth_getProof"),params:e.array(e.any())}),be=e.object({method:e.literal("eth_getStorageAt"),params:e.array(e.any())}),Oe=e.object({method:e.literal("eth_getTransactionByBlockHashAndIndex"),params:e.array(e.any())}),Le=e.object({method:e.literal("eth_getTransactionByBlockNumberAndIndex"),params:e.array(e.any())}),Ue=e.object({method:e.literal("eth_getTransactionByHash"),params:e.array(e.any())}),Me=e.object({method:e.literal("eth_getTransactionCount"),params:e.array(e.any())}),De=e.object({method:e.literal("eth_getTransactionReceipt"),params:e.array(e.any())}),je=e.object({method:e.literal("eth_getUncleCountByBlockHash"),params:e.array(e.any())}),Ge=e.object({method:e.literal("eth_getUncleCountByBlockNumber"),params:e.array(e.any())}),ve=e.object({method:e.literal("eth_maxPriorityFeePerGas")}),Be=e.object({method:e.literal("eth_newBlockFilter")}),ke=e.object({method:e.literal("eth_newFilter"),params:e.array(e.any())}),He=e.object({method:e.literal("eth_newPendingTransactionFilter")}),We=e.object({method:e.literal("eth_sendRawTransaction"),params:e.array(e.any())}),Ye=e.object({method:e.literal("eth_syncing"),params:e.array(e.any())}),qe=e.object({method:e.literal("eth_uninstallFilter"),params:e.array(e.any())}),M=e.object({method:e.literal("personal_sign"),params:e.array(e.any())}),Ke=e.object({method:e.literal("eth_signTypedData_v4"),params:e.array(e.any())}),Ve=e.object({method:e.literal("eth_sendTransaction"),params:e.array(e.any())}),$e=e.object({method:e.literal("solana_signMessage"),params:e.object({message:e.string(),pubkey:e.string()})}),ze=e.object({method:e.literal("solana_signTransaction"),params:e.object({transaction:e.string()})}),Qe=e.object({method:e.literal("solana_signAllTransactions"),params:e.object({transactions:e.array(e.string())})}),Je=e.object({method:e.literal("solana_signAndSendTransaction"),params:e.object({transaction:e.string(),options:e.object({skipPreflight:e.boolean().optional(),preflightCommitment:e.enum(["processed","confirmed","finalized","recent","single","singleGossip","root","max"]).optional(),maxRetries:e.number().optional(),minContextSlot:e.number().optional()}).optional()})}),Xe=e.object({method:e.literal("wallet_sendCalls"),params:e.array(e.object({chainId:e.string().or(e.number()).optional(),from:e.string().optional(),version:e.string().optional(),capabilities:e.any().optional(),calls:e.array(e.object({to:e.string().startsWith("0x"),data:e.string().startsWith("0x").optional(),value:e.string().optional()}))}))}),Ze=e.object({method:e.literal("wallet_getCallsStatus"),params:e.array(e.string())}),et=e.object({method:e.literal("wallet_getCapabilities")}),tt=e.object({method:e.literal("wallet_grantPermissions"),params:e.array(e.any())}),rt=e.object({method:e.literal("wallet_revokePermissions"),params:e.any()}),ot=e.object({method:e.literal("wallet_getAssets"),params:e.any()}),D=e.object({token:e.string()}),n=e.object({id:e.string().optional()}),C={appEvent:n.extend({type:a("APP_SWITCH_NETWORK"),payload:v}).or(n.extend({type:a("APP_CONNECT_EMAIL"),payload:B})).or(n.extend({type:a("APP_CONNECT_DEVICE")})).or(n.extend({type:a("APP_CONNECT_OTP"),payload:k})).or(n.extend({type:a("APP_CONNECT_SOCIAL"),payload:H})).or(n.extend({type:a("APP_GET_FARCASTER_URI")})).or(n.extend({type:a("APP_CONNECT_FARCASTER")})).or(n.extend({type:a("APP_GET_USER"),payload:e.optional(W)})).or(n.extend({type:a("APP_GET_SOCIAL_REDIRECT_URI"),payload:Y})).or(n.extend({type:a("APP_SIGN_OUT")})).or(n.extend({type:a("APP_IS_CONNECTED"),payload:e.optional(D)})).or(n.extend({type:a("APP_GET_CHAIN_ID")})).or(n.extend({type:a("APP_GET_SMART_ACCOUNT_ENABLED_NETWORKS")})).or(n.extend({type:a("APP_INIT_SMART_ACCOUNT")})).or(n.extend({type:a("APP_SET_PREFERRED_ACCOUNT"),payload:Q})).or(n.extend({type:a("APP_RPC_REQUEST"),payload:M.or(ot).or(me).or(de).or(_e).or(he).or(Re).or(ge).or(ye).or(Ae).or(Ce).or(Se).or(ue).or(Te).or(Pe).or(Ne).or(we).or(Ie).or(fe).or(xe).or(Fe).or(be).or(Oe).or(Le).or(Ue).or(Me).or(De).or(je).or(Ge).or(ve).or(Be).or(ke).or(He).or(We).or(Ye).or(qe).or(M).or(Ke).or(Ve).or($e).or(ze).or(Qe).or(Je).or(Ze).or(Xe).or(et).or(tt).or(rt)})).or(n.extend({type:a("APP_UPDATE_EMAIL"),payload:q})).or(n.extend({type:a("APP_UPDATE_EMAIL_PRIMARY_OTP"),payload:K})).or(n.extend({type:a("APP_UPDATE_EMAIL_SECONDARY_OTP"),payload:V})).or(n.extend({type:a("APP_SYNC_THEME"),payload:$})).or(n.extend({type:a("APP_SYNC_DAPP_DATA"),payload:z})).or(n.extend({type:a("APP_RELOAD")})),frameEvent:n.extend({type:a("FRAME_SWITCH_NETWORK_ERROR"),payload:p}).or(n.extend({type:a("FRAME_SWITCH_NETWORK_SUCCESS"),payload:se})).or(n.extend({type:a("FRAME_CONNECT_EMAIL_SUCCESS"),payload:J})).or(n.extend({type:a("FRAME_CONNECT_EMAIL_ERROR"),payload:p})).or(n.extend({type:a("FRAME_GET_FARCASTER_URI_SUCCESS"),payload:X})).or(n.extend({type:a("FRAME_GET_FARCASTER_URI_ERROR"),payload:p})).or(n.extend({type:a("FRAME_CONNECT_FARCASTER_SUCCESS"),payload:Z})).or(n.extend({type:a("FRAME_CONNECT_FARCASTER_ERROR"),payload:p})).or(n.extend({type:a("FRAME_CONNECT_OTP_ERROR"),payload:p})).or(n.extend({type:a("FRAME_CONNECT_OTP_SUCCESS")})).or(n.extend({type:a("FRAME_CONNECT_DEVICE_ERROR"),payload:p})).or(n.extend({type:a("FRAME_CONNECT_DEVICE_SUCCESS")})).or(n.extend({type:a("FRAME_CONNECT_SOCIAL_SUCCESS"),payload:ee})).or(n.extend({type:a("FRAME_CONNECT_SOCIAL_ERROR"),payload:p})).or(n.extend({type:a("FRAME_GET_USER_ERROR"),payload:p})).or(n.extend({type:a("FRAME_GET_USER_SUCCESS"),payload:re})).or(n.extend({type:a("FRAME_GET_SOCIAL_REDIRECT_URI_ERROR"),payload:p})).or(n.extend({type:a("FRAME_GET_SOCIAL_REDIRECT_URI_SUCCESS"),payload:oe})).or(n.extend({type:a("FRAME_SIGN_OUT_ERROR"),payload:p})).or(n.extend({type:a("FRAME_SIGN_OUT_SUCCESS")})).or(n.extend({type:a("FRAME_IS_CONNECTED_ERROR"),payload:p})).or(n.extend({type:a("FRAME_IS_CONNECTED_SUCCESS"),payload:ae})).or(n.extend({type:a("FRAME_GET_CHAIN_ID_ERROR"),payload:p})).or(n.extend({type:a("FRAME_GET_CHAIN_ID_SUCCESS"),payload:ne})).or(n.extend({type:a("FRAME_RPC_REQUEST_ERROR"),payload:p})).or(n.extend({type:a("FRAME_RPC_REQUEST_SUCCESS"),payload:Ee})).or(n.extend({type:a("FRAME_SESSION_UPDATE"),payload:D})).or(n.extend({type:a("FRAME_UPDATE_EMAIL_ERROR"),payload:p})).or(n.extend({type:a("FRAME_UPDATE_EMAIL_SUCCESS"),payload:te})).or(n.extend({type:a("FRAME_UPDATE_EMAIL_PRIMARY_OTP_ERROR"),payload:p})).or(n.extend({type:a("FRAME_UPDATE_EMAIL_PRIMARY_OTP_SUCCESS")})).or(n.extend({type:a("FRAME_UPDATE_EMAIL_SECONDARY_OTP_ERROR"),payload:p})).or(n.extend({type:a("FRAME_UPDATE_EMAIL_SECONDARY_OTP_SUCCESS"),payload:ie})).or(n.extend({type:a("FRAME_SYNC_THEME_ERROR"),payload:p})).or(n.extend({type:a("FRAME_SYNC_THEME_SUCCESS")})).or(n.extend({type:a("FRAME_SYNC_DAPP_DATA_ERROR"),payload:p})).or(n.extend({type:a("FRAME_SYNC_DAPP_DATA_SUCCESS")})).or(n.extend({type:a("FRAME_GET_SMART_ACCOUNT_ENABLED_NETWORKS_SUCCESS"),payload:ce})).or(n.extend({type:a("FRAME_GET_SMART_ACCOUNT_ENABLED_NETWORKS_ERROR"),payload:p})).or(n.extend({type:a("FRAME_INIT_SMART_ACCOUNT_ERROR"),payload:p})).or(n.extend({type:a("FRAME_SET_PREFERRED_ACCOUNT_SUCCESS"),payload:le})).or(n.extend({type:a("FRAME_SET_PREFERRED_ACCOUNT_ERROR"),payload:p})).or(n.extend({type:a("FRAME_READY"),payload:pe})).or(n.extend({type:a("FRAME_RELOAD_ERROR"),payload:p})).or(n.extend({type:a("FRAME_RELOAD_SUCCESS")}))};function N(i,t={}){return typeof t?.type=="string"&&t?.type?.includes(i)}var u=class{constructor({projectId:t,isAppClient:r=!1,chainId:c="eip155:1",enableLogger:h=!0}){if(this.iframe=null,this.iframeIsReady=!1,this.rpcUrl=b.BLOCKCHAIN_API_RPC_URL,this.initFrame=()=>{let s=document.getElementById("w3m-iframe");this.iframe&&!s&&document.body.appendChild(this.iframe)},this.events={registerFrameEventHandler:(s,l,A)=>{function R({data:y}){if(!N(o.FRAME_EVENT_KEY,y))return;let g=C.frameEvent.parse(y);g.id===s&&(l(g),window.removeEventListener("message",R))}m.isClient&&(window.addEventListener("message",R),A.addEventListener("abort",()=>{window.removeEventListener("message",R)}))},onFrameEvent:s=>{m.isClient&&window.addEventListener("message",({data:l})=>{if(!N(o.FRAME_EVENT_KEY,l))return;let A=C.frameEvent.parse(l);s(A)})},onAppEvent:s=>{m.isClient&&window.addEventListener("message",({data:l})=>{if(!N(o.APP_EVENT_KEY,l))return;let A=C.appEvent.parse(l);s(A)})},postAppEvent:s=>{if(m.isClient){if(!this.iframe?.contentWindow)throw new Error("W3mFrame: iframe is not set");C.appEvent.parse(s),this.iframe.contentWindow.postMessage(s,"*")}},postFrameEvent:s=>{if(m.isClient){if(!parent)throw new Error("W3mFrame: parent is not set");C.frameEvent.parse(s),parent.postMessage(s,"*")}}},this.projectId=t,this.frameLoadPromise=new Promise((s,l)=>{this.frameLoadPromiseResolver={resolve:s,reject:l}}),r&&(this.frameLoadPromise=new Promise((s,l)=>{this.frameLoadPromiseResolver={resolve:s,reject:l}}),m.isClient)){let s=document.createElement("iframe");s.id="w3m-iframe",s.src=`${O}?projectId=${t}&chainId=${c}&version=${U}&enableLogger=${h}`,s.name="w3m-secure-iframe",s.style.position="fixed",s.style.zIndex="999999",s.style.display="none",s.style.border="none",s.style.animationDelay="0s, 50ms",s.style.borderBottomLeftRadius="clamp(0px, var(--wui-border-radius-l), 44px)",s.style.borderBottomRightRadius="clamp(0px, var(--wui-border-radius-l), 44px)",this.iframe=s,this.iframe.onerror=()=>{this.frameLoadPromiseResolver?.reject("Unable to load email login dependency")},this.events.onFrameEvent(l=>{l.type==="@w3m-frame/READY"&&(this.iframeIsReady=!0,this.frameLoadPromiseResolver?.resolve(void 0))})}}get networks(){let t=["eip155:1","eip155:5","eip155:11155111","eip155:10","eip155:420","eip155:42161","eip155:421613","eip155:137","eip155:80001","eip155:42220","eip155:1313161554","eip155:1313161555","eip155:56","eip155:97","eip155:43114","eip155:43113","eip155:324","eip155:280","eip155:100","eip155:8453","eip155:84531","eip155:84532","eip155:7777777","eip155:999","solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp","solana:4uhcVJyU9pJkvQyS88uRDiswHXSCkY3z","solana:EtWTRABZaYq6iMfeYKouRu166VU2xqa1"].map(r=>({[r]:{rpcUrl:`${this.rpcUrl}/v1/?chainId=${r}&projectId=${this.projectId}`,chainId:r}}));return Object.assign({},...t)}};var T=class{constructor(t){let r=f({level:L}),{logger:c,chunkLoggerController:h}=F({opts:r});this.logger=x(c,this.constructor.name),this.chunkLoggerController=h,typeof window<"u"&&this.chunkLoggerController?.downloadLogsBlobInBrowser&&(window.downloadAppKitLogsBlob||(window.downloadAppKitLogsBlob={}),window.downloadAppKitLogsBlob.sdk=()=>{this.chunkLoggerController?.downloadLogsBlobInBrowser&&this.chunkLoggerController.downloadLogsBlobInBrowser({projectId:t})})}};var w=class{constructor({projectId:t,chainId:r,enableLogger:c=!0,onTimeout:h,abortController:s}){this.openRpcRequests=[],this.isInitialized=!1,c&&(this.w3mLogger=new T(t)),this.abortController=s,this.w3mFrame=new u({projectId:t,isAppClient:!0,chainId:r,enableLogger:c}),this.onTimeout=h,this.getLoginEmailUsed()&&this.createFrame()}async createFrame(){this.w3mFrame.initFrame(),this.initPromise=new Promise(t=>{this.w3mFrame.events.onFrameEvent(r=>{r.type===o.FRAME_READY&&setTimeout(()=>{t()},500)})}),await this.initPromise,this.isInitialized=!0,this.initPromise=void 0}async init(){if(!this.isInitialized){if(this.initPromise){await this.initPromise;return}await this.createFrame()}}getLoginEmailUsed(){return!!E.get(o.EMAIL_LOGIN_USED_KEY)}getEmail(){return E.get(o.EMAIL)}getUsername(){return E.get(o.SOCIAL_USERNAME)}async reload(){try{await this.appEvent({type:o.APP_RELOAD})}catch(t){throw this.w3mLogger?.logger.error({error:t},"Error reloading iframe"),t}}async connectEmail(t){try{m.checkIfAllowedToTriggerEmail(),await this.init();let r=await this.appEvent({type:o.APP_CONNECT_EMAIL,payload:t});return this.setNewLastEmailLoginTime(),r}catch(r){throw this.w3mLogger?.logger.error({error:r},"Error connecting email"),r}}async connectDevice(){try{return this.appEvent({type:o.APP_CONNECT_DEVICE})}catch(t){throw this.w3mLogger?.logger.error({error:t},"Error connecting device"),t}}async connectOtp(t){try{return this.appEvent({type:o.APP_CONNECT_OTP,payload:t})}catch(r){throw this.w3mLogger?.logger.error({error:r},"Error connecting otp"),r}}async isConnected(){try{if(!this.getLoginEmailUsed())return{isConnected:!1};let t=await this.appEvent({type:o.APP_IS_CONNECTED});return t?.isConnected||this.deleteAuthLoginCache(),t}catch(t){throw this.deleteAuthLoginCache(),this.w3mLogger?.logger.error({error:t},"Error checking connection"),t}}async getChainId(){try{let t=await this.appEvent({type:o.APP_GET_CHAIN_ID});return this.setLastUsedChainId(t.chainId),t}catch(t){throw this.w3mLogger?.logger.error({error:t},"Error getting chain id"),t}}async getSocialRedirectUri(t){try{return await this.init(),this.appEvent({type:o.APP_GET_SOCIAL_REDIRECT_URI,payload:t})}catch(r){throw this.w3mLogger?.logger.error({error:r},"Error getting social redirect uri"),r}}async updateEmail(t){try{let r=await this.appEvent({type:o.APP_UPDATE_EMAIL,payload:t});return this.setNewLastEmailLoginTime(),r}catch(r){throw this.w3mLogger?.logger.error({error:r},"Error updating email"),r}}async updateEmailPrimaryOtp(t){try{return this.appEvent({type:o.APP_UPDATE_EMAIL_PRIMARY_OTP,payload:t})}catch(r){throw this.w3mLogger?.logger.error({error:r},"Error updating email primary otp"),r}}async updateEmailSecondaryOtp(t){try{let r=await this.appEvent({type:o.APP_UPDATE_EMAIL_SECONDARY_OTP,payload:t});return this.setLoginSuccess(r.newEmail),r}catch(r){throw this.w3mLogger?.logger.error({error:r},"Error updating email secondary otp"),r}}async syncTheme(t){try{return this.appEvent({type:o.APP_SYNC_THEME,payload:t})}catch(r){throw this.w3mLogger?.logger.error({error:r},"Error syncing theme"),r}}async syncDappData(t){try{return this.appEvent({type:o.APP_SYNC_DAPP_DATA,payload:t})}catch(r){throw this.w3mLogger?.logger.error({error:r},"Error syncing dapp data"),r}}async getSmartAccountEnabledNetworks(){try{let t=await this.appEvent({type:o.APP_GET_SMART_ACCOUNT_ENABLED_NETWORKS});return this.persistSmartAccountEnabledNetworks(t.smartAccountEnabledNetworks),t}catch(t){throw this.persistSmartAccountEnabledNetworks([]),this.w3mLogger?.logger.error({error:t},"Error getting smart account enabled networks"),t}}async setPreferredAccount(t){try{return this.appEvent({type:o.APP_SET_PREFERRED_ACCOUNT,payload:{type:t}})}catch(r){throw this.w3mLogger?.logger.error({error:r},"Error setting preferred account"),r}}async connect(t){if(t?.socialUri)try{await this.init();let r=await this.appEvent({type:o.APP_CONNECT_SOCIAL,payload:{uri:t.socialUri,preferredAccountType:t.preferredAccountType,chainId:t.chainId}});return r.userName&&this.setSocialLoginSuccess(r.userName),this.setLoginSuccess(r.email),this.setLastUsedChainId(r.chainId),this.user=r,r}catch(r){throw this.w3mLogger?.logger.error({error:r},"Error connecting social"),r}else try{let r=t?.chainId||this.getLastUsedChainId()||1,c=await this.getUser({chainId:r,preferredAccountType:t?.preferredAccountType});return this.setLoginSuccess(c.email),this.setLastUsedChainId(c.chainId),this.user=c,c}catch(r){throw this.w3mLogger?.logger.error({error:r},"Error connecting"),r}}async getUser(t){try{await this.init();let r=t?.chainId||this.getLastUsedChainId()||1,c=await this.appEvent({type:o.APP_GET_USER,payload:{...t,chainId:r}});return this.user=c,c}catch(r){throw this.w3mLogger?.logger.error({error:r},"Error connecting"),r}}async connectSocial(t){try{await this.init();let r=await this.appEvent({type:o.APP_CONNECT_SOCIAL,payload:{uri:t}});return r.userName&&this.setSocialLoginSuccess(r.userName),r}catch(r){throw this.w3mLogger?.logger.error({error:r},"Error connecting social"),r}}async getFarcasterUri(){try{return await this.init(),await this.appEvent({type:o.APP_GET_FARCASTER_URI})}catch(t){throw this.w3mLogger?.logger.error({error:t},"Error getting farcaster uri"),t}}async connectFarcaster(){try{let t=await this.appEvent({type:o.APP_CONNECT_FARCASTER});return t.userName&&this.setSocialLoginSuccess(t.userName),t}catch(t){throw this.w3mLogger?.logger.error({error:t},"Error connecting farcaster"),t}}async switchNetwork(t){try{let r=await this.appEvent({type:o.APP_SWITCH_NETWORK,payload:{chainId:t}});return this.setLastUsedChainId(r.chainId),r}catch(r){throw this.w3mLogger?.logger.error({error:r},"Error switching network"),r}}async disconnect(){try{return this.deleteAuthLoginCache(),await new Promise(async r=>{let c=setTimeout(()=>{r()},3e3);await this.appEvent({type:o.APP_SIGN_OUT}),clearTimeout(c),r()})}catch(t){throw this.w3mLogger?.logger.error({error:t},"Error disconnecting"),t}}async request(t){try{if(d.GET_CHAIN_ID===t.method)return this.getLastUsedChainId();this.rpcRequestHandler?.(t);let r=await this.appEvent({type:o.APP_RPC_REQUEST,payload:t});return this.rpcSuccessHandler?.(r,t),r}catch(r){throw this.rpcErrorHandler?.(r,t),this.w3mLogger?.logger.error({error:r},"Error requesting"),r}}onRpcRequest(t){this.rpcRequestHandler=t}onRpcSuccess(t){this.rpcSuccessHandler=t}onRpcError(t){this.rpcErrorHandler=t}onIsConnected(t){this.w3mFrame.events.onFrameEvent(r=>{r.type===o.FRAME_IS_CONNECTED_SUCCESS&&r.payload.isConnected&&t()})}onNotConnected(t){this.w3mFrame.events.onFrameEvent(r=>{r.type===o.FRAME_IS_CONNECTED_ERROR&&t(),r.type===o.FRAME_IS_CONNECTED_SUCCESS&&!r.payload.isConnected&&t()})}onConnect(t){this.w3mFrame.events.onFrameEvent(r=>{r.type===o.FRAME_GET_USER_SUCCESS&&t(r.payload)})}onSocialConnected(t){this.w3mFrame.events.onFrameEvent(r=>{r.type===o.FRAME_CONNECT_SOCIAL_SUCCESS&&t(r.payload)})}async getCapabilities(){try{return await this.request({method:"wallet_getCapabilities"})||{}}catch{return{}}}onSetPreferredAccount(t){this.w3mFrame.events.onFrameEvent(r=>{r.type===o.FRAME_SET_PREFERRED_ACCOUNT_SUCCESS?t(r.payload):r.type===o.FRAME_SET_PREFERRED_ACCOUNT_ERROR&&t({type:d.ACCOUNT_TYPES.EOA})})}onGetSmartAccountEnabledNetworks(t){this.w3mFrame.events.onFrameEvent(r=>{r.type===o.FRAME_GET_SMART_ACCOUNT_ENABLED_NETWORKS_SUCCESS?t(r.payload.smartAccountEnabledNetworks):r.type===o.FRAME_GET_SMART_ACCOUNT_ENABLED_NETWORKS_ERROR&&t([])})}getAvailableChainIds(){return Object.keys(this.w3mFrame.networks)}rejectRpcRequests(){try{this.openRpcRequests.forEach(({abortController:t,method:r})=>{d.SAFE_RPC_METHODS.includes(r)||t.abort()}),this.openRpcRequests=[]}catch(t){this.w3mLogger?.logger.error({error:t},"Error aborting RPC request")}}async appEvent(t){let r,c;function h(R){return R.replace("@w3m-app/","")}let s=[o.APP_SYNC_DAPP_DATA,o.APP_SYNC_THEME,o.APP_SET_PREFERRED_ACCOUNT],l=h(t.type);return!this.w3mFrame.iframeIsReady&&!s.includes(t.type)&&(c=setTimeout(()=>{this.onTimeout?.("iframe_load_failed"),this.abortController.abort()},2e4)),await this.w3mFrame.frameLoadPromise,clearTimeout(c),[o.APP_CONNECT_EMAIL,o.APP_CONNECT_DEVICE,o.APP_CONNECT_OTP,o.APP_CONNECT_SOCIAL,o.APP_GET_SOCIAL_REDIRECT_URI].map(h).includes(l)&&(r=setTimeout(()=>{this.onTimeout?.("iframe_request_timeout"),this.abortController.abort()},3e4)),new Promise((R,y)=>{let g=Math.random().toString(36).substring(7);this.w3mLogger?.logger.info?.({event:t,id:g},"Sending app event"),this.w3mFrame.events.postAppEvent({...t,id:g});let I=new AbortController;if(l==="RPC_REQUEST"){let _=t;this.openRpcRequests=[...this.openRpcRequests,{..._.payload,abortController:I}]}I.signal.addEventListener("abort",()=>{l==="RPC_REQUEST"?y(new Error("Request was aborted")):l!=="GET_FARCASTER_URI"&&y(new Error("Something went wrong"))});function j(_,G){_.id===g&&(G?.logger.info?.({framEvent:_,id:g},"Received frame response"),_.type===`@w3m-frame/${l}_SUCCESS`?(r&&clearTimeout(r),c&&clearTimeout(c),"payload"in _&&R(_.payload),R(void 0)):_.type===`@w3m-frame/${l}_ERROR`&&(r&&clearTimeout(r),c&&clearTimeout(c),"payload"in _&&y(new Error(_.payload?.message||"An error occurred")),y(new Error("An error occurred"))))}this.w3mFrame.events.registerFrameEventHandler(g,_=>j(_,this.w3mLogger),this.abortController.signal)})}setNewLastEmailLoginTime(){E.set(o.LAST_EMAIL_LOGIN_TIME,Date.now().toString())}setSocialLoginSuccess(t){E.set(o.SOCIAL_USERNAME,t)}setLoginSuccess(t){t&&E.set(o.EMAIL,t),E.set(o.EMAIL_LOGIN_USED_KEY,"true"),E.delete(o.LAST_EMAIL_LOGIN_TIME)}deleteAuthLoginCache(){E.delete(o.EMAIL_LOGIN_USED_KEY),E.delete(o.EMAIL),E.delete(o.LAST_USED_CHAIN_KEY),E.delete(o.SOCIAL_USERNAME)}setLastUsedChainId(t){t&&E.set(o.LAST_USED_CHAIN_KEY,String(t))}getLastUsedChainId(){let t=E.get(o.LAST_USED_CHAIN_KEY)??void 0,r=Number(t);return isNaN(r)?t:r}persistSmartAccountEnabledNetworks(t){E.set(o.SMART_ACCOUNT_ENABLED_NETWORKS,t.join(","))}};export{m as a,w as b};
