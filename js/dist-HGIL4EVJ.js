import{b as de,c as ue,e as pe,f as fe,n as le,o as he,p as me,q as ye,r as ge,s as be}from"./chunk-6HHQFJDN.js";import{a as Ue}from"./chunk-NBB6K44E.js";import"./chunk-P6OKGMWB.js";import{ga as ce,ka as ve}from"./chunk-SH2H32CZ.js";import"./chunk-BDUWLAUS.js";import"./chunk-OBMTZ2R2.js";import"./chunk-6ZQQ3XQO.js";import{Ma as W,Ra as ae,t as je,ua as V}from"./chunk-J26BEOSD.js";import"./chunk-MQMLE4BX.js";import"./chunk-UHIHVU5C.js";import"./chunk-EDRI7XUL.js";import{d as yt,g as gt,i as d,k as u,l,o as p}from"./chunk-JY5TIRRF.js";var nt=yt((dn,rt)=>{d();p();u();rt.exports=J;J.default=J;J.stable=et;J.stableStringify=et;var te="[...]",Qe="[Circular]",T=[],O=[];function Ze(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function J(e,t,r,n){typeof n>"u"&&(n=Ze()),Ie(e,"",0,[],void 0,0,n);var i;try{O.length===0?i=JSON.stringify(e,t,r):i=JSON.stringify(e,tt(t),r)}catch{return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;T.length!==0;){var s=T.pop();s.length===4?Object.defineProperty(s[0],s[1],s[3]):s[0][s[1]]=s[2]}}return i}function j(e,t,r,n){var i=Object.getOwnPropertyDescriptor(n,r);i.get!==void 0?i.configurable?(Object.defineProperty(n,r,{value:e}),T.push([n,r,t,i])):O.push([t,r,e]):(n[r]=e,T.push([n,r,t]))}function Ie(e,t,r,n,i,s,a){s+=1;var o;if(typeof e=="object"&&e!==null){for(o=0;o<n.length;o++)if(n[o]===e){j(Qe,e,t,i);return}if(typeof a.depthLimit<"u"&&s>a.depthLimit){j(te,e,t,i);return}if(typeof a.edgesLimit<"u"&&r+1>a.edgesLimit){j(te,e,t,i);return}if(n.push(e),Array.isArray(e))for(o=0;o<e.length;o++)Ie(e[o],o,o,n,e,s,a);else{var c=Object.keys(e);for(o=0;o<c.length;o++){var f=c[o];Ie(e[f],f,o,n,e,s,a)}}n.pop()}}function Ot(e,t){return e<t?-1:e>t?1:0}function et(e,t,r,n){typeof n>"u"&&(n=Ze());var i=Oe(e,"",0,[],void 0,0,n)||e,s;try{O.length===0?s=JSON.stringify(i,t,r):s=JSON.stringify(i,tt(t),r)}catch{return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;T.length!==0;){var a=T.pop();a.length===4?Object.defineProperty(a[0],a[1],a[3]):a[0][a[1]]=a[2]}}return s}function Oe(e,t,r,n,i,s,a){s+=1;var o;if(typeof e=="object"&&e!==null){for(o=0;o<n.length;o++)if(n[o]===e){j(Qe,e,t,i);return}try{if(typeof e.toJSON=="function")return}catch{return}if(typeof a.depthLimit<"u"&&s>a.depthLimit){j(te,e,t,i);return}if(typeof a.edgesLimit<"u"&&r+1>a.edgesLimit){j(te,e,t,i);return}if(n.push(e),Array.isArray(e))for(o=0;o<e.length;o++)Oe(e[o],o,o,n,e,s,a);else{var c={},f=Object.keys(e).sort(Ot);for(o=0;o<f.length;o++){var y=f[o];Oe(e[y],y,o,n,e,s,a),c[y]=e[y]}if(typeof i<"u")T.push([i,t,e]),i[t]=c;else return c}n.pop()}}function tt(e){return e=typeof e<"u"?e:function(t,r){return r},function(t,r){if(O.length>0)for(var n=0;n<O.length;n++){var i=O[n];if(i[1]===t&&i[0]===r){r=i[2],O.splice(n,1);break}}return e.call(this,t,r)}}});d();p();u();d();p();u();d();p();u();d();p();u();var G=class extends TypeError{constructor(t,r){let n,{message:i,explanation:s,...a}=t,{path:o}=t,c=o.length===0?i:`At path: ${o.join(".")} -- ${i}`;super(s??c),s!=null&&(this.cause=c),Object.assign(this,a),this.name=this.constructor.name,this.failures=()=>n??(n=[t,...r()])}};d();p();u();d();p();u();function bt(e){return E(e)&&typeof e[Symbol.iterator]=="function"}function E(e){return typeof e=="object"&&e!==null}function A(e){return typeof e=="symbol"?e.toString():typeof e=="string"?JSON.stringify(e):`${e}`}function $e(e){let{done:t,value:r}=e.next();return t?void 0:r}function wt(e,t,r,n){if(e===!0)return;e===!1?e={}:typeof e=="string"&&(e={message:e});let{path:i,branch:s}=t,{type:a}=r,{refinement:o,message:c=`Expected a value of type \`${a}\`${o?` with refinement \`${o}\``:""}, but received: \`${A(n)}\``}=e;return{value:n,type:a,refinement:o,key:i[i.length-1],path:i,branch:s,...e,message:c}}function*v(e,t,r,n){bt(e)||(e=[e]);for(let i of e){let s=wt(i,t,r,n);s&&(yield s)}}function*U(e,t,r={}){let{path:n=[],branch:i=[e],coerce:s=!1,mask:a=!1}=r,o={path:n,branch:i};if(s&&(e=t.coercer(e,o),a&&t.type!=="type"&&E(t.schema)&&E(e)&&!Array.isArray(e)))for(let f in e)t.schema[f]===void 0&&delete e[f];let c="valid";for(let f of t.validator(e,o))f.explanation=r.message,c="not_valid",yield[f,void 0];for(let[f,y,q]of t.entries(e,o)){let oe=U(y,q,{path:f===void 0?n:[...n,f],branch:f===void 0?i:[...i,y],coerce:s,mask:a,message:r.message});for(let N of oe)N[0]?(c=N[0].refinement===null||N[0].refinement===void 0?"not_valid":"not_refined",yield[N[0],void 0]):s&&(y=N[1],f===void 0?e=y:e instanceof Map?e.set(f,y):e instanceof Set?e.add(y):E(e)&&(y!==void 0||f in e)&&(e[f]=y))}if(c!=="not_valid")for(let f of t.refiner(e,o))f.explanation=r.message,c="not_refined",yield[f,void 0];c==="valid"&&(yield[void 0,e])}var g=class{constructor(t){let{type:r,schema:n,validator:i,refiner:s,coercer:a=c=>c,entries:o=function*(){}}=t;this.type=r,this.schema=n,this.entries=o,this.coercer=a,i?this.validator=(c,f)=>{let y=i(c,f);return v(y,f,this,c)}:this.validator=()=>[],s?this.refiner=(c,f)=>{let y=s(c,f);return v(y,f,this,c)}:this.refiner=()=>[]}assert(t,r){return Et(t,this,r)}create(t,r){return we(t,this,r)}is(t){return R(t,this)}mask(t,r){return St(t,this,r)}validate(t,r={}){return $(t,this,r)}},Le="EXACT_OPTIONAL",Y=class extends g{constructor(t){super({...t,type:`exact optional ${t.type}`}),this.brand=Le}static isExactOptional(t){return E(t)&&"brand"in t&&t.brand===Le}};function Et(e,t,r){let n=$(e,t,{message:r});if(n[0])throw n[0]}function we(e,t,r){let n=$(e,t,{coerce:!0,message:r});if(n[0])throw n[0];return n[1]}function St(e,t,r){let n=$(e,t,{coerce:!0,mask:!0,message:r});if(n[0])throw n[0];return n[1]}function R(e,t){return!$(e,t)[0]}function $(e,t,r={}){let n=U(e,t,r),i=$e(n);return i[0]?[new G(i[0],function*(){for(let o of n)o[0]&&(yield o[0])}),void 0]:[void 0,i[1]]}d();p();u();d();p();u();d();p();u();function x(e,t){return new g({type:e,schema:null,validator:t})}function Ke(){return x("any",()=>!0)}function Me(e){return new g({type:"array",schema:e,*entries(t){if(e&&Array.isArray(t))for(let[r,n]of t.entries())yield[r,n,e]},coercer(t){return Array.isArray(t)?t.slice():t},validator(t){return Array.isArray(t)||`Expected an array value, but received: ${A(t)}`}})}function Je(){return x("integer",e=>typeof e=="number"&&!isNaN(e)&&Number.isInteger(e)||`Expected an integer, but received: ${A(e)}`)}function Fe(e){let t=A(e),r=typeof e;return new g({type:"literal",schema:r==="string"||r==="number"||r==="boolean"?e:null,validator(n){return n===e||`Expected the literal \`${t}\`, but received: ${A(n)}`}})}function At(){return x("never",()=>!1)}function He(e){return new g({...e,validator:(t,r)=>t===null||e.validator(t,r),refiner:(t,r)=>t===null||e.refiner(t,r)})}function ze(){return x("number",e=>typeof e=="number"&&!isNaN(e)||`Expected a number, but received: ${A(e)}`)}function Ee(e){let t=e?Object.keys(e):[],r=At();return new g({type:"object",schema:e??null,*entries(n){if(e&&E(n)){let i=new Set(Object.keys(n));for(let s of t){i.delete(s);let a=e[s];Y.isExactOptional(a)&&!Object.prototype.hasOwnProperty.call(n,s)||(yield[s,n[s],e[s]])}for(let s of i)yield[s,n[s],r]}},validator(n){return E(n)||`Expected an object, but received: ${A(n)}`},coercer(n){return E(n)?{...n}:n}})}function Se(e){return new g({...e,validator:(t,r)=>t===void 0||e.validator(t,r),refiner:(t,r)=>t===void 0||e.refiner(t,r)})}function Be(e,t){return new g({type:"record",schema:null,*entries(r){if(E(r))for(let n in r){let i=r[n];yield[n,n,e],yield[n,i,t]}},validator(r){return E(r)||`Expected an object, but received: ${A(r)}`}})}function I(){return x("string",e=>typeof e=="string"||`Expected a string, but received: ${A(e)}`)}function X(e){let t=e.map(r=>r.type).join(" | ");return new g({type:"union",schema:null,coercer(r){for(let n of e){let[i,s]=n.validate(r,{coerce:!0});if(!i)return s}return r},validator(r,n){let i=[];for(let s of e){let[...a]=U(r,s,n),[o]=a;if(!o?.[0])return[];for(let[c]of a)c&&i.push(c)}return[`Expected the value to satisfy a union of \`${t}\`, but received: ${A(r)}`,...i]}})}function ke(){return x("unknown",()=>!0)}function qe(e,t,r){return new g({...e,coercer:(n,i)=>R(n,t)?e.coercer(r(n,i),i):e.coercer(n,i)})}d();p();u();function Ve(e,t,r){return new g({...e,*refiner(n,i){yield*e.refiner(n,i);let s=r(n,i),a=v(s,i,e,n);for(let o of a)yield{...o,refinement:t}}})}d();p();u();function D(e){return!!e&&typeof e=="object"&&!Array.isArray(e)}var C=(e,t)=>Object.hasOwnProperty.call(e,t);var Ae;(function(e){e[e.Null=4]="Null",e[e.Comma=1]="Comma",e[e.Wrapper=1]="Wrapper",e[e.True=4]="True",e[e.False=5]="False",e[e.Quote=1]="Quote",e[e.Colon=1]="Colon",e[e.Date=24]="Date"})(Ae=Ae||(Ae={}));function We(e){if(typeof e!="object"||e===null)return!1;try{let t=e;for(;Object.getPrototypeOf(t)!==null;)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}catch{return!1}}d();p();u();var K=e=>Ee(e);function Ge({path:e,branch:t}){let r=e[e.length-1];return C(t[t.length-2],r)}function Q(e){return new g({...e,type:`optional ${e.type}`,validator:(t,r)=>!Ge(r)||e.validator(t,r),refiner:(t,r)=>!Ge(r)||e.refiner(t,r)})}function _e(e){if(e===null||typeof e=="boolean"||typeof e=="string"||typeof e=="number"&&Number.isFinite(e))return!0;if(typeof e=="object"){let t=!0;if(Array.isArray(e)){for(let n=0;n<e.length;n++)if(!_e(e[n])){t=!1;break}return t}let r=Object.entries(e);for(let n=0;n<r.length;n++)if(typeof r[n][0]!="string"||!_e(r[n][1])){t=!1;break}return t}return!1}var Ye=x("JSON",e=>_e(e)),L=qe(Ye,Ve(Ke(),"JSON",e=>R(e,Ye)),e=>JSON.parse(JSON.stringify(e,(t,r)=>{if(!(t==="__proto__"||t==="constructor"))return r})));function Z(e){try{return _t(e),!0}catch{return!1}}function _t(e){return we(e,L)}var xt="2.0",M=Fe(xt),ee=He(X([ze(),I()])),xe=K({code:Je(),message:I(),data:Q(L),stack:Q(I())}),Xe=X([Be(I(),L),Me(L)]),en=K({id:ee,jsonrpc:M,method:I(),params:Q(Xe)}),tn=K({jsonrpc:M,method:I(),params:Q(Xe)});var rn=Ee({id:ee,jsonrpc:M,result:Se(ke()),error:Se(xe)}),Ct=K({id:ee,jsonrpc:M,result:L}),It=K({id:ee,jsonrpc:M,error:xe}),nn=X([Ct,It]);function Ce(e){return R(e,xe)}var ot=gt(nt(),1);d();p();u();d();p();u();var h={rpc:{invalidInput:-32e3,resourceNotFound:-32001,resourceUnavailable:-32002,transactionRejected:-32003,methodNotSupported:-32004,limitExceeded:-32005,parse:-32700,invalidRequest:-32600,methodNotFound:-32601,invalidParams:-32602,internal:-32603},provider:{userRejectedRequest:4001,unauthorized:4100,unsupportedMethod:4200,disconnected:4900,chainDisconnected:4901}},Te={"-32700":{standard:"JSON RPC 2.0",message:"Invalid JSON was received by the server. An error occurred on the server while parsing the JSON text."},"-32600":{standard:"JSON RPC 2.0",message:"The JSON sent is not a valid Request object."},"-32601":{standard:"JSON RPC 2.0",message:"The method does not exist / is not available."},"-32602":{standard:"JSON RPC 2.0",message:"Invalid method parameter(s)."},"-32603":{standard:"JSON RPC 2.0",message:"Internal JSON-RPC error."},"-32000":{standard:"EIP-1474",message:"Invalid input."},"-32001":{standard:"EIP-1474",message:"Resource not found."},"-32002":{standard:"EIP-1474",message:"Resource unavailable."},"-32003":{standard:"EIP-1474",message:"Transaction rejected."},"-32004":{standard:"EIP-1474",message:"Method not supported."},"-32005":{standard:"EIP-1474",message:"Request limit exceeded."},4001:{standard:"EIP-1193",message:"User rejected the request."},4100:{standard:"EIP-1193",message:"The requested account and/or method has not been authorized by the user."},4200:{standard:"EIP-1193",message:"The requested method is not supported by this Ethereum provider."},4900:{standard:"EIP-1193",message:"The provider is disconnected from all chains."},4901:{standard:"EIP-1193",message:"The provider is disconnected from the specified chain."}};var it=h.rpc.internal,Tt="Unspecified error message. This is a bug, please report it.",Pt={code:it,message:F(it)},Nt="Unspecified server error.";function F(e,t=Tt){if(Rt(e)){let r=e.toString();if(C(Te,r))return Te[r].message;if(vt(e))return Nt}return t}function Rt(e){return Number.isInteger(e)}function Pe(e,{fallbackError:t=Pt,shouldIncludeStack:r=!0,shouldPreserveMessage:n=!0}={}){if(!Ce(t))throw new Error("Must provide fallback error with integer number code and string message.");let i=Dt(e,t,n);return r||delete i.stack,i}function Dt(e,t,r){if(e&&typeof e=="object"&&"serialize"in e&&typeof e.serialize=="function")return e.serialize();if(Ce(e))return e;let n=jt(e),i=re(e);return{...t,...r&&n&&{message:n},data:{cause:i}}}function jt(e){if(D(e)&&C(e,"message")&&typeof e.message=="string"&&e.message.length>0)return e.message}function vt(e){return e>=-32099&&e<=-32e3}function re(e){return Array.isArray(e)?e.map(t=>Z(t)?t:D(t)?st(t):null):D(e)?st(e):Z(e)?e:null}function st(e){return Object.getOwnPropertyNames(e).reduce((t,r)=>{let n=e[r];return Z(n)&&(t[r]=n),t},{})}function Ne(e){return D(e)&&C(e,"cause")&&D(e.cause)}function Ut(e){return e?.__esModule?e.default:e}var $t=Ut(ot.default),H=class extends Error{constructor(t,r,n){if(!Number.isInteger(t))throw new Error('"code" must be an integer.');if(!r||typeof r!="string")throw new Error('"message" must be a non-empty string.');Ne(n)?(super(r,{cause:n.cause}),C(this,"cause")||Object.assign(this,{cause:n.cause})):super(r),n!==void 0&&(this.data=n),this.code=t}serialize(){let t={code:this.code,message:this.message};return this.data!==void 0&&(t.data=this.data,We(this.data)&&(t.data.cause=re(this.data.cause))),this.stack&&(t.stack=this.stack),t}toString(){return $t(this.serialize(),Kt,2)}},z=class extends H{constructor(t,r,n){if(!Lt(t))throw new Error('"code" must be an integer such that: 1000 <= code <= 4999');super(t,r,n)}};function Lt(e){return Number.isInteger(e)&&e>=1e3&&e<=4999}function Kt(e,t){if(t!=="[Circular]")return t}d();p();u();var m={parse:e=>S(h.rpc.parse,e),invalidRequest:e=>S(h.rpc.invalidRequest,e),invalidParams:e=>S(h.rpc.invalidParams,e),methodNotFound:e=>S(h.rpc.methodNotFound,e),internal:e=>S(h.rpc.internal,e),server:e=>{if(!e||typeof e!="object"||Array.isArray(e))throw new Error("Ethereum RPC Server errors must provide single object argument.");let{code:t}=e;if(!Number.isInteger(t)||t>-32005||t<-32099)throw new Error('"code" must be an integer such that: -32099 <= code <= -32005');return S(t,e)},invalidInput:e=>S(h.rpc.invalidInput,e),resourceNotFound:e=>S(h.rpc.resourceNotFound,e),resourceUnavailable:e=>S(h.rpc.resourceUnavailable,e),transactionRejected:e=>S(h.rpc.transactionRejected,e),methodNotSupported:e=>S(h.rpc.methodNotSupported,e),limitExceeded:e=>S(h.rpc.limitExceeded,e)},_={userRejectedRequest:e=>B(h.provider.userRejectedRequest,e),unauthorized:e=>B(h.provider.unauthorized,e),unsupportedMethod:e=>B(h.provider.unsupportedMethod,e),disconnected:e=>B(h.provider.disconnected,e),chainDisconnected:e=>B(h.provider.chainDisconnected,e),custom:e=>{if(!e||typeof e!="object"||Array.isArray(e))throw new Error("Ethereum Provider custom errors must provide single object argument.");let{code:t,message:r,data:n}=e;if(!r||typeof r!="string")throw new Error('"message" must be a nonempty string');return new z(t,r,n)}};function S(e,t){let[r,n]=at(t);return new H(e,r??F(e),n)}function B(e,t){let[r,n]=at(t);return new z(e,r??F(e),n)}function at(e){if(e){if(typeof e=="string")return[e];if(typeof e=="object"&&!Array.isArray(e)){let{message:t,data:r}=e;if(t&&typeof t!="string")throw new Error("Must specify string message.");return[t??void 0,r]}}return[]}var Mt={name:"@gemini-wallet/core",version:"0.3.2",description:"Core SDK for Gemini Wallet integration with popup communication",main:"./dist/index.cjs",types:"./dist/index.d.ts",type:"module",repository:{type:"git",url:"git+https://github.com/gemini/gemini-wallet-core.git"},homepage:"https://keys.gemini.com",bugs:{url:"https://github.com/gemini/gemini-wallet-core/issues"},license:"MIT",author:"Gemini",files:["dist","src","README.md","LICENSE"],exports:{".":{types:"./dist/index.d.ts",import:"./dist/index.js",require:"./dist/index.cjs"},"./package.json":"./package.json"},scripts:{build:"dotenv -e .env.production -- tsup",dev:"dotenv -e .env.local -- tsup --watch",typecheck:"tsc --noEmit",lint:"eslint ./src","lint:ci":"eslint --max-warnings 0 ./src","lint:fix":"eslint ./src --fix",test:"bun test"},dependencies:{"@metamask/rpc-errors":"7.0.2",eventemitter3:"5.0.1"},devDependencies:{"@eslint/eslintrc":"3.3.1","@eslint/js":"9.38.0","@types/node":"22.13.0","dotenv-cli":"10.0.0","esbuild-plugin-replace":"1.4.0",eslint:"9.38.0","eslint-config-prettier":"10.1.8","eslint-config-turbo":"2.5.6","eslint-plugin-import":"2.32.0","eslint-plugin-only-warn":"1.1.0","eslint-plugin-prettier":"5.5.4","eslint-plugin-simple-import-sort":"12.1.1","eslint-plugin-sort-keys-fix":"1.1.2",globals:"16.4.0",prettier:"3.6.2",tsup:"8.5.0",typescript:"5.5.3","typescript-eslint":"8.40.0",vitest:"3.2.4"},peerDependencies:{viem:">=2.0.0"},keywords:["gemini","wallet","sdk","ethereum","web3","crypto"],module:"./dist/index.js"},Jt="https://keys.gemini.com",Ft=Jt,Ht="https://horizon-api.gemini.com/api/ens",zt=Mt.version,k=42161,Bt={ARBITRUM_ONE:42161,BASE:8453,ETHEREUM:1,OP_MAINNET:10,POLYGON:137},kt={ARBITRUM_SEPOLIA:421614,BASE_SEPOLIA:84532,OP_SEPOLIA:11155420,POLYGON_AMOY:80002,SEPOLIA:11155111},qt=[...Object.values(Bt),...Object.values(kt)];function ne(e){return{[le.id]:le.rpcUrls.default.http[0],[de.id]:de.rpcUrls.default.http[0],[he.id]:he.rpcUrls.default.http[0],[pe.id]:pe.rpcUrls.default.http[0],[ye.id]:ye.rpcUrls.default.http[0],[be.id]:be.rpcUrls.default.http[0],[ue.id]:ue.rpcUrls.default.http[0],[me.id]:me.rpcUrls.default.http[0],[fe.id]:fe.rpcUrls.default.http[0],[ge.id]:ge.rpcUrls.default.http[0]}[e]}var kn=420,qn=650,Vt=(e=>(e.POPUP_LOADED="POPUP_LOADED",e.POPUP_UNLOADED="POPUP_UNLOADED",e.POPUP_APP_CONTEXT="POPUP_APP_CONTEXT",e.SDK_CONNECT="SDK_CONNECT",e.SDK_DISCONNECT="SDK_DISCONNECT",e.SDK_SEND_TRANSACTION="SDK_SEND_TRANSACTION",e.SDK_SIGN_DATA="SDK_SIGN_DATA",e.SDK_SIGN_TYPED_DATA="SDK_SIGN_TYPED_DATA",e.SDK_SWITCH_CHAIN="SDK_SWITCH_CHAIN",e.SDK_OPEN_SETTINGS="SDK_OPEN_SETTINGS",e.SDK_CURRENT_ACCOUNT="SDK_CURRENT_ACCOUNT",e.SDK_SEND_BATCH_CALLS="SDK_SEND_BATCH_CALLS",e.SDK_GET_CAPABILITIES="SDK_GET_CAPABILITIES",e.SDK_GET_CALLS_STATUS="SDK_GET_CALLS_STATUS",e.SDK_SHOW_CALLS_STATUS="SDK_SHOW_CALLS_STATUS",e))(Vt||{}),Wn={REACT_NATIVE:"REACT_NATIVE",WEB:"WEB"},Wt=class extends Ue.default{};function Gt(e){let t;return typeof l<"u"?t=l.from(e).toString("base64"):t=btoa(Array.from(e).map(r=>String.fromCharCode(r)).join("")),t.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function Yt(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");for(;t.length%4!==0;)t+="=";if(typeof l<"u")return new Uint8Array(l.from(t,"base64"));{let r=atob(t),n=new Uint8Array(r.length);for(let i=0;i<r.length;i++)n[i]=r.charCodeAt(i);return n}}function Gn(e){let t=e instanceof Uint8Array?e:new Uint8Array(e);return Gt(t)}function Yn(e){if(typeof TextEncoder<"u")return new TextEncoder().encode(e);if(typeof l<"u")return new Uint8Array(l.from(e,"utf8"));{let t=new Uint8Array(e.length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t}}function Xn(e){let t=Yt(e);return Array.from(t).map(r=>r.toString(16).padStart(2,"0")).join("")}var pt={ATTESTER:"0x000474392a9cd86a4687354f1Ce2964B52e97484",BOOTSTRAPPER:"0x00000000D3254452a909E4eeD47455Af7E27C289",REGISTRY:"0x000000000069E2a187AEFFb852bF3cCdC95151B2"},Xt={...pt,ACCOUNT_IMPLEMENTATION:"0x00000000029d9c8b864DD51d6bb0d99FB72D650b",FACTORY:"0x000000000452377e1Bd9e72E939855ECb9363Cab",WEBAUTHN_VALIDATOR:"0x7ab16Ff354AcB328452F1D445b3Ddee9a91e9e69"},Qt={...pt,ACCOUNT_IMPLEMENTATION:"0x0006050168DE255a8672ACaD4821e721CBA44337",FACTORY:"0x00E58DF70FaB983a324c4C068c82d20407579FaC",WEBAUTHN_VALIDATOR:"0xbA45a2BFb8De3D24cA9D7F1B551E14dFF5d690Fd"};function ft(e,t){let{publicKey:r,credentialId:n,index:i=0n}=e;if(!r.startsWith("0x")||r.length!==130)throw new Error("Invalid public key: must be 64-byte hex string (0x + 128 chars)");let s=`0x${r.slice(2,66)}`,a=`0x${r.slice(66,130)}`,o={pubKeyX:BigInt(s),pubKeyY:BigInt(a)};if(!er(o))throw new Error("Invalid WebAuthn key: coordinates are not on secp256r1 curve");let c=Zt(n);return tr({authenticatorIdHash:c,contractAddresses:t,index:i,webAuthnData:o})}function Zn(e){return ft(e,Xt)}function ei(e){return ft(e,Qt)}function Zt(e){let t="=".repeat((4-e.length%4)%4),r=e.replace(/-/g,"+").replace(/_/g,"/")+t,n=atob(r),i=new Uint8Array(n.length);for(let s=0;s<n.length;s++)i[s]=n.charCodeAt(s);return V(i)}function er(e){let t=0xffffffff00000001000000000000000000000000ffffffffffffffffffffffffn,r=0x5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604bn,{pubKeyX:n,pubKeyY:i}=e;if(n===0n||i===0n||n>=t||i>=t)return!1;let s=i*i%t,a=n*n*n%t,o=3n*n%t,c=(a+t-o+r)%t;return s===c}function tr(e){let{webAuthnData:t,authenticatorIdHash:r,index:n,contractAddresses:i}=e,s=i.FACTORY,a=i.ACCOUNT_IMPLEMENTATION,o=i.WEBAUTHN_VALIDATOR,c=i.ATTESTER,f=i.BOOTSTRAPPER,y=i.REGISTRY,q=V(ce(["uint256","uint256","bytes32","uint256"],[t.pubKeyX,t.pubKeyY,r,n])),oe=W([{components:[{name:"pubKeyX",type:"uint256"},{name:"pubKeyY",type:"uint256"}],type:"tuple"},{type:"bytes32"}],[t,r]),ht=ae({abi:[{inputs:[{name:"validator",type:"address"},{name:"validatorInitData",type:"bytes"},{components:[{name:"registry",type:"address"},{name:"attesters",type:"address[]"},{name:"threshold",type:"uint8"}],name:"registryConfig",type:"tuple"}],name:"initNexusWithSingleValidator",type:"function"}],args:[o,oe,{attesters:[c],registry:y,threshold:1n}],functionName:"initNexusWithSingleValidator"}),mt=W([{type:"address"},{type:"bytes"}],[f,ht]);return rr(a,q,mt,s)}function rr(e,t,r,n){let i=ae({abi:[{inputs:[{name:"data",type:"bytes"}],name:"initializeAccount",type:"function"}],args:[r],functionName:"initializeAccount"}),s=W([{type:"address"},{type:"bytes"}],[e,i]),o=V(ce(["bytes","bytes"],["0x60806040526102c8803803806100148161018c565b92833981016040828203126101885781516001600160a01b03811692909190838303610188576020810151906001600160401b03821161018857019281601f8501121561018857835161006e610069826101c5565b61018c565b9481865260208601936020838301011161018857815f926020809301865e8601015260017f90b772c2cb8a51aa7a8a65fc23543c6d022d5b3f8e2b92eed79fba7eef8293005d823b15610176577f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc80546001600160a01b031916821790557fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b5f80a282511561015e575f8091610146945190845af43d15610156573d91610137610069846101c5565b9283523d5f602085013e6101e0565b505b6040516089908161023f8239f35b6060916101e0565b50505034156101485763b398979f60e01b5f5260045ffd5b634c9c8ce360e01b5f5260045260245ffd5b5f80fd5b6040519190601f01601f191682016001600160401b038111838210176101b157604052565b634e487b7160e01b5f52604160045260245ffd5b6001600160401b0381116101b157601f01601f191660200190565b9061020457508051156101f557805190602001fd5b63d6bda27560e01b5f5260045ffd5b81511580610235575b610215575090565b639996b31560e01b5f9081526001600160a01b0391909116600452602490fd5b50803b1561020d56fe608060405236156051577f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc545f9081906001600160a01b0316368280378136915af43d5f803e15604d573d5ff35b3d5ffd5b00fea264697066735822122041b5f70a351952142223f22504ca7b4e6d975f3a302d114ff820442fcf815ac264736f6c634300081b0033",s]));return ve({bytecodeHash:o,from:n,salt:t})}async function ti(e){try{let t=await fetch(`${Ht}/reverse/${e}`);if(!t.ok)throw new Error(`ENS API request failed: ${t.status} ${t.statusText}`);let r=await t.json();return{address:r.address,name:r.name||null}}catch(t){return console.error("Failed to resolve ENS name:",t),{address:e,name:null}}}var ct=420,dt=650,nr=e=>{let t=(window.innerWidth-ct)/2+window.screenX,r=(window.innerHeight-dt)/2+window.screenY,n=`wallet_${window?.crypto?.randomUUID()}`,i=window.open(e,n,`width=${ct}, height=${dt}, left=${t}, top=${r}`);if(i?.focus(),!i)throw m.internal("Pop up window failed to open");return i},ir=e=>{e&&!e.closed&&(e.opener?.focus(),e.close())},ie=e=>`0x${BigInt(e).toString(16)}`,sr=e=>JSON.stringify(e,(t,r)=>typeof r=="bigint"?r.toString()+"n":r,2),or=class{constructor({appMetadata:e,onDisconnectCallback:t}){this.popup=null,this.listeners=new Map,this.postMessage=async r=>{(await this.waitForPopupLoaded()).postMessage(r,this.url.origin)},this.postRequestAndWaitForResponse=async r=>{let n=this.onMessage(({requestId:i})=>i===r.requestId);return this.postMessage(r),await n},this.onMessage=r=>new Promise((n,i)=>{let s=a=>{if(a.origin!==this.url.origin)return;let o=a.data;r(o)&&(n(o),window.removeEventListener("message",s),this.listeners.delete(s))};window.addEventListener("message",s),this.listeners.set(s,{reject:i})}),this.onRequestCancelled=()=>{ir(this.popup),this.popup=null,this.listeners.forEach(({reject:r},n)=>{r(_.userRejectedRequest()),window.removeEventListener("message",n)}),this.listeners.clear()},this.waitForPopupLoaded=()=>this.popup&&!this.popup.closed?(this.popup.focus(),Promise.resolve(this.popup)):(this.popup=nr(this.url),this.onMessage(({event:r})=>r==="POPUP_UNLOADED").then(this.onRequestCancelled).catch(()=>{}),this.onMessage(({event:r})=>r==="SDK_DISCONNECT").then(()=>{this.onDisconnectCallback?.(),this.onRequestCancelled()}).catch(()=>{}),this.onMessage(({event:r})=>r==="POPUP_LOADED").then(r=>{this.postMessage({chainId:k,data:{appMetadata:this.appMetadata,origin:window.location.origin,sdkVersion:zt},event:"POPUP_APP_CONTEXT",origin:window.location.origin,requestId:r.requestId})}).then(()=>{if(!this.popup)throw m.internal();return this.popup})),this.url=new URL(Ft),this.appMetadata=e,this.onDisconnectCallback=t}},Re={},lt=class{constructor({scope:e="@gemini",module:t="wallet"}={}){this.scope=e,this.module=t}scopedKey(e){return`${this.scope}.${this.module}.${e}`}async storeObject(e,t){let r=sr(t);await this.setItem(e,r)}async loadObject(e,t){let r=await this.getItem(e);if(!r)return await this.storeObject(e,t),t;try{return JSON.parse(r)}catch(n){return console.error(`Error parsing JSON for key ${e}:`,n),t}}async setItem(e,t){let r=this.scopedKey(e);try{localStorage.setItem(r,t)}catch(n){console.warn("localStorage not available, using memory storage",n),Re[r]=t}}async getItem(e){let t=this.scopedKey(e);try{return localStorage.getItem(t)}catch(r){return console.warn("localStorage not available, using memory storage",r),Re[t]||null}}async removeItem(e){let t=this.scopedKey(e);try{localStorage.removeItem(t)}catch(r){console.warn("localStorage not available, using memory storage",r),delete Re[t]}}async removeItems(e){await Promise.all(e.map(t=>this.removeItem(t)))}},se="eth-accounts",De="eth-active-chain",ii="passkey-credential",si="preserved-passkey-credentials",oi="smart-account",ai="settings",ci="wc-requests",P="call-batches";function ar(e){return qt.includes(e)}var ut=class{constructor({appMetadata:e,chain:t,onDisconnectCallback:r,storage:n}){this.accounts=[],this.chain={id:k},this.communicator=new or({appMetadata:e,onDisconnectCallback:r}),this.storage=n||new lt;let i=t?.id??k,s=t?.rpcUrl??ne(i),a={id:i,rpcUrl:s};this.initPromise=this.initializeFromStorage(a)}async initializeFromStorage(e){let t={...e,rpcUrl:e.rpcUrl||ne(e.id)},[r,n]=await Promise.all([this.storage.loadObject(De,t),this.storage.loadObject(se,this.accounts)]);this.chain={...r,rpcUrl:r.rpcUrl||ne(r.id)},this.accounts=n}async ensureInitialized(){await this.initPromise}async connect(){await this.ensureInitialized();let e=await this.sendMessageToPopup({chainId:this.chain.id,event:"SDK_CONNECT",origin:window.location.origin});return this.accounts=e.data.address?[e.data.address]:[],await this.storage.storeObject(se,this.accounts),this.accounts}async disconnect(){await this.ensureInitialized(),this.accounts=[],await this.storage.storeObject(se,this.accounts)}async switchChain({id:e}){return await this.ensureInitialized(),ar(e)?(this.chain={id:e,rpcUrl:ne(e)},await this.storage.storeObject(De,this.chain),null):(await this.sendMessageToPopup({chainId:this.chain.id,data:e,event:"SDK_SWITCH_CHAIN",origin:window.location.origin})).data.error??"Unsupported chain."}async sendTransaction(e){return await this.ensureInitialized(),(await this.sendMessageToPopup({chainId:this.chain.id,data:e,event:"SDK_SEND_TRANSACTION",origin:window.location.origin})).data}async signData({message:e}){return await this.ensureInitialized(),(await this.sendMessageToPopup({chainId:this.chain.id,data:{message:e},event:"SDK_SIGN_DATA",origin:window.location.origin})).data}async signTypedData({message:e,types:t,primaryType:r,domain:n}){return await this.ensureInitialized(),(await this.sendMessageToPopup({chainId:this.chain.id,data:{domain:n,message:e,primaryType:r,types:t},event:"SDK_SIGN_TYPED_DATA",origin:window.location.origin})).data}async openSettings(){await this.ensureInitialized(),await this.sendMessageToPopup({chainId:this.chain.id,data:{},event:"SDK_OPEN_SETTINGS",origin:window.location.origin})}getCapabilities(e){let t={},r=e?.map(n=>parseInt(n,16))||[this.chain.id];for(let n of r){let i=ie(n);t[i]={atomic:{status:"supported"},paymasterService:{supported:!0}}}return t}async sendCalls(e){await this.ensureInitialized();let t=window?.crypto?.randomUUID()||`batch-${Date.now()}-${Math.random()}`,r=parseInt(e.chainId,16);if(r!==this.chain.id)throw new Error(`Chain mismatch. Expected ${this.chain.id}, got ${r}`);if(!e.calls||e.calls.length===0)throw new Error("No calls provided");let n={calls:e.calls,capabilities:e.capabilities,chainId:e.chainId,from:e.from,id:t,status:"pending",timestamp:Date.now()},i=await this.storage.loadObject(P,{});i[t]=n,await this.storage.storeObject(P,i);try{let s=await this.sendMessageToPopup({chainId:this.chain.id,data:{calls:e.calls},event:"SDK_SEND_BATCH_CALLS",origin:window.location.origin});if(s.data.error)throw new Error(s.data.error);return n.transactionHash=s.data.hash,n.status="pending",i[t]=n,await this.storage.storeObject(P,i),{capabilities:{caip345:{caip2:`eip155:${r}`,transactionHashes:[s.data.hash]}},id:t}}catch(s){throw n.status="failed",i[t]=n,await this.storage.storeObject(P,i),s}}async getCallsStatus(e){await this.ensureInitialized();let t=await this.storage.loadObject(P,{}),r=t[e];if(!r)throw new Error(`Unknown bundle ID: ${e}`);if(r.transactionHash&&this.chain.rpcUrl)try{let a=(await(await fetch(this.chain.rpcUrl,{body:JSON.stringify({id:1,jsonrpc:"2.0",method:"eth_getTransactionReceipt",params:[r.transactionHash]}),headers:{"Content-Type":"application/json"},method:"POST"})).json()).result;if(a){let o=a.status==="0x1"?"confirmed":"reverted";return r.status=o,t[e]=r,await this.storage.storeObject(P,t),{atomic:!0,chainId:r.chainId,id:e,receipts:[{blockHash:a.blockHash,blockNumber:a.blockNumber,gasUsed:a.gasUsed,logs:a.logs.map(c=>({address:c.address,data:c.data,topics:c.topics})),status:o==="confirmed"?"success":"reverted",transactionHash:a.transactionHash}],status:o==="confirmed"?200:500,version:"2.0.0"}}}catch(i){console.error("Failed to fetch transaction receipt:",i)}let n;switch(r.status){case"pending":n=100;break;case"confirmed":n=200;break;case"failed":n=400;break;case"reverted":n=500;break;default:n=100}return{atomic:!0,chainId:r.chainId,id:e,status:n,version:"2.0.0"}}async showCallsStatus(e){if(await this.ensureInitialized(),!(await this.storage.loadObject(P,{}))[e])throw new Error(`Unknown bundle ID: ${e}`)}sendMessageToPopup(e){return this.communicator.postRequestAndWaitForResponse({...e,requestId:window?.crypto?.randomUUID()})}},cr=async(e,t)=>{let r={...e,id:window?.crypto?.randomUUID(),jsonrpc:"2.0"},n=await window.fetch(t,{body:JSON.stringify(r),headers:{"Content-Type":"application/json"},method:"POST",mode:"cors"}),{result:i,error:s}=await n.json();if(s)throw s;return i};function dr(e){if(!e||typeof e!="object"||Array.isArray(e))throw m.invalidParams({message:"Expected a single, non-array, object argument."});let{method:t,params:r}=e;if(typeof t!="string"||t.length===0)throw m.invalidParams({message:"'args.method' must be a non-empty string."});if(r!==void 0&&!Array.isArray(r)&&(typeof r!="object"||r===null))throw m.invalidParams({message:"'args.params' must be an object or array if provided."})}function ur(e){let t=["value","gas","gasPrice","maxPriorityFeePerGas","maxFeePerGas"],r={...e};for(let n of t){if(!(n in e))continue;let i=e[n];typeof i!="bigint"&&je(i)&&(r[n]=BigInt(i))}return r}var pi=class extends Wt{constructor(e){super(),this.wallet=null,this.config=e;let t=e.onDisconnectCallback;this.wallet=new ut({...e,onDisconnectCallback:()=>{t?.(),this.disconnect()}})}async request(e){try{if(dr(e),!this.wallet?.accounts?.length)switch(e.method){case"eth_requestAccounts":{if(!this.wallet){let n=this.config.onDisconnectCallback;this.wallet=new ut({...this.config,onDisconnectCallback:()=>{n?.(),this.disconnect()}})}await this.wallet.connect(),this.emit("accountsChanged",this.wallet.accounts);break}case"net_version":return k;case"eth_chainId":return ie(k);default:throw _.unauthorized()}let t,r;switch(e.method){case"eth_requestAccounts":case"eth_accounts":t=this.wallet.accounts;break;case"net_version":t=this.wallet.chain.id;break;case"eth_chainId":t=ie(this.wallet.chain.id);break;case"personal_sign":case"wallet_sign":if(r=e.params,t=await this.wallet.signData({account:r[1],message:r[0]}),t.error)throw m.transactionRejected(t.error);t=t.hash;break;case"eth_sendTransaction":case"wallet_sendTransaction":if(r=e.params,r=ur(r[0]),t=await this.wallet.sendTransaction(r),t.error)throw m.transactionRejected(t.error);t=t.hash;break;case"wallet_switchEthereumChain":{let n=e.params,i;if(Array.isArray(n)&&n[0]?.chainId)i=parseInt(n[0].chainId,16);else if(n&&typeof n=="object"&&"id"in n&&Number.isInteger(n.id))i=n.id;else throw m.invalidParams("Invalid chain id argument. Expected [{ chainId: hex_string }] or { id: number }.");if(t=await this.wallet.switchChain({id:i}),t)throw _.custom({code:4902,message:t});await this.emit("chainChanged",ie(i));break}case"eth_signTypedData_v1":case"eth_signTypedData_v2":case"eth_signTypedData_v3":case"eth_signTypedData_v4":case"eth_signTypedData":{r=e.params;let n=JSON.parse(r[1]);if(t=await this.wallet.signTypedData({account:r[0],domain:n.domain,message:n.message,primaryType:n.primaryType,types:n.types}),t.error)throw m.transactionRejected(t.error);t=t.hash;break}case"wallet_getCapabilities":{let n=Array.isArray(e.params)?e.params:void 0;t=this.getCapabilities(n);break}case"wallet_sendCalls":{r=e.params,t=await this.sendCalls(r[0]);break}case"wallet_getCallsStatus":{r=e.params,t=await this.getCallsStatus(r[0]);break}case"wallet_showCallsStatus":{r=e.params,await this.showCallsStatus(r[0]),t=null;break}case"eth_ecRecover":case"eth_subscribe":case"eth_unsubscribe":case"personal_ecRecover":case"eth_signTransaction":case"wallet_watchAsset":case"wallet_grantPermissions":throw m.methodNotSupported("Not yet implemented.");case"eth_sign":case"eth_coinbase":case"wallet_addEthereumChain":throw m.methodNotSupported();default:if(!this.wallet.chain.rpcUrl)throw m.internal(`RPC URL missing for current chain (${this.wallet.chain.id})`);return cr(e,this.wallet.chain.rpcUrl)}return t}catch(t){let{code:r}=t;return r===h.provider.unauthorized&&this.disconnect(),Promise.reject(Pe(t))}}async openSettings(){await this.wallet?.openSettings()}getCapabilities(e){if(!this.wallet)throw _.unauthorized();let t=e?.[0];return this.wallet.getCapabilities(t)}async sendCalls(e){if(!this.wallet)throw _.unauthorized();try{return await this.wallet.sendCalls(e)}catch(t){throw m.transactionRejected(t instanceof Error?t.message:String(t))}}async getCallsStatus(e){if(!this.wallet)throw _.unauthorized();try{return await this.wallet.getCallsStatus(e)}catch(t){throw m.invalidParams(t instanceof Error?t.message:String(t))}}async showCallsStatus(e){if(!this.wallet)throw _.unauthorized();try{await this.wallet.showCallsStatus(e)}catch(t){throw m.invalidParams(t instanceof Error?t.message:String(t))}}async disconnect(){if(this.wallet){let e=this.config.storage||new lt;await e.removeItem(se),await e.removeItem(De)}this.wallet=null,this.config.onDisconnectCallback?.(),await this.emit("disconnect","User initiated disconnection"),await this.emit("accountsChanged",[])}};export{or as Communicator,k as DEFAULT_CHAIN_ID,Vt as GeminiSdkEvent,lt as GeminiStorage,ut as GeminiWallet,pi as GeminiWalletProvider,qn as POPUP_HEIGHT,kn as POPUP_WIDTH,Wn as PlatformType,Wt as ProviderEventEmitter,Ft as SDK_BACKEND_URL,zt as SDK_VERSION,P as STORAGE_CALL_BATCHES_KEY,se as STORAGE_ETH_ACCOUNTS_KEY,De as STORAGE_ETH_ACTIVE_CHAIN_KEY,ii as STORAGE_PASSKEY_CREDENTIAL_KEY,si as STORAGE_PRESERVED_PASSKEY_CREDENTIALS_KEY,ai as STORAGE_SETTINGS_KEY,oi as STORAGE_SMART_ACCOUNT_KEY,ci as STORAGE_WC_REQUESTS_KEY,Xn as base64ToHex,Gn as bufferToBase64URLString,ei as calculateV1Address,Zn as calculateWalletAddress,ir as closePopup,ur as convertSendValuesToBigInt,Yt as decodeBase64,Gt as encodeBase64,cr as fetchRpcRequest,Zt as generateAuthenticatorIdHash,ie as hexStringFromNumber,ar as isChainSupportedByGeminiSw,nr as openPopup,ti as reverseResolveEns,sr as safeJsonStringify,Yn as utf8StringToBuffer,dr as validateRpcRequestArgs,er as validateWebAuthnKey};
