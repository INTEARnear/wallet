import{a as Za,b as Mt,c as un,d as We,e as sc,f as ic,g as Ms,h as rc}from"./chunk-6NRFW7F3.js";import"./chunk-X4QP7L3N.js";import{a as Ja,b as Qa,c as zi,d as ec,e as Hi,f as tc,g as ze,q as nc,r as oc}from"./chunk-VOEBYPFM.js";import{A as ts,B as js,C as Ss,D as Pt,E as le,G as an,I as cn,J as ye,L as Xa,M as we,N as ln,P as hn,Q as E,R as jt,a as re,b as Ga,d as As,o as _e,p as ge,q as Ke,t as q,u as nn,v as on,z as Ya}from"./chunk-ZTBYICLP.js";import{a as Ha,b as Wa,c as Bs,d as tt,e as ke}from"./chunk-A5AP7RRR.js";import"./chunk-ZS2R6O6N.js";import{a as en,b as _s,c as Cs,d as Fa,e as La,f as Da,g as ui,h as sn,i as qa,j as Ba,k as ja,l as od,m as Ma,n as $a,o as Va,q as Ka,r as ad,s as za}from"./chunk-SQN7L5MN.js";import{a as Qt}from"./chunk-7GZ7JYLK.js";import{a as tn,b as hi,d as qt,e as Bt,f as et,g as es,h as Vi,k as di,l as pi,m as yt,n as ct,o as rn,p as fi,q as Ki}from"./chunk-6HADIPAO.js";import"./chunk-2T4BE52W.js";import{a as Is,b as Tt,d as $i}from"./chunk-XQOHLC2A.js";import"./chunk-WVZCG2XE.js";import"./chunk-SH2H32CZ.js";import"./chunk-BDUWLAUS.js";import"./chunk-OBMTZ2R2.js";import"./chunk-6ZQQ3XQO.js";import{ka as Qr}from"./chunk-J26BEOSD.js";import"./chunk-MQMLE4BX.js";import"./chunk-UHIHVU5C.js";import"./chunk-EDRI7XUL.js";import{g as Dt,i as oe,j as Ie,k as ae,l as z,o as ce}from"./chunk-JY5TIRRF.js";oe();ce();ae();oe();ce();ae();oe();ce();ae();oe();ce();ae();oe();ce();ae();$i();oe();ce();ae();$i();oe();ce();ae();var $t=Dt(Za()),cd=Dt(Za());var ld={level:"info"},Zi="custom_context",gn=1e3*1024,hd=Object.defineProperty,ud=(s,e,t)=>e in s?hd(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ss=(s,e,t)=>ud(s,typeof e!="symbol"?e+"":e,t),dn=class{constructor(e){ss(this,"nodeValue"),ss(this,"sizeInBytes"),ss(this,"next"),this.nodeValue=e,this.sizeInBytes=new TextEncoder().encode(this.nodeValue).length,this.next=null}get value(){return this.nodeValue}get size(){return this.sizeInBytes}},Gi=class{constructor(e){ss(this,"lengthInNodes"),ss(this,"sizeInBytes"),ss(this,"head"),ss(this,"tail"),ss(this,"maxSizeInBytes"),this.head=null,this.tail=null,this.lengthInNodes=0,this.maxSizeInBytes=e,this.sizeInBytes=0}append(e){let t=new dn(e);if(t.size>this.maxSizeInBytes)throw new Error(`[LinkedList] Value too big to insert into list: ${e} with size ${t.size}`);for(;this.size+t.size>this.maxSizeInBytes;)this.shift();this.head?(this.tail&&(this.tail.next=t),this.tail=t):(this.head=t,this.tail=t),this.lengthInNodes++,this.sizeInBytes+=t.size}shift(){if(!this.head)return;let e=this.head;this.head=this.head.next,this.head||(this.tail=null),this.lengthInNodes--,this.sizeInBytes-=e.size}toArray(){let e=[],t=this.head;for(;t!==null;)e.push(t.value),t=t.next;return e}get length(){return this.lengthInNodes}get size(){return this.sizeInBytes}toOrderedArray(){return Array.from(this)}[Symbol.iterator](){let e=this.head;return{next:()=>{if(!e)return{done:!0,value:null};let t=e.value;return e=e.next,{done:!1,value:t}}}}},dd=Object.defineProperty,pd=(s,e,t)=>e in s?dd(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Wi=(s,e,t)=>pd(s,typeof e!="symbol"?e+"":e,t),Yi=class{constructor(e,t=gn){Wi(this,"logs"),Wi(this,"level"),Wi(this,"levelValue"),Wi(this,"MAX_LOG_SIZE_IN_BYTES"),this.level=e??"error",this.levelValue=$t.levels.values[this.level],this.MAX_LOG_SIZE_IN_BYTES=t,this.logs=new Gi(this.MAX_LOG_SIZE_IN_BYTES)}forwardToConsole(e,t){t===$t.levels.values.error?console.error(e):t===$t.levels.values.warn?console.warn(e):t===$t.levels.values.debug?console.debug(e):t===$t.levels.values.trace?console.trace(e):console.log(e)}appendToLogs(e){this.logs.append(hi({timestamp:new Date().toISOString(),log:e}));let t=typeof e=="string"?JSON.parse(e).level:e.level;t>=this.levelValue&&this.forwardToConsole(e,t)}getLogs(){return this.logs}clearLogs(){this.logs=new Gi(this.MAX_LOG_SIZE_IN_BYTES)}getLogArray(){return Array.from(this.logs)}logsToBlob(e){let t=this.getLogArray();return t.push(hi({extraMetadata:e})),new Blob(t,{type:"application/json"})}},fd=Object.defineProperty,gd=(s,e,t)=>e in s?fd(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,yd=(s,e,t)=>gd(s,typeof e!="symbol"?e+"":e,t),pn=class{constructor(e,t=gn){yd(this,"baseChunkLogger"),this.baseChunkLogger=new Yi(e,t)}write(e){this.baseChunkLogger.appendToLogs(e)}getLogs(){return this.baseChunkLogger.getLogs()}clearLogs(){this.baseChunkLogger.clearLogs()}getLogArray(){return this.baseChunkLogger.getLogArray()}logsToBlob(e){return this.baseChunkLogger.logsToBlob(e)}downloadLogsBlobInBrowser(e){let t=URL.createObjectURL(this.logsToBlob(e)),i=document.createElement("a");i.href=t,i.download=`walletconnect-logs-${new Date().toISOString()}.txt`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(t)}},md=Object.defineProperty,wd=(s,e,t)=>e in s?md(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,bd=(s,e,t)=>wd(s,typeof e!="symbol"?e+"":e,t),fn=class{constructor(e,t=gn){bd(this,"baseChunkLogger"),this.baseChunkLogger=new Yi(e,t)}write(e){this.baseChunkLogger.appendToLogs(e)}getLogs(){return this.baseChunkLogger.getLogs()}clearLogs(){this.baseChunkLogger.clearLogs()}getLogArray(){return this.baseChunkLogger.getLogArray()}logsToBlob(e){return this.baseChunkLogger.logsToBlob(e)}},vd=Object.defineProperty,Ed=Object.defineProperties,Id=Object.getOwnPropertyDescriptors,ac=Object.getOwnPropertySymbols,_d=Object.prototype.hasOwnProperty,Cd=Object.prototype.propertyIsEnumerable,cc=(s,e,t)=>e in s?vd(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Xi=(s,e)=>{for(var t in e||(e={}))_d.call(e,t)&&cc(s,t,e[t]);if(ac)for(var t of ac(e))Cd.call(e,t)&&cc(s,t,e[t]);return s},Ji=(s,e)=>Ed(s,Id(e));function lc(s){return Ji(Xi({},s),{level:s?.level||ld.level})}function Ad(s,e,t=Zi){return s[t]=e,s}function Ue(s,e=Zi){return s[e]||""}function Sd(s,e,t=Zi){let i=Ue(s,t);return i.trim()?`${i}/${e}`:e}function Ge(s,e,t=Zi){let i=Sd(s,e,t),r=s.child({context:i});return Ad(r,i,t)}function Nd(s){var e,t;let i=new pn((e=s.opts)==null?void 0:e.level,s.maxSizeInBytes);return{logger:(0,$t.default)(Ji(Xi({},s.opts),{level:"trace",browser:Ji(Xi({},(t=s.opts)==null?void 0:t.browser),{write:r=>i.write(r)})})),chunkLoggerController:i}}function Od(s){var e;let t=new fn((e=s.opts)==null?void 0:e.level,s.maxSizeInBytes);return{logger:(0,$t.default)(Ji(Xi({},s.opts),{level:"trace"}),t),chunkLoggerController:t}}function Qi(s){return typeof s.loggerOverride<"u"&&typeof s.loggerOverride!="string"?{logger:s.loggerOverride,chunkLoggerController:null}:typeof window<"u"?Nd(s):Od(s)}oe();ce();ae();$i();var Td=Object.defineProperty,Pd=(s,e,t)=>e in s?Td(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,hc=(s,e,t)=>Pd(s,typeof e!="symbol"?e+"":e,t),er=class extends _s{constructor(e){super(),this.opts=e,hc(this,"protocol","wc"),hc(this,"version",2)}};var Rd=Object.defineProperty,xd=(s,e,t)=>e in s?Rd(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,kd=(s,e,t)=>xd(s,typeof e!="symbol"?e+"":e,t),tr=class extends _s{constructor(e,t){super(),this.core=e,this.logger=t,kd(this,"records",new Map)}},sr=class{constructor(e,t){this.logger=e,this.core=t}},ir=class extends _s{constructor(e,t){super(),this.relayer=e,this.logger=t}},rr=class extends _s{constructor(e){super()}},nr=class{constructor(e,t,i,r){this.core=e,this.logger=t,this.name=i}};var or=class extends _s{constructor(e,t){super(),this.relayer=e,this.logger=t}};var ar=class extends _s{constructor(e,t){super(),this.core=e,this.logger=t}};var cr=class{constructor(e,t,i){this.core=e,this.logger=t,this.store=i}},lr=class{constructor(e,t){this.projectId=e,this.logger=t}},hr=class{constructor(e,t,i){this.core=e,this.logger=t,this.telemetryEnabled=i}},Ud=Object.defineProperty,Fd=(s,e,t)=>e in s?Ud(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,uc=(s,e,t)=>Fd(s,typeof e!="symbol"?e+"":e,t);var ur=class{constructor(e){this.opts=e,uc(this,"protocol","wc"),uc(this,"version",2)}};var dr=class{constructor(e){this.client=e}};var $=Dt(en(),1);oe();ce();ae();var Wt=Dt(en(),1),Et=Dt(ja(),1),Hc=Dt(od(),1);var Wc=Dt(ad(),1);var Ld=":";function _t(s){let[e,t]=s.split(Ld);return{namespace:e,reference:t}}function Gc(s,e){return s.includes(":")?[s]:e.chains||[]}var Dd=Object.defineProperty,qd=Object.defineProperties,Bd=Object.getOwnPropertyDescriptors,dc=Object.getOwnPropertySymbols,jd=Object.prototype.hasOwnProperty,Md=Object.prototype.propertyIsEnumerable,On=(s,e,t)=>e in s?Dd(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,pc=(s,e)=>{for(var t in e||(e={}))jd.call(e,t)&&On(s,t,e[t]);if(dc)for(var t of dc(e))Md.call(e,t)&&On(s,t,e[t]);return s},$d=(s,e)=>qd(s,Bd(e)),fc=(s,e,t)=>On(s,typeof e!="symbol"?e+"":e,t),Vd="ReactNative",Xe={reactNative:"react-native",node:"node",browser:"browser",unknown:"unknown"};var Kd="js";function _i(){return typeof Ie<"u"&&typeof Ie.versions<"u"&&typeof Ie.versions.node<"u"}function Yt(){return!(0,Et.getDocument)()&&!!(0,Et.getNavigator)()&&navigator.product===Vd}function Yc(){return Yt()&&typeof globalThis<"u"&&typeof globalThis?.Platform<"u"&&globalThis?.Platform.OS==="android"}function Xc(){return Yt()&&typeof globalThis<"u"&&typeof globalThis?.Platform<"u"&&globalThis?.Platform.OS==="ios"}function xs(){return!_i()&&!!(0,Et.getNavigator)()&&!!(0,Et.getDocument)()}function Ci(){return Yt()?Xe.reactNative:_i()?Xe.node:xs()?Xe.browser:Xe.unknown}function Gn(){var s;try{return Yt()&&typeof globalThis<"u"&&typeof globalThis?.Application<"u"?(s=globalThis.Application)==null?void 0:s.applicationId:void 0}catch{return}}function zd(s,e){let t=new URLSearchParams(s);return Object.entries(e).sort(([i],[r])=>i.localeCompare(r)).forEach(([i,r])=>{r!=null&&t.set(i,String(r))}),t.toString()}function Jc(s){var e,t;let i=Yn();try{return s!=null&&s.url&&i.url&&new URL(s.url).host!==new URL(i.url).host&&(console.warn(`The configured WalletConnect 'metadata.url':${s.url} differs from the actual page url:${i.url}. This is probably unintended and can lead to issues.`),s.url=i.url),(e=s?.icons)!=null&&e.length&&s.icons.length>0&&(s.icons=s.icons.filter(r=>r!=="")),$d(pc(pc({},i),s),{url:s?.url||i.url,name:s?.name||i.name,description:s?.description||i.description,icons:(t=s?.icons)!=null&&t.length&&s.icons.length>0?s.icons:i.icons})}catch(r){return console.warn("Error populating app metadata",r),s||i}}function Yn(){return(0,Hc.getWindowMetadata)()||{name:"",description:"",url:"",icons:[""]}}function Hd(){if(Ci()===Xe.reactNative&&typeof globalThis<"u"&&typeof globalThis?.Platform<"u"){let{OS:t,Version:i}=globalThis.Platform;return[t,i].join("-")}let s=Ba();if(s===null)return"unknown";let e=s.os?s.os.replace(" ","").toLowerCase():"unknown";return s.type==="browser"?[e,s.name,s.version].join("-"):[e,s.version].join("-")}function Wd(){var s;let e=Ci();return e===Xe.browser?[e,((s=(0,Et.getLocation)())==null?void 0:s.host)||"unknown"].join(":"):e}function Xn(s,e,t){let i=Hd(),r=Wd();return[[s,e].join("-"),[Kd,t].join("-"),i,r].join("/")}function Zc({protocol:s,version:e,relayUrl:t,sdkVersion:i,auth:r,projectId:n,useOnCloseEvent:o,bundleId:a,packageName:c}){let l=t.split("?"),h=Xn(s,e,i),d={auth:r,ua:h,projectId:n,useOnCloseEvent:o||void 0,packageName:c||void 0,bundleId:a||void 0},u=zd(l[1]||"",d);return l[0]+"?"+u}function Ns(s,e){return s.filter(t=>e.includes(t)).length===s.length}function Sr(s){return Object.fromEntries(s.entries())}function Nr(s){return new Map(Object.entries(s))}function Xt(s=Wt.FIVE_MINUTES,e){let t=(0,Wt.toMiliseconds)(s||Wt.FIVE_MINUTES),i,r,n,o;return{resolve:a=>{n&&i&&(clearTimeout(n),i(a),o=Promise.resolve(a))},reject:a=>{n&&r&&(clearTimeout(n),r(a))},done:()=>new Promise((a,c)=>{if(o)return a(o);n=setTimeout(()=>{let l=new Error(e);o=Promise.reject(l),c(l)},t),i=a,r=c})}}function Ct(s,e,t){return new Promise(async(i,r)=>{let n=setTimeout(()=>r(new Error(t)),e);try{let o=await s;i(o)}catch(o){r(o)}clearTimeout(n)})}function Qc(s,e){if(typeof e=="string"&&e.startsWith(`${s}:`))return e;if(s.toLowerCase()==="topic"){if(typeof e!="string")throw new Error('Value must be "string" for expirer target type: topic');return`topic:${e}`}else if(s.toLowerCase()==="id"){if(typeof e!="number")throw new Error('Value must be "number" for expirer target type: id');return`id:${e}`}throw new Error(`Unknown expirer target type: ${s}`)}function el(s){return Qc("topic",s)}function tl(s){return Qc("id",s)}function Or(s){let[e,t]=s.split(":"),i={id:void 0,topic:void 0};if(e==="topic"&&typeof t=="string")i.topic=t;else if(e==="id"&&Number.isInteger(Number(t)))i.id=Number(t);else throw new Error(`Invalid target, expected id:number or topic:string, got ${e}:${t}`);return i}function me(s,e){return(0,Wt.fromMiliseconds)((e||Date.now())+(0,Wt.toMiliseconds)(s))}function rt(s){return Date.now()>=(0,Wt.toMiliseconds)(s)}function se(s,e){return`${s}${e?`:${e}`:""}`}function bt(s=[],e=[]){return[...new Set([...s,...e])]}async function sl({id:s,topic:e,wcDeepLink:t}){var i;try{if(!t)return;let r=typeof t=="string"?JSON.parse(t):t,n=r?.href;if(typeof n!="string")return;let o=Gd(n,s,e),a=Ci();if(a===Xe.browser){if(!((i=(0,Et.getDocument)())!=null&&i.hasFocus())){console.warn("Document does not have focus, skipping deeplink.");return}Yd(o)}else a===Xe.reactNative&&typeof globalThis?.Linking<"u"&&await globalThis.Linking.openURL(o)}catch(r){console.error(r)}}function Gd(s,e,t){let i=`requestId=${e}&sessionTopic=${t}`;s.endsWith("/")&&(s=s.slice(0,-1));let r=`${s}`;if(s.startsWith("https://t.me")){let n=s.includes("?")?"&startapp=":"?startapp=";r=`${r}${n}${Zd(i,!0)}`}else r=`${r}/wc?${i}`;return r}function Yd(s){let e="_self";Jd()?e="_top":(Xd()||s.startsWith("https://")||s.startsWith("http://"))&&(e="_blank"),window.open(s,e,"noreferrer noopener")}async function il(s,e){let t="";try{if(xs()&&(t=localStorage.getItem(e),t))return t;t=await s.getItem(e)}catch(i){console.error(i)}return t}function Jn(s,e){if(!s.includes(e))return null;let t=s.split(/([&,?,=])/),i=t.indexOf(e);return t[i+2]}function Zn(){return typeof crypto<"u"&&crypto!=null&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/gu,s=>{let e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}function Ai(){return typeof Ie<"u"&&Ie.env.IS_VITEST==="true"}function Xd(){return typeof window<"u"&&(!!window.TelegramWebviewProxy||!!window.Telegram||!!window.TelegramWebviewProxyProto)}function Jd(){try{return window.self!==window.top}catch{return!1}}function Zd(s,e=!1){let t=z.from(s).toString("base64");return e?t.replace(/[=]/g,""):t}function rl(s){return z.from(s,"base64").toString("utf-8")}function nl(s){return new Promise(e=>setTimeout(e,s))}var wr=class{constructor({limit:e}){fc(this,"limit"),fc(this,"set"),this.limit=e,this.set=new Set}add(e){if(!this.set.has(e)){if(this.set.size>=this.limit){let t=this.set.values().next().value;t&&this.set.delete(t)}this.set.add(e)}}has(e){return this.set.has(e)}},pr=BigInt(2**32-1),gc=BigInt(32);function ol(s,e=!1){return e?{h:Number(s&pr),l:Number(s>>gc&pr)}:{h:Number(s>>gc&pr)|0,l:Number(s&pr)|0}}function al(s,e=!1){let t=s.length,i=new Uint32Array(t),r=new Uint32Array(t);for(let n=0;n<t;n++){let{h:o,l:a}=ol(s[n],e);[i[n],r[n]]=[o,a]}return[i,r]}var yc=(s,e,t)=>s>>>t,mc=(s,e,t)=>s<<32-t|e>>>t,ls=(s,e,t)=>s>>>t|e<<32-t,hs=(s,e,t)=>s<<32-t|e>>>t,mi=(s,e,t)=>s<<64-t|e>>>t-32,wi=(s,e,t)=>s>>>t-32|e<<64-t,Qd=(s,e)=>e,ep=(s,e)=>s,tp=(s,e,t)=>s<<t|e>>>32-t,sp=(s,e,t)=>e<<t|s>>>32-t,ip=(s,e,t)=>e<<t-32|s>>>64-t,rp=(s,e,t)=>s<<t-32|e>>>64-t;function wt(s,e,t,i){let r=(e>>>0)+(i>>>0);return{h:s+t+(r/2**32|0)|0,l:r|0}}var Qn=(s,e,t)=>(s>>>0)+(e>>>0)+(t>>>0),eo=(s,e,t,i)=>e+t+i+(s/2**32|0)|0,np=(s,e,t,i)=>(s>>>0)+(e>>>0)+(t>>>0)+(i>>>0),op=(s,e,t,i,r)=>e+t+i+r+(s/2**32|0)|0,ap=(s,e,t,i,r)=>(s>>>0)+(e>>>0)+(t>>>0)+(i>>>0)+(r>>>0),cp=(s,e,t,i,r,n)=>e+t+i+r+n+(s/2**32|0)|0,$s=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;function Tr(s){return s instanceof Uint8Array||ArrayBuffer.isView(s)&&s.constructor.name==="Uint8Array"}function Gt(s){if(!Number.isSafeInteger(s)||s<0)throw new Error("positive integer expected, got "+s)}function It(s,...e){if(!Tr(s))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(s.length))throw new Error("Uint8Array expected of length "+e+", got length="+s.length)}function Pr(s){if(typeof s!="function"||typeof s.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");Gt(s.outputLen),Gt(s.blockLen)}function fs(s,e=!0){if(s.destroyed)throw new Error("Hash instance has been destroyed");if(e&&s.finished)throw new Error("Hash#digest() has already been called")}function to(s,e){It(s);let t=e.outputLen;if(s.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function vi(s){return new Uint32Array(s.buffer,s.byteOffset,Math.floor(s.byteLength/4))}function lt(...s){for(let e=0;e<s.length;e++)s[e].fill(0)}function yn(s){return new DataView(s.buffer,s.byteOffset,s.byteLength)}function Rt(s,e){return s<<32-e|s>>>e}var cl=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function ll(s){return s<<24&4278190080|s<<8&16711680|s>>>8&65280|s>>>24&255}var Kt=cl?s=>s:s=>ll(s);function lp(s){for(let e=0;e<s.length;e++)s[e]=ll(s[e]);return s}var us=cl?s=>s:lp,hl=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",hp=Array.from({length:256},(s,e)=>e.toString(16).padStart(2,"0"));function zs(s){if(It(s),hl)return s.toHex();let e="";for(let t=0;t<s.length;t++)e+=hp[s[t]];return e}var Vt={_0:48,_9:57,A:65,F:70,a:97,f:102};function wc(s){if(s>=Vt._0&&s<=Vt._9)return s-Vt._0;if(s>=Vt.A&&s<=Vt.F)return s-(Vt.A-10);if(s>=Vt.a&&s<=Vt.f)return s-(Vt.a-10)}function br(s){if(typeof s!="string")throw new Error("hex string expected, got "+typeof s);if(hl)return Uint8Array.fromHex(s);let e=s.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);let i=new Uint8Array(t);for(let r=0,n=0;r<t;r++,n+=2){let o=wc(s.charCodeAt(n)),a=wc(s.charCodeAt(n+1));if(o===void 0||a===void 0){let c=s[n]+s[n+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+n)}i[r]=o*16+a}return i}function ul(s){if(typeof s!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(s))}function vt(s){return typeof s=="string"&&(s=ul(s)),It(s),s}function ds(...s){let e=0;for(let i=0;i<s.length;i++){let r=s[i];It(r),e+=r.length}let t=new Uint8Array(e);for(let i=0,r=0;i<s.length;i++){let n=s[i];t.set(n,r),r+=n.length}return t}var Ws=class{};function Si(s){let e=i=>s().update(vt(i)).digest(),t=s();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>s(),e}function up(s){let e=(i,r)=>s(r).update(vt(i)).digest(),t=s({});return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=i=>s(i),e}function ks(s=32){if($s&&typeof $s.getRandomValues=="function")return $s.getRandomValues(new Uint8Array(s));if($s&&typeof $s.randomBytes=="function")return Uint8Array.from($s.randomBytes(s));throw new Error("crypto.getRandomValues must be defined")}var dp=BigInt(0),gi=BigInt(1),pp=BigInt(2),fp=BigInt(7),gp=BigInt(256),yp=BigInt(113),dl=[],pl=[],fl=[];for(let s=0,e=gi,t=1,i=0;s<24;s++){[t,i]=[i,(2*t+3*i)%5],dl.push(2*(5*i+t)),pl.push((s+1)*(s+2)/2%64);let r=dp;for(let n=0;n<7;n++)e=(e<<gi^(e>>fp)*yp)%gp,e&pp&&(r^=gi<<(gi<<BigInt(n))-gi);fl.push(r)}var gl=al(fl,!0),mp=gl[0],wp=gl[1],bc=(s,e,t)=>t>32?ip(s,e,t):tp(s,e,t),vc=(s,e,t)=>t>32?rp(s,e,t):sp(s,e,t);function bp(s,e=24){let t=new Uint32Array(10);for(let i=24-e;i<24;i++){for(let o=0;o<10;o++)t[o]=s[o]^s[o+10]^s[o+20]^s[o+30]^s[o+40];for(let o=0;o<10;o+=2){let a=(o+8)%10,c=(o+2)%10,l=t[c],h=t[c+1],d=bc(l,h,1)^t[a],u=vc(l,h,1)^t[a+1];for(let p=0;p<50;p+=10)s[o+p]^=d,s[o+p+1]^=u}let r=s[2],n=s[3];for(let o=0;o<24;o++){let a=pl[o],c=bc(r,n,a),l=vc(r,n,a),h=dl[o];r=s[h],n=s[h+1],s[h]=c,s[h+1]=l}for(let o=0;o<50;o+=10){for(let a=0;a<10;a++)t[a]=s[o+a];for(let a=0;a<10;a++)s[o+a]^=~t[(a+2)%10]&t[(a+4)%10]}s[0]^=mp[i],s[1]^=wp[i]}lt(t)}var Tn=class s extends Ws{constructor(e,t,i,r=!1,n=24){if(super(),this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,this.enableXOF=!1,this.blockLen=e,this.suffix=t,this.outputLen=i,this.enableXOF=r,this.rounds=n,Gt(i),!(0<e&&e<200))throw new Error("only keccak-f1600 function is supported");this.state=new Uint8Array(200),this.state32=vi(this.state)}clone(){return this._cloneInto()}keccak(){us(this.state32),bp(this.state32,this.rounds),us(this.state32),this.posOut=0,this.pos=0}update(e){fs(this),e=vt(e),It(e);let{blockLen:t,state:i}=this,r=e.length;for(let n=0;n<r;){let o=Math.min(t-this.pos,r-n);for(let a=0;a<o;a++)i[this.pos++]^=e[n++];this.pos===t&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;let{state:e,suffix:t,pos:i,blockLen:r}=this;e[i]^=t,(t&128)!==0&&i===r-1&&this.keccak(),e[r-1]^=128,this.keccak()}writeInto(e){fs(this,!1),It(e),this.finish();let t=this.state,{blockLen:i}=this;for(let r=0,n=e.length;r<n;){this.posOut>=i&&this.keccak();let o=Math.min(i-this.posOut,n-r);e.set(t.subarray(this.posOut,this.posOut+o),r),this.posOut+=o,r+=o}return e}xofInto(e){if(!this.enableXOF)throw new Error("XOF is not possible for this instance");return this.writeInto(e)}xof(e){return Gt(e),this.xofInto(new Uint8Array(e))}digestInto(e){if(to(e,this),this.finished)throw new Error("digest() was already called");return this.writeInto(e),this.destroy(),e}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,lt(this.state)}_cloneInto(e){let{blockLen:t,suffix:i,outputLen:r,rounds:n,enableXOF:o}=this;return e||(e=new s(t,i,r,o,n)),e.state32.set(this.state32),e.pos=this.pos,e.posOut=this.posOut,e.finished=this.finished,e.rounds=n,e.suffix=i,e.outputLen=r,e.enableXOF=o,e.destroyed=this.destroyed,e}},vp=(s,e,t)=>Si(()=>new Tn(e,s,t)),Ep=vp(1,136,256/8);function Ip(s,e,t,i){if(typeof s.setBigUint64=="function")return s.setBigUint64(e,t,i);let r=BigInt(32),n=BigInt(4294967295),o=Number(t>>r&n),a=Number(t&n),c=i?4:0,l=i?0:4;s.setUint32(e+c,o,i),s.setUint32(e+l,a,i)}function _p(s,e,t){return s&e^~s&t}function Cp(s,e,t){return s&e^s&t^e&t}var vr=class extends Ws{constructor(e,t,i,r){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=i,this.isLE=r,this.buffer=new Uint8Array(e),this.view=yn(this.buffer)}update(e){fs(this),e=vt(e),It(e);let{view:t,buffer:i,blockLen:r}=this,n=e.length;for(let o=0;o<n;){let a=Math.min(r-this.pos,n-o);if(a===r){let c=yn(e);for(;r<=n-o;o+=r)this.process(c,o);continue}i.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===r&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){fs(this),to(e,this),this.finished=!0;let{buffer:t,view:i,blockLen:r,isLE:n}=this,{pos:o}=this;t[o++]=128,lt(this.buffer.subarray(o)),this.padOffset>r-o&&(this.process(i,0),o=0);for(let d=o;d<r;d++)t[d]=0;Ip(i,r-8,BigInt(this.length*8),n),this.process(i,0);let a=yn(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let l=c/4,h=this.get();if(l>h.length)throw new Error("_sha2: outputLen bigger than state");for(let d=0;d<l;d++)a.setUint32(4*d,h[d],n)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let i=e.slice(0,t);return this.destroy(),i}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:i,length:r,finished:n,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=n,e.length=r,e.pos=a,r%t&&e.buffer.set(i),e}clone(){return this._cloneInto()}},is=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Fe=Uint32Array.from([3418070365,3238371032,1654270250,914150663,2438529370,812702999,355462360,4144912697,1731405415,4290775857,2394180231,1750603025,3675008525,1694076839,1203062813,3204075428]),Le=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),Ap=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),rs=new Uint32Array(64),Pn=class extends vr{constructor(e=32){super(64,e,8,!1),this.A=is[0]|0,this.B=is[1]|0,this.C=is[2]|0,this.D=is[3]|0,this.E=is[4]|0,this.F=is[5]|0,this.G=is[6]|0,this.H=is[7]|0}get(){let{A:e,B:t,C:i,D:r,E:n,F:o,G:a,H:c}=this;return[e,t,i,r,n,o,a,c]}set(e,t,i,r,n,o,a,c){this.A=e|0,this.B=t|0,this.C=i|0,this.D=r|0,this.E=n|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let d=0;d<16;d++,t+=4)rs[d]=e.getUint32(t,!1);for(let d=16;d<64;d++){let u=rs[d-15],p=rs[d-2],f=Rt(u,7)^Rt(u,18)^u>>>3,g=Rt(p,17)^Rt(p,19)^p>>>10;rs[d]=g+rs[d-7]+f+rs[d-16]|0}let{A:i,B:r,C:n,D:o,E:a,F:c,G:l,H:h}=this;for(let d=0;d<64;d++){let u=Rt(a,6)^Rt(a,11)^Rt(a,25),p=h+u+_p(a,c,l)+Ap[d]+rs[d]|0,f=(Rt(i,2)^Rt(i,13)^Rt(i,22))+Cp(i,r,n)|0;h=l,l=c,c=a,a=o+p|0,o=n,n=r,r=i,i=p+f|0}i=i+this.A|0,r=r+this.B|0,n=n+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,h=h+this.H|0,this.set(i,r,n,o,a,c,l,h)}roundClean(){lt(rs)}destroy(){this.set(0,0,0,0,0,0,0,0),lt(this.buffer)}},yl=al(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(s=>BigInt(s))),Sp=yl[0],Np=yl[1],ns=new Uint32Array(80),os=new Uint32Array(80),Ei=class extends vr{constructor(e=64){super(128,e,16,!1),this.Ah=Le[0]|0,this.Al=Le[1]|0,this.Bh=Le[2]|0,this.Bl=Le[3]|0,this.Ch=Le[4]|0,this.Cl=Le[5]|0,this.Dh=Le[6]|0,this.Dl=Le[7]|0,this.Eh=Le[8]|0,this.El=Le[9]|0,this.Fh=Le[10]|0,this.Fl=Le[11]|0,this.Gh=Le[12]|0,this.Gl=Le[13]|0,this.Hh=Le[14]|0,this.Hl=Le[15]|0}get(){let{Ah:e,Al:t,Bh:i,Bl:r,Ch:n,Cl:o,Dh:a,Dl:c,Eh:l,El:h,Fh:d,Fl:u,Gh:p,Gl:f,Hh:g,Hl:y}=this;return[e,t,i,r,n,o,a,c,l,h,d,u,p,f,g,y]}set(e,t,i,r,n,o,a,c,l,h,d,u,p,f,g,y){this.Ah=e|0,this.Al=t|0,this.Bh=i|0,this.Bl=r|0,this.Ch=n|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=h|0,this.Fh=d|0,this.Fl=u|0,this.Gh=p|0,this.Gl=f|0,this.Hh=g|0,this.Hl=y|0}process(e,t){for(let R=0;R<16;R++,t+=4)ns[R]=e.getUint32(t),os[R]=e.getUint32(t+=4);for(let R=16;R<80;R++){let B=ns[R-15]|0,D=os[R-15]|0,U=ls(B,D,1)^ls(B,D,8)^yc(B,D,7),j=hs(B,D,1)^hs(B,D,8)^mc(B,D,7),M=ns[R-2]|0,S=os[R-2]|0,V=ls(M,S,19)^mi(M,S,61)^yc(M,S,6),H=hs(M,S,19)^wi(M,S,61)^mc(M,S,6),O=np(j,H,os[R-7],os[R-16]),m=op(O,U,V,ns[R-7],ns[R-16]);ns[R]=m|0,os[R]=O|0}let{Ah:i,Al:r,Bh:n,Bl:o,Ch:a,Cl:c,Dh:l,Dl:h,Eh:d,El:u,Fh:p,Fl:f,Gh:g,Gl:y,Hh:A,Hl:_}=this;for(let R=0;R<80;R++){let B=ls(d,u,14)^ls(d,u,18)^mi(d,u,41),D=hs(d,u,14)^hs(d,u,18)^wi(d,u,41),U=d&p^~d&g,j=u&f^~u&y,M=ap(_,D,j,Np[R],os[R]),S=cp(M,A,B,U,Sp[R],ns[R]),V=M|0,H=ls(i,r,28)^mi(i,r,34)^mi(i,r,39),O=hs(i,r,28)^wi(i,r,34)^wi(i,r,39),m=i&n^i&a^n&a,w=r&o^r&c^o&c;A=g|0,_=y|0,g=p|0,y=f|0,p=d|0,f=u|0,{h:d,l:u}=wt(l|0,h|0,S|0,V|0),l=a|0,h=c|0,a=n|0,c=o|0,n=i|0,o=r|0;let b=Qn(V,O,w);i=eo(b,S,H,m),r=b|0}({h:i,l:r}=wt(this.Ah|0,this.Al|0,i|0,r|0)),{h:n,l:o}=wt(this.Bh|0,this.Bl|0,n|0,o|0),{h:a,l:c}=wt(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:h}=wt(this.Dh|0,this.Dl|0,l|0,h|0),{h:d,l:u}=wt(this.Eh|0,this.El|0,d|0,u|0),{h:p,l:f}=wt(this.Fh|0,this.Fl|0,p|0,f|0),{h:g,l:y}=wt(this.Gh|0,this.Gl|0,g|0,y|0),{h:A,l:_}=wt(this.Hh|0,this.Hl|0,A|0,_|0),this.set(i,r,n,o,a,c,l,h,d,u,p,f,g,y,A,_)}roundClean(){lt(ns,os)}destroy(){lt(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},Rn=class extends Ei{constructor(){super(48),this.Ah=Fe[0]|0,this.Al=Fe[1]|0,this.Bh=Fe[2]|0,this.Bl=Fe[3]|0,this.Ch=Fe[4]|0,this.Cl=Fe[5]|0,this.Dh=Fe[6]|0,this.Dl=Fe[7]|0,this.Eh=Fe[8]|0,this.El=Fe[9]|0,this.Fh=Fe[10]|0,this.Fl=Fe[11]|0,this.Gh=Fe[12]|0,this.Gl=Fe[13]|0,this.Hh=Fe[14]|0,this.Hl=Fe[15]|0}},De=Uint32Array.from([573645204,4230739756,2673172387,3360449730,596883563,1867755857,2520282905,1497426621,2519219938,2827943907,3193839141,1401305490,721525244,746961066,246885852,2177182882]),xn=class extends Ei{constructor(){super(32),this.Ah=De[0]|0,this.Al=De[1]|0,this.Bh=De[2]|0,this.Bl=De[3]|0,this.Ch=De[4]|0,this.Cl=De[5]|0,this.Dh=De[6]|0,this.Dl=De[7]|0,this.Eh=De[8]|0,this.El=De[9]|0,this.Fh=De[10]|0,this.Fl=De[11]|0,this.Gh=De[12]|0,this.Gl=De[13]|0,this.Hh=De[14]|0,this.Hl=De[15]|0}},Rr=Si(()=>new Pn),Op=Si(()=>new Ei),Tp=Si(()=>new Rn),Pp=Si(()=>new xn),Rp=Uint8Array.from([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3,11,8,12,0,5,2,15,13,10,14,3,6,7,1,9,4,7,9,3,1,13,12,11,14,2,6,5,10,4,0,15,8,9,0,5,7,2,4,10,15,14,1,11,12,6,8,3,13,2,12,6,10,0,11,8,3,4,13,7,5,15,14,1,9,12,5,1,15,14,13,4,10,0,7,6,3,9,2,8,11,13,11,7,14,12,1,3,9,5,0,15,4,8,6,2,10,6,15,14,9,11,3,0,8,12,2,13,7,1,4,10,5,10,2,8,4,7,6,1,5,15,11,9,14,3,12,13,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3,11,8,12,0,5,2,15,13,10,14,3,6,7,1,9,4,7,9,3,1,13,12,11,14,2,6,5,10,4,0,15,8,9,0,5,7,2,4,10,15,14,1,11,12,6,8,3,13,2,12,6,10,0,11,8,3,4,13,7,5,15,14,1,9]),Se=Uint32Array.from([4089235720,1779033703,2227873595,3144134277,4271175723,1013904242,1595750129,2773480762,2917565137,1359893119,725511199,2600822924,4215389547,528734635,327033209,1541459225]),k=new Uint32Array(32);function as(s,e,t,i,r,n){let o=r[n],a=r[n+1],c=k[2*s],l=k[2*s+1],h=k[2*e],d=k[2*e+1],u=k[2*t],p=k[2*t+1],f=k[2*i],g=k[2*i+1],y=Qn(c,h,o);l=eo(y,l,d,a),c=y|0,{Dh:g,Dl:f}={Dh:g^l,Dl:f^c},{Dh:g,Dl:f}={Dh:Qd(g,f),Dl:ep(g)},{h:p,l:u}=wt(p,u,g,f),{Bh:d,Bl:h}={Bh:d^p,Bl:h^u},{Bh:d,Bl:h}={Bh:ls(d,h,24),Bl:hs(d,h,24)},k[2*s]=c,k[2*s+1]=l,k[2*e]=h,k[2*e+1]=d,k[2*t]=u,k[2*t+1]=p,k[2*i]=f,k[2*i+1]=g}function cs(s,e,t,i,r,n){let o=r[n],a=r[n+1],c=k[2*s],l=k[2*s+1],h=k[2*e],d=k[2*e+1],u=k[2*t],p=k[2*t+1],f=k[2*i],g=k[2*i+1],y=Qn(c,h,o);l=eo(y,l,d,a),c=y|0,{Dh:g,Dl:f}={Dh:g^l,Dl:f^c},{Dh:g,Dl:f}={Dh:ls(g,f,16),Dl:hs(g,f,16)},{h:p,l:u}=wt(p,u,g,f),{Bh:d,Bl:h}={Bh:d^p,Bl:h^u},{Bh:d,Bl:h}={Bh:mi(d,h,63),Bl:wi(d,h,63)},k[2*s]=c,k[2*s+1]=l,k[2*e]=h,k[2*e+1]=d,k[2*t]=u,k[2*t+1]=p,k[2*i]=f,k[2*i+1]=g}function xp(s,e={},t,i,r){if(Gt(t),s<0||s>t)throw new Error("outputLen bigger than keyLen");let{key:n,salt:o,personalization:a}=e;if(n!==void 0&&(n.length<1||n.length>t))throw new Error("key length must be undefined or 1.."+t);if(o!==void 0&&o.length!==i)throw new Error("salt must be undefined or "+i);if(a!==void 0&&a.length!==r)throw new Error("personalization must be undefined or "+r)}var kn=class extends Ws{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,this.length=0,this.pos=0,Gt(e),Gt(t),this.blockLen=e,this.outputLen=t,this.buffer=new Uint8Array(e),this.buffer32=vi(this.buffer)}update(e){fs(this),e=vt(e),It(e);let{blockLen:t,buffer:i,buffer32:r}=this,n=e.length,o=e.byteOffset,a=e.buffer;for(let c=0;c<n;){this.pos===t&&(us(r),this.compress(r,0,!1),us(r),this.pos=0);let l=Math.min(t-this.pos,n-c),h=o+c;if(l===t&&!(h%4)&&c+l<n){let d=new Uint32Array(a,h,Math.floor((n-c)/4));us(d);for(let u=0;c+t<n;u+=r.length,c+=t)this.length+=t,this.compress(d,u,!1);us(d);continue}i.set(e.subarray(c,c+l),this.pos),this.pos+=l,this.length+=l,c+=l}return this}digestInto(e){fs(this),to(e,this);let{pos:t,buffer32:i}=this;this.finished=!0,lt(this.buffer.subarray(t)),us(i),this.compress(i,0,!0),us(i);let r=vi(e);this.get().forEach((n,o)=>r[o]=Kt(n))}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let i=e.slice(0,t);return this.destroy(),i}_cloneInto(e){let{buffer:t,length:i,finished:r,destroyed:n,outputLen:o,pos:a}=this;return e||(e=new this.constructor({dkLen:o})),e.set(...this.get()),e.buffer.set(t),e.destroyed=n,e.finished=r,e.length=i,e.pos=a,e.outputLen=o,e}clone(){return this._cloneInto()}},Un=class extends kn{constructor(e={}){let t=e.dkLen===void 0?64:e.dkLen;super(128,t),this.v0l=Se[0]|0,this.v0h=Se[1]|0,this.v1l=Se[2]|0,this.v1h=Se[3]|0,this.v2l=Se[4]|0,this.v2h=Se[5]|0,this.v3l=Se[6]|0,this.v3h=Se[7]|0,this.v4l=Se[8]|0,this.v4h=Se[9]|0,this.v5l=Se[10]|0,this.v5h=Se[11]|0,this.v6l=Se[12]|0,this.v6h=Se[13]|0,this.v7l=Se[14]|0,this.v7h=Se[15]|0,xp(t,e,64,16,16);let{key:i,personalization:r,salt:n}=e,o=0;if(i!==void 0&&(i=vt(i),o=i.length),this.v0l^=this.outputLen|o<<8|65536|1<<24,n!==void 0){n=vt(n);let a=vi(n);this.v4l^=Kt(a[0]),this.v4h^=Kt(a[1]),this.v5l^=Kt(a[2]),this.v5h^=Kt(a[3])}if(r!==void 0){r=vt(r);let a=vi(r);this.v6l^=Kt(a[0]),this.v6h^=Kt(a[1]),this.v7l^=Kt(a[2]),this.v7h^=Kt(a[3])}if(i!==void 0){let a=new Uint8Array(this.blockLen);a.set(i),this.update(a)}}get(){let{v0l:e,v0h:t,v1l:i,v1h:r,v2l:n,v2h:o,v3l:a,v3h:c,v4l:l,v4h:h,v5l:d,v5h:u,v6l:p,v6h:f,v7l:g,v7h:y}=this;return[e,t,i,r,n,o,a,c,l,h,d,u,p,f,g,y]}set(e,t,i,r,n,o,a,c,l,h,d,u,p,f,g,y){this.v0l=e|0,this.v0h=t|0,this.v1l=i|0,this.v1h=r|0,this.v2l=n|0,this.v2h=o|0,this.v3l=a|0,this.v3h=c|0,this.v4l=l|0,this.v4h=h|0,this.v5l=d|0,this.v5h=u|0,this.v6l=p|0,this.v6h=f|0,this.v7l=g|0,this.v7h=y|0}compress(e,t,i){this.get().forEach((c,l)=>k[l]=c),k.set(Se,16);let{h:r,l:n}=ol(BigInt(this.length));k[24]=Se[8]^n,k[25]=Se[9]^r,i&&(k[28]=~k[28],k[29]=~k[29]);let o=0,a=Rp;for(let c=0;c<12;c++)as(0,4,8,12,e,t+2*a[o++]),cs(0,4,8,12,e,t+2*a[o++]),as(1,5,9,13,e,t+2*a[o++]),cs(1,5,9,13,e,t+2*a[o++]),as(2,6,10,14,e,t+2*a[o++]),cs(2,6,10,14,e,t+2*a[o++]),as(3,7,11,15,e,t+2*a[o++]),cs(3,7,11,15,e,t+2*a[o++]),as(0,5,10,15,e,t+2*a[o++]),cs(0,5,10,15,e,t+2*a[o++]),as(1,6,11,12,e,t+2*a[o++]),cs(1,6,11,12,e,t+2*a[o++]),as(2,7,8,13,e,t+2*a[o++]),cs(2,7,8,13,e,t+2*a[o++]),as(3,4,9,14,e,t+2*a[o++]),cs(3,4,9,14,e,t+2*a[o++]);this.v0l^=k[0]^k[16],this.v0h^=k[1]^k[17],this.v1l^=k[2]^k[18],this.v1h^=k[3]^k[19],this.v2l^=k[4]^k[20],this.v2h^=k[5]^k[21],this.v3l^=k[6]^k[22],this.v3h^=k[7]^k[23],this.v4l^=k[8]^k[24],this.v4h^=k[9]^k[25],this.v5l^=k[10]^k[26],this.v5h^=k[11]^k[27],this.v6l^=k[12]^k[28],this.v6h^=k[13]^k[29],this.v7l^=k[14]^k[30],this.v7h^=k[15]^k[31],lt(k)}destroy(){this.destroyed=!0,lt(this.buffer32),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},kp=up(s=>new Un(s)),Up="https://rpc.walletconnect.org/v1";function ml(s){let e=`Ethereum Signed Message:
${s.length}`,t=new TextEncoder().encode(e+s);return"0x"+z.from(Ep(t)).toString("hex")}async function Fp(s,e,t,i,r,n){switch(t.t){case"eip191":return await Lp(s,e,t.s);case"eip1271":return await Dp(s,e,t.s,i,r,n);default:throw new Error(`verifySignature failed: Attempted to verify CacaoSignature with unknown type: ${t.t}`)}}function Lp(s,e,t){let i=Ha.fromHex(t);return Wa.recoverAddress({payload:ml(e),signature:i}).toLowerCase()===s.toLowerCase()}async function Dp(s,e,t,i,r,n){let o=_t(i);if(!o.namespace||!o.reference)throw new Error(`isValidEip1271Signature failed: chainId must be in CAIP-2 format, received: ${i}`);try{let a="0x1626ba7e",c="0000000000000000000000000000000000000000000000000000000000000040",l=t.substring(2),h=(l.length/2).toString(16).padStart(64,"0"),d=(e.startsWith("0x")?e:ml(e)).substring(2),u=a+d+c+h+l,p=await fetch(`${n||Up}/?chainId=${i}&projectId=${r}`,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify({id:qp(),jsonrpc:"2.0",method:"eth_call",params:[{to:s,data:u},"latest"]})}),{result:f}=await p.json();return f?f.slice(0,a.length).toLowerCase()===a.toLowerCase():!1}catch(a){return console.error("isValidEip1271Signature: ",a),!1}}function qp(){return Date.now()+Math.floor(Math.random()*1e3)}function wl(s){let e=atob(s),t=new Uint8Array(e.length);for(let o=0;o<e.length;o++)t[o]=e.charCodeAt(o);let i=t[0];if(i===0)throw new Error("No signatures found");let r=1+i*64;if(t.length<r)throw new Error("Transaction data too short for claimed signature count");if(t.length<100)throw new Error("Transaction too short");let n=z.from(s,"base64").slice(1,65);return Qt.encode(n)}function bl(s){let e=new Uint8Array(z.from(s,"base64")),t=Array.from("TransactionData::").map(n=>n.charCodeAt(0)),i=new Uint8Array(t.length+e.length);i.set(t),i.set(e,t.length);let r=kp(i,{dkLen:32});return Qt.encode(r)}function so(s){let e=new Uint8Array(Rr(Bp(s)));return Qt.encode(e)}function Bp(s){if(s instanceof Uint8Array)return s;if(Array.isArray(s))return new Uint8Array(s);if(typeof s=="object"&&s!=null&&s.data)return new Uint8Array(Object.values(s.data));if(typeof s=="object"&&s)return new Uint8Array(Object.values(s));throw new Error("getNearUint8ArrayFromBytes: Unexpected result type from bytes array")}function io(s){let e=z.from(s,"base64"),t=Va(e).txn;if(!t)throw new Error("Invalid signed transaction: missing 'txn' field");let i=$a(t),r=z.from("TX"),n=z.concat([r,z.from(i)]),o=Pp(n);return Ma.encode(o).replace(/=+$/,"")}function mn(s){let e=[],t=BigInt(s);for(;t>=BigInt(128);)e.push(Number(t&BigInt(127)|BigInt(128))),t>>=BigInt(7);return e.push(Number(t)),z.from(e)}function vl(s){let e=z.from(s.signed.bodyBytes,"base64"),t=z.from(s.signed.authInfoBytes,"base64"),i=z.from(s.signature.signature,"base64"),r=[];r.push(z.from([10])),r.push(mn(e.length)),r.push(e),r.push(z.from([18])),r.push(mn(t.length)),r.push(t),r.push(z.from([26])),r.push(mn(i.length)),r.push(i);let n=z.concat(r),o=Rr(n);return z.from(o).toString("hex").toUpperCase()}function El(s){var e,t;let i=[];try{if(typeof s=="string")return i.push(s),i;if(typeof s!="object")return i;s!=null&&s.id&&i.push(s.id);let r=(t=(e=s?.capabilities)==null?void 0:e.caip345)==null?void 0:t.transactionHashes;r&&i.push(...r)}catch(r){console.warn("getWalletSendCallsHashes failed: ",r)}return i}var jp=Object.defineProperty,Mp=Object.defineProperties,$p=Object.getOwnPropertyDescriptors,Ec=Object.getOwnPropertySymbols,Vp=Object.prototype.hasOwnProperty,Kp=Object.prototype.propertyIsEnumerable,Ic=(s,e,t)=>e in s?jp(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,zp=(s,e)=>{for(var t in e||(e={}))Vp.call(e,t)&&Ic(s,t,e[t]);if(Ec)for(var t of Ec(e))Kp.call(e,t)&&Ic(s,t,e[t]);return s},Hp=(s,e)=>Mp(s,$p(e)),Wp="did:pkh:",ro=s=>s?.split(":"),Gp=s=>{let e=s&&ro(s);if(e)return s.includes(Wp)?e[3]:e[1]},xr=s=>{let e=s&&ro(s);if(e)return e[2]+":"+e[3]},Ni=s=>{let e=s&&ro(s);if(e)return e.pop()};async function no(s){let{cacao:e,projectId:t}=s,{s:i,p:r}=e,n=oo(r,r.iss),o=Ni(r.iss);return await Fp(o,n,i,xr(r.iss),t)}var oo=(s,e)=>{let t=`${s.domain} wants you to sign in with your Ethereum account:`,i=Ni(e);if(!s.aud&&!s.uri)throw new Error("Either `aud` or `uri` is required to construct the message");let r=s.statement||void 0,n=`URI: ${s.aud||s.uri}`,o=`Version: ${s.version}`,a=`Chain ID: ${Gp(e)}`,c=`Nonce: ${s.nonce}`,l=`Issued At: ${s.iat}`,h=s.exp?`Expiration Time: ${s.exp}`:void 0,d=s.nbf?`Not Before: ${s.nbf}`:void 0,u=s.requestId?`Request ID: ${s.requestId}`:void 0,p=s.resources?`Resources:${s.resources.map(g=>`
- ${g}`).join("")}`:void 0,f=Oi(s.resources);if(f){let g=Ii(f);r=tf(r,g)}return[t,i,"",r,"",n,o,a,c,l,h,d,u,p].filter(g=>g!=null).join(`
`)};function Yp(s){return z.from(JSON.stringify(s)).toString("base64")}function Xp(s){return JSON.parse(z.from(s,"base64").toString("utf-8"))}function Rs(s){if(!s)throw new Error("No recap provided, value is undefined");if(!s.att)throw new Error("No `att` property found");let e=Object.keys(s.att);if(!(e!=null&&e.length))throw new Error("No resources found in `att` property");e.forEach(t=>{let i=s.att[t];if(Array.isArray(i))throw new Error(`Resource must be an object: ${t}`);if(typeof i!="object")throw new Error(`Resource must be an object: ${t}`);if(!Object.keys(i).length)throw new Error(`Resource object is empty: ${t}`);Object.keys(i).forEach(r=>{let n=i[r];if(!Array.isArray(n))throw new Error(`Ability limits ${r} must be an array of objects, found: ${n}`);if(!n.length)throw new Error(`Value of ${r} is empty array, must be an array with objects`);n.forEach(o=>{if(typeof o!="object")throw new Error(`Ability limits (${r}) must be an array of objects, found: ${o}`)})})})}function Jp(s,e,t,i={}){return t?.sort((r,n)=>r.localeCompare(n)),{att:{[s]:Zp(e,t,i)}}}function Zp(s,e,t={}){e=e?.sort((r,n)=>r.localeCompare(n));let i=e.map(r=>({[`${s}/${r}`]:[t]}));return Object.assign({},...i)}function Il(s){return Rs(s),`urn:recap:${Yp(s).replace(/=/g,"")}`}function Ii(s){let e=Xp(s.replace("urn:recap:",""));return Rs(e),e}function _l(s,e,t){let i=Jp(s,e,t);return Il(i)}function Qp(s){return s&&s.includes("urn:recap:")}function Cl(s,e){let t=Ii(s),i=Ii(e),r=ef(t,i);return Il(r)}function ef(s,e){Rs(s),Rs(e);let t=Object.keys(s.att).concat(Object.keys(e.att)).sort((r,n)=>r.localeCompare(n)),i={att:{}};return t.forEach(r=>{var n,o;Object.keys(((n=s.att)==null?void 0:n[r])||{}).concat(Object.keys(((o=e.att)==null?void 0:o[r])||{})).sort((a,c)=>a.localeCompare(c)).forEach(a=>{var c,l;i.att[r]=Hp(zp({},i.att[r]),{[a]:((c=s.att[r])==null?void 0:c[a])||((l=e.att[r])==null?void 0:l[a])})})}),i}function tf(s="",e){Rs(e);let t="I further authorize the stated URI to perform the following actions on my behalf: ";if(s.includes(t))return s;let i=[],r=0;Object.keys(e.att).forEach(a=>{let c=Object.keys(e.att[a]).map(d=>({ability:d.split("/")[0],action:d.split("/")[1]}));c.sort((d,u)=>d.action.localeCompare(u.action));let l={};c.forEach(d=>{l[d.ability]||(l[d.ability]=[]),l[d.ability].push(d.action)});let h=Object.keys(l).map(d=>(r++,`(${r}) '${d}': '${l[d].join("', '")}' for '${a}'.`));i.push(h.join(", ").replace(".,","."))});let n=i.join(" "),o=`${t}${n}`;return`${s?s+" ":""}${o}`}function ao(s){var e;let t=Ii(s);Rs(t);let i=(e=t.att)==null?void 0:e.eip155;return i?Object.keys(i).map(r=>r.split("/")[1]):[]}function co(s){let e=Ii(s);Rs(e);let t=[];return Object.values(e.att).forEach(i=>{Object.values(i).forEach(r=>{var n;(n=r?.[0])!=null&&n.chains&&t.push(r[0].chains)})}),[...new Set(t.flat())]}function Oi(s){if(!s)return;let e=s?.[s.length-1];return Qp(e)?e:void 0}function Al(s){return s instanceof Uint8Array||ArrayBuffer.isView(s)&&s.constructor.name==="Uint8Array"}function Fn(s){if(typeof s!="boolean")throw new Error(`boolean expected, not ${s}`)}function wn(s){if(!Number.isSafeInteger(s)||s<0)throw new Error("positive integer expected, got "+s)}function Ye(s,...e){if(!Al(s))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(s.length))throw new Error("Uint8Array expected of length "+e+", got length="+s.length)}function _c(s,e=!0){if(s.destroyed)throw new Error("Hash instance has been destroyed");if(e&&s.finished)throw new Error("Hash#digest() has already been called")}function sf(s,e){Ye(s);let t=e.outputLen;if(s.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function ps(s){return new Uint32Array(s.buffer,s.byteOffset,Math.floor(s.byteLength/4))}function Gs(...s){for(let e=0;e<s.length;e++)s[e].fill(0)}function rf(s){return new DataView(s.buffer,s.byteOffset,s.byteLength)}var nf=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function of(s){if(typeof s!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(s))}function Ln(s){if(typeof s=="string")s=of(s);else if(Al(s))s=Dn(s);else throw new Error("Uint8Array expected, got "+typeof s);return s}function af(s,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(s,e)}function cf(s,e){if(s.length!==e.length)return!1;let t=0;for(let i=0;i<s.length;i++)t|=s[i]^e[i];return t===0}var lf=(s,e)=>{function t(i,...r){if(Ye(i),!nf)throw new Error("Non little-endian hardware is not yet supported");if(s.nonceLength!==void 0){let l=r[0];if(!l)throw new Error("nonce / iv required");s.varSizeNonce?Ye(l):Ye(l,s.nonceLength)}let n=s.tagLength;n&&r[1]!==void 0&&Ye(r[1]);let o=e(i,...r),a=(l,h)=>{if(h!==void 0){if(l!==2)throw new Error("cipher output not supported");Ye(h)}},c=!1;return{encrypt(l,h){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,Ye(l),a(o.encrypt.length,h),o.encrypt(l,h)},decrypt(l,h){if(Ye(l),n&&l.length<n)throw new Error("invalid ciphertext length: smaller than tagLength="+n);return a(o.decrypt.length,h),o.decrypt(l,h)}}}return Object.assign(t,s),t};function Cc(s,e,t=!0){if(e===void 0)return new Uint8Array(s);if(e.length!==s)throw new Error("invalid output length, expected "+s+", got: "+e.length);if(t&&!uf(e))throw new Error("invalid output, must be aligned");return e}function Ac(s,e,t,i){if(typeof s.setBigUint64=="function")return s.setBigUint64(e,t,i);let r=BigInt(32),n=BigInt(4294967295),o=Number(t>>r&n),a=Number(t&n),c=i?4:0,l=i?0:4;s.setUint32(e+c,o,i),s.setUint32(e+l,a,i)}function hf(s,e,t){Fn(t);let i=new Uint8Array(16),r=rf(i);return Ac(r,0,BigInt(e),t),Ac(r,8,BigInt(s),t),i}function uf(s){return s.byteOffset%4===0}function Dn(s){return Uint8Array.from(s)}var Sl=s=>Uint8Array.from(s.split("").map(e=>e.charCodeAt(0))),df=Sl("expand 16-byte k"),pf=Sl("expand 32-byte k"),ff=ps(df),gf=ps(pf);function te(s,e){return s<<e|s>>>32-e}function qn(s){return s.byteOffset%4===0}var fr=64,yf=16,Nl=2**32-1,Sc=new Uint32Array;function mf(s,e,t,i,r,n,o,a){let c=r.length,l=new Uint8Array(fr),h=ps(l),d=qn(r)&&qn(n),u=d?ps(r):Sc,p=d?ps(n):Sc;for(let f=0;f<c;o++){if(s(e,t,i,h,o,a),o>=Nl)throw new Error("arx: counter overflow");let g=Math.min(fr,c-f);if(d&&g===fr){let y=f/4;if(f%4!==0)throw new Error("arx: invalid block position");for(let A=0,_;A<yf;A++)_=y+A,p[_]=u[_]^h[A];f+=fr;continue}for(let y=0,A;y<g;y++)A=f+y,n[A]=r[A]^l[y];f+=g}}function wf(s,e){let{allowShortKeys:t,extendNonceFn:i,counterLength:r,counterRight:n,rounds:o}=af({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof s!="function")throw new Error("core must be a function");return wn(r),wn(o),Fn(n),Fn(t),(a,c,l,h,d=0)=>{Ye(a),Ye(c),Ye(l);let u=l.length;if(h===void 0&&(h=new Uint8Array(u)),Ye(h),wn(d),d<0||d>=Nl)throw new Error("arx: counter overflow");if(h.length<u)throw new Error(`arx: output (${h.length}) is shorter than data (${u})`);let p=[],f=a.length,g,y;if(f===32)p.push(g=Dn(a)),y=gf;else if(f===16&&t)g=new Uint8Array(32),g.set(a),g.set(a,16),y=ff,p.push(g);else throw new Error(`arx: invalid 32-byte key, got length=${f}`);qn(c)||p.push(c=Dn(c));let A=ps(g);if(i){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");i(y,A,ps(c.subarray(0,16)),A),c=c.subarray(16)}let _=16-r;if(_!==c.length)throw new Error(`arx: nonce must be ${_} or 16 bytes`);if(_!==12){let B=new Uint8Array(12);B.set(c,n?0:12-c.length),c=B,p.push(c)}let R=ps(c);return mf(s,y,A,R,l,h,d,o),Gs(...p),h}}var Te=(s,e)=>s[e++]&255|(s[e++]&255)<<8,Bn=class{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=Ln(e),Ye(e,32);let t=Te(e,0),i=Te(e,2),r=Te(e,4),n=Te(e,6),o=Te(e,8),a=Te(e,10),c=Te(e,12),l=Te(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|i<<3)&8191,this.r[2]=(i>>>10|r<<6)&7939,this.r[3]=(r>>>7|n<<9)&8191,this.r[4]=(n>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let h=0;h<8;h++)this.pad[h]=Te(e,16+2*h)}process(e,t,i=!1){let r=i?0:2048,{h:n,r:o}=this,a=o[0],c=o[1],l=o[2],h=o[3],d=o[4],u=o[5],p=o[6],f=o[7],g=o[8],y=o[9],A=Te(e,t+0),_=Te(e,t+2),R=Te(e,t+4),B=Te(e,t+6),D=Te(e,t+8),U=Te(e,t+10),j=Te(e,t+12),M=Te(e,t+14),S=n[0]+(A&8191),V=n[1]+((A>>>13|_<<3)&8191),H=n[2]+((_>>>10|R<<6)&8191),O=n[3]+((R>>>7|B<<9)&8191),m=n[4]+((B>>>4|D<<12)&8191),w=n[5]+(D>>>1&8191),b=n[6]+((D>>>14|U<<2)&8191),I=n[7]+((U>>>11|j<<5)&8191),T=n[8]+((j>>>8|M<<8)&8191),x=n[9]+(M>>>5|r),v=0,N=v+S*a+V*(5*y)+H*(5*g)+O*(5*f)+m*(5*p);v=N>>>13,N&=8191,N+=w*(5*u)+b*(5*d)+I*(5*h)+T*(5*l)+x*(5*c),v+=N>>>13,N&=8191;let L=v+S*c+V*a+H*(5*y)+O*(5*g)+m*(5*f);v=L>>>13,L&=8191,L+=w*(5*p)+b*(5*u)+I*(5*d)+T*(5*h)+x*(5*l),v+=L>>>13,L&=8191;let F=v+S*l+V*c+H*a+O*(5*y)+m*(5*g);v=F>>>13,F&=8191,F+=w*(5*f)+b*(5*p)+I*(5*u)+T*(5*d)+x*(5*h),v+=F>>>13,F&=8191;let Z=v+S*h+V*l+H*c+O*a+m*(5*y);v=Z>>>13,Z&=8191,Z+=w*(5*g)+b*(5*f)+I*(5*p)+T*(5*u)+x*(5*d),v+=Z>>>13,Z&=8191;let W=v+S*d+V*h+H*l+O*c+m*a;v=W>>>13,W&=8191,W+=w*(5*y)+b*(5*g)+I*(5*f)+T*(5*p)+x*(5*u),v+=W>>>13,W&=8191;let K=v+S*u+V*d+H*h+O*l+m*c;v=K>>>13,K&=8191,K+=w*a+b*(5*y)+I*(5*g)+T*(5*f)+x*(5*p),v+=K>>>13,K&=8191;let X=v+S*p+V*u+H*d+O*h+m*l;v=X>>>13,X&=8191,X+=w*c+b*a+I*(5*y)+T*(5*g)+x*(5*f),v+=X>>>13,X&=8191;let G=v+S*f+V*p+H*u+O*d+m*h;v=G>>>13,G&=8191,G+=w*l+b*c+I*a+T*(5*y)+x*(5*g),v+=G>>>13,G&=8191;let fe=v+S*g+V*f+H*p+O*u+m*d;v=fe>>>13,fe&=8191,fe+=w*h+b*l+I*c+T*a+x*(5*y),v+=fe>>>13,fe&=8191;let Y=v+S*y+V*g+H*f+O*p+m*u;v=Y>>>13,Y&=8191,Y+=w*d+b*h+I*l+T*c+x*a,v+=Y>>>13,Y&=8191,v=(v<<2)+v|0,v=v+N|0,N=v&8191,v=v>>>13,L+=v,n[0]=N,n[1]=L,n[2]=F,n[3]=Z,n[4]=W,n[5]=K,n[6]=X,n[7]=G,n[8]=fe,n[9]=Y}finalize(){let{h:e,pad:t}=this,i=new Uint16Array(10),r=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=r,r=e[a]>>>13,e[a]&=8191;e[0]+=r*5,r=e[0]>>>13,e[0]&=8191,e[1]+=r,r=e[1]>>>13,e[1]&=8191,e[2]+=r,i[0]=e[0]+5,r=i[0]>>>13,i[0]&=8191;for(let a=1;a<10;a++)i[a]=e[a]+r,r=i[a]>>>13,i[a]&=8191;i[9]-=8192;let n=(r^1)-1;for(let a=0;a<10;a++)i[a]&=n;n=~n;for(let a=0;a<10;a++)e[a]=e[a]&n|i[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+t[0];e[0]=o&65535;for(let a=1;a<8;a++)o=(e[a]+t[a]|0)+(o>>>16)|0,e[a]=o&65535;Gs(i)}update(e){_c(this),e=Ln(e),Ye(e);let{buffer:t,blockLen:i}=this,r=e.length;for(let n=0;n<r;){let o=Math.min(i-this.pos,r-n);if(o===i){for(;i<=r-n;n+=i)this.process(e,n);continue}t.set(e.subarray(n,n+o),this.pos),this.pos+=o,n+=o,this.pos===i&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){Gs(this.h,this.r,this.buffer,this.pad)}digestInto(e){_c(this),sf(e,this),this.finished=!0;let{buffer:t,h:i}=this,{pos:r}=this;if(r){for(t[r++]=1;r<16;r++)t[r]=0;this.process(t,0,!0)}this.finalize();let n=0;for(let o=0;o<8;o++)e[n++]=i[o]>>>0,e[n++]=i[o]>>>8;return e}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let i=e.slice(0,t);return this.destroy(),i}};function bf(s){let e=(i,r)=>s(r).update(Ln(i)).digest(),t=s(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=i=>s(i),e}var vf=bf(s=>new Bn(s));function Ef(s,e,t,i,r,n=20){let o=s[0],a=s[1],c=s[2],l=s[3],h=e[0],d=e[1],u=e[2],p=e[3],f=e[4],g=e[5],y=e[6],A=e[7],_=r,R=t[0],B=t[1],D=t[2],U=o,j=a,M=c,S=l,V=h,H=d,O=u,m=p,w=f,b=g,I=y,T=A,x=_,v=R,N=B,L=D;for(let Z=0;Z<n;Z+=2)U=U+V|0,x=te(x^U,16),w=w+x|0,V=te(V^w,12),U=U+V|0,x=te(x^U,8),w=w+x|0,V=te(V^w,7),j=j+H|0,v=te(v^j,16),b=b+v|0,H=te(H^b,12),j=j+H|0,v=te(v^j,8),b=b+v|0,H=te(H^b,7),M=M+O|0,N=te(N^M,16),I=I+N|0,O=te(O^I,12),M=M+O|0,N=te(N^M,8),I=I+N|0,O=te(O^I,7),S=S+m|0,L=te(L^S,16),T=T+L|0,m=te(m^T,12),S=S+m|0,L=te(L^S,8),T=T+L|0,m=te(m^T,7),U=U+H|0,L=te(L^U,16),I=I+L|0,H=te(H^I,12),U=U+H|0,L=te(L^U,8),I=I+L|0,H=te(H^I,7),j=j+O|0,x=te(x^j,16),T=T+x|0,O=te(O^T,12),j=j+O|0,x=te(x^j,8),T=T+x|0,O=te(O^T,7),M=M+m|0,v=te(v^M,16),w=w+v|0,m=te(m^w,12),M=M+m|0,v=te(v^M,8),w=w+v|0,m=te(m^w,7),S=S+V|0,N=te(N^S,16),b=b+N|0,V=te(V^b,12),S=S+V|0,N=te(N^S,8),b=b+N|0,V=te(V^b,7);let F=0;i[F++]=o+U|0,i[F++]=a+j|0,i[F++]=c+M|0,i[F++]=l+S|0,i[F++]=h+V|0,i[F++]=d+H|0,i[F++]=u+O|0,i[F++]=p+m|0,i[F++]=f+w|0,i[F++]=g+b|0,i[F++]=y+I|0,i[F++]=A+T|0,i[F++]=_+x|0,i[F++]=R+v|0,i[F++]=B+N|0,i[F++]=D+L|0}var If=wf(Ef,{counterRight:!1,counterLength:4,allowShortKeys:!1}),_f=new Uint8Array(16),Nc=(s,e)=>{s.update(e);let t=e.length%16;t&&s.update(_f.subarray(t))},Cf=new Uint8Array(32);function Oc(s,e,t,i,r){let n=s(e,t,Cf),o=vf.create(n);r&&Nc(o,r),Nc(o,i);let a=hf(i.length,r?r.length:0,!0);o.update(a);let c=o.digest();return Gs(n,a),c}var Af=s=>(e,t,i)=>({encrypt(r,n){let o=r.length;n=Cc(o+16,n,!1),n.set(r);let a=n.subarray(0,-16);s(e,t,a,a,1);let c=Oc(s,e,t,a,i);return n.set(c,o),Gs(c),n},decrypt(r,n){n=Cc(r.length-16,n,!1);let o=r.subarray(0,-16),a=r.subarray(-16),c=Oc(s,e,t,o,i);if(!cf(a,c))throw new Error("invalid tag");return n.set(r.subarray(0,-16)),s(e,t,n,n,1),Gs(c),n}}),Ol=lf({blockSize:64,nonceLength:12,tagLength:16},Af(If)),Er=class extends Ws{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,Pr(e);let i=vt(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let r=this.blockLen,n=new Uint8Array(r);n.set(i.length>r?e.create().update(i).digest():i);for(let o=0;o<n.length;o++)n[o]^=54;this.iHash.update(n),this.oHash=e.create();for(let o=0;o<n.length;o++)n[o]^=106;this.oHash.update(n),lt(n)}update(e){return fs(this),this.iHash.update(e),this}digestInto(e){fs(this),It(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));let{oHash:t,iHash:i,finished:r,destroyed:n,blockLen:o,outputLen:a}=this;return e=e,e.finished=r,e.destroyed=n,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=i._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},kr=(s,e,t)=>new Er(s,e).update(t).digest();kr.create=(s,e)=>new Er(s,e);function Sf(s,e,t){return Pr(s),t===void 0&&(t=new Uint8Array(s.outputLen)),kr(s,vt(t),vt(e))}var bn=Uint8Array.from([0]),Tc=Uint8Array.of();function Nf(s,e,t,i=32){Pr(s),Gt(i);let r=s.outputLen;if(i>255*r)throw new Error("Length should be <= 255*HashLen");let n=Math.ceil(i/r);t===void 0&&(t=Tc);let o=new Uint8Array(n*r),a=kr.create(s,e),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let h=0;h<n;h++)bn[0]=h+1,c.update(h===0?Tc:l).update(t).update(bn).digestInto(l),o.set(l,r*h),a._cloneInto(c);return a.destroy(),c.destroy(),lt(l,bn),o.slice(0,i)}var Of=(s,e,t,i,r)=>Nf(s,Sf(s,e,t),i,r),Ur=Rr,lo=BigInt(0),jn=BigInt(1);function Ir(s,e=""){if(typeof s!="boolean"){let t=e&&`"${e}"`;throw new Error(t+"expected boolean, got type="+typeof s)}return s}function Os(s,e,t=""){let i=Tr(s),r=s?.length,n=e!==void 0;if(!i||n&&r!==e){let o=t&&`"${t}" `,a=n?` of length ${e}`:"",c=i?`length=${r}`:`type=${typeof s}`;throw new Error(o+"expected Uint8Array"+a+", got "+c)}return s}function gr(s){let e=s.toString(16);return e.length&1?"0"+e:e}function Tl(s){if(typeof s!="string")throw new Error("hex string expected, got "+typeof s);return s===""?lo:BigInt("0x"+s)}function Fr(s){return Tl(zs(s))}function _r(s){return It(s),Tl(zs(Uint8Array.from(s).reverse()))}function ho(s,e){return br(s.toString(16).padStart(e*2,"0"))}function uo(s,e){return ho(s,e).reverse()}function qe(s,e,t){let i;if(typeof e=="string")try{i=br(e)}catch(n){throw new Error(s+" must be hex string or Uint8Array, cause: "+n)}else if(Tr(e))i=Uint8Array.from(e);else throw new Error(s+" must be hex string or Uint8Array");let r=i.length;if(typeof t=="number"&&r!==t)throw new Error(s+" of length "+t+" expected, got "+r);return i}var vn=s=>typeof s=="bigint"&&lo<=s;function Tf(s,e,t){return vn(s)&&vn(e)&&vn(t)&&e<=s&&s<t}function Mn(s,e,t,i){if(!Tf(e,t,i))throw new Error("expected valid "+s+": "+t+" <= n < "+i+", got "+e)}function Pl(s){let e;for(e=0;s>lo;s>>=jn,e+=1);return e}var Ti=s=>(jn<<BigInt(s))-jn;function Pf(s,e,t){if(typeof s!="number"||s<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");let i=u=>new Uint8Array(u),r=u=>Uint8Array.of(u),n=i(s),o=i(s),a=0,c=()=>{n.fill(1),o.fill(0),a=0},l=(...u)=>t(o,n,...u),h=(u=i(0))=>{o=l(r(0),u),n=l(),u.length!==0&&(o=l(r(1),u),n=l())},d=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let u=0,p=[];for(;u<e;){n=l();let f=n.slice();p.push(f),u+=n.length}return ds(...p)};return(u,p)=>{c(),h(u);let f;for(;!(f=p(d()));)h();return c(),f}}function Lr(s,e,t={}){if(!s||typeof s!="object")throw new Error("expected valid options object");function i(r,n,o){let a=s[r];if(o&&a===void 0)return;let c=typeof a;if(c!==n||a===null)throw new Error(`param "${r}" is invalid: expected ${n}, got ${c}`)}Object.entries(e).forEach(([r,n])=>i(r,n,!1)),Object.entries(t).forEach(([r,n])=>i(r,n,!0))}function Pc(s){let e=new WeakMap;return(t,...i)=>{let r=e.get(t);if(r!==void 0)return r;let n=s(t,...i);return e.set(t,n),n}}var Je=BigInt(0),He=BigInt(1),Ts=BigInt(2),Rl=BigInt(3),xl=BigInt(4),kl=BigInt(5),Rf=BigInt(7),Ul=BigInt(8),xf=BigInt(9),Fl=BigInt(16);function it(s,e){let t=s%e;return t>=Je?t:e+t}function mt(s,e,t){let i=s;for(;e-- >Je;)i*=i,i%=t;return i}function Rc(s,e){if(s===Je)throw new Error("invert: expected non-zero number");if(e<=Je)throw new Error("invert: expected positive modulus, got "+e);let t=it(s,e),i=e,r=Je,n=He;for(;t!==Je;){let o=i/t,a=i%t,c=r-n*o;i=t,t=a,r=n,n=c}if(i!==He)throw new Error("invert: does not exist");return it(r,e)}function po(s,e,t){if(!s.eql(s.sqr(e),t))throw new Error("Cannot find square root")}function Ll(s,e){let t=(s.ORDER+He)/xl,i=s.pow(e,t);return po(s,i,e),i}function kf(s,e){let t=(s.ORDER-kl)/Ul,i=s.mul(e,Ts),r=s.pow(i,t),n=s.mul(e,r),o=s.mul(s.mul(n,Ts),r),a=s.mul(n,s.sub(o,s.ONE));return po(s,a,e),a}function Uf(s){let e=ms(s),t=Dl(s),i=t(e,e.neg(e.ONE)),r=t(e,i),n=t(e,e.neg(i)),o=(s+Rf)/Fl;return(a,c)=>{let l=a.pow(c,o),h=a.mul(l,i),d=a.mul(l,r),u=a.mul(l,n),p=a.eql(a.sqr(h),c),f=a.eql(a.sqr(d),c);l=a.cmov(l,h,p),h=a.cmov(u,d,f);let g=a.eql(a.sqr(h),c),y=a.cmov(l,h,g);return po(a,y,c),y}}function Dl(s){if(s<Rl)throw new Error("sqrt is not defined for small field");let e=s-He,t=0;for(;e%Ts===Je;)e/=Ts,t++;let i=Ts,r=ms(s);for(;xc(r,i)===1;)if(i++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return Ll;let n=r.pow(i,e),o=(e+He)/Ts;return function(a,c){if(a.is0(c))return c;if(xc(a,c)!==1)throw new Error("Cannot find square root");let l=t,h=a.mul(a.ONE,n),d=a.pow(c,e),u=a.pow(c,o);for(;!a.eql(d,a.ONE);){if(a.is0(d))return a.ZERO;let p=1,f=a.sqr(d);for(;!a.eql(f,a.ONE);)if(p++,f=a.sqr(f),p===l)throw new Error("Cannot find square root");let g=He<<BigInt(l-p-1),y=a.pow(h,g);l=p,h=a.sqr(y),d=a.mul(d,h),u=a.mul(u,y)}return u}}function Ff(s){return s%xl===Rl?Ll:s%Ul===kl?kf:s%Fl===xf?Uf(s):Dl(s)}var Lf=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Df(s){let e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},t=Lf.reduce((i,r)=>(i[r]="function",i),e);return Lr(s,t),s}function qf(s,e,t){if(t<Je)throw new Error("invalid exponent, negatives unsupported");if(t===Je)return s.ONE;if(t===He)return e;let i=s.ONE,r=e;for(;t>Je;)t&He&&(i=s.mul(i,r)),r=s.sqr(r),t>>=He;return i}function ql(s,e,t=!1){let i=new Array(e.length).fill(t?s.ZERO:void 0),r=e.reduce((o,a,c)=>s.is0(a)?o:(i[c]=o,s.mul(o,a)),s.ONE),n=s.inv(r);return e.reduceRight((o,a,c)=>s.is0(a)?o:(i[c]=s.mul(o,i[c]),s.mul(o,a)),n),i}function xc(s,e){let t=(s.ORDER-He)/Ts,i=s.pow(e,t),r=s.eql(i,s.ONE),n=s.eql(i,s.ZERO),o=s.eql(i,s.neg(s.ONE));if(!r&&!n&&!o)throw new Error("invalid Legendre symbol result");return r?1:n?0:-1}function Bl(s,e){e!==void 0&&Gt(e);let t=e!==void 0?e:s.toString(2).length,i=Math.ceil(t/8);return{nBitLength:t,nByteLength:i}}function ms(s,e,t=!1,i={}){if(s<=Je)throw new Error("invalid field: expected ORDER > 0, got "+s);let r,n,o=!1,a;if(typeof e=="object"&&e!=null){if(i.sqrt||t)throw new Error("cannot specify opts in two arguments");let u=e;u.BITS&&(r=u.BITS),u.sqrt&&(n=u.sqrt),typeof u.isLE=="boolean"&&(t=u.isLE),typeof u.modFromBytes=="boolean"&&(o=u.modFromBytes),a=u.allowedLengths}else typeof e=="number"&&(r=e),i.sqrt&&(n=i.sqrt);let{nBitLength:c,nByteLength:l}=Bl(s,r);if(l>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let h,d=Object.freeze({ORDER:s,isLE:t,BITS:c,BYTES:l,MASK:Ti(c),ZERO:Je,ONE:He,allowedLengths:a,create:u=>it(u,s),isValid:u=>{if(typeof u!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof u);return Je<=u&&u<s},is0:u=>u===Je,isValidNot0:u=>!d.is0(u)&&d.isValid(u),isOdd:u=>(u&He)===He,neg:u=>it(-u,s),eql:(u,p)=>u===p,sqr:u=>it(u*u,s),add:(u,p)=>it(u+p,s),sub:(u,p)=>it(u-p,s),mul:(u,p)=>it(u*p,s),pow:(u,p)=>qf(d,u,p),div:(u,p)=>it(u*Rc(p,s),s),sqrN:u=>u*u,addN:(u,p)=>u+p,subN:(u,p)=>u-p,mulN:(u,p)=>u*p,inv:u=>Rc(u,s),sqrt:n||(u=>(h||(h=Ff(s)),h(d,u))),toBytes:u=>t?uo(u,l):ho(u,l),fromBytes:(u,p=!0)=>{if(a){if(!a.includes(u.length)||u.length>l)throw new Error("Field.fromBytes: expected "+a+" bytes, got "+u.length);let g=new Uint8Array(l);g.set(u,t?0:g.length-u.length),u=g}if(u.length!==l)throw new Error("Field.fromBytes: expected "+l+" bytes, got "+u.length);let f=t?_r(u):Fr(u);if(o&&(f=it(f,s)),!p&&!d.isValid(f))throw new Error("invalid field element: outside of range 0..ORDER");return f},invertBatch:u=>ql(d,u),cmov:(u,p,f)=>f?p:u});return Object.freeze(d)}function jl(s){if(typeof s!="bigint")throw new Error("field order must be bigint");let e=s.toString(2).length;return Math.ceil(e/8)}function Ml(s){let e=jl(s);return e+Math.ceil(e/2)}function Bf(s,e,t=!1){let i=s.length,r=jl(e),n=Ml(e);if(i<16||i<n||i>1024)throw new Error("expected "+n+"-1024 bytes of input, got "+i);let o=t?_r(s):Fr(s),a=it(o,e-He)+He;return t?uo(a,r):ho(a,r)}var Ys=BigInt(0),Ps=BigInt(1);function Cr(s,e){let t=e.negate();return s?t:e}function En(s,e){let t=ql(s.Fp,e.map(i=>i.Z));return e.map((i,r)=>s.fromAffine(i.toAffine(t[r])))}function $l(s,e){if(!Number.isSafeInteger(s)||s<=0||s>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+s)}function In(s,e){$l(s,e);let t=Math.ceil(e/s)+1,i=2**(s-1),r=2**s,n=Ti(s),o=BigInt(s);return{windows:t,windowSize:i,mask:n,maxNumber:r,shiftBy:o}}function kc(s,e,t){let{windowSize:i,mask:r,maxNumber:n,shiftBy:o}=t,a=Number(s&r),c=s>>o;a>i&&(a-=n,c+=Ps);let l=e*i,h=l+Math.abs(a)-1,d=a===0,u=a<0,p=e%2!==0;return{nextN:c,offset:h,isZero:d,isNeg:u,isNegF:p,offsetF:l}}function jf(s,e){if(!Array.isArray(s))throw new Error("array expected");s.forEach((t,i)=>{if(!(t instanceof e))throw new Error("invalid point at index "+i)})}function Mf(s,e){if(!Array.isArray(s))throw new Error("array of scalars expected");s.forEach((t,i)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+i)})}var _n=new WeakMap,Vl=new WeakMap;function Cn(s){return Vl.get(s)||1}function Uc(s){if(s!==Ys)throw new Error("invalid wNAF")}var $n=class{constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,i=this.ZERO){let r=e;for(;t>Ys;)t&Ps&&(i=i.add(r)),r=r.double(),t>>=Ps;return i}precomputeWindow(e,t){let{windows:i,windowSize:r}=In(t,this.bits),n=[],o=e,a=o;for(let c=0;c<i;c++){a=o,n.push(a);for(let l=1;l<r;l++)a=a.add(o),n.push(a);o=a.double()}return n}wNAF(e,t,i){if(!this.Fn.isValid(i))throw new Error("invalid scalar");let r=this.ZERO,n=this.BASE,o=In(e,this.bits);for(let a=0;a<o.windows;a++){let{nextN:c,offset:l,isZero:h,isNeg:d,isNegF:u,offsetF:p}=kc(i,a,o);i=c,h?n=n.add(Cr(u,t[p])):r=r.add(Cr(d,t[l]))}return Uc(i),{p:r,f:n}}wNAFUnsafe(e,t,i,r=this.ZERO){let n=In(e,this.bits);for(let o=0;o<n.windows&&i!==Ys;o++){let{nextN:a,offset:c,isZero:l,isNeg:h}=kc(i,o,n);if(i=a,!l){let d=t[c];r=r.add(h?d.negate():d)}}return Uc(i),r}getPrecomputes(e,t,i){let r=_n.get(t);return r||(r=this.precomputeWindow(t,e),e!==1&&(typeof i=="function"&&(r=i(r)),_n.set(t,r))),r}cached(e,t,i){let r=Cn(e);return this.wNAF(r,this.getPrecomputes(r,e,i),t)}unsafe(e,t,i,r){let n=Cn(e);return n===1?this._unsafeLadder(e,t,r):this.wNAFUnsafe(n,this.getPrecomputes(n,e,i),t,r)}createCache(e,t){$l(t,this.bits),Vl.set(e,t),_n.delete(e)}hasCache(e){return Cn(e)!==1}};function $f(s,e,t,i){let r=e,n=s.ZERO,o=s.ZERO;for(;t>Ys||i>Ys;)t&Ps&&(n=n.add(r)),i&Ps&&(o=o.add(r)),r=r.double(),t>>=Ps,i>>=Ps;return{p1:n,p2:o}}function Vf(s,e,t,i){jf(t,s),Mf(i,e);let r=t.length,n=i.length;if(r!==n)throw new Error("arrays of points and scalars must have equal length");let o=s.ZERO,a=Pl(BigInt(r)),c=1;a>12?c=a-3:a>4?c=a-2:a>0&&(c=2);let l=Ti(c),h=new Array(Number(l)+1).fill(o),d=Math.floor((e.BITS-1)/c)*c,u=o;for(let p=d;p>=0;p-=c){h.fill(o);for(let g=0;g<n;g++){let y=i[g],A=Number(y>>BigInt(p)&l);h[A]=h[A].add(t[g])}let f=o;for(let g=h.length-1,y=o;g>0;g--)y=y.add(h[g]),f=f.add(y);if(u=u.add(f),p!==0)for(let g=0;g<c;g++)u=u.double()}return u}function Fc(s,e,t){if(e){if(e.ORDER!==s)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return Df(e),e}else return ms(s,{isLE:t})}function Kf(s,e,t={},i){if(i===void 0&&(i=s==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${s} CURVE object`);for(let a of["p","n","h"]){let c=e[a];if(!(typeof c=="bigint"&&c>Ys))throw new Error(`CURVE.${a} must be positive bigint`)}let r=Fc(e.p,t.Fp,i),n=Fc(e.n,t.Fn,i),o=["Gx","Gy","a",s==="weierstrass"?"b":"d"];for(let a of o)if(!r.isValid(e[a]))throw new Error(`CURVE.${a} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:r,Fn:n}}BigInt(0),BigInt(1),BigInt(2),BigInt(8),ul("HashToScalar-");var yi=BigInt(0),Vs=BigInt(1),yr=BigInt(2);function zf(s){return Lr(s,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...s})}function Hf(s){let e=zf(s),{P:t,type:i,adjustScalarBytes:r,powPminus2:n,randomBytes:o}=e,a=i==="x25519";if(!a&&i!=="x448")throw new Error("invalid type");let c=o||ks,l=a?255:448,h=a?32:56,d=BigInt(a?9:5),u=BigInt(a?121665:39081),p=a?yr**BigInt(254):yr**BigInt(447),f=a?BigInt(8)*yr**BigInt(251)-Vs:BigInt(4)*yr**BigInt(445)-Vs,g=p+f+Vs,y=O=>it(O,t),A=_(d);function _(O){return uo(y(O),h)}function R(O){let m=qe("u coordinate",O,h);return a&&(m[31]&=127),y(_r(m))}function B(O){return _r(r(qe("scalar",O,h)))}function D(O,m){let w=M(R(m),B(O));if(w===yi)throw new Error("invalid private or public key received");return _(w)}function U(O){return D(O,A)}function j(O,m,w){let b=y(O*(m-w));return m=y(m-b),w=y(w+b),{x_2:m,x_3:w}}function M(O,m){Mn("u",O,yi,t),Mn("scalar",m,p,g);let w=m,b=O,I=Vs,T=yi,x=O,v=Vs,N=yi;for(let F=BigInt(l-1);F>=yi;F--){let Z=w>>F&Vs;N^=Z,{x_2:I,x_3:x}=j(N,I,x),{x_2:T,x_3:v}=j(N,T,v),N=Z;let W=I+T,K=y(W*W),X=I-T,G=y(X*X),fe=K-G,Y=x+v,Ee=x-v,gt=y(Ee*W),Zt=y(Y*X),Es=gt+Zt,qs=gt-Zt;x=y(Es*Es),v=y(b*y(qs*qs)),I=y(K*G),T=y(fe*(K+y(u*fe)))}({x_2:I,x_3:x}=j(N,I,x)),{x_2:T,x_3:v}=j(N,T,v);let L=n(T);return y(I*L)}let S={secretKey:h,publicKey:h,seed:h},V=(O=c(h))=>(It(O,S.seed),O);function H(O){let m=V(O);return{secretKey:m,publicKey:U(m)}}return{keygen:H,getSharedSecret:(O,m)=>D(O,m),getPublicKey:O=>U(O),scalarMult:D,scalarMultBase:U,utils:{randomSecretKey:V,randomPrivateKey:V},GuBytes:A.slice(),lengths:S}}var Wf=BigInt(1),Lc=BigInt(2),Gf=BigInt(3),Yf=BigInt(5),Xf=BigInt(8),Kl=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),Jf={p:Kl,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:Xf,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function Zf(s){let e=BigInt(10),t=BigInt(20),i=BigInt(40),r=BigInt(80),n=Kl,o=s*s%n*s%n,a=mt(o,Lc,n)*o%n,c=mt(a,Wf,n)*s%n,l=mt(c,Yf,n)*c%n,h=mt(l,e,n)*l%n,d=mt(h,t,n)*h%n,u=mt(d,i,n)*d%n,p=mt(u,r,n)*u%n,f=mt(p,r,n)*u%n,g=mt(f,e,n)*l%n;return{pow_p_5_8:mt(g,Lc,n)*s%n,b2:o}}function Qf(s){return s[0]&=248,s[31]&=127,s[31]|=64,s}var eg=ms(Jf.p,{isLE:!0}),Vn=(()=>{let s=eg.ORDER;return Hf({P:s,type:"x25519",powPminus2:e=>{let{pow_p_5_8:t,b2:i}=Zf(e);return it(mt(t,Gf,s)*i,s)},adjustScalarBytes:Qf})})(),Dc=(s,e)=>(s+(s>=0?e:-e)/zl)/e;function tg(s,e,t){let[[i,r],[n,o]]=e,a=Dc(o*s,t),c=Dc(-r*s,t),l=s-a*i-c*n,h=-a*r-c*o,d=l<Ht,u=h<Ht;d&&(l=-l),u&&(h=-h);let p=Ti(Math.ceil(Pl(t)/2))+Hs;if(l<Ht||l>=p||h<Ht||h>=p)throw new Error("splitScalar (endomorphism): failed, k="+s);return{k1neg:d,k1:l,k2neg:u,k2:h}}function Kn(s){if(!["compact","recovered","der"].includes(s))throw new Error('Signature format must be "compact", "recovered", or "der"');return s}function An(s,e){let t={};for(let i of Object.keys(e))t[i]=s[i]===void 0?e[i]:s[i];return Ir(t.lowS,"lowS"),Ir(t.prehash,"prehash"),t.format!==void 0&&Kn(t.format),t}var zn=class extends Error{constructor(e=""){super(e)}},zt={Err:zn,_tlv:{encode:(s,e)=>{let{Err:t}=zt;if(s<0||s>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");let i=e.length/2,r=gr(i);if(r.length/2&128)throw new t("tlv.encode: long form length too big");let n=i>127?gr(r.length/2|128):"";return gr(s)+n+r+e},decode(s,e){let{Err:t}=zt,i=0;if(s<0||s>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[i++]!==s)throw new t("tlv.decode: wrong tlv");let r=e[i++],n=!!(r&128),o=0;if(!n)o=r;else{let c=r&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");let l=e.subarray(i,i+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(let h of l)o=o<<8|h;if(i+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}let a=e.subarray(i,i+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(i+o)}}},_int:{encode(s){let{Err:e}=zt;if(s<Ht)throw new e("integer: negative integers are not allowed");let t=gr(s);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(s){let{Err:e}=zt;if(s[0]&128)throw new e("invalid signature integer: negative");if(s[0]===0&&!(s[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Fr(s)}},toSig(s){let{Err:e,_int:t,_tlv:i}=zt,r=qe("signature",s),{v:n,l:o}=i.decode(48,r);if(o.length)throw new e("invalid signature: left bytes after parsing");let{v:a,l:c}=i.decode(2,n),{v:l,l:h}=i.decode(2,c);if(h.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(s){let{_tlv:e,_int:t}=zt,i=e.encode(2,t.encode(s.r)),r=e.encode(2,t.encode(s.s)),n=i+r;return e.encode(48,n)}},Ht=BigInt(0),Hs=BigInt(1),zl=BigInt(2),mr=BigInt(3),sg=BigInt(4);function Ks(s,e){let{BYTES:t}=s,i;if(typeof e=="bigint")i=e;else{let r=qe("private key",e);try{i=s.fromBytes(r)}catch{throw new Error(`invalid private key: expected ui8a of size ${t}, got ${typeof e}`)}}if(!s.isValidNot0(i))throw new Error("invalid private key: out of range [1..N-1]");return i}function ig(s,e={}){let t=Kf("weierstrass",s,e),{Fp:i,Fn:r}=t,n=t.CURVE,{h:o,n:a}=n;Lr(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});let{endo:c}=e;if(c&&(!i.is0(n.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');let l=Wl(i,r);function h(){if(!i.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function d(O,m,w){let{x:b,y:I}=m.toAffine(),T=i.toBytes(b);if(Ir(w,"isCompressed"),w){h();let x=!i.isOdd(I);return ds(Hl(x),T)}else return ds(Uint8Array.of(4),T,i.toBytes(I))}function u(O){Os(O,void 0,"Point");let{publicKey:m,publicKeyUncompressed:w}=l,b=O.length,I=O[0],T=O.subarray(1);if(b===m&&(I===2||I===3)){let x=i.fromBytes(T);if(!i.isValid(x))throw new Error("bad point: is not on curve, wrong x");let v=g(x),N;try{N=i.sqrt(v)}catch(F){let Z=F instanceof Error?": "+F.message:"";throw new Error("bad point: is not on curve, sqrt error"+Z)}h();let L=i.isOdd(N);return(I&1)===1!==L&&(N=i.neg(N)),{x,y:N}}else if(b===w&&I===4){let x=i.BYTES,v=i.fromBytes(T.subarray(0,x)),N=i.fromBytes(T.subarray(x,x*2));if(!y(v,N))throw new Error("bad point: is not on curve");return{x:v,y:N}}else throw new Error(`bad point: got length ${b}, expected compressed=${m} or uncompressed=${w}`)}let p=e.toBytes||d,f=e.fromBytes||u;function g(O){let m=i.sqr(O),w=i.mul(m,O);return i.add(i.add(w,i.mul(O,n.a)),n.b)}function y(O,m){let w=i.sqr(m),b=g(O);return i.eql(w,b)}if(!y(n.Gx,n.Gy))throw new Error("bad curve params: generator point");let A=i.mul(i.pow(n.a,mr),sg),_=i.mul(i.sqr(n.b),BigInt(27));if(i.is0(i.add(A,_)))throw new Error("bad curve params: a or b");function R(O,m,w=!1){if(!i.isValid(m)||w&&i.is0(m))throw new Error(`bad point coordinate ${O}`);return m}function B(O){if(!(O instanceof S))throw new Error("ProjectivePoint expected")}function D(O){if(!c||!c.basises)throw new Error("no endo");return tg(O,c.basises,r.ORDER)}let U=Pc((O,m)=>{let{X:w,Y:b,Z:I}=O;if(i.eql(I,i.ONE))return{x:w,y:b};let T=O.is0();m==null&&(m=T?i.ONE:i.inv(I));let x=i.mul(w,m),v=i.mul(b,m),N=i.mul(I,m);if(T)return{x:i.ZERO,y:i.ZERO};if(!i.eql(N,i.ONE))throw new Error("invZ was invalid");return{x,y:v}}),j=Pc(O=>{if(O.is0()){if(e.allowInfinityPoint&&!i.is0(O.Y))return;throw new Error("bad point: ZERO")}let{x:m,y:w}=O.toAffine();if(!i.isValid(m)||!i.isValid(w))throw new Error("bad point: x or y not field elements");if(!y(m,w))throw new Error("bad point: equation left != right");if(!O.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function M(O,m,w,b,I){return w=new S(i.mul(w.X,O),w.Y,w.Z),m=Cr(b,m),w=Cr(I,w),m.add(w)}class S{constructor(m,w,b){this.X=R("x",m),this.Y=R("y",w,!0),this.Z=R("z",b),Object.freeze(this)}static CURVE(){return n}static fromAffine(m){let{x:w,y:b}=m||{};if(!m||!i.isValid(w)||!i.isValid(b))throw new Error("invalid affine point");if(m instanceof S)throw new Error("projective point not allowed");return i.is0(w)&&i.is0(b)?S.ZERO:new S(w,b,i.ONE)}static fromBytes(m){let w=S.fromAffine(f(Os(m,void 0,"point")));return w.assertValidity(),w}static fromHex(m){return S.fromBytes(qe("pointHex",m))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(m=8,w=!0){return H.createCache(this,m),w||this.multiply(mr),this}assertValidity(){j(this)}hasEvenY(){let{y:m}=this.toAffine();if(!i.isOdd)throw new Error("Field doesn't support isOdd");return!i.isOdd(m)}equals(m){B(m);let{X:w,Y:b,Z:I}=this,{X:T,Y:x,Z:v}=m,N=i.eql(i.mul(w,v),i.mul(T,I)),L=i.eql(i.mul(b,v),i.mul(x,I));return N&&L}negate(){return new S(this.X,i.neg(this.Y),this.Z)}double(){let{a:m,b:w}=n,b=i.mul(w,mr),{X:I,Y:T,Z:x}=this,v=i.ZERO,N=i.ZERO,L=i.ZERO,F=i.mul(I,I),Z=i.mul(T,T),W=i.mul(x,x),K=i.mul(I,T);return K=i.add(K,K),L=i.mul(I,x),L=i.add(L,L),v=i.mul(m,L),N=i.mul(b,W),N=i.add(v,N),v=i.sub(Z,N),N=i.add(Z,N),N=i.mul(v,N),v=i.mul(K,v),L=i.mul(b,L),W=i.mul(m,W),K=i.sub(F,W),K=i.mul(m,K),K=i.add(K,L),L=i.add(F,F),F=i.add(L,F),F=i.add(F,W),F=i.mul(F,K),N=i.add(N,F),W=i.mul(T,x),W=i.add(W,W),F=i.mul(W,K),v=i.sub(v,F),L=i.mul(W,Z),L=i.add(L,L),L=i.add(L,L),new S(v,N,L)}add(m){B(m);let{X:w,Y:b,Z:I}=this,{X:T,Y:x,Z:v}=m,N=i.ZERO,L=i.ZERO,F=i.ZERO,Z=n.a,W=i.mul(n.b,mr),K=i.mul(w,T),X=i.mul(b,x),G=i.mul(I,v),fe=i.add(w,b),Y=i.add(T,x);fe=i.mul(fe,Y),Y=i.add(K,X),fe=i.sub(fe,Y),Y=i.add(w,I);let Ee=i.add(T,v);return Y=i.mul(Y,Ee),Ee=i.add(K,G),Y=i.sub(Y,Ee),Ee=i.add(b,I),N=i.add(x,v),Ee=i.mul(Ee,N),N=i.add(X,G),Ee=i.sub(Ee,N),F=i.mul(Z,Y),N=i.mul(W,G),F=i.add(N,F),N=i.sub(X,F),F=i.add(X,F),L=i.mul(N,F),X=i.add(K,K),X=i.add(X,K),G=i.mul(Z,G),Y=i.mul(W,Y),X=i.add(X,G),G=i.sub(K,G),G=i.mul(Z,G),Y=i.add(Y,G),K=i.mul(X,Y),L=i.add(L,K),K=i.mul(Ee,Y),N=i.mul(fe,N),N=i.sub(N,K),K=i.mul(fe,X),F=i.mul(Ee,F),F=i.add(F,K),new S(N,L,F)}subtract(m){return this.add(m.negate())}is0(){return this.equals(S.ZERO)}multiply(m){let{endo:w}=e;if(!r.isValidNot0(m))throw new Error("invalid scalar: out of range");let b,I,T=x=>H.cached(this,x,v=>En(S,v));if(w){let{k1neg:x,k1:v,k2neg:N,k2:L}=D(m),{p:F,f:Z}=T(v),{p:W,f:K}=T(L);I=Z.add(K),b=M(w.beta,F,W,x,N)}else{let{p:x,f:v}=T(m);b=x,I=v}return En(S,[b,I])[0]}multiplyUnsafe(m){let{endo:w}=e,b=this;if(!r.isValid(m))throw new Error("invalid scalar: out of range");if(m===Ht||b.is0())return S.ZERO;if(m===Hs)return b;if(H.hasCache(this))return this.multiply(m);if(w){let{k1neg:I,k1:T,k2neg:x,k2:v}=D(m),{p1:N,p2:L}=$f(S,b,T,v);return M(w.beta,N,L,I,x)}else return H.unsafe(b,m)}multiplyAndAddUnsafe(m,w,b){let I=this.multiplyUnsafe(w).add(m.multiplyUnsafe(b));return I.is0()?void 0:I}toAffine(m){return U(this,m)}isTorsionFree(){let{isTorsionFree:m}=e;return o===Hs?!0:m?m(S,this):H.unsafe(this,a).is0()}clearCofactor(){let{clearCofactor:m}=e;return o===Hs?this:m?m(S,this):this.multiplyUnsafe(o)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}toBytes(m=!0){return Ir(m,"isCompressed"),this.assertValidity(),p(S,this,m)}toHex(m=!0){return zs(this.toBytes(m))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(m=!0){return this.toBytes(m)}_setWindowSize(m){this.precompute(m)}static normalizeZ(m){return En(S,m)}static msm(m,w){return Vf(S,r,m,w)}static fromPrivateKey(m){return S.BASE.multiply(Ks(r,m))}}S.BASE=new S(n.Gx,n.Gy,i.ONE),S.ZERO=new S(i.ZERO,i.ONE,i.ZERO),S.Fp=i,S.Fn=r;let V=r.BITS,H=new $n(S,e.endo?Math.ceil(V/2):V);return S.BASE.precompute(8),S}function Hl(s){return Uint8Array.of(s?2:3)}function Wl(s,e){return{secretKey:e.BYTES,publicKey:1+s.BYTES,publicKeyUncompressed:1+2*s.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function rg(s,e={}){let{Fn:t}=s,i=e.randomBytes||ks,r=Object.assign(Wl(s.Fp,t),{seed:Ml(t.ORDER)});function n(u){try{return!!Ks(t,u)}catch{return!1}}function o(u,p){let{publicKey:f,publicKeyUncompressed:g}=r;try{let y=u.length;return p===!0&&y!==f||p===!1&&y!==g?!1:!!s.fromBytes(u)}catch{return!1}}function a(u=i(r.seed)){return Bf(Os(u,r.seed,"seed"),t.ORDER)}function c(u,p=!0){return s.BASE.multiply(Ks(t,u)).toBytes(p)}function l(u){let p=a(u);return{secretKey:p,publicKey:c(p)}}function h(u){if(typeof u=="bigint")return!1;if(u instanceof s)return!0;let{secretKey:p,publicKey:f,publicKeyUncompressed:g}=r;if(t.allowedLengths||p===f)return;let y=qe("key",u).length;return y===f||y===g}function d(u,p,f=!0){if(h(u)===!0)throw new Error("first arg must be private key");if(h(p)===!1)throw new Error("second arg must be public key");let g=Ks(t,u);return s.fromHex(p).multiply(g).toBytes(f)}return Object.freeze({getPublicKey:c,getSharedSecret:d,keygen:l,Point:s,utils:{isValidSecretKey:n,isValidPublicKey:o,randomSecretKey:a,isValidPrivateKey:n,randomPrivateKey:a,normPrivateKeyToScalar:u=>Ks(t,u),precompute(u=8,p=s.BASE){return p.precompute(u,!1)}},lengths:r})}function ng(s,e,t={}){Pr(e),Lr(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});let i=t.randomBytes||ks,r=t.hmac||((w,...b)=>kr(e,w,ds(...b))),{Fp:n,Fn:o}=s,{ORDER:a,BITS:c}=o,{keygen:l,getPublicKey:h,getSharedSecret:d,utils:u,lengths:p}=rg(s,t),f={prehash:!1,lowS:typeof t.lowS=="boolean"?t.lowS:!1,format:void 0,extraEntropy:!1},g="compact";function y(w){let b=a>>Hs;return w>b}function A(w,b){if(!o.isValidNot0(b))throw new Error(`invalid signature ${w}: out of range 1..Point.Fn.ORDER`);return b}function _(w,b){Kn(b);let I=p.signature,T=b==="compact"?I:b==="recovered"?I+1:void 0;return Os(w,T,`${b} signature`)}class R{constructor(b,I,T){this.r=A("r",b),this.s=A("s",I),T!=null&&(this.recovery=T),Object.freeze(this)}static fromBytes(b,I=g){_(b,I);let T;if(I==="der"){let{r:L,s:F}=zt.toSig(Os(b));return new R(L,F)}I==="recovered"&&(T=b[0],I="compact",b=b.subarray(1));let x=o.BYTES,v=b.subarray(0,x),N=b.subarray(x,x*2);return new R(o.fromBytes(v),o.fromBytes(N),T)}static fromHex(b,I){return this.fromBytes(br(b),I)}addRecoveryBit(b){return new R(this.r,this.s,b)}recoverPublicKey(b){let I=n.ORDER,{r:T,s:x,recovery:v}=this;if(v==null||![0,1,2,3].includes(v))throw new Error("recovery id invalid");if(a*zl<I&&v>1)throw new Error("recovery id is ambiguous for h>1 curve");let N=v===2||v===3?T+a:T;if(!n.isValid(N))throw new Error("recovery id 2 or 3 invalid");let L=n.toBytes(N),F=s.fromBytes(ds(Hl((v&1)===0),L)),Z=o.inv(N),W=D(qe("msgHash",b)),K=o.create(-W*Z),X=o.create(x*Z),G=s.BASE.multiplyUnsafe(K).add(F.multiplyUnsafe(X));if(G.is0())throw new Error("point at infinify");return G.assertValidity(),G}hasHighS(){return y(this.s)}toBytes(b=g){if(Kn(b),b==="der")return br(zt.hexFromSig(this));let I=o.toBytes(this.r),T=o.toBytes(this.s);if(b==="recovered"){if(this.recovery==null)throw new Error("recovery bit must be present");return ds(Uint8Array.of(this.recovery),I,T)}return ds(I,T)}toHex(b){return zs(this.toBytes(b))}assertValidity(){}static fromCompact(b){return R.fromBytes(qe("sig",b),"compact")}static fromDER(b){return R.fromBytes(qe("sig",b),"der")}normalizeS(){return this.hasHighS()?new R(this.r,o.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return zs(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return zs(this.toBytes("compact"))}}let B=t.bits2int||function(w){if(w.length>8192)throw new Error("input is too large");let b=Fr(w),I=w.length*8-c;return I>0?b>>BigInt(I):b},D=t.bits2int_modN||function(w){return o.create(B(w))},U=Ti(c);function j(w){return Mn("num < 2^"+c,w,Ht,U),o.toBytes(w)}function M(w,b){return Os(w,void 0,"message"),b?Os(e(w),void 0,"prehashed message"):w}function S(w,b,I){if(["recovered","canonical"].some(X=>X in I))throw new Error("sign() legacy options not supported");let{lowS:T,prehash:x,extraEntropy:v}=An(I,f);w=M(w,x);let N=D(w),L=Ks(o,b),F=[j(L),j(N)];if(v!=null&&v!==!1){let X=v===!0?i(p.secretKey):v;F.push(qe("extraEntropy",X))}let Z=ds(...F),W=N;function K(X){let G=B(X);if(!o.isValidNot0(G))return;let fe=o.inv(G),Y=s.BASE.multiply(G).toAffine(),Ee=o.create(Y.x);if(Ee===Ht)return;let gt=o.create(fe*o.create(W+Ee*L));if(gt===Ht)return;let Zt=(Y.x===Ee?0:2)|Number(Y.y&Hs),Es=gt;return T&&y(gt)&&(Es=o.neg(gt),Zt^=1),new R(Ee,Es,Zt)}return{seed:Z,k2sig:K}}function V(w,b,I={}){w=qe("message",w);let{seed:T,k2sig:x}=S(w,b,I);return Pf(e.outputLen,o.BYTES,r)(T,x)}function H(w){let b,I=typeof w=="string"||Tr(w),T=!I&&w!==null&&typeof w=="object"&&typeof w.r=="bigint"&&typeof w.s=="bigint";if(!I&&!T)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(T)b=new R(w.r,w.s);else if(I){try{b=R.fromBytes(qe("sig",w),"der")}catch(x){if(!(x instanceof zt.Err))throw x}if(!b)try{b=R.fromBytes(qe("sig",w),"compact")}catch{return!1}}return b||!1}function O(w,b,I,T={}){let{lowS:x,prehash:v,format:N}=An(T,f);if(I=qe("publicKey",I),b=M(qe("message",b),v),"strict"in T)throw new Error("options.strict was renamed to lowS");let L=N===void 0?H(w):R.fromBytes(qe("sig",w),N);if(L===!1)return!1;try{let F=s.fromBytes(I);if(x&&L.hasHighS())return!1;let{r:Z,s:W}=L,K=D(b),X=o.inv(W),G=o.create(K*X),fe=o.create(Z*X),Y=s.BASE.multiplyUnsafe(G).add(F.multiplyUnsafe(fe));return Y.is0()?!1:o.create(Y.x)===Z}catch{return!1}}function m(w,b,I={}){let{prehash:T}=An(I,f);return b=M(b,T),R.fromBytes(w,"recovered").recoverPublicKey(b).toBytes()}return Object.freeze({keygen:l,getPublicKey:h,getSharedSecret:d,utils:u,lengths:p,Point:s,sign:V,verify:O,recoverPublicKey:m,Signature:R,hash:e})}function og(s){let e={a:s.a,b:s.b,p:s.Fp.ORDER,n:s.n,h:s.h,Gx:s.Gx,Gy:s.Gy},t=s.Fp,i=s.allowedPrivateKeyLengths?Array.from(new Set(s.allowedPrivateKeyLengths.map(o=>Math.ceil(o/2)))):void 0,r=ms(e.n,{BITS:s.nBitLength,allowedLengths:i,modFromBytes:s.wrapPrivateKey}),n={Fp:t,Fn:r,allowInfinityPoint:s.allowInfinityPoint,endo:s.endo,isTorsionFree:s.isTorsionFree,clearCofactor:s.clearCofactor,fromBytes:s.fromBytes,toBytes:s.toBytes};return{CURVE:e,curveOpts:n}}function ag(s){let{CURVE:e,curveOpts:t}=og(s),i={hmac:s.hmac,randomBytes:s.randomBytes,lowS:s.lowS,bits2int:s.bits2int,bits2int_modN:s.bits2int_modN};return{CURVE:e,curveOpts:t,hash:s.hash,ecdsaOpts:i}}function cg(s,e){let t=e.Point;return Object.assign({},e,{ProjectivePoint:t,CURVE:Object.assign({},s,Bl(t.Fn.ORDER,t.Fn.BITS))})}function lg(s){let{CURVE:e,curveOpts:t,hash:i,ecdsaOpts:r}=ag(s),n=ig(e,t),o=ng(n,i,r);return cg(s,o)}function Hn(s,e){let t=i=>lg({...s,hash:i});return{...t(e),create:t}}var Gl={p:BigInt("0xffffffff00000001000000000000000000000000ffffffffffffffffffffffff"),n:BigInt("0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551"),h:BigInt(1),a:BigInt("0xffffffff00000001000000000000000000000000fffffffffffffffffffffffc"),b:BigInt("0x5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b"),Gx:BigInt("0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296"),Gy:BigInt("0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5")},Yl={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffeffffffff0000000000000000ffffffff"),n:BigInt("0xffffffffffffffffffffffffffffffffffffffffffffffffc7634d81f4372ddf581a0db248b0a77aecec196accc52973"),h:BigInt(1),a:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffeffffffff0000000000000000fffffffc"),b:BigInt("0xb3312fa7e23ee7e4988e056be3f82d19181d9c6efe8141120314088f5013875ac656398d8a2ed19d2a85c8edd3ec2aef"),Gx:BigInt("0xaa87ca22be8b05378eb1c71ef320ad746e1d3b628ba79b9859f741e082542a385502f25dbf55296c3a545e3872760ab7"),Gy:BigInt("0x3617de4a96262c6f5d9e98bf9292dc29f8f41dbd289a147ce9da3113b5f0b8c00a60b1ce1d7e819d7a431d7c90ea0e5f")},Xl={p:BigInt("0x1ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"),n:BigInt("0x01fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa51868783bf2f966b7fcc0148f709a5d03bb5c9b8899c47aebb6fb71e91386409"),h:BigInt(1),a:BigInt("0x1fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc"),b:BigInt("0x0051953eb9618e1c9a1f929a21a0b68540eea2da725b99b315f3b8b489918ef109e156193951ec7e937b1652c0bd3bb1bf073573df883d2c34f1ef451fd46b503f00"),Gx:BigInt("0x00c6858e06b70404e9cd9e3ecb662395b4429c648139053fb521f828af606b4d3dbaa14b5e77efe75928fe1dc127a2ffa8de3348b3c1856a429bf97e7e31c2e5bd66"),Gy:BigInt("0x011839296a789a3bc0045c8a5fb42c7d1bd998f54449579b446817afbd17273e662c97ee72995ef42640c550b9013fad0761353c7086a272c24088be94769fd16650")},hg=ms(Gl.p),ug=ms(Yl.p),dg=ms(Xl.p),pg=Hn({...Gl,Fp:hg,lowS:!1},Rr);Hn({...Yl,Fp:ug,lowS:!1},Tp),Hn({...Xl,Fp:dg,lowS:!1,allowedPrivateKeyLengths:[130,131,132]},Op);var fg=pg,Jl="base10",Be="base16",je="base64pad",Jt="base64url",Pi="utf8",Zl=0,At=1,Xs=2,gg=0,qc=1,bi=12,fo=32;function Ql(){let s=Vn.utils.randomPrivateKey(),e=Vn.getPublicKey(s);return{privateKey:ke(s,Be),publicKey:ke(e,Be)}}function Dr(){let s=ks(fo);return ke(s,Be)}function eh(s,e){let t=Vn.getSharedSecret(tt(s,Be),tt(e,Be)),i=Of(Ur,t,void 0,void 0,fo);return ke(i,Be)}function Js(s){let e=Ur(tt(s,Be));return ke(e,Be)}function Ze(s){let e=Ur(tt(s,Pi));return ke(e,Be)}function th(s){return tt(`${s}`,Jl)}function gs(s){return Number(ke(s,Jl))}function sh(s){return s.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function ih(s){let e=s.replace(/-/g,"+").replace(/_/g,"/"),t=(4-e.length%4)%4;return e+"=".repeat(t)}function rh(s){let e=th(typeof s.type<"u"?s.type:Zl);if(gs(e)===At&&typeof s.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");let t=typeof s.senderPublicKey<"u"?tt(s.senderPublicKey,Be):void 0,i=typeof s.iv<"u"?tt(s.iv,Be):ks(bi),r=tt(s.symKey,Be),n=Ol(r,i).encrypt(tt(s.message,Pi)),o=ch({type:e,sealed:n,iv:i,senderPublicKey:t});return s.encoding===Jt?sh(o):o}function nh(s){let e=tt(s.symKey,Be),{sealed:t,iv:i}=Zs({encoded:s.encoded,encoding:s.encoding}),r=Ol(e,i).decrypt(t);if(r===null)throw new Error("Failed to decrypt");return ke(r,Pi)}function oh(s,e){let t=th(Xs),i=ks(bi),r=tt(s,Pi),n=ch({type:t,sealed:r,iv:i});return e===Jt?sh(n):n}function ah(s,e){let{sealed:t}=Zs({encoded:s,encoding:e});return ke(t,Pi)}function ch(s){if(gs(s.type)===Xs)return ke(Bs([s.type,s.sealed]),je);if(gs(s.type)===At){if(typeof s.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");return ke(Bs([s.type,s.senderPublicKey,s.iv,s.sealed]),je)}return ke(Bs([s.type,s.iv,s.sealed]),je)}function Zs(s){let e=(s.encoding||je)===Jt?ih(s.encoded):s.encoded,t=tt(e,je),i=t.slice(gg,qc),r=qc;if(gs(i)===At){let c=r+fo,l=c+bi,h=t.slice(r,c),d=t.slice(c,l),u=t.slice(l);return{type:i,sealed:u,iv:d,senderPublicKey:h}}if(gs(i)===Xs){let c=t.slice(r),l=ks(bi);return{type:i,sealed:c,iv:l}}let n=r+bi,o=t.slice(r,n),a=t.slice(n);return{type:i,sealed:a,iv:o}}function lh(s,e){let t=Zs({encoded:s,encoding:e?.encoding});return go({type:gs(t.type),senderPublicKey:typeof t.senderPublicKey<"u"?ke(t.senderPublicKey,Be):void 0,receiverPublicKey:e?.receiverPublicKey})}function go(s){let e=s?.type||Zl;if(e===At){if(typeof s?.senderPublicKey>"u")throw new Error("missing sender public key");if(typeof s?.receiverPublicKey>"u")throw new Error("missing receiver public key")}return{type:e,senderPublicKey:s?.senderPublicKey,receiverPublicKey:s?.receiverPublicKey}}function yo(s){return s.type===At&&typeof s.senderPublicKey=="string"&&typeof s.receiverPublicKey=="string"}function mo(s){return s.type===Xs}function yg(s){let e=z.from(s.x,"base64"),t=z.from(s.y,"base64");return Bs([new Uint8Array([4]),e,t])}function hh(s,e){let[t,i,r]=s.split("."),n=z.from(ih(r),"base64");if(n.length!==64)throw new Error("Invalid signature length");let o=n.slice(0,32),a=n.slice(32,64),c=`${t}.${i}`,l=Ur(c),h=yg(e);if(!fg.verify(Bs([o,a]),l,h))throw new Error("Invalid signature");return ui(s).payload}var mg="irn";function Ri(s){return s?.relay||{protocol:mg}}function Us(s){let e=Ka[s];if(typeof e>"u")throw new Error(`Relay Protocol not supported: ${s}`);return e}var wg=Object.defineProperty,bg=Object.defineProperties,vg=Object.getOwnPropertyDescriptors,Bc=Object.getOwnPropertySymbols,Eg=Object.prototype.hasOwnProperty,Ig=Object.prototype.propertyIsEnumerable,jc=(s,e,t)=>e in s?wg(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Sn=(s,e)=>{for(var t in e||(e={}))Eg.call(e,t)&&jc(s,t,e[t]);if(Bc)for(var t of Bc(e))Ig.call(e,t)&&jc(s,t,e[t]);return s},_g=(s,e)=>bg(s,vg(e));function Cg(s,e="-"){let t={},i="relay"+e;return Object.keys(s).forEach(r=>{if(r.startsWith(i)){let n=r.replace(i,""),o=s[r];t[n]=o}}),t}function wo(s){if(!s.includes("wc:")){let l=rl(s);l!=null&&l.includes("wc:")&&(s=l)}s=s.includes("wc://")?s.replace("wc://",""):s,s=s.includes("wc:")?s.replace("wc:",""):s;let e=s.indexOf(":"),t=s.indexOf("?")!==-1?s.indexOf("?"):void 0,i=s.substring(0,e),r=s.substring(e+1,t).split("@"),n=typeof t<"u"?s.substring(t):"",o=new URLSearchParams(n),a=Object.fromEntries(o.entries()),c=typeof a.methods=="string"?a.methods.split(","):void 0;return{protocol:i,topic:Ag(r[0]),version:parseInt(r[1],10),symKey:a.symKey,relay:Cg(a),methods:c,expiryTimestamp:a.expiryTimestamp?parseInt(a.expiryTimestamp,10):void 0}}function Ag(s){return s.startsWith("//")?s.substring(2):s}function Sg(s,e="-"){let t="relay",i={};return Object.keys(s).forEach(r=>{let n=r,o=t+e+n;s[n]&&(i[o]=s[n])}),i}function bo(s){let e=new URLSearchParams,t=Sn(Sn(_g(Sn({},Sg(s.relay)),{symKey:s.symKey}),s.expiryTimestamp&&{expiryTimestamp:s.expiryTimestamp.toString()}),s.methods&&{methods:s.methods.join(",")});return Object.entries(t).sort(([i],[r])=>i.localeCompare(r)).forEach(([i,r])=>{r!==void 0&&e.append(i,String(r))}),`${s.protocol}:${s.topic}@${s.version}?${e}`}function xi(s,e,t){return`${s}?wc_ev=${t}&topic=${e}`}var Ng=Object.defineProperty,Og=Object.defineProperties,Tg=Object.getOwnPropertyDescriptors,Mc=Object.getOwnPropertySymbols,Pg=Object.prototype.hasOwnProperty,Rg=Object.prototype.propertyIsEnumerable,$c=(s,e,t)=>e in s?Ng(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,xg=(s,e)=>{for(var t in e||(e={}))Pg.call(e,t)&&$c(s,t,e[t]);if(Mc)for(var t of Mc(e))Rg.call(e,t)&&$c(s,t,e[t]);return s},kg=(s,e)=>Og(s,Tg(e));function Qs(s){let e=[];return s.forEach(t=>{let[i,r]=t.split(":");e.push(`${i}:${r}`)}),e}function Ug(s){let e=[];return Object.values(s).forEach(t=>{e.push(...Qs(t.accounts))}),e}function Fg(s,e){let t=[];return Object.values(s).forEach(i=>{Qs(i.accounts).includes(e)&&t.push(...i.methods)}),t}function Lg(s,e){let t=[];return Object.values(s).forEach(i=>{Qs(i.accounts).includes(e)&&t.push(...i.events)}),t}function ki(s){return s.includes(":")}function Fs(s){return ki(s)?s.split(":")[0]:s}function Vc(s){var e,t,i;let r={};if(!ht(s))return r;for(let[n,o]of Object.entries(s)){let a=ki(n)?[n]:o.chains,c=o.methods||[],l=o.events||[],h=Fs(n);r[h]=kg(xg({},r[h]),{chains:bt(a,(e=r[h])==null?void 0:e.chains),methods:bt(c,(t=r[h])==null?void 0:t.methods),events:bt(l,(i=r[h])==null?void 0:i.events)})}return r}function Dg(s){let e={};return s?.forEach(t=>{var i;let[r,n]=t.split(":");e[r]||(e[r]={accounts:[],chains:[],events:[],methods:[]}),e[r].accounts.push(t),(i=e[r].chains)==null||i.push(`${r}:${n}`)}),e}function vo(s,e){e=e.map(i=>i.replace("did:pkh:",""));let t=Dg(e);for(let[i,r]of Object.entries(t))r.methods?r.methods=bt(r.methods,s):r.methods=s,r.events=["chainChanged","accountsChanged"];return t}function uh(s,e){var t,i,r,n,o,a;let c=Vc(s),l=Vc(e),h={},d=Object.keys(c).concat(Object.keys(l));for(let u of d)h[u]={chains:bt((t=c[u])==null?void 0:t.chains,(i=l[u])==null?void 0:i.chains),methods:bt((r=c[u])==null?void 0:r.methods,(n=l[u])==null?void 0:n.methods),events:bt((o=c[u])==null?void 0:o.events,(a=l[u])==null?void 0:a.events)};return h}var qg={INVALID_METHOD:{message:"Invalid method.",code:1001},INVALID_EVENT:{message:"Invalid event.",code:1002},INVALID_UPDATE_REQUEST:{message:"Invalid update request.",code:1003},INVALID_EXTEND_REQUEST:{message:"Invalid extend request.",code:1004},INVALID_SESSION_SETTLE_REQUEST:{message:"Invalid session settle request.",code:1005},UNAUTHORIZED_METHOD:{message:"Unauthorized method.",code:3001},UNAUTHORIZED_EVENT:{message:"Unauthorized event.",code:3002},UNAUTHORIZED_UPDATE_REQUEST:{message:"Unauthorized update request.",code:3003},UNAUTHORIZED_EXTEND_REQUEST:{message:"Unauthorized extend request.",code:3004},USER_REJECTED:{message:"User rejected.",code:5e3},USER_REJECTED_CHAINS:{message:"User rejected chains.",code:5001},USER_REJECTED_METHODS:{message:"User rejected methods.",code:5002},USER_REJECTED_EVENTS:{message:"User rejected events.",code:5003},UNSUPPORTED_CHAINS:{message:"Unsupported chains.",code:5100},UNSUPPORTED_METHODS:{message:"Unsupported methods.",code:5101},UNSUPPORTED_EVENTS:{message:"Unsupported events.",code:5102},UNSUPPORTED_ACCOUNTS:{message:"Unsupported accounts.",code:5103},UNSUPPORTED_NAMESPACE_KEY:{message:"Unsupported namespace key.",code:5104},USER_DISCONNECTED:{message:"User disconnected.",code:6e3},SESSION_SETTLEMENT_FAILED:{message:"Session settlement failed.",code:7e3},WC_METHOD_UNSUPPORTED:{message:"Unsupported wc_ method.",code:10001}},Bg={NOT_INITIALIZED:{message:"Not initialized.",code:1},NO_MATCHING_KEY:{message:"No matching key.",code:2},RESTORE_WILL_OVERRIDE:{message:"Restore will override.",code:3},RESUBSCRIBED:{message:"Resubscribed.",code:4},MISSING_OR_INVALID:{message:"Missing or invalid.",code:5},EXPIRED:{message:"Expired.",code:6},UNKNOWN_TYPE:{message:"Unknown type.",code:7},MISMATCHED_TOPIC:{message:"Mismatched topic.",code:8},NON_CONFORMING_NAMESPACES:{message:"Non conforming namespaces.",code:9}};function P(s,e){let{message:t,code:i}=Bg[s];return{message:e?`${t} ${e}`:t,code:i}}function he(s,e){let{message:t,code:i}=qg[s];return{message:e?`${t} ${e}`:t,code:i}}function St(s,e){return Array.isArray(s)?typeof e<"u"&&s.length?s.every(e):!0:!1}function ht(s){return Object.getPrototypeOf(s)===Object.prototype&&Object.keys(s).length}function Ce(s){return typeof s>"u"}function be(s,e){return e&&Ce(s)?!0:typeof s=="string"&&!!s.trim().length}function Eo(s,e){return e&&Ce(s)?!0:typeof s=="number"&&!isNaN(s)}function dh(s,e){let{requiredNamespaces:t}=e,i=Object.keys(s.namespaces),r=Object.keys(t),n=!0;return Ns(r,i)?(i.forEach(o=>{let{accounts:a,methods:c,events:l}=s.namespaces[o],h=Qs(a),d=t[o];(!Ns(Gc(o,d),h)||!Ns(d.methods,c)||!Ns(d.events,l))&&(n=!1)}),n):!1}function Ar(s){return be(s,!1)&&s.includes(":")?s.split(":").length===2:!1}function jg(s){if(be(s,!1)&&s.includes(":")){let e=s.split(":");if(e.length===3){let t=e[0]+":"+e[1];return!!e[2]&&Ar(t)}}return!1}function ph(s){function e(t){try{return typeof new URL(t)<"u"}catch{return!1}}try{if(be(s,!1)){if(e(s))return!0;let t=rl(s);return e(t)}}catch{}return!1}function fh(s){var e;return(e=s?.proposer)==null?void 0:e.publicKey}function gh(s){return s?.topic}function yh(s,e){let t=null;return be(s?.publicKey,!1)||(t=P("MISSING_OR_INVALID",`${e} controller public key should be a string`)),t}function Kc(s){let e=!0;return St(s)?s.length&&(e=s.every(t=>be(t,!1))):e=!1,e}function Mg(s,e,t){let i=null;return St(e)&&e.length?e.forEach(r=>{i||Ar(r)||(i=he("UNSUPPORTED_CHAINS",`${t}, chain ${r} should be a string and conform to "namespace:chainId" format`))}):Ar(s)||(i=he("UNSUPPORTED_CHAINS",`${t}, chains must be defined as "namespace:chainId" e.g. "eip155:1": {...} in the namespace key OR as an array of CAIP-2 chainIds e.g. eip155: { chains: ["eip155:1", "eip155:5"] }`)),i}function $g(s,e,t){let i=null;return Object.entries(s).forEach(([r,n])=>{if(i)return;let o=Mg(r,Gc(r,n),`${e} ${t}`);o&&(i=o)}),i}function Vg(s,e){let t=null;return St(s)?s.forEach(i=>{t||jg(i)||(t=he("UNSUPPORTED_ACCOUNTS",`${e}, account ${i} should be a string and conform to "namespace:chainId:address" format`))}):t=he("UNSUPPORTED_ACCOUNTS",`${e}, accounts should be an array of strings conforming to "namespace:chainId:address" format`),t}function Kg(s,e){let t=null;return Object.values(s).forEach(i=>{if(t)return;let r=Vg(i?.accounts,`${e} namespace`);r&&(t=r)}),t}function zg(s,e){let t=null;return Kc(s?.methods)?Kc(s?.events)||(t=he("UNSUPPORTED_EVENTS",`${e}, events should be an array of strings or empty array for no events`)):t=he("UNSUPPORTED_METHODS",`${e}, methods should be an array of strings or empty array for no methods`),t}function mh(s,e){let t=null;return Object.values(s).forEach(i=>{if(t)return;let r=zg(i,`${e}, namespace`);r&&(t=r)}),t}function wh(s,e,t){let i=null;if(s&&ht(s)){let r=mh(s,e);r&&(i=r);let n=$g(s,e,t);n&&(i=n)}else i=P("MISSING_OR_INVALID",`${e}, ${t} should be an object with data`);return i}function qr(s,e){let t=null;if(s&&ht(s)){let i=mh(s,e);i&&(t=i);let r=Kg(s,e);r&&(t=r)}else t=P("MISSING_OR_INVALID",`${e}, namespaces should be an object with data`);return t}function Io(s){return be(s.protocol,!0)}function bh(s,e){let t=!1;return e&&!s?t=!0:s&&St(s)&&s.length&&s.forEach(i=>{t=Io(i)}),t}function vh(s){return typeof s=="number"}function Me(s){return typeof s<"u"&&typeof s!==null}function Eh(s){return!(!s||typeof s!="object"||!s.code||!Eo(s.code,!1)||!s.message||!be(s.message,!1))}function Ih(s){return!(Ce(s)||!be(s.method,!1))}function _h(s){return!(Ce(s)||Ce(s.result)&&Ce(s.error)||!Eo(s.id,!1)||!be(s.jsonrpc,!1))}function Ch(s){return!(Ce(s)||!be(s.name,!1))}function _o(s,e){return!(!Ar(e)||!Ug(s).includes(e))}function Ah(s,e,t){return be(t,!1)?Fg(s,e).includes(t):!1}function Sh(s,e,t){return be(t,!1)?Lg(s,e).includes(t):!1}function Co(s,e,t){let i=null,r=Hg(s),n=Wg(e),o=Object.keys(r),a=Object.keys(n),c=zc(Object.keys(s)),l=zc(Object.keys(e)),h=c.filter(d=>!l.includes(d));return h.length&&(i=P("NON_CONFORMING_NAMESPACES",`${t} namespaces keys don't satisfy requiredNamespaces.
      Required: ${h.toString()}
      Received: ${Object.keys(e).toString()}`)),Ns(o,a)||(i=P("NON_CONFORMING_NAMESPACES",`${t} namespaces chains don't satisfy required namespaces.
      Required: ${o.toString()}
      Approved: ${a.toString()}`)),Object.keys(e).forEach(d=>{if(!d.includes(":")||i)return;let u=Qs(e[d].accounts);u.includes(d)||(i=P("NON_CONFORMING_NAMESPACES",`${t} namespaces accounts don't satisfy namespace accounts for ${d}
        Required: ${d}
        Approved: ${u.toString()}`))}),o.forEach(d=>{i||(Ns(r[d].methods,n[d].methods)?Ns(r[d].events,n[d].events)||(i=P("NON_CONFORMING_NAMESPACES",`${t} namespaces events don't satisfy namespace events for ${d}`)):i=P("NON_CONFORMING_NAMESPACES",`${t} namespaces methods don't satisfy namespace methods for ${d}`))}),i}function Hg(s){let e={};return Object.keys(s).forEach(t=>{var i;t.includes(":")?e[t]=s[t]:(i=s[t].chains)==null||i.forEach(r=>{e[r]={methods:s[t].methods,events:s[t].events}})}),e}function zc(s){return[...new Set(s.map(e=>e.includes(":")?e.split(":")[0]:e))]}function Wg(s){let e={};return Object.keys(s).forEach(t=>{t.includes(":")?e[t]=s[t]:Qs(s[t].accounts)?.forEach(r=>{e[r]={accounts:s[t].accounts.filter(n=>n.includes(`${r}:`)),methods:s[t].methods,events:s[t].events}})}),e}function Nh(s,e){return Eo(s,!1)&&s<=e.max&&s>=e.min}function Ao(){let s=Ci();return new Promise(e=>{switch(s){case Xe.browser:e(Gg());break;case Xe.reactNative:e(Yg());break;case Xe.node:e(Xg());break;default:e(!0)}})}function Gg(){return xs()&&navigator?.onLine}async function Yg(){return Yt()&&typeof globalThis<"u"&&globalThis!=null&&globalThis.NetInfo?(await globalThis?.NetInfo.fetch())?.isConnected:!0}function Xg(){return!0}function Oh(s){switch(Ci()){case Xe.browser:Jg(s);break;case Xe.reactNative:Zg(s);break;case Xe.node:break}}function Jg(s){!Yt()&&xs()&&(window.addEventListener("online",()=>s(!0)),window.addEventListener("offline",()=>s(!1)))}function Zg(s){Yt()&&typeof globalThis<"u"&&globalThis!=null&&globalThis.NetInfo&&globalThis?.NetInfo.addEventListener(e=>s(e?.isConnected))}function Th(){var s;return xs()&&(0,Et.getDocument)()?((s=(0,Et.getDocument)())==null?void 0:s.visibilityState)==="visible":!0}var Nn={},ys=class{static get(e){return Nn[e]}static set(e,t){Nn[e]=t}static delete(e){delete Nn[e]}};function Qg(s){let e=Qt.decode(s);if(e.length<33)throw new Error("Too short to contain a public key");return e.slice(1,33)}function ey({publicKey:s,signature:e,payload:t}){var i;let r=Wn(t.method),n=128|parseInt(((i=t.version)==null?void 0:i.toString())||"4"),o=iy(t.address),a=t.era==="00"?new Uint8Array([0]):Wn(t.era);if(a.length!==1&&a.length!==2)throw new Error("Invalid era length");let c=parseInt(t.nonce,16),l=new Uint8Array([c&255,c>>8&255]),h=BigInt(`0x${sy(t.tip)}`),d=ny(h),u=new Uint8Array([0,...s,o,...e,...a,...l,...d,...r]),p=ry(u.length+1);return new Uint8Array([...p,n,...u])}function ty(s){let e=Wn(s),t=(0,Wc.blake2b)(e,void 0,32);return"0x"+z.from(t).toString("hex")}function Wn(s){return new Uint8Array(s.replace(/^0x/,"").match(/.{1,2}/g).map(e=>parseInt(e,16)))}function sy(s){return s.startsWith("0x")?s.slice(2):s}function iy(s){let e=Qt.decode(s)[0];return e===42?0:e===60?2:1}function ry(s){if(s<64)return new Uint8Array([s<<2]);if(s<16384){let e=s<<2|1;return new Uint8Array([e&255,e>>8&255])}else if(s<1<<30){let e=s<<2|2;return new Uint8Array([e&255,e>>8&255,e>>16&255,e>>24&255])}else throw new Error("Compact encoding > 2^30 not supported")}function ny(s){if(s<BigInt(1)<<BigInt(6))return new Uint8Array([Number(s<<BigInt(2))]);if(s<BigInt(1)<<BigInt(14)){let e=s<<BigInt(2)|BigInt(1);return new Uint8Array([Number(e&BigInt(255)),Number(e>>BigInt(8)&BigInt(255))])}else if(s<BigInt(1)<<BigInt(30)){let e=s<<BigInt(2)|BigInt(2);return new Uint8Array([Number(e&BigInt(255)),Number(e>>BigInt(8)&BigInt(255)),Number(e>>BigInt(16)&BigInt(255)),Number(e>>BigInt(24)&BigInt(255))])}else throw new Error("BigInt compact encoding not supported > 2^30")}function Ph(s){let e=Uint8Array.from(z.from(s.signature,"hex")),t=Qg(s.transaction.address),i=ey({publicKey:t,signature:e,payload:s.transaction}),r=z.from(i).toString("hex");return ty(r)}function ei({logger:s,name:e}){let t=typeof s=="string"?Qi({opts:{level:s,name:e}}).logger:s;return t.level=typeof s=="string"?s:s.level,t}var tu=Dt(ja(),1),su="wc",iu=2,jr="core",Ut=`${su}@2:${jr}:`,oy={name:jr,logger:"error"},ay={database:":memory:"},cy="crypto",Rh="client_ed25519_seed",ly=$.ONE_DAY,hy="keychain",uy="0.3",dy="messages",py="0.3",fy=$.SIX_HOURS,gy="publisher",na="irn",yy="error",ru="wss://relay.walletconnect.org",my="relayer",ve={message:"relayer_message",message_ack:"relayer_message_ack",connect:"relayer_connect",disconnect:"relayer_disconnect",error:"relayer_error",connection_stalled:"relayer_connection_stalled",transport_closed:"relayer_transport_closed",publish:"relayer_publish"},wy="_subscription",ut={payload:"payload",connect:"connect",disconnect:"disconnect",error:"error"},by=.1;var To="2.22.4";var pe={link_mode:"link_mode",relay:"relay"},Br={inbound:"inbound",outbound:"outbound"},vy="0.3",Ey="WALLETCONNECT_CLIENT_ID",xh="WALLETCONNECT_LINK_MODE_APPS",ot={created:"subscription_created",deleted:"subscription_deleted",expired:"subscription_expired",disabled:"subscription_disabled",sync:"subscription_sync",resubscribed:"subscription_resubscribed"};var Iy="subscription",_y="0.3",W0=$.FIVE_SECONDS*1e3,Cy="pairing",Ay="0.3";var Ui={wc_pairingDelete:{req:{ttl:$.ONE_DAY,prompt:!1,tag:1e3},res:{ttl:$.ONE_DAY,prompt:!1,tag:1001}},wc_pairingPing:{req:{ttl:$.THIRTY_SECONDS,prompt:!1,tag:1002},res:{ttl:$.THIRTY_SECONDS,prompt:!1,tag:1003}},unregistered_method:{req:{ttl:$.ONE_DAY,prompt:!1,tag:0},res:{ttl:$.ONE_DAY,prompt:!1,tag:0}}},ws={create:"pairing_create",expire:"pairing_expire",delete:"pairing_delete",ping:"pairing_ping"},Nt={created:"history_created",updated:"history_updated",deleted:"history_deleted",sync:"history_sync"},Sy="history",Ny="0.3",Oy="expirer",at={created:"expirer_created",deleted:"expirer_deleted",expired:"expirer_expired",sync:"expirer_sync"},Ty="0.3";var Py="verify-api",Ry="https://verify.walletconnect.com",nu="https://verify.walletconnect.org",ii=nu,xy=`${ii}/v3`,ky=[Ry,nu],Uy="echo",Fy="https://echo.walletconnect.com";var Ot={pairing_started:"pairing_started",pairing_uri_validation_success:"pairing_uri_validation_success",pairing_uri_not_expired:"pairing_uri_not_expired",store_new_pairing:"store_new_pairing",subscribing_pairing_topic:"subscribing_pairing_topic",subscribe_pairing_topic_success:"subscribe_pairing_topic_success",existing_pairing:"existing_pairing",pairing_not_expired:"pairing_not_expired",emit_inactive_pairing:"emit_inactive_pairing",emit_session_proposal:"emit_session_proposal",subscribing_to_pairing_topic:"subscribing_to_pairing_topic"},kt={no_wss_connection:"no_wss_connection",no_internet_connection:"no_internet_connection",malformed_pairing_uri:"malformed_pairing_uri",active_pairing_already_exists:"active_pairing_already_exists",subscribe_pairing_topic_failure:"subscribe_pairing_topic_failure",pairing_expired:"pairing_expired",proposal_expired:"proposal_expired",proposal_listener_not_found:"proposal_listener_not_found"},pt={session_approve_started:"session_approve_started",proposal_not_expired:"proposal_not_expired",session_namespaces_validation_success:"session_namespaces_validation_success",create_session_topic:"create_session_topic",subscribing_session_topic:"subscribing_session_topic",subscribe_session_topic_success:"subscribe_session_topic_success",publishing_session_approve:"publishing_session_approve",session_approve_publish_success:"session_approve_publish_success",store_session:"store_session",publishing_session_settle:"publishing_session_settle",session_settle_publish_success:"session_settle_publish_success",session_request_response_started:"session_request_response_started",session_request_response_validation_success:"session_request_response_validation_success",session_request_response_publish_started:"session_request_response_publish_started"},bs={no_internet_connection:"no_internet_connection",no_wss_connection:"no_wss_connection",proposal_expired:"proposal_expired",subscribe_session_topic_failure:"subscribe_session_topic_failure",session_approve_publish_failure:"session_approve_publish_failure",session_settle_publish_failure:"session_settle_publish_failure",session_approve_namespace_validation_failure:"session_approve_namespace_validation_failure",proposal_not_found:"proposal_not_found",session_request_response_validation_failure:"session_request_response_validation_failure",session_request_response_publish_failure:"session_request_response_publish_failure"},vs={authenticated_session_approve_started:"authenticated_session_approve_started",authenticated_session_not_expired:"authenticated_session_not_expired",chains_caip2_compliant:"chains_caip2_compliant",chains_evm_compliant:"chains_evm_compliant",create_authenticated_session_topic:"create_authenticated_session_topic",cacaos_verified:"cacaos_verified",store_authenticated_session:"store_authenticated_session",subscribing_authenticated_session_topic:"subscribing_authenticated_session_topic",subscribe_authenticated_session_topic_success:"subscribe_authenticated_session_topic_success",publishing_authenticated_session_approve:"publishing_authenticated_session_approve",authenticated_session_approve_publish_success:"authenticated_session_approve_publish_success"},ri={no_internet_connection:"no_internet_connection",no_wss_connection:"no_wss_connection",missing_session_authenticate_request:"missing_session_authenticate_request",session_authenticate_request_expired:"session_authenticate_request_expired",chains_caip2_compliant_failure:"chains_caip2_compliant_failure",chains_evm_compliant_failure:"chains_evm_compliant_failure",invalid_cacao:"invalid_cacao",subscribe_authenticated_session_topic_failure:"subscribe_authenticated_session_topic_failure",authenticated_session_approve_publish_failure:"authenticated_session_approve_publish_failure",authenticated_session_pending_request_not_found:"authenticated_session_pending_request_not_found"},Ly=.1,Dy="event-client",qy=86400,By="https://pulse.walletconnect.org/batch";function jy(s,e){if(s.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),i=0;i<t.length;i++)t[i]=255;for(var r=0;r<s.length;r++){var n=s.charAt(r),o=n.charCodeAt(0);if(t[o]!==255)throw new TypeError(n+" is ambiguous");t[o]=r}var a=s.length,c=s.charAt(0),l=Math.log(a)/Math.log(256),h=Math.log(256)/Math.log(a);function d(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,y=0,A=0,_=f.length;A!==_&&f[A]===0;)A++,g++;for(var R=(_-A)*h+1>>>0,B=new Uint8Array(R);A!==_;){for(var D=f[A],U=0,j=R-1;(D!==0||U<y)&&j!==-1;j--,U++)D+=256*B[j]>>>0,B[j]=D%a>>>0,D=D/a>>>0;if(D!==0)throw new Error("Non-zero carry");y=U,A++}for(var M=R-y;M!==R&&B[M]===0;)M++;for(var S=c.repeat(g);M<R;++M)S+=s.charAt(B[M]);return S}function u(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var y=0,A=0;f[g]===c;)y++,g++;for(var _=(f.length-g)*l+1>>>0,R=new Uint8Array(_);f[g];){var B=t[f.charCodeAt(g)];if(B===255)return;for(var D=0,U=_-1;(B!==0||D<A)&&U!==-1;U--,D++)B+=a*R[U]>>>0,R[U]=B%256>>>0,B=B/256>>>0;if(B!==0)throw new Error("Non-zero carry");A=D,g++}if(f[g]!==" "){for(var j=_-A;j!==_&&R[j]===0;)j++;for(var M=new Uint8Array(y+(_-j)),S=y;j!==_;)M[S++]=R[j++];return M}}}function p(f){var g=u(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:u,decode:p}}var My=jy,$y=My,ou=s=>{if(s instanceof Uint8Array&&s.constructor.name==="Uint8Array")return s;if(s instanceof ArrayBuffer)return new Uint8Array(s);if(ArrayBuffer.isView(s))return new Uint8Array(s.buffer,s.byteOffset,s.byteLength);throw new Error("Unknown type, must be binary type")},Vy=s=>new TextEncoder().encode(s),Ky=s=>new TextDecoder().decode(s),Po=class{constructor(e,t,i){this.name=e,this.prefix=t,this.baseEncode=i}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Ro=class{constructor(e,t,i){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=i}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return au(this,e)}},xo=class{constructor(e){this.decoders=e}or(e){return au(this,e)}decode(e){let t=e[0],i=this.decoders[t];if(i)return i.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},au=(s,e)=>new xo({...s.decoders||{[s.prefix]:s},...e.decoders||{[e.prefix]:e}}),ko=class{constructor(e,t,i,r){this.name=e,this.prefix=t,this.baseEncode=i,this.baseDecode=r,this.encoder=new Po(e,t,i),this.decoder=new Ro(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},Mr=({name:s,prefix:e,encode:t,decode:i})=>new ko(s,e,t,i),Bi=({prefix:s,name:e,alphabet:t})=>{let{encode:i,decode:r}=$y(t,e);return Mr({prefix:s,name:e,encode:i,decode:n=>ou(r(n))})},zy=(s,e,t,i)=>{let r={};for(let h=0;h<e.length;++h)r[e[h]]=h;let n=s.length;for(;s[n-1]==="=";)--n;let o=new Uint8Array(n*t/8|0),a=0,c=0,l=0;for(let h=0;h<n;++h){let d=r[s[h]];if(d===void 0)throw new SyntaxError(`Non-${i} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Hy=(s,e,t)=>{let i=e[e.length-1]==="=",r=(1<<t)-1,n="",o=0,a=0;for(let c=0;c<s.length;++c)for(a=a<<8|s[c],o+=8;o>t;)o-=t,n+=e[r&a>>o];if(o&&(n+=e[r&a<<t-o]),i)for(;n.length*t&7;)n+="=";return n},Re=({name:s,prefix:e,bitsPerChar:t,alphabet:i})=>Mr({prefix:e,name:s,encode(r){return Hy(r,i,t)},decode(r){return zy(r,i,t,s)}}),Wy=Mr({prefix:"\0",name:"identity",encode:s=>Ky(s),decode:s=>Vy(s)}),Gy=Object.freeze({__proto__:null,identity:Wy}),Yy=Re({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),Xy=Object.freeze({__proto__:null,base2:Yy}),Jy=Re({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),Zy=Object.freeze({__proto__:null,base8:Jy}),Qy=Bi({prefix:"9",name:"base10",alphabet:"0123456789"}),em=Object.freeze({__proto__:null,base10:Qy}),tm=Re({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),sm=Re({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),im=Object.freeze({__proto__:null,base16:tm,base16upper:sm}),rm=Re({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),nm=Re({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),om=Re({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),am=Re({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),cm=Re({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),lm=Re({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),hm=Re({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),um=Re({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),dm=Re({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),pm=Object.freeze({__proto__:null,base32:rm,base32upper:nm,base32pad:om,base32padupper:am,base32hex:cm,base32hexupper:lm,base32hexpad:hm,base32hexpadupper:um,base32z:dm}),fm=Bi({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),gm=Bi({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),ym=Object.freeze({__proto__:null,base36:fm,base36upper:gm}),mm=Bi({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),wm=Bi({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),bm=Object.freeze({__proto__:null,base58btc:mm,base58flickr:wm}),vm=Re({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Em=Re({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Im=Re({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),_m=Re({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),Cm=Object.freeze({__proto__:null,base64:vm,base64pad:Em,base64url:Im,base64urlpad:_m}),cu=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),Am=cu.reduce((s,e,t)=>(s[t]=e,s),[]),Sm=cu.reduce((s,e,t)=>(s[e.codePointAt(0)]=t,s),[]);function Nm(s){return s.reduce((e,t)=>(e+=Am[t],e),"")}function Om(s){let e=[];for(let t of s){let i=Sm[t.codePointAt(0)];if(i===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(i)}return new Uint8Array(e)}var Tm=Mr({prefix:"\u{1F680}",name:"base256emoji",encode:Nm,decode:Om}),Pm=Object.freeze({__proto__:null,base256emoji:Tm}),Rm=lu,kh=128,xm=127,km=~xm,Um=Math.pow(2,31);function lu(s,e,t){e=e||[],t=t||0;for(var i=t;s>=Um;)e[t++]=s&255|kh,s/=128;for(;s&km;)e[t++]=s&255|kh,s>>>=7;return e[t]=s|0,lu.bytes=t-i+1,e}var Fm=Uo,Lm=128,Uh=127;function Uo(s,i){var t=0,i=i||0,r=0,n=i,o,a=s.length;do{if(n>=a)throw Uo.bytes=0,new RangeError("Could not decode varint");o=s[n++],t+=r<28?(o&Uh)<<r:(o&Uh)*Math.pow(2,r),r+=7}while(o>=Lm);return Uo.bytes=n-i,t}var Dm=Math.pow(2,7),qm=Math.pow(2,14),Bm=Math.pow(2,21),jm=Math.pow(2,28),Mm=Math.pow(2,35),$m=Math.pow(2,42),Vm=Math.pow(2,49),Km=Math.pow(2,56),zm=Math.pow(2,63),Hm=function(s){return s<Dm?1:s<qm?2:s<Bm?3:s<jm?4:s<Mm?5:s<$m?6:s<Vm?7:s<Km?8:s<zm?9:10},Wm={encode:Rm,decode:Fm,encodingLength:Hm},hu=Wm,Fh=(s,e,t=0)=>(hu.encode(s,e,t),e),Lh=s=>hu.encodingLength(s),Fo=(s,e)=>{let t=e.byteLength,i=Lh(s),r=i+Lh(t),n=new Uint8Array(r+t);return Fh(s,n,0),Fh(t,n,i),n.set(e,r),new Lo(s,t,e,n)},Lo=class{constructor(e,t,i,r){this.code=e,this.size=t,this.digest=i,this.bytes=r}},uu=({name:s,code:e,encode:t})=>new Do(s,e,t),Do=class{constructor(e,t,i){this.name=e,this.code=t,this.encode=i}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?Fo(this.code,t):t.then(i=>Fo(this.code,i))}else throw Error("Unknown type, must be binary type")}},du=s=>async e=>new Uint8Array(await crypto.subtle.digest(s,e)),Gm=uu({name:"sha2-256",code:18,encode:du("SHA-256")}),Ym=uu({name:"sha2-512",code:19,encode:du("SHA-512")}),Xm=Object.freeze({__proto__:null,sha256:Gm,sha512:Ym}),pu=0,Jm="identity",fu=ou,Zm=s=>Fo(pu,fu(s)),Qm={code:pu,name:Jm,encode:fu,digest:Zm},ew=Object.freeze({__proto__:null,identity:Qm});new TextEncoder,new TextDecoder;var Dh={...Gy,...Xy,...Zy,...em,...im,...pm,...ym,...bm,...Cm,...Pm};({...Xm,...ew});function gu(s){return globalThis.Buffer!=null?new Uint8Array(s.buffer,s.byteOffset,s.byteLength):s}function tw(s=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?gu(globalThis.Buffer.allocUnsafe(s)):new Uint8Array(s)}function yu(s,e,t,i){return{name:s,prefix:e,encoder:{name:s,prefix:e,encode:t},decoder:{decode:i}}}var qh=yu("utf8","u",s=>"u"+new TextDecoder("utf8").decode(s),s=>new TextEncoder().encode(s.substring(1))),So=yu("ascii","a",s=>{let e="a";for(let t=0;t<s.length;t++)e+=String.fromCharCode(s[t]);return e},s=>{s=s.substring(1);let e=tw(s.length);for(let t=0;t<s.length;t++)e[t]=s.charCodeAt(t);return e}),sw={utf8:qh,"utf-8":qh,hex:Dh.base16,latin1:So,ascii:So,binary:So,...Dh};function iw(s,e="utf8"){let t=sw[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?gu(globalThis.Buffer.from(s,"utf-8")):t.decoder.decode(`${t.prefix}${s}`)}var rw=Object.defineProperty,nw=(s,e,t)=>e in s?rw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,xt=(s,e,t)=>nw(s,typeof e!="symbol"?e+"":e,t),qo=class{constructor(e,t){this.core=e,this.logger=t,xt(this,"keychain",new Map),xt(this,"name",hy),xt(this,"version",uy),xt(this,"initialized",!1),xt(this,"storagePrefix",Ut),xt(this,"init",async()=>{if(!this.initialized){let i=await this.getKeyChain();typeof i<"u"&&(this.keychain=i),this.initialized=!0}}),xt(this,"has",i=>(this.isInitialized(),this.keychain.has(i))),xt(this,"set",async(i,r)=>{this.isInitialized(),this.keychain.set(i,r),await this.persist()}),xt(this,"get",i=>{this.isInitialized();let r=this.keychain.get(i);if(typeof r>"u"){let{message:n}=P("NO_MATCHING_KEY",`${this.name}: ${i}`);throw new Error(n)}return r}),xt(this,"del",async i=>{this.isInitialized(),this.keychain.delete(i),await this.persist()}),this.core=e,this.logger=Ge(t,this.name)}get context(){return Ue(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}async setKeyChain(e){await this.core.storage.setItem(this.storageKey,Sr(e))}async getKeyChain(){let e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?Nr(e):void 0}async persist(){await this.setKeyChain(this.keychain)}isInitialized(){if(!this.initialized){let{message:e}=P("NOT_INITIALIZED",this.name);throw new Error(e)}}},ow=Object.defineProperty,aw=(s,e,t)=>e in s?ow(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ne=(s,e,t)=>aw(s,typeof e!="symbol"?e+"":e,t),Bo=class{constructor(e,t,i){this.core=e,this.logger=t,Ne(this,"name",cy),Ne(this,"keychain"),Ne(this,"randomSessionIdentifier",Dr()),Ne(this,"initialized",!1),Ne(this,"clientId"),Ne(this,"init",async()=>{this.initialized||(await this.keychain.init(),this.initialized=!0)}),Ne(this,"hasKeys",r=>(this.isInitialized(),this.keychain.has(r))),Ne(this,"getClientId",async()=>{if(this.isInitialized(),this.clientId)return this.clientId;let r=await this.getClientSeed(),n=sn(r),o=Da(n.publicKey);return this.clientId=o,o}),Ne(this,"generateKeyPair",()=>{this.isInitialized();let r=Ql();return this.setPrivateKey(r.publicKey,r.privateKey)}),Ne(this,"signJWT",async r=>{this.isInitialized();let n=await this.getClientSeed(),o=sn(n),a=this.randomSessionIdentifier;return await qa(a,r,ly,o)}),Ne(this,"generateSharedKey",(r,n,o)=>{this.isInitialized();let a=this.getPrivateKey(r),c=eh(a,n);return this.setSymKey(c,o)}),Ne(this,"setSymKey",async(r,n)=>{this.isInitialized();let o=n||Js(r);return await this.keychain.set(o,r),o}),Ne(this,"deleteKeyPair",async r=>{this.isInitialized(),await this.keychain.del(r)}),Ne(this,"deleteSymKey",async r=>{this.isInitialized(),await this.keychain.del(r)}),Ne(this,"encode",async(r,n,o)=>{this.isInitialized();let a=go(o),c=hi(n);if(mo(a))return oh(c,o?.encoding);if(yo(a)){let u=a.senderPublicKey,p=a.receiverPublicKey;r=await this.generateSharedKey(u,p)}let l=this.getSymKey(r),{type:h,senderPublicKey:d}=a;return rh({type:h,symKey:l,message:c,senderPublicKey:d,encoding:o?.encoding})}),Ne(this,"decode",async(r,n,o)=>{this.isInitialized();let a=lh(n,o);if(mo(a)){let c=ah(n,o?.encoding);return tn(c)}if(yo(a)){let c=a.receiverPublicKey,l=a.senderPublicKey;r=await this.generateSharedKey(c,l)}try{let c=this.getSymKey(r),l=nh({symKey:c,encoded:n,encoding:o?.encoding});return tn(l)}catch(c){this.logger.error(`Failed to decode message from topic: '${r}', clientId: '${await this.getClientId()}'`),this.logger.error(c)}}),Ne(this,"getPayloadType",(r,n=je)=>{let o=Zs({encoded:r,encoding:n});return gs(o.type)}),Ne(this,"getPayloadSenderPublicKey",(r,n=je)=>{let o=Zs({encoded:r,encoding:n});return o.senderPublicKey?ke(o.senderPublicKey,Be):void 0}),this.core=e,this.logger=Ge(t,this.name),this.keychain=i||new qo(this.core,this.logger)}get context(){return Ue(this.logger)}async setPrivateKey(e,t){return await this.keychain.set(e,t),e}getPrivateKey(e){return this.keychain.get(e)}async getClientSeed(){let e="";try{e=this.keychain.get(Rh)}catch{e=Dr(),await this.keychain.set(Rh,e)}return iw(e,"base16")}getSymKey(e){return this.keychain.get(e)}isInitialized(){if(!this.initialized){let{message:e}=P("NOT_INITIALIZED",this.name);throw new Error(e)}}},cw=Object.defineProperty,lw=Object.defineProperties,hw=Object.getOwnPropertyDescriptors,Bh=Object.getOwnPropertySymbols,uw=Object.prototype.hasOwnProperty,dw=Object.prototype.propertyIsEnumerable,jo=(s,e,t)=>e in s?cw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,pw=(s,e)=>{for(var t in e||(e={}))uw.call(e,t)&&jo(s,t,e[t]);if(Bh)for(var t of Bh(e))dw.call(e,t)&&jo(s,t,e[t]);return s},fw=(s,e)=>lw(s,hw(e)),nt=(s,e,t)=>jo(s,typeof e!="symbol"?e+"":e,t),Mo=class extends sr{constructor(e,t){super(e,t),this.logger=e,this.core=t,nt(this,"messages",new Map),nt(this,"messagesWithoutClientAck",new Map),nt(this,"name",dy),nt(this,"version",py),nt(this,"initialized",!1),nt(this,"storagePrefix",Ut),nt(this,"init",async()=>{if(!this.initialized){this.logger.trace("Initialized");try{let i=await this.getRelayerMessages();typeof i<"u"&&(this.messages=i);let r=await this.getRelayerMessagesWithoutClientAck();typeof r<"u"&&(this.messagesWithoutClientAck=r),this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",size:this.messages.size})}catch(i){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(i)}finally{this.initialized=!0}}}),nt(this,"set",async(i,r,n)=>{this.isInitialized();let o=Ze(r),a=this.messages.get(i);if(typeof a>"u"&&(a={}),typeof a[o]<"u")return o;if(a[o]=r,this.messages.set(i,a),n===Br.inbound){let c=this.messagesWithoutClientAck.get(i)||{};this.messagesWithoutClientAck.set(i,fw(pw({},c),{[o]:r}))}return await this.persist(),o}),nt(this,"get",i=>{this.isInitialized();let r=this.messages.get(i);return typeof r>"u"&&(r={}),r}),nt(this,"getWithoutAck",i=>{this.isInitialized();let r={};for(let n of i){let o=this.messagesWithoutClientAck.get(n)||{};r[n]=Object.values(o)}return r}),nt(this,"has",(i,r)=>{this.isInitialized();let n=this.get(i),o=Ze(r);return typeof n[o]<"u"}),nt(this,"ack",async(i,r)=>{this.isInitialized();let n=this.messagesWithoutClientAck.get(i);if(typeof n>"u")return;let o=Ze(r);delete n[o],Object.keys(n).length===0?this.messagesWithoutClientAck.delete(i):this.messagesWithoutClientAck.set(i,n),await this.persist()}),nt(this,"del",async i=>{this.isInitialized(),this.messages.delete(i),this.messagesWithoutClientAck.delete(i),await this.persist()}),this.logger=Ge(e,this.name),this.core=t}get context(){return Ue(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get storageKeyWithoutClientAck(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name+"_withoutClientAck"}async setRelayerMessages(e){await this.core.storage.setItem(this.storageKey,Sr(e))}async setRelayerMessagesWithoutClientAck(e){await this.core.storage.setItem(this.storageKeyWithoutClientAck,Sr(e))}async getRelayerMessages(){let e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?Nr(e):void 0}async getRelayerMessagesWithoutClientAck(){let e=await this.core.storage.getItem(this.storageKeyWithoutClientAck);return typeof e<"u"?Nr(e):void 0}async persist(){await this.setRelayerMessages(this.messages),await this.setRelayerMessagesWithoutClientAck(this.messagesWithoutClientAck)}isInitialized(){if(!this.initialized){let{message:e}=P("NOT_INITIALIZED",this.name);throw new Error(e)}}},gw=Object.defineProperty,yw=Object.defineProperties,mw=Object.getOwnPropertyDescriptors,jh=Object.getOwnPropertySymbols,ww=Object.prototype.hasOwnProperty,bw=Object.prototype.propertyIsEnumerable,$o=(s,e,t)=>e in s?gw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ti=(s,e)=>{for(var t in e||(e={}))ww.call(e,t)&&$o(s,t,e[t]);if(jh)for(var t of jh(e))bw.call(e,t)&&$o(s,t,e[t]);return s},Mh=(s,e)=>yw(s,mw(e)),dt=(s,e,t)=>$o(s,typeof e!="symbol"?e+"":e,t),Vo=class extends ir{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,dt(this,"events",new Tt),dt(this,"name",gy),dt(this,"queue",new Map),dt(this,"publishTimeout",(0,$.toMiliseconds)($.ONE_MINUTE)),dt(this,"initialPublishTimeout",(0,$.toMiliseconds)($.ONE_SECOND*15)),dt(this,"needsTransportRestart",!1),dt(this,"publish",async(i,r,n)=>{var o,a,c,l,h;this.logger.debug("Publishing Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:i,message:r,opts:n}});let d=n?.ttl||fy,u=n?.prompt||!1,p=n?.tag||0,f=n?.id||Bt().toString(),g=Us(Ri().protocol),y={id:f,method:n?.publishMethod||g.publish,params:ti({topic:i,message:r,ttl:d,prompt:u,tag:p,attestation:n?.attestation},n?.tvf)},A=`Failed to publish payload, please try again. id:${f} tag:${p}`;try{Ce((o=y.params)==null?void 0:o.prompt)&&((a=y.params)==null||delete a.prompt),Ce((c=y.params)==null?void 0:c.tag)&&((l=y.params)==null||delete l.tag);let _=new Promise(async R=>{let B=({id:U})=>{var j;((j=y.id)==null?void 0:j.toString())===U.toString()&&(this.removeRequestFromQueue(U),this.relayer.events.removeListener(ve.publish,B),R())};this.relayer.events.on(ve.publish,B);let D=Ct(new Promise((U,j)=>{this.rpcPublish(y,n).then(U).catch(M=>{this.logger.warn(M,M?.message),j(M)})}),this.initialPublishTimeout,`Failed initial publish, retrying.... id:${f} tag:${p}`);try{await D,this.events.removeListener(ve.publish,B)}catch(U){this.queue.set(f,{request:y,opts:n,attempt:1}),this.logger.warn(U,U?.message)}});this.logger.trace({type:"method",method:"publish",params:{id:f,topic:i,message:r,opts:n}}),await Ct(_,this.publishTimeout,A)}catch(_){if(this.logger.debug("Failed to Publish Payload"),this.logger.error(_),(h=n?.internal)!=null&&h.throwOnFailedPublish)throw _}finally{this.queue.delete(f)}}),dt(this,"publishCustom",async i=>{var r,n,o,a,c;this.logger.debug("Publishing custom payload"),this.logger.trace({type:"method",method:"publishCustom",params:i});let{payload:l,opts:h={}}=i,{attestation:d,tvf:u,publishMethod:p,prompt:f,tag:g,ttl:y=$.FIVE_MINUTES}=h,A=h.id||Bt().toString(),_=Us(Ri().protocol),R=p||_.publish,B={id:A,method:R,params:ti(Mh(ti({},l),{ttl:y,prompt:f,tag:g,attestation:d}),u)},D=`Failed to publish custom payload, please try again. id:${A} tag:${g}`;try{Ce((r=B.params)==null?void 0:r.prompt)&&((n=B.params)==null||delete n.prompt),Ce((o=B.params)==null?void 0:o.tag)&&((a=B.params)==null||delete a.tag);let U=new Promise(async j=>{let M=({id:V})=>{var H;((H=B.id)==null?void 0:H.toString())===V.toString()&&(this.removeRequestFromQueue(V),this.relayer.events.removeListener(ve.publish,M),j())};this.relayer.events.on(ve.publish,M);let S=Ct(new Promise((V,H)=>{this.rpcPublish(B,h).then(V).catch(O=>{this.logger.warn(O,O?.message),H(O)})}),this.initialPublishTimeout,`Failed initial custom payload publish, retrying.... method:${R} id:${A} tag:${g}`);try{await S,this.events.removeListener(ve.publish,M)}catch(V){this.queue.set(A,{request:B,opts:h,attempt:1}),this.logger.warn(V,V?.message)}});this.logger.trace({type:"method",method:"publish",params:{id:A,payload:l,opts:h}}),await Ct(U,this.publishTimeout,D)}catch(U){if(this.logger.debug("Failed to Publish Payload"),this.logger.error(U),(c=h?.internal)!=null&&c.throwOnFailedPublish)throw U}finally{this.queue.delete(A)}}),dt(this,"on",(i,r)=>{this.events.on(i,r)}),dt(this,"once",(i,r)=>{this.events.once(i,r)}),dt(this,"off",(i,r)=>{this.events.off(i,r)}),dt(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),this.relayer=e,this.logger=Ge(t,this.name),this.registerEventListeners()}get context(){return Ue(this.logger)}async rpcPublish(e,t){this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"message",direction:"outgoing",request:e});let i=await this.relayer.request(e);return this.relayer.events.emit(ve.publish,ti(ti({},e),t)),this.logger.debug("Successfully Published Payload"),i}removeRequestFromQueue(e){this.queue.delete(e)}checkQueue(){this.queue.forEach(async(e,t)=>{var i;let r=e.attempt+1;this.queue.set(t,Mh(ti({},e),{attempt:r})),this.logger.warn({},`Publisher: queue->publishing: ${e.request.id}, tag: ${(i=e.request.params)==null?void 0:i.tag}, attempt: ${r}`),await this.rpcPublish(e.request,e.opts),this.logger.warn({},`Publisher: queue->published: ${e.request.id}`)})}registerEventListeners(){this.relayer.core.heartbeat.on(Cs.pulse,()=>{if(this.needsTransportRestart){this.needsTransportRestart=!1,this.relayer.events.emit(ve.connection_stalled);return}this.checkQueue()}),this.relayer.on(ve.message_ack,e=>{this.removeRequestFromQueue(e.id.toString())})}},vw=Object.defineProperty,Ew=(s,e,t)=>e in s?vw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,si=(s,e,t)=>Ew(s,typeof e!="symbol"?e+"":e,t),Ko=class{constructor(){si(this,"map",new Map),si(this,"set",(e,t)=>{let i=this.get(e);this.exists(e,t)||this.map.set(e,[...i,t])}),si(this,"get",e=>this.map.get(e)||[]),si(this,"exists",(e,t)=>this.get(e).includes(t)),si(this,"delete",(e,t)=>{if(typeof t>"u"){this.map.delete(e);return}if(!this.map.has(e))return;let i=this.get(e);if(!this.exists(e,t))return;let r=i.filter(n=>n!==t);if(!r.length){this.map.delete(e);return}this.map.set(e,r)}),si(this,"clear",()=>{this.map.clear()})}get topics(){return Array.from(this.map.keys())}},Iw=Object.defineProperty,_w=Object.defineProperties,Cw=Object.getOwnPropertyDescriptors,$h=Object.getOwnPropertySymbols,Aw=Object.prototype.hasOwnProperty,Sw=Object.prototype.propertyIsEnumerable,zo=(s,e,t)=>e in s?Iw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Fi=(s,e)=>{for(var t in e||(e={}))Aw.call(e,t)&&zo(s,t,e[t]);if($h)for(var t of $h(e))Sw.call(e,t)&&zo(s,t,e[t]);return s},No=(s,e)=>_w(s,Cw(e)),ue=(s,e,t)=>zo(s,typeof e!="symbol"?e+"":e,t),Ho=class extends or{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,ue(this,"subscriptions",new Map),ue(this,"topicMap",new Ko),ue(this,"events",new Tt),ue(this,"name",Iy),ue(this,"version",_y),ue(this,"pending",new Map),ue(this,"cached",[]),ue(this,"initialized",!1),ue(this,"storagePrefix",Ut),ue(this,"subscribeTimeout",(0,$.toMiliseconds)($.ONE_MINUTE)),ue(this,"initialSubscribeTimeout",(0,$.toMiliseconds)($.ONE_SECOND*15)),ue(this,"clientId"),ue(this,"batchSubscribeTopicsLimit",500),ue(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),this.registerEventListeners(),await this.restore()),this.initialized=!0}),ue(this,"subscribe",async(i,r)=>{var n;this.isInitialized(),this.logger.debug("Subscribing Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:i,opts:r}});try{let o=Ri(r),a={topic:i,relay:o,transportType:r?.transportType};(n=r?.internal)!=null&&n.skipSubscribe||this.pending.set(i,a);let c=await this.rpcSubscribe(i,o,r);return typeof c=="string"&&(this.onSubscribe(c,a),this.logger.debug("Successfully Subscribed Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:i,opts:r}})),c}catch(o){throw this.logger.debug("Failed to Subscribe Topic"),this.logger.error(o),o}}),ue(this,"unsubscribe",async(i,r)=>{this.isInitialized(),typeof r?.id<"u"?await this.unsubscribeById(i,r.id,r):await this.unsubscribeByTopic(i,r)}),ue(this,"isSubscribed",i=>new Promise(r=>{r(this.topicMap.topics.includes(i))})),ue(this,"isKnownTopic",i=>new Promise(r=>{r(this.topicMap.topics.includes(i)||this.pending.has(i)||this.cached.some(n=>n.topic===i))})),ue(this,"on",(i,r)=>{this.events.on(i,r)}),ue(this,"once",(i,r)=>{this.events.once(i,r)}),ue(this,"off",(i,r)=>{this.events.off(i,r)}),ue(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),ue(this,"start",async()=>{await this.onConnect()}),ue(this,"stop",async()=>{await this.onDisconnect()}),ue(this,"restart",async()=>{await this.restore(),await this.onRestart()}),ue(this,"checkPending",async()=>{if(this.pending.size===0&&(!this.initialized||!this.relayer.connected))return;let i=[];this.pending.forEach(r=>{i.push(r)}),await this.batchSubscribe(i)}),ue(this,"registerEventListeners",()=>{this.relayer.core.heartbeat.on(Cs.pulse,async()=>{await this.checkPending()}),this.events.on(ot.created,async i=>{let r=ot.created;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:i}),await this.persist()}),this.events.on(ot.deleted,async i=>{let r=ot.deleted;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:i}),await this.persist()})}),this.relayer=e,this.logger=Ge(t,this.name),this.clientId=""}get context(){return Ue(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.relayer.core.customStoragePrefix+"//"+this.name}get length(){return this.subscriptions.size}get ids(){return Array.from(this.subscriptions.keys())}get values(){return Array.from(this.subscriptions.values())}get topics(){return this.topicMap.topics}get hasAnyTopics(){return this.topicMap.topics.length>0||this.pending.size>0||this.cached.length>0||this.subscriptions.size>0}hasSubscription(e,t){let i=!1;try{i=this.getSubscription(e).topic===t}catch{}return i}reset(){this.cached=[],this.initialized=!0}onDisable(){this.values.length>0&&(this.cached=this.values),this.subscriptions.clear(),this.topicMap.clear()}async unsubscribeByTopic(e,t){let i=this.topicMap.get(e);await Promise.all(i.map(async r=>await this.unsubscribeById(e,r,t)))}async unsubscribeById(e,t,i){this.logger.debug("Unsubscribing Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:i}});try{let r=Ri(i);await this.restartToComplete({topic:e,id:t,relay:r}),await this.rpcUnsubscribe(e,t,r);let n=he("USER_DISCONNECTED",`${this.name}, ${e}`);await this.onUnsubscribe(e,t,n),this.logger.debug("Successfully Unsubscribed Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:i}})}catch(r){throw this.logger.debug("Failed to Unsubscribe Topic"),this.logger.error(r),r}}async rpcSubscribe(e,t,i){var r,n;let o=await this.getSubscriptionId(e);if((r=i?.internal)!=null&&r.skipSubscribe)return o;(!i||i?.transportType===pe.relay)&&await this.restartToComplete({topic:e,id:e,relay:t});let a={method:Us(t.protocol).subscribe,params:{topic:e}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:a});let c=(n=i?.internal)==null?void 0:n.throwOnFailedPublish;try{if(i?.transportType===pe.link_mode)return setTimeout(()=>{(this.relayer.connected||this.relayer.connecting)&&this.relayer.request(a).catch(d=>this.logger.warn(d))},(0,$.toMiliseconds)($.ONE_SECOND)),o;let l=new Promise(async d=>{let u=p=>{p.topic===e&&(this.events.removeListener(ot.created,u),d(p.id))};this.events.on(ot.created,u);try{let p=await Ct(new Promise((f,g)=>{this.relayer.request(a).catch(y=>{this.logger.warn(y,y?.message),g(y)}).then(f)}),this.initialSubscribeTimeout,`Subscribing to ${e} failed, please try again`);this.events.removeListener(ot.created,u),d(p)}catch{}}),h=await Ct(l,this.subscribeTimeout,`Subscribing to ${e} failed, please try again`);if(!h&&c)throw new Error(`Subscribing to ${e} failed, please try again`);return h?o:null}catch(l){if(this.logger.debug("Outgoing Relay Subscribe Payload stalled"),this.relayer.events.emit(ve.connection_stalled),c)throw l}return null}async rpcBatchSubscribe(e){if(!e.length)return;let t=e[0].relay,i={method:Us(t.protocol).batchSubscribe,params:{topics:e.map(r=>r.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:i});try{await await Ct(new Promise(r=>{this.relayer.request(i).catch(n=>this.logger.warn(n)).then(r)}),this.subscribeTimeout,"rpcBatchSubscribe failed, please try again")}catch{this.relayer.events.emit(ve.connection_stalled)}}async rpcBatchFetchMessages(e){if(!e.length)return;let t=e[0].relay,i={method:Us(t.protocol).batchFetchMessages,params:{topics:e.map(n=>n.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:i});let r;try{r=await await Ct(new Promise((n,o)=>{this.relayer.request(i).catch(a=>{this.logger.warn(a),o(a)}).then(n)}),this.subscribeTimeout,"rpcBatchFetchMessages failed, please try again")}catch{this.relayer.events.emit(ve.connection_stalled)}return r}rpcUnsubscribe(e,t,i){let r={method:Us(i.protocol).unsubscribe,params:{topic:e,id:t}};return this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:r}),this.relayer.request(r)}onSubscribe(e,t){this.setSubscription(e,No(Fi({},t),{id:e})),this.pending.delete(t.topic)}onBatchSubscribe(e){e.length&&e.forEach(t=>{this.setSubscription(t.id,Fi({},t)),this.pending.delete(t.topic)})}async onUnsubscribe(e,t,i){this.events.removeAllListeners(t),this.hasSubscription(t,e)&&this.deleteSubscription(t,i),await this.relayer.messages.del(e)}async setRelayerSubscriptions(e){await this.relayer.core.storage.setItem(this.storageKey,e)}async getRelayerSubscriptions(){return await this.relayer.core.storage.getItem(this.storageKey)}setSubscription(e,t){this.logger.debug("Setting subscription"),this.logger.trace({type:"method",method:"setSubscription",id:e,subscription:t}),this.addSubscription(e,t)}addSubscription(e,t){this.subscriptions.set(e,Fi({},t)),this.topicMap.set(t.topic,e),this.events.emit(ot.created,t)}getSubscription(e){this.logger.debug("Getting subscription"),this.logger.trace({type:"method",method:"getSubscription",id:e});let t=this.subscriptions.get(e);if(!t){let{message:i}=P("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(i)}return t}deleteSubscription(e,t){this.logger.debug("Deleting subscription"),this.logger.trace({type:"method",method:"deleteSubscription",id:e,reason:t});let i=this.getSubscription(e);this.subscriptions.delete(e),this.topicMap.delete(i.topic,e),this.events.emit(ot.deleted,No(Fi({},i),{reason:t}))}async persist(){await this.setRelayerSubscriptions(this.values),this.events.emit(ot.sync)}async onRestart(){if(this.cached.length){let e=[...this.cached],t=Math.ceil(this.cached.length/this.batchSubscribeTopicsLimit);for(let i=0;i<t;i++){let r=e.splice(0,this.batchSubscribeTopicsLimit);await this.batchSubscribe(r)}}this.events.emit(ot.resubscribed)}async restore(){try{let e=await this.getRelayerSubscriptions();if(typeof e>"u"||!e.length)return;if(this.subscriptions.size&&!e.every(t=>{var i;return t.topic===((i=this.subscriptions.get(t.id))==null?void 0:i.topic)})){let{message:t}=P("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),this.logger.error(`${this.name}: ${JSON.stringify(this.values)}`),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored subscriptions for ${this.name}`),this.logger.trace({type:"method",method:"restore",subscriptions:this.values})}catch(e){this.logger.debug(`Failed to Restore subscriptions for ${this.name}`),this.logger.error(e)}}async batchSubscribe(e){e.length&&(await this.rpcBatchSubscribe(e),this.onBatchSubscribe(await Promise.all(e.map(async t=>No(Fi({},t),{id:await this.getSubscriptionId(t.topic)})))))}async batchFetchMessages(e){if(!e.length)return;this.logger.trace(`Fetching batch messages for ${e.length} subscriptions`);let t=await this.rpcBatchFetchMessages(e);t&&t.messages&&(await nl((0,$.toMiliseconds)($.ONE_SECOND)),await this.relayer.handleBatchMessageEvents(t.messages))}async onConnect(){await this.restart(),this.reset()}onDisconnect(){this.onDisable()}isInitialized(){if(!this.initialized){let{message:e}=P("NOT_INITIALIZED",this.name);throw new Error(e)}}async restartToComplete(e){!this.relayer.connected&&!this.relayer.connecting&&(this.cached.push(e),await this.relayer.transportOpen())}async getClientId(){return this.clientId||(this.clientId=await this.relayer.core.crypto.getClientId()),this.clientId}async getSubscriptionId(e){return Ze(e+await this.getClientId())}},Nw=Object.defineProperty,Vh=Object.getOwnPropertySymbols,Ow=Object.prototype.hasOwnProperty,Tw=Object.prototype.propertyIsEnumerable,Wo=(s,e,t)=>e in s?Nw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Kh=(s,e)=>{for(var t in e||(e={}))Ow.call(e,t)&&Wo(s,t,e[t]);if(Vh)for(var t of Vh(e))Tw.call(e,t)&&Wo(s,t,e[t]);return s},ie=(s,e,t)=>Wo(s,typeof e!="symbol"?e+"":e,t),Go=class extends rr{constructor(e){var t;super(e),ie(this,"protocol","wc"),ie(this,"version",2),ie(this,"core"),ie(this,"logger"),ie(this,"events",new Tt),ie(this,"provider"),ie(this,"messages"),ie(this,"subscriber"),ie(this,"publisher"),ie(this,"name",my),ie(this,"transportExplicitlyClosed",!1),ie(this,"initialized",!1),ie(this,"connectionAttemptInProgress",!1),ie(this,"relayUrl"),ie(this,"projectId"),ie(this,"packageName"),ie(this,"bundleId"),ie(this,"hasExperiencedNetworkDisruption",!1),ie(this,"pingTimeout"),ie(this,"heartBeatTimeout",(0,$.toMiliseconds)($.THIRTY_SECONDS+$.FIVE_SECONDS)),ie(this,"reconnectTimeout"),ie(this,"connectPromise"),ie(this,"reconnectInProgress",!1),ie(this,"requestsInFlight",[]),ie(this,"connectTimeout",(0,$.toMiliseconds)($.ONE_SECOND*15)),ie(this,"request",async i=>{var r,n;this.logger.debug("Publishing Request Payload");let o=i.id||Bt().toString();await this.toEstablishConnection();try{this.logger.trace({id:o,method:i.method,topic:(r=i.params)==null?void 0:r.topic},"relayer.request - publishing...");let a=`${o}:${((n=i.params)==null?void 0:n.tag)||""}`;this.requestsInFlight.push(a);let c=await this.provider.request(i);return this.requestsInFlight=this.requestsInFlight.filter(l=>l!==a),c}catch(a){throw this.logger.debug(`Failed to Publish Request: ${o}`),a}}),ie(this,"resetPingTimeout",()=>{_i()&&(clearTimeout(this.pingTimeout),this.pingTimeout=setTimeout(()=>{var i,r,n,o;try{this.logger.debug({},"pingTimeout: Connection stalled, terminating..."),(o=(n=(r=(i=this.provider)==null?void 0:i.connection)==null?void 0:r.socket)==null?void 0:n.terminate)==null||o.call(n)}catch(a){this.logger.warn(a,a?.message)}},this.heartBeatTimeout))}),ie(this,"onPayloadHandler",i=>{this.onProviderPayload(i),this.resetPingTimeout()}),ie(this,"onConnectHandler",()=>{this.logger.warn({},"Relayer connected \u{1F6DC}"),this.startPingTimeout(),this.events.emit(ve.connect)}),ie(this,"onDisconnectHandler",()=>{this.logger.warn({},"Relayer disconnected \u{1F6D1}"),this.requestsInFlight=[],this.onProviderDisconnect()}),ie(this,"onProviderErrorHandler",i=>{this.logger.fatal(`Fatal socket error: ${i.message}`),this.events.emit(ve.error,i),this.logger.fatal("Fatal socket error received, closing transport"),this.transportClose()}),ie(this,"registerProviderListeners",()=>{this.provider.on(ut.payload,this.onPayloadHandler),this.provider.on(ut.connect,this.onConnectHandler),this.provider.on(ut.disconnect,this.onDisconnectHandler),this.provider.on(ut.error,this.onProviderErrorHandler)}),this.core=e.core,this.logger=ei({logger:(t=e.logger)!=null?t:yy,name:this.name}),this.messages=new Mo(this.logger,e.core),this.subscriber=new Ho(this,this.logger),this.publisher=new Vo(this,this.logger),this.projectId=e?.projectId,this.relayUrl=e?.relayUrl||ru,Yc()?this.packageName=Gn():Xc()&&(this.bundleId=Gn()),this.provider={}}async init(){this.logger.trace("Initialized"),this.registerEventListeners(),await Promise.all([this.messages.init(),this.subscriber.init()]),this.initialized=!0,this.transportOpen().catch(e=>this.logger.warn(e,e?.message))}get context(){return Ue(this.logger)}get connected(){var e,t,i;return((i=(t=(e=this.provider)==null?void 0:e.connection)==null?void 0:t.socket)==null?void 0:i.readyState)===1||!1}get connecting(){var e,t,i;return((i=(t=(e=this.provider)==null?void 0:e.connection)==null?void 0:t.socket)==null?void 0:i.readyState)===0||this.connectPromise!==void 0||!1}async publish(e,t,i){this.isInitialized(),await this.publisher.publish(e,t,i),await this.recordMessageEvent({topic:e,message:t,publishedAt:Date.now(),transportType:pe.relay},Br.outbound)}async publishCustom(e){this.isInitialized(),await this.publisher.publishCustom(e)}async subscribe(e,t){var i,r,n;this.isInitialized(),(!(t!=null&&t.transportType)||t?.transportType==="relay")&&await this.toEstablishConnection();let o=typeof((i=t?.internal)==null?void 0:i.throwOnFailedPublish)>"u"?!0:(r=t?.internal)==null?void 0:r.throwOnFailedPublish,a=((n=this.subscriber.topicMap.get(e))==null?void 0:n[0])||"",c,l=h=>{h.topic===e&&(this.subscriber.off(ot.created,l),c())};return await Promise.all([new Promise(h=>{c=h,this.subscriber.on(ot.created,l)}),new Promise(async(h,d)=>{a=await this.subscriber.subscribe(e,Kh({internal:{throwOnFailedPublish:o}},t)).catch(u=>{o&&d(u)})||a,h()})]),a}async unsubscribe(e,t){this.isInitialized(),await this.subscriber.unsubscribe(e,t)}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}off(e,t){this.events.off(e,t)}removeListener(e,t){this.events.removeListener(e,t)}async transportDisconnect(){this.provider.disconnect&&(this.hasExperiencedNetworkDisruption||this.connected)?await Ct(this.provider.disconnect(),2e3,"provider.disconnect()").catch(()=>this.onProviderDisconnect()):this.onProviderDisconnect()}async transportClose(){this.transportExplicitlyClosed=!0,await this.transportDisconnect()}async transportOpen(e){if(!this.subscriber.hasAnyTopics){this.logger.info("Starting WS connection skipped because the client has no topics to work with.");return}if(this.connectPromise?(this.logger.debug({},"Waiting for existing connection attempt to resolve..."),await this.connectPromise,this.logger.debug({},"Existing connection attempt resolved")):(this.connectPromise=new Promise(async(t,i)=>{await this.connect(e).then(t).catch(i).finally(()=>{this.connectPromise=void 0})}),await this.connectPromise),!this.connected)throw new Error(`Couldn't establish socket connection to the relay server: ${this.relayUrl}`)}async restartTransport(e){this.logger.debug({},"Restarting transport..."),!this.connectionAttemptInProgress&&(this.relayUrl=e||this.relayUrl,await this.confirmOnlineStateOrThrow(),await this.transportClose(),await this.transportOpen())}async confirmOnlineStateOrThrow(){if(!await Ao())throw new Error("No internet connection detected. Please restart your network and try again.")}async handleBatchMessageEvents(e){if(e?.length===0){this.logger.trace("Batch message events is empty. Ignoring...");return}let t=e.sort((i,r)=>i.publishedAt-r.publishedAt);this.logger.debug(`Batch of ${t.length} message events sorted`);for(let i of t)try{await this.onMessageEvent(i)}catch(r){this.logger.warn(r,"Error while processing batch message event: "+r?.message)}this.logger.trace(`Batch of ${t.length} message events processed`)}async onLinkMessageEvent(e,t){let{topic:i}=e;if(!t.sessionExists){let r=me($.FIVE_MINUTES),n={topic:i,expiry:r,relay:{protocol:"irn"},active:!1};await this.core.pairing.pairings.set(i,n)}this.events.emit(ve.message,e),await this.recordMessageEvent(e,Br.inbound)}async connect(e){await this.confirmOnlineStateOrThrow(),e&&e!==this.relayUrl&&(this.relayUrl=e,await this.transportDisconnect()),this.connectionAttemptInProgress=!0,this.transportExplicitlyClosed=!1;let t=1;for(;t<6;){try{if(this.transportExplicitlyClosed)break;this.logger.debug({},`Connecting to ${this.relayUrl}, attempt: ${t}...`),await this.createProvider(),await new Promise(async(i,r)=>{let n=()=>{r(new Error("Connection interrupted while trying to connect"))};this.provider.once(ut.disconnect,n),await Ct(new Promise((o,a)=>{this.provider.connect().then(o).catch(a)}),this.connectTimeout,`Socket stalled when trying to connect to ${this.relayUrl}`).catch(o=>{r(o)}).finally(()=>{this.provider.off(ut.disconnect,n),clearTimeout(this.reconnectTimeout)}),await new Promise(async(o,a)=>{let c=()=>{r(new Error("Connection interrupted while trying to subscribe"))};this.provider.once(ut.disconnect,c),await this.subscriber.start().then(o).catch(a).finally(()=>{this.provider.off(ut.disconnect,c)})}),this.hasExperiencedNetworkDisruption=!1,i()})}catch(i){await this.subscriber.stop();let r=i;this.logger.warn({},r.message),this.hasExperiencedNetworkDisruption=!0}finally{this.connectionAttemptInProgress=!1}if(this.connected){this.logger.debug({},`Connected to ${this.relayUrl} successfully on attempt: ${t}`);break}await new Promise(i=>setTimeout(i,(0,$.toMiliseconds)(t*1))),t++}}startPingTimeout(){var e,t,i,r,n;if(_i())try{(t=(e=this.provider)==null?void 0:e.connection)!=null&&t.socket&&((n=(r=(i=this.provider)==null?void 0:i.connection)==null?void 0:r.socket)==null||n.on("ping",()=>{this.resetPingTimeout()})),this.resetPingTimeout()}catch(o){this.logger.warn(o,o?.message)}}async createProvider(){this.provider.connection&&this.unregisterProviderListeners();let e=await this.core.crypto.signJWT(this.relayUrl);this.provider=new fi(new za(Zc({sdkVersion:To,protocol:this.protocol,version:this.version,relayUrl:this.relayUrl,projectId:this.projectId,auth:e,useOnCloseEvent:!0,bundleId:this.bundleId,packageName:this.packageName}))),this.registerProviderListeners()}async recordMessageEvent(e,t){let{topic:i,message:r}=e;await this.messages.set(i,r,t)}async shouldIgnoreMessageEvent(e){let{topic:t,message:i}=e;if(!i||i.length===0)return this.logger.warn(`Ignoring invalid/empty message: ${i}`),!0;if(!await this.subscriber.isKnownTopic(t))return this.logger.warn(`Ignoring message for unknown topic ${t}`),!0;let r=this.messages.has(t,i);return r&&this.logger.warn(`Ignoring duplicate message: ${i}`),r}async onProviderPayload(e){if(this.logger.debug("Incoming Relay Payload"),this.logger.trace({type:"payload",direction:"incoming",payload:e}),di(e)){if(!e.method.endsWith(wy))return;let t=e.params,{topic:i,message:r,publishedAt:n,attestation:o}=t.data,a={topic:i,message:r,publishedAt:n,transportType:pe.relay,attestation:o};this.logger.debug("Emitting Relayer Payload"),this.logger.trace(Kh({type:"event",event:t.id},a)),this.events.emit(t.id,a),await this.acknowledgePayload(e),await this.onMessageEvent(a)}else pi(e)&&this.events.emit(ve.message_ack,e)}async onMessageEvent(e){await this.shouldIgnoreMessageEvent(e)||(await this.recordMessageEvent(e,Br.inbound),this.events.emit(ve.message,e))}async acknowledgePayload(e){let t=es(e.id,!0);await this.provider.connection.send(t)}unregisterProviderListeners(){this.provider.off(ut.payload,this.onPayloadHandler),this.provider.off(ut.connect,this.onConnectHandler),this.provider.off(ut.disconnect,this.onDisconnectHandler),this.provider.off(ut.error,this.onProviderErrorHandler),clearTimeout(this.pingTimeout)}async registerEventListeners(){let e=await Ao();Oh(async t=>{e!==t&&(e=t,t?await this.transportOpen().catch(i=>this.logger.error(i,i?.message)):(this.hasExperiencedNetworkDisruption=!0,await this.transportDisconnect(),this.transportExplicitlyClosed=!1))}),this.core.heartbeat.on(Cs.pulse,async()=>{if(!this.transportExplicitlyClosed&&!this.connected&&Th())try{await this.confirmOnlineStateOrThrow(),await this.transportOpen()}catch(t){this.logger.warn(t,t?.message)}})}async onProviderDisconnect(){clearTimeout(this.pingTimeout),this.events.emit(ve.disconnect),this.connectionAttemptInProgress=!1,!this.reconnectInProgress&&(this.reconnectInProgress=!0,await this.subscriber.stop(),this.subscriber.hasAnyTopics&&(this.transportExplicitlyClosed||(this.reconnectTimeout=setTimeout(async()=>{await this.transportOpen().catch(e=>this.logger.error(e,e?.message)),this.reconnectTimeout=void 0,this.reconnectInProgress=!1},(0,$.toMiliseconds)(by)))))}isInitialized(){if(!this.initialized){let{message:e}=P("NOT_INITIALIZED",this.name);throw new Error(e)}}async toEstablishConnection(){if(await this.confirmOnlineStateOrThrow(),!this.connected){if(this.connectPromise){await this.connectPromise;return}await this.connect()}}};function Pw(s,e){return s===e||Number.isNaN(s)&&Number.isNaN(e)}function zh(s){return Object.getOwnPropertySymbols(s).filter(e=>Object.prototype.propertyIsEnumerable.call(s,e))}function Hh(s){return s==null?s===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(s)}var Rw="[object RegExp]",xw="[object String]",kw="[object Number]",Uw="[object Boolean]",Wh="[object Arguments]",Fw="[object Symbol]",Lw="[object Date]",Dw="[object Map]",qw="[object Set]",Bw="[object Array]",jw="[object Function]",Mw="[object ArrayBuffer]",Oo="[object Object]",$w="[object Error]",Vw="[object DataView]",Kw="[object Uint8Array]",zw="[object Uint8ClampedArray]",Hw="[object Uint16Array]",Ww="[object Uint32Array]",Gw="[object BigUint64Array]",Yw="[object Int8Array]",Xw="[object Int16Array]",Jw="[object Int32Array]",Zw="[object BigInt64Array]",Qw="[object Float32Array]",eb="[object Float64Array]";function tb(){}function Gh(s){if(!s||typeof s!="object")return!1;let e=Object.getPrototypeOf(s);return e===null||e===Object.prototype||Object.getPrototypeOf(e)===null?Object.prototype.toString.call(s)==="[object Object]":!1}function sb(s,e,t){return Di(s,e,void 0,void 0,void 0,void 0,t)}function Di(s,e,t,i,r,n,o){let a=o(s,e,t,i,r,n);if(a!==void 0)return a;if(typeof s==typeof e)switch(typeof s){case"bigint":case"string":case"boolean":case"symbol":case"undefined":return s===e;case"number":return s===e||Object.is(s,e);case"function":return s===e;case"object":return qi(s,e,n,o)}return qi(s,e,n,o)}function qi(s,e,t,i){if(Object.is(s,e))return!0;let r=Hh(s),n=Hh(e);if(r===Wh&&(r=Oo),n===Wh&&(n=Oo),r!==n)return!1;switch(r){case xw:return s.toString()===e.toString();case kw:{let c=s.valueOf(),l=e.valueOf();return Pw(c,l)}case Uw:case Lw:case Fw:return Object.is(s.valueOf(),e.valueOf());case Rw:return s.source===e.source&&s.flags===e.flags;case jw:return s===e}t=t??new Map;let o=t.get(s),a=t.get(e);if(o!=null&&a!=null)return o===e;t.set(s,e),t.set(e,s);try{switch(r){case Dw:{if(s.size!==e.size)return!1;for(let[c,l]of s.entries())if(!e.has(c)||!Di(l,e.get(c),c,s,e,t,i))return!1;return!0}case qw:{if(s.size!==e.size)return!1;let c=Array.from(s.values()),l=Array.from(e.values());for(let h=0;h<c.length;h++){let d=c[h],u=l.findIndex(p=>Di(d,p,void 0,s,e,t,i));if(u===-1)return!1;l.splice(u,1)}return!0}case Bw:case Kw:case zw:case Hw:case Ww:case Gw:case Yw:case Xw:case Jw:case Zw:case Qw:case eb:{if(typeof z<"u"&&z.isBuffer(s)!==z.isBuffer(e)||s.length!==e.length)return!1;for(let c=0;c<s.length;c++)if(!Di(s[c],e[c],c,s,e,t,i))return!1;return!0}case Mw:return s.byteLength!==e.byteLength?!1:qi(new Uint8Array(s),new Uint8Array(e),t,i);case Vw:return s.byteLength!==e.byteLength||s.byteOffset!==e.byteOffset?!1:qi(new Uint8Array(s),new Uint8Array(e),t,i);case $w:return s.name===e.name&&s.message===e.message;case Oo:{if(!(qi(s.constructor,e.constructor,t,i)||Gh(s)&&Gh(e)))return!1;let c=[...Object.keys(s),...zh(s)],l=[...Object.keys(e),...zh(e)];if(c.length!==l.length)return!1;for(let h=0;h<c.length;h++){let d=c[h],u=s[d];if(!Object.hasOwn(e,d))return!1;let p=e[d];if(!Di(u,p,d,s,e,t,i))return!1}return!0}default:return!1}}finally{t.delete(s),t.delete(e)}}function ib(s,e){return sb(s,e,tb)}var rb=Object.defineProperty,Yh=Object.getOwnPropertySymbols,nb=Object.prototype.hasOwnProperty,ob=Object.prototype.propertyIsEnumerable,Yo=(s,e,t)=>e in s?rb(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Xh=(s,e)=>{for(var t in e||(e={}))nb.call(e,t)&&Yo(s,t,e[t]);if(Yh)for(var t of Yh(e))ob.call(e,t)&&Yo(s,t,e[t]);return s},Qe=(s,e,t)=>Yo(s,typeof e!="symbol"?e+"":e,t),Ft=class extends nr{constructor(e,t,i,r=Ut,n=void 0){super(e,t,i,r),this.core=e,this.logger=t,this.name=i,Qe(this,"map",new Map),Qe(this,"version",vy),Qe(this,"cached",[]),Qe(this,"initialized",!1),Qe(this,"getKey"),Qe(this,"storagePrefix",Ut),Qe(this,"recentlyDeleted",[]),Qe(this,"recentlyDeletedLimit",200),Qe(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(o=>{this.getKey&&o!==null&&!Ce(o)?this.map.set(this.getKey(o),o):fh(o)?this.map.set(o.id,o):gh(o)&&this.map.set(o.topic,o)}),this.cached=[],this.initialized=!0)}),Qe(this,"set",async(o,a)=>{this.isInitialized(),this.map.has(o)?await this.update(o,a):(this.logger.debug("Setting value"),this.logger.trace({type:"method",method:"set",key:o,value:a}),this.map.set(o,a),await this.persist())}),Qe(this,"get",o=>(this.isInitialized(),this.logger.debug("Getting value"),this.logger.trace({type:"method",method:"get",key:o}),this.getData(o))),Qe(this,"getAll",o=>(this.isInitialized(),o?this.values.filter(a=>Object.keys(o).every(c=>ib(a[c],o[c]))):this.values)),Qe(this,"update",async(o,a)=>{this.isInitialized(),this.logger.debug("Updating value"),this.logger.trace({type:"method",method:"update",key:o,update:a});let c=Xh(Xh({},this.getData(o)),a);this.map.set(o,c),await this.persist()}),Qe(this,"delete",async(o,a)=>{this.isInitialized(),this.map.has(o)&&(this.logger.debug("Deleting value"),this.logger.trace({type:"method",method:"delete",key:o,reason:a}),this.map.delete(o),this.addToRecentlyDeleted(o),await this.persist())}),this.logger=Ge(t,this.name),this.storagePrefix=r,this.getKey=n}get context(){return Ue(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.map.size}get keys(){return Array.from(this.map.keys())}get values(){return Array.from(this.map.values())}addToRecentlyDeleted(e){this.recentlyDeleted.push(e),this.recentlyDeleted.length>=this.recentlyDeletedLimit&&this.recentlyDeleted.splice(0,this.recentlyDeletedLimit/2)}async setDataStore(e){await this.core.storage.setItem(this.storageKey,e)}async getDataStore(){return await this.core.storage.getItem(this.storageKey)}getData(e){let t=this.map.get(e);if(!t){if(this.recentlyDeleted.includes(e)){let{message:r}=P("MISSING_OR_INVALID",`Record was recently deleted - ${this.name}: ${e}`);throw this.logger.error(r),new Error(r)}let{message:i}=P("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(i),new Error(i)}return t}async persist(){await this.setDataStore(this.values)}async restore(){try{let e=await this.getDataStore();if(typeof e>"u"||!e.length)return;if(this.map.size){let{message:t}=P("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored value for ${this.name}`),this.logger.trace({type:"method",method:"restore",value:this.values})}catch(e){this.logger.debug(`Failed to Restore value for ${this.name}`),this.logger.error(e)}}isInitialized(){if(!this.initialized){let{message:e}=P("NOT_INITIALIZED",this.name);throw new Error(e)}}},ab=Object.defineProperty,cb=(s,e,t)=>e in s?ab(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Q=(s,e,t)=>cb(s,typeof e!="symbol"?e+"":e,t),Xo=class{constructor(e,t){this.core=e,this.logger=t,Q(this,"name",Cy),Q(this,"version",Ay),Q(this,"events",new Is),Q(this,"pairings"),Q(this,"initialized",!1),Q(this,"storagePrefix",Ut),Q(this,"ignoredPayloadTypes",[At]),Q(this,"registeredMethods",[]),Q(this,"init",async()=>{this.initialized||(await this.pairings.init(),await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.initialized=!0,this.logger.trace("Initialized"))}),Q(this,"register",({methods:i})=>{this.isInitialized(),this.registeredMethods=[...new Set([...this.registeredMethods,...i])]}),Q(this,"create",async i=>{this.isInitialized();let r=Dr(),n=await this.core.crypto.setSymKey(r),o=me($.FIVE_MINUTES),a={protocol:na},c={topic:n,expiry:o,relay:a,active:!1,methods:i?.methods},l=bo({protocol:this.core.protocol,version:this.core.version,topic:n,symKey:r,relay:a,expiryTimestamp:o,methods:i?.methods});return this.events.emit(ws.create,c),this.core.expirer.set(n,o),await this.pairings.set(n,c),await this.core.relayer.subscribe(n,{transportType:i?.transportType,internal:i?.internal}),{topic:n,uri:l}}),Q(this,"pair",async i=>{this.isInitialized();let r=this.core.eventClient.createEvent({properties:{topic:i?.uri,trace:[Ot.pairing_started]}});this.isValidPair(i,r);let{topic:n,symKey:o,relay:a,expiryTimestamp:c,methods:l}=wo(i.uri);r.props.properties.topic=n,r.addTrace(Ot.pairing_uri_validation_success),r.addTrace(Ot.pairing_uri_not_expired);let h;if(this.pairings.keys.includes(n)){if(h=this.pairings.get(n),r.addTrace(Ot.existing_pairing),h.active)throw r.setError(kt.active_pairing_already_exists),new Error(`Pairing already exists: ${n}. Please try again with a new connection URI.`);r.addTrace(Ot.pairing_not_expired)}let d=c||me($.FIVE_MINUTES),u={topic:n,relay:a,expiry:d,active:!1,methods:l};this.core.expirer.set(n,d),await this.pairings.set(n,u),r.addTrace(Ot.store_new_pairing),i.activatePairing&&await this.activate({topic:n}),this.events.emit(ws.create,u),r.addTrace(Ot.emit_inactive_pairing),this.core.crypto.keychain.has(n)||await this.core.crypto.setSymKey(o,n),r.addTrace(Ot.subscribing_pairing_topic);try{await this.core.relayer.confirmOnlineStateOrThrow()}catch{r.setError(kt.no_internet_connection)}try{await this.core.relayer.subscribe(n,{relay:a})}catch(p){throw r.setError(kt.subscribe_pairing_topic_failure),p}return r.addTrace(Ot.subscribe_pairing_topic_success),u}),Q(this,"activate",async({topic:i})=>{this.isInitialized();let r=me($.FIVE_MINUTES);this.core.expirer.set(i,r),await this.pairings.update(i,{active:!0,expiry:r})}),Q(this,"ping",async i=>{this.isInitialized(),await this.isValidPing(i),this.logger.warn("ping() is deprecated and will be removed in the next major release.");let{topic:r}=i;if(this.pairings.keys.includes(r)){let n=await this.sendRequest(r,"wc_pairingPing",{}),{done:o,resolve:a,reject:c}=Xt();this.events.once(se("pairing_ping",n),({error:l})=>{l?c(l):a()}),await o()}}),Q(this,"updateExpiry",async({topic:i,expiry:r})=>{this.isInitialized(),await this.pairings.update(i,{expiry:r})}),Q(this,"updateMetadata",async({topic:i,metadata:r})=>{this.isInitialized(),await this.pairings.update(i,{peerMetadata:r})}),Q(this,"getPairings",()=>(this.isInitialized(),this.pairings.values)),Q(this,"disconnect",async i=>{this.isInitialized(),await this.isValidDisconnect(i);let{topic:r}=i;this.pairings.keys.includes(r)&&(await this.sendRequest(r,"wc_pairingDelete",he("USER_DISCONNECTED")),await this.deletePairing(r))}),Q(this,"formatUriFromPairing",i=>{this.isInitialized();let{topic:r,relay:n,expiry:o,methods:a}=i,c=this.core.crypto.keychain.get(r);return bo({protocol:this.core.protocol,version:this.core.version,topic:r,symKey:c,relay:n,expiryTimestamp:o,methods:a})}),Q(this,"sendRequest",async(i,r,n)=>{let o=et(r,n),a=await this.core.crypto.encode(i,o),c=Ui[r].req;return this.core.history.set(i,o),this.core.relayer.publish(i,a,c),o.id}),Q(this,"sendResult",async(i,r,n)=>{let o=es(i,n),a=await this.core.crypto.encode(r,o),c=(await this.core.history.get(r,i)).request.method,l=Ui[c].res;await this.core.relayer.publish(r,a,l),await this.core.history.resolve(o)}),Q(this,"sendError",async(i,r,n)=>{let o=Vi(i,n),a=await this.core.crypto.encode(r,o),c=(await this.core.history.get(r,i)).request.method,l=Ui[c]?Ui[c].res:Ui.unregistered_method.res;await this.core.relayer.publish(r,a,l),await this.core.history.resolve(o)}),Q(this,"deletePairing",async(i,r)=>{await this.core.relayer.unsubscribe(i),await Promise.all([this.pairings.delete(i,he("USER_DISCONNECTED")),this.core.crypto.deleteSymKey(i),r?Promise.resolve():this.core.expirer.del(i)])}),Q(this,"cleanup",async()=>{let i=this.pairings.getAll().filter(r=>rt(r.expiry));await Promise.all(i.map(r=>this.deletePairing(r.topic)))}),Q(this,"onRelayEventRequest",async i=>{let{topic:r,payload:n}=i;switch(n.method){case"wc_pairingPing":return await this.onPairingPingRequest(r,n);case"wc_pairingDelete":return await this.onPairingDeleteRequest(r,n);default:return await this.onUnknownRpcMethodRequest(r,n)}}),Q(this,"onRelayEventResponse",async i=>{let{topic:r,payload:n}=i,o=(await this.core.history.get(r,n.id)).request.method;switch(o){case"wc_pairingPing":return this.onPairingPingResponse(r,n);default:return this.onUnknownRpcMethodResponse(o)}}),Q(this,"onPairingPingRequest",async(i,r)=>{let{id:n}=r;try{this.isValidPing({topic:i}),await this.sendResult(n,i,!0),this.events.emit(ws.ping,{id:n,topic:i})}catch(o){await this.sendError(n,i,o),this.logger.error(o)}}),Q(this,"onPairingPingResponse",(i,r)=>{let{id:n}=r;setTimeout(()=>{yt(r)?this.events.emit(se("pairing_ping",n),{}):ct(r)&&this.events.emit(se("pairing_ping",n),{error:r.error})},500)}),Q(this,"onPairingDeleteRequest",async(i,r)=>{let{id:n}=r;try{this.isValidDisconnect({topic:i}),await this.deletePairing(i),this.events.emit(ws.delete,{id:n,topic:i})}catch(o){await this.sendError(n,i,o),this.logger.error(o)}}),Q(this,"onUnknownRpcMethodRequest",async(i,r)=>{let{id:n,method:o}=r;try{if(this.registeredMethods.includes(o))return;let a=he("WC_METHOD_UNSUPPORTED",o);await this.sendError(n,i,a),this.logger.error(a)}catch(a){await this.sendError(n,i,a),this.logger.error(a)}}),Q(this,"onUnknownRpcMethodResponse",i=>{this.registeredMethods.includes(i)||this.logger.error(he("WC_METHOD_UNSUPPORTED",i))}),Q(this,"isValidPair",(i,r)=>{var n;if(!Me(i)){let{message:a}=P("MISSING_OR_INVALID",`pair() params: ${i}`);throw r.setError(kt.malformed_pairing_uri),new Error(a)}if(!ph(i.uri)){let{message:a}=P("MISSING_OR_INVALID",`pair() uri: ${i.uri}`);throw r.setError(kt.malformed_pairing_uri),new Error(a)}let o=wo(i?.uri);if(!((n=o?.relay)!=null&&n.protocol)){let{message:a}=P("MISSING_OR_INVALID","pair() uri#relay-protocol");throw r.setError(kt.malformed_pairing_uri),new Error(a)}if(!(o!=null&&o.symKey)){let{message:a}=P("MISSING_OR_INVALID","pair() uri#symKey");throw r.setError(kt.malformed_pairing_uri),new Error(a)}if(o!=null&&o.expiryTimestamp&&(0,$.toMiliseconds)(o?.expiryTimestamp)<Date.now()){r.setError(kt.pairing_expired);let{message:a}=P("EXPIRED","pair() URI has expired. Please try again with a new connection URI.");throw new Error(a)}}),Q(this,"isValidPing",async i=>{if(!Me(i)){let{message:n}=P("MISSING_OR_INVALID",`ping() params: ${i}`);throw new Error(n)}let{topic:r}=i;await this.isValidPairingTopic(r)}),Q(this,"isValidDisconnect",async i=>{if(!Me(i)){let{message:n}=P("MISSING_OR_INVALID",`disconnect() params: ${i}`);throw new Error(n)}let{topic:r}=i;await this.isValidPairingTopic(r)}),Q(this,"isValidPairingTopic",async i=>{if(!be(i,!1)){let{message:r}=P("MISSING_OR_INVALID",`pairing topic should be a string: ${i}`);throw new Error(r)}if(!this.pairings.keys.includes(i)){let{message:r}=P("NO_MATCHING_KEY",`pairing topic doesn't exist: ${i}`);throw new Error(r)}if(rt(this.pairings.get(i).expiry)){await this.deletePairing(i);let{message:r}=P("EXPIRED",`pairing topic: ${i}`);throw new Error(r)}}),this.core=e,this.logger=Ge(t,this.name),this.pairings=new Ft(this.core,this.logger,this.name,this.storagePrefix)}get context(){return Ue(this.logger)}isInitialized(){if(!this.initialized){let{message:e}=P("NOT_INITIALIZED",this.name);throw new Error(e)}}registerRelayerEvents(){this.core.relayer.on(ve.message,async e=>{let{topic:t,message:i,transportType:r}=e;if(this.pairings.keys.includes(t)&&r!==pe.link_mode&&!this.ignoredPayloadTypes.includes(this.core.crypto.getPayloadType(i)))try{let n=await this.core.crypto.decode(t,i);di(n)?(this.core.history.set(t,n),await this.onRelayEventRequest({topic:t,payload:n})):pi(n)&&(await this.core.history.resolve(n),await this.onRelayEventResponse({topic:t,payload:n}),this.core.history.delete(t,n.id)),await this.core.relayer.messages.ack(t,i)}catch(n){this.logger.error(n)}})}registerExpirerEvents(){this.core.expirer.on(at.expired,async e=>{let{topic:t}=Or(e.target);t&&this.pairings.keys.includes(t)&&(await this.deletePairing(t,!0),this.events.emit(ws.expire,{topic:t}))})}},lb=Object.defineProperty,hb=(s,e,t)=>e in s?lb(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Pe=(s,e,t)=>hb(s,typeof e!="symbol"?e+"":e,t),Jo=class extends tr{constructor(e,t){super(e,t),this.core=e,this.logger=t,Pe(this,"records",new Map),Pe(this,"events",new Tt),Pe(this,"name",Sy),Pe(this,"version",Ny),Pe(this,"cached",[]),Pe(this,"initialized",!1),Pe(this,"storagePrefix",Ut),Pe(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(i=>this.records.set(i.id,i)),this.cached=[],this.registerEventListeners(),this.initialized=!0)}),Pe(this,"set",(i,r,n)=>{if(this.isInitialized(),this.logger.debug("Setting JSON-RPC request history record"),this.logger.trace({type:"method",method:"set",topic:i,request:r,chainId:n}),this.records.has(r.id))return;let o={id:r.id,topic:i,request:{method:r.method,params:r.params||null},chainId:n,expiry:me($.THIRTY_DAYS)};this.records.set(o.id,o),this.persist(),this.events.emit(Nt.created,o)}),Pe(this,"resolve",async i=>{if(this.isInitialized(),this.logger.debug("Updating JSON-RPC response history record"),this.logger.trace({type:"method",method:"update",response:i}),!this.records.has(i.id))return;let r=await this.getRecord(i.id);typeof r.response>"u"&&(r.response=ct(i)?{error:i.error}:{result:i.result},this.records.set(r.id,r),this.persist(),this.events.emit(Nt.updated,r))}),Pe(this,"get",async(i,r)=>(this.isInitialized(),this.logger.debug("Getting record"),this.logger.trace({type:"method",method:"get",topic:i,id:r}),await this.getRecord(r))),Pe(this,"delete",(i,r)=>{this.isInitialized(),this.logger.debug("Deleting record"),this.logger.trace({type:"method",method:"delete",id:r}),this.values.forEach(n=>{if(n.topic===i){if(typeof r<"u"&&n.id!==r)return;this.records.delete(n.id),this.events.emit(Nt.deleted,n)}}),this.persist()}),Pe(this,"exists",async(i,r)=>(this.isInitialized(),this.records.has(r)?(await this.getRecord(r)).topic===i:!1)),Pe(this,"on",(i,r)=>{this.events.on(i,r)}),Pe(this,"once",(i,r)=>{this.events.once(i,r)}),Pe(this,"off",(i,r)=>{this.events.off(i,r)}),Pe(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),this.logger=Ge(t,this.name)}get context(){return Ue(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get size(){return this.records.size}get keys(){return Array.from(this.records.keys())}get values(){return Array.from(this.records.values())}get pending(){let e=[];return this.values.forEach(t=>{if(typeof t.response<"u")return;let i={topic:t.topic,request:et(t.request.method,t.request.params,t.id),chainId:t.chainId};return e.push(i)}),e}async setJsonRpcRecords(e){await this.core.storage.setItem(this.storageKey,e)}async getJsonRpcRecords(){return await this.core.storage.getItem(this.storageKey)}getRecord(e){this.isInitialized();let t=this.records.get(e);if(!t){let{message:i}=P("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(i)}return t}async persist(){await this.setJsonRpcRecords(this.values),this.events.emit(Nt.sync)}async restore(){try{let e=await this.getJsonRpcRecords();if(typeof e>"u"||!e.length)return;if(this.records.size){let{message:t}=P("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",records:this.values})}catch(e){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(e)}}registerEventListeners(){this.events.on(Nt.created,e=>{let t=Nt.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.events.on(Nt.updated,e=>{let t=Nt.updated;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.events.on(Nt.deleted,e=>{let t=Nt.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.core.heartbeat.on(Cs.pulse,()=>{this.cleanup()})}cleanup(){try{this.isInitialized();let e=!1;this.records.forEach(t=>{(0,$.toMiliseconds)(t.expiry||0)-Date.now()<=0&&(this.logger.info(`Deleting expired history log: ${t.id}`),this.records.delete(t.id),this.events.emit(Nt.deleted,t,!1),e=!0)}),e&&this.persist()}catch(e){this.logger.warn(e)}}isInitialized(){if(!this.initialized){let{message:e}=P("NOT_INITIALIZED",this.name);throw new Error(e)}}},ub=Object.defineProperty,db=(s,e,t)=>e in s?ub(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,$e=(s,e,t)=>db(s,typeof e!="symbol"?e+"":e,t),Zo=class extends ar{constructor(e,t){super(e,t),this.core=e,this.logger=t,$e(this,"expirations",new Map),$e(this,"events",new Tt),$e(this,"name",Oy),$e(this,"version",Ty),$e(this,"cached",[]),$e(this,"initialized",!1),$e(this,"storagePrefix",Ut),$e(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(i=>this.expirations.set(i.target,i)),this.cached=[],this.registerEventListeners(),this.initialized=!0)}),$e(this,"has",i=>{try{let r=this.formatTarget(i);return typeof this.getExpiration(r)<"u"}catch{return!1}}),$e(this,"set",(i,r)=>{this.isInitialized();let n=this.formatTarget(i),o={target:n,expiry:r};this.expirations.set(n,o),this.checkExpiry(n,o),this.events.emit(at.created,{target:n,expiration:o})}),$e(this,"get",i=>{this.isInitialized();let r=this.formatTarget(i);return this.getExpiration(r)}),$e(this,"del",i=>{if(this.isInitialized(),this.has(i)){let r=this.formatTarget(i),n=this.getExpiration(r);this.expirations.delete(r),this.events.emit(at.deleted,{target:r,expiration:n})}}),$e(this,"on",(i,r)=>{this.events.on(i,r)}),$e(this,"once",(i,r)=>{this.events.once(i,r)}),$e(this,"off",(i,r)=>{this.events.off(i,r)}),$e(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),this.logger=Ge(t,this.name)}get context(){return Ue(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.expirations.size}get keys(){return Array.from(this.expirations.keys())}get values(){return Array.from(this.expirations.values())}formatTarget(e){if(typeof e=="string")return el(e);if(typeof e=="number")return tl(e);let{message:t}=P("UNKNOWN_TYPE",`Target type: ${typeof e}`);throw new Error(t)}async setExpirations(e){await this.core.storage.setItem(this.storageKey,e)}async getExpirations(){return await this.core.storage.getItem(this.storageKey)}async persist(){await this.setExpirations(this.values),this.events.emit(at.sync)}async restore(){try{let e=await this.getExpirations();if(typeof e>"u"||!e.length)return;if(this.expirations.size){let{message:t}=P("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored expirations for ${this.name}`),this.logger.trace({type:"method",method:"restore",expirations:this.values})}catch(e){this.logger.debug(`Failed to Restore expirations for ${this.name}`),this.logger.error(e)}}getExpiration(e){let t=this.expirations.get(e);if(!t){let{message:i}=P("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.warn(i),new Error(i)}return t}checkExpiry(e,t){let{expiry:i}=t;(0,$.toMiliseconds)(i)-Date.now()<=0&&this.expire(e,t)}expire(e,t){this.expirations.delete(e),this.events.emit(at.expired,{target:e,expiration:t})}checkExpirations(){this.core.relayer.connected&&this.expirations.forEach((e,t)=>this.checkExpiry(t,e))}registerEventListeners(){this.core.heartbeat.on(Cs.pulse,()=>this.checkExpirations()),this.events.on(at.created,e=>{let t=at.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(at.expired,e=>{let t=at.expired;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(at.deleted,e=>{let t=at.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()})}isInitialized(){if(!this.initialized){let{message:e}=P("NOT_INITIALIZED",this.name);throw new Error(e)}}},pb=Object.defineProperty,fb=(s,e,t)=>e in s?pb(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ae=(s,e,t)=>fb(s,typeof e!="symbol"?e+"":e,t),Qo=class extends cr{constructor(e,t,i){super(e,t,i),this.core=e,this.logger=t,this.store=i,Ae(this,"name",Py),Ae(this,"abortController"),Ae(this,"isDevEnv"),Ae(this,"verifyUrlV3",xy),Ae(this,"storagePrefix",Ut),Ae(this,"version",iu),Ae(this,"publicKey"),Ae(this,"fetchPromise"),Ae(this,"init",async()=>{var r;this.isDevEnv||(this.publicKey=await this.store.getItem(this.storeKey),this.publicKey&&(0,$.toMiliseconds)((r=this.publicKey)==null?void 0:r.expiresAt)<Date.now()&&(this.logger.debug("verify v2 public key expired"),await this.removePublicKey()))}),Ae(this,"register",async r=>{if(!xs()||this.isDevEnv)return;let n=window.location.origin,{id:o,decryptedId:a}=r,c=`${this.verifyUrlV3}/attestation?projectId=${this.core.projectId}&origin=${n}&id=${o}&decryptedId=${a}`;try{let l=(0,tu.getDocument)(),h=this.startAbortTimer($.ONE_SECOND*5),d=await new Promise((u,p)=>{let f=()=>{window.removeEventListener("message",y),l.body.removeChild(g),p("attestation aborted")};this.abortController.signal.addEventListener("abort",f);let g=l.createElement("iframe");g.src=c,g.style.display="none",g.addEventListener("error",f,{signal:this.abortController.signal});let y=A=>{if(A.data&&typeof A.data=="string")try{let _=JSON.parse(A.data);if(_.type==="verify_attestation"){if(ui(_.attestation).payload.id!==o)return;clearInterval(h),l.body.removeChild(g),this.abortController.signal.removeEventListener("abort",f),window.removeEventListener("message",y),u(_.attestation===null?"":_.attestation)}}catch(_){this.logger.warn(_)}};l.body.appendChild(g),window.addEventListener("message",y,{signal:this.abortController.signal})});return this.logger.debug(d,"jwt attestation"),d}catch(l){this.logger.warn(l)}return""}),Ae(this,"resolve",async r=>{if(this.isDevEnv)return"";let{attestationId:n,hash:o,encryptedId:a}=r;if(n===""){this.logger.debug("resolve: attestationId is empty, skipping");return}if(n){if(ui(n).payload.id!==a)return;let l=await this.isValidJwtAttestation(n);if(l){if(!l.isVerified){this.logger.warn("resolve: jwt attestation: origin url not verified");return}return l}}if(!o)return;let c=this.getVerifyUrl(r?.verifyUrl);return this.fetchAttestation(o,c)}),Ae(this,"fetchAttestation",async(r,n)=>{this.logger.debug(`resolving attestation: ${r} from url: ${n}`);let o=this.startAbortTimer($.ONE_SECOND*5),a=await fetch(`${n}/attestation/${r}?v2Supported=true`,{signal:this.abortController.signal});return clearTimeout(o),a.status===200?await a.json():void 0}),Ae(this,"getVerifyUrl",r=>{let n=r||ii;return ky.includes(n)||(this.logger.info(`verify url: ${n}, not included in trusted list, assigning default: ${ii}`),n=ii),n}),Ae(this,"fetchPublicKey",async()=>{try{this.logger.debug(`fetching public key from: ${this.verifyUrlV3}`);let r=this.startAbortTimer($.FIVE_SECONDS),n=await fetch(`${this.verifyUrlV3}/public-key`,{signal:this.abortController.signal});return clearTimeout(r),await n.json()}catch(r){this.logger.warn(r)}}),Ae(this,"persistPublicKey",async r=>{this.logger.debug(r,"persisting public key to local storage"),await this.store.setItem(this.storeKey,r),this.publicKey=r}),Ae(this,"removePublicKey",async()=>{this.logger.debug("removing verify v2 public key from storage"),await this.store.removeItem(this.storeKey),this.publicKey=void 0}),Ae(this,"isValidJwtAttestation",async r=>{let n=await this.getPublicKey();try{if(n)return this.validateAttestation(r,n)}catch(a){this.logger.error(a),this.logger.warn("error validating attestation")}let o=await this.fetchAndPersistPublicKey();try{if(o)return this.validateAttestation(r,o)}catch(a){this.logger.error(a),this.logger.warn("error validating attestation")}}),Ae(this,"getPublicKey",async()=>this.publicKey?this.publicKey:await this.fetchAndPersistPublicKey()),Ae(this,"fetchAndPersistPublicKey",async()=>{if(this.fetchPromise)return await this.fetchPromise,this.publicKey;this.fetchPromise=new Promise(async n=>{let o=await this.fetchPublicKey();o&&(await this.persistPublicKey(o),n(o))});let r=await this.fetchPromise;return this.fetchPromise=void 0,r}),Ae(this,"validateAttestation",(r,n)=>{let o=hh(r,n.publicKey),a={hasExpired:(0,$.toMiliseconds)(o.exp)<Date.now(),payload:o};if(a.hasExpired)throw this.logger.warn("resolve: jwt attestation expired"),new Error("JWT attestation expired");return{origin:a.payload.origin,isScam:a.payload.isScam,isVerified:a.payload.isVerified}}),this.logger=Ge(t,this.name),this.abortController=new AbortController,this.isDevEnv=Ai(),this.init()}get storeKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//verify:public:key"}get context(){return Ue(this.logger)}startAbortTimer(e){return this.abortController=new AbortController,setTimeout(()=>this.abortController.abort(),(0,$.toMiliseconds)(e))}},gb=Object.defineProperty,yb=(s,e,t)=>e in s?gb(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Jh=(s,e,t)=>yb(s,typeof e!="symbol"?e+"":e,t),ea=class extends lr{constructor(e,t){super(e,t),this.projectId=e,this.logger=t,Jh(this,"context",Uy),Jh(this,"registerDeviceToken",async i=>{let{clientId:r,token:n,notificationType:o,enableEncrypted:a=!1}=i,c=`${Fy}/${this.projectId}/clients`;await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:r,type:o,token:n,always_raw:a})})}),this.logger=Ge(t,this.context)}},mb=Object.defineProperty,Zh=Object.getOwnPropertySymbols,wb=Object.prototype.hasOwnProperty,bb=Object.prototype.propertyIsEnumerable,ta=(s,e,t)=>e in s?mb(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Li=(s,e)=>{for(var t in e||(e={}))wb.call(e,t)&&ta(s,t,e[t]);if(Zh)for(var t of Zh(e))bb.call(e,t)&&ta(s,t,e[t]);return s},Oe=(s,e,t)=>ta(s,typeof e!="symbol"?e+"":e,t),sa=class extends hr{constructor(e,t,i=!0){super(e,t,i),this.core=e,this.logger=t,Oe(this,"context",Dy),Oe(this,"storagePrefix",Ut),Oe(this,"storageVersion",Ly),Oe(this,"events",new Map),Oe(this,"shouldPersist",!1),Oe(this,"init",async()=>{if(!Ai())try{let r={eventId:Zn(),timestamp:Date.now(),domain:this.getAppDomain(),props:{event:"INIT",type:"",properties:{client_id:await this.core.crypto.getClientId(),user_agent:Xn(this.core.relayer.protocol,this.core.relayer.version,To)}}};await this.sendEvent([r])}catch(r){this.logger.warn(r)}}),Oe(this,"createEvent",r=>{let{event:n="ERROR",type:o="",properties:{topic:a,trace:c}}=r,l=Zn(),h=this.core.projectId||"",d=Date.now(),u=Li({eventId:l,timestamp:d,props:{event:n,type:o,properties:{topic:a,trace:c}},bundleId:h,domain:this.getAppDomain()},this.setMethods(l));return this.telemetryEnabled&&(this.events.set(l,u),this.shouldPersist=!0),u}),Oe(this,"getEvent",r=>{let{eventId:n,topic:o}=r;if(n)return this.events.get(n);let a=Array.from(this.events.values()).find(c=>c.props.properties.topic===o);if(a)return Li(Li({},a),this.setMethods(a.eventId))}),Oe(this,"deleteEvent",r=>{let{eventId:n}=r;this.events.delete(n),this.shouldPersist=!0}),Oe(this,"setEventListeners",()=>{this.core.heartbeat.on(Cs.pulse,async()=>{this.shouldPersist&&await this.persist(),this.events.forEach(r=>{(0,$.fromMiliseconds)(Date.now())-(0,$.fromMiliseconds)(r.timestamp)>qy&&(this.events.delete(r.eventId),this.shouldPersist=!0)})})}),Oe(this,"setMethods",r=>({addTrace:n=>this.addTrace(r,n),setError:n=>this.setError(r,n)})),Oe(this,"addTrace",(r,n)=>{let o=this.events.get(r);o&&(o.props.properties.trace.push(n),this.events.set(r,o),this.shouldPersist=!0)}),Oe(this,"setError",(r,n)=>{let o=this.events.get(r);o&&(o.props.type=n,o.timestamp=Date.now(),this.events.set(r,o),this.shouldPersist=!0)}),Oe(this,"persist",async()=>{await this.core.storage.setItem(this.storageKey,Array.from(this.events.values())),this.shouldPersist=!1}),Oe(this,"restore",async()=>{try{let r=await this.core.storage.getItem(this.storageKey)||[];if(!r.length)return;r.forEach(n=>{this.events.set(n.eventId,Li(Li({},n),this.setMethods(n.eventId)))})}catch(r){this.logger.warn(r)}}),Oe(this,"submit",async()=>{if(!this.telemetryEnabled||this.events.size===0)return;let r=[];for(let[n,o]of this.events)o.props.type&&r.push(o);if(r.length!==0)try{if((await this.sendEvent(r)).ok)for(let n of r)this.events.delete(n.eventId),this.shouldPersist=!0}catch(n){this.logger.warn(n)}}),Oe(this,"sendEvent",async r=>{let n=this.getAppDomain()?"":"&sp=desktop";return await fetch(`${By}?projectId=${this.core.projectId}&st=events_sdk&sv=js-${To}${n}`,{method:"POST",body:JSON.stringify(r)})}),Oe(this,"getAppDomain",()=>Yn().url),this.logger=Ge(t,this.context),this.telemetryEnabled=i,i?this.restore().then(async()=>{await this.submit(),this.setEventListeners()}):this.persist()}get storageKey(){return this.storagePrefix+this.storageVersion+this.core.customStoragePrefix+"//"+this.context}},vb=Object.defineProperty,Qh=Object.getOwnPropertySymbols,Eb=Object.prototype.hasOwnProperty,Ib=Object.prototype.propertyIsEnumerable,ia=(s,e,t)=>e in s?vb(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,eu=(s,e)=>{for(var t in e||(e={}))Eb.call(e,t)&&ia(s,t,e[t]);if(Qh)for(var t of Qh(e))Ib.call(e,t)&&ia(s,t,e[t]);return s},de=(s,e,t)=>ia(s,typeof e!="symbol"?e+"":e,t),ra=class s extends er{constructor(e){var t;super(e),de(this,"protocol",su),de(this,"version",iu),de(this,"name",jr),de(this,"relayUrl"),de(this,"projectId"),de(this,"customStoragePrefix"),de(this,"events",new Tt),de(this,"logger"),de(this,"heartbeat"),de(this,"relayer"),de(this,"crypto"),de(this,"storage"),de(this,"history"),de(this,"expirer"),de(this,"pairing"),de(this,"verify"),de(this,"echoClient"),de(this,"linkModeSupportedApps"),de(this,"eventClient"),de(this,"initialized",!1),de(this,"logChunkController"),de(this,"on",(a,c)=>this.events.on(a,c)),de(this,"once",(a,c)=>this.events.once(a,c)),de(this,"off",(a,c)=>this.events.off(a,c)),de(this,"removeListener",(a,c)=>this.events.removeListener(a,c)),de(this,"dispatchEnvelope",({topic:a,message:c,sessionExists:l})=>{if(!a||!c)return;let h={topic:a,message:c,publishedAt:Date.now(),transportType:pe.link_mode};this.relayer.onLinkMessageEvent(h,{sessionExists:l})});let i=this.getGlobalCore(e?.customStoragePrefix);if(i)try{return this.customStoragePrefix=i.customStoragePrefix,this.logger=i.logger,this.heartbeat=i.heartbeat,this.crypto=i.crypto,this.history=i.history,this.expirer=i.expirer,this.storage=i.storage,this.relayer=i.relayer,this.pairing=i.pairing,this.verify=i.verify,this.echoClient=i.echoClient,this.linkModeSupportedApps=i.linkModeSupportedApps,this.eventClient=i.eventClient,this.initialized=i.initialized,this.logChunkController=i.logChunkController,i}catch(a){console.warn("Failed to copy global core",a)}this.projectId=e?.projectId,this.relayUrl=e?.relayUrl||ru,this.customStoragePrefix=e!=null&&e.customStoragePrefix?`:${e.customStoragePrefix}`:"";let r=lc({level:typeof e?.logger=="string"&&e.logger?e.logger:oy.logger,name:jr}),{logger:n,chunkLoggerController:o}=Qi({opts:r,maxSizeInBytes:e?.maxLogBlobSizeInBytes,loggerOverride:e?.logger});this.logChunkController=o,(t=this.logChunkController)!=null&&t.downloadLogsBlobInBrowser&&(window.downloadLogsBlobInBrowser=async()=>{var a,c;(a=this.logChunkController)!=null&&a.downloadLogsBlobInBrowser&&((c=this.logChunkController)==null||c.downloadLogsBlobInBrowser({clientId:await this.crypto.getClientId()}))}),this.logger=Ge(n,this.name),this.heartbeat=new Fa,this.crypto=new Bo(this,this.logger,e?.keychain),this.history=new Jo(this,this.logger),this.expirer=new Zo(this,this.logger),this.storage=e!=null&&e.storage?e.storage:new La(eu(eu({},ay),e?.storageOptions)),this.relayer=new Go({core:this,logger:this.logger,relayUrl:this.relayUrl,projectId:this.projectId}),this.pairing=new Xo(this,this.logger),this.verify=new Qo(this,this.logger,this.storage),this.echoClient=new ea(this.projectId||"",this.logger),this.linkModeSupportedApps=[],this.eventClient=new sa(this,this.logger,e?.telemetryEnabled),this.setGlobalCore(this)}static async init(e){let t=new s(e);await t.initialize();let i=await t.crypto.getClientId();return await t.storage.setItem(Ey,i),t}get context(){return Ue(this.logger)}async start(){this.initialized||await this.initialize()}async getLogsBlob(){var e;return(e=this.logChunkController)==null?void 0:e.logsToBlob({clientId:await this.crypto.getClientId()})}async addLinkModeSupportedApp(e){this.linkModeSupportedApps.includes(e)||(this.linkModeSupportedApps.push(e),await this.storage.setItem(xh,this.linkModeSupportedApps))}async initialize(){this.logger.trace("Initialized");try{await this.crypto.init(),await this.history.init(),await this.expirer.init(),await this.relayer.init(),await this.heartbeat.init(),await this.pairing.init(),this.linkModeSupportedApps=await this.storage.getItem(xh)||[],this.initialized=!0,this.logger.info("Core Initialization Success")}catch(e){throw this.logger.warn(e,`Core Initialization Failure at epoch ${Date.now()}`),this.logger.error(e.message),e}}getGlobalCore(e=""){try{if(this.isGlobalCoreDisabled())return;let t=`_walletConnectCore_${e}`,i=`${t}_count`;return globalThis[i]=(globalThis[i]||0)+1,globalThis[i]>1&&console.warn(`WalletConnect Core is already initialized. This is probably a mistake and can lead to unexpected behavior. Init() was called ${globalThis[i]} times.`),globalThis[t]}catch(t){console.warn("Failed to get global WalletConnect core",t);return}}setGlobalCore(e){var t;try{if(this.isGlobalCoreDisabled())return;let i=`_walletConnectCore_${((t=e.opts)==null?void 0:t.customStoragePrefix)||""}`;globalThis[i]=e}catch(i){console.warn("Failed to set global WalletConnect core",i)}}isGlobalCoreDisabled(){try{return typeof Ie<"u"&&Ie.env.DISABLE_GLOBAL_CORE==="true"}catch{return!0}}},mu=ra;var J=Dt(en(),1);var Eu="wc",Iu=2,_u="client",ba=`${Eu}@${Iu}:${_u}:`,oa={name:_u,logger:"error",controller:!1,relayUrl:"wss://relay.walletconnect.org"};var wu="WALLETCONNECT_DEEPLINK_CHOICE";var _b="proposal";var bu="Proposal expired",Cb="session",ni=J.SEVEN_DAYS,Ab="engine",xe={wc_sessionPropose:{req:{ttl:J.FIVE_MINUTES,prompt:!0,tag:1100},res:{ttl:J.FIVE_MINUTES,prompt:!1,tag:1101},reject:{ttl:J.FIVE_MINUTES,prompt:!1,tag:1120},autoReject:{ttl:J.FIVE_MINUTES,prompt:!1,tag:1121}},wc_sessionSettle:{req:{ttl:J.FIVE_MINUTES,prompt:!1,tag:1102},res:{ttl:J.FIVE_MINUTES,prompt:!1,tag:1103}},wc_sessionUpdate:{req:{ttl:J.ONE_DAY,prompt:!1,tag:1104},res:{ttl:J.ONE_DAY,prompt:!1,tag:1105}},wc_sessionExtend:{req:{ttl:J.ONE_DAY,prompt:!1,tag:1106},res:{ttl:J.ONE_DAY,prompt:!1,tag:1107}},wc_sessionRequest:{req:{ttl:J.FIVE_MINUTES,prompt:!0,tag:1108},res:{ttl:J.FIVE_MINUTES,prompt:!1,tag:1109}},wc_sessionEvent:{req:{ttl:J.FIVE_MINUTES,prompt:!0,tag:1110},res:{ttl:J.FIVE_MINUTES,prompt:!1,tag:1111}},wc_sessionDelete:{req:{ttl:J.ONE_DAY,prompt:!1,tag:1112},res:{ttl:J.ONE_DAY,prompt:!1,tag:1113}},wc_sessionPing:{req:{ttl:J.ONE_DAY,prompt:!1,tag:1114},res:{ttl:J.ONE_DAY,prompt:!1,tag:1115}},wc_sessionAuthenticate:{req:{ttl:J.ONE_HOUR,prompt:!0,tag:1116},res:{ttl:J.ONE_HOUR,prompt:!1,tag:1117},reject:{ttl:J.FIVE_MINUTES,prompt:!1,tag:1118},autoReject:{ttl:J.FIVE_MINUTES,prompt:!1,tag:1119}}},aa={min:J.FIVE_MINUTES,max:J.SEVEN_DAYS},Lt={idle:"IDLE",active:"ACTIVE"},Sb={eth_sendTransaction:{key:""},eth_sendRawTransaction:{key:""},wallet_sendCalls:{key:""},solana_signTransaction:{key:"signature"},solana_signAllTransactions:{key:"transactions"},solana_signAndSendTransaction:{key:"signature"},sui_signAndExecuteTransaction:{key:"digest"},sui_signTransaction:{key:""},hedera_signAndExecuteTransaction:{key:"transactionId"},hedera_executeTransaction:{key:"transactionId"},near_signTransaction:{key:""},near_signTransactions:{key:""},tron_signTransaction:{key:"txID"},xrpl_signTransaction:{key:""},xrpl_signTransactionFor:{key:""},algo_signTxn:{key:""},sendTransfer:{key:"txid"},stacks_stxTransfer:{key:"txId"},polkadot_signTransaction:{key:""},cosmos_signDirect:{key:""}},Nb="request",Ob=["wc_sessionPropose","wc_sessionRequest","wc_authRequest","wc_sessionAuthenticate"],Tb="wc";var Pb="auth",Rb="authKeys",xb="pairingTopics",kb="requests",Vr=`${Tb}@${1.5}:${Pb}:`,$r=`${Vr}:PUB_KEY`,Ub=Object.defineProperty,Fb=Object.defineProperties,Lb=Object.getOwnPropertyDescriptors,vu=Object.getOwnPropertySymbols,Db=Object.prototype.hasOwnProperty,qb=Object.prototype.propertyIsEnumerable,la=(s,e,t)=>e in s?Ub(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ne=(s,e)=>{for(var t in e||(e={}))Db.call(e,t)&&la(s,t,e[t]);if(vu)for(var t of vu(e))qb.call(e,t)&&la(s,t,e[t]);return s},Ve=(s,e)=>Fb(s,Lb(e)),C=(s,e,t)=>la(s,typeof e!="symbol"?e+"":e,t),ha=class extends dr{constructor(e){super(e),C(this,"name",Ab),C(this,"events",new Is),C(this,"initialized",!1),C(this,"requestQueue",{state:Lt.idle,queue:[]}),C(this,"sessionRequestQueue",{state:Lt.idle,queue:[]}),C(this,"emittedSessionRequests",new wr({limit:500})),C(this,"requestQueueDelay",J.ONE_SECOND),C(this,"expectedPairingMethodMap",new Map),C(this,"recentlyDeletedMap",new Map),C(this,"recentlyDeletedLimit",200),C(this,"relayMessageCache",[]),C(this,"pendingSessions",new Map),C(this,"init",async()=>{this.initialized||(await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.registerPairingEvents(),await this.registerLinkModeListeners(),this.client.core.pairing.register({methods:Object.keys(xe)}),this.initialized=!0,setTimeout(async()=>{await this.processPendingMessageEvents(),this.sessionRequestQueue.queue=this.getPendingSessionRequests(),this.processSessionRequestQueue()},(0,J.toMiliseconds)(this.requestQueueDelay)))}),C(this,"connect",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();let i=Ve(ne({},t),{requiredNamespaces:t.requiredNamespaces||{},optionalNamespaces:t.optionalNamespaces||{}});await this.isValidConnect(i),i.optionalNamespaces=uh(i.requiredNamespaces,i.optionalNamespaces),i.requiredNamespaces={};let{pairingTopic:r,requiredNamespaces:n,optionalNamespaces:o,sessionProperties:a,scopedProperties:c,relays:l}=i,h=r,d,u=!1;try{if(h){let U=this.client.core.pairing.pairings.get(h);this.client.logger.warn("connect() with existing pairing topic is deprecated and will be removed in the next major release."),u=U.active}}catch(U){throw this.client.logger.error(`connect() -> pairing.get(${h}) failed`),U}if(!h||!u){let{topic:U,uri:j}=await this.client.core.pairing.create({internal:{skipSubscribe:!0}});h=U,d=j}if(!h){let{message:U}=P("NO_MATCHING_KEY",`connect() pairing topic: ${h}`);throw new Error(U)}let p=await this.client.core.crypto.generateKeyPair(),f=xe.wc_sessionPropose.req.ttl||J.FIVE_MINUTES,g=me(f),y=Ve(ne(ne({requiredNamespaces:n,optionalNamespaces:o,relays:l??[{protocol:na}],proposer:{publicKey:p,metadata:this.client.metadata},expiryTimestamp:g,pairingTopic:h},a&&{sessionProperties:a}),c&&{scopedProperties:c}),{id:qt()}),A=se("session_connect",y.id),{reject:_,resolve:R,done:B}=Xt(f,bu),D=({id:U})=>{U===y.id&&(this.client.events.off("proposal_expire",D),this.pendingSessions.delete(y.id),this.events.emit(A,{error:{message:bu,code:0}}))};return this.client.events.on("proposal_expire",D),this.events.once(A,({error:U,session:j})=>{this.client.events.off("proposal_expire",D),U?_(U):j&&R(j)}),await this.sendProposeSession({proposal:y,publishOpts:{internal:{throwOnFailedPublish:!0},tvf:{correlationId:y.id}}}),await this.setProposal(y.id,y),{uri:d,approval:B}}),C(this,"pair",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{return await this.client.core.pairing.pair(t)}catch(i){throw this.client.logger.error("pair() failed"),i}}),C(this,"approve",async t=>{var i,r,n;let o=this.client.core.eventClient.createEvent({properties:{topic:(i=t?.id)==null?void 0:i.toString(),trace:[pt.session_approve_started]}});try{this.isInitialized(),await this.confirmOnlineStateOrThrow()}catch(S){throw o.setError(bs.no_internet_connection),S}try{await this.isValidProposalId(t?.id)}catch(S){throw this.client.logger.error(`approve() -> proposal.get(${t?.id}) failed`),o.setError(bs.proposal_not_found),S}try{await this.isValidApprove(t)}catch(S){throw this.client.logger.error("approve() -> isValidApprove() failed"),o.setError(bs.session_approve_namespace_validation_failure),S}let{id:a,relayProtocol:c,namespaces:l,sessionProperties:h,scopedProperties:d,sessionConfig:u}=t,p=this.client.proposal.get(a);this.client.core.eventClient.deleteEvent({eventId:o.eventId});let{pairingTopic:f,proposer:g,requiredNamespaces:y,optionalNamespaces:A}=p,_=(r=this.client.core.eventClient)==null?void 0:r.getEvent({topic:f});_||(_=(n=this.client.core.eventClient)==null?void 0:n.createEvent({type:pt.session_approve_started,properties:{topic:f,trace:[pt.session_approve_started,pt.session_namespaces_validation_success]}}));let R=await this.client.core.crypto.generateKeyPair(),B=g.publicKey,D=await this.client.core.crypto.generateSharedKey(R,B),U=ne(ne(ne({relay:{protocol:c??"irn"},namespaces:l,controller:{publicKey:R,metadata:this.client.metadata},expiry:me(ni)},h&&{sessionProperties:h}),d&&{scopedProperties:d}),u&&{sessionConfig:u}),j=pe.relay;_.addTrace(pt.subscribing_session_topic);try{await this.client.core.relayer.subscribe(D,{transportType:j,internal:{skipSubscribe:!0}})}catch(S){throw _.setError(bs.subscribe_session_topic_failure),S}_.addTrace(pt.subscribe_session_topic_success);let M=Ve(ne({},U),{topic:D,requiredNamespaces:y,optionalNamespaces:A,pairingTopic:f,acknowledged:!1,self:U.controller,peer:{publicKey:g.publicKey,metadata:g.metadata},controller:R,transportType:pe.relay});await this.client.session.set(D,M),_.addTrace(pt.store_session);try{await this.sendApproveSession({sessionTopic:D,proposal:p,pairingProposalResponse:{relay:{protocol:c??"irn"},responderPublicKey:R},sessionSettleRequest:U,publishOpts:{internal:{throwOnFailedPublish:!0},tvf:{correlationId:a}}}),_.addTrace(pt.session_approve_publish_success)}catch(S){throw this.client.logger.error(S),this.client.session.delete(D,he("USER_DISCONNECTED")),await this.client.core.relayer.unsubscribe(D),S}return this.client.core.eventClient.deleteEvent({eventId:_.eventId}),await this.client.core.pairing.updateMetadata({topic:f,metadata:g.metadata}),await this.deleteProposal(a),await this.client.core.pairing.activate({topic:f}),await this.setExpiry(D,me(ni)),{topic:D,acknowledged:()=>Promise.resolve(this.client.session.get(D))}}),C(this,"reject",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidReject(t)}catch(o){throw this.client.logger.error("reject() -> isValidReject() failed"),o}let{id:i,reason:r}=t,n;try{n=this.client.proposal.get(i).pairingTopic}catch(o){throw this.client.logger.error(`reject() -> proposal.get(${i}) failed`),o}n&&await this.sendError({id:i,topic:n,error:r,rpcOpts:xe.wc_sessionPropose.reject}),await this.deleteProposal(i)}),C(this,"update",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidUpdate(t)}catch(d){throw this.client.logger.error("update() -> isValidUpdate() failed"),d}let{topic:i,namespaces:r}=t,{done:n,resolve:o,reject:a}=Xt(),c=qt(),l=Bt().toString(),h=this.client.session.get(i).namespaces;return this.events.once(se("session_update",c),({error:d})=>{d?a(d):o()}),await this.client.session.update(i,{namespaces:r}),await this.sendRequest({topic:i,method:"wc_sessionUpdate",params:{namespaces:r},throwOnFailedPublish:!0,clientRpcId:c,relayRpcId:l}).catch(d=>{this.client.logger.error(d),this.client.session.update(i,{namespaces:h}),a(d)}),{acknowledged:n}}),C(this,"extend",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidExtend(t)}catch(c){throw this.client.logger.error("extend() -> isValidExtend() failed"),c}let{topic:i}=t,r=qt(),{done:n,resolve:o,reject:a}=Xt();return this.events.once(se("session_extend",r),({error:c})=>{c?a(c):o()}),await this.setExpiry(i,me(ni)),this.sendRequest({topic:i,method:"wc_sessionExtend",params:{},clientRpcId:r,throwOnFailedPublish:!0}).catch(c=>{a(c)}),{acknowledged:n}}),C(this,"request",async t=>{this.isInitialized();try{await this.isValidRequest(t)}catch(y){throw this.client.logger.error("request() -> isValidRequest() failed"),y}let{chainId:i,request:r,topic:n,expiry:o=xe.wc_sessionRequest.req.ttl}=t,a=this.client.session.get(n);a?.transportType===pe.relay&&await this.confirmOnlineStateOrThrow();let c=qt(),l=Bt().toString(),{done:h,resolve:d,reject:u}=Xt(o,"Request expired. Please try again.");this.events.once(se("session_request",c),({error:y,result:A})=>{y?u(y):d(A)});let p="wc_sessionRequest",f=this.getAppLinkIfEnabled(a.peer.metadata,a.transportType);if(f)return await this.sendRequest({clientRpcId:c,relayRpcId:l,topic:n,method:p,params:{request:Ve(ne({},r),{expiryTimestamp:me(o)}),chainId:i},expiry:o,throwOnFailedPublish:!0,appLink:f}).catch(y=>u(y)),this.client.events.emit("session_request_sent",{topic:n,request:r,chainId:i,id:c}),await h();let g={request:Ve(ne({},r),{expiryTimestamp:me(o)}),chainId:i};return await Promise.all([new Promise(async y=>{await this.sendRequest({clientRpcId:c,relayRpcId:l,topic:n,method:p,params:g,expiry:o,throwOnFailedPublish:!0,tvf:this.getTVFParams(c,g)}).catch(A=>u(A)),this.client.events.emit("session_request_sent",{topic:n,request:r,chainId:i,id:c}),y()}),new Promise(async y=>{var A;if(!((A=a.sessionConfig)!=null&&A.disableDeepLink)){let _=await il(this.client.core.storage,wu);await sl({id:c,topic:n,wcDeepLink:_})}y()}),h()]).then(y=>y[2])}),C(this,"respond",async t=>{var i,r;this.isInitialized();let n=this.client.core.eventClient.createEvent({properties:{topic:t?.topic||((r=(i=t?.response)==null?void 0:i.id)==null?void 0:r.toString()),trace:[pt.session_request_response_started]}});try{await this.isValidRespond(t)}catch(d){throw n.addTrace(d?.message),n.setError(bs.session_request_response_validation_failure),d}n.addTrace(pt.session_request_response_validation_success);let{topic:o,response:a}=t,{id:c}=a,l=this.client.session.get(o);l.transportType===pe.relay&&await this.confirmOnlineStateOrThrow();let h=this.getAppLinkIfEnabled(l.peer.metadata,l.transportType);try{n.addTrace(pt.session_request_response_publish_started),yt(a)?await this.sendResult({id:c,topic:o,result:a.result,throwOnFailedPublish:!0,appLink:h}):ct(a)&&await this.sendError({id:c,topic:o,error:a.error,appLink:h}),this.cleanupAfterResponse(t)}catch(d){throw n.addTrace(d?.message),n.setError(bs.session_request_response_publish_failure),d}}),C(this,"ping",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidPing(t)}catch(r){throw this.client.logger.error("ping() -> isValidPing() failed"),r}let{topic:i}=t;if(this.client.session.keys.includes(i)){let r=qt(),n=Bt().toString(),{done:o,resolve:a,reject:c}=Xt();this.events.once(se("session_ping",r),({error:l})=>{l?c(l):a()}),await Promise.all([this.sendRequest({topic:i,method:"wc_sessionPing",params:{},throwOnFailedPublish:!0,clientRpcId:r,relayRpcId:n}),o()])}else this.client.core.pairing.pairings.keys.includes(i)&&(this.client.logger.warn("ping() on pairing topic is deprecated and will be removed in the next major release."),await this.client.core.pairing.ping({topic:i}))}),C(this,"emit",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow(),await this.isValidEmit(t);let{topic:i,event:r,chainId:n}=t,o=Bt().toString(),a=qt();await this.sendRequest({topic:i,method:"wc_sessionEvent",params:{event:r,chainId:n},throwOnFailedPublish:!0,relayRpcId:o,clientRpcId:a})}),C(this,"disconnect",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow(),await this.isValidDisconnect(t);let{topic:i}=t;if(this.client.session.keys.includes(i))await this.sendRequest({topic:i,method:"wc_sessionDelete",params:he("USER_DISCONNECTED"),throwOnFailedPublish:!0}),await this.deleteSession({topic:i,emitEvent:!1});else if(this.client.core.pairing.pairings.keys.includes(i))await this.client.core.pairing.disconnect({topic:i});else{let{message:r}=P("MISMATCHED_TOPIC",`Session or pairing topic not found: ${i}`);throw new Error(r)}}),C(this,"find",t=>(this.isInitialized(),this.client.session.getAll().filter(i=>dh(i,t)))),C(this,"getPendingSessionRequests",()=>this.client.pendingRequest.getAll()),C(this,"authenticate",async(t,i)=>{var r;this.isInitialized(),this.isValidAuthenticate(t);let n=i&&this.client.core.linkModeSupportedApps.includes(i)&&((r=this.client.metadata.redirect)==null?void 0:r.linkMode),o=n?pe.link_mode:pe.relay;o===pe.relay&&await this.confirmOnlineStateOrThrow();let{chains:a,statement:c="",uri:l,domain:h,nonce:d,type:u,exp:p,nbf:f,methods:g=[],expiry:y}=t,A=[...t.resources||[]],{topic:_,uri:R}=await this.client.core.pairing.create({methods:["wc_sessionAuthenticate"],transportType:o});this.client.logger.info({message:"Generated new pairing",pairing:{topic:_,uri:R}});let B=await this.client.core.crypto.generateKeyPair(),D=Js(B);if(await Promise.all([this.client.auth.authKeys.set($r,{responseTopic:D,publicKey:B}),this.client.auth.pairingTopics.set(D,{topic:D,pairingTopic:_})]),await this.client.core.relayer.subscribe(D,{transportType:o}),this.client.logger.info(`sending request to new pairing topic: ${_}`),g.length>0){let{namespace:v}=_t(a[0]),N=_l(v,"request",g);Oi(A)&&(N=Cl(N,A.pop())),A.push(N)}let U=y&&y>xe.wc_sessionAuthenticate.req.ttl?y:xe.wc_sessionAuthenticate.req.ttl,j={authPayload:{type:u??"caip122",chains:a,statement:c,aud:l,domain:h,version:"1",nonce:d,iat:new Date().toISOString(),exp:p,nbf:f,resources:A},requester:{publicKey:B,metadata:this.client.metadata},expiryTimestamp:me(U)},M={eip155:{chains:a,methods:[...new Set(["personal_sign",...g])],events:["chainChanged","accountsChanged"]}},S={requiredNamespaces:{},optionalNamespaces:M,relays:[{protocol:"irn"}],pairingTopic:_,proposer:{publicKey:B,metadata:this.client.metadata},expiryTimestamp:me(xe.wc_sessionPropose.req.ttl),id:qt()},{done:V,resolve:H,reject:O}=Xt(U,"Request expired"),m=qt(),w=se("session_connect",S.id),b=se("session_request",m),I=async({error:v,session:N})=>{this.events.off(b,T),v?O(v):N&&H({session:N})},T=async v=>{var N,L,F;if(await this.deletePendingAuthRequest(m,{message:"fulfilled",code:0}),v.error){let Y=he("WC_METHOD_UNSUPPORTED","wc_sessionAuthenticate");return v.error.code===Y.code?void 0:(this.events.off(w,I),O(v.error.message))}await this.deleteProposal(S.id),this.events.off(w,I);let{cacaos:Z,responder:W}=v.result,K=[],X=[];for(let Y of Z){await no({cacao:Y,projectId:this.client.core.projectId})||(this.client.logger.error(Y,"Signature verification failed"),O(he("SESSION_SETTLEMENT_FAILED","Signature verification failed")));let{p:Ee}=Y,gt=Oi(Ee.resources),Zt=[xr(Ee.iss)],Es=Ni(Ee.iss);if(gt){let qs=ao(gt),nd=co(gt);K.push(...qs),Zt.push(...nd)}for(let qs of Zt)X.push(`${qs}:${Es}`)}let G=await this.client.core.crypto.generateSharedKey(B,W.publicKey),fe;K.length>0&&(fe={topic:G,acknowledged:!0,self:{publicKey:B,metadata:this.client.metadata},peer:W,controller:W.publicKey,expiry:me(ni),requiredNamespaces:{},optionalNamespaces:{},relay:{protocol:"irn"},pairingTopic:_,namespaces:vo([...new Set(K)],[...new Set(X)]),transportType:o},await this.client.core.relayer.subscribe(G,{transportType:o}),await this.client.session.set(G,fe),_&&await this.client.core.pairing.updateMetadata({topic:_,metadata:W.metadata}),fe=this.client.session.get(G)),(N=this.client.metadata.redirect)!=null&&N.linkMode&&(L=W.metadata.redirect)!=null&&L.linkMode&&(F=W.metadata.redirect)!=null&&F.universal&&i&&(this.client.core.addLinkModeSupportedApp(W.metadata.redirect.universal),this.client.session.update(G,{transportType:pe.link_mode})),H({auths:Z,session:fe})};this.events.once(w,I),this.events.once(b,T);let x;try{if(n){let v=et("wc_sessionAuthenticate",j,m);this.client.core.history.set(_,v);let N=await this.client.core.crypto.encode("",v,{type:Xs,encoding:Jt});x=xi(i,_,N)}else await Promise.all([this.sendRequest({topic:_,method:"wc_sessionAuthenticate",params:j,expiry:t.expiry,throwOnFailedPublish:!0,clientRpcId:m}),this.sendRequest({topic:_,method:"wc_sessionPropose",params:S,expiry:xe.wc_sessionPropose.req.ttl,throwOnFailedPublish:!0,clientRpcId:S.id})])}catch(v){throw this.events.off(w,I),this.events.off(b,T),v}return await this.setProposal(S.id,S),await this.setAuthRequest(m,{request:Ve(ne({},j),{verifyContext:{}}),pairingTopic:_,transportType:o}),{uri:x??R,response:V}}),C(this,"approveSessionAuthenticate",async t=>{let{id:i,auths:r}=t,n=this.client.core.eventClient.createEvent({properties:{topic:i.toString(),trace:[vs.authenticated_session_approve_started]}});try{this.isInitialized()}catch(y){throw n.setError(ri.no_internet_connection),y}let o=this.getPendingAuthRequest(i);if(!o)throw n.setError(ri.authenticated_session_pending_request_not_found),new Error(`Could not find pending auth request with id ${i}`);let a=o.transportType||pe.relay;a===pe.relay&&await this.confirmOnlineStateOrThrow();let c=o.requester.publicKey,l=await this.client.core.crypto.generateKeyPair(),h=Js(c),d={type:At,receiverPublicKey:c,senderPublicKey:l},u=[],p=[];for(let y of r){if(!await no({cacao:y,projectId:this.client.core.projectId})){n.setError(ri.invalid_cacao);let D=he("SESSION_SETTLEMENT_FAILED","Signature verification failed");throw await this.sendError({id:i,topic:h,error:D,encodeOpts:d}),new Error(D.message)}n.addTrace(vs.cacaos_verified);let{p:A}=y,_=Oi(A.resources),R=[xr(A.iss)],B=Ni(A.iss);if(_){let D=ao(_),U=co(_);u.push(...D),R.push(...U)}for(let D of R)p.push(`${D}:${B}`)}let f=await this.client.core.crypto.generateSharedKey(l,c);n.addTrace(vs.create_authenticated_session_topic);let g;if(u?.length>0){g={topic:f,acknowledged:!0,self:{publicKey:l,metadata:this.client.metadata},peer:{publicKey:c,metadata:o.requester.metadata},controller:c,expiry:me(ni),authentication:r,requiredNamespaces:{},optionalNamespaces:{},relay:{protocol:"irn"},pairingTopic:o.pairingTopic,namespaces:vo([...new Set(u)],[...new Set(p)]),transportType:a},n.addTrace(vs.subscribing_authenticated_session_topic);try{await this.client.core.relayer.subscribe(f,{transportType:a})}catch(y){throw n.setError(ri.subscribe_authenticated_session_topic_failure),y}n.addTrace(vs.subscribe_authenticated_session_topic_success),await this.client.session.set(f,g),n.addTrace(vs.store_authenticated_session),await this.client.core.pairing.updateMetadata({topic:o.pairingTopic,metadata:o.requester.metadata})}n.addTrace(vs.publishing_authenticated_session_approve);try{await this.sendResult({topic:h,id:i,result:{cacaos:r,responder:{publicKey:l,metadata:this.client.metadata}},encodeOpts:d,throwOnFailedPublish:!0,appLink:this.getAppLinkIfEnabled(o.requester.metadata,a)})}catch(y){throw n.setError(ri.authenticated_session_approve_publish_failure),y}return await this.client.auth.requests.delete(i,{message:"fulfilled",code:0}),await this.client.core.pairing.activate({topic:o.pairingTopic}),this.client.core.eventClient.deleteEvent({eventId:n.eventId}),{session:g}}),C(this,"rejectSessionAuthenticate",async t=>{this.isInitialized();let{id:i,reason:r}=t,n=this.getPendingAuthRequest(i);if(!n)throw new Error(`Could not find pending auth request with id ${i}`);n.transportType===pe.relay&&await this.confirmOnlineStateOrThrow();let o=n.requester.publicKey,a=await this.client.core.crypto.generateKeyPair(),c=Js(o),l={type:At,receiverPublicKey:o,senderPublicKey:a};await this.sendError({id:i,topic:c,error:r,encodeOpts:l,rpcOpts:xe.wc_sessionAuthenticate.reject,appLink:this.getAppLinkIfEnabled(n.requester.metadata,n.transportType)}),await this.client.auth.requests.delete(i,{message:"rejected",code:0}),await this.deleteProposal(i)}),C(this,"formatAuthMessage",t=>{this.isInitialized();let{request:i,iss:r}=t;return oo(i,r)}),C(this,"processRelayMessageCache",()=>{setTimeout(async()=>{if(this.relayMessageCache.length!==0)for(;this.relayMessageCache.length>0;)try{let t=this.relayMessageCache.shift();t&&await this.onRelayMessage(t)}catch(t){this.client.logger.error(t)}},50)}),C(this,"cleanupDuplicatePairings",async t=>{if(t.pairingTopic)try{let i=this.client.core.pairing.pairings.get(t.pairingTopic),r=this.client.core.pairing.pairings.getAll().filter(n=>{var o,a;return((o=n.peerMetadata)==null?void 0:o.url)&&((a=n.peerMetadata)==null?void 0:a.url)===t.peer.metadata.url&&n.topic&&n.topic!==i.topic});if(r.length===0)return;this.client.logger.info(`Cleaning up ${r.length} duplicate pairing(s)`),await Promise.all(r.map(n=>this.client.core.pairing.disconnect({topic:n.topic}))),this.client.logger.info("Duplicate pairings clean up finished")}catch(i){this.client.logger.error(i)}}),C(this,"deleteSession",async t=>{var i;let{topic:r,expirerHasDeleted:n=!1,emitEvent:o=!0,id:a=0}=t,{self:c}=this.client.session.get(r);await this.client.core.relayer.unsubscribe(r),await this.client.session.delete(r,he("USER_DISCONNECTED")),this.addToRecentlyDeleted(r,"session"),this.client.core.crypto.keychain.has(c.publicKey)&&await this.client.core.crypto.deleteKeyPair(c.publicKey),this.client.core.crypto.keychain.has(r)&&await this.client.core.crypto.deleteSymKey(r),n||this.client.core.expirer.del(r),this.client.core.storage.removeItem(wu).catch(l=>this.client.logger.warn(l)),this.getPendingSessionRequests().forEach(l=>{l.topic===r&&this.deletePendingSessionRequest(l.id,he("USER_DISCONNECTED"))}),r===((i=this.sessionRequestQueue.queue[0])==null?void 0:i.topic)&&(this.sessionRequestQueue.state=Lt.idle),o&&this.client.events.emit("session_delete",{id:a,topic:r})}),C(this,"deleteProposal",async(t,i)=>{if(i)try{let r=this.client.proposal.get(t);this.client.core.eventClient.getEvent({topic:r.pairingTopic})?.setError(bs.proposal_expired)}catch{}await Promise.all([this.client.proposal.delete(t,he("USER_DISCONNECTED")),i?Promise.resolve():this.client.core.expirer.del(t)]),this.addToRecentlyDeleted(t,"proposal")}),C(this,"deletePendingSessionRequest",async(t,i,r=!1)=>{await Promise.all([this.client.pendingRequest.delete(t,i),r?Promise.resolve():this.client.core.expirer.del(t)]),this.addToRecentlyDeleted(t,"request"),this.sessionRequestQueue.queue=this.sessionRequestQueue.queue.filter(n=>n.id!==t),r&&(this.sessionRequestQueue.state=Lt.idle,this.client.events.emit("session_request_expire",{id:t}))}),C(this,"deletePendingAuthRequest",async(t,i,r=!1)=>{await Promise.all([this.client.auth.requests.delete(t,i),r?Promise.resolve():this.client.core.expirer.del(t)])}),C(this,"setExpiry",async(t,i)=>{this.client.session.keys.includes(t)&&(this.client.core.expirer.set(t,i),await this.client.session.update(t,{expiry:i}))}),C(this,"setProposal",async(t,i)=>{this.client.core.expirer.set(t,me(xe.wc_sessionPropose.req.ttl)),await this.client.proposal.set(t,i)}),C(this,"setAuthRequest",async(t,i)=>{let{request:r,pairingTopic:n,transportType:o=pe.relay}=i;this.client.core.expirer.set(t,r.expiryTimestamp),await this.client.auth.requests.set(t,{authPayload:r.authPayload,requester:r.requester,expiryTimestamp:r.expiryTimestamp,id:t,pairingTopic:n,verifyContext:r.verifyContext,transportType:o})}),C(this,"setPendingSessionRequest",async t=>{let{id:i,topic:r,params:n,verifyContext:o}=t,a=n.request.expiryTimestamp||me(xe.wc_sessionRequest.req.ttl);this.client.core.expirer.set(i,a),await this.client.pendingRequest.set(i,{id:i,topic:r,params:n,verifyContext:o})}),C(this,"sendRequest",async t=>{let{topic:i,method:r,params:n,expiry:o,relayRpcId:a,clientRpcId:c,throwOnFailedPublish:l,appLink:h,tvf:d,publishOpts:u={}}=t,p=et(r,n,c),f,g=!!h;try{let _=g?Jt:je;f=await this.client.core.crypto.encode(i,p,{encoding:_})}catch(_){throw await this.cleanup(),this.client.logger.error(`sendRequest() -> core.crypto.encode() for topic ${i} failed`),_}let y;if(Ob.includes(r)){let _=Ze(JSON.stringify(p)),R=Ze(f);y=await this.client.core.verify.register({id:R,decryptedId:_})}let A=ne(ne({},xe[r].req),u);if(A.attestation=y,o&&(A.ttl=o),a&&(A.id=a),this.client.core.history.set(i,p),g){let _=xi(h,i,f);await globalThis.Linking.openURL(_,this.client.name)}else A.tvf=Ve(ne({},d),{correlationId:p.id}),l?(A.internal=Ve(ne({},A.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(i,f,A)):this.client.core.relayer.publish(i,f,A).catch(_=>this.client.logger.error(_));return p.id}),C(this,"sendProposeSession",async t=>{let{proposal:i,publishOpts:r}=t,n=et("wc_sessionPropose",i,i.id);this.client.core.history.set(i.pairingTopic,n);let o=await this.client.core.crypto.encode(i.pairingTopic,n,{encoding:je}),a=Ze(JSON.stringify(n)),c=Ze(o),l=await this.client.core.verify.register({id:c,decryptedId:a});await this.client.core.relayer.publishCustom({payload:{pairingTopic:i.pairingTopic,sessionProposal:o},opts:Ve(ne({},r),{publishMethod:"wc_proposeSession",attestation:l})})}),C(this,"sendApproveSession",async t=>{let{sessionTopic:i,pairingProposalResponse:r,proposal:n,sessionSettleRequest:o,publishOpts:a}=t,c=es(n.id,r),l=await this.client.core.crypto.encode(n.pairingTopic,c,{encoding:je}),h=et("wc_sessionSettle",o,a?.id),d=await this.client.core.crypto.encode(i,h,{encoding:je});this.client.core.history.set(i,h),await this.client.core.relayer.publishCustom({payload:{sessionTopic:i,pairingTopic:n.pairingTopic,sessionProposalResponse:l,sessionSettlementRequest:d},opts:Ve(ne({},a),{publishMethod:"wc_approveSession"})})}),C(this,"sendResult",async t=>{let{id:i,topic:r,result:n,throwOnFailedPublish:o,encodeOpts:a,appLink:c}=t,l=es(i,n),h,d=c&&typeof globalThis?.Linking<"u";try{let f=d?Jt:je;h=await this.client.core.crypto.encode(r,l,Ve(ne({},a||{}),{encoding:f}))}catch(f){throw await this.cleanup(),this.client.logger.error(`sendResult() -> core.crypto.encode() for topic ${r} failed`),f}let u,p;try{u=await this.client.core.history.get(r,i);let f=u.request;try{p=this.getTVFParams(i,f.params,n)}catch(g){this.client.logger.warn(`sendResult() -> getTVFParams() failed: ${g?.message}`)}}catch(f){throw this.client.logger.error(`sendResult() -> history.get(${r}, ${i}) failed`),f}if(d){let f=xi(c,r,h);await globalThis.Linking.openURL(f,this.client.name)}else{let f=u.request.method,g=xe[f].res;g.tvf=Ve(ne({},p),{correlationId:i}),o?(g.internal=Ve(ne({},g.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(r,h,g)):this.client.core.relayer.publish(r,h,g).catch(y=>this.client.logger.error(y))}await this.client.core.history.resolve(l)}),C(this,"sendError",async t=>{let{id:i,topic:r,error:n,encodeOpts:o,rpcOpts:a,appLink:c}=t,l=Vi(i,n),h,d=c&&typeof globalThis?.Linking<"u";try{let p=d?Jt:je;h=await this.client.core.crypto.encode(r,l,Ve(ne({},o||{}),{encoding:p}))}catch(p){throw await this.cleanup(),this.client.logger.error(`sendError() -> core.crypto.encode() for topic ${r} failed`),p}let u;try{u=await this.client.core.history.get(r,i)}catch(p){throw this.client.logger.error(`sendError() -> history.get(${r}, ${i}) failed`),p}if(d){let p=xi(c,r,h);await globalThis.Linking.openURL(p,this.client.name)}else{let p=u.request.method,f=a||xe[p].res;this.client.core.relayer.publish(r,h,f)}await this.client.core.history.resolve(l)}),C(this,"cleanup",async()=>{let t=[],i=[];this.client.session.getAll().forEach(r=>{let n=!1;rt(r.expiry)&&(n=!0),this.client.core.crypto.keychain.has(r.topic)||(n=!0),n&&t.push(r.topic)}),this.client.proposal.getAll().forEach(r=>{rt(r.expiryTimestamp)&&i.push(r.id)}),await Promise.all([...t.map(r=>this.deleteSession({topic:r})),...i.map(r=>this.deleteProposal(r))])}),C(this,"onProviderMessageEvent",async t=>{!this.initialized||this.relayMessageCache.length>0?this.relayMessageCache.push(t):await this.onRelayMessage(t)}),C(this,"onRelayEventRequest",async t=>{this.requestQueue.queue.push(t),await this.processRequestsQueue()}),C(this,"processRequestsQueue",async()=>{if(this.requestQueue.state===Lt.active){this.client.logger.info("Request queue already active, skipping...");return}for(this.client.logger.info(`Request queue starting with ${this.requestQueue.queue.length} requests`);this.requestQueue.queue.length>0;){this.requestQueue.state=Lt.active;let t=this.requestQueue.queue.shift();if(t)try{await this.processRequest(t)}catch(i){this.client.logger.warn(i)}}this.requestQueue.state=Lt.idle}),C(this,"processRequest",async t=>{let{topic:i,payload:r,attestation:n,transportType:o,encryptedId:a}=t,c=r.method;if(!this.shouldIgnorePairingRequest({topic:i,requestMethod:c}))switch(c){case"wc_sessionPropose":return await this.onSessionProposeRequest({topic:i,payload:r,attestation:n,encryptedId:a});case"wc_sessionSettle":return await this.onSessionSettleRequest(i,r);case"wc_sessionUpdate":return await this.onSessionUpdateRequest(i,r);case"wc_sessionExtend":return await this.onSessionExtendRequest(i,r);case"wc_sessionPing":return await this.onSessionPingRequest(i,r);case"wc_sessionDelete":return await this.onSessionDeleteRequest(i,r);case"wc_sessionRequest":return await this.onSessionRequest({topic:i,payload:r,attestation:n,encryptedId:a,transportType:o});case"wc_sessionEvent":return await this.onSessionEventRequest(i,r);case"wc_sessionAuthenticate":return await this.onSessionAuthenticateRequest({topic:i,payload:r,attestation:n,encryptedId:a,transportType:o});default:return this.client.logger.info(`Unsupported request method ${c}`)}}),C(this,"onRelayEventResponse",async t=>{let{topic:i,payload:r,transportType:n}=t,o=(await this.client.core.history.get(i,r.id)).request.method;switch(o){case"wc_sessionPropose":return this.onSessionProposeResponse(i,r,n);case"wc_sessionSettle":return this.onSessionSettleResponse(i,r);case"wc_sessionUpdate":return this.onSessionUpdateResponse(i,r);case"wc_sessionExtend":return this.onSessionExtendResponse(i,r);case"wc_sessionPing":return this.onSessionPingResponse(i,r);case"wc_sessionRequest":return this.onSessionRequestResponse(i,r);case"wc_sessionAuthenticate":return this.onSessionAuthenticateResponse(i,r);default:return this.client.logger.info(`Unsupported response method ${o}`)}}),C(this,"onRelayEventUnknownPayload",t=>{let{topic:i}=t,{message:r}=P("MISSING_OR_INVALID",`Decoded payload on topic ${i} is not identifiable as a JSON-RPC request or a response.`);throw new Error(r)}),C(this,"shouldIgnorePairingRequest",t=>{let{topic:i,requestMethod:r}=t,n=this.expectedPairingMethodMap.get(i);return!n||n.includes(r)?!1:!!(n.includes("wc_sessionAuthenticate")&&this.client.events.listenerCount("session_authenticate")>0)}),C(this,"onSessionProposeRequest",async t=>{let{topic:i,payload:r,attestation:n,encryptedId:o}=t,{params:a,id:c}=r;try{let l=this.client.core.eventClient.getEvent({topic:i});this.client.events.listenerCount("session_proposal")===0&&(console.warn("No listener for session_proposal event"),l?.setError(kt.proposal_listener_not_found)),this.isValidConnect(ne({},r.params));let h=a.expiryTimestamp||me(xe.wc_sessionPropose.req.ttl),d=ne({id:c,pairingTopic:i,expiryTimestamp:h,attestation:n,encryptedId:o},a);await this.setProposal(c,d);let u=await this.getVerifyContext({attestationId:n,hash:Ze(JSON.stringify(r)),encryptedId:o,metadata:d.proposer.metadata});l?.addTrace(Ot.emit_session_proposal),this.client.events.emit("session_proposal",{id:c,params:d,verifyContext:u})}catch(l){await this.sendError({id:c,topic:i,error:l,rpcOpts:xe.wc_sessionPropose.autoReject}),this.client.logger.error(l)}}),C(this,"onSessionProposeResponse",async(t,i,r)=>{let{id:n}=i;if(yt(i)){let{result:o}=i;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",result:o});let a=this.client.proposal.get(n);this.client.logger.trace({type:"method",method:"onSessionProposeResponse",proposal:a});let c=a.proposer.publicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",selfPublicKey:c});let l=o.responderPublicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",peerPublicKey:l});let h=await this.client.core.crypto.generateSharedKey(c,l);this.pendingSessions.set(n,{sessionTopic:h,pairingTopic:t,proposalId:n,publicKey:c});let d=await this.client.core.relayer.subscribe(h,{transportType:r});this.client.logger.trace({type:"method",method:"onSessionProposeResponse",subscriptionId:d}),await this.client.core.pairing.activate({topic:t})}else if(ct(i)){await this.deleteProposal(n);let o=se("session_connect",n);if(this.events.listenerCount(o)===0)throw new Error(`emitting ${o} without any listeners, 954`);this.events.emit(o,{error:i.error})}}),C(this,"onSessionSettleRequest",async(t,i)=>{let{id:r,params:n}=i;try{this.isValidSessionSettleRequest(n);let{relay:o,controller:a,expiry:c,namespaces:l,sessionProperties:h,scopedProperties:d,sessionConfig:u}=i.params,p=[...this.pendingSessions.values()].find(y=>y.sessionTopic===t);if(!p)return this.client.logger.error(`Pending session not found for topic ${t}`);let f=this.client.proposal.get(p.proposalId),g=Ve(ne(ne(ne({topic:t,relay:o,expiry:c,namespaces:l,acknowledged:!0,pairingTopic:p.pairingTopic,requiredNamespaces:f.requiredNamespaces,optionalNamespaces:f.optionalNamespaces,controller:a.publicKey,self:{publicKey:p.publicKey,metadata:this.client.metadata},peer:{publicKey:a.publicKey,metadata:a.metadata}},h&&{sessionProperties:h}),d&&{scopedProperties:d}),u&&{sessionConfig:u}),{transportType:pe.relay});await this.client.session.set(g.topic,g),await this.setExpiry(g.topic,g.expiry),await this.client.core.pairing.updateMetadata({topic:p.pairingTopic,metadata:g.peer.metadata}),this.client.events.emit("session_connect",{session:g}),this.events.emit(se("session_connect",p.proposalId),{session:g}),this.pendingSessions.delete(p.proposalId),this.deleteProposal(p.proposalId,!1),this.cleanupDuplicatePairings(g),await this.sendResult({id:i.id,topic:t,result:!0})}catch(o){await this.sendError({id:r,topic:t,error:o}),this.client.logger.error(o)}}),C(this,"onSessionSettleResponse",async(t,i)=>{let{id:r}=i;yt(i)?(await this.client.session.update(t,{acknowledged:!0}),this.events.emit(se("session_approve",r),{})):ct(i)&&(await this.client.session.delete(t,he("USER_DISCONNECTED")),this.events.emit(se("session_approve",r),{error:i.error}))}),C(this,"onSessionUpdateRequest",async(t,i)=>{let{params:r,id:n}=i;try{let o=`${t}_session_update`,a=ys.get(o);if(a&&this.isRequestOutOfSync(a,n)){this.client.logger.warn(`Discarding out of sync request - ${n}`),this.sendError({id:n,topic:t,error:he("INVALID_UPDATE_REQUEST")});return}this.isValidUpdate(ne({topic:t},r));try{ys.set(o,n),await this.client.session.update(t,{namespaces:r.namespaces}),await this.sendResult({id:n,topic:t,result:!0})}catch(c){throw ys.delete(o),c}this.client.events.emit("session_update",{id:n,topic:t,params:r})}catch(o){await this.sendError({id:n,topic:t,error:o}),this.client.logger.error(o)}}),C(this,"isRequestOutOfSync",(t,i)=>i.toString().slice(0,-3)<t.toString().slice(0,-3)),C(this,"onSessionUpdateResponse",(t,i)=>{let{id:r}=i,n=se("session_update",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);yt(i)?this.events.emit(se("session_update",r),{}):ct(i)&&this.events.emit(se("session_update",r),{error:i.error})}),C(this,"onSessionExtendRequest",async(t,i)=>{let{id:r}=i;try{this.isValidExtend({topic:t}),await this.setExpiry(t,me(ni)),await this.sendResult({id:r,topic:t,result:!0}),this.client.events.emit("session_extend",{id:r,topic:t})}catch(n){await this.sendError({id:r,topic:t,error:n}),this.client.logger.error(n)}}),C(this,"onSessionExtendResponse",(t,i)=>{let{id:r}=i,n=se("session_extend",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);yt(i)?this.events.emit(se("session_extend",r),{}):ct(i)&&this.events.emit(se("session_extend",r),{error:i.error})}),C(this,"onSessionPingRequest",async(t,i)=>{let{id:r}=i;try{this.isValidPing({topic:t}),await this.sendResult({id:r,topic:t,result:!0,throwOnFailedPublish:!0}),this.client.events.emit("session_ping",{id:r,topic:t})}catch(n){await this.sendError({id:r,topic:t,error:n}),this.client.logger.error(n)}}),C(this,"onSessionPingResponse",(t,i)=>{let{id:r}=i,n=se("session_ping",r);setTimeout(()=>{if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners 2176`);yt(i)?this.events.emit(se("session_ping",r),{}):ct(i)&&this.events.emit(se("session_ping",r),{error:i.error})},500)}),C(this,"onSessionDeleteRequest",async(t,i)=>{let{id:r}=i;try{this.isValidDisconnect({topic:t,reason:i.params}),await Promise.all([new Promise(n=>{this.client.core.relayer.once(ve.publish,async()=>{n(await this.deleteSession({topic:t,id:r}))})}),this.sendResult({id:r,topic:t,result:!0}),this.cleanupPendingSentRequestsForTopic({topic:t,error:he("USER_DISCONNECTED")})]).catch(n=>this.client.logger.error(n))}catch(n){this.client.logger.error(n)}}),C(this,"onSessionRequest",async t=>{var i,r,n;let{topic:o,payload:a,attestation:c,encryptedId:l,transportType:h}=t,{id:d,params:u}=a;try{await this.isValidRequest(ne({topic:o},u));let p=this.client.session.get(o),f=await this.getVerifyContext({attestationId:c,hash:Ze(JSON.stringify(et("wc_sessionRequest",u,d))),encryptedId:l,metadata:p.peer.metadata,transportType:h}),g={id:d,topic:o,params:u,verifyContext:f};await this.setPendingSessionRequest(g),h===pe.link_mode&&(i=p.peer.metadata.redirect)!=null&&i.universal&&this.client.core.addLinkModeSupportedApp((r=p.peer.metadata.redirect)==null?void 0:r.universal),(n=this.client.signConfig)!=null&&n.disableRequestQueue?this.emitSessionRequest(g):(this.addSessionRequestToSessionRequestQueue(g),this.processSessionRequestQueue())}catch(p){await this.sendError({id:d,topic:o,error:p}),this.client.logger.error(p)}}),C(this,"onSessionRequestResponse",(t,i)=>{let{id:r}=i,n=se("session_request",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);yt(i)?this.events.emit(se("session_request",r),{result:i.result}):ct(i)&&this.events.emit(se("session_request",r),{error:i.error})}),C(this,"onSessionEventRequest",async(t,i)=>{let{id:r,params:n}=i;try{let o=`${t}_session_event_${n.event.name}`,a=ys.get(o);if(a&&this.isRequestOutOfSync(a,r)){this.client.logger.info(`Discarding out of sync request - ${r}`);return}this.isValidEmit(ne({topic:t},n)),this.client.events.emit("session_event",{id:r,topic:t,params:n}),ys.set(o,r)}catch(o){await this.sendError({id:r,topic:t,error:o}),this.client.logger.error(o)}}),C(this,"onSessionAuthenticateResponse",(t,i)=>{let{id:r}=i;this.client.logger.trace({type:"method",method:"onSessionAuthenticateResponse",topic:t,payload:i}),yt(i)?this.events.emit(se("session_request",r),{result:i.result}):ct(i)&&this.events.emit(se("session_request",r),{error:i.error})}),C(this,"onSessionAuthenticateRequest",async t=>{var i;let{topic:r,payload:n,attestation:o,encryptedId:a,transportType:c}=t;try{let{requester:l,authPayload:h,expiryTimestamp:d}=n.params,u=await this.getVerifyContext({attestationId:o,hash:Ze(JSON.stringify(n)),encryptedId:a,metadata:l.metadata,transportType:c}),p={requester:l,pairingTopic:r,id:n.id,authPayload:h,verifyContext:u,expiryTimestamp:d};await this.setAuthRequest(n.id,{request:p,pairingTopic:r,transportType:c}),c===pe.link_mode&&(i=l.metadata.redirect)!=null&&i.universal&&this.client.core.addLinkModeSupportedApp(l.metadata.redirect.universal),this.client.events.emit("session_authenticate",{topic:r,params:n.params,id:n.id,verifyContext:u})}catch(l){this.client.logger.error(l);let h=n.params.requester.publicKey,d=await this.client.core.crypto.generateKeyPair(),u=this.getAppLinkIfEnabled(n.params.requester.metadata,c),p={type:At,receiverPublicKey:h,senderPublicKey:d};await this.sendError({id:n.id,topic:r,error:l,encodeOpts:p,rpcOpts:xe.wc_sessionAuthenticate.autoReject,appLink:u})}}),C(this,"addSessionRequestToSessionRequestQueue",t=>{this.sessionRequestQueue.queue.push(t)}),C(this,"cleanupAfterResponse",t=>{this.deletePendingSessionRequest(t.response.id,{message:"fulfilled",code:0}),setTimeout(()=>{this.sessionRequestQueue.state=Lt.idle,this.processSessionRequestQueue()},(0,J.toMiliseconds)(this.requestQueueDelay))}),C(this,"cleanupPendingSentRequestsForTopic",({topic:t,error:i})=>{let r=this.client.core.history.pending;r.length>0&&r.filter(n=>n.topic===t&&n.request.method==="wc_sessionRequest").forEach(n=>{let o=n.request.id,a=se("session_request",o);if(this.events.listenerCount(a)===0)throw new Error(`emitting ${a} without any listeners`);this.events.emit(se("session_request",n.request.id),{error:i})})}),C(this,"processSessionRequestQueue",()=>{if(this.sessionRequestQueue.state===Lt.active){this.client.logger.info("session request queue is already active.");return}let t=this.sessionRequestQueue.queue[0];if(!t){this.client.logger.info("session request queue is empty.");return}try{this.emitSessionRequest(t)}catch(i){this.client.logger.error(i)}}),C(this,"emitSessionRequest",t=>{if(this.emittedSessionRequests.has(t.id)){this.client.logger.warn({id:t.id},`Skipping emitting \`session_request\` event for duplicate request. id: ${t.id}`);return}this.sessionRequestQueue.state=Lt.active,this.emittedSessionRequests.add(t.id),this.client.events.emit("session_request",t)}),C(this,"onPairingCreated",t=>{if(t.methods&&this.expectedPairingMethodMap.set(t.topic,t.methods),t.active)return;let i=this.client.proposal.getAll().find(r=>r.pairingTopic===t.topic);i&&this.onSessionProposeRequest({topic:t.topic,payload:et("wc_sessionPropose",Ve(ne({},i),{requiredNamespaces:i.requiredNamespaces,optionalNamespaces:i.optionalNamespaces,relays:i.relays,proposer:i.proposer,sessionProperties:i.sessionProperties,scopedProperties:i.scopedProperties}),i.id),attestation:i.attestation,encryptedId:i.encryptedId})}),C(this,"isValidConnect",async t=>{if(!Me(t)){let{message:l}=P("MISSING_OR_INVALID",`connect() params: ${JSON.stringify(t)}`);throw new Error(l)}let{pairingTopic:i,requiredNamespaces:r,optionalNamespaces:n,sessionProperties:o,scopedProperties:a,relays:c}=t;if(Ce(i)||await this.isValidPairingTopic(i),!bh(c,!0)){let{message:l}=P("MISSING_OR_INVALID",`connect() relays: ${c}`);throw new Error(l)}if(r&&!Ce(r)&&ht(r)!==0){let l="requiredNamespaces are deprecated and are automatically assigned to optionalNamespaces";["fatal","error","silent"].includes(this.client.logger.level)?console.warn(l):this.client.logger.warn(l),this.validateNamespaces(r,"requiredNamespaces")}if(n&&!Ce(n)&&ht(n)!==0&&this.validateNamespaces(n,"optionalNamespaces"),o&&!Ce(o)&&this.validateSessionProps(o,"sessionProperties"),a&&!Ce(a)){this.validateSessionProps(a,"scopedProperties");let l=Object.keys(r||{}).concat(Object.keys(n||{}));if(!Object.keys(a).every(h=>l.includes(h.split(":")[0])))throw new Error(`Scoped properties must be a subset of required/optional namespaces, received: ${JSON.stringify(a)}, required/optional namespaces: ${JSON.stringify(l)}`)}}),C(this,"validateNamespaces",(t,i)=>{let r=wh(t,"connect()",i);if(r)throw new Error(r.message)}),C(this,"isValidApprove",async t=>{if(!Me(t))throw new Error(P("MISSING_OR_INVALID",`approve() params: ${t}`).message);let{id:i,namespaces:r,relayProtocol:n,sessionProperties:o,scopedProperties:a}=t;this.checkRecentlyDeleted(i),await this.isValidProposalId(i);let c=this.client.proposal.get(i),l=qr(r,"approve()");if(l)throw new Error(l.message);let h=Co(c.requiredNamespaces,r,"approve()");if(h)throw new Error(h.message);if(!be(n,!0)){let{message:d}=P("MISSING_OR_INVALID",`approve() relayProtocol: ${n}`);throw new Error(d)}if(o&&!Ce(o)&&this.validateSessionProps(o,"sessionProperties"),a&&!Ce(a)){this.validateSessionProps(a,"scopedProperties");let d=new Set(Object.keys(r));if(!Object.keys(a).every(u=>d.has(u.split(":")[0])))throw new Error(`Scoped properties must be a subset of approved namespaces, received: ${JSON.stringify(a)}, approved namespaces: ${Array.from(d).join(", ")}`)}}),C(this,"isValidReject",async t=>{if(!Me(t)){let{message:n}=P("MISSING_OR_INVALID",`reject() params: ${t}`);throw new Error(n)}let{id:i,reason:r}=t;if(this.checkRecentlyDeleted(i),await this.isValidProposalId(i),!Eh(r)){let{message:n}=P("MISSING_OR_INVALID",`reject() reason: ${JSON.stringify(r)}`);throw new Error(n)}}),C(this,"isValidSessionSettleRequest",t=>{if(!Me(t)){let{message:l}=P("MISSING_OR_INVALID",`onSessionSettleRequest() params: ${t}`);throw new Error(l)}let{relay:i,controller:r,namespaces:n,expiry:o}=t;if(!Io(i)){let{message:l}=P("MISSING_OR_INVALID","onSessionSettleRequest() relay protocol should be a string");throw new Error(l)}let a=yh(r,"onSessionSettleRequest()");if(a)throw new Error(a.message);let c=qr(n,"onSessionSettleRequest()");if(c)throw new Error(c.message);if(rt(o)){let{message:l}=P("EXPIRED","onSessionSettleRequest()");throw new Error(l)}}),C(this,"isValidUpdate",async t=>{if(!Me(t)){let{message:c}=P("MISSING_OR_INVALID",`update() params: ${t}`);throw new Error(c)}let{topic:i,namespaces:r}=t;this.checkRecentlyDeleted(i),await this.isValidSessionTopic(i);let n=this.client.session.get(i),o=qr(r,"update()");if(o)throw new Error(o.message);let a=Co(n.requiredNamespaces,r,"update()");if(a)throw new Error(a.message)}),C(this,"isValidExtend",async t=>{if(!Me(t)){let{message:r}=P("MISSING_OR_INVALID",`extend() params: ${t}`);throw new Error(r)}let{topic:i}=t;this.checkRecentlyDeleted(i),await this.isValidSessionTopic(i)}),C(this,"isValidRequest",async t=>{if(!Me(t)){let{message:c}=P("MISSING_OR_INVALID",`request() params: ${t}`);throw new Error(c)}let{topic:i,request:r,chainId:n,expiry:o}=t;this.checkRecentlyDeleted(i),await this.isValidSessionTopic(i);let{namespaces:a}=this.client.session.get(i);if(!_o(a,n)){let{message:c}=P("MISSING_OR_INVALID",`request() chainId: ${n}`);throw new Error(c)}if(!Ih(r)){let{message:c}=P("MISSING_OR_INVALID",`request() ${JSON.stringify(r)}`);throw new Error(c)}if(!Ah(a,n,r.method)){let{message:c}=P("MISSING_OR_INVALID",`request() method: ${r.method}`);throw new Error(c)}if(o&&!Nh(o,aa)){let{message:c}=P("MISSING_OR_INVALID",`request() expiry: ${o}. Expiry must be a number (in seconds) between ${aa.min} and ${aa.max}`);throw new Error(c)}}),C(this,"isValidRespond",async t=>{var i;if(!Me(t)){let{message:a}=P("MISSING_OR_INVALID",`respond() params: ${t}`);throw new Error(a)}let{topic:r,response:n}=t;try{await this.isValidSessionTopic(r)}catch(a){throw(i=t?.response)!=null&&i.id&&this.cleanupAfterResponse(t),a}if(!_h(n)){let{message:a}=P("MISSING_OR_INVALID",`respond() response: ${JSON.stringify(n)}`);throw new Error(a)}let o=this.client.pendingRequest.get(n.id);if(o.topic!==r){let{message:a}=P("MISMATCHED_TOPIC",`Request response topic mismatch. reqId: ${n.id}, expected topic: ${o.topic}, received topic: ${r}`);throw new Error(a)}}),C(this,"isValidPing",async t=>{if(!Me(t)){let{message:r}=P("MISSING_OR_INVALID",`ping() params: ${t}`);throw new Error(r)}let{topic:i}=t;await this.isValidSessionOrPairingTopic(i)}),C(this,"isValidEmit",async t=>{if(!Me(t)){let{message:a}=P("MISSING_OR_INVALID",`emit() params: ${t}`);throw new Error(a)}let{topic:i,event:r,chainId:n}=t;await this.isValidSessionTopic(i);let{namespaces:o}=this.client.session.get(i);if(!_o(o,n)){let{message:a}=P("MISSING_OR_INVALID",`emit() chainId: ${n}`);throw new Error(a)}if(!Ch(r)){let{message:a}=P("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(r)}`);throw new Error(a)}if(!Sh(o,n,r.name)){let{message:a}=P("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(r)}`);throw new Error(a)}}),C(this,"isValidDisconnect",async t=>{if(!Me(t)){let{message:r}=P("MISSING_OR_INVALID",`disconnect() params: ${t}`);throw new Error(r)}let{topic:i}=t;await this.isValidSessionOrPairingTopic(i)}),C(this,"isValidAuthenticate",t=>{let{chains:i,uri:r,domain:n,nonce:o}=t;if(!Array.isArray(i)||i.length===0)throw new Error("chains is required and must be a non-empty array");if(!be(r,!1))throw new Error("uri is required parameter");if(!be(n,!1))throw new Error("domain is required parameter");if(!be(o,!1))throw new Error("nonce is required parameter");if([...new Set(i.map(c=>_t(c).namespace))].length>1)throw new Error("Multi-namespace requests are not supported. Please request single namespace only.");let{namespace:a}=_t(i[0]);if(a!=="eip155")throw new Error("Only eip155 namespace is supported for authenticated sessions. Please use .connect() for non-eip155 chains.")}),C(this,"getVerifyContext",async t=>{let{attestationId:i,hash:r,encryptedId:n,metadata:o,transportType:a}=t,c={verified:{verifyUrl:o.verifyUrl||ii,validation:"UNKNOWN",origin:o.url||""}};try{if(a===pe.link_mode){let h=this.getAppLinkIfEnabled(o,a);return c.verified.validation=h&&new URL(h).origin===new URL(o.url).origin?"VALID":"INVALID",c}let l=await this.client.core.verify.resolve({attestationId:i,hash:r,encryptedId:n,verifyUrl:o.verifyUrl});l&&(c.verified.origin=l.origin,c.verified.isScam=l.isScam,c.verified.validation=l.origin===new URL(o.url).origin?"VALID":"INVALID")}catch(l){this.client.logger.warn(l)}return this.client.logger.debug(`Verify context: ${JSON.stringify(c)}`),c}),C(this,"validateSessionProps",(t,i)=>{Object.values(t).forEach((r,n)=>{if(r==null){let{message:o}=P("MISSING_OR_INVALID",`${i} must contain an existing value for each key. Received: ${r} for key ${Object.keys(t)[n]}`);throw new Error(o)}})}),C(this,"getPendingAuthRequest",t=>{let i=this.client.auth.requests.get(t);return typeof i=="object"?i:void 0}),C(this,"addToRecentlyDeleted",(t,i)=>{if(this.recentlyDeletedMap.set(t,i),this.recentlyDeletedMap.size>=this.recentlyDeletedLimit){let r=0,n=this.recentlyDeletedLimit/2;for(let o of this.recentlyDeletedMap.keys()){if(r++>=n)break;this.recentlyDeletedMap.delete(o)}}}),C(this,"checkRecentlyDeleted",t=>{let i=this.recentlyDeletedMap.get(t);if(i){let{message:r}=P("MISSING_OR_INVALID",`Record was recently deleted - ${i}: ${t}`);throw new Error(r)}}),C(this,"isLinkModeEnabled",(t,i)=>{var r,n,o,a,c,l,h,d,u;return!t||i!==pe.link_mode?!1:((n=(r=this.client.metadata)==null?void 0:r.redirect)==null?void 0:n.linkMode)===!0&&((a=(o=this.client.metadata)==null?void 0:o.redirect)==null?void 0:a.universal)!==void 0&&((l=(c=this.client.metadata)==null?void 0:c.redirect)==null?void 0:l.universal)!==""&&((h=t?.redirect)==null?void 0:h.universal)!==void 0&&((d=t?.redirect)==null?void 0:d.universal)!==""&&((u=t?.redirect)==null?void 0:u.linkMode)===!0&&this.client.core.linkModeSupportedApps.includes(t.redirect.universal)&&typeof globalThis?.Linking<"u"}),C(this,"getAppLinkIfEnabled",(t,i)=>{var r;return this.isLinkModeEnabled(t,i)?(r=t?.redirect)==null?void 0:r.universal:void 0}),C(this,"handleLinkModeMessage",({url:t})=>{if(!t||!t.includes("wc_ev")||!t.includes("topic"))return;let i=Jn(t,"topic")||"",r=decodeURIComponent(Jn(t,"wc_ev")||""),n=this.client.session.keys.includes(i);n&&this.client.session.update(i,{transportType:pe.link_mode}),this.client.core.dispatchEnvelope({topic:i,message:r,sessionExists:n})}),C(this,"registerLinkModeListeners",async()=>{var t;if(Ai()||Yt()&&(t=this.client.metadata.redirect)!=null&&t.linkMode){let i=globalThis?.Linking;if(typeof i<"u"){i.addEventListener("url",this.handleLinkModeMessage,this.client.name);let r=await i.getInitialURL();r&&setTimeout(()=>{this.handleLinkModeMessage({url:r})},50)}}}),C(this,"getTVFParams",(t,i,r)=>{var n,o,a;if(!((n=i.request)!=null&&n.method))return{};let c={correlationId:t,rpcMethods:[i.request.method],chainId:i.chainId};try{let l=this.extractTxHashesFromResult(i.request,r);c.txHashes=l,c.contractAddresses=this.isValidContractData(i.request.params)?[(a=(o=i.request.params)==null?void 0:o[0])==null?void 0:a.to]:[]}catch(l){this.client.logger.warn(l,"Error getting TVF params")}return c}),C(this,"isValidContractData",t=>{var i;if(!t)return!1;try{let r=t?.data||((i=t?.[0])==null?void 0:i.data);if(!r.startsWith("0x"))return!1;let n=r.slice(2);return/^[0-9a-fA-F]*$/.test(n)?n.length%2===0:!1}catch{}return!1}),C(this,"extractTxHashesFromResult",(t,i)=>{var r;try{if(!i)return[];let n=t.method,o=Sb[n];if(n==="sui_signTransaction")return[bl(i.transactionBytes)];if(n==="near_signTransaction")return[so(i)];if(n==="near_signTransactions")return i.map(c=>so(c));if(n==="xrpl_signTransactionFor"||n==="xrpl_signTransaction")return[(r=i.tx_json)==null?void 0:r.hash];if(n==="polkadot_signTransaction")return[Ph({transaction:t.params.transactionPayload,signature:i.signature})];if(n==="algo_signTxn")return St(i)?i.map(c=>io(c)):[io(i)];if(n==="cosmos_signDirect")return[vl(i)];if(n==="wallet_sendCalls")return El(i);if(typeof i=="string")return[i];let a=i[o.key];if(St(a))return n==="solana_signAllTransactions"?a.map(c=>wl(c)):a;if(typeof a=="string")return[a]}catch(n){this.client.logger.warn(n,"Error extracting tx hashes from result")}return[]})}async processPendingMessageEvents(){try{let e=this.client.session.keys,t=this.client.core.relayer.messages.getWithoutAck(e);for(let[i,r]of Object.entries(t))for(let n of r)try{await this.onProviderMessageEvent({topic:i,message:n,publishedAt:Date.now()})}catch{this.client.logger.warn(`Error processing pending message event for topic: ${i}, message: ${n}`)}}catch(e){this.client.logger.warn(e,"processPendingMessageEvents failed")}}isInitialized(){if(!this.initialized){let{message:e}=P("NOT_INITIALIZED",this.name);throw new Error(e)}}async confirmOnlineStateOrThrow(){await this.client.core.relayer.confirmOnlineStateOrThrow()}registerRelayerEvents(){this.client.core.relayer.on(ve.message,e=>{this.onProviderMessageEvent(e)})}async onRelayMessage(e){let{topic:t,message:i,attestation:r,transportType:n}=e,{publicKey:o}=this.client.auth.authKeys.keys.includes($r)?this.client.auth.authKeys.get($r):{responseTopic:void 0,publicKey:void 0};try{let a=await this.client.core.crypto.decode(t,i,{receiverPublicKey:o,encoding:n===pe.link_mode?Jt:je});di(a)?(this.client.core.history.set(t,a),await this.onRelayEventRequest({topic:t,payload:a,attestation:r,transportType:n,encryptedId:Ze(i)})):pi(a)?(await this.client.core.history.resolve(a),await this.onRelayEventResponse({topic:t,payload:a,transportType:n}),this.client.core.history.delete(t,a.id)):await this.onRelayEventUnknownPayload({topic:t,payload:a,transportType:n}),await this.client.core.relayer.messages.ack(t,i)}catch(a){this.client.logger.error(a)}}registerExpirerEvents(){this.client.core.expirer.on(at.expired,async e=>{let{topic:t,id:i}=Or(e.target);if(i&&this.client.pendingRequest.keys.includes(i))return await this.deletePendingSessionRequest(i,P("EXPIRED"),!0);if(i&&this.client.auth.requests.keys.includes(i))return await this.deletePendingAuthRequest(i,P("EXPIRED"),!0);t?this.client.session.keys.includes(t)&&(await this.deleteSession({topic:t,expirerHasDeleted:!0}),this.client.events.emit("session_expire",{topic:t})):i&&(await this.deleteProposal(i,!0),this.client.events.emit("proposal_expire",{id:i}))})}registerPairingEvents(){this.client.core.pairing.events.on(ws.create,e=>this.onPairingCreated(e)),this.client.core.pairing.events.on(ws.delete,e=>{this.addToRecentlyDeleted(e.topic,"pairing")})}isValidPairingTopic(e){if(!be(e,!1)){let{message:t}=P("MISSING_OR_INVALID",`pairing topic should be a string: ${e}`);throw new Error(t)}if(!this.client.core.pairing.pairings.keys.includes(e)){let{message:t}=P("NO_MATCHING_KEY",`pairing topic doesn't exist: ${e}`);throw new Error(t)}if(rt(this.client.core.pairing.pairings.get(e).expiry)){let{message:t}=P("EXPIRED",`pairing topic: ${e}`);throw new Error(t)}}async isValidSessionTopic(e){if(!be(e,!1)){let{message:t}=P("MISSING_OR_INVALID",`session topic should be a string: ${e}`);throw new Error(t)}if(this.checkRecentlyDeleted(e),!this.client.session.keys.includes(e)){let{message:t}=P("NO_MATCHING_KEY",`session topic doesn't exist: ${e}`);throw new Error(t)}if(rt(this.client.session.get(e).expiry)){await this.deleteSession({topic:e});let{message:t}=P("EXPIRED",`session topic: ${e}`);throw new Error(t)}if(!this.client.core.crypto.keychain.has(e)){let{message:t}=P("MISSING_OR_INVALID",`session topic does not exist in keychain: ${e}`);throw await this.deleteSession({topic:e}),new Error(t)}}async isValidSessionOrPairingTopic(e){if(this.checkRecentlyDeleted(e),this.client.session.keys.includes(e))await this.isValidSessionTopic(e);else if(this.client.core.pairing.pairings.keys.includes(e))this.isValidPairingTopic(e);else if(be(e,!1)){let{message:t}=P("NO_MATCHING_KEY",`session or pairing topic doesn't exist: ${e}`);throw new Error(t)}else{let{message:t}=P("MISSING_OR_INVALID",`session or pairing topic should be a string: ${e}`);throw new Error(t)}}async isValidProposalId(e){if(!vh(e)){let{message:t}=P("MISSING_OR_INVALID",`proposal id should be a number: ${e}`);throw new Error(t)}if(!this.client.proposal.keys.includes(e)){let{message:t}=P("NO_MATCHING_KEY",`proposal id doesn't exist: ${e}`);throw new Error(t)}if(rt(this.client.proposal.get(e).expiryTimestamp)){await this.deleteProposal(e);let{message:t}=P("EXPIRED",`proposal id: ${e}`);throw new Error(t)}}},ua=class extends Ft{constructor(e,t){super(e,t,_b,ba),this.core=e,this.logger=t}},da=class extends Ft{constructor(e,t){super(e,t,Cb,ba),this.core=e,this.logger=t}},pa=class extends Ft{constructor(e,t){super(e,t,Nb,ba,i=>i.id),this.core=e,this.logger=t}},fa=class extends Ft{constructor(e,t){super(e,t,Rb,Vr,()=>$r),this.core=e,this.logger=t}},ga=class extends Ft{constructor(e,t){super(e,t,xb,Vr),this.core=e,this.logger=t}},ya=class extends Ft{constructor(e,t){super(e,t,kb,Vr,i=>i.id),this.core=e,this.logger=t}},Bb=Object.defineProperty,jb=(s,e,t)=>e in s?Bb(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ca=(s,e,t)=>jb(s,typeof e!="symbol"?e+"":e,t),ma=class{constructor(e,t){this.core=e,this.logger=t,ca(this,"authKeys"),ca(this,"pairingTopics"),ca(this,"requests"),this.authKeys=new fa(this.core,this.logger),this.pairingTopics=new ga(this.core,this.logger),this.requests=new ya(this.core,this.logger)}async init(){await this.authKeys.init(),await this.pairingTopics.init(),await this.requests.init()}},Mb=Object.defineProperty,$b=(s,e,t)=>e in s?Mb(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ee=(s,e,t)=>$b(s,typeof e!="symbol"?e+"":e,t),wa=class s extends ur{constructor(e){super(e),ee(this,"protocol",Eu),ee(this,"version",Iu),ee(this,"name",oa.name),ee(this,"metadata"),ee(this,"core"),ee(this,"logger"),ee(this,"events",new Tt),ee(this,"engine"),ee(this,"session"),ee(this,"proposal"),ee(this,"pendingRequest"),ee(this,"auth"),ee(this,"signConfig"),ee(this,"on",(i,r)=>this.events.on(i,r)),ee(this,"once",(i,r)=>this.events.once(i,r)),ee(this,"off",(i,r)=>this.events.off(i,r)),ee(this,"removeListener",(i,r)=>this.events.removeListener(i,r)),ee(this,"removeAllListeners",i=>this.events.removeAllListeners(i)),ee(this,"connect",async i=>{try{return await this.engine.connect(i)}catch(r){throw this.logger.error(r.message),r}}),ee(this,"pair",async i=>{try{return await this.engine.pair(i)}catch(r){throw this.logger.error(r.message),r}}),ee(this,"approve",async i=>{try{return await this.engine.approve(i)}catch(r){throw this.logger.error(r.message),r}}),ee(this,"reject",async i=>{try{return await this.engine.reject(i)}catch(r){throw this.logger.error(r.message),r}}),ee(this,"update",async i=>{try{return await this.engine.update(i)}catch(r){throw this.logger.error(r.message),r}}),ee(this,"extend",async i=>{try{return await this.engine.extend(i)}catch(r){throw this.logger.error(r.message),r}}),ee(this,"request",async i=>{try{return await this.engine.request(i)}catch(r){throw this.logger.error(r.message),r}}),ee(this,"respond",async i=>{try{return await this.engine.respond(i)}catch(r){throw this.logger.error(r.message),r}}),ee(this,"ping",async i=>{try{return await this.engine.ping(i)}catch(r){throw this.logger.error(r.message),r}}),ee(this,"emit",async i=>{try{return await this.engine.emit(i)}catch(r){throw this.logger.error(r.message),r}}),ee(this,"disconnect",async i=>{try{return await this.engine.disconnect(i)}catch(r){throw this.logger.error(r.message),r}}),ee(this,"find",i=>{try{return this.engine.find(i)}catch(r){throw this.logger.error(r.message),r}}),ee(this,"getPendingSessionRequests",()=>{try{return this.engine.getPendingSessionRequests()}catch(i){throw this.logger.error(i.message),i}}),ee(this,"authenticate",async(i,r)=>{try{return await this.engine.authenticate(i,r)}catch(n){throw this.logger.error(n.message),n}}),ee(this,"formatAuthMessage",i=>{try{return this.engine.formatAuthMessage(i)}catch(r){throw this.logger.error(r.message),r}}),ee(this,"approveSessionAuthenticate",async i=>{try{return await this.engine.approveSessionAuthenticate(i)}catch(r){throw this.logger.error(r.message),r}}),ee(this,"rejectSessionAuthenticate",async i=>{try{return await this.engine.rejectSessionAuthenticate(i)}catch(r){throw this.logger.error(r.message),r}}),this.name=e?.name||oa.name,this.metadata=Jc(e?.metadata),this.signConfig=e?.signConfig;let t=ei({logger:e?.logger||oa.logger,name:this.name});this.logger=t,this.core=e?.core||new mu(e),this.session=new da(this.core,this.logger),this.proposal=new ua(this.core,this.logger),this.pendingRequest=new pa(this.core,this.logger),this.engine=new ha(this),this.auth=new ma(this.core,this.logger)}static async init(e){let t=new s(e);return await t.initialize(),t}get context(){return Ue(this.logger)}get pairing(){return this.core.pairing.pairings}async initialize(){this.logger.trace("Initialized");try{await this.core.start(),await this.session.init(),await this.proposal.init(),await this.pendingRequest.init(),await this.auth.init(),await this.engine.init(),this.logger.info("SignClient Initialization Success")}catch(e){throw this.logger.info("SignClient Initialization Failure"),this.logger.error(e.message),e}}};var Cu=wa;$i();function xa(s){return s==null||typeof s!="object"&&typeof s!="function"}function Ku(s){return Object.getOwnPropertySymbols(s).filter(e=>Object.prototype.propertyIsEnumerable.call(s,e))}function zu(s){return s==null?s===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(s)}var Vb="[object RegExp]",Hu="[object String]",Wu="[object Number]",Gu="[object Boolean]",Yu="[object Arguments]",Kb="[object Symbol]",zb="[object Date]",Hb="[object Map]",Wb="[object Set]",Gb="[object Array]",Yb="[object ArrayBuffer]",Xb="[object Object]",Jb="[object DataView]",Zb="[object Uint8Array]",Qb="[object Uint8ClampedArray]",ev="[object Uint16Array]",tv="[object Uint32Array]",sv="[object Int8Array]",iv="[object Int16Array]",rv="[object Int32Array]",nv="[object Float32Array]",ov="[object Float64Array]";function ka(s){return ArrayBuffer.isView(s)&&!(s instanceof DataView)}function av(s,e){return ai(s,void 0,s,new Map,e)}function ai(s,e,t,i=new Map,r=void 0){let n=r?.(s,e,t,i);if(n!=null)return n;if(xa(s))return s;if(i.has(s))return i.get(s);if(Array.isArray(s)){let o=new Array(s.length);i.set(s,o);for(let a=0;a<s.length;a++)o[a]=ai(s[a],a,t,i,r);return Object.hasOwn(s,"index")&&(o.index=s.index),Object.hasOwn(s,"input")&&(o.input=s.input),o}if(s instanceof Date)return new Date(s.getTime());if(s instanceof RegExp){let o=new RegExp(s.source,s.flags);return o.lastIndex=s.lastIndex,o}if(s instanceof Map){let o=new Map;i.set(s,o);for(let[a,c]of s)o.set(a,ai(c,a,t,i,r));return o}if(s instanceof Set){let o=new Set;i.set(s,o);for(let a of s)o.add(ai(a,void 0,t,i,r));return o}if(typeof z<"u"&&z.isBuffer(s))return s.subarray();if(ka(s)){let o=new(Object.getPrototypeOf(s)).constructor(s.length);i.set(s,o);for(let a=0;a<s.length;a++)o[a]=ai(s[a],a,t,i,r);return o}if(s instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&s instanceof SharedArrayBuffer)return s.slice(0);if(s instanceof DataView){let o=new DataView(s.buffer.slice(0),s.byteOffset,s.byteLength);return i.set(s,o),Ds(o,s,t,i,r),o}if(typeof File<"u"&&s instanceof File){let o=new File([s],s.name,{type:s.type});return i.set(s,o),Ds(o,s,t,i,r),o}if(s instanceof Blob){let o=new Blob([s],{type:s.type});return i.set(s,o),Ds(o,s,t,i,r),o}if(s instanceof Error){let o=new s.constructor;return i.set(s,o),o.message=s.message,o.name=s.name,o.stack=s.stack,o.cause=s.cause,Ds(o,s,t,i,r),o}if(typeof s=="object"&&cv(s)){let o=Object.create(Object.getPrototypeOf(s));return i.set(s,o),Ds(o,s,t,i,r),o}return s}function Ds(s,e,t=s,i,r){let n=[...Object.keys(e),...Ku(e)];for(let o=0;o<n.length;o++){let a=n[o],c=Object.getOwnPropertyDescriptor(s,a);(c==null||c.writable)&&(s[a]=ai(e[a],a,t,i,r))}}function cv(s){switch(zu(s)){case Yu:case Gb:case Yb:case Jb:case Gu:case zb:case nv:case ov:case sv:case iv:case rv:case Hb:case Wu:case Xb:case Vb:case Wb:case Hu:case Kb:case Zb:case Qb:case ev:case tv:return!0;default:return!1}}function lv(s,e){return av(s,(t,i,r,n)=>{let o=e?.(t,i,r,n);if(o!=null)return o;if(typeof s=="object")switch(Object.prototype.toString.call(s)){case Wu:case Hu:case Gu:{let a=new s.constructor(s?.valueOf());return Ds(a,s),a}case Yu:{let a={};return Ds(a,s),a.length=s.length,a[Symbol.iterator]=s[Symbol.iterator],a}default:return}})}function Au(s){return lv(s)}function Su(s){return s!==null&&typeof s=="object"&&zu(s)==="[object Arguments]"}function Nu(s){return typeof s=="object"&&s!==null}function hv(){}function uv(s){return ka(s)}function dv(s){if(typeof s!="object"||s==null)return!1;if(Object.getPrototypeOf(s)===null)return!0;if(Object.prototype.toString.call(s)!=="[object Object]"){let t=s[Symbol.toStringTag];return t==null||!Object.getOwnPropertyDescriptor(s,Symbol.toStringTag)?.writable?!1:s.toString()===`[object ${t}]`}let e=s;for(;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(s)===e}function pv(s){if(xa(s))return s;if(Array.isArray(s)||ka(s)||s instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&s instanceof SharedArrayBuffer)return s.slice(0);let e=Object.getPrototypeOf(s),t=e.constructor;if(s instanceof Date||s instanceof Map||s instanceof Set)return new t(s);if(s instanceof RegExp){let i=new t(s);return i.lastIndex=s.lastIndex,i}if(s instanceof DataView)return new t(s.buffer.slice(0));if(s instanceof Error){let i=new t(s.message);return i.stack=s.stack,i.name=s.name,i.cause=s.cause,i}if(typeof File<"u"&&s instanceof File)return new t([s],s.name,{type:s.type,lastModified:s.lastModified});if(typeof s=="object"){let i=Object.create(e);return Object.assign(i,s)}return s}function fv(s,...e){let t=e.slice(0,-1),i=e[e.length-1],r=s;for(let n=0;n<t.length;n++){let o=t[n];r=Sa(r,o,i,new Map)}return r}function Sa(s,e,t,i){if(xa(s)&&(s=Object(s)),e==null||typeof e!="object")return s;if(i.has(e))return pv(i.get(e));if(i.set(e,s),Array.isArray(e)){e=e.slice();for(let n=0;n<e.length;n++)e[n]=e[n]??void 0}let r=[...Object.keys(e),...Ku(e)];for(let n=0;n<r.length;n++){let o=r[n],a=e[o],c=s[o];if(Su(a)&&(a={...a}),Su(c)&&(c={...c}),typeof z<"u"&&z.isBuffer(a)&&(a=Au(a)),Array.isArray(a))if(typeof c=="object"&&c!=null){let h=[],d=Reflect.ownKeys(c);for(let u=0;u<d.length;u++){let p=d[u];h[p]=c[p]}c=h}else c=[];let l=t(c,a,o,s,e,i);l!=null?s[o]=l:Array.isArray(a)||Nu(c)&&Nu(a)?s[o]=Sa(c,a,t,i):c==null&&dv(a)?s[o]=Sa({},a,t,i):c==null&&uv(a)?s[o]=Au(a):(c===void 0||a!==void 0)&&(s[o]=a)}return s}function gv(s,...e){return fv(s,...e,hv)}var Ou="error",yv="wss://relay.walletconnect.org",mv="wc",Xu="universal_provider",Kr=`${mv}@2:${Xu}:`,Ju="https://rpc.walletconnect.org/v1/",Zu="generic",wv=`${Ju}bundler`,ci="call_status",bv=86400,Ua={DEFAULT_CHAIN_CHANGED:"default_chain_changed"},vv=Object.defineProperty,Ev=Object.defineProperties,Iv=Object.getOwnPropertyDescriptors,Tu=Object.getOwnPropertySymbols,_v=Object.prototype.hasOwnProperty,Cv=Object.prototype.propertyIsEnumerable,Pu=(s,e,t)=>e in s?vv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,zr=(s,e)=>{for(var t in e||(e={}))_v.call(e,t)&&Pu(s,t,e[t]);if(Tu)for(var t of Tu(e))Cv.call(e,t)&&Pu(s,t,e[t]);return s},Av=(s,e)=>Ev(s,Iv(e));function Qu(s,e,t){var i;let r=_t(s);return((i=e.rpcMap)==null?void 0:i[r.reference])||`${Ju}?chainId=${r.namespace}:${r.reference}&projectId=${t}`}function Sv(s){return s.includes(":")?s.split(":")[1]:s}function ed(s){return s.map(e=>`${e.split(":")[0]}:${e.split(":")[1]}`)}function Nv(s,e){let t=Object.keys(e.namespaces).filter(r=>r.includes(s));if(!t.length)return[];let i=[];return t.forEach(r=>{let n=e.namespaces[r].accounts;i.push(...n)}),i}function Ru(s){return Object.fromEntries(Object.entries(s).filter(([e,t])=>{var i,r;return((i=t?.chains)==null?void 0:i.length)&&((r=t?.chains)==null?void 0:r.length)>0}))}function Hr(s={},e={}){let t=Ru(xu(s)),i=Ru(xu(e));return gv(t,i)}function xu(s){var e,t,i,r,n;let o={};if(!ht(s))return o;for(let[a,c]of Object.entries(s)){let l=ki(a)?[a]:c.chains,h=c.methods||[],d=c.events||[],u=c.rpcMap||{},p=Fs(a);o[p]=Av(zr(zr({},o[p]),c),{chains:bt(l,(e=o[p])==null?void 0:e.chains),methods:bt(h,(t=o[p])==null?void 0:t.methods),events:bt(d,(i=o[p])==null?void 0:i.events)}),(ht(u)||ht(((r=o[p])==null?void 0:r.rpcMap)||{}))&&(o[p].rpcMap=zr(zr({},u),(n=o[p])==null?void 0:n.rpcMap))}return o}function ku(s){return s.includes(":")?s.split(":")[2]:s}function Uu(s){let e={};for(let[t,i]of Object.entries(s)){let r=i.methods||[],n=i.events||[],o=i.accounts||[],a=ki(t)?[t]:i.chains?i.chains:ed(i.accounts);e[t]={chains:a,methods:r,events:n,accounts:o}}return e}function va(s){return typeof s=="number"?s:s.includes("0x")?parseInt(s,16):(s=s.includes(":")?s.split(":")[1]:s,isNaN(Number(s))?s:Number(s))}function Ov(s){try{let e=JSON.parse(s);return typeof e=="object"&&e!==null&&!Array.isArray(e)}catch{return!1}}var td={},li=s=>td[s],Ea=(s,e)=>{td[s]=e},Tv=Object.defineProperty,Fu=Object.getOwnPropertySymbols,Pv=Object.prototype.hasOwnProperty,Rv=Object.prototype.propertyIsEnumerable,Lu=(s,e,t)=>e in s?Tv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Du=(s,e)=>{for(var t in e||(e={}))Pv.call(e,t)&&Lu(s,t,e[t]);if(Fu)for(var t of Fu(e))Rv.call(e,t)&&Lu(s,t,e[t]);return s},qu="eip155",xv=["atomic","flow-control","paymasterService","sessionKeys","auxiliaryFunds"],kv=s=>s&&s.startsWith("0x")?BigInt(s).toString(10):s,Ia=s=>s&&s.startsWith("0x")?s:`0x${BigInt(s).toString(16)}`,Bu=s=>Object.keys(s).filter(e=>xv.includes(e)).reduce((e,t)=>(e[t]=Uv(s[t]),e),{}),Uv=s=>typeof s=="string"&&Ov(s)?JSON.parse(s):s,Fv=(s,e,t)=>{let{sessionProperties:i={},scopedProperties:r={}}=s,n={};if(!ht(r)&&!ht(i))return;let o=Bu(i);for(let a of t){let c=kv(a);if(!c)continue;n[Ia(c)]=o;let l=r?.[`${qu}:${c}`];if(l){let h=l?.[`${qu}:${c}:${e}`];n[Ia(c)]=Du(Du({},n[Ia(c)]),Bu(h||l))}}for(let[a,c]of Object.entries(n))Object.keys(c).length===0&&delete n[a];return Object.keys(n).length>0?n:void 0},Lv=Object.defineProperty,Dv=(s,e,t)=>e in s?Lv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,qv=(s,e,t)=>Dv(s,typeof e!="symbol"?e+"":e,t),_a,Na=class s{constructor(e){qv(this,"storage"),this.storage=e}async getItem(e){return await this.storage.getItem(e)}async setItem(e,t){return await this.storage.setItem(e,t)}async removeItem(e){return await this.storage.removeItem(e)}static getStorage(e){return _a||(_a=new s(e)),_a}},Bv=Object.defineProperty,jv=Object.defineProperties,Mv=Object.getOwnPropertyDescriptors,ju=Object.getOwnPropertySymbols,$v=Object.prototype.hasOwnProperty,Vv=Object.prototype.propertyIsEnumerable,Mu=(s,e,t)=>e in s?Bv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Kv=(s,e)=>{for(var t in e||(e={}))$v.call(e,t)&&Mu(s,t,e[t]);if(ju)for(var t of ju(e))Vv.call(e,t)&&Mu(s,t,e[t]);return s},zv=(s,e)=>jv(s,Mv(e));async function Hv(s,e){let t=_t(s.result.capabilities.caip345.caip2),i=s.result.capabilities.caip345.transactionHashes,r=await Promise.allSettled(i.map(d=>Wv(t.reference,d,e))),n=r.filter(d=>d.status==="fulfilled").map(d=>d.value).filter(d=>d);r.filter(d=>d.status==="rejected").forEach(d=>console.warn("Failed to fetch transaction receipt:",d.reason));let o=!n.length||n.some(d=>!d),a=n.every(d=>d?.status==="0x1"),c=n.every(d=>d?.status==="0x0"),l=n.some(d=>d?.status==="0x0"),h;return o?h=100:a?h=200:c?h=500:l&&(h=600),{id:s.result.id,version:s.request.version,atomic:s.request.atomicRequired,chainId:s.request.chainId,capabilities:s.result.capabilities,receipts:n,status:h}}async function Wv(s,e,t){return await t(parseInt(s)).request(et("eth_getTransactionReceipt",[e]))}async function Gv({sendCalls:s,storage:e}){let t=await e.getItem(ci);await e.setItem(ci,zv(Kv({},t),{[s.result.id]:{request:s.request,result:s.result,expiry:me(bv)}}))}async function Yv({resultId:s,storage:e}){let t=await e.getItem(ci);if(t){delete t[s],await e.setItem(ci,t);for(let i in t)rt(t[i].expiry)&&delete t[i];await e.setItem(ci,t)}}async function Xv({resultId:s,storage:e}){let t=await e.getItem(ci),i=t?.[s];if(i&&!rt(i.expiry))return i;await Yv({resultId:s,storage:e})}var Jv=Object.defineProperty,Zv=Object.defineProperties,Qv=Object.getOwnPropertyDescriptors,$u=Object.getOwnPropertySymbols,e0=Object.prototype.hasOwnProperty,t0=Object.prototype.propertyIsEnumerable,Oa=(s,e,t)=>e in s?Jv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ca=(s,e)=>{for(var t in e||(e={}))e0.call(e,t)&&Oa(s,t,e[t]);if($u)for(var t of $u(e))t0.call(e,t)&&Oa(s,t,e[t]);return s},Aa=(s,e)=>Zv(s,Qv(e)),Ls=(s,e,t)=>Oa(s,typeof e!="symbol"?e+"":e,t),Ta=class{constructor(e){Ls(this,"name","eip155"),Ls(this,"client"),Ls(this,"chainId"),Ls(this,"namespace"),Ls(this,"httpProviders"),Ls(this,"events"),Ls(this,"storage"),this.namespace=e.namespace,this.events=li("events"),this.client=li("client"),this.httpProviders=this.createHttpProviders(),this.chainId=parseInt(this.getDefaultChain()),this.storage=Na.getStorage(this.client.core.storage)}async request(e){switch(e.request.method){case"eth_requestAccounts":return this.getAccounts();case"eth_accounts":return this.getAccounts();case"wallet_switchEthereumChain":return await this.handleSwitchChain(e);case"eth_chainId":return parseInt(this.getDefaultChain());case"wallet_getCapabilities":return await this.getCapabilities(e);case"wallet_getCallsStatus":return await this.getCallStatus(e);case"wallet_sendCalls":return await this.sendCalls(e)}return this.namespace.methods.includes(e.request.method)?await this.client.request(e):this.getHttpProvider().request(e.request)}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(parseInt(e),t);let i=this.chainId;this.chainId=parseInt(e),this.events.emit(Ua.DEFAULT_CHAIN_CHANGED,{currentCaipChainId:`${this.name}:${e}`,previousCaipChainId:`${this.name}:${i}`})}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId.toString();if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}createHttpProvider(e,t){let i=t||Qu(`${this.name}:${e}`,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new fi(new Ki(i,li("disableProviderPing")))}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{var i;let r=parseInt(Sv(t));e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}getHttpProvider(e){let t=e||this.chainId;return this.httpProviders[t]||(this.httpProviders=Aa(Ca({},this.httpProviders),{[t]:this.createHttpProvider(t)}),this.httpProviders[t])}async handleSwitchChain(e){var t,i;let r=e.request.params?(t=e.request.params[0])==null?void 0:t.chainId:"0x0";r=r.startsWith("0x")?r:`0x${r}`;let n=parseInt(r,16);if(this.isChainApproved(n))this.setDefaultChain(`${n}`);else if(this.namespace.methods.includes("wallet_switchEthereumChain"))await this.client.request({topic:e.topic,request:{method:e.request.method,params:[{chainId:r}]},chainId:(i=this.namespace.chains)==null?void 0:i[0]}),this.setDefaultChain(`${n}`);else throw new Error(`Failed to switch to chain 'eip155:${n}'. The chain is not approved or the wallet does not support 'wallet_switchEthereumChain' method.`);return null}isChainApproved(e){return this.namespace.chains.includes(`${this.name}:${e}`)}async getCapabilities(e){var t,i,r,n,o;let a=(i=(t=e.request)==null?void 0:t.params)==null?void 0:i[0],c=((n=(r=e.request)==null?void 0:r.params)==null?void 0:n[1])||[];if(!a)throw new Error("Missing address parameter in `wallet_getCapabilities` request");let l=this.client.session.get(e.topic),h=((o=l?.sessionProperties)==null?void 0:o.capabilities)||{},d=`${a}${c.join(",")}`,u=h?.[d];if(u)return u;let p;try{p=Fv(l,a,c)}catch(g){console.warn("Failed to extract capabilities from session",g)}if(p)return p;let f=await this.client.request(e);try{await this.client.session.update(e.topic,{sessionProperties:Aa(Ca({},l.sessionProperties||{}),{capabilities:Aa(Ca({},h||{}),{[d]:f})})})}catch(g){console.warn("Failed to update session with capabilities",g)}return f}async getCallStatus(e){var t,i,r;let n=this.client.session.get(e.topic),o=(t=n.sessionProperties)==null?void 0:t.bundler_name;if(o){let l=this.getBundlerUrl(e.chainId,o);try{return await this.getUserOperationReceipt(l,e)}catch(h){console.warn("Failed to fetch call status from bundler",h,l)}}let a=(i=n.sessionProperties)==null?void 0:i.bundler_url;if(a)try{return await this.getUserOperationReceipt(a,e)}catch(l){console.warn("Failed to fetch call status from custom bundler",l,a)}let c=await Xv({resultId:(r=e.request.params)==null?void 0:r[0],storage:this.storage});if(c)try{return await Hv(c,this.getHttpProvider.bind(this))}catch(l){console.warn("Failed to fetch call status from stored send calls",l,c)}if(this.namespace.methods.includes(e.request.method))return await this.client.request(e);throw new Error("Fetching call status not approved by the wallet.")}async getUserOperationReceipt(e,t){var i;let r=new URL(e),n=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(et("eth_getUserOperationReceipt",[(i=t.request.params)==null?void 0:i[0]]))});if(!n.ok)throw new Error(`Failed to fetch user operation receipt - ${n.status}`);return await n.json()}getBundlerUrl(e,t){return`${wv}?projectId=${this.client.core.projectId}&chainId=${e}&bundler=${t}`}async sendCalls(e){var t,i,r;let n=await this.client.request(e),o=(t=e.request.params)==null?void 0:t[0],a=n?.id,c=n?.capabilities||{},l=(i=c?.caip345)==null?void 0:i.caip2,h=(r=c?.caip345)==null?void 0:r.transactionHashes;return!a||!l||!(h!=null&&h.length)||await Gv({sendCalls:{request:o,result:n},storage:this.storage}),n}},s0=Object.defineProperty,i0=(s,e,t)=>e in s?s0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,oi=(s,e,t)=>i0(s,typeof e!="symbol"?e+"":e,t),Pa=class{constructor(e){oi(this,"name",Zu),oi(this,"client"),oi(this,"httpProviders"),oi(this,"events"),oi(this,"namespace"),oi(this,"chainId"),this.namespace=e.namespace,this.events=li("events"),this.client=li("client"),this.chainId=this.getDefaultChain(),this.name=this.getNamespaceName(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace.chains=[...new Set((this.namespace.chains||[]).concat(e.chains||[]))],this.namespace.accounts=[...new Set((this.namespace.accounts||[]).concat(e.accounts||[]))],this.namespace.methods=[...new Set((this.namespace.methods||[]).concat(e.methods||[]))],this.namespace.events=[...new Set((this.namespace.events||[]).concat(e.events||[]))],this.httpProviders=this.createHttpProviders()}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider(e.chainId).request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t);let i=this.chainId;this.chainId=e,this.events.emit(Ua.DEFAULT_CHAIN_CHANGED,{currentCaipChainId:`${this.name}:${e}`,previousCaipChainId:`${this.name}:${i}`})}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getNamespaceName(){let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return _t(e).namespace}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){var e,t;let i={};return(t=(e=this.namespace)==null?void 0:e.accounts)==null||t.forEach(r=>{var n,o;let a=_t(r),c=(o=(n=this.namespace)==null?void 0:n.rpcMap)==null?void 0:o[`${a.namespace}:${a.reference}`];i[a.reference]=this.createHttpProvider(r,c)}),i}getHttpProvider(e){let t=_t(e).reference,i=this.httpProviders[t];if(typeof i>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return i}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||Qu(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new fi(new Ki(i,li("disableProviderPing")))}},r0=Object.defineProperty,n0=Object.defineProperties,o0=Object.getOwnPropertyDescriptors,Vu=Object.getOwnPropertySymbols,a0=Object.prototype.hasOwnProperty,c0=Object.prototype.propertyIsEnumerable,Ra=(s,e,t)=>e in s?r0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ji=(s,e)=>{for(var t in e||(e={}))a0.call(e,t)&&Ra(s,t,e[t]);if(Vu)for(var t of Vu(e))c0.call(e,t)&&Ra(s,t,e[t]);return s},Wr=(s,e)=>n0(s,o0(e)),ft=(s,e,t)=>Ra(s,typeof e!="symbol"?e+"":e,t),Gr=class s{constructor(e){ft(this,"client"),ft(this,"namespaces"),ft(this,"optionalNamespaces"),ft(this,"sessionProperties"),ft(this,"scopedProperties"),ft(this,"events",new Is),ft(this,"rpcProviders",{}),ft(this,"session"),ft(this,"providerOpts"),ft(this,"logger"),ft(this,"uri"),ft(this,"disableProviderPing",!1);var t,i;this.providerOpts=e,this.logger=ei({logger:(t=e.logger)!=null?t:Ou,name:(i=this.providerOpts.name)!=null?i:Xu}),this.disableProviderPing=e?.disableProviderPing||!1}static async init(e){let t=new s(e);return await t.initialize(),t}async request(e,t,i){let[r,n]=this.validateChain(t);if(!this.session)throw new Error("Please call connect() before request()");return await this.getProvider(r).request({request:ji({},e),chainId:`${r}:${n}`,topic:this.session.topic,expiry:i})}sendAsync(e,t,i,r){let n=new Date().getTime();this.request(e,i,r).then(o=>t(null,es(n,o))).catch(o=>t(o,void 0))}async enable(){if(!this.client)throw new Error("Sign Client not initialized");return this.session||await this.connect({namespaces:this.namespaces,optionalNamespaces:this.optionalNamespaces,sessionProperties:this.sessionProperties,scopedProperties:this.scopedProperties}),await this.requestAccounts()}async disconnect(){var e;if(!this.session)throw new Error("Please call connect() before enable()");await this.client.disconnect({topic:(e=this.session)==null?void 0:e.topic,reason:he("USER_DISCONNECTED")}),await this.cleanup()}async connect(e){if(!this.client)throw new Error("Sign Client not initialized");if(this.setNamespaces(e),this.cleanupPendingPairings(),!e.skipPairing)return await this.pair(e.pairingTopic)}async authenticate(e,t){if(!this.client)throw new Error("Sign Client not initialized");this.setNamespaces(e),await this.cleanupPendingPairings();let{uri:i,response:r}=await this.client.authenticate(e,t);i&&(this.uri=i,this.events.emit("display_uri",i));let n=await r();if(this.session=n.session,this.session){let o=Uu(this.session.namespaces);this.namespaces=Hr(this.namespaces,o),await this.persist("namespaces",this.namespaces),this.onConnect()}return n}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}removeListener(e,t){this.events.removeListener(e,t)}off(e,t){this.events.off(e,t)}get isWalletConnect(){return!0}async pair(e){let{uri:t,approval:i}=await this.client.connect({pairingTopic:e,requiredNamespaces:this.namespaces,optionalNamespaces:this.optionalNamespaces,sessionProperties:this.sessionProperties,scopedProperties:this.scopedProperties});t&&(this.uri=t,this.events.emit("display_uri",t));let r=await i();this.session=r;let n=Uu(r.namespaces);return this.namespaces=Hr(this.namespaces,n),await this.persist("namespaces",this.namespaces),await this.persist("optionalNamespaces",this.optionalNamespaces),this.onConnect(),this.session}setDefaultChain(e,t){try{if(!this.session)return;let[i,r]=this.validateChain(e);this.getProvider(i).setDefaultChain(r,t)}catch(i){if(!/Please call connect/.test(i.message))throw i}}async cleanupPendingPairings(e={}){try{this.logger.info("Cleaning up inactive pairings...");let t=this.client.pairing.getAll();if(!St(t))return;for(let i of t)e.deletePairings?this.client.core.expirer.set(i.topic,0):await this.client.core.relayer.subscriber.unsubscribe(i.topic);this.logger.info(`Inactive pairings cleared: ${t.length}`)}catch(t){this.logger.warn(t,"Failed to cleanup pending pairings")}}abortPairingAttempt(){this.logger.warn("abortPairingAttempt is deprecated. This is now a no-op.")}async checkStorage(){this.namespaces=await this.getFromStore("namespaces")||{},this.optionalNamespaces=await this.getFromStore("optionalNamespaces")||{},this.session&&this.createProviders()}async initialize(){this.logger.trace("Initialized"),await this.createClient(),await this.checkStorage(),this.registerEventListeners()}async createClient(){var e,t;if(this.client=this.providerOpts.client||await Cu.init({core:this.providerOpts.core,logger:this.providerOpts.logger||Ou,relayUrl:this.providerOpts.relayUrl||yv,projectId:this.providerOpts.projectId,metadata:this.providerOpts.metadata,storageOptions:this.providerOpts.storageOptions,storage:this.providerOpts.storage,name:this.providerOpts.name,customStoragePrefix:this.providerOpts.customStoragePrefix,telemetryEnabled:this.providerOpts.telemetryEnabled}),this.providerOpts.session)try{this.session=this.client.session.get(this.providerOpts.session.topic)}catch(i){throw this.logger.error(i,"Failed to get session"),new Error(`The provided session: ${(t=(e=this.providerOpts)==null?void 0:e.session)==null?void 0:t.topic} doesn't exist in the Sign client`)}else{let i=this.client.session.getAll();this.session=i[0]}this.logger.trace("SignClient Initialized")}createProviders(){if(!this.client)throw new Error("Sign Client not initialized");if(!this.session)throw new Error("Session not initialized. Please call connect() before enable()");let e=[...new Set(Object.keys(this.session.namespaces).map(t=>Fs(t)))];Ea("client",this.client),Ea("events",this.events),Ea("disableProviderPing",this.disableProviderPing),e.forEach(t=>{if(!this.session)return;let i=Nv(t,this.session);if(i?.length===0)return;let r=ed(i),n=Hr(this.namespaces,this.optionalNamespaces),o=Wr(ji({},n[t]),{accounts:i,chains:r});switch(t){case"eip155":this.rpcProviders[t]=new Ta({namespace:o});break;default:this.rpcProviders[t]=new Pa({namespace:o})}})}registerEventListeners(){if(typeof this.client>"u")throw new Error("Sign Client is not initialized");this.client.on("session_ping",e=>{var t;let{topic:i}=e;i===((t=this.session)==null?void 0:t.topic)&&this.events.emit("session_ping",e)}),this.client.on("session_event",e=>{var t;let{params:i,topic:r}=e;if(r!==((t=this.session)==null?void 0:t.topic))return;let{event:n}=i;if(n.name==="accountsChanged"){let o=n.data;o&&St(o)&&this.events.emit("accountsChanged",o.map(ku))}else if(n.name==="chainChanged"){let o=i.chainId,a=i.event.data,c=Fs(o),l=va(o)!==va(a)?`${c}:${va(a)}`:o;this.onChainChanged({currentCaipChainId:l})}else this.events.emit(n.name,n.data);this.events.emit("session_event",e)}),this.client.on("session_update",({topic:e,params:t})=>{var i,r;if(e!==((i=this.session)==null?void 0:i.topic))return;let{namespaces:n}=t,o=(r=this.client)==null?void 0:r.session.get(e);this.session=Wr(ji({},o),{namespaces:n}),this.onSessionUpdate(),this.events.emit("session_update",{topic:e,params:t})}),this.client.on("session_delete",async e=>{var t;e.topic===((t=this.session)==null?void 0:t.topic)&&(await this.cleanup(),this.events.emit("session_delete",e),this.events.emit("disconnect",Wr(ji({},he("USER_DISCONNECTED")),{data:e.topic})))}),this.on(Ua.DEFAULT_CHAIN_CHANGED,e=>{this.onChainChanged(Wr(ji({},e),{internal:!0}))})}getProvider(e){return this.rpcProviders[e]||this.rpcProviders[Zu]}onSessionUpdate(){Object.keys(this.rpcProviders).forEach(e=>{var t;this.getProvider(e).updateNamespace((t=this.session)==null?void 0:t.namespaces[e])})}setNamespaces(e){let{namespaces:t={},optionalNamespaces:i={},sessionProperties:r,scopedProperties:n}=e;this.optionalNamespaces=Hr(t,i),this.sessionProperties=r,this.scopedProperties=n}validateChain(e){let[t,i]=e?.split(":")||["",""];if(!this.namespaces||!Object.keys(this.namespaces).length)return[t,i];if(t&&!Object.keys(this.namespaces||{}).map(o=>Fs(o)).includes(t))throw new Error(`Namespace '${t}' is not configured. Please call connect() first with namespace config.`);if(t&&i)return[t,i];let r=Fs(Object.keys(this.namespaces)[0]),n=this.rpcProviders[r].getDefaultChain();return[r,n]}async requestAccounts(){let[e]=this.validateChain();return await this.getProvider(e).requestAccounts()}async onChainChanged({currentCaipChainId:e,previousCaipChainId:t,internal:i=!1}){if(!this.namespaces)return;let[r,n]=this.validateChain(e);n&&(this.updateNamespaceChain(r,n),i?(this.events.emit("chainChanged",n),this.emitAccountsChangedOnChainChange({namespace:r,currentCaipChainId:e,previousCaipChainId:t})):this.getProvider(r).setDefaultChain(n),await this.persist("namespaces",this.namespaces))}emitAccountsChangedOnChainChange({namespace:e,currentCaipChainId:t,previousCaipChainId:i}){var r,n;try{if(i===t)return;let o=(n=(r=this.session)==null?void 0:r.namespaces[e])==null?void 0:n.accounts;if(!o)return;let a=o.filter(c=>c.includes(`${t}:`)).map(ku);if(!St(a))return;this.events.emit("accountsChanged",a)}catch(o){this.logger.warn(o,"Failed to emit accountsChanged on chain change")}}updateNamespaceChain(e,t){if(!this.namespaces)return;let i=this.namespaces[e]?e:`${e}:${t}`,r={chains:[],methods:[],events:[],defaultChain:t};this.namespaces[i]?this.namespaces[i]&&(this.namespaces[i].defaultChain=t):this.namespaces[i]=r}onConnect(){this.createProviders(),this.events.emit("connect",{session:this.session})}async cleanup(){this.namespaces=void 0,this.optionalNamespaces=void 0,this.sessionProperties=void 0,await this.deleteFromStore("namespaces"),await this.deleteFromStore("optionalNamespaces"),await this.deleteFromStore("sessionProperties"),this.session=void 0,this.cleanupPendingPairings({deletePairings:!0}),await this.cleanupStorage()}async persist(e,t){var i;let r=((i=this.session)==null?void 0:i.topic)||"";await this.client.core.storage.setItem(`${Kr}/${e}${r}`,t)}async getFromStore(e){var t;let i=((t=this.session)==null?void 0:t.topic)||"";return await this.client.core.storage.getItem(`${Kr}/${e}${i}`)}async deleteFromStore(e){var t;let i=((t=this.session)==null?void 0:t.topic)||"";await this.client.core.storage.removeItem(`${Kr}/${e}${i}`)}async cleanupStorage(){var e;try{if(((e=this.client)==null?void 0:e.session.length)>0)return;let t=await this.client.core.storage.getKeys();for(let i of t)i.startsWith(Kr)&&await this.client.core.storage.removeItem(i)}catch(t){this.logger.warn(t,"Failed to cleanup storage")}}};oe();ce();ae();oe();ce();ae();oe();ce();ae();var Mi={ERROR_CODE_UNRECOGNIZED_CHAIN_ID:4902,ERROR_CODE_DEFAULT:5e3,ERROR_INVALID_CHAIN_ID:32603};var Yr=class extends ec{async setUniversalProvider(e){if(!this.namespace)throw new Error("UniversalAdapter:setUniversalProvider - namespace is required");return this.addConnector(new tc({provider:e,caipNetworks:this.getCaipNetworks(),namespace:this.namespace})),Promise.resolve()}async connect(e){return Promise.resolve({id:"WALLET_CONNECT",type:"WALLET_CONNECT",chainId:Number(e.chainId),provider:this.provider,address:""})}async disconnect(){try{await this.getWalletConnectConnector().disconnect(),this.emit("disconnect")}catch(e){console.warn("UniversalAdapter:disconnect - error",e)}return{connections:[]}}syncConnections(){return Promise.resolve()}async getAccounts({namespace:e}){let i=this.provider?.session?.namespaces?.[e]?.accounts?.map(r=>{let[,,n]=r.split(":");return n}).filter((r,n,o)=>o.indexOf(r)===n)||[];return Promise.resolve({accounts:i.map(r=>Ke.createAccount(e,r,e==="bip122"?"payment":"eoa"))})}async syncConnectors(){return Promise.resolve()}async getBalance(e){if(!(e.caipNetwork&&_e.BALANCE_SUPPORTED_CHAINS.includes(e.caipNetwork?.chainNamespace))||e.caipNetwork?.testnet)return{balance:"0.00",symbol:e.caipNetwork?.nativeCurrency.symbol||""};let i=E.getAccountData();if(i?.balanceLoading&&e.chainId===E.state.activeCaipNetwork?.id)return{balance:i?.balance||"0.00",symbol:i?.balanceSymbol||""};let n=(await E.fetchTokenBalance()).find(o=>o.chainId===`${e.caipNetwork?.chainNamespace}:${e.chainId}`&&o.symbol===e.caipNetwork?.nativeCurrency.symbol);return{balance:n?.quantity.numeric||"0.00",symbol:n?.symbol||e.caipNetwork?.nativeCurrency.symbol||""}}async signMessage(e){let{provider:t,message:i,address:r}=e;if(!t)throw new Error("UniversalAdapter:signMessage - provider is undefined");let n="";return E.state.activeCaipNetwork?.chainNamespace===re.CHAIN.SOLANA?n=(await t.request({method:"solana_signMessage",params:{message:Qt.encode(new TextEncoder().encode(i)),pubkey:r}},E.state.activeCaipNetwork?.caipNetworkId)).signature:n=await t.request({method:"personal_sign",params:[i,r]},E.state.activeCaipNetwork?.caipNetworkId),{signature:n}}async estimateGas(){return Promise.resolve({gas:BigInt(0)})}async sendTransaction(){return Promise.resolve({hash:""})}walletGetAssets(e){return Promise.resolve({})}async writeContract(){return Promise.resolve({hash:""})}emitFirstAvailableConnection(){}parseUnits(){return 0n}formatUnits(){return"0"}async getCapabilities(){return Promise.resolve({})}async grantPermissions(){return Promise.resolve({})}async revokePermissions(){return Promise.resolve("0x")}async syncConnection(){return Promise.resolve({id:"WALLET_CONNECT",type:"WALLET_CONNECT",chainId:1,provider:this.provider,address:""})}async switchNetwork(e){let{caipNetwork:t}=e,i=this.getWalletConnectConnector();if(t.chainNamespace===re.CHAIN.EVM)try{await i.provider?.request({method:"wallet_switchEthereumChain",params:[{chainId:Qr(t.id)}]})}catch(r){if(r.code===Mi.ERROR_CODE_UNRECOGNIZED_CHAIN_ID||r.code===Mi.ERROR_INVALID_CHAIN_ID||r.code===Mi.ERROR_CODE_DEFAULT||r?.data?.originalError?.code===Mi.ERROR_CODE_UNRECOGNIZED_CHAIN_ID)try{await i.provider?.request({method:"wallet_addEthereumChain",params:[{chainId:Qr(t.id),rpcUrls:[t?.rpcUrls.chainDefault?.http],chainName:t.name,nativeCurrency:t.nativeCurrency,blockExplorerUrls:[t.blockExplorers?.default.url]}]})}catch{throw new Error("Chain is not supported")}}i.provider.setDefaultChain(t.caipNetworkId)}getWalletConnectProvider(){return this.connectors.find(i=>i.type==="WALLET_CONNECT")?.provider}};oe();ce();ae();var l0=["email","socials","swaps","onramp","activity","reownBranding","multiWallet","emailCapture","payWithExchange","payments","reownAuthentication"],Xr={email:{apiFeatureName:"social_login",localFeatureName:"email",returnType:!1,isLegacy:!1,isAvailableOnBasic:!1,processApi:s=>{if(!s?.config)return!1;let e=s.config;return!!s.isEnabled&&e.includes("email")},processFallback:s=>s===void 0?_e.DEFAULT_REMOTE_FEATURES.email:!!s},socials:{apiFeatureName:"social_login",localFeatureName:"socials",returnType:!1,isLegacy:!1,isAvailableOnBasic:!1,processApi:s=>{if(!s?.config)return!1;let e=s.config;return s.isEnabled&&e.length>0?e.filter(t=>t!=="email"):!1},processFallback:s=>s===void 0?_e.DEFAULT_REMOTE_FEATURES.socials:typeof s=="boolean"?s?_e.DEFAULT_REMOTE_FEATURES.socials:!1:s},swaps:{apiFeatureName:"swap",localFeatureName:"swaps",returnType:!1,isLegacy:!1,isAvailableOnBasic:!1,processApi:s=>{if(!s?.config)return!1;let e=s.config;return s.isEnabled&&e.length>0?e:!1},processFallback:s=>s===void 0?_e.DEFAULT_REMOTE_FEATURES.swaps:typeof s=="boolean"?s?_e.DEFAULT_REMOTE_FEATURES.swaps:!1:s},onramp:{apiFeatureName:"onramp",localFeatureName:"onramp",returnType:!1,isLegacy:!1,isAvailableOnBasic:!1,processApi:s=>{if(!s?.config)return!1;let e=s.config;return s.isEnabled&&e.length>0?e:!1},processFallback:s=>s===void 0?_e.DEFAULT_REMOTE_FEATURES.onramp:typeof s=="boolean"?s?_e.DEFAULT_REMOTE_FEATURES.onramp:!1:s},activity:{apiFeatureName:"activity",localFeatureName:"history",returnType:!1,isLegacy:!0,isAvailableOnBasic:!1,processApi:s=>!!s.isEnabled,processFallback:s=>s===void 0?_e.DEFAULT_REMOTE_FEATURES.activity:!!s},reownBranding:{apiFeatureName:"reown_branding",localFeatureName:"reownBranding",returnType:!1,isLegacy:!1,isAvailableOnBasic:!1,processApi:s=>!!s.isEnabled,processFallback:s=>s===void 0?_e.DEFAULT_REMOTE_FEATURES.reownBranding:!!s},emailCapture:{apiFeatureName:"email_capture",localFeatureName:"emailCapture",returnType:!1,isLegacy:!1,isAvailableOnBasic:!1,processApi:s=>s.isEnabled&&(s.config??[]),processFallback:s=>!1},multiWallet:{apiFeatureName:"multi_wallet",localFeatureName:"multiWallet",returnType:!1,isLegacy:!1,isAvailableOnBasic:!1,processApi:s=>!!s.isEnabled,processFallback:()=>_e.DEFAULT_REMOTE_FEATURES.multiWallet},payWithExchange:{apiFeatureName:"fund_from_exchange",localFeatureName:"payWithExchange",returnType:!1,isLegacy:!1,isAvailableOnBasic:!1,processApi:s=>!!s.isEnabled,processFallback:()=>_e.DEFAULT_REMOTE_FEATURES.payWithExchange},payments:{apiFeatureName:"payments",localFeatureName:"payments",returnType:!1,isLegacy:!1,isAvailableOnBasic:!1,processApi:s=>!!s.isEnabled,processFallback:()=>_e.DEFAULT_REMOTE_FEATURES.payments},reownAuthentication:{apiFeatureName:"reown_authentication",localFeatureName:"reownAuthentication",returnType:!1,isLegacy:!1,isAvailableOnBasic:!1,processApi:s=>!!s.isEnabled,processFallback:s=>typeof s>"u"?_e.DEFAULT_REMOTE_FEATURES.reownAuthentication:!!s}},sd={localSettingsOverridden:new Set,getApiConfig(s,e){return e?.find(t=>t.id===s)},addWarning(s,e){if(s!==void 0){let t=Xr[e],i=t.isLegacy?`"features.${t.localFeatureName}" (now "${e}")`:`"features.${e}"`;this.localSettingsOverridden.add(i)}},processFeature(s,e,t,i,r){let n=Xr[s],o=e[n.localFeatureName];if(r&&!n.isAvailableOnBasic)return!1;if(i){let a=this.getApiConfig(n.apiFeatureName,t);return a?.config===null?this.processFallbackFeature(s,o):a?.config?(o!==void 0&&this.addWarning(o,s),this.processApiFeature(s,a)):!1}return this.processFallbackFeature(s,o)},processApiFeature(s,e){return Xr[s].processApi(e)},processFallbackFeature(s,e){return Xr[s].processFallback(e)},async fetchRemoteFeatures(s){let e=s.basic??!1,t=s.features||{};this.localSettingsOverridden.clear();let i=null,r=!1;try{i=await js.fetchProjectConfig(),r=i!=null}catch(o){console.warn("[Reown Config] Failed to fetch remote project configuration. Using local/default values.",o)}let n=r&&!e?_e.DEFAULT_REMOTE_FEATURES:_e.DEFAULT_REMOTE_FEATURES_DISABLED;try{for(let o of l0){let a=this.processFeature(o,t,i,r,e);Object.assign(n,{[o]:a})}}catch(o){return console.warn("[Reown Config] Failed to process the configuration from Cloud. Using default values.",o),_e.DEFAULT_REMOTE_FEATURES}if(r&&this.localSettingsOverridden.size>0){let o=`Your local configuration for ${Array.from(this.localSettingsOverridden).join(", ")} was ignored because a remote configuration was successfully fetched. Please manage these features via your project dashboard on dashboard.reown.com.`;ze.open({debugMessage:We.ALERT_WARNINGS.LOCAL_CONFIGURATION_IGNORED.debugMessage(o)},"warning")}return n}};var Jr=class{constructor(e){this.chainNamespaces=[],this.features={},this.remoteFeatures={},this.reportedAlertErrors={},this.getCaipNetwork=(t,i)=>{if(t){let r=E.getCaipNetworks(t)?.find(a=>a.id===i);if(r)return r;let n=E.getNetworkData(t)?.caipNetwork;return n||E.getRequestedCaipNetworks(t).filter(a=>a.chainNamespace===t)?.[0]}return E.state.activeCaipNetwork||this.defaultCaipNetwork},this.getCaipNetworkId=()=>{let t=this.getCaipNetwork();if(t)return t.id},this.getCaipNetworks=t=>E.getCaipNetworks(t),this.getActiveChainNamespace=()=>E.state.activeChain,this.setRequestedCaipNetworks=(t,i)=>{E.setRequestedCaipNetworks(t,i)},this.getApprovedCaipNetworkIds=()=>E.getAllApprovedCaipNetworkIds(),this.getCaipAddress=t=>E.state.activeChain===t||!t?E.state.activeCaipAddress:E.state.chains.get(t)?.accountState?.caipAddress,this.setClientId=t=>{on.setClientId(t)},this.getProvider=t=>we.getProvider(t),this.getProviderType=t=>we.getProviderId(t),this.getPreferredAccountType=t=>an(t),this.setCaipAddress=(t,i,r=!1)=>{E.setAccountProp("caipAddress",t,i,r),E.setAccountProp("address",Ke.getPlainAddress(t),i,r)},this.setBalance=(t,i,r)=>{E.setAccountProp("balance",t,r),E.setAccountProp("balanceSymbol",i,r)},this.setProfileName=(t,i)=>{E.setAccountProp("profileName",t,i)},this.setProfileImage=(t,i)=>{E.setAccountProp("profileImage",t,i)},this.setUser=(t,i)=>{E.setAccountProp("user",t,i)},this.resetAccount=t=>{E.resetAccount(t)},this.setCaipNetwork=t=>{E.setActiveCaipNetwork(t)},this.setCaipNetworkOfNamespace=(t,i)=>{E.setChainNetworkData(i,{caipNetwork:t})},this.setStatus=(t,i)=>{E.setAccountProp("status",t,i),le.isConnected()?ge.setConnectionStatus("connected"):ge.setConnectionStatus("disconnected")},this.getAddressByChainNamespace=t=>E.getAccountData(t)?.address,this.setConnectors=t=>{let i=[...le.state.allConnectors,...t];le.setConnectors(i)},this.setConnections=(t,i)=>{ge.setConnections(t,i),ye.setConnections(t,i)},this.fetchIdentity=t=>on.fetchIdentity(t),this.getReownName=t=>Qa.getNamesForAddress(t),this.getConnectors=()=>le.getConnectors(),this.getConnectorImage=t=>Ya.getConnectorImage(t),this.getConnections=t=>this.remoteFeatures.multiWallet?cn.getConnectionsData(t).connections:(ze.open(re.REMOTE_FEATURES_ALERTS.MULTI_WALLET_NOT_ENABLED.DEFAULT,"info"),[]),this.getRecentConnections=t=>this.remoteFeatures.multiWallet?cn.getConnectionsData(t).recentConnections:(ze.open(re.REMOTE_FEATURES_ALERTS.MULTI_WALLET_NOT_ENABLED.DEFAULT,"info"),[]),this.switchConnection=async t=>{if(!this.remoteFeatures.multiWallet){ze.open(re.REMOTE_FEATURES_ALERTS.MULTI_WALLET_NOT_ENABLED.DEFAULT,"info");return}await ye.switchConnection(t)},this.deleteConnection=t=>{if(!this.remoteFeatures.multiWallet){ze.open(re.REMOTE_FEATURES_ALERTS.MULTI_WALLET_NOT_ENABLED.DEFAULT,"info");return}ge.deleteAddressFromConnection(t),ye.syncStorageConnections()},this.setConnectedWalletInfo=(t,i)=>{let r=we.getProviderId(i),n=t?{...t,type:r}:void 0;E.setAccountProp("connectedWalletInfo",n,i)},this.getIsConnectedState=()=>!!E.state.activeCaipAddress,this.addAddressLabel=(t,i,r)=>{let n=E.getAccountData(r)?.addressLabels||{};E.setAccountProp("addressLabels",{...n,[t]:i},r)},this.removeAddressLabel=(t,i)=>{let r=E.getAccountData(i)?.addressLabels||{};E.setAccountProp("addressLabels",{...r,[t]:void 0},i)},this.getAddress=t=>{let i=t||E.state.activeChain;return E.getAccountData(i)?.address},this.resetNetwork=t=>{E.resetNetwork(t)},this.addConnector=t=>{le.addConnector(t)},this.resetWcConnection=()=>{ye.resetWcConnection()},this.setAddressExplorerUrl=(t,i)=>{E.setAccountProp("addressExplorerUrl",t,i)},this.setSmartAccountDeployed=(t,i)=>{E.setAccountProp("smartAccountDeployed",t,i)},this.setPreferredAccountType=(t,i)=>{E.setAccountProp("preferredAccountType",t,i)},this.setEIP6963Enabled=t=>{q.setEIP6963Enabled(t)},this.handleUnsafeRPCRequest=()=>{if(this.isOpen()){if(this.isTransactionStackEmpty())return;this.redirect("ApproveTransaction")}else this.open({view:"ApproveTransaction"})},this.options=e,this.version=e.sdkVersion,this.caipNetworks=this.extendCaipNetworks(e),this.chainNamespaces=this.getChainNamespacesSet(e.adapters,this.caipNetworks),this.defaultCaipNetwork=this.extendDefaultCaipNetwork(e),this.chainAdapters=this.createAdapters(e.adapters),this.readyPromise=this.initialize(e)}getChainNamespacesSet(e,t){let i=e?.map(n=>n.namespace).filter(n=>!!n);if(i?.length)return[...new Set(i)];let r=t?.map(n=>n.chainNamespace);return[...new Set(r)]}async initialize(e){if(this.initializeProjectSettings(e),this.initControllers(e),await this.initChainAdapters(),this.sendInitializeEvent(e),q.state.enableReconnect?(await this.syncExistingConnection(),await this.syncAdapterConnections()):await this.unSyncExistingConnection(),this.remoteFeatures=await sd.fetchRemoteFeatures(e),await js.fetchUsage(),q.setRemoteFeatures(this.remoteFeatures),this.remoteFeatures.onramp&&Ja.setOnrampProviders(this.remoteFeatures.onramp),(q.state.remoteFeatures?.email||Array.isArray(q.state.remoteFeatures?.socials)&&q.state.remoteFeatures?.socials.length>0)&&await this.checkAllowedOrigins(),q.state.features?.reownAuthentication||q.state.remoteFeatures?.reownAuthentication){let{ReownAuthentication:t}=await import("./features-B7JE7FJ2.js"),i=q.state.siwx;i instanceof t||(i&&console.warn("ReownAuthentication option is enabled, SIWX configuration will be overridden."),q.setSIWX(new t))}}async openSend(e){let t=e.namespace||E.state.activeChain,i=this.getCaipAddress(t),r=this.getCaipNetwork(t)?.id;if(!i)throw new Error("openSend: caipAddress not found");if(r?.toString()!==e.chainId.toString()){let n=E.getCaipNetworkById(e.chainId,t);if(!n)throw new Error(`openSend: caipNetwork with chainId ${e.chainId} not found`);await this.switchNetwork(n,{throwOnFailure:!0})}try{let n=sc.getTokenSymbolByAddress(e.assetAddress);n&&await js.fetchTokenImages([n])}catch{}return await jt.open({view:"WalletSend",data:{send:e}}),new Promise((n,o)=>{let a=hn.subscribeKey("hash",h=>{h&&(l(),n({hash:h}))}),c=jt.subscribe(h=>{h.open||(l(),o(new Error("Modal closed")))}),l=this.createCleanupHandler([a,c])})}toModalOptions(){function e(i){return i?.view==="Swap"}function t(i){return i?.view==="WalletSend"}return{isSwap:e,isSend:t}}async checkAllowedOrigins(){try{let e=await js.fetchAllowedOrigins();if(!Ke.isClient())return;let t=window.location.origin;zi.isOriginAllowed(t,e,re.DEFAULT_ALLOWED_ANCESTORS)||ze.open(We.ALERT_ERRORS.ORIGIN_NOT_ALLOWED,"error")}catch(e){if(!(e instanceof Error))return;switch(e.message){case"RATE_LIMITED":ze.open(We.ALERT_ERRORS.RATE_LIMITED_APP_CONFIGURATION,"error");break;case"SERVER_ERROR":{let t=e.cause instanceof Error?e.cause:e;ze.open({displayMessage:We.ALERT_ERRORS.SERVER_ERROR_APP_CONFIGURATION.displayMessage,debugMessage:We.ALERT_ERRORS.SERVER_ERROR_APP_CONFIGURATION.debugMessage(t.message)},"error");break}default:break}}}createCleanupHandler(e){return()=>{e.forEach(t=>{try{t()}catch{}})}}sendInitializeEvent(e){let{...t}=e;delete t.adapters,delete t.universalProvider,ts.sendEvent({type:"track",event:"INITIALIZE",properties:{...t,networks:e.networks.map(i=>i.id),siweConfig:{options:e.siweConfig?.options||{}}}})}initControllers(e){this.initializeOptionsController(e),this.initializeChainController(e),this.initializeThemeController(e),this.initializeConnectionController(e),this.initializeConnectorController()}initAdapterController(){Xa.initialize(this.chainAdapters)}initializeThemeController(e){e.themeMode&&Pt.setThemeMode(e.themeMode),e.themeVariables&&Pt.setThemeVariables(e.themeVariables)}initializeChainController(e){if(!this.connectionControllerClient)throw new Error("ConnectionControllerClient must be set");E.initialize(e.adapters??[],this.caipNetworks,{connectionControllerClient:this.connectionControllerClient});let t=this.getDefaultNetwork();t&&E.setActiveCaipNetwork(t)}initializeConnectionController(e){ye.initialize(e.adapters??[]),ye.setWcBasic(e.basic??!1)}initializeConnectorController(){le.initialize(this.chainNamespaces)}initializeProjectSettings(e){q.setProjectId(e.projectId),q.setSdkVersion(e.sdkVersion)}initializeOptionsController(e){q.setDebug(e.debug!==!1),q.setEnableWalletGuide(e.enableWalletGuide!==!1),q.setEnableWallets(e.enableWallets!==!1),q.setEIP6963Enabled(e.enableEIP6963!==!1),q.setEnableNetworkSwitch(e.enableNetworkSwitch!==!1),q.setEnableReconnect(e.enableReconnect!==!1),q.setEnableMobileFullScreen(e.enableMobileFullScreen===!0),q.setCoinbasePreference(e.coinbasePreference),q.setEnableAuthLogger(e.enableAuthLogger!==!1),q.setCustomRpcUrls(e.customRpcUrls),q.setEnableEmbedded(e.enableEmbedded),q.setAllWallets(e.allWallets),q.setIncludeWalletIds(e.includeWalletIds),q.setExcludeWalletIds(e.excludeWalletIds),q.setFeaturedWalletIds(e.featuredWalletIds),q.setTokens(e.tokens),q.setTermsConditionsUrl(e.termsConditionsUrl),q.setPrivacyPolicyUrl(e.privacyPolicyUrl),q.setCustomWallets(e.customWallets),q.setFeatures(e.features),q.setAllowUnsupportedChain(e.allowUnsupportedChain),q.setUniversalProviderConfigOverride(e.universalProviderConfigOverride),q.setPreferUniversalLinks(e.experimental_preferUniversalLinks),q.setDefaultAccountTypes(e.defaultAccountTypes);let t=this.getDefaultMetaData();if(!e.metadata&&t&&(e.metadata=t),q.setMetadata(e.metadata),q.setDisableAppend(e.disableAppend),q.setEnableEmbedded(e.enableEmbedded),q.setSIWX(e.siwx),this.features=q.state.features??{},!e.projectId){ze.open(We.ALERT_ERRORS.PROJECT_ID_NOT_CONFIGURED,"error");return}if(e.adapters?.find(r=>r.namespace===re.CHAIN.EVM)&&e.siweConfig){if(e.siwx)throw new Error("Cannot set both `siweConfig` and `siwx` options");q.setSIWX(e.siweConfig.mapToSIWX())}}getDefaultMetaData(){return Ke.isClient()?{name:document.getElementsByTagName("title")?.[0]?.textContent||"",description:document.querySelector('meta[property="og:description"]')?.content||"",url:window.location.origin,icons:[document.querySelector('link[rel~="icon"]')?.href||""]}:null}setUnsupportedNetwork(e){let t=this.getActiveChainNamespace();if(t){let i=Ms.getUnsupportedNetwork(`${t}:${e}`);E.setActiveCaipNetwork(i)}}getDefaultNetwork(){return Ms.getCaipNetworkFromStorage(this.defaultCaipNetwork)}extendCaipNetwork(e,t){return Ms.extendCaipNetwork(e,{customNetworkImageUrls:t.chainImages,projectId:t.projectId})}extendCaipNetworks(e){return Ms.extendCaipNetworks(e.networks,{customNetworkImageUrls:e.chainImages,customRpcUrls:e.customRpcUrls,projectId:e.projectId})}extendDefaultCaipNetwork(e){let t=e.networks.find(r=>r.id===e.defaultNetwork?.id);return t?Ms.extendCaipNetwork(t,{customNetworkImageUrls:e.chainImages,customRpcUrls:e.customRpcUrls,projectId:e.projectId}):void 0}async disconnectConnector(e,t){try{this.setLoading(!0,e);let i={connections:[]},r=this.getAdapter(e);return(E.state.chains.get(e)?.accountState?.caipAddress||!q.state.enableReconnect)&&r?.disconnect&&(i=await r.disconnect({id:t})),this.setLoading(!1,e),i}catch(i){throw this.setLoading(!1,e),new Error(`Failed to disconnect chains: ${i.message}`)}}createClients(){this.connectionControllerClient={connectWalletConnect:async()=>{let e=E.state.activeChain,t=this.getAdapter(e),i=this.getCaipNetwork(e)?.id,r=ye.getConnections(e),n=this.remoteFeatures.multiWallet,o=r.length>0;if(!t)throw new Error("Adapter not found");let a=await t.connectWalletConnect(i);(!o||!n)&&this.close(),this.setClientId(a?.clientId||null),ge.setConnectedNamespaces([...E.state.chains.keys()]),await this.syncWalletConnectAccount(),await Hi.initializeIfEnabled()},connectExternal:async e=>{let t=await this.onConnectExternal(e);return await this.connectInactiveNamespaces(e,t),t?{address:t.address}:void 0},reconnectExternal:async({id:e,info:t,type:i,provider:r})=>{let n=E.state.activeChain,o=this.getAdapter(n);if(!n)throw new Error("reconnectExternal: namespace not found");if(!o)throw new Error("reconnectExternal: adapter not found");o?.reconnect&&(await o?.reconnect({id:e,info:t,type:i,provider:r,chainId:this.getCaipNetwork()?.id}),ge.addConnectedNamespace(n),this.syncConnectedWalletInfo(n))},disconnectConnector:async e=>{await this.disconnectConnector(e.namespace,e.id)},disconnect:async e=>{let{id:t,chainNamespace:i,initialDisconnect:r}=e||{},n=i||E.state.activeChain,o=le.getConnectorId(n),a=t===re.CONNECTOR_ID.AUTH||o===re.CONNECTOR_ID.AUTH,c=t===re.CONNECTOR_ID.WALLET_CONNECT||o===re.CONNECTOR_ID.WALLET_CONNECT;try{let l=Array.from(E.state.chains.keys()),h=i?[i]:l;(c||a)&&(h=l);let d=h.map(async f=>{let g=le.getConnectorId(f),y=t||g,A=await this.disconnectConnector(f,y);A&&(a&&ge.deleteConnectedSocialProvider(),A.connections.forEach(_=>{ge.addDisconnectedConnectorId(_.connectorId,f)})),r&&this.onDisconnectNamespace({chainNamespace:f,closeModal:!1})}),u=await Promise.allSettled(d);hn.resetSend(),ye.resetWcConnection(),Hi.getSIWX()?.signOutOnDisconnect&&await Hi.clearSessions(),le.setFilterByNamespace(void 0),ye.syncStorageConnections();let p=u.filter(f=>f.status==="rejected");if(p.length>0)throw new Error(p.map(f=>f.reason.message).join(", "));ts.sendEvent({type:"track",event:"DISCONNECT_SUCCESS",properties:{namespace:i||"all"}})}catch(l){throw new Error(`Failed to disconnect chains: ${l.message}`)}},checkInstalled:e=>e?e.some(t=>!!window.ethereum?.[String(t)]):!!window.ethereum,signMessage:async e=>{let t=E.state.activeChain,i=this.getAdapter(E.state.activeChain);if(!t)throw new Error("signMessage: namespace not found");if(!i)throw new Error("signMessage: adapter not found");let r=this.getAddress(t);if(!r)throw new Error("signMessage: address not found");return(await i?.signMessage({message:e,address:r,provider:we.getProvider(t)}))?.signature||""},sendTransaction:async e=>{let t=e.chainNamespace;if(!t)throw new Error("sendTransaction: namespace not found");if(_e.SEND_SUPPORTED_NAMESPACES.includes(t)){let i=this.getAdapter(t);if(!i)throw new Error("sendTransaction: adapter not found");let r=we.getProvider(t);return(await i?.sendTransaction({...e,caipNetwork:this.getCaipNetwork(),provider:r}))?.hash||""}return""},estimateGas:async e=>{let t=e.chainNamespace;if(t===re.CHAIN.EVM){let i=this.getAdapter(t);if(!i)throw new Error("estimateGas: adapter is required but got undefined");let r=we.getProvider(t),n=this.getCaipNetwork();if(!n)throw new Error("estimateGas: caipNetwork is required but got undefined");return(await i?.estimateGas({...e,provider:r,caipNetwork:n}))?.gas||0n}return 0n},getEnsAvatar:async()=>{let e=E.state.activeChain;if(!e)throw new Error("getEnsAvatar: namespace is required but got undefined");let t=this.getAddress(e);if(!t)throw new Error("getEnsAvatar: address not found");return await this.syncIdentity({address:t,chainId:Number(this.getCaipNetwork()?.id),chainNamespace:e}),E.getAccountData()?.profileImage||!1},getEnsAddress:async e=>await zi.resolveReownName(e),writeContract:async e=>{let t=E.state.activeChain,i=this.getAdapter(t);if(!t)throw new Error("writeContract: namespace is required but got undefined");if(!i)throw new Error("writeContract: adapter is required but got undefined");let r=this.getCaipNetwork(),n=this.getCaipAddress(),o=we.getProvider(t);if(!r||!n)throw new Error("writeContract: caipNetwork or caipAddress is required but got undefined");return(await i?.writeContract({...e,caipNetwork:r,provider:o,caipAddress:n}))?.hash},parseUnits:(e,t)=>{let i=this.getAdapter(E.state.activeChain);if(!i)throw new Error("parseUnits: adapter is required but got undefined");return i?.parseUnits({value:e,decimals:t})??0n},formatUnits:(e,t)=>{let i=this.getAdapter(E.state.activeChain);if(!i)throw new Error("formatUnits: adapter is required but got undefined");return i?.formatUnits({value:e,decimals:t})??"0"},getCapabilities:async e=>{let t=this.getAdapter(E.state.activeChain);if(!t)throw new Error("getCapabilities: adapter is required but got undefined");return await t?.getCapabilities(e)},grantPermissions:async e=>{let t=this.getAdapter(E.state.activeChain);if(!t)throw new Error("grantPermissions: adapter is required but got undefined");return await t?.grantPermissions(e)},revokePermissions:async e=>{let t=this.getAdapter(E.state.activeChain);if(!t)throw new Error("revokePermissions: adapter is required but got undefined");return t?.revokePermissions?await t.revokePermissions(e):"0x"},walletGetAssets:async e=>{let t=this.getAdapter(E.state.activeChain);if(!t)throw new Error("walletGetAssets: adapter is required but got undefined");return await t?.walletGetAssets(e)??{}},updateBalance:e=>{let t=this.getAddress(e),i=this.getCaipNetwork(e);!i||!t||this.updateNativeBalance(t,i?.id,e)}},ye.setClient(this.connectionControllerClient)}async onConnectExternal(e){let t=E.state.activeChain,i=e.chain||t,r=this.getAdapter(i),n=!0;if(e.type===Mt.CONNECTOR_TYPE_AUTH&&re.AUTH_CONNECTOR_SUPPORTED_CHAINS.some(d=>le.getConnectorId(d)===re.CONNECTOR_ID.AUTH)&&e.chain!==t&&(n=!1),e.chain&&e.chain!==t&&!e.caipNetwork){let l=this.getCaipNetworks().find(h=>h.chainNamespace===e.chain);l&&n&&this.setCaipNetwork(l)}if(!i)throw new Error("connectExternal: namespace not found");if(!r)throw new Error("connectExternal: adapter not found");let o=this.getCaipNetwork(i),a=e.caipNetwork||o,c=await r.connect({id:e.id,address:e.address,info:e.info,type:e.type,provider:e.provider,socialUri:e.socialUri,chainId:e.caipNetwork?.id||o?.id,rpcUrl:e.caipNetwork?.rpcUrls?.default?.http?.[0]||o?.rpcUrls?.default?.http?.[0]});if(c)return ge.addConnectedNamespace(i),this.syncProvider({...c,chainNamespace:i}),this.setStatus("connected",i),this.syncConnectedWalletInfo(i),ge.removeDisconnectedConnectorId(e.id,i),{address:c.address,connectedCaipNetwork:a}}async connectInactiveNamespaces(e,t){let i=e.type===Mt.CONNECTOR_TYPE_AUTH,r=un.getOtherAuthNamespaces(t?.connectedCaipNetwork?.chainNamespace),n=E.state.activeCaipNetwork,o=this.getAdapter(n?.chainNamespace);i&&(await Promise.all(r.map(async a=>{try{let c=we.getProvider(a),l=this.getCaipNetwork(a);await this.getAdapter(a)?.connect({...e,provider:c,socialUri:void 0,chainId:l?.id,rpcUrl:l?.rpcUrls?.default?.http?.[0]})&&(ge.addConnectedNamespace(a),ge.removeDisconnectedConnectorId(e.id,a),this.setStatus("connected",a),this.syncConnectedWalletInfo(a))}catch(c){ze.warn(We.ALERT_WARNINGS.INACTIVE_NAMESPACE_NOT_CONNECTED.displayMessage,We.ALERT_WARNINGS.INACTIVE_NAMESPACE_NOT_CONNECTED.debugMessage(a,c instanceof Error?c.message:void 0),We.ALERT_WARNINGS.INACTIVE_NAMESPACE_NOT_CONNECTED.code)}})),n&&await o?.switchNetwork({caipNetwork:n}))}getApprovedCaipNetworksData(){if(we.getProviderId(E.state.activeChain)===Mt.CONNECTOR_TYPE_WALLET_CONNECT){let t=this.universalProvider?.session?.namespaces;return{supportsAllNetworks:this.universalProvider?.session?.peer?.metadata.name==="MetaMask Wallet",approvedCaipNetworkIds:this.getChainsFromNamespaces(t)}}return{supportsAllNetworks:!0,approvedCaipNetworkIds:[]}}async switchCaipNetwork(e){let t=e.chainNamespace;if(this.getAddressByChainNamespace(e.chainNamespace)){let r=we.getProviderId(t);if(e.chainNamespace===E.state.activeChain)await this.getAdapter(t)?.switchNetwork({caipNetwork:e});else if(this.setCaipNetwork(e),r===Mt.CONNECTOR_TYPE_WALLET_CONNECT)this.syncWalletConnectAccount();else{let n=this.getAddressByChainNamespace(t);n&&this.syncAccount({address:n,chainId:e.id,chainNamespace:t})}}else this.setCaipNetwork(e)}getChainsFromNamespaces(e={}){return Object.values(e).flatMap(t=>{let i=t.chains||[],r=t.accounts.map(n=>{let{chainId:o,chainNamespace:a}=As.parseCaipAddress(n);return`${a}:${o}`});return Array.from(new Set([...i,...r]))})}createAdapters(e){return this.createClients(),this.chainNamespaces.reduce((t,i)=>{let r=e?.find(n=>n.namespace===i);return r?(r.construct({namespace:i,projectId:this.options?.projectId,networks:this.caipNetworks?.filter(({chainNamespace:n})=>n===i)}),t[i]=r):t[i]=new Yr({namespace:i,networks:this.getCaipNetworks()}),t},{})}async initChainAdapter(e){this.onConnectors(e),this.listenAdapter(e);let t=this.getAdapter(e);if(!t)throw new Error("adapter not found");await t.syncConnectors(),await this.createUniversalProviderForAdapter(e)}async initChainAdapters(){await Promise.all(this.chainNamespaces.map(async e=>{await this.initChainAdapter(e)})),this.initAdapterController()}onConnectors(e){this.getAdapter(e)?.on("connectors",this.setConnectors.bind(this))}listenAdapter(e){let t=this.getAdapter(e);if(!t)return;let i=ge.getConnectionStatus();q.state.enableReconnect===!1?this.setStatus("disconnected",e):i==="connected"?this.setStatus("connecting",e):i==="disconnected"?(ge.clearAddressCache(),this.setStatus(i,e)):this.setStatus(i,e),t.on("switchNetwork",({address:r,chainId:n})=>{let o=this.getCaipNetworks().find(l=>l.id.toString()===n.toString()||l.caipNetworkId.toString()===n.toString()),a=E.state.activeChain===e,c=E.state.chains.get(e)?.accountState?.address;if(o){let l=a&&r?r:c;l&&this.syncAccount({address:l,chainId:o.id,chainNamespace:e})}else this.setUnsupportedNetwork(n)}),t.on("disconnect",()=>{let r=this.remoteFeatures.multiWallet,n=Array.from(ye.state.connections.values()).flat();this.onDisconnectNamespace({chainNamespace:e,closeModal:!r||n.length===0})}),t.on("connections",r=>{this.setConnections(r,e)}),t.on("pendingTransactions",()=>{let r=this.getAddress(e),n=E.state.activeCaipNetwork;!r||!n?.id||this.updateNativeBalance(r,n.id,n.chainNamespace)}),t.on("accountChanged",({address:r,chainId:n,connector:o})=>{this.handlePreviousConnectorConnection(o);let a=E.state.activeChain===e;o?.provider&&(this.syncProvider({id:o.id,type:o.type,provider:o?.provider,chainNamespace:e}),this.syncConnectedWalletInfo(e));let c=E.getNetworkData(e)?.caipNetwork?.id,l=n||c;a&&l?this.syncAccount({address:r,chainId:l,chainNamespace:e}):!a&&l?(this.syncAccountInfo(r,l,e),this.syncBalance({address:r,chainId:l,chainNamespace:e})):this.syncAccountInfo(r,n,e),ge.addConnectedNamespace(e)})}async handlePreviousConnectorConnection(e){let t=e?.chain,i=e?.id,r=le.getConnectorId(t),n=q.state.remoteFeatures?.multiWallet,a=t&&i&&r&&r!==i&&!n;try{a&&await ye.disconnect({id:r,namespace:t})}catch(c){console.warn("Error disconnecting previous connector",c)}}async createUniversalProviderForAdapter(e){await this.getUniversalProvider(),this.universalProvider&&await this.chainAdapters?.[e]?.setUniversalProvider?.(this.universalProvider)}async syncExistingConnection(){await Promise.allSettled(this.chainNamespaces.map(e=>this.syncNamespaceConnection(e)))}async unSyncExistingConnection(){try{await Promise.allSettled(this.chainNamespaces.map(e=>ye.disconnect({namespace:e,initialDisconnect:!0})))}catch(e){console.error("Error disconnecting existing connections:",e)}}async reconnectWalletConnect(){await this.syncWalletConnectAccount();let e=this.getAddress();this.getCaipAddress()||ge.deleteRecentWallet();let t=ge.getRecentWallet();ts.sendEvent({type:"track",event:"CONNECT_SUCCESS",address:e,properties:{method:Ke.isMobile()?"mobile":"qrcode",name:t?.name||"Unknown",reconnect:!0,view:Ss.state.view,walletRank:t?.order}})}async syncNamespaceConnection(e){try{e===re.CHAIN.EVM&&Ke.isSafeApp()&&le.setConnectorId(re.CONNECTOR_ID.SAFE,e);let t=le.getConnectorId(e);switch(this.setStatus("connecting",e),t){case re.CONNECTOR_ID.WALLET_CONNECT:await this.reconnectWalletConnect();break;case re.CONNECTOR_ID.AUTH:break;default:await this.syncAdapterConnection(e)}}catch(t){console.warn("AppKit couldn't sync existing connection",t),this.setStatus("disconnected",e)}}onDisconnectNamespace(e){let{chainNamespace:t,closeModal:i}=e||{};E.resetAccount(t),E.resetNetwork(t),ge.removeConnectedNamespace(t);let r=Array.from(E.state.chains.keys());(t?[t]:r).forEach(o=>ge.addDisconnectedConnectorId(le.getConnectorId(o)||"",o)),le.removeConnectorId(t),we.resetChain(t),this.setUser(null,t),this.setStatus("disconnected",t),this.setConnectedWalletInfo(null,t),i!==!1&&jt.close()}async syncAdapterConnections(){await Promise.allSettled(this.chainNamespaces.map(e=>{let t=this.getAdapter(e),i=this.getCaipAddress(e),r=this.getCaipNetwork(e);return t?.syncConnections({connectToFirstConnector:!i,caipNetwork:r})}))}async syncAdapterConnection(e){let t=this.getAdapter(e),i=this.getCaipNetwork(e),r=le.getConnectorId(e),o=le.getConnectors(e).find(a=>a.id===r);try{if(!t||!o)throw new Error(`Adapter or connector not found for namespace ${e}`);if(!i?.id)throw new Error("CaipNetwork not found");let a=await t?.syncConnection({namespace:e,id:o.id,chainId:i.id,rpcUrl:i?.rpcUrls?.default?.http?.[0]});a?(this.syncProvider({...a,chainNamespace:e}),await this.syncAccount({...a,chainNamespace:e}),this.setStatus("connected",e),ts.sendEvent({type:"track",event:"CONNECT_SUCCESS",address:a.address,properties:{method:"browser",name:o.info?.name||o.name||"Unknown",reconnect:!0,view:Ss.state.view,walletRank:void 0}})):this.setStatus("disconnected",e)}catch{this.onDisconnectNamespace({chainNamespace:e,closeModal:!1})}}async syncWalletConnectAccount(){let e=Object.keys(this.universalProvider?.session?.namespaces||{}),t=this.chainNamespaces.map(async i=>{let r=this.getAdapter(i);if(!r)return;let n=this.universalProvider?.session?.namespaces?.[i]?.accounts||[],o=E.state.activeCaipNetwork?.id,a=n.find(l=>{let{chainId:h}=As.parseCaipAddress(l);return h===o?.toString()})||n[0];if(a){let l=As.validateCaipAddress(a),{chainId:h,address:d}=As.parseCaipAddress(l);if(we.setProviderId(i,Mt.CONNECTOR_TYPE_WALLET_CONNECT),this.caipNetworks&&E.state.activeCaipNetwork&&r.namespace!==re.CHAIN.EVM){let u=r.getWalletConnectProvider({caipNetworks:this.getCaipNetworks(),provider:this.universalProvider,activeCaipNetwork:E.state.activeCaipNetwork});we.setProvider(i,u)}else we.setProvider(i,this.universalProvider);le.setConnectorId(re.CONNECTOR_ID.WALLET_CONNECT,i),ge.addConnectedNamespace(i),await this.syncAccount({address:d,chainId:h,chainNamespace:i})}else e.includes(i)&&this.setStatus("disconnected",i);let c=this.getApprovedCaipNetworksData();this.syncConnectedWalletInfo(i),E.setApprovedCaipNetworksData(i,{approvedCaipNetworkIds:c.approvedCaipNetworkIds,supportsAllNetworks:c.supportsAllNetworks})});await Promise.all(t)}syncProvider({type:e,provider:t,id:i,chainNamespace:r}){we.setProviderId(r,e),we.setProvider(r,t),le.setConnectorId(i,r)}async syncAccount(e){let t=e.chainNamespace===E.state.activeChain,i=E.getCaipNetworkByNamespace(e.chainNamespace,e.chainId),{address:r,chainId:n,chainNamespace:o}=e,{chainId:a}=ge.getActiveNetworkProps(),c=i?.id||a,l=E.state.activeCaipNetwork?.name===re.UNSUPPORTED_NETWORK_NAME,h=E.getNetworkProp("supportsAllNetworks",o);if(this.setStatus("connected",o),!(l&&!h)&&c){let d=this.getCaipNetworks().find(g=>g.id.toString()===c.toString()),u=this.getCaipNetworks().find(g=>g.chainNamespace===o);if(!h&&!d&&!u){let g=this.getApprovedCaipNetworkIds()||[],y=g.find(_=>As.parseCaipNetworkId(_)?.chainId===c.toString()),A=g.find(_=>As.parseCaipNetworkId(_)?.chainNamespace===o);d=this.getCaipNetworks().find(_=>_.caipNetworkId===y),u=this.getCaipNetworks().find(_=>_.caipNetworkId===A||"deprecatedCaipNetworkId"in _&&_.deprecatedCaipNetworkId===A)}let p=d||u;p?.chainNamespace===E.state.activeChain?q.state.enableNetworkSwitch&&!q.state.allowUnsupportedChain&&E.state.activeCaipNetwork?.name===re.UNSUPPORTED_NETWORK_NAME?E.showUnsupportedChainUI():this.setCaipNetwork(p):t||i&&this.setCaipNetworkOfNamespace(i,o),this.syncConnectedWalletInfo(o);let f=this.getAddress(o);un.isLowerCaseMatch(r,f)||this.syncAccountInfo(r,p?.id,o),t?await this.syncBalance({address:r,chainId:p?.id,chainNamespace:o}):await this.syncBalance({address:r,chainId:i?.id,chainNamespace:o}),this.syncIdentity({address:r,chainId:n,chainNamespace:o})}}async syncAccountInfo(e,t,i){let r=this.getCaipAddress(i),n=t||r?.split(":")[1];if(!n)return;let o=`${i}:${n}:${e}`;this.setCaipAddress(o,i,!0),await this.syncIdentity({address:e,chainId:n,chainNamespace:i})}async syncReownName(e,t){try{let i=await this.getReownName(e);if(i[0]){let r=i[0];this.setProfileName(r.name,t)}else this.setProfileName(null,t)}catch{this.setProfileName(null,t)}}syncConnectedWalletInfo(e){let t=le.getConnectorId(e),i=we.getProviderId(e);if(i===Mt.CONNECTOR_TYPE_ANNOUNCED||i===Mt.CONNECTOR_TYPE_INJECTED){if(t){let n=this.getConnectors().find(o=>{let a=o.id===t,c=o.info?.rdns===t,l=o.connectors?.some(h=>h.id===t||h.info?.rdns===t);return a||c||!!l});if(n){let{info:o,name:a,imageUrl:c}=n,l=c||this.getConnectorImage(n);this.setConnectedWalletInfo({name:a,icon:l,...o},e)}}}else if(i===Mt.CONNECTOR_TYPE_WALLET_CONNECT){let r=we.getProvider(e);r?.session&&this.setConnectedWalletInfo({...r.session.peer.metadata,name:r.session.peer.metadata.name,icon:r.session.peer.metadata.icons?.[0]},e)}else if(t&&(t===re.CONNECTOR_ID.COINBASE_SDK||t===re.CONNECTOR_ID.COINBASE)){let r=this.getConnectors().find(c=>c.id===t),n=r?.name||"Coinbase Wallet",o=r?.imageUrl||this.getConnectorImage(r),a=r?.info;this.setConnectedWalletInfo({...a,name:n,icon:o},e)}}async syncBalance(e){!Ga.getNetworksByNamespace(this.getCaipNetworks(),e.chainNamespace).find(i=>i.id.toString()===e.chainId?.toString())||!e.chainId||await this.updateNativeBalance(e.address,e.chainId,e.chainNamespace)}async ready(){await this.readyPromise}async updateNativeBalance(e,t,i){let r=this.getAdapter(i),n=E.getCaipNetworkByNamespace(i,t);if(r){let o=await r.getBalance({address:e,chainId:t,caipNetwork:n,tokens:this.options.tokens});return this.setBalance(o.balance,o.symbol,i),o}}async initializeUniversalAdapter(){let e=ic.createLogger((i,...r)=>{i&&this.handleAlertError(i),console.error(...r)}),t={projectId:this.options?.projectId,metadata:{name:this.options?.metadata?this.options?.metadata.name:"",description:this.options?.metadata?this.options?.metadata.description:"",url:this.options?.metadata?this.options?.metadata.url:"",icons:this.options?.metadata?this.options?.metadata.icons:[""]},logger:e};q.setManualWCControl(!!this.options?.manualWCControl),this.universalProvider=this.options.universalProvider??await Gr.init(t),q.state.enableReconnect===!1&&this.universalProvider.session&&await this.universalProvider.disconnect(),this.listenWalletConnect()}listenWalletConnect(){this.universalProvider&&this.chainNamespaces.forEach(e=>{zi.listenWcProvider({universalProvider:this.universalProvider,namespace:e,onDisplayUri:t=>{ye.setUri(t)},onConnect:t=>{let{address:i}=Ke.getAccount(t[0]);ye.finalizeWcConnection(i)},onDisconnect:()=>{E.state.noAdapters&&this.resetAccount(e),ye.resetWcConnection()},onChainChanged:t=>{let i=E.state.activeChain,r=i&&le.state.activeConnectorIds[i]===re.CONNECTOR_ID.WALLET_CONNECT;if(i===e&&(E.state.noAdapters||r)){let n=this.getCaipNetworks().find(a=>a.id.toString()===t.toString()||a.caipNetworkId.toString()===t.toString()),o=this.getCaipNetwork();if(!n){this.setUnsupportedNetwork(t);return}o?.id.toString()!==n?.id.toString()&&o?.chainNamespace===n?.chainNamespace&&this.setCaipNetwork(n)}},onAccountsChanged:t=>{let i=E.state.activeChain,r=i&&le.state.activeConnectorIds[i]===re.CONNECTOR_ID.WALLET_CONNECT;if(i===e&&(E.state.noAdapters||r)){let n=t?.[0];n&&this.syncAccount({address:n.address,chainId:n.chainId,chainNamespace:n.chainNamespace})}}})})}createUniversalProvider(){return!this.universalProviderInitPromise&&Ke.isClient()&&this.options?.projectId&&(this.universalProviderInitPromise=this.initializeUniversalAdapter()),this.universalProviderInitPromise}async getUniversalProvider(){if(!this.universalProvider)try{await this.createUniversalProvider()}catch(e){ts.sendEvent({type:"error",event:"INTERNAL_SDK_ERROR",properties:{errorType:"UniversalProviderInitError",errorMessage:e instanceof Error?e.message:"Unknown",uncaught:!1}}),console.error("AppKit:getUniversalProvider - Cannot create provider",e)}return this.universalProvider}getDisabledCaipNetworks(){let e=E.getAllApprovedCaipNetworkIds(),t=E.getAllRequestedCaipNetworks();return Ke.sortRequestedNetworks(e,t).filter(r=>E.isCaipNetworkDisabled(r))}handleAlertError(e){let t=Object.entries(We.UniversalProviderErrors).find(([,{message:a}])=>e.message.includes(a)),[i,r]=t??[],{message:n,alertErrorKey:o}=r??{};if(i&&n&&!this.reportedAlertErrors[i]){let a=We.ALERT_ERRORS[o];a&&(ze.open(a,"error"),this.reportedAlertErrors[i]=!0)}}getAdapter(e){if(e)return this.chainAdapters?.[e]}createAdapter(e){if(!e)return;let t=e.namespace;if(!t)return;this.createClients();let i=e;i.namespace=t,i.construct({namespace:t,projectId:this.options?.projectId,networks:this.caipNetworks?.filter(({chainNamespace:r})=>r===t)}),this.chainNamespaces.includes(t)||this.chainNamespaces.push(t),this.chainAdapters&&(this.chainAdapters[t]=i)}async open(e){await this.injectModalUi(),e?.uri&&ye.setUri(e.uri);let{isSwap:t,isSend:i}=this.toModalOptions();return t(e)?jt.open({...e,data:{swap:e.arguments}}):i(e)&&e.arguments?this.openSend(e.arguments):jt.open(e)}async close(){await this.injectModalUi(),jt.close()}setLoading(e,t){jt.setLoading(e,t)}async disconnect(e){await ye.disconnect({namespace:e})}getSIWX(){return q.state.siwx}getError(){return""}getChainId(){return E.state.activeCaipNetwork?.id}async switchNetwork(e,{throwOnFailure:t=!1}={}){let i=this.getCaipNetworks().find(r=>r.id===e.id);if(!i){ze.open(We.ALERT_ERRORS.SWITCH_NETWORK_NOT_FOUND,"error");return}await E.switchActiveNetwork(i,{throwOnFailure:t})}getWalletProvider(){return E.state.activeChain?we.state.providers[E.state.activeChain]:null}getWalletProviderType(){return we.getProviderId(E.state.activeChain)}subscribeProviders(e){return we.subscribeProviders(e)}getThemeMode(){return Pt.state.themeMode}getThemeVariables(){return Pt.state.themeVariables}setThemeMode(e){Pt.setThemeMode(e),nc(Pt.state.themeMode)}setTermsConditionsUrl(e){q.setTermsConditionsUrl(e)}setPrivacyPolicyUrl(e){q.setPrivacyPolicyUrl(e)}setThemeVariables(e){Pt.setThemeVariables(e),oc(Pt.state.themeVariables)}subscribeTheme(e){return Pt.subscribe(e)}subscribeConnections(e){return this.remoteFeatures.multiWallet?ye.subscribe(e):(ze.open(re.REMOTE_FEATURES_ALERTS.MULTI_WALLET_NOT_ENABLED.DEFAULT,"info"),()=>{})}getWalletInfo(e){return e?E.state.chains.get(e)?.accountState?.connectedWalletInfo:E.getAccountData()?.connectedWalletInfo}getAccount(e){let t=e||E.state.activeChain,i=le.getAuthConnector(t),r=E.getAccountData(t),n=ge.getConnectedConnectorId(E.state.activeChain),o=ye.getConnections(t);if(!t)throw new Error("AppKit:getAccount - namespace is required");let a=o.flatMap(c=>c.accounts.map(({address:l,type:h,publicKey:d})=>Ke.createAccount(t,l,h||"eoa",d)));if(r)return{allAccounts:a,caipAddress:r.caipAddress,address:Ke.getPlainAddress(r.caipAddress),isConnected:!!r.caipAddress,status:r.status,embeddedWalletInfo:i&&n===re.CONNECTOR_ID.AUTH?{user:r.user?{...r.user,username:ge.getConnectedSocialUsername()}:void 0,authProvider:r.socialProvider||"email",accountType:an(t),isSmartAccountDeployed:!!r.smartAccountDeployed}:void 0}}subscribeAccount(e,t){let i=()=>{let r=this.getAccount(t);r&&e(r)};t?E.subscribeChainProp("accountState",i,t):E.subscribe(i),le.subscribe(i)}subscribeNetwork(e){return E.subscribe(({activeCaipNetwork:t})=>{e({caipNetwork:t,chainId:t?.id,caipNetworkId:t?.caipNetworkId})})}subscribeWalletInfo(e,t){return t?E.subscribeChainProp("accountState",i=>e(i?.connectedWalletInfo),t):E.subscribeChainProp("accountState",i=>e(i?.connectedWalletInfo))}subscribeShouldUpdateToAddress(e){E.subscribeChainProp("accountState",t=>e(t?.shouldUpdateToAddress))}subscribeCaipNetworkChange(e){E.subscribeKey("activeCaipNetwork",e)}getState(){return ln.state}getRemoteFeatures(){return q.state.remoteFeatures}subscribeState(e){return ln.subscribe(e)}subscribeRemoteFeatures(e){return q.subscribeKey("remoteFeatures",e)}showErrorMessage(e){nn.showError(e)}showSuccessMessage(e){nn.showSuccess(e)}getEvent(){return{...ts.state}}subscribeEvents(e){return ts.subscribe(e)}replace(e){Ss.replace(e)}redirect(e){Ss.push(e)}popTransactionStack(e){Ss.popTransactionStack(e)}isOpen(){return jt.state.open}isTransactionStackEmpty(){return Ss.state.transactionStack.length===0}static getInstance(){return this.instance}updateFeatures(e){q.setFeatures(e)}updateRemoteFeatures(e){q.setRemoteFeatures(e)}updateOptions(e){let i={...q.state||{},...e};q.setOptions(i)}setConnectMethodsOrder(e){q.setConnectMethodsOrder(e)}setWalletFeaturesOrder(e){q.setWalletFeaturesOrder(e)}setCollapseWallets(e){q.setCollapseWallets(e)}setSocialsOrder(e){q.setSocialsOrder(e)}getConnectMethodsOrder(){return rc.getConnectOrderMethod(q.state.features,le.getConnectors())}addNetwork(e,t){if(this.chainAdapters&&!this.chainAdapters[e])throw new Error(`Adapter for namespace ${e} doesn't exist`);let i=this.extendCaipNetwork(t,this.options);this.getCaipNetworks().find(r=>r.id===i.id)||E.addNetwork(i)}removeNetwork(e,t){if(this.chainAdapters&&!this.chainAdapters[e])throw new Error(`Adapter for namespace ${e} doesn't exist`);this.getCaipNetworks().find(r=>r.id===t)&&E.removeNetwork(e,t)}};var id=!1,Zr=class extends Jr{async open(e){le.isConnected()||await super.open(e)}async close(){if(await super.close(),this.options.manualWCControl){let e=E.getAccountData(this.activeChainNamespace)?.address;ye.finalizeWcConnection(e)}}async syncIdentity(e){return Promise.resolve()}async syncBalance(e){return Promise.resolve()}async injectModalUi(){if(!id&&Ke.isClient()){if(await import("./basic-PGNS5MWQ.js"),await import("./w3m-modal-P7IET5W3.js"),!document.querySelector("w3m-modal")){let t=document.createElement("w3m-modal");!q.state.disableAppend&&!q.state.enableEmbedded&&document.body.insertAdjacentElement("beforeend",t)}id=!0}}};oe();ce();ae();var rd="1.8.11";function g1(s){return new Zr({...s,basic:!0,sdkVersion:`html-core-${rd}`})}export{Zr as AppKit,g1 as createAppKit};
/*! Bundled license information:

@walletconnect/utils/dist/index.js:
  (*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) *)
*/
